<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <title>Create Account - Tool Tracking</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/common.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .auth-container {
            width: 100%;
            max-width: 450px;
            padding: 2rem;
        }
        
        .auth-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            border: none;
        }
        
        .card-body {
            padding: 2rem;
        }
        
        .form-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 0.5rem;
        }
        
        .form-control {
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            padding: 0.75rem;
        }
        
        .form-control:focus {
            border-color: #FF9800;
            box-shadow: 0 0 0 0.2rem rgba(255, 152, 0, 0.25);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
            border: none;
            border-radius: 8px;
            padding: 0.75rem;
            font-weight: bold;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #F57C00 0%, #E65100 100%);
        }
        
        .back-to-home {
            position: absolute;
            top: 1rem;
            left: 1rem;
            color: white;
            text-decoration: none;
            font-weight: bold;
            z-index: 1000;
        }
        
        .back-to-home:hover {
            color: #FFD700;
        }
    </style>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    <script src="js/common.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <a href="index.html" class="back-to-home">
        <i class="fas fa-arrow-left"></i> Back to Home
    </a>
    
    <div class="auth-container">
        <div class="card auth-card">
            <div class="card-body">
                <div class="text-center mb-4">
                    <h2 class="mb-2" style="color: #FF9800; font-weight: bold;">Create Account</h2>
                    <p class="text-muted">Join Tool Tracking System</p>
                </div>
                
                <form id="signUpForm" onsubmit="event.preventDefault(); signUp();">
                    <div id="signUpAlert" class="alert alert-danger d-none" role="alert"></div>
                    
                    <div class="mb-2">
                        <label for="signUpFullName" class="form-label">Full Name</label>
                        <input type="text" id="signUpFullName" class="form-control" required autocomplete="name" 
                               oninput="validateFullName(this)" onblur="formatFullName(this)" 
                               placeholder="Enter your full name (English letters only)">
                        <div id="fullNameValidation" class="form-text text-muted"></div>
                    </div>
                    
                    <div class="mb-2">
                        <label for="signUpEmail" class="form-label">Email</label>
                        <input type="email" id="signUpEmail" class="form-control" required autocomplete="username">
                    </div>
                    
                    <div class="mb-2">
                        <label for="signUpPassword" class="form-label">Password</label>
                        <div class="input-group">
                            <input type="password" id="signUpPassword" class="form-control" required autocomplete="new-password">
                            <button class="btn btn-outline-secondary" type="button" id="toggleSignUpPassword" tabindex="-1">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-2">
                        <label for="signUpConfirmPassword" class="form-label">Confirm Password</label>
                        <div class="input-group">
                            <input type="password" id="signUpConfirmPassword" class="form-control" required autocomplete="new-password">
                            <button class="btn btn-outline-secondary" type="button" id="toggleSignUpConfirmPassword" tabindex="-1">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary w-100 mb-2" id="signUpBtn">
                        <span class="btn-text">CREATE ACCOUNT</span>
                        <span class="btn-loading d-none">
                            <span class="spinner-border spinner-border-sm me-2"></span>Loading...
                        </span>
                    </button>
                </form>
                
                <div class="text-center mt-3">
                    <p class="text-muted">Already have an account? <a href="signin.html" style="color: #FF9800; font-weight: bold;">Sign In</a></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Use global Firebase instances from common.js
        const auth = window.auth;
        const db = window.db;
        
        // Show/Hide password logic
        const signUpPassword = document.getElementById('signUpPassword');
        document.getElementById('toggleSignUpPassword').onclick = function() {
            if (signUpPassword.type === 'password') {
                signUpPassword.type = 'text';
                this.innerHTML = '<i class="fas fa-eye-slash"></i>';
            } else {
                signUpPassword.type = 'password';
                this.innerHTML = '<i class="fas fa-eye"></i>';
            }
        };
        const signUpConfirmPassword = document.getElementById('signUpConfirmPassword');
        document.getElementById('toggleSignUpConfirmPassword').onclick = function() {
            if (signUpConfirmPassword.type === 'password') {
                signUpConfirmPassword.type = 'text';
                this.innerHTML = '<i class="fas fa-eye-slash"></i>';
            } else {
                signUpConfirmPassword.type = 'password';
                this.innerHTML = '<i class="fas fa-eye"></i>';
            }
        };

        // Full name validation and formatting functions
        function validateFullName(input) {
            const value = input.value;
            const validationDiv = document.getElementById('fullNameValidation');
            
            // Remove any non-English letters and spaces immediately
            const cleanedValue = value.replace(/[^A-Za-z ]/g, '');
            if (cleanedValue !== value) {
                input.value = cleanedValue;
            }
            
            // Check if empty
            if (!cleanedValue.trim()) {
                validationDiv.textContent = '';
                validationDiv.className = 'form-text text-muted';
                return;
            }
            
            // Check if contains only valid characters
            if (!/^[A-Za-z ]+$/.test(cleanedValue)) {
                validationDiv.textContent = 'Only English letters and spaces are allowed';
                validationDiv.className = 'form-text text-danger';
                return;
            }
            
            // Check if has at least 2 characters
            if (cleanedValue.trim().length < 2) {
                validationDiv.textContent = 'Name must be at least 2 characters long';
                validationDiv.className = 'form-text text-warning';
                return;
            }
            
            // Check if has at least one space (first and last name)
            const words = cleanedValue.trim().split(' ').filter(word => word.length > 0);
            if (words.length < 2) {
                validationDiv.textContent = 'Please enter both first and last name';
                validationDiv.className = 'form-text text-warning';
                return;
            }
            
            // All validations passed
            validationDiv.textContent = '✓ Valid name format';
            validationDiv.className = 'form-text text-success';
        }
        
        function formatFullName(input) {
            const value = input.value.trim();
            if (!value) return;
            
            // Split into words, capitalize first letter of each word, lowercase the rest
            const formattedName = value
                .split(' ')
                .filter(word => word.length > 0)
                .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                .join(' ');
            
            input.value = formattedName;
            
            // Update validation message
            const validationDiv = document.getElementById('fullNameValidation');
            if (formattedName && /^([A-Z][a-z]+)( [A-Z][a-z]+)+$/.test(formattedName)) {
                validationDiv.textContent = '✓ Name formatted correctly';
                validationDiv.className = 'form-text text-success';
            }
        }

        // Sign up logic
        async function signUp() {
            let fullName = document.getElementById('signUpFullName').value.trim();
            const email = document.getElementById('signUpEmail').value.trim();
            const password = document.getElementById('signUpPassword').value.trim();
            const confirmPassword = document.getElementById('signUpConfirmPassword').value.trim();
            const alertBox = document.getElementById('signUpAlert');
            alertBox.classList.add('d-none');

            // Final validation for full name format
            if (!fullName || !/^([A-Z][a-z]+)( [A-Z][a-z]+)+$/.test(fullName)) {
                alertBox.textContent = 'Please enter a valid full name with both first and last name (English letters only).';
                alertBox.classList.remove('d-none');
                return;
            }

            if (!fullName || !email || !password || !confirmPassword) {
                alertBox.textContent = 'Please fill in all fields.';
                alertBox.classList.remove('d-none');
                return;
            }
            if (password !== confirmPassword) {
                alertBox.textContent = 'Passwords do not match.';
                alertBox.classList.remove('d-none');
                return;
            }
            
            // Check if email already exists in pending registrations
            try {
                const pendingDoc = await db.collection('pendingRegistrations').doc(email).get();
                if (pendingDoc.exists) {
                    alertBox.textContent = 'An account with this email is already pending verification. Please check your email or try again later.';
                    alertBox.classList.remove('d-none');
                    return;
                }
            } catch (error) {
                console.error('Error checking pending registrations:', error);
            }
            
            try {
                // Create Firebase Auth account
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // Send email verification
                await user.sendEmailVerification();
                console.log('Email verification sent to:', email);
                
                // Store pending registration data
                await db.collection('pendingRegistrations').doc(email).set({
                    fullName: fullName,
                    email: email,
                    uid: user.uid,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    verified: false
                });
                console.log('Pending registration document created for:', email);
                
                // Sign out the user immediately to prevent access
                await auth.signOut();
                console.log('User signed out after registration');

                alertBox.classList.add('d-none');
                alert('Account created successfully! Please check your email inbox (and spam folder) for a verification email. Click the verification link in the email, then you can sign in. You will not be able to sign in until you verify your email address.');
                
                // Redirect to sign in page
                setTimeout(() => {
                    window.location.href = 'signin.html';
                }, 2000);
            } catch (error) {
                console.error('Sign up error:', error);
                alertBox.textContent = error.message;
                alertBox.classList.remove('d-none');
            }
        }
        
        // Check if user is already logged in
        auth.onAuthStateChanged(function(user) {
            if (user && user.emailVerified) {
                // User is already logged in, redirect to main menu
                window.location.href = 'main-menu.html';
            }
        });
    </script>
</body>
</html>


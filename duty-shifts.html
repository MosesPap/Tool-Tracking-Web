<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <title>Διαχείριση Υπηρεσιών - Tool Tracking</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/common.css">
    <style>
        body, html {
            margin: 0;
            padding: 0;
            background: #f5f5f5;
        }

        .full-width-title-bar {
            width: 100vw !important;
            margin-left: calc(50% - 50vw) !important;
            margin-right: calc(50% - 50vw) !important;
            margin-top: 0 !important;
        }

        .container-fluid {
            padding: 1rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .group-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid #e0e0e0;
        }

        .group-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
        }

        .person-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            margin: 0.5rem 0;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            cursor: move;
            transition: background-color 0.2s;
        }

        .person-item:hover {
            background: #e9ecef;
        }

        .person-item.dragging {
            opacity: 0.5;
        }

        .person-name {
            flex: 1;
            font-size: 1rem;
        }

        .person-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .transfer-dropdown {
            position: relative;
            display: inline-block;
        }

        .transfer-dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: white;
            min-width: 150px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1000;
            border-radius: 8px;
            padding: 0.5rem 0;
            margin-top: 0.25rem;
        }

        .transfer-dropdown-content.show {
            display: block;
        }

        .transfer-dropdown-content button {
            width: 100%;
            text-align: left;
            padding: 0.5rem 1rem;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .transfer-dropdown-content button:hover {
            background-color: #f1f1f1;
        }

        .btn-add-person {
            width: 100%;
            margin-top: 0.5rem;
        }

        .calendar-section {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .calendar-nav {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
        }

        .calendar-day-header {
            text-align: center;
            font-weight: bold;
            padding: 0.5rem;
            color: #666;
            font-size: 0.9rem;
        }

        .calendar-day {
            aspect-ratio: 1;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .calendar-day:hover {
            border-color: #FF9800;
            transform: scale(1.05);
        }

        .calendar-day.today {
            border-color: #FF9800;
            background: #FFF3E0;
            font-weight: bold;
        }

        .calendar-day.normal-day {
            background: #E8F5E9;
        }

        .calendar-day.semi-normal-day {
            background: #FFF9C4;
        }

        .calendar-day.weekend-holiday {
            background: #FFE0B2;
        }

        .calendar-day.special-holiday {
            background: #E1BEE7;
            border-color: #9C27B0;
            font-weight: bold;
        }

        .calendar-day.holiday {
            background: #FFCDD2;
        }

        .day-number {
            font-size: 1rem;
            font-weight: bold;
        }

        .day-type {
            font-size: 0.7rem;
            margin-top: 0.25rem;
            text-align: center;
        }

        .orthodox-holiday-name {
            font-size: 0.7rem;
            margin-top: 0.2rem;
            color: #7B1FA2;
            font-weight: bold;
            text-align: center;
            word-break: break-word;
            line-height: 1.1;
        }

        .duty-person {
            font-size: 0.75rem;
            margin-top: 0.25rem;
            color: #FF9800;
            font-weight: bold;
            text-align: center;
            word-break: break-word;
        }

        .holiday-list {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .holiday-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            margin: 0.5rem 0;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .stats-card {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
            color: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 12px rgba(255, 152, 0, 0.3);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .modal-day-details {
            max-height: 60vh;
            overflow-y: auto;
        }

        .duty-assignment {
            padding: 0.75rem;
            margin: 0.5rem 0;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #FF9800;
        }

        .group-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: bold;
            margin-right: 0.5rem;
        }

        .group-1 { background: #E3F2FD; color: #1976D2; }
        .group-2 { background: #F3E5F5; color: #7B1FA2; }
        .group-3 { background: #E8F5E9; color: #388E3C; }
        .group-4 { background: #FFF3E0; color: #F57C00; }

        @media (max-width: 768px) {
            .calendar-grid {
                gap: 0.25rem;
            }
            
            .calendar-day {
                padding: 0.25rem;
                font-size: 0.85rem;
            }
            
            .day-number {
                font-size: 0.9rem;
            }
            
            .day-type, .duty-person, .orthodox-holiday-name {
                font-size: 0.65rem;
            }
        }
    </style>
</head>
<body>
    <!-- Title Bar -->
    <div class="full-width-title-bar">
        <div class="d-flex justify-content-between align-items-center p-3" style="background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); color: white;">
            <div class="d-flex align-items-center">
                <a href="main-menu.html" class="text-white me-3" style="text-decoration: none;">
                    <i class="fas fa-arrow-left fa-lg"></i>
                </a>
                <h4 class="mb-0">Διαχείριση Υπηρεσιών</h4>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <!-- Statistics Card -->
        <div class="stats-card">
            <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Στατιστικά Περιστροφής</h5>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="totalPeople">0</div>
                    <div class="stat-label">Συνολικό Προσωπικό</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="avgRotation">0</div>
                    <div class="stat-label">Μέσες Ημέρες Περιστροφής</div>
                </div>
            </div>
        </div>

        <!-- Groups Section -->
        <div class="row">
            <div class="col-12 col-md-6 col-lg-3 mb-3" id="group1Container">
                <div class="group-card">
                    <div class="group-header">
                        <div class="group-title">
                            <span class="group-badge group-1">Ομάδα 1</span>
                        </div>
                        <button class="btn btn-sm btn-outline-primary" onclick="addPerson(1)">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div id="group1People"></div>
                    <div class="mt-2">
                        <small class="text-muted">Περιστροφή: <span id="group1Rotation">-</span> ημέρες</small>
                    </div>
                </div>
            </div>

            <div class="col-12 col-md-6 col-lg-3 mb-3" id="group2Container">
                <div class="group-card">
                    <div class="group-header">
                        <div class="group-title">
                            <span class="group-badge group-2">Ομάδα 2</span>
                        </div>
                        <button class="btn btn-sm btn-outline-primary" onclick="addPerson(2)">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div id="group2People"></div>
                    <div class="mt-2">
                        <small class="text-muted">Περιστροφή: <span id="group2Rotation">-</span> ημέρες</small>
                    </div>
                </div>
            </div>

            <div class="col-12 col-md-6 col-lg-3 mb-3" id="group3Container">
                <div class="group-card">
                    <div class="group-header">
                        <div class="group-title">
                            <span class="group-badge group-3">Ομάδα 3</span>
                        </div>
                        <button class="btn btn-sm btn-outline-primary" onclick="addPerson(3)">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div id="group3People"></div>
                    <div class="mt-2">
                        <small class="text-muted">Περιστροφή: <span id="group3Rotation">-</span> ημέρες</small>
                    </div>
                </div>
            </div>

            <div class="col-12 col-md-6 col-lg-3 mb-3" id="group4Container">
                <div class="group-card">
                    <div class="group-header">
                        <div class="group-title">
                            <span class="group-badge group-4">Ομάδα 4</span>
                        </div>
                        <button class="btn btn-sm btn-outline-primary" onclick="addPerson(4)">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div id="group4People"></div>
                    <div class="mt-2">
                        <small class="text-muted">Περιστροφή: <span id="group4Rotation">-</span> ημέρες</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Special Holidays Configuration -->
        <div class="holiday-list">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5><i class="fas fa-star me-2"></i>Ειδικές Αργίες</h5>
                <button class="btn btn-warning btn-sm" onclick="addRecurringHoliday()">
                    <i class="fas fa-plus me-1"></i>Προσθήκη Ειδικής Αργίας
                </button>
            </div>
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                <small>Ορίστε αργίες που επαναλαμβάνονται κάθε χρόνο (π.χ., 25 Δεκεμβρίου, 1 Ιανουαρίου) ή σχετίζονται με το Πάσχα (π.χ., Μεγάλο Σάββατο). Οι ειδικές αργίες έχουν την υψηλότερη προτεραιότητα και χρησιμοποιούν τη σειρά ειδικών αργιών κάθε ομάδας.</small>
            </div>
            <div id="recurringHolidaysList"></div>
        </div>

        <!-- Regular Holidays Section -->
        <div class="holiday-list">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5><i class="fas fa-calendar-times me-2"></i>Κανονικές Αργίες</h5>
                <button class="btn btn-primary btn-sm" onclick="addHoliday()">
                    <i class="fas fa-plus me-1"></i>Προσθήκη Αργίας
                </button>
            </div>
            <div id="holidaysList"></div>
        </div>

        <!-- Calendar Section -->
        <div class="calendar-section">
            <div class="calendar-header">
                <h5><i class="fas fa-calendar-alt me-2"></i>Ημερολόγιο Υπηρεσιών</h5>
                <div class="calendar-nav">
                    <button class="btn btn-sm btn-outline-secondary" onclick="previousMonth()">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <h5 class="mb-0 mx-3" id="currentMonthYear"></h5>
                    <button class="btn btn-sm btn-outline-secondary" onclick="nextMonth()">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                    <button class="btn btn-sm btn-success ms-2" onclick="openAssignDutyModalForDate()">
                        <i class="fas fa-user-plus me-1"></i>Χειροκίνητη Ανάθεση
                    </button>
                    <button class="btn btn-sm btn-primary ms-2" onclick="openCalculateDutiesModal()">
                        <i class="fas fa-calculator me-1"></i>Υπολογισμός Υπηρεσιών
                    </button>
                </div>
            </div>
            <div class="calendar-grid" id="calendarGrid"></div>
        </div>
    </div>

    <!-- Add Person Modal -->
    <div class="modal fade" id="addPersonModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Προσθήκη Ατόμου στην Ομάδα <span id="modalGroupNumber"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="personName" class="form-label">Όνομα</label>
                        <input type="text" class="form-control" id="personName" placeholder="Εισάγετε το όνομά του ατόμου">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ακύρωση</button>
                    <button type="button" class="btn btn-primary" onclick="savePerson()">Προσθήκη Ατόμου</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Special Holiday Modal -->
    <div class="modal fade" id="addSpecialHolidayModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title"><i class="fas fa-star me-2"></i>Προσθήκη Ειδικής Αργίας</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <small>Οι ειδικές αργίες έχουν την υψηλότερη προτεραιότητα και χρησιμοποιούν τη σειρά ειδικών αργιών κάθε ομάδας.</small>
                    </div>
                    <div class="mb-3">
                        <label for="specialHolidayDate" class="form-label">Ημερομηνία</label>
                        <input type="date" class="form-control" id="specialHolidayDate" required>
                    </div>
                    <div class="mb-3">
                        <label for="specialHolidayName" class="form-label">Όνομα Ειδικής Αργίας (Προαιρετικό)</label>
                        <input type="text" class="form-control" id="specialHolidayName" placeholder="π.χ., Χριστούγεννα, Πάσχα, Πρωτοχρονιά">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ακύρωση</button>
                    <button type="button" class="btn btn-warning" onclick="saveSpecialHoliday()">Προσθήκη Ειδικής Αργίας</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Recurring Holiday Modal -->
    <div class="modal fade" id="addRecurringHolidayModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-info">
                    <h5 class="modal-title"><i class="fas fa-repeat me-2"></i>Προσθήκη Επαναλαμβανόμενης Αργίας</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="recurringHolidayType" class="form-label">Τύπος</label>
                        <select class="form-control" id="recurringHolidayType" onchange="toggleRecurringHolidayFields()">
                            <option value="fixed">Σταθερή Ημερομηνία (π.χ., 25 Δεκεμβρίου)</option>
                            <option value="easter-relative">Σχετική με Πάσχα (π.χ., Μεγάλο Σάββατο)</option>
                        </select>
                    </div>
                    <div class="mb-3" id="fixedDateFields">
                        <label for="recurringHolidayMonth" class="form-label">Μήνας</label>
                        <select class="form-control" id="recurringHolidayMonth">
                            <option value="">Επιλέξτε...</option>
                            <option value="1">Ιανουάριος</option>
                            <option value="2">Φεβρουάριος</option>
                            <option value="3">Μάρτιος</option>
                            <option value="4">Απρίλιος</option>
                            <option value="5">Μάιος</option>
                            <option value="6">Ιούνιος</option>
                            <option value="7">Ιούλιος</option>
                            <option value="8">Αύγουστος</option>
                            <option value="9">Σεπτέμβριος</option>
                            <option value="10">Οκτώβριος</option>
                            <option value="11">Νοέμβριος</option>
                            <option value="12">Δεκέμβριος</option>
                        </select>
                    </div>
                    <div class="mb-3" id="fixedDayFields">
                        <label for="recurringHolidayDay" class="form-label">Ημέρα</label>
                        <input type="number" class="form-control" id="recurringHolidayDay" min="1" max="31">
                    </div>
                    <div class="mb-3" id="easterOffsetFields" style="display: none;">
                        <label for="recurringHolidayEasterOffset" class="form-label">Ημέρες από το Πάσχα</label>
                        <input type="number" class="form-control" id="recurringHolidayEasterOffset" value="0">
                        <small class="text-muted">0 = Πάσχα, -1 = 1 ημέρα πριν, 1 = 1 ημέρα μετά, κτλ.</small>
                    </div>
                    <div class="mb-3">
                        <label for="recurringHolidayName" class="form-label">Όνομα Αργίας</label>
                        <input type="text" class="form-control" id="recurringHolidayName" placeholder="π.χ., Χριστούγεννα, Μεγάλο Σάββατο">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ακύρωση</button>
                    <button type="button" class="btn btn-info" onclick="saveRecurringHoliday()">Αποθήκευση</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Calculate Duties Modal -->
    <div class="modal fade" id="calculateDutiesModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary">
                    <h5 class="modal-title"><i class="fas fa-calculator me-2"></i>Υπολογισμός Υπηρεσιών</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <small>Επιλέξτε τον μήνα ή τους μήνες για τους οποίους θέλετε να υπολογιστούν οι υπηρεσίες. Οι υπηρεσίες προηγούμενων μηνών δεν θα επηρεαστούν.</small>
                    </div>
                    <div class="mb-3">
                        <label for="calculateStartMonth" class="form-label">Από Μήνα</label>
                        <input type="month" class="form-control" id="calculateStartMonth" required>
                    </div>
                    <div class="mb-3">
                        <label for="calculateEndMonth" class="form-label">Έως Μήνα (Προαιρετικό)</label>
                        <input type="month" class="form-control" id="calculateEndMonth">
                        <small class="text-muted">Αφήστε κενό για υπολογισμό μόνο του επιλεγμένου μήνα</small>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="preserveExistingAssignments" checked>
                        <label class="form-check-label" for="preserveExistingAssignments">
                            Διατήρηση υπαρχουσών αναθέσεων (μη αντικατάσταση)
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ακύρωση</button>
                    <button type="button" class="btn btn-primary" onclick="calculateDutiesForSelectedMonths()">
                        <i class="fas fa-calculator me-1"></i>Υπολογισμός
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Holiday Modal -->
    <div class="modal fade" id="addHolidayModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Προσθήκη Αργίας</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="holidayDate" class="form-label">Ημερομηνία</label>
                        <input type="date" class="form-control" id="holidayDate">
                    </div>
                    <div class="mb-3">
                        <label for="holidayName" class="form-label">Όνομα Αργίας (Προαιρετικό)</label>
                        <input type="text" class="form-control" id="holidayName" placeholder="π.χ., Χριστούγεννα, Πρωτοχρονιά">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ακύρωση</button>
                    <button type="button" class="btn btn-primary" onclick="saveHoliday()">Προσθήκη Αργίας</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Day Details Modal -->
    <div class="modal fade" id="dayDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="dayDetailsTitle"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body modal-day-details" id="dayDetailsContent"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="assignDutyBtn" style="display: none;" onclick="openAssignDutyModal()">
                        <i class="fas fa-user-plus me-1"></i>Ανάθεση Υπηρεσίας
                    </button>
                    <button type="button" class="btn btn-warning" id="editDutyBtn" style="display: none;" onclick="openAssignDutyModal()">
                        <i class="fas fa-edit me-1"></i>Επεξεργασία Υπηρεσίας
                    </button>
                    <button type="button" class="btn btn-danger" id="removeDutyBtn" style="display: none;" onclick="removeDutyAssignment()">
                        <i class="fas fa-trash me-1"></i>Αφαίρεση Υπηρεσίας
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Κλείσιμο</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Assign Duty Modal -->
    <div class="modal fade" id="assignDutyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Ανάθεση Υπηρεσίας</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="assignDutyDate" class="form-label">Ημερομηνία</label>
                        <input type="date" class="form-control" id="assignDutyDate" required>
                    </div>
                    <div class="mb-3">
                        <label for="assignDutyGroup" class="form-label">Ομάδα</label>
                        <select class="form-control" id="assignDutyGroup" required>
                            <option value="">Επιλέξτε Ομάδα</option>
                            <option value="1">Ομάδα 1</option>
                            <option value="2">Ομάδα 2</option>
                            <option value="3">Ομάδα 3</option>
                            <option value="4">Ομάδα 4</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="assignDutyPerson" class="form-label">Άτομο</label>
                        <select class="form-control" id="assignDutyPerson" required>
                            <option value="">Επιλέξτε Άτομο</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ακύρωση</button>
                    <button type="button" class="btn btn-primary" onclick="saveManualDuty()">Αποθήκευση</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK - must load before common.js -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    
    <!-- Common Firebase configuration and utilities -->
    <script src="js/common.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Data storage - each group has two order lists: regular and special
        let groups = {
            1: { regular: [], special: [] },
            2: { regular: [], special: [] },
            3: { regular: [], special: [] },
            4: { regular: [], special: [] }
        };
        let holidays = [];
        let specialHolidays = []; // User-defined special holidays
        let dutyAssignments = {};
        let currentDate = new Date();
        let currentGroup = null;
        let selectedDateForDuty = null;
        
        // Configuration for recurring special holidays
        // Format: { month: 1-12, day: 1-31, name: string, type: 'fixed' | 'easter-relative', offset?: number }
        let recurringSpecialHolidays = [
            { month: 12, day: 24, name: 'Παραμονή Χριστουγέννων', type: 'fixed' },
            { month: 12, day: 25, name: 'Χριστούγεννα', type: 'fixed' },
            { month: 12, day: 31, name: 'Παραμονή Πρωτοχρονιάς', type: 'fixed' },
            { month: 1, day: 1, name: 'Πρωτοχρονιά', type: 'fixed' },
            { name: 'Μεγάλο Σάββατο', type: 'easter-relative', offset: -1 }, // 1 day before Easter
            { name: 'Πάσχα', type: 'easter-relative', offset: 0 } // Easter Sunday
        ];

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            // Wait for Firebase to be ready
            if (window.auth && window.db) {
                // Check authentication
                window.auth.onAuthStateChanged(async function(user) {
                    if (user && user.emailVerified) {
                        await loadData();
                        renderGroups();
                        renderHolidays();
                        renderRecurringHolidays();
                        renderCalendar();
                        updateStatistics();
                    } else {
                        // Not authenticated, use localStorage
                        loadDataFromLocalStorage();
                        renderGroups();
                        renderHolidays();
                        renderRecurringHolidays();
                        renderCalendar();
                        updateStatistics();
                    }
                });
            } else {
                // Firebase not loaded yet, wait a bit and try again
                setTimeout(() => {
                    document.dispatchEvent(new Event('DOMContentLoaded'));
                }, 500);
            }
        });

        // Load data from Firebase Firestore
        async function loadData() {
            try {
                // Wait for Firebase to be ready
                if (!window.db) {
                    console.log('Waiting for Firebase to initialize...');
                    setTimeout(loadData, 100);
                    return;
                }
                
                const db = window.db || firebase.firestore();
                const user = window.auth?.currentUser;
                
                if (!user) {
                    console.log('User not authenticated, using localStorage as fallback');
                    loadDataFromLocalStorage();
                    return;
                }
                
                // Load groups
                const groupsDoc = await db.collection('dutyShifts').doc('groups').get();
                if (groupsDoc.exists) {
                    const data = groupsDoc.data();
                    // Remove metadata fields
                    delete data.lastUpdated;
                    delete data.updatedBy;
                    // Migrate old format to new format if needed
                    groups = migrateGroupsFormat(data) || { 1: { regular: [], special: [] }, 2: { regular: [], special: [] }, 3: { regular: [], special: [] }, 4: { regular: [], special: [] } };
                }
                
                // Load holidays
                const holidaysDoc = await db.collection('dutyShifts').doc('holidays').get();
                if (holidaysDoc.exists) {
                    const data = holidaysDoc.data();
                    holidays = data.list || [];
                }
                
                // Load special holidays
                const specialHolidaysDoc = await db.collection('dutyShifts').doc('specialHolidays').get();
                if (specialHolidaysDoc.exists) {
                    const data = specialHolidaysDoc.data();
                    specialHolidays = data.list || [];
                }
                
                // Load recurring holidays configuration
                await loadRecurringHolidaysConfig();
                
                // Initialize default special holidays if they don't exist
                initializeDefaultSpecialHolidays();
                
                // Load assignments
                const assignmentsDoc = await db.collection('dutyShifts').doc('assignments').get();
                if (assignmentsDoc.exists) {
                    const data = assignmentsDoc.data();
                    // Remove metadata fields
                    delete data.lastUpdated;
                    delete data.updatedBy;
                    dutyAssignments = data || {};
                }
                
                console.log('Data loaded from Firebase');
            } catch (error) {
                console.error('Error loading data from Firebase:', error);
                // Fallback to localStorage
                loadDataFromLocalStorage();
            }
        }

        // Fallback: Load data from localStorage
        function loadDataFromLocalStorage() {
            const savedGroups = localStorage.getItem('dutyShiftsGroups');
            const savedHolidays = localStorage.getItem('dutyShiftsHolidays');
            const savedAssignments = localStorage.getItem('dutyShiftsAssignments');
            
            if (savedGroups) {
                const parsed = JSON.parse(savedGroups);
                groups = migrateGroupsFormat(parsed) || { 1: { regular: [], special: [] }, 2: { regular: [], special: [] }, 3: { regular: [], special: [] }, 4: { regular: [], special: [] } };
            }
            if (savedHolidays) {
                holidays = JSON.parse(savedHolidays);
            }
            
            const savedSpecialHolidays = localStorage.getItem('dutyShiftsSpecialHolidays');
            if (savedSpecialHolidays) {
                specialHolidays = JSON.parse(savedSpecialHolidays);
            }
            
            // Load recurring holidays configuration
            loadRecurringHolidaysConfig();
            
            // Initialize default special holidays if they don't exist
            initializeDefaultSpecialHolidays();
            
            if (savedAssignments) {
                dutyAssignments = JSON.parse(savedAssignments);
            }
        }

        // Save data to Firebase Firestore
        async function saveData() {
            try {
                // Wait for Firebase to be ready
                if (!window.db) {
                    console.log('Firebase not ready, saving to localStorage');
                    saveDataToLocalStorage();
                    return;
                }
                
                const db = window.db || firebase.firestore();
                const user = window.auth?.currentUser;
                
                if (!user) {
                    console.log('User not authenticated, saving to localStorage');
                    saveDataToLocalStorage();
                    return;
                }
                
                // Save groups
                await db.collection('dutyShifts').doc('groups').set({
                    ...groups,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedBy: user.uid
                });
                
                // Save holidays
                await db.collection('dutyShifts').doc('holidays').set({
                    list: holidays,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedBy: user.uid
                });
                
                // Save special holidays
                await db.collection('dutyShifts').doc('specialHolidays').set({
                    list: specialHolidays,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedBy: user.uid
                });
                
                // Save assignments
                await db.collection('dutyShifts').doc('assignments').set({
                    ...dutyAssignments,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedBy: user.uid
                });
                
                console.log('Data saved to Firebase');
                
                // Also save to localStorage as backup
                saveDataToLocalStorage();
            } catch (error) {
                console.error('Error saving data to Firebase:', error);
                // Fallback to localStorage
                saveDataToLocalStorage();
            }
        }

        // Fallback: Save data to localStorage
        function saveDataToLocalStorage() {
            localStorage.setItem('dutyShiftsGroups', JSON.stringify(groups));
            localStorage.setItem('dutyShiftsHolidays', JSON.stringify(holidays));
            localStorage.setItem('dutyShiftsSpecialHolidays', JSON.stringify(specialHolidays));
            localStorage.setItem('dutyShiftsAssignments', JSON.stringify(dutyAssignments));
        }

        // Migrate old groups format to new format
        function migrateGroupsFormat(data) {
            if (!data) return null;
            
            const migrated = {
                1: { regular: [], special: [] },
                2: { regular: [], special: [] },
                3: { regular: [], special: [] },
                4: { regular: [], special: [] }
            };
            
            for (let i = 1; i <= 4; i++) {
                if (Array.isArray(data[i])) {
                    // Old format - array of names
                    migrated[i].regular = [...data[i]];
                    migrated[i].special = [...data[i]];
                } else if (data[i] && typeof data[i] === 'object') {
                    // New format or partial migration
                    migrated[i].regular = data[i].regular || data[i].people || [];
                    migrated[i].special = data[i].special || data[i].people || [];
                }
            }
            
            return migrated;
        }

        // Render groups
        function renderGroups() {
            for (let i = 1; i <= 4; i++) {
                const container = document.getElementById(`group${i}People`);
                container.innerHTML = '';
                
                const groupData = groups[i] || { regular: [], special: [] };
                const regularList = groupData.regular || [];
                const specialList = groupData.special || [];
                
                if (regularList.length === 0 && specialList.length === 0) {
                    container.innerHTML = '<p class="text-muted text-center">Δεν έχουν προστεθεί άτομα ακόμα</p>';
                } else {
                    // Regular duties order
                    const regularDiv = document.createElement('div');
                    regularDiv.className = 'mb-3';
                    regularDiv.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <strong class="text-primary"><i class="fas fa-calendar-day me-1"></i>Σειρά Κανονικών Υπηρεσιών:</strong>
                        </div>
                        <div id="regularList_${i}"></div>
                    `;
                    container.appendChild(regularDiv);
                    
                    // Special holidays order
                    const specialDiv = document.createElement('div');
                    specialDiv.className = 'mb-3';
                    specialDiv.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <strong class="text-warning"><i class="fas fa-star me-1"></i>Σειρά Ειδικών Αργιών:</strong>
                        </div>
                        <div id="specialList_${i}"></div>
                    `;
                    container.appendChild(specialDiv);
                    
                    // Render regular list
                    const regularContainer = document.getElementById(`regularList_${i}`);
                    if (regularList.length === 0) {
                        regularContainer.innerHTML = '<p class="text-muted text-center small">Δεν υπάρχουν άτομα</p>';
                    } else {
                        regularList.forEach((person, index) => {
                            const personDiv = createPersonItem(i, person, index, 'regular', regularList);
                            regularContainer.appendChild(personDiv);
                        });
                    }
                    
                    // Render special list
                    const specialContainer = document.getElementById(`specialList_${i}`);
                    if (specialList.length === 0) {
                        specialContainer.innerHTML = '<p class="text-muted text-center small">Δεν υπάρχουν άτομα</p>';
                    } else {
                        specialList.forEach((person, index) => {
                            const personDiv = createPersonItem(i, person, index, 'special', specialList);
                            specialContainer.appendChild(personDiv);
                        });
                    }
                }
                
                const rotationSpan = document.getElementById(`group${i}Rotation`);
                const totalPeople = new Set([...(groupData.regular || []), ...(groupData.special || [])]).size;
                rotationSpan.textContent = totalPeople > 0 ? totalPeople : '-';
            }
        }

        // Create person item with reorder controls
        function createPersonItem(groupNum, person, index, listType, listArray) {
            const personDiv = document.createElement('div');
            personDiv.className = 'person-item';
            personDiv.draggable = true;
            personDiv.dataset.groupNum = groupNum;
            personDiv.dataset.index = index;
            personDiv.dataset.listType = listType;
            
            personDiv.innerHTML = `
                <span class="person-name">
                    <i class="fas fa-grip-vertical text-muted me-2" style="cursor: move;"></i>${person}
                </span>
                <div class="person-actions">
                    <div class="btn-group btn-group-sm" role="group">
                        <button class="btn btn-outline-secondary" onclick="movePersonInList(${groupNum}, ${index}, '${listType}', 'up')" ${index === 0 ? 'disabled' : ''} title="Μετακίνηση προς τα πάνω">
                            <i class="fas fa-arrow-up"></i>
                        </button>
                        <button class="btn btn-outline-secondary" onclick="movePersonInList(${groupNum}, ${index}, '${listType}', 'down')" ${index === listArray.length - 1 ? 'disabled' : ''} title="Μετακίνηση προς τα κάτω">
                            <i class="fas fa-arrow-down"></i>
                        </button>
                    </div>
                    <div class="transfer-dropdown">
                        <button class="btn btn-sm btn-outline-primary" onclick="toggleTransferDropdown(${groupNum}, ${index}, '${listType}', event)">
                            <i class="fas fa-exchange-alt"></i>
                        </button>
                        <div class="transfer-dropdown-content" id="transferDropdown_${groupNum}_${index}_${listType}">
                            ${[1, 2, 3, 4].filter(g => g !== groupNum).map(targetGroup => `
                                <button onclick="transferPerson(${groupNum}, ${index}, ${targetGroup}, '${listType}')">
                                    <i class="fas fa-arrow-right me-2"></i>Μεταφορά στην Ομάδα ${targetGroup}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                    <button class="btn btn-sm btn-outline-danger" onclick="removePerson(${groupNum}, ${index}, '${listType}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            
            // Add drag and drop handlers
            personDiv.addEventListener('dragstart', handleDragStart);
            personDiv.addEventListener('dragover', handleDragOver);
            personDiv.addEventListener('drop', handleDrop);
            personDiv.addEventListener('dragend', handleDragEnd);
            
            return personDiv;
        }

        // Drag and drop handlers
        let draggedElement = null;
        
        function handleDragStart(e) {
            draggedElement = this;
            this.style.opacity = '0.5';
            e.dataTransfer.effectAllowed = 'move';
        }
        
        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }
        
        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            
            if (draggedElement !== this) {
                const groupNum = parseInt(this.dataset.groupNum);
                const listType = this.dataset.listType;
                const fromIndex = parseInt(draggedElement.dataset.index);
                const toIndex = parseInt(this.dataset.index);
                
                const list = groups[groupNum][listType];
                const person = list[fromIndex];
                list.splice(fromIndex, 1);
                list.splice(toIndex, 0, person);
                
                saveData();
                renderGroups();
            }
            
            return false;
        }
        
        function handleDragEnd(e) {
            this.style.opacity = '1';
            draggedElement = null;
        }

        // Add person
        function addPerson(groupNumber) {
            currentGroup = groupNumber;
            document.getElementById('modalGroupNumber').textContent = groupNumber;
            document.getElementById('personName').value = '';
            const modal = new bootstrap.Modal(document.getElementById('addPersonModal'));
            modal.show();
        }

        // Save person - adds to both regular and special lists
        function savePerson() {
            const name = document.getElementById('personName').value.trim();
            if (!name) {
                alert('Παρακαλώ εισάγετε όνομα');
                return;
            }
            
            if (!groups[currentGroup]) {
                groups[currentGroup] = { regular: [], special: [] };
            }
            
            // Add to both lists
            if (!groups[currentGroup].regular) groups[currentGroup].regular = [];
            if (!groups[currentGroup].special) groups[currentGroup].special = [];
            
            groups[currentGroup].regular.push(name);
            groups[currentGroup].special.push(name);
            
            saveData();
            renderGroups();
            updateStatistics();
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('addPersonModal'));
            modal.hide();
        }

        // Remove person from specific list
        function removePerson(groupNumber, index, listType) {
            if (confirm('Είστε σίγουροι ότι θέλετε να αφαιρέσετε αυτό το άτομο από αυτή τη λίστα;')) {
                const list = groups[groupNumber][listType];
                const person = list[index];
                list.splice(index, 1);
                
                // Also remove from the other list if it exists there
                const otherListType = listType === 'regular' ? 'special' : 'regular';
                const otherList = groups[groupNumber][otherListType];
                const otherIndex = otherList.indexOf(person);
                if (otherIndex !== -1) {
                    otherList.splice(otherIndex, 1);
                }
                
                saveData();
                renderGroups();
                updateStatistics();
            }
        }

        // Move person up or down in list
        function movePersonInList(groupNumber, index, listType, direction) {
            const list = groups[groupNumber][listType];
            if (direction === 'up' && index > 0) {
                [list[index - 1], list[index]] = [list[index], list[index - 1]];
            } else if (direction === 'down' && index < list.length - 1) {
                [list[index], list[index + 1]] = [list[index + 1], list[index]];
            }
            
            saveData();
            renderGroups();
        }

        // Toggle transfer dropdown
        function toggleTransferDropdown(groupNumber, index, listType, event) {
            event.stopPropagation();
            
            // Close all other dropdowns
            document.querySelectorAll('.transfer-dropdown-content').forEach(dropdown => {
                dropdown.classList.remove('show');
            });
            
            // Toggle current dropdown
            const dropdown = document.getElementById(`transferDropdown_${groupNumber}_${index}_${listType}`);
            dropdown.classList.toggle('show');
        }

        // Transfer person to another group
        function transferPerson(fromGroup, index, toGroup, listType) {
            const list = groups[fromGroup][listType];
            const person = list[index];
            
            if (!person) return;
            
            // Remove from current group's list
            list.splice(index, 1);
            
            // Also remove from other list in same group
            const otherListType = listType === 'regular' ? 'special' : 'regular';
            const otherList = groups[fromGroup][otherListType];
            const otherIndex = otherList.indexOf(person);
            if (otherIndex !== -1) {
                otherList.splice(otherIndex, 1);
            }
            
            // Add to target group (both lists)
            if (!groups[toGroup]) {
                groups[toGroup] = { regular: [], special: [] };
            }
            if (!groups[toGroup].regular) groups[toGroup].regular = [];
            if (!groups[toGroup].special) groups[toGroup].special = [];
            
            groups[toGroup].regular.push(person);
            groups[toGroup].special.push(person);
            
            // Close dropdown
            document.querySelectorAll('.transfer-dropdown-content').forEach(dropdown => {
                dropdown.classList.remove('show');
            });
            
            saveData();
            renderGroups();
            updateStatistics();
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.transfer-dropdown')) {
                document.querySelectorAll('.transfer-dropdown-content').forEach(dropdown => {
                    dropdown.classList.remove('show');
                });
            }
        });

        // Add holiday
        function addHoliday() {
            document.getElementById('holidayDate').value = '';
            document.getElementById('holidayName').value = '';
            const modal = new bootstrap.Modal(document.getElementById('addHolidayModal'));
            modal.show();
        }

        // Save holiday
        function saveHoliday() {
            const date = document.getElementById('holidayDate').value;
            const name = document.getElementById('holidayName').value.trim();
            
            if (!date) {
                alert('Παρακαλώ επιλέξτε ημερομηνία');
                return;
            }
            
            const holidayDate = new Date(date + 'T00:00:00');
            const holidayKey = formatDateKey(holidayDate);
            
            // Check if already exists
            if (holidays.find(h => h.date === holidayKey)) {
                alert('Αυτή η ημερομηνία είναι ήδη σημειωμένη ως αργία');
                return;
            }
            
            holidays.push({
                date: holidayKey,
                name: name || 'Holiday'
            });
            
            saveData();
            renderHolidays();
            renderCalendar();
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('addHolidayModal'));
            modal.hide();
        }

        // Remove holiday
        function removeHoliday(index) {
            if (confirm('Είστε σίγουροι ότι θέλετε να αφαιρέσετε αυτή την αργία;')) {
                holidays.splice(index, 1);
                saveData();
                renderHolidays();
                renderCalendar();
            }
        }

        // Render holidays
        function renderHolidays() {
            const container = document.getElementById('holidaysList');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (holidays.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">Δεν έχουν προστεθεί αργίες ακόμα</p>';
                return;
            }
            
            holidays.sort((a, b) => a.date.localeCompare(b.date));
            
            holidays.forEach((holiday, index) => {
                const holidayDiv = document.createElement('div');
                holidayDiv.className = 'holiday-item';
                const date = new Date(holiday.date + 'T00:00:00');
                holidayDiv.innerHTML = `
                    <div>
                        <strong>${formatDate(date)}</strong>
                        ${holiday.name ? `<span class="text-muted ms-2">- ${holiday.name}</span>` : ''}
                    </div>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeHoliday(${index})">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                container.appendChild(holidayDiv);
            });
        }

        // Configuration: How many years ahead to calculate recurring special holidays
        const SPECIAL_HOLIDAYS_YEARS_AHEAD = 30; // Calculate for next 30 years

        // Initialize default special holidays based on recurring configuration
        function initializeDefaultSpecialHolidays() {
            const currentYear = new Date().getFullYear();
            const yearsToCalculate = SPECIAL_HOLIDAYS_YEARS_AHEAD;
            const defaultHolidays = [];
            
            // Process each recurring holiday definition
            recurringSpecialHolidays.forEach(holidayDef => {
                if (holidayDef.type === 'fixed') {
                    // Fixed date holidays (month + day)
                    for (let year = currentYear; year <= currentYear + yearsToCalculate; year++) {
                        const date = new Date(year, holidayDef.month - 1, holidayDef.day);
                        const dateKey = formatDateKey(date);
                        
                        // Check if already exists
                        if (!specialHolidays.some(h => h.date === dateKey)) {
                            defaultHolidays.push({
                                date: dateKey,
                                name: holidayDef.name
                            });
                        }
                    }
                } else if (holidayDef.type === 'easter-relative') {
                    // Movable holidays based on Orthodox Easter
                    for (let year = currentYear; year <= currentYear + yearsToCalculate; year++) {
                        const orthodoxHolidays = calculateOrthodoxHolidays(year);
                        const easterDate = orthodoxHolidays.easterSunday;
                        
                        const holidayDate = new Date(easterDate);
                        holidayDate.setDate(holidayDate.getDate() + (holidayDef.offset || 0));
                        
                        const dateKey = formatDateKey(holidayDate);
                        
                        // Check if already exists
                        if (!specialHolidays.some(h => h.date === dateKey)) {
                            defaultHolidays.push({
                                date: dateKey,
                                name: holidayDef.name
                            });
                        }
                    }
                }
            });
            
            // Add default holidays if they don't already exist
            if (defaultHolidays.length > 0) {
                defaultHolidays.forEach(defaultHoliday => {
                    specialHolidays.push(defaultHoliday);
                });
                
                // Sort by date
                specialHolidays.sort((a, b) => a.date.localeCompare(b.date));
                // Save to Firebase and localStorage
                saveData();
            }
        }
        
        // Load recurring holidays configuration
        async function loadRecurringHolidaysConfig() {
            try {
                if (window.db) {
                    const db = window.db || firebase.firestore();
                    const user = window.auth?.currentUser;
                    
                    if (user) {
                        const doc = await db.collection('dutyShifts').doc('recurringSpecialHolidays').get();
                        if (doc.exists) {
                            const data = doc.data();
                            recurringSpecialHolidays = data.list || recurringSpecialHolidays;
                        }
                    }
                }
                
                // Fallback to localStorage
                const saved = localStorage.getItem('dutyShiftsRecurringHolidays');
                if (saved) {
                    recurringSpecialHolidays = JSON.parse(saved);
                }
            } catch (error) {
                console.error('Error loading recurring holidays config:', error);
                const saved = localStorage.getItem('dutyShiftsRecurringHolidays');
                if (saved) {
                    recurringSpecialHolidays = JSON.parse(saved);
                }
            }
        }
        
        // Save recurring holidays configuration to Firebase
        async function saveRecurringHolidaysConfig() {
            try {
                if (!window.db) {
                    localStorage.setItem('dutyShiftsRecurringHolidays', JSON.stringify(recurringSpecialHolidays));
                    return;
                }
                
                const db = window.db || firebase.firestore();
                const user = window.auth?.currentUser;
                
                if (!user) {
                    localStorage.setItem('dutyShiftsRecurringHolidays', JSON.stringify(recurringSpecialHolidays));
                    return;
                }
                
                await db.collection('dutyShifts').doc('recurringSpecialHolidays').set({
                    list: recurringSpecialHolidays,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedBy: user.uid
                });
                
                localStorage.setItem('dutyShiftsRecurringHolidays', JSON.stringify(recurringSpecialHolidays));
            } catch (error) {
                console.error('Error saving recurring holidays config:', error);
                localStorage.setItem('dutyShiftsRecurringHolidays', JSON.stringify(recurringSpecialHolidays));
            }
        }

        // Render special holidays
        function renderSpecialHolidays() {
            const container = document.getElementById('specialHolidaysList');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (specialHolidays.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">Δεν έχουν προστεθεί ειδικές αργίες ακόμα</p>';
                return;
            }
            
            specialHolidays.sort((a, b) => a.date.localeCompare(b.date));
            
            specialHolidays.forEach((holiday, index) => {
                const holidayDiv = document.createElement('div');
                holidayDiv.className = 'holiday-item';
                holidayDiv.style.borderLeft = '4px solid #FFC107';
                const date = new Date(holiday.date + 'T00:00:00');
                holidayDiv.innerHTML = `
                    <div>
                        <strong><i class="fas fa-star text-warning me-1"></i>${formatDate(date)}</strong>
                        ${holiday.name ? `<span class="text-muted ms-2">- ${holiday.name}</span>` : ''}
                    </div>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeSpecialHoliday(${index})">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                container.appendChild(holidayDiv);
            });
        }

        // Add special holiday
        function addSpecialHoliday() {
            document.getElementById('specialHolidayDate').value = '';
            document.getElementById('specialHolidayName').value = '';
            const modal = new bootstrap.Modal(document.getElementById('addSpecialHolidayModal'));
            modal.show();
        }

        // Save special holiday
        function saveSpecialHoliday() {
            const date = document.getElementById('specialHolidayDate').value;
            const name = document.getElementById('specialHolidayName').value.trim();
            
            if (!date) {
                alert('Παρακαλώ επιλέξτε ημερομηνία');
                return;
            }
            
            const dateKey = formatDateKey(new Date(date + 'T00:00:00'));
            
            // Check if already exists
            if (specialHolidays.some(h => h.date === dateKey)) {
                alert('Αυτή η ημερομηνία είναι ήδη σημειωμένη ως ειδική αργία');
                return;
            }
            
            specialHolidays.push({
                date: dateKey,
                name: name || ''
            });
            
            // Sort by date
            specialHolidays.sort((a, b) => a.date.localeCompare(b.date));
            
            saveData();
            renderCalendar();
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('addSpecialHolidayModal'));
            modal.hide();
        }

        // Remove special holiday (kept for backward compatibility, but not used in UI)
        function removeSpecialHoliday(index) {
            if (confirm('Είστε σίγουροι ότι θέλετε να αφαιρέσετε αυτή την ειδική αργία;')) {
                specialHolidays.splice(index, 1);
                saveData();
                renderCalendar();
            }
        }

        // Toggle recurring holiday fields based on type
        function toggleRecurringHolidayFields() {
            const type = document.getElementById('recurringHolidayType').value;
            const fixedFields = document.getElementById('fixedDateFields');
            const fixedDayFields = document.getElementById('fixedDayFields');
            const easterFields = document.getElementById('easterOffsetFields');
            
            if (type === 'fixed') {
                fixedFields.style.display = 'block';
                fixedDayFields.style.display = 'block';
                easterFields.style.display = 'none';
            } else {
                fixedFields.style.display = 'none';
                fixedDayFields.style.display = 'none';
                easterFields.style.display = 'block';
            }
        }

        // Render recurring holidays configuration
        function renderRecurringHolidays() {
            const container = document.getElementById('recurringHolidaysList');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (recurringSpecialHolidays.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">Δεν έχουν οριστεί επαναλαμβανόμενες αργίες</p>';
                return;
            }
            
            recurringSpecialHolidays.forEach((holiday, index) => {
                const holidayDiv = document.createElement('div');
                holidayDiv.className = 'holiday-item';
                holidayDiv.style.borderLeft = '4px solid #17a2b8';
                
                let displayText = '';
                if (holiday.type === 'fixed') {
                    const monthNames = ['Ιανουαρίου', 'Φεβρουαρίου', 'Μαρτίου', 'Απριλίου', 'Μαΐου', 'Ιουνίου', 
                                       'Ιουλίου', 'Αυγούστου', 'Σεπτεμβρίου', 'Οκτωβρίου', 'Νοεμβρίου', 'Δεκεμβρίου'];
                    displayText = `${holiday.day} ${monthNames[holiday.month - 1]} - ${holiday.name}`;
                } else if (holiday.type === 'easter-relative') {
                    const offsetText = holiday.offset === 0 ? 'Πάσχα' : 
                                      holiday.offset === -1 ? '1 ημέρα πριν το Πάσχα' :
                                      holiday.offset === 1 ? '1 ημέρα μετά το Πάσχα' :
                                      `${holiday.offset} ημέρες ${holiday.offset > 0 ? 'μετά' : 'πριν'} το Πάσχα`;
                    displayText = `${holiday.name} (${offsetText})`;
                }
                
                holidayDiv.innerHTML = `
                    <div>
                        <strong><i class="fas fa-repeat text-info me-1"></i>${displayText}</strong>
                    </div>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeRecurringHoliday(${index})">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                container.appendChild(holidayDiv);
            });
        }

        // Add recurring holiday
        function addRecurringHoliday() {
            document.getElementById('recurringHolidayType').value = 'fixed';
            document.getElementById('recurringHolidayMonth').value = '';
            document.getElementById('recurringHolidayDay').value = '';
            document.getElementById('recurringHolidayEasterOffset').value = '0';
            document.getElementById('recurringHolidayName').value = '';
            toggleRecurringHolidayFields();
            const modal = new bootstrap.Modal(document.getElementById('addRecurringHolidayModal'));
            modal.show();
        }

        // Save recurring holiday
        function saveRecurringHoliday() {
            const type = document.getElementById('recurringHolidayType').value;
            const name = document.getElementById('recurringHolidayName').value.trim();
            
            if (!name) {
                alert('Παρακαλώ εισάγετε όνομα');
                return;
            }
            
            let holidayDef = { name: name, type: type };
            
            if (type === 'fixed') {
                const month = parseInt(document.getElementById('recurringHolidayMonth').value);
                const day = parseInt(document.getElementById('recurringHolidayDay').value);
                
                if (!month || !day) {
                    alert('Παρακαλώ επιλέξτε μήνα και ημέρα');
                    return;
                }
                
                holidayDef.month = month;
                holidayDef.day = day;
            } else if (type === 'easter-relative') {
                const offset = parseInt(document.getElementById('recurringHolidayEasterOffset').value) || 0;
                holidayDef.offset = offset;
            }
            
            recurringSpecialHolidays.push(holidayDef);
            saveRecurringHolidaysConfig();
            renderRecurringHolidays();
            
            // Regenerate special holidays for all years
            initializeDefaultSpecialHolidays();
            renderCalendar();
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('addRecurringHolidayModal'));
            modal.hide();
        }

        // Remove recurring holiday
        function removeRecurringHoliday(index) {
            if (confirm('Είστε σίγουροι ότι θέλετε να αφαιρέσετε αυτή την επαναλαμβανόμενη αργία;')) {
                recurringSpecialHolidays.splice(index, 1);
                saveRecurringHolidaysConfig();
                renderRecurringHolidays();
                
                // Regenerate special holidays
                initializeDefaultSpecialHolidays();
                renderCalendar();
            }
        }

        // Calculate Orthodox Easter (returns the date of Easter Sunday)
        // Orthodox Easter is calculated using the Julian calendar
        function calculateOrthodoxEaster(year) {
            // Algorithm for calculating Orthodox Easter (Julian calendar)
            const a = year % 19;
            const b = year % 7;
            const c = year % 4;
            
            const d = (19 * a + 15) % 30;
            const e = (2 * c + 4 * b - d + 34) % 7;
            const f = d + e + 114;
            
            const month = Math.floor(f / 31);
            const day = (f % 31) + 1;
            
            // Convert to Gregorian calendar (add 13 days for 20th-21st century)
            const easterDate = new Date(year, month - 1, day);
            easterDate.setDate(easterDate.getDate() + 13);
            
            return easterDate;
        }

        // Calculate all Orthodox holidays based on Easter
        function calculateOrthodoxHolidays(year) {
            const easterSunday = calculateOrthodoxEaster(year);
            const holidays = {};
            
            // Clean Monday (48 days before Easter)
            const cleanMonday = new Date(easterSunday);
            cleanMonday.setDate(cleanMonday.getDate() - 48);
            holidays['cleanMonday'] = cleanMonday;
            
            // Palm Sunday (7 days before Easter)
            const palmSunday = new Date(easterSunday);
            palmSunday.setDate(palmSunday.getDate() - 7);
            holidays['palmSunday'] = palmSunday;
            
            // Good Friday (2 days before Easter)
            const goodFriday = new Date(easterSunday);
            goodFriday.setDate(goodFriday.getDate() - 2);
            holidays['goodFriday'] = goodFriday;
            
            // Great Saturday (1 day before Easter)
            const greatSaturday = new Date(easterSunday);
            greatSaturday.setDate(greatSaturday.getDate() - 1);
            holidays['greatSaturday'] = greatSaturday;
            
            // Easter Sunday (Great Sunday)
            holidays['easterSunday'] = easterSunday;
            
            // Easter Monday (1 day after Easter)
            const easterMonday = new Date(easterSunday);
            easterMonday.setDate(easterMonday.getDate() + 1);
            holidays['easterMonday'] = easterMonday;
            
            // Ascension Day (39 days after Easter)
            const ascensionDay = new Date(easterSunday);
            ascensionDay.setDate(ascensionDay.getDate() + 39);
            holidays['ascensionDay'] = ascensionDay;
            
            // Pentecost (49 days after Easter)
            const pentecost = new Date(easterSunday);
            pentecost.setDate(pentecost.getDate() + 49);
            holidays['pentecost'] = pentecost;
            
            // Whit Monday (50 days after Easter)
            const whitMonday = new Date(easterSunday);
            whitMonday.setDate(whitMonday.getDate() + 50);
            holidays['whitMonday'] = whitMonday;
            
            return holidays;
        }

        // Check if date is a special holiday (only user-defined special holidays)
        function isSpecialHoliday(date) {
            const key = formatDateKey(date);
            return specialHolidays.some(h => h.date === key);
        }

        // Check if date is holiday (including automatically detected Orthodox/Cyprus holidays)
        function isHoliday(date) {
            const key = formatDateKey(date);
            // Check user-defined holidays
            if (holidays.some(h => h.date === key)) {
                return true;
            }
            // Check automatically detected Orthodox/Cyprus holidays
            return isOrthodoxOrCyprusHoliday(date);
        }

        // Check if date is an Orthodox or Cyprus Greek holiday (automatic detection)
        function isOrthodoxOrCyprusHoliday(date) {
            const month = date.getMonth() + 1; // 1-12
            const day = date.getDate();
            const year = date.getFullYear();
            const dateKey = formatDateKey(date);
            
            // Fixed Orthodox/Cyprus holidays
            if (month === 1 && day === 1) return true;  // New Year's Day
            if (month === 1 && day === 6) return true;  // Epiphany/Theophany
            if (month === 3 && day === 25) return true; // Annunciation / Greek Independence Day
            if (month === 4 && day === 1) return true;  // EOKA Liberation Struggle Day
            if (month === 5 && day === 1) return true;  // Labor Day
            if (month === 8 && day === 15) return true; // Dormition of the Theotokos
            if (month === 9 && day === 8) return true;  // Nativity of the Theotokos
            if (month === 9 && day === 14) return true; // Exaltation of the Cross
            if (month === 10 && day === 1) return true; // Cyprus Independence Day
            if (month === 10 && day === 28) return true; // Ochi Day
            if (month === 12 && day === 25) return true; // Christmas (Nativity of Christ)
            if (month === 12 && day === 26) return true; // Synaxis of the Theotokos
            if (month === 12 && day === 31) return true; // New Year's Eve
            
            // Orthodox holidays based on Easter
            const orthodoxHolidays = calculateOrthodoxHolidays(year);
            for (const key in orthodoxHolidays) {
                if (dateKey === formatDateKey(orthodoxHolidays[key])) {
                    return true;
                }
            }
            
            return false;
        }

        // Get Orthodox/Cyprus holiday name for a date (automatic detection)
        function getOrthodoxHolidayNameAuto(date) {
            if (!isOrthodoxOrCyprusHoliday(date)) return null;
            
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const year = date.getFullYear();
            const dateKey = formatDateKey(date);
            
            // Fixed Orthodox holidays
            if (month === 1 && day === 1) return 'Πρωτοχρονιά';
            if (month === 1 && day === 6) return 'Θεοφάνια';
            if (month === 3 && day === 25) return 'Ευαγγελισμός';
            if (month === 4 && day === 1) return 'ΕΟΚΑ';
            if (month === 5 && day === 1) return 'Πρωτομαγιά';
            if (month === 8 && day === 15) return 'Κοίμηση';
            if (month === 9 && day === 8) return 'Γέννηση Θεοτόκου';
            if (month === 9 && day === 14) return 'Σταύρωση';
            if (month === 10 && day === 1) return 'Ανεξαρτησία';
            if (month === 10 && day === 28) return 'Όχι';
            if (month === 12 && day === 25) return 'Χριστούγεννα';
            if (month === 12 && day === 26) return 'Σύναξης';
            if (month === 12 && day === 31) return 'Παραμονή';
            
            // Orthodox holidays based on Easter
            const orthodoxHolidays = calculateOrthodoxHolidays(year);
            
            if (dateKey === formatDateKey(orthodoxHolidays.cleanMonday)) return 'Καθαρά Δευτέρα';
            if (dateKey === formatDateKey(orthodoxHolidays.palmSunday)) return 'Κυριακή Βαΐων';
            if (dateKey === formatDateKey(orthodoxHolidays.goodFriday)) return 'Μ. Παρασκευή';
            if (dateKey === formatDateKey(orthodoxHolidays.greatSaturday)) return 'Μ. Σάββατο';
            if (dateKey === formatDateKey(orthodoxHolidays.easterSunday)) return 'Πάσχα';
            if (dateKey === formatDateKey(orthodoxHolidays.easterMonday)) return 'Δευτέρα Πάσχα';
            if (dateKey === formatDateKey(orthodoxHolidays.ascensionDay)) return 'Ανάληψη';
            if (dateKey === formatDateKey(orthodoxHolidays.pentecost)) return 'Πεντηκοστή';
            if (dateKey === formatDateKey(orthodoxHolidays.whitMonday)) return 'Αγίου Πνεύματος';
            
            return null;
        }

        // Check if date is weekend
        function isWeekend(date) {
            const day = date.getDay();
            return day === 0 || day === 6; // Sunday or Saturday
        }

        // Get day type
        function getDayType(date) {
            // Special holidays have highest priority
            if (isSpecialHoliday(date)) {
                return 'special-holiday';
            }
            
            if (isHoliday(date)) {
                return 'weekend-holiday';
            }
            
            if (isWeekend(date)) {
                return 'weekend-holiday';
            }
            
            // Check if next day is weekend, holiday, or special holiday
            const nextDay = new Date(date);
            nextDay.setDate(nextDay.getDate() + 1);
            
            if (isWeekend(nextDay) || isHoliday(nextDay) || isSpecialHoliday(nextDay)) {
                return 'semi-normal-day';
            }
            
            // Check if it's Friday
            if (date.getDay() === 5) {
                return 'semi-normal-day';
            }
            
            return 'normal-day';
        }

        // Format date key
        function formatDateKey(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Format date for display
        function formatDate(date) {
            return date.toLocaleDateString('el-GR', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                weekday: 'long'
            });
        }

        // Generate a consistent color for a person based on their name
        function getPersonColor(personName) {
            // Create a hash from the person's name
            let hash = 0;
            for (let i = 0; i < personName.length; i++) {
                hash = personName.charCodeAt(i) + ((hash << 5) - hash);
            }
            
            // Generate a color from the hash (bright, distinct colors)
            const hue = Math.abs(hash) % 360;
            // Use high saturation and medium lightness for vibrant colors
            return `hsl(${hue}, 70%, 60%)`;
        }

        // Extract all person names from assignment string
        function extractAllPersonNames(assignment) {
            if (!assignment) return [];
            
            // Match all patterns like "Name (Ομάδα X)"
            const matches = assignment.matchAll(/([^(]+)\s*\(Ομάδα\s*(\d+)\)/g);
            const persons = [];
            
            for (const match of matches) {
                if (match[1]) {
                    persons.push({
                        name: match[1].trim(),
                        group: parseInt(match[2])
                    });
                }
            }
            
            return persons;
        }

        // Get person colors for a day
        function getDayPersonColors(assignment) {
            if (!assignment) return [];
            
            const persons = extractAllPersonNames(assignment);
            return persons.map(p => ({
                color: getPersonColor(p.name),
                name: p.name,
                group: p.group
            }));
        }

        // Get holiday name for a date (checks special holidays first, then auto-detected Orthodox holidays)
        function getOrthodoxHolidayName(date) {
            // First check special holidays (user-defined)
            if (isSpecialHoliday(date)) {
                const key = formatDateKey(date);
                const holiday = specialHolidays.find(h => h.date === key);
                return holiday ? holiday.name : null;
            }
            
            // Then check auto-detected Orthodox/Cyprus holidays
            return getOrthodoxHolidayNameAuto(date);
        }

        // Render calendar
        function renderCalendar() {
            const calendarGrid = document.getElementById('calendarGrid');
            const currentMonthYear = document.getElementById('currentMonthYear');
            
            if (!calendarGrid || !currentMonthYear) {
                console.error('Calendar elements not found');
                return;
            }
            
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            currentMonthYear.textContent = 
                currentDate.toLocaleDateString('el-GR', { month: 'long', year: 'numeric' });
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            // Convert Sunday (0) to 6, Monday (1) to 0, etc. for Monday-first calendar
            let startingDayOfWeek = firstDay.getDay();
            startingDayOfWeek = startingDayOfWeek === 0 ? 6 : startingDayOfWeek - 1;
            
            const grid = calendarGrid;
            grid.innerHTML = '';
            
            // Day headers - Monday first
            const dayHeaders = ['Δευ', 'Τρι', 'Τετ', 'Πεμ', 'Παρ', 'Σαβ', 'Κυρ'];
            dayHeaders.forEach(header => {
                const headerDiv = document.createElement('div');
                headerDiv.className = 'calendar-day-header';
                headerDiv.textContent = header;
                grid.appendChild(headerDiv);
            });
            
            // Empty cells for days before month starts
            for (let i = 0; i < startingDayOfWeek; i++) {
                const emptyDiv = document.createElement('div');
                grid.appendChild(emptyDiv);
            }
            
            // Days of the month
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dayType = getDayType(date);
                const isToday = date.getTime() === today.getTime();
                const key = formatDateKey(date);
                const assignment = dutyAssignments[key];
                
                const dayDiv = document.createElement('div');
                dayDiv.className = `calendar-day ${dayType} ${isToday ? 'today' : ''}`;
                if (isHoliday(date) || isOrthodoxOrCyprusHoliday(date)) {
                    dayDiv.classList.add('holiday');
                }
                if (isSpecialHoliday(date)) {
                    dayDiv.classList.add('special-holiday');
                }
                
                // Apply person-specific colors
                const personColorData = getDayPersonColors(assignment);
                
                if (personColorData.length > 0) {
                    // Use the first person's color as left border
                    const mainColor = personColorData[0].color;
                    dayDiv.style.borderLeft = `4px solid ${mainColor}`;
                    
                    // If multiple people, add top border with second color
                    if (personColorData.length > 1) {
                        dayDiv.style.borderTop = `3px solid ${personColorData[1].color}`;
                    }
                    
                    // Add a subtle box shadow with the person's color
                    dayDiv.style.boxShadow = `0 0 8px ${mainColor}40, inset 0 0 0 1px ${mainColor}30`;
                }
                
                dayDiv.onclick = () => showDayDetails(date);
                
                // Get holiday name (special holiday first, then Orthodox/Cyprus holiday)
                const holidayName = getOrthodoxHolidayName(date);
                
                dayDiv.innerHTML = `
                    <div class="day-number">${day}</div>
                    <div class="day-type">${getDayTypeLabel(dayType)}</div>
                    ${holidayName ? `<div class="orthodox-holiday-name">${holidayName}</div>` : ''}
                    ${assignment ? `<div class="duty-person">${assignment}</div>` : ''}
                `;
                
                grid.appendChild(dayDiv);
            }
        }

        // Get day type label
        function getDayTypeLabel(dayType) {
            switch(dayType) {
                case 'special-holiday': return 'Ειδική';
                case 'normal-day': return 'Κανονική';
                case 'semi-normal-day': return 'Ημι-Κανονική';
                case 'weekend-holiday': return 'Σαββατοκύριακο/Αργία';
                default: return '';
            }
        }

        // Previous month
        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        }

        // Next month
        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        }

        // Check if a person has duty on a specific day
        function hasDutyOnDay(dayKey, person, groupNum) {
            const assignment = dutyAssignments[dayKey];
            if (!assignment) return false;
            
            const personGroupStr = `${person} (Ομάδα ${groupNum})`;
            return assignment.includes(personGroupStr);
        }

        // Check if a person has duty on consecutive days (day before or day after)
        function hasConsecutiveDuty(dayKey, person, groupNum) {
            const date = new Date(dayKey + 'T00:00:00');
            
            // Check day before
            const dayBefore = new Date(date);
            dayBefore.setDate(dayBefore.getDate() - 1);
            const dayBeforeKey = formatDateKey(dayBefore);
            if (hasDutyOnDay(dayBeforeKey, person, groupNum)) {
                return true;
            }
            
            // Check day after
            const dayAfter = new Date(date);
            dayAfter.setDate(dayAfter.getDate() + 1);
            const dayAfterKey = formatDateKey(dayAfter);
            if (hasDutyOnDay(dayAfterKey, person, groupNum)) {
                return true;
            }
            
            return false;
        }


        // Check if person had duty on a special holiday before this date
        // If so, and current day is a weekend (Saturday/Sunday) or holiday, skip this person
        function hadSpecialHolidayDutyBefore(dayKey, person, groupNum) {
            const date = new Date(dayKey + 'T00:00:00');
            const dayOfWeek = date.getDay(); // 0=Sunday, 6=Saturday
            const currentDayType = getDayType(date);
            
            // Only apply this rule if current day is:
            // - A weekend (Saturday or Sunday)
            // - OR a holiday (weekend-holiday type, but not special holiday)
            const isWeekend = dayOfWeek === 0 || dayOfWeek === 6; // Sunday or Saturday
            const isHoliday = currentDayType === 'weekend-holiday' && !isSpecialHoliday(date);
            
            if (!isWeekend && !isHoliday) {
                return false;
            }
            
            // Check the previous 30 days for special holiday duty
            // This ensures we catch the "next" weekend/holiday after a special holiday
            for (let i = 1; i <= 30; i++) {
                const checkDate = new Date(date);
                checkDate.setDate(checkDate.getDate() - i);
                const checkKey = formatDateKey(checkDate);
                
                // Check if this was a special holiday and person had duty
                if (isSpecialHoliday(checkDate) && hasDutyOnDay(checkKey, person, groupNum)) {
                    return true;
                }
            }
            
            return false;
        }

        // Check if person had duty on consecutive weekend/holiday days
        // If so, skip them from the next weekend/holiday
        function hasConsecutiveWeekendHolidayDuty(dayKey, person, groupNum) {
            const date = new Date(dayKey + 'T00:00:00');
            const currentDayType = getDayType(date);
            
            // Only apply this rule if current day is a weekend/holiday
            if (currentDayType !== 'weekend-holiday' || isSpecialHoliday(date)) {
                return false;
            }
            
            // Check if person had duty on the previous weekend/holiday day
            // Look back up to 7 days to find the previous weekend/holiday
            let consecutiveCount = 0;
            let foundPreviousWeekendHoliday = false;
            
            for (let i = 1; i <= 7; i++) {
                const checkDate = new Date(date);
                checkDate.setDate(checkDate.getDate() - i);
                const checkKey = formatDateKey(checkDate);
                const checkDayType = getDayType(checkDate);
                
                // If we find a weekend/holiday day (not special holiday)
                if (checkDayType === 'weekend-holiday' && !isSpecialHoliday(checkDate)) {
                    foundPreviousWeekendHoliday = true;
                    if (hasDutyOnDay(checkKey, person, groupNum)) {
                        consecutiveCount++;
                        // Continue checking backwards for more consecutive days
                    } else {
                        // Found a weekend/holiday without duty, stop counting
                        break;
                    }
                } else if (checkDayType !== 'weekend-holiday' && foundPreviousWeekendHoliday) {
                    // We already found a weekend/holiday, and now we hit a non-weekend/holiday
                    // This breaks the consecutive sequence
                    break;
                }
            }
            
            // If person had duty on 2 or more consecutive weekend/holiday days before this one, skip them
            // This prevents assigning them to a third consecutive weekend/holiday
            return consecutiveCount >= 2;
        }

        // Check if person had duty on consecutive special holidays
        // If so, skip them from the next special holiday
        function hasConsecutiveSpecialHolidayDuty(dayKey, person, groupNum) {
            const date = new Date(dayKey + 'T00:00:00');
            
            // Only apply this rule if current day is a special holiday
            if (!isSpecialHoliday(date)) {
                return false;
            }
            
            // Check if person had duty on any previous special holiday
            // Look back up to 30 days to catch all special holidays
            for (let i = 1; i <= 30; i++) {
                const checkDate = new Date(date);
                checkDate.setDate(checkDate.getDate() - i);
                const checkKey = formatDateKey(checkDate);
                
                // If we find a special holiday where person had duty, it's consecutive
                // This prevents assigning the same person to multiple special holidays in a row
                if (isSpecialHoliday(checkDate) && hasDutyOnDay(checkKey, person, groupNum)) {
                    return true;
                }
            }
            
            return false;
        }

        // Count days of a specific type since last duty for a person
        // startDate is optional - if provided, will also check assignments before this date
        function countDaysSinceLastDuty(dayKey, person, groupNum, dayTypeCategory, allDaysByType, startDate = null) {
            const daysOfType = allDaysByType[dayTypeCategory];
            const currentIndex = daysOfType.indexOf(dayKey);
            
            if (currentIndex === -1) {
                return Infinity; // Current day not in this type
            }
            
            // Find last duty day for this person in this day type (before current day)
            let lastDutyIndex = -1;
            for (let i = currentIndex - 1; i >= 0; i--) {
                if (hasDutyOnDay(daysOfType[i], person, groupNum)) {
                    lastDutyIndex = i;
                    break;
                }
            }
            
            // If startDate is provided, also check existing assignments before the start date
            if (startDate && lastDutyIndex === -1) {
                const currentDate = new Date(dayKey + 'T00:00:00');
                const checkDate = new Date(startDate);
                checkDate.setDate(checkDate.getDate() - 1); // Day before start date
                
                // Look backwards from start date to find last duty
                let daysBack = 0;
                const maxDaysBack = 365; // Check up to 1 year back
                
                while (daysBack < maxDaysBack && checkDate >= new Date(2000, 0, 1)) { // Don't go before year 2000
                    const checkKey = formatDateKey(checkDate);
                    const checkDayType = getDayType(checkDate);
                    let checkTypeCategory = 'normal';
                    
                    if (checkDayType === 'special-holiday') {
                        checkTypeCategory = 'special';
                    } else if (checkDayType === 'semi-normal-day') {
                        checkTypeCategory = 'semi';
                    } else if (checkDayType === 'weekend-holiday') {
                        checkTypeCategory = 'weekend';
                    }
                    
                    // Only count if it's the same day type category
                    if (checkTypeCategory === dayTypeCategory && hasDutyOnDay(checkKey, person, groupNum)) {
                        // Found a previous duty - calculate days between
                        const daysBetween = Math.floor((currentDate - checkDate) / (1000 * 60 * 60 * 24));
                        // Count only days of the same type between them
                        let sameTypeDays = 0;
                        const tempDate = new Date(checkDate);
                        tempDate.setDate(tempDate.getDate() + 1);
                        while (tempDate < currentDate) {
                            const tempDayType = getDayType(tempDate);
                            let tempTypeCategory = 'normal';
                            if (tempDayType === 'special-holiday') {
                                tempTypeCategory = 'special';
                            } else if (tempDayType === 'semi-normal-day') {
                                tempTypeCategory = 'semi';
                            } else if (tempDayType === 'weekend-holiday') {
                                tempTypeCategory = 'weekend';
                            }
                            if (tempTypeCategory === dayTypeCategory) {
                                sameTypeDays++;
                            }
                            tempDate.setDate(tempDate.getDate() + 1);
                        }
                        return sameTypeDays;
                    }
                    
                    checkDate.setDate(checkDate.getDate() - 1);
                    daysBack++;
                }
            }
            
            if (lastDutyIndex === -1) {
                return Infinity; // Never had duty of this type
            }
            
            // Count how many days of this type between last duty and current day
            return currentIndex - lastDutyIndex;
        }

        // Open calculate duties modal
        function openCalculateDutiesModal() {
            // Set default to current month
            const currentYear = currentDate.getFullYear();
            const currentMonth = String(currentDate.getMonth() + 1).padStart(2, '0');
            document.getElementById('calculateStartMonth').value = `${currentYear}-${currentMonth}`;
            document.getElementById('calculateEndMonth').value = '';
            document.getElementById('preserveExistingAssignments').checked = true;
            
            const modal = new bootstrap.Modal(document.getElementById('calculateDutiesModal'));
            modal.show();
        }

        // Calculate duties for selected months
        function calculateDutiesForSelectedMonths() {
            const startMonth = document.getElementById('calculateStartMonth').value;
            const endMonth = document.getElementById('calculateEndMonth').value;
            const preserveExisting = document.getElementById('preserveExistingAssignments').checked;
            
            if (!startMonth) {
                alert('Παρακαλώ επιλέξτε τουλάχιστον τον μήνα έναρξης');
                return;
            }
            
            // Parse start date
            const [startYear, startMonthNum] = startMonth.split('-').map(Number);
            const startDate = new Date(startYear, startMonthNum - 1, 1);
            
            // Parse end date (or use start month if not specified)
            let endDate;
            if (endMonth) {
                const [endYear, endMonthNum] = endMonth.split('-').map(Number);
                endDate = new Date(endYear, endMonthNum, 0); // Last day of the month
            } else {
                endDate = new Date(startYear, startMonthNum, 0); // Last day of start month
            }
            
            // Store existing assignments if preserving
            const existingAssignments = preserveExisting ? { ...dutyAssignments } : {};
            
            // Clear assignments only for the selected date range if not preserving
            if (!preserveExisting) {
                const dateIterator = new Date(startDate);
                while (dateIterator <= endDate) {
                    const key = formatDateKey(dateIterator);
                    delete dutyAssignments[key];
                    dateIterator.setDate(dateIterator.getDate() + 1);
                }
            }
            
            // Calculate duties for the selected range
            calculateDutiesForDateRange(startDate, endDate, preserveExisting);
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('calculateDutiesModal'));
            modal.hide();
        }

        // Calculate duties for a specific date range
        function calculateDutiesForDateRange(startDate, endDate, preserveExisting = true) {
            
            // Process each group
            for (let groupNum = 1; groupNum <= 4; groupNum++) {
                const groupData = groups[groupNum] || { regular: [], special: [] };
                const regularPeople = groupData.regular || [];
                const specialPeople = groupData.special || [];
                
                if (regularPeople.length === 0 && specialPeople.length === 0) continue;
                
                // Separate days by type with priority: special > weekend > semi > normal
                const dayTypeLists = {
                    special: [],  // Highest priority - special holidays
                    weekend: [],  // Second priority
                    semi: [],     // Third priority
                    normal: []   // Lowest priority
                };
                
                // Build lists of days by type
                const dateIterator = new Date(startDate);
                while (dateIterator <= endDate) {
                    const dayType = getDayType(dateIterator);
                    const key = formatDateKey(dateIterator);
                    let typeCategory = 'normal';
                    
                    if (dayType === 'special-holiday') {
                        typeCategory = 'special';
                    } else if (dayType === 'semi-normal-day') {
                        typeCategory = 'semi';
                    } else if (dayType === 'weekend-holiday') {
                        typeCategory = 'weekend';
                    }
                    
                    dayTypeLists[typeCategory].push(key);
                    dateIterator.setDate(dateIterator.getDate() + 1);
                }
                
                // Track deferred assignments for swap logic (shared across all day types)
                // Format: { skippedPerson: string, skippedDay: string, replacementPerson: string, replacementDay: string, groupNum: number, dayTypeCategory: string }
                const deferredAssignments = [];
                
                // Helper function to assign duty for a day type with proper rotation
                function assignDutiesForDayType(dayTypeCategory, priorityLevel) {
                    const days = dayTypeLists[dayTypeCategory];
                    if (days.length === 0) return;
                    
                    // Use special order for special holidays, regular order for others
                    const isSpecialHolidayType = dayTypeCategory === 'special';
                    const groupPeople = isSpecialHolidayType ? specialPeople : regularPeople;
                    
                    if (groupPeople.length === 0) return;
                    
                    const rotationDays = groupPeople.length;
                    
                    days.forEach((dayKey, dayIndex) => {
                        // Check if this day already has a manual assignment for this group
                        const existingAssignment = dutyAssignments[dayKey];
                        if (preserveExisting && existingAssignment && existingAssignment.includes(`(Ομάδα ${groupNum})`)) {
                            // Skip - this day already has a manual assignment for this group
                            return;
                        }
                        
                        // Find the person who should be on duty based on rotation
                        // Logic: Each person should be on duty every N days of this specific type
                        // We need to find who has waited the longest (or is most eligible) for this day type
                        
                        // First, calculate days since last duty for all people
                        const personEligibility = [];
                        for (let i = 0; i < groupPeople.length; i++) {
                            const person = groupPeople[i];
                            const daysSinceLastDuty = countDaysSinceLastDuty(dayKey, person, groupNum, dayTypeCategory, dayTypeLists, startDate);
                            const isEligible = daysSinceLastDuty >= rotationDays || daysSinceLastDuty === Infinity;
                            
                            personEligibility.push({
                                person: person,
                                index: i,
                                daysSinceLastDuty: daysSinceLastDuty,
                                isEligible: isEligible
                            });
                        }
                        
                        // Sort by eligibility (eligible first), then by days since last duty (longest wait first)
                        // If tied, use rotation order (index)
                        personEligibility.sort((a, b) => {
                            if (a.isEligible !== b.isEligible) {
                                return b.isEligible - a.isEligible; // Eligible first
                            }
                            if (a.daysSinceLastDuty !== b.daysSinceLastDuty) {
                                return b.daysSinceLastDuty - a.daysSinceLastDuty; // Longest wait first
                            }
                            return a.index - b.index; // Rotation order
                        });
                        
                        // The ideal person is the first eligible person, or if none are eligible, the one who has waited longest
                        const idealPerson = personEligibility[0].person;
                        const idealPersonIndex = personEligibility[0].index;
                        const daysSinceLastDuty = personEligibility[0].daysSinceLastDuty;
                        const isEligible = personEligibility[0].isEligible;
                        
                        // Check for conflicts
                        const hasConflict = hasConsecutiveDuty(dayKey, idealPerson, groupNum) || 
                                         hasFridaySundayDuty(dayKey, idealPerson, groupNum) ||
                                         hadSpecialHolidayDutyBefore(dayKey, idealPerson, groupNum) ||
                                         hasConsecutiveWeekendHolidayDuty(dayKey, idealPerson, groupNum) ||
                                         hasConsecutiveSpecialHolidayDuty(dayKey, idealPerson, groupNum);
                        
                        let assignedPerson = null;
                        let skippedPerson = null;
                        
                        // Check for strict conflicts (consecutive special holidays or consecutive weekend/holiday)
                        const hasStrictConflict = hasConsecutiveSpecialHolidayDuty(dayKey, idealPerson, groupNum) ||
                                                 hasConsecutiveWeekendHolidayDuty(dayKey, idealPerson, groupNum);
                        
                        // For special holidays and weekends (priority 1-2), don't assign if there are strict conflicts
                        // Strict conflicts must be avoided even for high priority days
                        if (priorityLevel <= 2 && isEligible && !hasStrictConflict) {
                            assignedPerson = idealPerson;
                        } else if (isEligible && !hasConflict) {
                            // Ideal person is eligible and has no conflicts
                            assignedPerson = idealPerson;
                        } else {
                            // Need to find alternative person
                            // Track if ideal person was skipped due to special holiday conflict
                            const skippedDueToSpecialHoliday = isEligible && (hasConflict || hasStrictConflict) && 
                                                              (hadSpecialHolidayDutyBefore(dayKey, idealPerson, groupNum) ||
                                                               hasConsecutiveSpecialHolidayDuty(dayKey, idealPerson, groupNum));
                            
                            if (skippedDueToSpecialHoliday) {
                                skippedPerson = idealPerson;
                            }
                            
                            // Try all people in eligibility order (already sorted by eligibility and wait time)
                            for (let i = 0; i < personEligibility.length; i++) {
                                const candidateData = personEligibility[i];
                                const candidatePerson = candidateData.person;
                                
                                // Skip the ideal person if they have conflict
                                if (candidatePerson === idealPerson && hasConflict) {
                                    continue;
                                }
                                
                                const candidateDaysSince = candidateData.daysSinceLastDuty;
                                const candidateEligible = candidateData.isEligible;
                                const candidateConflict = hasConsecutiveDuty(dayKey, candidatePerson, groupNum) || 
                                                         hasFridaySundayDuty(dayKey, candidatePerson, groupNum) ||
                                                         hadSpecialHolidayDutyBefore(dayKey, candidatePerson, groupNum) ||
                                                         hasConsecutiveWeekendHolidayDuty(dayKey, candidatePerson, groupNum) ||
                                                         hasConsecutiveSpecialHolidayDuty(dayKey, candidatePerson, groupNum);
                                
                                // Check for strict conflicts for candidate
                                const candidateStrictConflict = hasConsecutiveSpecialHolidayDuty(dayKey, candidatePerson, groupNum) ||
                                                               hasConsecutiveWeekendHolidayDuty(dayKey, candidatePerson, groupNum);
                                
                                // For special holidays and weekends, don't assign if there are strict conflicts
                                if (priorityLevel <= 2 && candidateEligible && !candidateStrictConflict) {
                                    assignedPerson = candidatePerson;
                                    break;
                                }
                                
                                // For semi and normal, only assign if eligible and no conflicts
                                if (candidateEligible && !candidateConflict) {
                                    assignedPerson = candidatePerson;
                                    break;
                                }
                            }
                            
                            // If we found a replacement and ideal person was skipped due to special holiday
                            if (assignedPerson && skippedPerson && skippedPerson !== assignedPerson) {
                                // Store deferred assignment for swap
                                deferredAssignments.push({
                                    skippedPerson: skippedPerson,
                                    skippedDay: dayKey,
                                    replacementPerson: assignedPerson,
                                    replacementDay: null, // Will be set later
                                    groupNum: groupNum,
                                    dayTypeCategory: dayTypeCategory
                                });
                            }
                        }
                        
                        // Assign duty if we found a person
                        if (assignedPerson) {
                            if (dutyAssignments[dayKey]) {
                                dutyAssignments[dayKey] += `, ${assignedPerson} (Ομάδα ${groupNum})`;
                            } else {
                                dutyAssignments[dayKey] = `${assignedPerson} (Ομάδα ${groupNum})`;
                            }
                        }
                    });
                }
                
                // Assign duties in priority order: special > weekend > semi > normal
                // Priority 1: Special Holidays (highest priority)
                assignDutiesForDayType('special', 1);
                
                // Priority 2: Weekend/Holiday days
                assignDutiesForDayType('weekend', 2);
                
                // Priority 3: Semi-normal days
                assignDutiesForDayType('semi', 3);
                
                // Priority 4: Normal days
                assignDutiesForDayType('normal', 4);
                
                // Old loop - replaced with priority-based assignments above
                /*for (const typeCategory in dayTypeLists) {
                    const days = dayTypeLists[typeCategory];
                    if (days.length === 0) continue;
                    
                    const rotationDays = groupPeople.length;
                    let personIndex = 0;
                    
                    // Simple rotation: assign person 0 to day 0, person 1 to day 1, etc.
                    // After rotationDays days, cycle back to person 0
                    days.forEach((dayKey, dayIndex) => {
                        // Calculate which person should be on duty
                        // Every rotationDays days, we cycle through all people
                        const rotationPosition = dayIndex % rotationDays;
                        const person = groupPeople[rotationPosition];
                        
                        // Allow multiple groups to assign on the same day
                        if (dutyAssignments[dayKey]) {
                            dutyAssignments[dayKey] += `, ${person} (Ομάδα ${groupNum})`;
                        } else {
                            dutyAssignments[dayKey] = `${person} (Ομάδα ${groupNum})`;
                        }
                    });
                }*/
            }
            
            saveData();
            renderCalendar();
            alert('Οι αναθέσεις υπηρεσιών υπολογίστηκαν επιτυχώς για την επιλεγμένη περίοδο!');
        }

        // Show day details
        function showDayDetails(date) {
            const key = formatDateKey(date);
            const assignment = dutyAssignments[key];
            const dayType = getDayType(date);
            
            // Store selected date for manual assignment
            selectedDateForDuty = date;
            
            const modal = new bootstrap.Modal(document.getElementById('dayDetailsModal'));
            document.getElementById('dayDetailsTitle').textContent = formatDate(date);
            
            let content = `
                <div class="mb-3">
                    <strong>Τύπος Ημέρας:</strong> ${getDayTypeLabel(dayType)}
                </div>
            `;
            
            if (isSpecialHoliday(date)) {
                const holidayName = getOrthodoxHolidayName(date);
                const displayName = holidayName || 'Ειδική Αργία';
                
                content += `
                    <div class="alert alert-warning" style="background: #FFE082; border-color: #FFC107;">
                        <i class="fas fa-star me-2"></i>
                        <strong>Ειδική Αργία:</strong> ${displayName}
                    </div>
                `;
            } else if (isOrthodoxOrCyprusHoliday(date)) {
                const holidayName = getOrthodoxHolidayNameAuto(date);
                content += `
                    <div class="alert alert-info">
                        <i class="fas fa-church me-2"></i>
                        <strong>Ορθόδοξη/Κυπριακή Αργία:</strong> ${holidayName || 'Αργία'}
                    </div>
                `;
            } else if (isHoliday(date)) {
                const holiday = holidays.find(h => h.date === key);
                content += `
                    <div class="alert alert-info">
                        <i class="fas fa-calendar-times me-2"></i>
                        <strong>Αργία:</strong> ${holiday ? holiday.name : 'Αργία'}
                    </div>
                `;
            }
            
            if (assignment) {
                content += `
                    <div class="duty-assignment">
                        <strong><i class="fas fa-user-shield me-2"></i>Σε Υπηρεσία:</strong> ${assignment}
                    </div>
                `;
            } else {
                content += `
                    <div class="alert alert-secondary">
                        <i class="fas fa-info-circle me-2"></i>Δεν υπάρχει ανάθεση υπηρεσίας για αυτή την ημέρα
                    </div>
                `;
            }
            
            document.getElementById('dayDetailsContent').innerHTML = content;
            
            // Show/hide buttons based on whether assignment exists
            const assignBtn = document.getElementById('assignDutyBtn');
            const editBtn = document.getElementById('editDutyBtn');
            const removeBtn = document.getElementById('removeDutyBtn');
            
            if (assignment) {
                assignBtn.style.display = 'none';
                editBtn.style.display = 'inline-block';
                removeBtn.style.display = 'inline-block';
            } else {
                assignBtn.style.display = 'inline-block';
                editBtn.style.display = 'none';
                removeBtn.style.display = 'none';
            }
            
            modal.show();
        }

        // Open assign duty modal from day details
        function openAssignDutyModal() {
            // Close day details modal
            const dayDetailsModal = bootstrap.Modal.getInstance(document.getElementById('dayDetailsModal'));
            if (dayDetailsModal) {
                dayDetailsModal.hide();
            }
            
            openAssignDutyModalForDate(selectedDateForDuty);
        }

        // Open assign duty modal for a specific date (or current date if not specified)
        function openAssignDutyModalForDate(date = null) {
            // Clear previous event listeners
            const groupSelect = document.getElementById('assignDutyGroup');
            const newGroupSelect = groupSelect.cloneNode(true);
            groupSelect.parentNode.replaceChild(newGroupSelect, groupSelect);
            
            // Set date in assign modal
            const dateInput = document.getElementById('assignDutyDate');
            if (date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                dateInput.value = `${year}-${month}-${day}`;
                selectedDateForDuty = date;
            } else {
                // Use today's date
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                dateInput.value = `${year}-${month}-${day}`;
                selectedDateForDuty = today;
            }
            
            // Reset form
            document.getElementById('assignDutyGroup').value = '';
            document.getElementById('assignDutyPerson').innerHTML = '<option value="">Επιλέξτε Άτομο</option>';
            
            // Update person dropdown when group changes
            document.getElementById('assignDutyGroup').addEventListener('change', function() {
                updatePersonDropdown();
            });
            
            // Open modal
            const modal = new bootstrap.Modal(document.getElementById('assignDutyModal'));
            modal.show();
        }

        // Update person dropdown based on selected group
        function updatePersonDropdown() {
            const groupSelect = document.getElementById('assignDutyGroup');
            const personSelect = document.getElementById('assignDutyPerson');
            const selectedGroup = parseInt(groupSelect.value);
            
            personSelect.innerHTML = '<option value="">Επιλέξτε Άτομο</option>';
            
            if (selectedGroup && groups[selectedGroup]) {
                const groupData = groups[selectedGroup];
                const regularList = groupData.regular || [];
                const specialList = groupData.special || [];
                // Combine both lists, removing duplicates
                const allPeople = [...new Set([...regularList, ...specialList])];
                
                if (allPeople.length > 0) {
                    allPeople.forEach(person => {
                        const option = document.createElement('option');
                        option.value = person;
                        option.textContent = person;
                        personSelect.appendChild(option);
                    });
                }
            }
        }

        // Save manual duty assignment
        function saveManualDuty() {
            const date = document.getElementById('assignDutyDate').value;
            const groupNum = parseInt(document.getElementById('assignDutyGroup').value);
            const person = document.getElementById('assignDutyPerson').value.trim();
            
            if (!date) {
                alert('Παρακαλώ επιλέξτε ημερομηνία');
                return;
            }
            
            if (!groupNum || !person) {
                alert('Παρακαλώ επιλέξτε ομάδα και άτομο');
                return;
            }
            
            const dateKey = formatDateKey(new Date(date + 'T00:00:00'));
            
            // Check if assignment already exists
            if (dutyAssignments[dateKey]) {
                // Update existing assignment
                const existing = dutyAssignments[dateKey];
                // Remove old assignment for this group if exists
                const updated = existing.split(', ').filter(a => !a.includes(`Ομάδα ${groupNum}`));
                updated.push(`${person} (Ομάδα ${groupNum})`);
                dutyAssignments[dateKey] = updated.join(', ');
            } else {
                // Create new assignment
                dutyAssignments[dateKey] = `${person} (Ομάδα ${groupNum})`;
            }
            
            saveData();
            renderCalendar();
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('assignDutyModal'));
            modal.hide();
            
            alert('Η ανάθεση υπηρεσίας αποθηκεύτηκε επιτυχώς!');
        }

        // Remove duty assignment
        function removeDutyAssignment() {
            if (!selectedDateForDuty) return;
            
            if (!confirm('Είστε σίγουροι ότι θέλετε να αφαιρέσετε την ανάθεση υπηρεσίας για αυτή την ημέρα;')) {
                return;
            }
            
            const key = formatDateKey(selectedDateForDuty);
            delete dutyAssignments[key];
            
            saveData();
            renderCalendar();
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('dayDetailsModal'));
            modal.hide();
            
            alert('Η ανάθεση υπηρεσίας αφαιρέθηκε επιτυχώς!');
        }

        // Update statistics
        function updateStatistics() {
            let totalPeople = 0;
            let totalRotation = 0;
            let groupCount = 0;
            
            for (let i = 1; i <= 4; i++) {
                const groupData = groups[i] || { regular: [], special: [] };
                const regularList = groupData.regular || [];
                const specialList = groupData.special || [];
                // Count unique people across both lists
                const uniquePeople = new Set([...regularList, ...specialList]);
                const peopleCount = uniquePeople.size;
                
                if (peopleCount > 0) {
                    totalPeople += peopleCount;
                    totalRotation += peopleCount;
                    groupCount++;
                }
            }
            
            document.getElementById('totalPeople').textContent = totalPeople;
            document.getElementById('avgRotation').textContent = 
                groupCount > 0 ? Math.round(totalRotation / groupCount) : 0;
        }
    </script>
</body>
</html>


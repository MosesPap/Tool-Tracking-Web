<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <title>My Tools - Tool Tracking</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/common.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    <script src="js/common.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }

        .mytools-title {
            color: orange;
            font-weight: bold;
            font-size: 2.2rem;
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
        }

        /* Back to Menu button 3D interactive Grey */
        .mytools-back {
            position: relative;
            padding: 6px 12px;
            font-size: 0.9rem;
            font-weight: bold;
            border-radius: 12px;
            border: 2px solid #bdbdbd;
            background: linear-gradient(135deg, #e0e0e0 0%, #bdbdbd 100%);
            color: #333;
            text-decoration: none;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(189, 189, 189, 0.3);
            cursor: pointer;
            white-space: nowrap;
            transform: perspective(1000px) rotateX(0deg);
            margin-bottom: 1rem;
        }

        .mytools-back:hover {
            background: linear-gradient(135deg, #d0d0d0 0%, #adadad 100%);
            border-color: #adadad;
            transform: perspective(1000px) rotateX(5deg) translateY(-2px);
            box-shadow: 0 4px 12px rgba(189, 189, 189, 0.4),
                        0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .mytools-back:active {
            transform: perspective(1000px) rotateX(2deg) translateY(0px);
            box-shadow: 0 2px 4px rgba(189, 189, 189, 0.3);
        }

        /* 3D Interactive Grey Button for Add Collection */
        .add-collection-btn-3d {
            position: relative;
            width: 100%;
            padding: 12px 24px;
            font-size: 1rem;
            font-weight: bold;
            border-radius: 12px;
            border: 2px solid #bdbdbd;
            background: linear-gradient(135deg, #e0e0e0 0%, #bdbdbd 100%);
            color: #333;
            text-decoration: none;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(189, 189, 189, 0.3);
            cursor: pointer;
            transform: perspective(1000px) rotateX(0deg);
            margin-top: 10px;
        }

        .add-collection-btn-3d:hover {
            background: linear-gradient(135deg, #d0d0d0 0%, #adadad 100%);
            border-color: #adadad;
            transform: perspective(1000px) rotateX(5deg) translateY(-2px);
            box-shadow: 0 4px 12px rgba(189, 189, 189, 0.4),
                       0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .add-collection-btn-3d:active {
            transform: perspective(1000px) rotateX(2deg) translateY(0px);
            box-shadow: 0 2px 4px rgba(189, 189, 189, 0.3);
        }

        .mytools-collection {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
            border-radius: 6px 6px 0 0;
            padding: 6px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1.5rem;
            border: 2px solid #F57C00;
            border-bottom: none;
            box-shadow: 0 2px 4px rgba(255, 152, 0, 0.3),
                        inset 0 1px 0 rgba(255, 255, 255, 0.2);
            transform: perspective(1000px) rotateX(2deg);
            transition: all 0.3s ease;
        }

        .mytools-collection:hover {
            background: linear-gradient(135deg, #FFB74D 0%, #FF9800 100%);
            border-color: #FF9800;
            transform: perspective(1000px) rotateX(0deg) translateY(-1px);
            box-shadow: 0 3px 8px rgba(255, 152, 0, 0.4),
                        inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        .mytools-location {
            background: linear-gradient(135deg, #cbe7ff 0%, #a8d5ff 100%);
            color: #222;
            font-weight: bold;
            font-size: 1.1rem;
            border-radius: 0 0 6px 6px;
            padding: 6px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            border: 2px solid #a8d5ff;
            border-top: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1),
                        inset 0 1px 0 rgba(255, 255, 255, 0.4);
            transform: perspective(1000px) rotateX(1deg);
            transition: all 0.3s ease;
        }

        .mytools-location:hover {
            background: linear-gradient(135deg, #d4edff 0%, #b8e0ff 100%);
            border-color: #b8e0ff;
            transform: perspective(1000px) rotateX(0deg) translateY(-1px);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15),
                        inset 0 1px 0 rgba(255, 255, 255, 0.5);
        }

        .mytools-tool-item {
            padding: 12px 12px 8px 12px;
            border-radius: 0 0 6px 6px;
            margin-bottom: 0.5rem;
            font-size: 1.08rem;
            border: 2px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1),
                        inset 0 1px 0 rgba(255, 255, 255, 0.5);
            transform: perspective(1000px) rotateX(1deg);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .mytools-tool-item:hover {
            transform: perspective(1000px) rotateX(0deg) translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15),
                        inset 0 1px 0 rgba(255, 255, 255, 0.6);
        }

        .mytools-tool-item:active {
            transform: perspective(1000px) rotateX(1deg) translateY(0px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1),
                        inset 0 1px 0 rgba(255, 255, 255, 0.5);
        }

        .mytools-tool-bg1 {
            background: linear-gradient(135deg, #fff 0%, #f5f5f5 100%);
        }

        .mytools-tool-bg2 {
            background: linear-gradient(135deg, #fff7e6 0%, #ffe8cc 100%);
        }

        .mytools-tool-name {
            font-weight: bold;
            font-size: 1.13rem;
            display: block !important;
            margin-bottom: 4px !important;
            width: 100% !important;
            clear: both !important;
        }

        .mytools-tool-tid {
            font-weight: bold;
            display: block !important;
            margin-bottom: 4px !important;
            width: 100% !important;
            clear: both !important;
        }

        .mytools-tool-part {
            font-size: 1.01rem;
            color: #444;
        }

        .mytools-status-in {
            color: #388E3C;
            font-weight: bold;
            font-size: 1.05rem;
        }

        .mytools-status-out {
            color: #d32f2f;
            font-weight: bold;
            font-size: 1.05rem;
        }

        .mytools-status-broken {
            color: #ff6f00;
            font-weight: bold;
            font-size: 1.05rem;
        }

        .mytools-status-lost {
            color: #ff8f00;
            font-weight: bold;
            font-size: 1.05rem;
        }

        .mytools-status-calibration {
            color: #1976d2;
            font-weight: bold;
            font-size: 1.05rem;
        }

        .mytools-tool-extra {
            font-size: 1.01rem;
            color: #222;
            margin-top: 2px;
        }

        .mytools-tool-cal {
            color: #388E3C;
            font-size: 1.01rem;
            margin-top: 2px;
        }

        /* 3D Interactive Buttons */
        #myToolsScreen .btn,
        #myToolsByCollectionScreen .btn {
            border-radius: 12px;
            border: 2px solid;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2),
                        inset 0 1px 0 rgba(255, 255, 255, 0.3),
                        inset 0 -1px 0 rgba(0, 0, 0, 0.1);
            transform: perspective(1000px) rotateX(2deg);
            transition: all 0.3s ease;
        }

        #myToolsScreen .btn:hover,
        #myToolsByCollectionScreen .btn:hover {
            transform: perspective(1000px) rotateX(0deg) translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3),
                        inset 0 1px 0 rgba(255, 255, 255, 0.4),
                        inset 0 -1px 0 rgba(0, 0, 0, 0.1);
        }

        #myToolsScreen .btn:active,
        #myToolsByCollectionScreen .btn:active {
            transform: perspective(1000px) rotateX(2deg) translateY(0px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2),
                        inset 0 1px 0 rgba(255, 255, 255, 0.3),
                        inset 0 -1px 0 rgba(0, 0, 0, 0.1);
        }

        /* Collection selection buttons */
        .collection-select-btn {
            border-radius: 12px;
            border: 2px solid;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2),
                        inset 0 1px 0 rgba(255, 255, 255, 0.3),
                        inset 0 -1px 0 rgba(0, 0, 0, 0.1);
            transform: perspective(1000px) rotateX(2deg);
            transition: all 0.3s ease;
        }

        .collection-select-btn:hover {
            transform: perspective(1000px) rotateX(0deg) translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3),
                        inset 0 1px 0 rgba(255, 255, 255, 0.4),
                        inset 0 -1px 0 rgba(0, 0, 0, 0.1);
        }

        .collection-select-btn:active {
            transform: perspective(1000px) rotateX(2deg) translateY(0px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2),
                        inset 0 1px 0 rgba(255, 255, 255, 0.3),
                        inset 0 -1px 0 rgba(0, 0, 0, 0.1);
        }

        /* Location filter buttons */
        .btn[data-location] {
            border-radius: 12px;
            border: 2px solid;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2),
                        inset 0 1px 0 rgba(255, 255, 255, 0.3),
                        inset 0 -1px 0 rgba(0, 0, 0, 0.1);
            transform: perspective(1000px) rotateX(2deg);
            transition: all 0.3s ease;
        }

        .btn[data-location]:hover {
            transform: perspective(1000px) rotateX(0deg) translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3),
                        inset 0 1px 0 rgba(255, 255, 255, 0.4),
                        inset 0 -1px 0 rgba(0, 0, 0, 0.1);
        }

        .btn[data-location]:active {
            transform: perspective(1000px) rotateX(2deg) translateY(0px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2),
                        inset 0 1px 0 rgba(255, 255, 255, 0.3),
                        inset 0 -1px 0 rgba(0, 0, 0, 0.1);
        }

        /* Photo buttons in title bars */
        #myToolsAddCollectionPhotoBtn,
        #myToolsCollectionPhotosBtn,
        #myToolsByCollectionAddPhotoBtn,
        #myToolsByCollectionPhotosBtn,
        #locationPhotoBtn {
            border-radius: 16px;
            border: 2px solid;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2),
                        inset 0 1px 0 rgba(255, 255, 255, 0.3),
                        inset 0 -1px 0 rgba(0, 0, 0, 0.1);
            transform: perspective(1000px) rotateX(2deg);
            transition: all 0.3s ease;
        }

        #myToolsAddCollectionPhotoBtn:hover,
        #myToolsCollectionPhotosBtn:hover,
        #myToolsByCollectionAddPhotoBtn:hover,
        #myToolsByCollectionPhotosBtn:hover,
        #locationPhotoBtn:hover {
            transform: perspective(1000px) rotateX(0deg) translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3),
                        inset 0 1px 0 rgba(255, 255, 255, 0.4),
                        inset 0 -1px 0 rgba(0, 0, 0, 0.1);
        }

        #myToolsAddCollectionPhotoBtn:active,
        #myToolsCollectionPhotosBtn:active,
        #myToolsByCollectionAddPhotoBtn:active,
        #myToolsByCollectionPhotosBtn:active,
        #locationPhotoBtn:active {
            transform: perspective(1000px) rotateX(2deg) translateY(0px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2),
                        inset 0 1px 0 rgba(255, 255, 255, 0.3),
                        inset 0 -1px 0 rgba(0, 0, 0, 0.1);
        }

        /* Photo buttons in tool cards */
        .mytools-photo-btn {
            border: 2px solid !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2),
                        inset 0 1px 0 rgba(255, 255, 255, 0.3),
                        inset 0 -1px 0 rgba(0, 0, 0, 0.1) !important;
            transform: perspective(1000px) rotateX(2deg) !important;
            transition: all 0.3s ease !important;
        }

        .mytools-photo-btn:hover {
            transform: perspective(1000px) rotateX(0deg) translateY(-2px) !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3),
                        inset 0 1px 0 rgba(255, 255, 255, 0.4),
                        inset 0 -1px 0 rgba(0, 0, 0, 0.1) !important;
        }

        .mytools-photo-btn:active {
            transform: perspective(1000px) rotateX(2deg) translateY(0px) !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2),
                        inset 0 1px 0 rgba(255, 255, 255, 0.3),
                        inset 0 -1px 0 rgba(0, 0, 0, 0.1) !important;
        }

        /* Responsive font sizes for mobile */
        @media (max-width: 768px) {
            #myToolsScreenBody .mytools-tool-item * {
                font-size: 1.1rem !important;
            }

            #myToolsScreenBody .mytools-tool-item .mytools-tool-name {
                font-size: 1.3rem !important;
            }

            #myToolsScreenBody .mytools-tool-item [class*="mytools-status-"] {
                font-size: 1.0rem !important;
                padding: 5px 10px !important;
            }
        }

        /* Larger fonts for desktop */
        @media (min-width: 1025px) {
            #myToolsScreenBody .mytools-tool-item * {
                font-size: 1.5rem !important;
            }

            #myToolsScreenBody .mytools-tool-item .mytools-tool-name {
                font-size: 1.8rem !important;
            }

            #myToolsScreenBody .mytools-tool-item [class*="mytools-status-"] {
                font-size: 1.3rem !important;
                padding: 6px 12px !important;
            }
        }
    </style>
</head>
<body>
    <!-- My Tools Screen (hidden by default - will show collection selection first) -->
    <div id="myToolsScreen" style="display:none;">
        <div class="container py-4">
            <button id="myToolsBackBtn" class="mytools-back" onclick="handleBackNavigation()">
                <i class="fas fa-arrow-left"></i> Back to Menu
            </button>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                <h2 class="mytools-title" style="margin:0;">MY TOOLS</h2>
                <div style="display:flex;gap:8px;">
                    <button id="myToolsAddCollectionPhotoBtn" style="background:#4CAF50;color:white;border:none;border-radius:16px;padding:8px 16px;font-size:0.9rem;font-weight:bold;cursor:pointer;">
                        <i class="fas fa-camera"></i> Add Collection Photo
                    </button>
                    <button id="myToolsCollectionPhotosBtn" style="background:#9C27B0;color:white;border:none;border-radius:16px;padding:8px 16px;font-size:0.9rem;font-weight:bold;cursor:pointer;">
                        <i class="fas fa-images"></i> Collection Photos
                    </button>
                </div>
            </div>
            <div id="myToolsScreenBody"></div>
        </div>
    </div>

    <!-- My Tools by Collection Screen -->
    <div id="myToolsByCollectionScreen" style="display:none;">
        <!-- Orange Title Bar -->
        <div style="background: #FF9800; color: white; padding: 1rem 0; width: 100%; position: relative;">
            <div class="container">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <h2 style="color: white; font-weight: bold; font-size: 2rem; margin: 0;" id="myToolsCollectionTitle"></h2>
                    <div style="display:flex;gap:8px;">
                        <button id="myToolsByCollectionAddPhotoBtn" style="background:#4CAF50;color:white;border:none;border-radius:16px;padding:8px 16px;font-size:0.9rem;font-weight:bold;cursor:pointer;">
                            <i class="fas fa-camera"></i> Add Collection Photo
                        </button>
                        <button id="myToolsByCollectionPhotosBtn" style="background:#9C27B0;color:white;border:none;border-radius:16px;padding:8px 16px;font-size:0.9rem;font-weight:bold;cursor:pointer;">
                            <i class="fas fa-images"></i> Collection Photos
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="container py-4">
            <button id="backToCollectionSelectBtn" class="mytools-back mb-3" onclick="handleBackNavigation()">
                <i class="fas fa-arrow-left"></i> Back to Menu
            </button>
            <div class="row mb-3">
                <div class="col-6">
                    <button id="collectionCheckupBtn" class="btn btn-success w-100">
                        <i class="fas fa-clipboard-check"></i> Collection Checkup
                    </button>
                </div>
                <div class="col-6">
                    <button id="selectDifferentCollectionBtn" class="btn btn-primary w-100">
                        <i class="fas fa-exchange-alt"></i> Select Collection
                    </button>
                </div>
            </div>
            <!-- Add Location Photo Button -->
            <div class="mb-3">
                <button id="locationPhotoBtn" class="btn btn-info w-100">
                    <i class="fas fa-camera"></i> Add Location Photo
                </button>
            </div>
            <div id="myToolsByCollectionList"></div>
        </div>
    </div>

    <!-- Collection Checkup Screen -->
    <div id="collectionCheckupScreen" style="display:none;">
        <!-- Orange Title Bar -->
        <div style="background: #FF9800; color: white; padding: 1rem 0; width: 100%; position: relative;">
            <div class="container">
                <h2 style="color: white; font-weight: bold; font-size: 2rem; margin: 0; text-align: center;">Collection Checkup</h2>
            </div>
        </div>
        
        <div class="container py-4">
            <button id="backToMyToolsByCollectionBtn" class="btn btn-outline-secondary mb-3">
                <i class="fas fa-arrow-left"></i> Back to Collection
            </button>
            
            <!-- Show Results and History buttons -->
            <div class="row mb-3" id="checkupActionButtons" style="display:none;">
                <div class="col-6">
                    <button id="showResultsBtn" class="btn btn-primary w-100">
                        <i class="fas fa-chart-bar"></i> Show Results
                    </button>
                </div>
                <div class="col-6">
                    <button id="checkupHistoryBtn" class="btn btn-secondary w-100">
                        <i class="fas fa-history"></i> History
                    </button>
                </div>
            </div>
            
            <!-- Collection Header with Progress -->
            <div id="checkupCollectionHeader" class="mb-3" style="background: #FF9800; color: white; padding: 12px; border-radius: 8px;">
                <div class="row align-items-center">
                    <div class="col-6">
                        <div id="checkupLocationTitle" style="font-size: 1.2rem; font-weight: bold;">All Locations</div>
                    </div>
                    <div class="col-3 text-center">
                        <button id="selectAllBtn" class="btn btn-success btn-sm">
                            <i class="fas fa-check-double"></i> Select All
                        </button>
                    </div>
                    <div class="col-3 text-end">
                        <div><strong>Progress:</strong></div>
                        <div id="checkupProgress" style="font-size: 1.1rem; font-weight: bold;">0/0</div>
                    </div>
                </div>
            </div>
            
            <!-- Tools List -->
            <div id="checkupToolsList" style="height: calc(100vh - 400px); overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 10px; margin-bottom: 80px;"></div>
            
            <!-- Location Filter Bar -->
            <div id="checkupLocationFilter" class="mt-3" style="background: #f5f5f5; padding: 8px; border-radius: 8px; position: fixed; bottom: 0; left: 0; right: 0; z-index: 1000; border-top: 2px solid #FF9800;">
                <div class="d-flex gap-2 overflow-x-auto" id="checkupLocationButtons"></div>
            </div>
        </div>
    </div>

    <!-- Checkup Results Modal -->
    <div class="modal fade" id="checkupResultsModal" tabindex="-1" aria-labelledby="checkupResultsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="checkupResultsModalLabel">Checkup Results</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="checkupResultsContent">
                    <!-- Results content will be populated here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="saveCheckupResultsBtn">
                        <i class="fas fa-save"></i> Save Results
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Checkup Save Success Modal -->
    <div class="modal fade" id="checkupSaveSuccessModal" tabindex="-1" aria-labelledby="checkupSaveSuccessModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="checkupSaveSuccessModalLabel">Checkup Results Saved</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Checkup results have been successfully saved to the database.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Checkup History Screen -->
    <div id="checkupHistoryScreen" style="display:none;">
        <!-- Orange Title Bar -->
        <div style="background: #FF9800; color: white; padding: 1rem 0; width: 100%; position: relative;">
            <div class="container">
                <h2 style="color: white; font-weight: bold; font-size: 2rem; margin: 0; text-align: center;">Checkup History - <span id="checkupHistoryTechName"></span></h2>
            </div>
        </div>
        
        <div class="container py-4">
            <button id="checkupHistoryBackBtn" class="btn" style="background:#FF9800;color:white;font-weight:bold;font-size:1.2em;border-radius:24px;padding:8px 32px 8px 32px;margin-bottom:1rem;">
                Back
            </button>
            <div class="row mb-3">
                <div class="col-8 col-md-6 mb-2">
                    <input id="checkupHistorySearch" class="form-control" placeholder="Search by date or collection..." />
                </div>
                <div class="col-4 col-md-3 mb-2">
                    <select id="checkupHistoryCollectionFilter" class="form-select">
                        <option value="All">All</option>
                    </select>
                </div>
                <div class="col-12 col-md-3 mb-2 d-flex gap-2">
                    <button id="checkupHistoryRefreshBtn" class="btn w-100" style="background:#FF9800;color:white;font-weight:bold;font-size:1em;border-radius:24px;">Refresh History</button>
                </div>
            </div>
            <div class="mb-3">
                <button id="checkupHistoryCleanupBtn" class="btn w-100" style="background:#f44336;color:white;font-weight:bold;font-size:1em;border-radius:24px;">Cleanup Old Records (&gt;1 month)</button>
            </div>
            <div id="checkupHistoryList"></div>
        </div>
    </div>

    <!-- Checkup History Details Modal -->
    <div class="modal fade" id="checkupDetailsModal" tabindex="-1" aria-labelledby="checkupDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="checkupDetailsModalLabel">Checkup Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="checkupDetailsContent">
                    <!-- Details will be populated here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Checkout Info Modal for My Tools -->
    <div class="modal fade" id="checkoutInfoModal" tabindex="-1" aria-labelledby="checkoutInfoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="checkoutInfoModalTitle">Tool Checkout Information</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="checkoutInfoModalBody">
                    <!-- Checkout info will be populated here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tool Photo Gallery Modal -->
    <div class="modal fade" id="toolPhotoGalleryModal" tabindex="-1" aria-labelledby="toolPhotoGalleryModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-0">
                    <h5 class="modal-title" id="toolPhotoGalleryModalLabel">Tool Photos</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body d-flex flex-column align-items-center justify-content-center position-relative" id="toolPhotoGalleryContent">
                    <!-- Photo will be shown here -->
                </div>
                <div class="modal-footer justify-content-center border-0 bg-dark">
                    <span id="toolPhotoCounter" class="text-white"></span>
                    <button type="button" class="btn btn-danger ms-3" id="toolPhotoDeleteBtn">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Photo Upload Loading Modal -->
    <div class="modal fade" id="photoUploadLoadingModal" tabindex="-1" aria-labelledby="photoUploadLoadingModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="photoUploadLoadingModalLabel">Uploading Photo</h5>
                </div>
                <div class="modal-body text-center">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div id="photoUploadProgress">Processing image...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Photo Upload Choice Modal -->
    <div class="modal fade" id="photoUploadChoiceModal" tabindex="-1" aria-labelledby="photoUploadChoiceModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="border-radius: 16px; border: none; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                <div class="modal-header" style="background: #FF9800; color: white; border-radius: 16px 16px 0 0; border: none; padding: 20px;">
                    <h5 class="modal-title" id="photoUploadChoiceModalLabel" style="font-weight: bold; font-size: 1.3rem;">
                        <i class="fas fa-camera"></i> Add Photo
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" style="padding: 24px;">
                    <div style="margin-bottom: 16px;">
                        <strong style="font-size: 1.1rem; color: #333;">Other tools with this part number that have photos:</strong>
                        <div id="photoUploadToolsList" style="margin-top: 8px; padding: 12px; background: #f5f5f5; border-radius: 8px;"></div>
                    </div>
                    <div style="margin-bottom: 16px;">
                        <strong style="font-size: 1.1rem; color: #333;">Select photos to use (click to select/deselect):</strong>
                        <div id="photoUploadThumbnails" style="margin-top: 8px; padding: 12px; background: #f5f5f5; border-radius: 8px; display: flex; flex-wrap: wrap; gap: 8px; max-height: 250px; overflow-y: auto;"></div>
                        <div id="selectedPhotosCount" style="margin-top: 8px; text-align: center; color: #666; font-size: 0.9rem;">
                            <span id="selectedCount">0</span> photo(s) selected
                        </div>
                    </div>
                    <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #ddd;">
                        <div class="d-grid gap-2" id="selectedPhotosActions" style="margin-bottom: 12px;">
                            <button type="button" class="btn" id="addSelectedPhotosMyToolBtn" style="background: #2196F3; color: white; font-weight: bold; border-radius: 12px; padding: 12px; font-size: 1rem;" disabled>
                                <i class="fas fa-user-check"></i> Add Selected to MY Tool
                            </button>
                            <button type="button" class="btn" id="addSelectedPhotosAllToolsBtn" style="background: #673AB7; color: white; font-weight: bold; border-radius: 12px; padding: 12px; font-size: 1rem;" disabled>
                                <i class="fas fa-users"></i> Add Selected to ALL Tools üîê
                            </button>
                        </div>
                        <div class="d-grid gap-2">
                            <button type="button" class="btn" id="addNewPhotoMyToolBtn" style="background: #4CAF50; color: white; font-weight: bold; border-radius: 12px; padding: 12px; font-size: 1rem;">
                                <i class="fas fa-camera"></i> Add New Photo to MY Tool
                            </button>
                            <button type="button" class="btn" id="addNewPhotoAllToolsBtn" style="background: #FF5722; color: white; font-weight: bold; border-radius: 12px; padding: 12px; font-size: 1rem;">
                                <i class="fas fa-camera-retro"></i> Add New Photo to ALL Tools üîê
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Photo Delete Choice Modal -->
    <div class="modal fade" id="photoDeleteChoiceModal" tabindex="-1" aria-labelledby="photoDeleteChoiceModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="photoDeleteChoiceModalLabel">Delete Photo</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p><strong>This photo is used by the following tool owners:</strong></p>
                    <div id="photoDeleteOwnersList"></div>
                    <div class="d-grid gap-2 mt-3">
                        <button type="button" class="btn btn-warning" id="deleteMyToolOnlyBtn">
                            <i class="fas fa-user"></i> Delete from MY Tool Only
                        </button>
                        <button type="button" class="btn btn-danger" id="deleteFromAllToolsBtn">
                            <i class="fas fa-users"></i> Delete from ALL Tools üîê
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Collection Selection Modal -->
    <div class="modal fade" id="collectionSelectModal" tabindex="-1" aria-labelledby="collectionSelectModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="collectionSelectModalLabel">Select Collection</h5>
                    <button type="button" class="btn-close btn-close-white" id="collectionSelectModalCloseBtn" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="collectionSelectBody">
                    <!-- Collections will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Add New Collection Modal -->
    <div class="modal fade" id="addCollectionModal" tabindex="-1" aria-labelledby="addCollectionModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="addCollectionModalLabel">Add New Collection</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addCollectionForm">
                        <div class="mb-3">
                            <label for="collectionNameInput" class="form-label"><strong>Collection Name *</strong></label>
                            <input type="text" class="form-control" id="collectionNameInput" placeholder="e.g., Col-1, AV-1" required>
                        </div>
                        <div class="mb-3">
                            <label for="collectionDescriptionInput" class="form-label"><strong>Description</strong></label>
                            <textarea class="form-control" id="collectionDescriptionInput" rows="3" placeholder="Enter collection description"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="collectionPhotoInput" class="form-label"><strong>Collection Photo</strong></label>
                            <input type="file" class="form-control" id="collectionPhotoInput" accept="image/*">
                            <small class="form-text text-muted">Optional: Upload a photo for this collection</small>
                        </div>
                        <div id="addCollectionError" class="text-danger mb-3" style="display: none;"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveCollectionBtn">Save Collection</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Global variables
        let lastViewedCollectionName = null;
        let lastViewedCollectionTools = [];
        
        // Checkup functionality variables
        let checkupCheckedTools = new Set();
        let checkupSelectedLocation = 'All';
        let checkupLocationStats = {};
        
        // Helper function to escape HTML
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        let photoUploadToAllTools = false;
        let currentPhotoUploadToolId = null;
        let currentPhotoUploadPartNumber = null;
        let photoUploadAutoShareTargets = [];
        let currentToolPhotoUrls = [];

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async function() {
            // Wait for common.js to load and use global Firebase instances
            function waitForAuth() {
                const auth = window.auth;
                const db = window.db;
                
                if (!auth || !db) {
                    console.log('[MY-TOOLS] Waiting for common.js to load...');
                    setTimeout(waitForAuth, 50);
                    return;
                }
                
                console.log('[MY-TOOLS] ‚úì Using global Firebase instances from common.js');
                initializePage(auth, db);
            }
            
            async function initializePage(auth, db) {
                console.log('[MY-TOOLS] ====== initializePage() called ======');
                console.log('[MY-TOOLS] Timestamp:', new Date().toISOString());
                console.log('[MY-TOOLS] localStorage.authVerified:', localStorage.getItem('authVerified'));
                console.log('[MY-TOOLS] localStorage.fullName:', localStorage.getItem('fullName'));
                console.log('[MY-TOOLS] auth.currentUser (sync):', auth ? (auth.currentUser ? auth.currentUser.email : 'null') : 'auth not initialized');
                
                let initializationComplete = false;
                
                // Function to complete page initialization
                async function completeInitialization() {
                    if (initializationComplete) {
                        console.log('[MY-TOOLS] completeInitialization() already called, skipping');
                        return;
                    }
                    initializationComplete = true;
                    
                    console.log('[MY-TOOLS] ====== completeInitialization() called ======');
                    console.log('[MY-TOOLS] Timestamp:', new Date().toISOString());
                    // Show collection selection modal first (matching index.html behavior)
                    console.log('[MY-TOOLS] Calling showCollectionSelectionDialog()...');
                    await showCollectionSelectionDialog();
                    console.log('[MY-TOOLS] Collection selection dialog shown');
                    console.log('[MY-TOOLS] completeInitialization() completed');
                }
                
                // SEAMLESS NAVIGATION: Check localStorage first - if flag exists, proceed IMMEDIATELY
                const authVerified = localStorage.getItem('authVerified');
                const storedFullName = localStorage.getItem('fullName');
                
                console.log('[MY-TOOLS] Checking auth flags...');
                console.log('[MY-TOOLS] authVerified:', authVerified);
                console.log('[MY-TOOLS] storedFullName:', storedFullName);
                
                if (authVerified === 'true' && storedFullName) {
                    // User was authenticated in main-menu - proceed IMMEDIATELY (no waiting)
                    console.log('[MY-TOOLS] ‚úì Auth verified flag found - proceeding immediately');
                    console.log('[MY-TOOLS] Calling completeInitialization() immediately...');
                    await completeInitialization();
                
                // Verify auth in background (non-blocking) - but wait a bit for Firebase to restore session
                console.log('[MY-TOOLS] Scheduling background auth verification (300ms delay)...');
                setTimeout(() => {
                    console.log('[MY-TOOLS] Background auth check starting...');
                    // First check currentUser (synchronous check)
                    const currentUser = auth.currentUser;
                    console.log('[MY-TOOLS] auth.currentUser (after delay):', currentUser ? currentUser.email : 'null');
                    if (currentUser) {
                        console.log('[MY-TOOLS] ‚úì Auth confirmed via currentUser:', currentUser.email);
                        localStorage.setItem('authVerified', 'true');
                        return;
                    }
                    
                    // If currentUser is null, wait for onAuthStateChanged (but only redirect if truly logged out)
                    console.log('[MY-TOOLS] currentUser is null, setting up onAuthStateChanged listener...');
                    let authCheckComplete = false;
                    const unsubscribe = auth.onAuthStateChanged(async function(user) {
                        console.log('[MY-TOOLS] onAuthStateChanged fired in background check, user:', user ? user.email : 'null');
                        if (authCheckComplete) {
                            console.log('[MY-TOOLS] Background check already completed, ignoring event');
                            return; // Only process first event
                        }
                        authCheckComplete = true;
                        
                        if (user) {
                            console.log('[MY-TOOLS] ‚úì Auth confirmed via onAuthStateChanged:', user.email);
                            localStorage.setItem('authVerified', 'true');
                        } else {
                            // Only redirect if we're certain user is logged out
                            console.log('[MY-TOOLS] ‚ö† Background auth check: no user found after delay');
                            console.log('[MY-TOOLS] Scheduling double-check (500ms delay)...');
                            setTimeout(() => {
                                const doubleCheckUser = auth.currentUser;
                                console.log('[MY-TOOLS] Double-check auth.currentUser:', doubleCheckUser ? doubleCheckUser.email : 'null');
                                if (!doubleCheckUser) {
                                    console.log('[MY-TOOLS] ‚úó User confirmed logged out - redirecting to main-menu.html');
                                    localStorage.removeItem('authVerified');
                                    localStorage.removeItem('fullName');
                                    window.location.href = 'main-menu.html';
                                } else {
                                    console.log('[MY-TOOLS] ‚úì User found in double-check, staying on page');
                                }
                            }, 500);
                        }
                        unsubscribe(); // Clean up listener
                        console.log('[MY-TOOLS] Background auth check completed, listener unsubscribed');
                    });
                }, 300); // Give Firebase 300ms to restore session
                
                console.log('[MY-TOOLS] Returning from initializePage() - page initialized immediately');
                return; // Exit - page initialized, no delays
                } else {
                    // No stored flag - wait for Firebase auth
                    console.log('[MY-TOOLS] ‚úó No auth flag found - waiting for Firebase auth');
                    console.log('[MY-TOOLS] Setting up onAuthStateChanged listener (no flag path)...');
                    auth.onAuthStateChanged(async function(user) {
                        console.log('[MY-TOOLS] onAuthStateChanged fired (no flag path), user:', user ? user.email : 'null');
                        if (user && !user.emailVerified) {
                            console.log('[MY-TOOLS] ‚úó User email not verified, signing out...');
                            auth.signOut();
                            localStorage.removeItem('authVerified');
                            window.location.href = 'main-menu.html';
                            return;
                        }
                        
                        if (user) {
                            console.log('[MY-TOOLS] ‚úì User authenticated, setting flags and initializing...');
                            localStorage.setItem('authVerified', 'true');
                            if (!localStorage.getItem('fullName')) {
                                localStorage.setItem('fullName', user.email);
                                console.log('[MY-TOOLS] Stored fullName:', user.email);
                            }
                            await completeInitialization();
                        } else {
                            console.log('[MY-TOOLS] ‚úó No user found, redirecting to main-menu.html');
                            localStorage.removeItem('authVerified');
                            window.location.href = 'main-menu.html';
                        }
                    });
                }
            }
            
            // Setup event listeners
            setupEventListeners();
            
            // Start waiting for common.js
            waitForAuth();
        });

        // Setup event listeners
        function setupEventListeners() {
            // Collection photo buttons for My Tools screen
            const myToolsAddBtn = document.getElementById('myToolsAddCollectionPhotoBtn');
            if (myToolsAddBtn) {
                myToolsAddBtn.onclick = function() {
                    showCollectionSelectionForPhotos();
                };
            }

            const myToolsPhotosBtn = document.getElementById('myToolsCollectionPhotosBtn');
            if (myToolsPhotosBtn) {
                myToolsPhotosBtn.onclick = function() {
                    showCollectionSelectionForPhotos();
                };
            }

            // Collection photo buttons for My Tools by Collection screen
            const byCollectionAddBtn = document.getElementById('myToolsByCollectionAddPhotoBtn');
            if (byCollectionAddBtn) {
                byCollectionAddBtn.onclick = function() {
                    if (lastViewedCollectionName) {
                        createCollectionPhotoUploadInput(lastViewedCollectionName);
                    }
                };
            }

            const byCollectionPhotosBtn = document.getElementById('myToolsByCollectionPhotosBtn');
            if (byCollectionPhotosBtn) {
                byCollectionPhotosBtn.onclick = function() {
                    if (lastViewedCollectionName) {
                        const tempElement = document.createElement('div');
                        tempElement.setAttribute('data-collection-name', lastViewedCollectionName);
                        showCollectionPhotoGallery(tempElement);
                    }
                };
            }

            // Collection checkup button
            const checkupBtn = document.getElementById('collectionCheckupBtn');
            if (checkupBtn) {
                checkupBtn.onclick = function() {
                    showCollectionCheckupScreen();
                };
            }

            // Select different collection button
            const selectCollectionBtn = document.getElementById('selectDifferentCollectionBtn');
            if (selectCollectionBtn) {
                selectCollectionBtn.onclick = function() {
                    showCollectionSelectionDialog();
                };
            }

            // Location photo button
            const locationPhotoBtn = document.getElementById('locationPhotoBtn');
            if (locationPhotoBtn) {
                locationPhotoBtn.onclick = function() {
                    if (lastViewedCollectionName) {
                        showLocationPhotoUploadDialog(lastViewedCollectionName, '');
                    }
                };
            }

            // Handle browser back button
            window.addEventListener('popstate', function(event) {
                if (event.state && event.state.modal) {
                    const modal = bootstrap.Modal.getInstance(document.getElementById(event.state.modal));
                    if (modal) modal.hide();
                } else if (event.state && event.state.screen === 'myToolsByCollection') {
                    // If we're going back from collection view, show collection selection again
                    showCollectionSelectionDialog();
                } else {
                    handleBackNavigation();
                }
            });
        }

        // Handle back navigation
        function handleBackNavigation() {
            window.location.href = 'main-menu.html';
        }

        // Show collection selection dialog (matching index.html)
        async function showCollectionSelectionDialog() {
            const auth = window.auth || firebase.auth();
            const db = window.db || firebase.firestore();
            
            // Wait for user to be available (Firebase may need time to restore session)
            let user = auth.currentUser;
            if (!user) {
                console.log('[MY-TOOLS] showCollectionSelectionDialog: auth.currentUser is null, waiting for user...');
                // Wait up to 2 seconds for Firebase to restore the session
                let waitCount = 0;
                while (!user && waitCount < 20) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    user = auth.currentUser;
                    waitCount++;
                }
                
                if (!user) {
                    console.log('[MY-TOOLS] showCollectionSelectionDialog: Still no user after waiting, checking localStorage...');
                    // If still no user but we have localStorage flag, use that
                    const storedFullName = localStorage.getItem('fullName');
                    if (storedFullName && localStorage.getItem('authVerified') === 'true') {
                        console.log('[MY-TOOLS] showCollectionSelectionDialog: Using stored fullName from localStorage:', storedFullName);
                        // Continue with storedFullName - we'll use it below
                    } else {
                        console.log('[MY-TOOLS] showCollectionSelectionDialog: No user and no stored credentials, cannot show dialog');
                        return;
                    }
                } else {
                    console.log('[MY-TOOLS] showCollectionSelectionDialog: User found after waiting:', user.email);
                }
            }
            
            const fullName = localStorage.getItem('fullName') || (user ? user.email : null);
            if (!fullName) {
                console.error('[MY-TOOLS] showCollectionSelectionDialog: No fullName available');
                return;
            }
            const modal = new bootstrap.Modal(document.getElementById('collectionSelectModal'));
            const body = document.getElementById('collectionSelectBody');
            body.innerHTML = '<div class="text-center">Loading...</div>';
            try {
                // 1. Query tools for this owner
                const toolsSnapshot = await db.collection('tools').where('owner', '==', fullName).get();
                if (toolsSnapshot.empty) {
                    body.innerHTML = '<div class="text-center text-danger">No tools found for you.</div>';
                    modal.show();
                    return;
                }
                // 2. Extract unique collectionCodes
                const collectionCodes = [...new Set(toolsSnapshot.docs.map(doc => doc.data().collectionCode).filter(Boolean))];
                if (collectionCodes.length === 0) {
                    body.innerHTML = '<div class="text-center text-danger">No collections found for your tools.</div>';
                    modal.show();
                    return;
                }
                // 3. Query collections for those codes (batch if >10)
                let collections = [];
                if (collectionCodes.length <= 10) {
                    const colSnap = await db.collection('collections').where('collectionName', 'in', collectionCodes).get();
                    collections = colSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                } else {
                    // Firestore 'in' query limit is 10, so batch if needed
                    for (let i = 0; i < collectionCodes.length; i += 10) {
                        const batch = collectionCodes.slice(i, i + 10);
                        const colSnap = await db.collection('collections').where('collectionName', 'in', batch).get();
                        collections = collections.concat(colSnap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    }
                }
                if (collections.length === 0) {
                    body.innerHTML = '<div class="text-center text-danger mb-3">No collections found for your tools.</div>';
                } else {
                    let html = '<div class="list-group mb-3">';
                    collections.forEach(data => {
                        const isCurrentCollection = data.collectionName === lastViewedCollectionName;
                        html += `<button class="list-group-item list-group-item-action collection-select-btn ${isCurrentCollection ? 'active' : ''}" style="font-weight:bold;color:${isCurrentCollection ? 'white' : '#1976d2'};" data-collection="${data.collectionName}">
                            <span style="font-size:1.1em;">${data.collectionName}</span><br>
                            <span style="font-size:0.9em;color:${isCurrentCollection ? 'rgba(255,255,255,0.8)' : '#888'};">
                                ${isCurrentCollection ? 'Current Collection' : 'Code: ' + data.collectionName}
                            </span>
                        </button>`;
                    });
                    html += '</div>';
                    body.innerHTML = html;
                    // Add click handlers
                    body.querySelectorAll('button[data-collection]').forEach(btn => {
                        btn.onclick = function() {
                            modal.hide();
                            showMyToolsByCollection(this.getAttribute('data-collection'));
                        };
                    });
                }
                
                // Add "Add New Collection" button with 3D interactive grey style
                const addButton = document.createElement('button');
                addButton.className = 'add-collection-btn-3d';
                addButton.innerHTML = '<i class="fas fa-plus me-2"></i>Add New Collection';
                addButton.onclick = function(e) {
                    e.stopPropagation();
                    modal.hide();
                    showAddCollectionModal();
                };
                body.appendChild(addButton);
                
                // Handle modal close button to return to main menu
                const closeBtn = document.getElementById('collectionSelectModalCloseBtn');
                if (closeBtn) {
                    closeBtn.onclick = function() {
                        modal.hide();
                        // Use setTimeout to ensure modal is hidden before navigation
                        setTimeout(() => {
                            handleBackNavigation();
                        }, 300);
                    };
                }
                
                modal.show();
            } catch (e) {
                body.innerHTML = '<div class="text-center text-danger">Error loading collections.</div>';
                modal.show();
            }
        }

        // Show Add Collection Modal
        function showAddCollectionModal() {
            const modal = new bootstrap.Modal(document.getElementById('addCollectionModal'));
            document.getElementById('addCollectionForm').reset();
            document.getElementById('addCollectionError').style.display = 'none';
            document.getElementById('addCollectionError').textContent = '';
            modal.show();
        }

        // Save new collection to Firebase
        async function saveNewCollection() {
            const db = window.db || firebase.firestore();
            const storage = window.storage || firebase.storage();
            const auth = window.auth || firebase.auth();
            
            const collectionName = document.getElementById('collectionNameInput').value.trim();
            const description = document.getElementById('collectionDescriptionInput').value.trim();
            const photoFile = document.getElementById('collectionPhotoInput').files[0];
            const errorDiv = document.getElementById('addCollectionError');
            
            // Validate collection name
            if (!collectionName) {
                errorDiv.textContent = 'Collection name is required.';
                errorDiv.style.display = 'block';
                return;
            }
            
            // Check if collection already exists
            const existingCollection = await db.collection('collections').where('collectionName', '==', collectionName).get();
            if (!existingCollection.empty) {
                errorDiv.textContent = 'A collection with this name already exists.';
                errorDiv.style.display = 'block';
                return;
            }
            
            try {
                errorDiv.style.display = 'none';
                const saveBtn = document.getElementById('saveCollectionBtn');
                saveBtn.disabled = true;
                saveBtn.textContent = 'Saving...';
                
                let photoUrls = [];
                
                // Upload photo if provided
                if (photoFile) {
                    const loadingModal = new bootstrap.Modal(document.getElementById('photoUploadLoadingModal'));
                    loadingModal.show();
                    document.getElementById('photoUploadProgress').textContent = 'Processing image...';
                    
                    // Compress image
                    const compressedBlob = await compressImage(photoFile);
                    if (!compressedBlob) {
                        loadingModal.hide();
                        errorDiv.textContent = 'Failed to compress image.';
                        errorDiv.style.display = 'block';
                        saveBtn.disabled = false;
                        saveBtn.textContent = 'Save Collection';
                        return;
                    }
                    
                    document.getElementById('photoUploadProgress').textContent = 'Uploading to storage...';
                    
                    // Upload to Firebase Storage
                    const fileName = `${collectionName}_photo1.jpg`;
                    const photoRef = storage.ref('Collection%20Photo/' + fileName);
                    const uploadTask = photoRef.put(compressedBlob);
                    
                    await new Promise((resolve, reject) => {
                        uploadTask.on('state_changed',
                            (snapshot) => {
                                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                                document.getElementById('photoUploadProgress').textContent = `Uploading... ${Math.round(progress)}%`;
                            },
                            (error) => {
                                loadingModal.hide();
                                reject(error);
                            },
                            async () => {
                                try {
                                    const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                                    photoUrls = [downloadURL];
                                    loadingModal.hide();
                                    resolve();
                                } catch (error) {
                                    loadingModal.hide();
                                    reject(error);
                                }
                            }
                        );
                    });
                }
                
                // Create collection document in Firestore
                const collectionData = {
                    collectionName: collectionName,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    photoUrls: photoUrls
                };
                
                if (description) {
                    collectionData.description = description;
                }
                
                await db.collection('collections').add(collectionData);
                
                // Close modal and refresh collection selection
                const addModal = bootstrap.Modal.getInstance(document.getElementById('addCollectionModal'));
                if (addModal) addModal.hide();
                
                // Show success message and refresh
                alert('Collection created successfully!');
                await showCollectionSelectionDialog();
                
            } catch (error) {
                console.error('Error saving collection:', error);
                errorDiv.textContent = 'Error saving collection: ' + error.message;
                errorDiv.style.display = 'block';
                const saveBtn = document.getElementById('saveCollectionBtn');
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save Collection';
            }
        }

        // Set up event listener for save collection button
        document.addEventListener('DOMContentLoaded', function() {
            const saveBtn = document.getElementById('saveCollectionBtn');
            if (saveBtn) {
                saveBtn.addEventListener('click', saveNewCollection);
            }
        });

        // Show My Tools by Collection (matching index.html)
        async function showMyToolsByCollection(collectionName) {
            const auth = window.auth || firebase.auth();
            const db = window.db || firebase.firestore();
            lastViewedCollectionName = collectionName;
            const user = auth.currentUser;
            const fullName = localStorage.getItem('fullName') || (user ? user.email : '');
            
            // Hide My Tools screen, show My Tools by Collection screen
            document.getElementById('myToolsScreen').style.display = 'none';
            document.getElementById('myToolsByCollectionScreen').style.display = 'block';
            
            // Push history state for back button support
            window.history.pushState({ screen: 'myToolsByCollection', collection: collectionName }, '', '');
            
            const title = document.getElementById('myToolsCollectionTitle');
            const list = document.getElementById('myToolsByCollectionList');
            title.textContent = `Collection: ${collectionName}`;
            list.innerHTML = '<div class="text-center">Loading...</div>';
            
            // Update collection photo button counts
            await updateCollectionPhotoButtonCounts();
            
            try {
                // Query tools where collectionCode matches the collectionName
                const snapshot = await db.collection('tools')
                    .where('owner', '==', fullName)
                    .where('collectionCode', '==', collectionName)
                    .get();
                
                if (snapshot.empty) {
                    list.innerHTML = '<div class="text-center text-danger">No tools found in this collection.</div>';
                    lastViewedCollectionTools = [];
                    return;
                }
                
                // Group tools by location
                const tools = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                lastViewedCollectionTools = tools;
                const locations = [...new Set(tools.map(t => t.location || 'No Location'))];
                locations.sort();
                
                // OUT tools first, then IN, then others
                const getStatusOrder = status => {
                    if (!status) return 2;
                    const s = status.toUpperCase();
                    if (s === 'OUT') return 0;
                    if (s === 'IN') return 1;
                    return 2;
                };
                
                // Filtering state
                let selectedLocation = 'All';
                
                // Render function
                async function renderToolsByLocation(selectedLoc) {
                    // Update the filter bar with new selected state
                    let filterHtml = '<div id="locationFilterBar" style="display:flex;gap:8px;overflow-x:auto;position:sticky;top:0;z-index:10;background:#fff;padding:8px 0 8px 0;border-bottom:2px solid #FF9800;margin-bottom:10px;">';
                    filterHtml += `<button class="btn btn-sm ${selectedLoc==='All'?'btn-orange':'btn-outline-secondary'}" data-location="All" style="${selectedLoc==='All'?'background-color:#FF9800;color:white;border-color:#FF9800;':'background-color:transparent;color:#6c757d;border-color:#6c757d;'}">All</button>`;
                    locations.forEach(loc => {
                        filterHtml += `<button class="btn btn-sm ${selectedLoc===loc?'btn-orange':'btn-outline-secondary'}" data-location="${loc}" style="${selectedLoc===loc?'background-color:#FF9800;color:white;border-color:#FF9800;':'background-color:transparent;color:#6c757d;border-color:#6c757d;'}">${loc}</button>`;
                    });
                    filterHtml += '</div>';
                    
                    let html = '';
                    const locs = selectedLoc === 'All' ? locations : [selectedLoc];
                    
                    // Fetch photo counts for all locations
                    const photoCountPromises = locs.map(loc => getLocationPhotoCount(collectionName, loc));
                    const photoCounts = await Promise.all(photoCountPromises);
                    
                    locs.forEach((loc, locIndex) => {
                        const toolsAtLoc = tools.filter(t => (t.location || 'No Location') === loc);
                        if (!toolsAtLoc.length) return;
                        
                        const photoCount = photoCounts[locIndex];
                        const photoText = getResponsiveButtonText(`Photos (${photoCount})`, `Pics (${photoCount})`);
                        
                        html += `<div style="background:#FF9800;color:white;font-weight:bold;font-size:1.1em;padding:4px 12px;border-radius:6px 6px 0 0;position:sticky;top:0;z-index:5;display:flex;align-items:center;justify-content:space-between;">
                            <span>Location: ${loc} (Total: ${toolsAtLoc.length} tools)</span>
                            <button class="btn btn-sm btn-info ms-2" style="background:#1976d2;color:white;font-weight:bold;" onclick="event.stopPropagation(); showLocationPhotosFromTitleBar('${collectionName}','${loc}')">
                                <i class="fas fa-images"></i> ${photoText}
                            </button>
                        </div>`;
                        
                        // OUT first, then IN, then others
                        const sorted = toolsAtLoc.slice().sort((a, b) => getStatusOrder(a.status) - getStatusOrder(b.status));
                        sorted.forEach((tool, idx) => {
                            const status = (tool.status || '').toUpperCase();
                            let bg = '#E8F5E9';
                            let statusColor = '#388E3C';
                            if (status === 'OUT') { bg = '#FFEBEE'; statusColor = '#d32f2f'; }
                            else if (status === 'BROKEN') { bg = '#FFF3E0'; statusColor = '#ff6f00'; }
                            else if (status === 'LOST') { bg = '#FFE0B2'; statusColor = '#ff8f00'; }
                            else if (status === 'CALIBRATION') { bg = '#E3F2FD'; statusColor = '#1976d2'; }
                            
                            html += `<div style="background:${bg};border-radius:0 0 6px 6px;margin-bottom:8px;padding:12px 12px 8px 12px;">
                                <div style="cursor:pointer;" onclick="showToolDetailsFromMyTools(${JSON.stringify(tool).replace(/"/g, '&quot;')})">
                                <div style="font-weight:bold;font-size:1.13rem;color:#1976d2;display:block !important;margin-bottom:4px;">${idx + 1}. ${tool.toolName || 'Unknown Tool'}</div>
                                <div style="font-weight:bold;display:block !important;margin-bottom:4px;">TID: ${tool.id}</div>
                                <span style="display:flex;align-items:center;justify-content:space-between;">
                                    <span style="font-size:1.01rem;color:#444;">Part #: ${tool.partNumber || ''}</span>
                                    <span style="font-size:1.01rem;font-weight:bold;color:#222;">WorkOn: <span style="color:#888;font-weight:bold;">${(typeof tool.WorkOn === 'string' && tool.WorkOn.trim()) ? tool.WorkOn : 'N/A'}</span></span>
                                </span><br>
                                <span style="font-weight:bold;color:${statusColor};">Status: ${tool.status || ''}</span><br>
                                <span style="font-size:1.01rem;color:#222;">Location: ${tool.location || ''}</span><br>
                                <span style="font-size:1.01rem;color:#1976d2;font-weight:bold;">Cal Due Date: ${tool.calDueDate ? (tool.calDueDate.toDate ? tool.calDueDate.toDate().toLocaleDateString('en-GB') : tool.calDueDate) : 'N/A'}</span>
                                </div>
                                <div style="margin-top:8px;display:flex;gap:8px;justify-content:flex-end;">
                                    <button onclick="event.stopPropagation(); createPhotoUploadInput('${tool.id}', '${tool.partNumber || tool.id}')" 
                                            class="mytools-photo-btn"
                                            style="background:#FF9800;color:white;border:2px solid #F57C00;border-radius:16px;padding:6px 12px;font-size:0.9rem;font-weight:bold;cursor:pointer;">
                                        <i class="fas fa-camera"></i> ${getResponsiveButtonText('Add Photo', 'Add')}
                                    </button>
                                    ${tool.photoUrls && tool.photoUrls.length > 0 ? 
                                        `<button onclick="event.stopPropagation(); showToolPhotoGallery(this)" 
                                                class="mytools-photo-btn"
                                                data-photo-urls='${JSON.stringify(tool.photoUrls)}'
                                                data-tool-id='${tool.id}'
                                                data-part-number='${tool.partNumber || tool.id}'
                                                style="background:#1976d2;color:white;border:2px solid #1565C0;border-radius:16px;padding:6px 12px;font-size:0.9rem;font-weight:bold;cursor:pointer;">
                                            <i class="fas fa-images"></i> ${getResponsiveButtonText('Photos', 'Pics')} (${tool.photoUrls.length})
                                        </button>` : ''
                                    }
                                </div>
                            </div>`;
                        });
                    });
                    
                    list.innerHTML = filterHtml + `<div style="height:calc(100vh - 300px);overflow-y:auto;padding-right:5px;">` + html + `</div>`;
                    
                    // Add event listeners for filter buttons
                    list.querySelectorAll('button[data-location]').forEach(btn => {
                        btn.onclick = async function() {
                            selectedLocation = this.getAttribute('data-location');
                            await renderToolsByLocation(selectedLocation);
                        };
                    });
                }
                
                await renderToolsByLocation(selectedLocation);
            } catch (e) {
                title.textContent = `Collection: ${collectionName}`;
                list.innerHTML = '<div class="text-center text-danger">Error loading tools.</div>';
                lastViewedCollectionTools = [];
            }
        }

        // Helper functions
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                   window.innerWidth <= 768;
        }

        function getResponsiveButtonText(desktopText, mobileText) {
            return isMobileDevice() ? mobileText : desktopText;
        }

        async function getLocationPhotoCount(collectionName, location) {
            const db = window.db || firebase.firestore();
            if (!collectionName || collectionName === 'N/A' || !location || location === 'N/A') return 0;
            try {
                const documentId = `${collectionName}_${location}`;
                const docRef = db.collection('locationPhotos').doc(documentId);
                const doc = await docRef.get();
                
                if (doc.exists) {
                    const data = doc.data();
                    return data.photoUrls ? data.photoUrls.length : 0;
                }
                return 0;
            } catch (error) {
                console.error('Error getting photo count:', error);
                return 0;
            }
        }

        // My Tools Screen with app-like formatting (kept for backward compatibility, but not used in main flow)
        async function showMyTools() {
            const auth = window.auth || firebase.auth();
            const db = window.db || firebase.firestore();
            const user = auth.currentUser;
            if (!user) return;
            const fullName = localStorage.getItem('fullName') || user.email;
            const myToolsScreenBody = document.getElementById('myToolsScreenBody');
            myToolsScreenBody.innerHTML = '<div class="text-center">Loading...</div>';

            // Update collection photo button counts
            await updateCollectionPhotoButtonCounts();

            try {
                // Query all tools where owner matches the logged-in user
                const snapshot = await db.collection('tools')
                    .where('owner', '==', fullName)
                    .get();

                if (snapshot.empty) {
                    myToolsScreenBody.innerHTML = '<div class="text-center">No tools found for you.</div>';
                } else {
                    // Group by collectionCode and location
                    const tools = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    const grouped = {};
                    tools.forEach(tool => {
                        const collection = tool.collectionCode || 'N/A';
                        const location = tool.location || 'N/A';
                        if (!grouped[collection]) grouped[collection] = {};
                        if (!grouped[collection][location]) grouped[collection][location] = [];
                        grouped[collection][location].push(tool);
                    });

                    let html = '';
                    Object.keys(grouped).forEach(collection => {
                        html += `<div class="mytools-collection"><span>Collection:</span><span>${collection}</span></div>`;
                        Object.keys(grouped[collection]).forEach(location => {
                            const toolsAtLocation = grouped[collection][location];
                            html += `<div class="mytools-location"><span>Location:</span><span>${location} (Total: ${toolsAtLocation.length} tools)</span></div>`;
                            toolsAtLocation.forEach((tool, idx) => {
                                const bgClass = idx % 2 === 0 ? 'mytools-tool-bg1' : 'mytools-tool-bg2';
                                html += `<div class="mytools-tool-item ${bgClass}">`
                                    + `<div style="cursor:pointer;" onclick="showToolDetailsFromMyTools(${JSON.stringify(tool).replace(/"/g, '&quot;')})">`
                                    + `<div class="mytools-tool-name" style="display: block !important; width: 100% !important; margin-bottom: 4px; clear: both;">${idx + 1}. ${tool.toolName || 'Unknown Tool'}</div>`
                                    + `<div class="mytools-tool-tid" style="display: block !important; width: 100% !important; margin-bottom: 4px; clear: both;">TID: ${tool.id}</div>`
                                    + `<span style="display:flex;align-items:center;justify-content:space-between;">
                                        <span style="font-size:1.01rem;color:#444;">Part #: ${tool.partNumber || ''}</span>
                                        <span style="font-size:1.01rem;font-weight:bold;color:#222;">WorkOn: <span style="color:#888;font-weight:bold;">${(typeof tool.WorkOn === 'string' && tool.WorkOn.trim()) ? tool.WorkOn : 'N/A'}</span></span>
                                    </span><br>`
                                    + `<span class="mytools-status-${getStatusClass(tool.status)}">Status: ${tool.status || ''}</span>`;
                                if (tool.status === 'OUT') {
                                    html += `<div class="mytools-tool-extra">Technician: ${tool.technician || ''}</div>`;
                                    if (tool.timestamp && tool.timestamp.toDate) {
                                        const outTime = tool.timestamp.toDate().toLocaleString('en-GB', {
                                            day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
                                        });
                                        html += `<div class="mytools-tool-extra">Checked out: ${outTime}</div>`;
                                    }
                                }
                                if (tool.calDueDate && tool.calDueDate.toDate) {
                                    const calDue = tool.calDueDate.toDate().toLocaleDateString('en-GB');
                                    html += `<div class="mytools-tool-cal">Cal Due: <span style="font-weight: bold;">${calDue}</span></div>`;
                                }
                                html += `</div>`;
                                html += `<div style="margin-top:8px;display:flex;gap:8px;justify-content:flex-end;">`;
                                html += `<button onclick="event.stopPropagation(); createPhotoUploadInput('${tool.id}', '${tool.partNumber || tool.id}')" class="mytools-photo-btn" style="background:#FF9800;color:white;border:2px solid #F57C00;border-radius:16px;padding:6px 12px;font-size:0.9rem;font-weight:bold;cursor:pointer;"><i class="fas fa-camera"></i> Add Photo</button>`;
                                if (tool.photoUrls && tool.photoUrls.length > 0) {
                                    html += `<button onclick="event.stopPropagation(); showToolPhotoGallery(this)" class="mytools-photo-btn" data-photo-urls='${JSON.stringify(tool.photoUrls)}' data-tool-id='${tool.id}' data-part-number='${tool.partNumber || tool.id}' style="background:#1976d2;color:white;border:2px solid #1565C0;border-radius:16px;padding:6px 12px;font-size:0.9rem;font-weight:bold;cursor:pointer;"><i class="fas fa-images"></i> Photos (${tool.photoUrls.length})</button>`;
                                }
                                html += `</div>`;
                                html += `</div>`;
                            });
                        });
                    });
                    myToolsScreenBody.innerHTML = html;
                }
            } catch (error) {
                myToolsScreenBody.innerHTML = `<div class="text-danger text-center">Error loading your tools: ${error.message}</div>`;
            }
        }

        // Helper to get status CSS class
        function getStatusClass(status) {
            const upperStatus = status ? status.toUpperCase() : 'IN';
            switch (upperStatus) {
                case 'OUT': return 'out';
                case 'BROKEN': return 'broken';
                case 'LOST': return 'lost';
                case 'CALIBRATION': return 'calibration';
                default: return 'in';
            }
        }

        // Show tool details from My Tools
        async function showToolDetailsFromMyTools(tool) {
            const db = window.db || firebase.firestore();
            const formatTimestamp = (timestamp) => {
                if (!timestamp) return 'N/A';
                if (timestamp.toDate) {
                    return timestamp.toDate().toLocaleString('en-GB', {
                        day: '2-digit', month: '2-digit', year: 'numeric',
                        hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
                    });
                }
                if (timestamp.seconds) {
                    return new Date(timestamp.seconds * 1000).toLocaleString('en-GB', {
                        day: '2-digit', month: '2-digit', year: 'numeric',
                        hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
                    });
                }
                return timestamp;
            };

            const modal = new bootstrap.Modal(document.getElementById('checkoutInfoModal'));
            const modalTitle = document.getElementById('checkoutInfoModalTitle');
            const modalBody = document.getElementById('checkoutInfoModalBody');

            modalTitle.textContent = 'Loading...';
            modalBody.innerHTML = '<div class="text-center">Loading checkout information...</div>';
            modal.show();

            try {
                const status = tool.status || 'N/A';
                let title = '';
                let field1Label = '';
                let field1Value = '';
                let field2Label = '';
                let field2Value = '';

                if (status === 'OUT') {
                    title = 'Tool Checkout Information';
                    field1Label = 'Checked Out By:';
                    field2Label = 'ChkOut Date:';

                    const toolDoc = await db.collection('tools').doc(tool.id).get();
                    if (toolDoc.exists) {
                        const toolData = toolDoc.data();
                        field1Value = toolData.technician || 'N/A';
                        field2Value = formatTimestamp(toolData.timestamp);
                    } else {
                        field1Value = 'N/A';
                        field2Value = 'N/A';
                    }
                } else if (status === 'IN') {
                    title = 'Last Tool Movement Information';
                    field1Label = 'Technician:';
                    field2Label = 'Date:';
                    try {
                        const logSnapshot = await db.collection('logtoolmovements')
                            .where('toolId', '==', tool.id)
                            .orderBy('timestamp', 'desc')
                            .limit(1)
                            .get();
                        if (!logSnapshot.empty) {
                            const lastLogEntry = logSnapshot.docs[0].data();
                            field1Value = lastLogEntry.technician || 'N/A';
                            field2Value = formatTimestamp(lastLogEntry.timestamp);
                        } else {
                            field1Value = tool.technician || 'N/A';
                            field2Value = formatTimestamp(tool.timestamp);
                        }
                    } catch (logError) {
                        console.error('Error querying logtoolmovements:', logError);
                        field1Value = tool.technician || 'N/A';
                        field2Value = formatTimestamp(tool.timestamp);
                    }
                } else {
                    title = 'Tool Information';
                    field1Label = 'Status:';
                    field1Value = tool.status || 'N/A';
                    field2Label = 'Technician:';
                    field2Value = tool.technician || 'N/A';
                }

                modalTitle.textContent = title;
                modalBody.innerHTML = `
                    <div class="mb-3">
                        <strong style="color: #222; font-size: 1.1em;">${field1Label}</strong>
                        <div style="color: #1976d2; font-size: 1.0em; margin-top: 4px;">${field1Value}</div>
                    </div>
                    <div class="mb-3">
                        <strong style="color: #222; font-size: 1.1em;">${field2Label}</strong>
                        <div style="color: #1976d2; font-size: 1.0em; margin-top: 4px;">${field2Value}</div>
                    </div>
                `;

                window.history.pushState({ modal: 'checkoutInfo' }, '', '');
                modal.show();
            } catch (error) {
                console.error('Error fetching checkout information:', error);
                modalTitle.textContent = 'Error';
                modalBody.innerHTML = `
                    <div class="text-center text-danger">
                        Error loading checkout information. Please try again.<br>
                        <small>Status: ${tool.status || 'N/A'}<br>
                        Tool ID: ${tool.id || 'N/A'}</small>
                    </div>
                `;
            }
        }

        // Update collection photo button counts
        async function updateCollectionPhotoButtonCounts() {
            const auth = window.auth || firebase.auth();
            const db = window.db || firebase.firestore();
            try {
                // Update My Tools screen buttons
                const myToolsBtn = document.getElementById('myToolsCollectionPhotosBtn');
                if (myToolsBtn) {
                    const user = auth.currentUser;
                    if (user) {
                        const fullName = localStorage.getItem('fullName') || user.email;
                        const snapshot = await db.collection('tools')
                            .where('owner', '==', fullName)
                            .get();

                        if (!snapshot.empty) {
                            const collections = [...new Set(snapshot.docs.map(doc => doc.data().collectionCode).filter(Boolean))];
                            let totalPhotos = 0;

                            for (const collectionName of collections) {
                                const collectionQuery = await db.collection('collections').where('collectionName', '==', collectionName).get();
                                if (!collectionQuery.empty) {
                                    const collectionDoc = collectionQuery.docs[0];
                                    totalPhotos += (collectionDoc.data().photoUrls || []).length;
                                }
                            }

                            myToolsBtn.innerHTML = `<i class="fas fa-images"></i> Collection Photos (${totalPhotos})`;
                        }
                    }
                }

                // Update My Tools by Collection screen buttons
                const myToolsByCollectionBtn = document.getElementById('myToolsByCollectionPhotosBtn');
                if (myToolsByCollectionBtn && lastViewedCollectionName) {
                    const collectionQuery = await db.collection('collections').where('collectionName', '==', lastViewedCollectionName).get();
                    let photoCount = 0;
                    if (!collectionQuery.empty) {
                        const collectionDoc = collectionQuery.docs[0];
                        photoCount = (collectionDoc.data().photoUrls || []).length;
                    }
                    myToolsByCollectionBtn.innerHTML = `<i class="fas fa-images"></i> Collection Photos (${photoCount})`;
                }
            } catch (error) {
                console.error('Error updating collection photo button counts:', error);
            }
        }

        // Show collection selection for photos
        async function showCollectionSelectionForPhotos() {
            const user = auth.currentUser;
            if (!user) return;
            const fullName = localStorage.getItem('fullName') || user.email;

            try {
                const snapshot = await db.collection('tools')
                    .where('owner', '==', fullName)
                    .get();

                if (snapshot.empty) {
                    alert('No collections found.');
                    return;
                }

                const collections = [...new Set(snapshot.docs.map(doc => doc.data().collectionCode).filter(Boolean))];
                collections.sort();

                if (collections.length === 0) {
                    alert('No collections found.');
                    return;
                }

                const collectionsWithPhotos = [];
                for (const collectionName of collections) {
                    const collectionQuery = await db.collection('collections').where('collectionName', '==', collectionName).get();
                    let photoCount = 0;
                    if (!collectionQuery.empty) {
                        const collectionDoc = collectionQuery.docs[0];
                        photoCount = (collectionDoc.data().photoUrls || []).length;
                    }
                    collectionsWithPhotos.push({ name: collectionName, photoCount });
                }

                const modalHtml = `
                    <div class="modal fade" id="collectionPhotoSelectionModal" tabindex="-1" aria-labelledby="collectionPhotoSelectionModalLabel" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header bg-primary text-white">
                                    <h5 class="modal-title" id="collectionPhotoSelectionModalLabel">Select Collection</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="d-grid gap-2">
                                        ${collectionsWithPhotos.map(collection => `
                                            <button type="button" class="btn btn-outline-primary" onclick="selectCollectionForPhotos('${collection.name}')">
                                                ${collection.name} <span class="badge bg-secondary ms-2">${collection.photoCount} photos</span>
                                            </button>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                const existingModal = document.getElementById('collectionPhotoSelectionModal');
                if (existingModal) {
                    existingModal.remove();
                }

                document.body.insertAdjacentHTML('beforeend', modalHtml);

                const modal = new bootstrap.Modal(document.getElementById('collectionPhotoSelectionModal'));
                modal.show();

                document.getElementById('collectionPhotoSelectionModal').addEventListener('hidden.bs.modal', function() {
                    this.remove();
                });

            } catch (error) {
                console.error('Error loading collections:', error);
                alert('Error loading collections: ' + error.message);
            }
        }

        // Select collection for photos
        function selectCollectionForPhotos(collectionName) {
            const modal = bootstrap.Modal.getInstance(document.getElementById('collectionPhotoSelectionModal'));
            if (modal) modal.hide();

            const activeElement = document.activeElement;
            if (activeElement && activeElement.id === 'myToolsAddCollectionPhotoBtn') {
                createCollectionPhotoUploadInput(collectionName);
            } else {
                const tempElement = document.createElement('div');
                tempElement.setAttribute('data-collection-name', collectionName);
                showCollectionPhotoGallery(tempElement);
            }
        }

        // Create collection photo upload input
        function createCollectionPhotoUploadInput(collectionName) {
            const modalHtml = `
                <div class="modal fade" id="collectionPhotoSourceModal" tabindex="-1" aria-labelledby="collectionPhotoSourceModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-sm">
                        <div class="modal-content">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title" id="collectionPhotoSourceModalLabel">Add Collection Photo</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body text-center">
                                <div class="d-grid gap-3">
                                    <button type="button" class="btn btn-primary btn-lg" onclick="takeCollectionPhotoWithCamera('${collectionName}')">
                                        <i class="fas fa-camera"></i> Take Photo
                                    </button>
                                    <button type="button" class="btn btn-secondary btn-lg" onclick="selectCollectionPhotoFromGallery('${collectionName}')">
                                        <i class="fas fa-images"></i> Choose from Gallery
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            const existingModal = document.getElementById('collectionPhotoSourceModal');
            if (existingModal) {
                existingModal.remove();
            }

            document.body.insertAdjacentHTML('beforeend', modalHtml);

            const modal = new bootstrap.Modal(document.getElementById('collectionPhotoSourceModal'));
            modal.show();

            document.getElementById('collectionPhotoSourceModal').addEventListener('hidden.bs.modal', function() {
                this.remove();
            });
        }

        // Take collection photo with camera
        function takeCollectionPhotoWithCamera(collectionName) {
            const sourceModal = bootstrap.Modal.getInstance(document.getElementById('collectionPhotoSourceModal'));
            if (sourceModal) sourceModal.hide();

            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.capture = 'environment';
            input.style.display = 'none';

            input.onchange = function(event) {
                const file = event.target.files[0];
                if (file) {
                    uploadCollectionPhoto(collectionName, file);
                }
                document.body.removeChild(input);
            };

            document.body.appendChild(input);
            input.click();
        }

        // Select collection photo from gallery
        function selectCollectionPhotoFromGallery(collectionName) {
            const sourceModal = bootstrap.Modal.getInstance(document.getElementById('collectionPhotoSourceModal'));
            if (sourceModal) sourceModal.hide();

            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.style.display = 'none';

            input.onchange = function(event) {
                const file = event.target.files[0];
                if (file) {
                    uploadCollectionPhoto(collectionName, file);
                }
                document.body.removeChild(input);
            };

            document.body.appendChild(input);
            input.click();
        }

        // Upload collection photo
        async function uploadCollectionPhoto(collectionName, file) {
            const db = window.db || firebase.firestore();
            const storage = window.storage || firebase.storage();
            try {
                const loadingModal = new bootstrap.Modal(document.getElementById('photoUploadLoadingModal'));
                loadingModal.show();
                document.getElementById('photoUploadProgress').textContent = 'Processing image...';

                const compressedBlob = await compressImage(file);
                if (!compressedBlob) {
                    loadingModal.hide();
                    alert('Failed to compress image');
                    return;
                }

                document.getElementById('photoUploadProgress').textContent = 'Uploading to storage...';

                const collectionQuery = await db.collection('collections').where('collectionName', '==', collectionName).get();
                let currentPhotoUrls = [];
                let collectionDocId = null;

                if (!collectionQuery.empty) {
                    const collectionDoc = collectionQuery.docs[0];
                    collectionDocId = collectionDoc.id;
                    currentPhotoUrls = collectionDoc.data().photoUrls || [];
                }

                const photoNumber = currentPhotoUrls.length + 1;
                const fileName = `${collectionName}_photo${photoNumber}.jpg`;

                const photoRef = storage.ref('Collection%20Photo/' + fileName);
                const uploadTask = photoRef.put(compressedBlob);

                uploadTask.on('state_changed',
                    (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        document.getElementById('photoUploadProgress').textContent = `Uploading... ${Math.round(progress)}%`;
                    },
                    (error) => {
                        console.error('Upload error:', error);
                        loadingModal.hide();
                        alert('Upload failed: ' + error.message);
                    },
                    async () => {
                        try {
                            document.getElementById('photoUploadProgress').textContent = 'Updating database...';

                            const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                            const newPhotoUrls = [...currentPhotoUrls, downloadURL];

                            if (collectionDocId) {
                                await db.collection('collections').doc(collectionDocId).update({
                                    photoUrls: newPhotoUrls
                                });
                            } else {
                                await db.collection('collections').add({
                                    collectionName: collectionName,
                                    photoUrls: newPhotoUrls,
                                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                                });
                            }

                            loadingModal.hide();
                            alert('Collection photo uploaded successfully!');

                            await showMyTools();
                            await updateCollectionPhotoButtonCounts();

                        } catch (error) {
                            console.error('Error updating collection:', error);
                            loadingModal.hide();
                            alert('Error updating collection: ' + error.message);
                        }
                    }
                );

            } catch (error) {
                console.error('Collection photo upload failed:', error);
                const loadingModal = bootstrap.Modal.getInstance(document.getElementById('photoUploadLoadingModal'));
                if (loadingModal) loadingModal.hide();
                alert('Upload failed: ' + error.message);
            }
        }

        // Show collection photo gallery
        async function showCollectionPhotoGallery(element) {
            const collectionName = element.getAttribute('data-collection-name');

            try {
                const collectionQuery = await db.collection('collections').where('collectionName', '==', collectionName).get();
                let photoUrls = [];

                if (!collectionQuery.empty) {
                    const collectionDoc = collectionQuery.docs[0];
                    photoUrls = collectionDoc.data().photoUrls || [];
                }

                if (photoUrls.length === 0) {
                    alert('No photos found for this collection.');
                    return;
                }

                showCollectionPhotoFullscreen(photoUrls[0], 0, JSON.stringify(photoUrls));

            } catch (error) {
                console.error('Error loading collection photos:', error);
                alert('Error loading collection photos: ' + error.message);
            }
        }

        // Show collection photo in fullscreen
        function showCollectionPhotoFullscreen(photoUrl, photoIndex, allPhotoUrls) {
            const photoUrls = JSON.parse(allPhotoUrls);
            if (!photoUrls || photoUrls.length === 0) return;

            let currentPhotoIndex = photoIndex;

            let modal = document.getElementById('collectionPhotoFullscreenModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.className = 'modal fade';
                modal.id = 'collectionPhotoFullscreenModal';
                modal.tabIndex = -1;
                modal.innerHTML = `
                    <div class="modal-dialog modal-fullscreen">
                        <div class="modal-content bg-dark text-white">
                            <div class="modal-header border-0">
                                <h5 class="modal-title">Collection Photos</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body d-flex flex-column align-items-center justify-content-center position-relative" id="collectionPhotoFullscreenContent">
                            </div>
                            <div class="modal-footer justify-content-center border-0 bg-dark">
                                <span id="collectionPhotoCounter" class="text-white"></span>
                                <button type="button" class="btn btn-danger ms-3" id="collectionPhotoDeleteBtn">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                        </div>
                    </div>
                </div>
            `;
                document.body.appendChild(modal);
            }

            const contentElement = document.getElementById('collectionPhotoFullscreenContent');
            const counter = document.getElementById('collectionPhotoCounter');

            function updatePhoto() {
                contentElement.innerHTML = `<img src="${photoUrls[currentPhotoIndex]}" class="img-fluid rounded shadow" style="max-height:80vh;max-width:100vw;object-fit:contain;">`;

                const prevArrow = document.createElement('button');
                prevArrow.type = 'button';
                prevArrow.className = 'btn btn-light position-absolute';
                prevArrow.style = 'left: 20px; top: 50%; transform: translateY(-50%); z-index: 1000; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;';
                prevArrow.innerHTML = '<i class="fas fa-chevron-left"></i>';
                prevArrow.onclick = function() {
                    if (currentPhotoIndex > 0) {
                        currentPhotoIndex--;
                        updatePhoto();
                    }
                };

                const nextArrow = document.createElement('button');
                nextArrow.type = 'button';
                nextArrow.className = 'btn btn-light position-absolute';
                nextArrow.style = 'right: 20px; top: 50%; transform: translateY(-50%); z-index: 1000; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;';
                nextArrow.innerHTML = '<i class="fas fa-chevron-right"></i>';
                nextArrow.onclick = function() {
                    if (currentPhotoIndex < photoUrls.length - 1) {
                        currentPhotoIndex++;
                        updatePhoto();
                    }
                };

                contentElement.appendChild(prevArrow);
                contentElement.appendChild(nextArrow);

                counter.textContent = `${currentPhotoIndex + 1} / ${photoUrls.length}`;

                prevArrow.style.display = currentPhotoIndex === 0 ? 'none' : 'flex';
                nextArrow.style.display = currentPhotoIndex === photoUrls.length - 1 ? 'none' : 'flex';

                const deleteBtn = document.getElementById('collectionPhotoDeleteBtn');
                if (deleteBtn) {
                    deleteBtn.onclick = function() {
                        deleteCollectionPhoto(currentPhotoIndex, photoUrls[currentPhotoIndex]);
                    };
                }
            }

            updatePhoto();

            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
        }

        // Delete collection photo
        async function deleteCollectionPhoto(photoIndex, photoUrl) {
            const db = window.db || firebase.firestore();
            const storage = window.storage || firebase.storage();
            if (!confirm('Are you sure you want to delete this photo? This action cannot be undone.')) {
                return;
            }

            try {
                const loadingModal = new bootstrap.Modal(document.getElementById('photoUploadLoadingModal'));
                loadingModal.show();
                document.getElementById('photoUploadProgress').textContent = 'Deleting photo...';

                const collectionName = lastViewedCollectionName;
                if (!collectionName) {
                    throw new Error('Collection name not found');
                }

                const collectionDoc = await db.collection('collections').doc(collectionName).get();

                if (!collectionDoc.exists) {
                    throw new Error('Collection document not found');
                }

                const currentPhotoUrls = collectionDoc.data().photoUrls || [];
                const updatedPhotoUrls = currentPhotoUrls.filter((url, index) => index !== photoIndex);

                await db.collection('collections').doc(collectionName).update({
                    photoUrls: updatedPhotoUrls
                });

                try {
                    const urlParts = photoUrl.split('/');
                    const encodedPath = urlParts[urlParts.length - 1].split('?')[0];
                    const decodedPath = decodeURIComponent(encodedPath);
                    const photoRef = storage.ref().child(decodedPath);
                    await photoRef.delete();
                } catch (storageError) {
                    console.warn('Could not delete from storage:', storageError);
                }

                loadingModal.hide();
                alert('Photo deleted successfully!');

                const galleryModal = bootstrap.Modal.getInstance(document.getElementById('collectionPhotoFullscreenModal'));
                if (galleryModal) galleryModal.hide();

                await showMyTools();
                await updateCollectionPhotoButtonCounts();

            } catch (error) {
                console.error('Collection photo delete failed:', error);
                const loadingModal = bootstrap.Modal.getInstance(document.getElementById('photoUploadLoadingModal'));
                if (loadingModal) loadingModal.hide();
                alert('Delete failed: ' + error.message);
            }
        }

        // Image compression function
        function compressImage(file) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();

                img.onload = function() {
                    let newWidth = img.width;
                    let newHeight = img.height;
                    const maxSize = 1200;

                    if (newWidth > maxSize || newHeight > maxSize) {
                        if (newWidth > newHeight) {
                            newHeight = (newHeight * maxSize) / newWidth;
                            newWidth = maxSize;
                        } else {
                            newWidth = (newWidth * maxSize) / newHeight;
                            newHeight = maxSize;
                        }
                    }

                    canvas.width = newWidth;
                    canvas.height = newHeight;

                    ctx.drawImage(img, 0, 0, newWidth, newHeight);

                    let quality = 0.95;

                    function tryCompression() {
                        canvas.toBlob((result) => {
                            if (result.size <= 800 * 1024 || quality <= 0.1) {
                                resolve(result);
                            } else {
                                quality -= 0.05;
                                tryCompression();
                            }
                        }, 'image/jpeg', quality);
                    }

                    tryCompression();
                };

                img.onerror = function() {
                    console.error('Failed to load image');
                    resolve(null);
                };

                img.src = URL.createObjectURL(file);
            });
        }

        // Create photo upload input (full implementation with photo sharing logic)
        async function createPhotoUploadInput(toolId, partNumber) {
            const db = window.db || firebase.firestore();
            currentPhotoUploadToolId = toolId;
            currentPhotoUploadPartNumber = partNumber;
            photoUploadToAllTools = false;
            photoUploadAutoShareTargets = [];

            try {
                // Get current tool's photo URLs
                const toolDoc = await db.collection('tools').doc(toolId).get();
                currentToolPhotoUrls = toolDoc.exists ? (toolDoc.data().photoUrls || []) : [];

                // Check if there are other tools with the same part number that have photos
                const toolsWithSamePart = await db.collection('tools')
                    .where('partNumber', '==', partNumber)
                    .get();

                // Filter tools that have photos (excluding current tool)
                const toolsWithPhotos = toolsWithSamePart.docs
                    .filter(doc => doc.id !== toolId && doc.data().photoUrls && doc.data().photoUrls.length > 0)
                    .map(doc => ({
                        id: doc.id,
                        toolName: doc.data().toolName || 'Unknown Tool',
                        owner: doc.data().owner || 'Unknown',
                        photoCount: (doc.data().photoUrls || []).length,
                        photoUrls: doc.data().photoUrls || []
                    }));

                // If other tools with photos exist, show choice modal
                if (toolsWithPhotos.length > 0) {
                    // Format tools list
                    let toolsListHTML = '';
                    toolsListHTML = toolsWithPhotos.map((tool, index) => 
                        `<div style="font-size: 1.15rem; font-weight: bold; color: #333; margin-bottom: 6px;">
                            ${index + 1}. ${tool.toolName} (Owner: ${tool.owner}) - ${tool.photoCount} photo(s)
                        </div>`
                    ).join('');

                    // Collect all unique photo URLs from all tools
                    const allPhotoUrls = [];
                    toolsWithPhotos.forEach(tool => {
                        tool.photoUrls.forEach(url => {
                            if (!allPhotoUrls.includes(url) && !currentToolPhotoUrls.includes(url)) {
                                allPhotoUrls.push(url);
                            }
                        });
                    });

                    // Initialize selected photos array
                    window.selectedPhotos = [];

                    // Format photo thumbnails with selection handlers
                    let thumbnailsHTML = '';
                    if (allPhotoUrls.length > 0) {
                        thumbnailsHTML = allPhotoUrls.map((url, index) => 
                            `<div style="position: relative; display: inline-block;">
                                <img src="${url}" 
                                     data-photo-url="${url}"
                                     data-photo-index="${index}"
                                     class="photo-thumbnail-selectable"
                                     style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px; border: 2px solid #ddd; cursor: pointer; transition: all 0.2s;" 
                                     onclick="togglePhotoSelection('${url}', ${index})"
                                     onmouseover="this.style.transform='scale(1.05)';"
                                     onmouseout="if(!this.classList.contains('selected')) { this.style.transform='scale(1)'; }"
                                     title="Click to select/deselect">
                                <div class="photo-selected-indicator" style="display: none; position: absolute; top: -5px; right: -5px; background: #4CAF50; color: white; border-radius: 50%; width: 24px; height: 24px; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                                    <i class="fas fa-check"></i>
                                </div>
                            </div>`
                        ).join('');
                    } else {
                        thumbnailsHTML = '<div style="color: #999; font-style: italic;">No new shared photos available (your tool already has all of them).</div>';
                    }

                    // Show choice modal
                    document.getElementById('photoUploadToolsList').innerHTML = toolsListHTML;
                    document.getElementById('photoUploadThumbnails').innerHTML = thumbnailsHTML;
                    document.getElementById('selectedCount').textContent = '0';

                    const addSelectedMyBtn = document.getElementById('addSelectedPhotosMyToolBtn');
                    const addSelectedAllBtn = document.getElementById('addSelectedPhotosAllToolsBtn');
                    if (addSelectedMyBtn) addSelectedMyBtn.disabled = true;
                    if (addSelectedAllBtn) addSelectedAllBtn.disabled = true;

                    const choiceModal = new bootstrap.Modal(document.getElementById('photoUploadChoiceModal'));
                    choiceModal.show();

                    // Store toolsWithSamePart for use in useSelectedPhotos function
                    window.currentPhotoUploadData = {
                        toolId: toolId,
                        partNumber: partNumber,
                        toolsWithSamePart: toolsWithSamePart,
                        toolsWithPhotos: toolsWithPhotos,
                        allPhotoUrls: allPhotoUrls,
                        currentToolPhotoUrls: currentToolPhotoUrls
                    };

                    if (addSelectedMyBtn) {
                        addSelectedMyBtn.onclick = function() {
                            if (window.selectedPhotos.length > 0) {
                                useSelectedPhotos(toolId, partNumber, toolsWithSamePart.docs, false);
                            }
                        };
                    }

                    if (addSelectedAllBtn) {
                        addSelectedAllBtn.onclick = function() {
                            if (window.selectedPhotos.length > 0) {
                                useSelectedPhotos(toolId, partNumber, toolsWithSamePart.docs, true);
                            }
                        };
                    }

                    const addNewPhotoMyBtn = document.getElementById('addNewPhotoMyToolBtn');
                    if (addNewPhotoMyBtn) {
                        addNewPhotoMyBtn.onclick = function() {
                            photoUploadToAllTools = false;
                            photoUploadAutoShareTargets = [];
                            window.selectedPhotos = [];
                            choiceModal.hide();
                            showPhotoSourceModal(toolId, partNumber);
                        };
                    }

                    const addNewPhotoAllBtn = document.getElementById('addNewPhotoAllToolsBtn');
                    if (addNewPhotoAllBtn) {
                        addNewPhotoAllBtn.onclick = async function() {
                            const authorized = await verifyAdminCode('add a new photo to ALL matching tools');
                            if (!authorized) {
                                return;
                            }
                            photoUploadToAllTools = true;
                            photoUploadAutoShareTargets = [];
                            window.selectedPhotos = [];
                            choiceModal.hide();
                            showPhotoSourceModal(toolId, partNumber);
                        };
                    }
                } else {
                    // No other tools with photos, proceed directly to source selection
                    const toolsWithoutPhotos = toolsWithSamePart.docs
                        .filter(doc => doc.id !== toolId && (!doc.data().photoUrls || doc.data().photoUrls.length === 0));

                    photoUploadAutoShareTargets = toolsWithoutPhotos.map(doc => ({
                        id: doc.id,
                        ref: doc.ref,
                        owner: doc.data().owner || 'Unknown',
                        toolName: doc.data().toolName || 'Unknown Tool',
                        photoUrls: doc.data().photoUrls || []
                    }));

                    photoUploadToAllTools = false;
                    window.selectedPhotos = [];
                    showPhotoSourceModal(toolId, partNumber);
                }
            } catch (error) {
                console.error('Error checking tools with same part number:', error);
                // On error, proceed with normal flow (add to my tool only)
                photoUploadToAllTools = false;
                showPhotoSourceModal(toolId, partNumber);
            }
        }

        // Toggle photo selection
        function togglePhotoSelection(photoUrl, index) {
            const img = document.querySelector(`img[data-photo-index="${index}"]`);
            const indicator = img ? img.nextElementSibling : null;
            
            if (!window.selectedPhotos) {
                window.selectedPhotos = [];
            }
            
            const isSelected = window.selectedPhotos.includes(photoUrl);
            
            if (isSelected) {
                // Deselect
                window.selectedPhotos = window.selectedPhotos.filter(url => url !== photoUrl);
                if (img) {
                    img.classList.remove('selected');
                    img.style.border = '2px solid #ddd';
                    img.style.opacity = '1';
                }
                if (indicator) indicator.style.display = 'none';
            } else {
                // Select
                window.selectedPhotos.push(photoUrl);
                if (img) {
                    img.classList.add('selected');
                    img.style.border = '3px solid #4CAF50';
                    img.style.opacity = '0.9';
                }
                if (indicator) indicator.style.display = 'flex';
            }
            
            // Update count and button states
            const count = window.selectedPhotos.length;
            const selectedCountEl = document.getElementById('selectedCount');
            if (selectedCountEl) {
                selectedCountEl.textContent = count;
            }

            const addSelectedMyBtn = document.getElementById('addSelectedPhotosMyToolBtn');
            const addSelectedAllBtn = document.getElementById('addSelectedPhotosAllToolsBtn');
            if (addSelectedMyBtn) {
                addSelectedMyBtn.disabled = count === 0;
            }
            if (addSelectedAllBtn) {
                addSelectedAllBtn.disabled = count === 0;
            }
        }

        // Use multiple selected photos
        async function useSelectedPhotos(toolId, partNumber, toolsWithSamePartDocs = [], addToAll = false) {
            const db = window.db || firebase.firestore();
            if (!window.selectedPhotos || window.selectedPhotos.length === 0) {
                alert('Please select at least one photo.');
                return;
            }

            // Hide the choice modal
            const choiceModal = bootstrap.Modal.getInstance(document.getElementById('photoUploadChoiceModal'));
            if (choiceModal) choiceModal.hide();

            try {
                if (addToAll) {
                    const authorized = await verifyAdminCode('add the selected photos to ALL matching tools');
                    if (!authorized) {
                        return;
                    }

                    const updatePromises = toolsWithSamePartDocs.map(async (doc) => {
                        const existingPhotoUrls = doc.data().photoUrls || [];
                        const updatedPhotoUrls = [...existingPhotoUrls];

                        window.selectedPhotos.forEach(photoUrl => {
                            if (!updatedPhotoUrls.includes(photoUrl)) {
                                updatedPhotoUrls.push(photoUrl);
                            }
                        });

                        if (updatedPhotoUrls.length > existingPhotoUrls.length) {
                            await doc.ref.update({
                                photoUrls: updatedPhotoUrls
                            });
                            console.log('Added selected photos to tool', doc.id);
                        }
                    });

                    await Promise.all(updatePromises);
                    alert(`‚úÖ ${window.selectedPhotos.length} photo(s) added to ALL ${toolsWithSamePartDocs.length} tool(s)!`);
                } else {
                    // Add photos only to current tool
                    const toolDoc = await db.collection('tools').doc(toolId).get();
                    if (toolDoc.exists) {
                        const currentPhotoUrls = toolDoc.data().photoUrls || [];
                        let newPhotoUrls = [...currentPhotoUrls];

                        window.selectedPhotos.forEach(photoUrl => {
                            if (!newPhotoUrls.includes(photoUrl)) {
                                newPhotoUrls.push(photoUrl);
                            }
                        });

                        if (newPhotoUrls.length > currentPhotoUrls.length) {
                            await db.collection('tools').doc(toolId).update({
                                photoUrls: newPhotoUrls
                            });
                            alert(`‚úÖ ${newPhotoUrls.length - currentPhotoUrls.length} photo(s) added to YOUR tool!`);
                        } else {
                            alert('‚ÑπÔ∏è All selected photos are already in your tool.');
                        }
                    }
                }

                // Reset selection UI
                window.selectedPhotos = [];
                const selectedCountEl = document.getElementById('selectedCount');
                if (selectedCountEl) selectedCountEl.textContent = '0';
                const addSelectedMyBtn = document.getElementById('addSelectedPhotosMyToolBtn');
                const addSelectedAllBtn = document.getElementById('addSelectedPhotosAllToolsBtn');
                if (addSelectedMyBtn) addSelectedMyBtn.disabled = true;
                if (addSelectedAllBtn) addSelectedAllBtn.disabled = true;

                // Refresh the view
                if (lastViewedCollectionName) {
                    showMyToolsByCollection(lastViewedCollectionName);
                } else {
                    await showMyTools();
                }

            } catch (error) {
                console.error('Error using selected photos:', error);
                alert('Error adding photos: ' + error.message);
            }
        }

        // Verify admin code
        async function verifyAdminCode(actionDescription = 'perform this action') {
            try {
                const settingsDoc = await db.collection('settings').doc('admin').get();
                const adminCode = settingsDoc.exists ? settingsDoc.data().adminCode : null;

                if (!adminCode) {
                    alert('Admin code not configured. Please contact system administrator.');
                    return false;
                }

                const enteredCode = prompt(`üîê Enter admin code to ${actionDescription}:`);
                if (enteredCode === null) {
                    return false;
                }

                if (enteredCode !== adminCode) {
                    alert('‚ùå Incorrect admin code.');
                    return false;
                }

                return true;
            } catch (error) {
                console.error('Error verifying admin code:', error);
                alert('Unable to verify admin code. Please try again.');
                return false;
            }
        }

        // Show photo source selection modal
        function showPhotoSourceModal(toolId, partNumber) {
            const modalHtml = `
                <div class="modal fade" id="photoSourceModal" tabindex="-1" aria-labelledby="photoSourceModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-sm">
                        <div class="modal-content">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title" id="photoSourceModalLabel">Add Photo</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body text-center">
                                <div class="d-grid gap-3">
                                    <button type="button" class="btn btn-primary btn-lg" onclick="takePhotoWithCamera('${toolId}', '${partNumber}')">
                                        <i class="fas fa-camera"></i> Take Photo
                                    </button>
                                    <button type="button" class="btn btn-secondary btn-lg" onclick="selectPhotoFromGallery('${toolId}', '${partNumber}')">
                                        <i class="fas fa-images"></i> Choose from Gallery
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            const existingModal = document.getElementById('photoSourceModal');
            if (existingModal) {
                existingModal.remove();
            }

            document.body.insertAdjacentHTML('beforeend', modalHtml);

            const modal = new bootstrap.Modal(document.getElementById('photoSourceModal'));
            modal.show();

            document.getElementById('photoSourceModal').addEventListener('hidden.bs.modal', function() {
                this.remove();
            });
        }

        // Take photo with camera
        function takePhotoWithCamera(toolId, partNumber) {
            const sourceModal = bootstrap.Modal.getInstance(document.getElementById('photoSourceModal'));
            if (sourceModal) sourceModal.hide();

            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.capture = 'environment';
            input.style.display = 'none';

            input.onchange = function(event) {
                const file = event.target.files[0];
                if (file) {
                    uploadToolPhoto(toolId, partNumber, file);
                }
                document.body.removeChild(input);
            };

            document.body.appendChild(input);
            input.click();
        }

        // Select photo from gallery
        function selectPhotoFromGallery(toolId, partNumber) {
            const sourceModal = bootstrap.Modal.getInstance(document.getElementById('photoSourceModal'));
            if (sourceModal) sourceModal.hide();

            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.style.display = 'none';

            input.onchange = function(event) {
                const file = event.target.files[0];
                if (file) {
                    uploadToolPhoto(toolId, partNumber, file);
                }
                document.body.removeChild(input);
            };

            document.body.appendChild(input);
            input.click();
        }

        // Upload tool photo (full implementation with sharing logic)
        async function uploadToolPhoto(toolId, partNumber, file) {
            const db = window.db || firebase.firestore();
            const storage = window.storage || firebase.storage();
            try {
                const loadingModal = new bootstrap.Modal(document.getElementById('photoUploadLoadingModal'));
                loadingModal.show();
                document.getElementById('photoUploadProgress').textContent = 'Processing image...';

                const compressedBlob = await compressImage(file);
                if (!compressedBlob) {
                    loadingModal.hide();
                    alert('Failed to compress image');
                    return;
                }

                document.getElementById('photoUploadProgress').textContent = 'Uploading to storage...';

                const toolDoc = await db.collection('tools').doc(toolId).get();
                const currentPhotoUrls = toolDoc.exists ? (toolDoc.data().photoUrls || []) : [];
                const photoNumber = currentPhotoUrls.length + 1;

                const fileName = `${partNumber}_photo${photoNumber}.jpg`;

                const photoRef = storage.ref('Tool_Photos/' + fileName);
                const uploadTask = photoRef.put(compressedBlob);

                uploadTask.on('state_changed',
                    (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        document.getElementById('photoUploadProgress').textContent = `Uploading... ${Math.round(progress)}%`;
                    },
                    (error) => {
                        console.error('Upload error:', error);
                        loadingModal.hide();
                        alert('Upload failed: ' + error.message);
                    },
                    async () => {
                        try {
                            document.getElementById('photoUploadProgress').textContent = 'Updating database...';

                            const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();

                            const newPhotoUrls = [...currentPhotoUrls, downloadURL];
                            await db.collection('tools').doc(toolId).update({
                                photoUrls: newPhotoUrls
                            });

                            // Share with other tools if user chose "Add to ALL Tools"
                            const shouldAddToAll = photoUploadToAllTools && currentPhotoUploadToolId === toolId && currentPhotoUploadPartNumber === partNumber;
                            
                            if (shouldAddToAll) {
                                // Find all tools with the same part number and add the same photo
                                const toolsWithSamePart = await db.collection('tools')
                                    .where('partNumber', '==', partNumber)
                                    .get();
                                
                                const updatePromises = toolsWithSamePart.docs.map(async (doc) => {
                                    if (doc.id !== toolId) {
                                        const existingPhotoUrls = doc.data().photoUrls || [];
                                        const updatedPhotoUrls = [...existingPhotoUrls, downloadURL];
                                        await doc.ref.update({
                                            photoUrls: updatedPhotoUrls
                                        });
                                        console.log('Updated tool', doc.id, 'with same photo');
                                    }
                                });
                                
                                await Promise.all(updatePromises);
                                
                                loadingModal.hide();
                                alert('Photo uploaded successfully! Added to ' + (toolsWithSamePart.docs.length) + ' tools with the same part number.');
                            } else if (photoUploadAutoShareTargets.length > 0) {
                                const sharePromises = photoUploadAutoShareTargets.map(async (target) => {
                                    const existingPhotoUrls = target.photoUrls || [];
                                    if (!existingPhotoUrls.includes(downloadURL)) {
                                        const updatedPhotoUrls = [...existingPhotoUrls, downloadURL];
                                        await target.ref.update({
                                            photoUrls: updatedPhotoUrls
                                        });
                                        console.log('Auto-shared photo with tool', target.id);
                                    }
                                });

                                await Promise.all(sharePromises);

                                loadingModal.hide();
                                const reportLines = photoUploadAutoShareTargets.map(target => `${target.toolName} (${target.owner})`);
                                alert(`‚úÖ Photo uploaded successfully! Also shared with ${photoUploadAutoShareTargets.length} other tool(s) that previously had no photos:\n${reportLines.join('\n')}`);
                            } else {
                                loadingModal.hide();
                                alert('‚úÖ Photo uploaded successfully! Added to YOUR tool only.');
                            }

                            // Reset the global variables
                            photoUploadToAllTools = false;
                            currentPhotoUploadToolId = null;
                            currentPhotoUploadPartNumber = null;
                            photoUploadAutoShareTargets = [];

                            // Refresh the current view
                            if (lastViewedCollectionName) {
                                showMyToolsByCollection(lastViewedCollectionName);
                            } else {
                                await showMyTools();
                            }

                        } catch (error) {
                            console.error('Error updating tool:', error);
                            loadingModal.hide();
                            alert('Error updating tool: ' + error.message);
                        }
                    }
                );

            } catch (error) {
                console.error('Photo upload failed:', error);
                const loadingModal = bootstrap.Modal.getInstance(document.getElementById('photoUploadLoadingModal'));
                if (loadingModal) loadingModal.hide();
                alert('Upload failed: ' + error.message);
            }
        }

        // Show tool photo gallery
        function showToolPhotoGallery(el) {
            const photoUrls = JSON.parse(el.getAttribute('data-photo-urls'));
            const toolId = el.getAttribute('data-tool-id');
            const partNumber = el.getAttribute('data-part-number');
            if (!photoUrls || photoUrls.length === 0) return;
            let currentPhotoIndex = 0;
            const galleryContent = document.getElementById('toolPhotoGalleryContent');
            const counter = document.getElementById('toolPhotoCounter');
            const prevBtn = document.getElementById('toolPhotoPrevBtn');
            const nextBtn = document.getElementById('toolPhotoNextBtn');

            function updatePhoto() {
                galleryContent.innerHTML = `<img src="${photoUrls[currentPhotoIndex]}" class="img-fluid rounded shadow" style="max-height:80vh;max-width:100vw;object-fit:contain;">`;

                const prevArrow = document.createElement('button');
                prevArrow.type = 'button';
                prevArrow.className = 'btn btn-light position-absolute';
                prevArrow.id = 'toolPhotoPrevBtn';
                prevArrow.style = 'left: 20px; top: 50%; transform: translateY(-50%); z-index: 1000; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;';
                prevArrow.innerHTML = '<i class="fas fa-chevron-left"></i>';
                prevArrow.onclick = function() {
                    if (currentPhotoIndex > 0) {
                        currentPhotoIndex--;
                        updatePhoto();
                    }
                };

                const nextArrow = document.createElement('button');
                nextArrow.type = 'button';
                nextArrow.className = 'btn btn-light position-absolute';
                nextArrow.id = 'toolPhotoNextBtn';
                nextArrow.style = 'right: 20px; top: 50%; transform: translateY(-50%); z-index: 1000; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;';
                nextArrow.innerHTML = '<i class="fas fa-chevron-right"></i>';
                nextArrow.onclick = function() {
                    if (currentPhotoIndex < photoUrls.length - 1) {
                        currentPhotoIndex++;
                        updatePhoto();
                    }
                };

                galleryContent.appendChild(prevArrow);
                galleryContent.appendChild(nextArrow);

                counter.textContent = `${currentPhotoIndex + 1} / ${photoUrls.length}`;

                prevArrow.style.display = currentPhotoIndex === 0 ? 'none' : 'flex';
                nextArrow.style.display = currentPhotoIndex === photoUrls.length - 1 ? 'none' : 'flex';

                const deleteBtn = document.getElementById('toolPhotoDeleteBtn');
                if (deleteBtn) {
                    deleteBtn.onclick = function() {
                        deletePhoto(toolId, partNumber, currentPhotoIndex, photoUrls[currentPhotoIndex]);
                    };
                }
            }

            updatePhoto();
            const modal = new bootstrap.Modal(document.getElementById('toolPhotoGalleryModal'));
            modal.show();
            window.history.pushState({ modal: 'toolPhotoGallery' }, '', '');
        }

        // Delete photo function (full implementation with admin code verification)
        async function deletePhoto(toolId, partNumber, photoIndex, photoUrl) {
            const db = window.db || firebase.firestore();
            const storage = window.storage || firebase.storage();
            return new Promise(async (resolve, reject) => {
                try {
                    // Find all tools with the same part number to show owners
                    const toolsWithSamePart = await db.collection('tools')
                        .where('partNumber', '==', partNumber)
                        .get();

                    // Get unique owners
                    const owners = [...new Set(toolsWithSamePart.docs.map(doc => doc.data().owner))].filter(Boolean);
                    
                    // Format owners as numbered vertical list
                    let ownersListHTML = '';
                    if (owners.length === 0) {
                        ownersListHTML = '<div style="font-size: 1.15rem; font-weight: bold; color: #666;">Unknown</div>';
                    } else {
                        ownersListHTML = owners.map((owner, index) => 
                            `<div style="font-size: 1.15rem; font-weight: bold; color: #333; margin-bottom: 6px;">${index + 1}. ${owner}</div>`
                        ).join('');
                    }
                    
                    // Show custom modal with owner information
                    document.getElementById('photoDeleteOwnersList').innerHTML = ownersListHTML;
                    const choiceModal = new bootstrap.Modal(document.getElementById('photoDeleteChoiceModal'));
                    choiceModal.show();
                    
                    let deleteFromAll = false;
                    
                    // Handle "Delete from MY Tool Only" button
                    document.getElementById('deleteMyToolOnlyBtn').onclick = function() {
                        choiceModal.hide();
                        
                        if (!confirm('‚ö†Ô∏è Are you sure you want to delete this photo from YOUR tool?\n\nThis action cannot be undone.')) {
                            return;
                        }
                        
                        deleteFromAll = false;
                        proceedWithDeletion();
                    };
                    
                    // Handle "Delete from ALL Tools" button
                    document.getElementById('deleteFromAllToolsBtn').onclick = async function() {
                        const db = window.db || firebase.firestore();
                        choiceModal.hide();
                        
                        const settingsDoc = await db.collection('settings').doc('admin').get();
                        const adminCode = settingsDoc.exists ? settingsDoc.data().adminCode : null;
                        
                        if (!adminCode) {
                            alert('Admin code not configured. Please contact system administrator.');
                            return;
                        }
                        
                        const enteredCode = prompt('üîê Enter admin code to delete photo from ALL tools:');
                        
                        if (enteredCode === null) {
                            return;
                        }
                        
                        if (enteredCode !== adminCode) {
                            alert('‚ùå Incorrect admin code. Photo deletion cancelled.');
                            return;
                        }
                        
                        if (!confirm(`‚ö†Ô∏è Are you sure you want to delete this photo from ALL ${toolsWithSamePart.docs.length} tools?\n\nThis will permanently remove the photo from:\n${owners.join('\n')}\n\nThis action CANNOT be undone!`)) {
                            return;
                        }
                        
                        deleteFromAll = true;
                        proceedWithDeletion();
                    };
                    
                    async function proceedWithDeletion() {
                        const db = window.db || firebase.firestore();
                        const storage = window.storage || firebase.storage();
                        const loadingModal = new bootstrap.Modal(document.getElementById('photoUploadLoadingModal'));
                        loadingModal.show();
                        document.getElementById('photoUploadProgress').textContent = 'Deleting photo...';

                        const toolDoc = await db.collection('tools').doc(toolId).get();
                        const currentPhotoUrls = toolDoc.exists ? (toolDoc.data().photoUrls || []) : [];
                        
                        const updatedPhotoUrls = currentPhotoUrls.filter((url, index) => index !== photoIndex);
                        
                        await db.collection('tools').doc(toolId).update({
                            photoUrls: updatedPhotoUrls
                        });

                        let affectedToolsCount = 1;

                        if (deleteFromAll) {
                            const updatePromises = toolsWithSamePart.docs.map(async (doc) => {
                                if (doc.id !== toolId) {
                                    const existingPhotoUrls = doc.data().photoUrls || [];
                                    const updatedUrls = existingPhotoUrls.filter(url => url !== photoUrl);
                                    await doc.ref.update({
                                        photoUrls: updatedUrls
                                    });
                                    console.log('Updated tool', doc.id, 'removed same photo');
                                }
                            });

                            await Promise.all(updatePromises);
                            affectedToolsCount = toolsWithSamePart.docs.length;

                            // Try to delete from Firebase Storage
                            try {
                                const urlParts = photoUrl.split('/');
                                const encodedPath = urlParts[urlParts.length - 1].split('?')[0];
                                const decodedPath = decodeURIComponent(encodedPath);
                                const photoRef = storage.ref().child(decodedPath);
                                await photoRef.delete();
                            } catch (storageError) {
                                console.warn('Could not delete from storage:', storageError);
                            }
                        } else {
                            // Try to delete from Firebase Storage
                            try {
                                const urlParts = photoUrl.split('/');
                                const encodedPath = urlParts[urlParts.length - 1].split('?')[0];
                                const decodedPath = decodeURIComponent(encodedPath);
                                const photoRef = storage.ref().child(decodedPath);
                                await photoRef.delete();
                            } catch (storageError) {
                                console.warn('Could not delete from storage:', storageError);
                            }
                        }

                        loadingModal.hide();
                        alert(`Photo deleted successfully from ${affectedToolsCount} tool(s)!`);

                        const galleryModal = bootstrap.Modal.getInstance(document.getElementById('toolPhotoGalleryModal'));
                        if (galleryModal) galleryModal.hide();

                        if (lastViewedCollectionName) {
                            showMyToolsByCollection(lastViewedCollectionName);
                        } else {
                            await showMyTools();
                        }
                    }
                } catch (error) {
                    console.error('Photo delete failed:', error);
                    alert('Delete failed: ' + error.message);
                }
            });
        }

        // Show location photos from title bar
        async function showLocationPhotosFromTitleBar(collectionName, location) {
            try {
                const documentId = `${collectionName}_${location}`;
                const docRef = db.collection('locationPhotos').doc(documentId);
                const doc = await docRef.get();

                if (!doc.exists) {
                    alert('No photos found for this location.');
                    return;
                }

                const data = doc.data();
                const photoUrls = data.photoUrls || [];

                if (photoUrls.length === 0) {
                    alert('No photos found for this location.');
                    return;
                }

                // Go directly to full-screen gallery starting from first photo
                showLocationPhotoFullscreen(JSON.stringify(photoUrls), 0, collectionName, location);
                
            } catch (error) {
                console.error('Error loading location photos:', error);
                alert('Error loading photos. Please try again.');
            }
        }

        // Show location photo in fullscreen
        function showLocationPhotoFullscreen(photoUrlsJson, photoIndex, collectionName, location) {
            const photoUrls = JSON.parse(photoUrlsJson);
            if (!photoUrls || photoUrls.length === 0) return;
            
            let currentPhotoIndex = photoIndex;
            
            let modal = document.getElementById('locationPhotoFullscreenModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.className = 'modal fade';
                modal.id = 'locationPhotoFullscreenModal';
                modal.tabIndex = -1;
                modal.innerHTML = `
                    <div class="modal-dialog modal-fullscreen">
                        <div class="modal-content bg-dark text-white">
                            <div class="modal-header border-0">
                                <h5 class="modal-title">Location Photos: ${collectionName} / ${location}</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body d-flex flex-column align-items-center justify-content-center position-relative" id="locationPhotoFullscreenContent">
                            </div>
                            <div class="modal-footer justify-content-center border-0 bg-dark">
                                <span id="locationPhotoCounter" class="text-white"></span>
                                <button type="button" class="btn btn-danger ms-3" id="locationPhotoDeleteBtn">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            const contentElement = document.getElementById('locationPhotoFullscreenContent');
            const counter = document.getElementById('locationPhotoCounter');
            
            function updatePhoto() {
                contentElement.innerHTML = `<img src="${photoUrls[currentPhotoIndex]}" class="img-fluid rounded shadow" style="max-height:80vh;max-width:100vw;object-fit:contain;">`;

                const prevArrow = document.createElement('button');
                prevArrow.type = 'button';
                prevArrow.className = 'btn btn-light position-absolute';
                prevArrow.style = 'left: 20px; top: 50%; transform: translateY(-50%); z-index: 1000; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;';
                prevArrow.innerHTML = '<i class="fas fa-chevron-left"></i>';
                prevArrow.onclick = function() {
                    if (currentPhotoIndex > 0) {
                        currentPhotoIndex--;
                        updatePhoto();
                    }
                };

                const nextArrow = document.createElement('button');
                nextArrow.type = 'button';
                nextArrow.className = 'btn btn-light position-absolute';
                nextArrow.style = 'right: 20px; top: 50%; transform: translateY(-50%); z-index: 1000; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;';
                nextArrow.innerHTML = '<i class="fas fa-chevron-right"></i>';
                nextArrow.onclick = function() {
                    if (currentPhotoIndex < photoUrls.length - 1) {
                        currentPhotoIndex++;
                        updatePhoto();
                    }
                };

                contentElement.appendChild(prevArrow);
                contentElement.appendChild(nextArrow);

                counter.textContent = `${currentPhotoIndex + 1} / ${photoUrls.length}`;

                prevArrow.style.display = currentPhotoIndex === 0 ? 'none' : 'flex';
                nextArrow.style.display = currentPhotoIndex === photoUrls.length - 1 ? 'none' : 'flex';

                const deleteBtn = document.getElementById('locationPhotoDeleteBtn');
                if (deleteBtn) {
                    deleteBtn.onclick = function() {
                        deleteLocationPhoto(collectionName, location, currentPhotoIndex, photoUrls[currentPhotoIndex]);
                    };
                }
            }

            updatePhoto();

            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
        }

        // Delete location photo
        async function deleteLocationPhoto(collectionName, location, photoIndex, photoUrl) {
            if (!confirm('Are you sure you want to delete this location photo? This action cannot be undone.')) {
                return;
            }

            try {
                const loadingModal = new bootstrap.Modal(document.getElementById('photoUploadLoadingModal'));
                loadingModal.show();
                document.getElementById('photoUploadProgress').textContent = 'Deleting photo...';

                const documentId = `${collectionName}_${location}`;
                const docRef = db.collection('locationPhotos').doc(documentId);
                const doc = await docRef.get();

                if (!doc.exists) {
                    throw new Error('Location document not found');
                }

                const currentPhotoUrls = doc.data().photoUrls || [];
                const updatedPhotoUrls = currentPhotoUrls.filter((url, index) => index !== photoIndex);

                await docRef.update({
                    photoUrls: updatedPhotoUrls
                });

                try {
                    const urlParts = photoUrl.split('/');
                    const encodedPath = urlParts[urlParts.length - 1].split('?')[0];
                    const decodedPath = decodeURIComponent(encodedPath);
                    const photoRef = storage.ref().child(decodedPath);
                    await photoRef.delete();
                } catch (storageError) {
                    console.warn('Could not delete from storage:', storageError);
                }

                loadingModal.hide();
                alert('Location photo deleted successfully!');

                const galleryModal = bootstrap.Modal.getInstance(document.getElementById('locationPhotoFullscreenModal'));
                if (galleryModal) galleryModal.hide();

                if (lastViewedCollectionName) {
                    showMyToolsByCollection(lastViewedCollectionName);
                }

            } catch (error) {
                console.error('Location photo delete failed:', error);
                const loadingModal = bootstrap.Modal.getInstance(document.getElementById('photoUploadLoadingModal'));
                if (loadingModal) loadingModal.hide();
                alert('Delete failed: ' + error.message);
            }
        }

        // Show location photo upload dialog
        async function showLocationPhotoUploadDialog(collectionName, location) {
            try {
                const toolsSnapshot = await db.collection('tools')
                    .where('collectionCode', '==', collectionName)
                    .get();
                
                if (toolsSnapshot.empty) {
                    alert('No tools found for this collection.');
                    return;
                }
                
                const locations = [...new Set(toolsSnapshot.docs.map(doc => doc.data().location).filter(Boolean))].sort();
                
                if (locations.length === 0) {
                    alert('No locations found for this collection.');
                    return;
                }
                
                // Create location selection modal
                const modalHtml = `
                    <div class="modal fade" id="locationPhotoLocationSelectModal" tabindex="-1" aria-labelledby="locationPhotoLocationSelectModalLabel" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header bg-success text-white">
                                    <h5 class="modal-title" id="locationPhotoLocationSelectModalLabel">Select Location for Photo</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <strong>Collection:</strong> ${collectionName}
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label"><strong>Select Location:</strong></label>
                                        <select id="locationPhotoLocationSelect" class="form-select">
                                            <option value="">Choose a location...</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="button" class="btn btn-success" id="locationPhotoLocationConfirmBtn">Continue</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                const existingModal = document.getElementById('locationPhotoLocationSelectModal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                const modal = document.getElementById('locationPhotoLocationSelectModal');
                const locationSelect = modal.querySelector('#locationPhotoLocationSelect');
                locationSelect.innerHTML = '<option value="">Choose a location...</option>';
                locations.forEach(loc => {
                    locationSelect.innerHTML += `<option value="${loc}">${loc}</option>`;
                });
                
                const bsModal = new bootstrap.Modal(modal);
                bsModal.show();
                
                document.getElementById('locationPhotoLocationConfirmBtn').onclick = function() {
                    const selectedLocation = locationSelect.value;
                    if (!selectedLocation) {
                        alert('Please select a location.');
                        return;
                    }
                    
                    bsModal.hide();
                    showLocationPhotoFileUploadDialog(collectionName, selectedLocation);
                };
                
            } catch (error) {
                console.error('Error loading locations:', error);
                alert('Error loading locations. Please try again.');
            }
        }

        // ============================================
        // COLLECTION CHECKUP FUNCTIONALITY
        // ============================================
        
        function showCollectionCheckupScreen() {
            document.getElementById('myToolsByCollectionScreen').style.display = 'none';
            document.getElementById('collectionCheckupScreen').style.display = 'block';
            
            // Reset checkup state
            checkupCheckedTools = new Set();
            // Set initial location to first available location instead of 'All'
            const tools = lastViewedCollectionTools;
            const locations = [...new Set(tools.map(t => t.location || 'No Location'))].sort();
            checkupSelectedLocation = locations.length > 0 ? locations[0] : 'No Location';
            
            // Update the main title bar
            const mainTitle = document.querySelector('#collectionCheckupScreen h2');
            if (mainTitle && lastViewedCollectionName) {
                mainTitle.textContent = `${lastViewedCollectionName} Collection Checkup`;
            }
            
            // Set initial location title
            const locationTitle = document.getElementById('checkupLocationTitle');
            if (locationTitle) {
                locationTitle.textContent = checkupSelectedLocation;
            }
            
            if (!lastViewedCollectionTools.length) {
                document.getElementById('checkupToolsList').innerHTML = '<div class="text-center text-danger">No tools found for checkup.</div>';
                document.getElementById('checkupActionButtons').style.display = 'none';
                return;
            }
            
            // Show action buttons
            document.getElementById('checkupActionButtons').style.display = 'block';
            
            // Render tools and location filter
            renderCheckupTools();
            renderCheckupLocationFilter();
            updateCheckupProgress();
        }

        function renderCheckupTools() {
            const list = document.getElementById('checkupToolsList');
            const tools = lastViewedCollectionTools;
            
            // Filter tools by selected location
            const filteredTools = tools.filter(t => (t.location || 'No Location') === checkupSelectedLocation);
            
            if (filteredTools.length === 0) {
                list.innerHTML = '<div class="text-center text-muted">No tools in selected location.</div>';
                return;
            }
            
            let html = '';
            filteredTools.forEach((tool, index) => {
                const isChecked = checkupCheckedTools.has(tool.id);
                const status = (tool.status || '').toUpperCase();
                
                // Determine background color based on status and checked state
                let bgColor = '#f5f5f5'; // Default gray
                if (isChecked) {
                    bgColor = '#e8f5e8'; // Light green for checked
                } else if (status === 'OUT') {
                    bgColor = '#ffebee'; // Light red for out
                } else if (status === 'BROKEN') {
                    bgColor = '#fff3e0'; // Light orange for broken
                } else if (status === 'LOST') {
                    bgColor = '#ffe0b2'; // Light amber for lost
                } else if (status === 'CALIBRATION') {
                    bgColor = '#e3f2fd'; // Light blue for calibration
                }
                
                html += `
                    <div class="card mb-2" style="background-color: ${bgColor}; border: 1px solid #ddd;">
                        <div class="card-body p-3">
                            <div class="row align-items-center">
                                <div class="col-auto">
                                    <input type="checkbox" class="form-check-input" id="checkupTool${tool.id}" 
                                           ${isChecked ? 'checked' : ''} 
                                           onchange="toggleCheckupTool('${tool.id}', this.checked)"
                                           style="transform: scale(1.2);">
                                </div>
                                <div class="col">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <h6 class="mb-1"><strong>${index + 1}. ${escapeHtml(tool.toolName || 'Unknown Tool')}</strong></h6>
                                            <div class="text-muted small">Part #: ${escapeHtml(tool.partNumber || 'N/A')}</div>
                                            <div class="text-muted small">Location: ${escapeHtml(tool.location || 'No Location')}</div>
                                            <div class="small">
                                                <strong>Status: </strong>
                                                <span style="color: ${getStatusColor(status)};">${escapeHtml(tool.status || 'N/A')}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            list.innerHTML = html;
        }

        function renderCheckupLocationFilter() {
            const tools = lastViewedCollectionTools;
            const locations = [...new Set(tools.map(t => t.location || 'No Location'))].sort();
            
            let html = '';
            locations.forEach(loc => {
                const isSelected = checkupSelectedLocation === loc;
                html += `
                    <button class="btn btn-sm ${isSelected ? 'btn-orange' : 'btn-outline-secondary'}" 
                            onclick="selectCheckupLocation('${escapeHtml(loc)}')"
                            style="${isSelected ? 'background-color:#FF9800;color:white;border-color:#FF9800;' : 'background-color:transparent;color:#6c757d;border-color:#6c757d;'}">
                        ${escapeHtml(loc)}
                    </button>
                `;
            });
            
            document.getElementById('checkupLocationButtons').innerHTML = html;
        }

        function selectCheckupLocation(location) {
            checkupSelectedLocation = location;
            
            // Update the location title
            const locationTitle = document.getElementById('checkupLocationTitle');
            if (locationTitle) {
                locationTitle.textContent = location;
            }
            
            renderCheckupTools();
            renderCheckupLocationFilter();
            updateCheckupProgress();
        }

        function toggleCheckupTool(toolId, checked) {
            if (checked) {
                checkupCheckedTools.add(toolId);
            } else {
                checkupCheckedTools.delete(toolId);
            }
            updateCheckupProgress();
        }

        function updateCheckupProgress() {
            const totalTools = lastViewedCollectionTools.length;
            const checkedCount = checkupCheckedTools.size;
            document.getElementById('checkupProgress').textContent = `${checkedCount}/${totalTools}`;
        }

        // Select All functionality
        document.getElementById('selectAllBtn').onclick = function() {
            const tools = lastViewedCollectionTools.filter(t => (t.location || 'No Location') === checkupSelectedLocation);
            
            tools.forEach(tool => {
                checkupCheckedTools.add(tool.id);
            });
            
            renderCheckupTools();
            updateCheckupProgress();
        };

        // Show Results functionality
        document.getElementById('showResultsBtn').onclick = function() {
            showCheckupResults();
        };

        function showCheckupResults() {
            const tools = lastViewedCollectionTools;
            const totalTools = tools.length;
            const checkedCount = checkupCheckedTools.size;
            const uncheckedCount = totalTools - checkedCount;
            
            // Calculate location stats
            const locationStats = {};
            const locations = [...new Set(tools.map(t => t.location || 'No Location'))];
            locations.forEach(loc => {
                const locationTools = tools.filter(t => (t.location || 'No Location') === loc);
                const locationChecked = locationTools.filter(t => checkupCheckedTools.has(t.id)).length;
                locationStats[loc] = {
                    total: locationTools.length,
                    checked: locationChecked,
                    unchecked: locationTools.length - locationChecked
                };
            });
            
            let html = `
                <div class="mb-4">
                    <h6><strong>Overall Summary:</strong></h6>
                    <div class="row">
                        <div class="col-4">
                            <div class="text-center">
                                <div class="h4 text-primary">${totalTools}</div>
                                <small class="text-muted">Total Tools</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="text-center">
                                <div class="h4 text-success">${checkedCount}</div>
                                <small class="text-muted">Checked</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="text-center">
                                <div class="h4 text-warning">${uncheckedCount}</div>
                                <small class="text-muted">Unchecked</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div>
                    <h6><strong>By Location:</strong></h6>
        `;
        
        Object.entries(locationStats).forEach(([location, stats]) => {
            html += `
                <div class="card mb-2">
                    <div class="card-body p-3">
                        <h6 class="card-title">${escapeHtml(location)}</h6>
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="text-primary">${stats.total}</div>
                                <small class="text-muted">Total</small>
                            </div>
                            <div class="col-4">
                                <div class="text-success">${stats.checked}</div>
                                <small class="text-muted">Checked</small>
                            </div>
                            <div class="col-4">
                                <div class="text-warning">${stats.unchecked}</div>
                                <small class="text-muted">Unchecked</small>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        
        document.getElementById('checkupResultsContent').innerHTML = html;
        
        const modal = new bootstrap.Modal(document.getElementById('checkupResultsModal'));
        modal.show();
    }

    // Save Results functionality
    document.getElementById('saveCheckupResultsBtn').onclick = function() {
        saveCheckupResults();
    };

    async function saveCheckupResults() {
        const tools = lastViewedCollectionTools;
        const totalTools = tools.length;
        const checkedCount = checkupCheckedTools.size;
        const uncheckedCount = totalTools - checkedCount;
        
        // Calculate location stats
        const locationStats = {};
        const locations = [...new Set(tools.map(t => t.location || 'No Location'))];
        locations.forEach(loc => {
            const locationTools = tools.filter(t => (t.location || 'No Location') === loc);
            const locationChecked = locationTools.filter(t => checkupCheckedTools.has(t.id)).length;
            locationStats[loc] = {
                total: locationTools.length,
                checked: locationChecked,
                unchecked: locationTools.length - locationChecked
            };
        });
        
        try {
            const user = auth.currentUser;
            const fullName = localStorage.getItem('fullName') || user.email;
            
            const checkupData = {
                technicianName: fullName,
                collectionCode: lastViewedCollectionName,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                totalTools: totalTools,
                checkedTools: checkedCount,
                uncheckedTools: uncheckedCount,
                locationStats: locationStats,
                checkedToolIds: Array.from(checkupCheckedTools),
                allToolIds: tools.map(t => t.id),
                checkupDate: new Date().toLocaleString('en-GB')
            };
            
            // Create custom document ID
            const technicianNameWithoutSpaces = fullName.replace(/\s+/g, '');
            const timestamp = new Date();
            const timestampString = timestamp.toLocaleString('en-GB', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            }).replace(/[/:]/g, '').replace(/\s+/g, '-');
            
            const documentId = `${technicianNameWithoutSpaces}_${timestampString}`;
            
            await db.collection('checkupResults').doc(documentId).set(checkupData);
            
            // Close results modal and show success modal
            const resultsModal = bootstrap.Modal.getInstance(document.getElementById('checkupResultsModal'));
            resultsModal.hide();
            
            const successModal = new bootstrap.Modal(document.getElementById('checkupSaveSuccessModal'));
            successModal.show();
            
        } catch (error) {
            console.error('Error saving checkup results:', error);
            alert('Error saving checkup results: ' + error.message);
        }
    }

    // History button
    document.getElementById('checkupHistoryBtn').onclick = function() {
        showCheckupHistoryScreen();
    };

    function getStatusColor(status) {
        switch (status) {
            case 'OUT': return '#d32f2f';
            case 'BROKEN': return '#ff6f00';
            case 'LOST': return '#ff8f00';
            case 'CALIBRATION': return '#1976d2';
            default: return '#388e3c';
        }
    }

    document.getElementById('backToMyToolsByCollectionBtn').onclick = function() {
        document.getElementById('collectionCheckupScreen').style.display = 'none';
        document.getElementById('myToolsByCollectionScreen').style.display = 'block';
    };

    function showCheckupHistoryScreen() {
        // Hide all other main screens
        document.getElementById('myToolsByCollectionScreen').style.display = 'none';
        document.getElementById('collectionCheckupScreen').style.display = 'none';
        document.getElementById('checkupHistoryScreen').style.display = 'block';
        // Set technician name
        const user = auth.currentUser;
        const fullName = localStorage.getItem('fullName') || (user ? user.email : '');
        document.getElementById('checkupHistoryTechName').textContent = fullName;
        // Load history
        loadCheckupHistory();
    }

    document.getElementById('checkupHistoryBackBtn').onclick = function() {
        document.getElementById('checkupHistoryScreen').style.display = 'none';
        document.getElementById('collectionCheckupScreen').style.display = 'block';
    };

    document.getElementById('checkupHistoryRefreshBtn').onclick = function() {
        loadCheckupHistory();
    };

    document.getElementById('checkupHistoryCleanupBtn').onclick = function() {
        cleanupOldCheckupHistory();
    };

    document.getElementById('checkupHistorySearch').oninput = function() {
        renderCheckupHistoryList(window._checkupHistoryRaw || []);
    };
    document.getElementById('checkupHistoryCollectionFilter').onchange = function() {
        renderCheckupHistoryList(window._checkupHistoryRaw || []);
    };

    async function loadCheckupHistory() {
        const user = auth.currentUser;
        if (!user) return;
        const fullName = localStorage.getItem('fullName') || user.email;
        const listDiv = document.getElementById('checkupHistoryList');
        listDiv.innerHTML = '<div class="text-center">Loading...</div>';
        try {
            const snap = await db.collection('checkupResults')
                .where('technicianName', '==', fullName)
                .orderBy('timestamp', 'desc')
                .get();
            const records = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            window._checkupHistoryRaw = records;
            // Populate collection filter
            const collections = Array.from(new Set(records.map(r => r.collectionCode || 'All')));
            const filter = document.getElementById('checkupHistoryCollectionFilter');
            filter.innerHTML = '<option value="All">All</option>' + collections.map(c => `<option value="${c}">${escapeHtml(c)}</option>`).join('');
            renderCheckupHistoryList(records);
        } catch (e) {
            listDiv.innerHTML = `<div class='text-danger text-center'>Error loading history: ${escapeHtml(e.message)}</div>`;
        }
    }

    function renderCheckupHistoryList(records) {
        const search = document.getElementById('checkupHistorySearch').value.trim().toLowerCase();
        const filter = document.getElementById('checkupHistoryCollectionFilter').value;
        let filtered = records;
        if (filter && filter !== 'All') {
            filtered = filtered.filter(r => (r.collectionCode || 'All') === filter);
        }
        if (search) {
            filtered = filtered.filter(r =>
                (r.collectionCode || '').toLowerCase().includes(search) ||
                (r.checkupDate || '').toLowerCase().includes(search)
            );
        }
        const listDiv = document.getElementById('checkupHistoryList');
        if (!filtered.length) {
            listDiv.innerHTML = '<div class="text-center text-muted">No checkup history found.</div>';
            return;
        }
        let html = '';
        filtered.forEach(r => {
            const checked = r.checkedTools || 0;
            const total = r.totalTools || 0;
            const isAll = (r.collectionCode || '').toLowerCase().includes('all');
            html += `<div style="background:#fff;border-radius:16px;padding:16px 12px;margin-bottom:16px;box-shadow:0 2px 4px rgba(0,0,0,0.07);border:1px solid #ddd;">
                <div style="font-size:1.15em;font-weight:bold;color:#000;">${escapeHtml(r.checkupDate || 'Unknown')}</div>
                <div style="color:#888;font-size:1.05em;">Collection: <span style="color:${isAll ? '#888' : '#FF9800'};font-weight:bold;">${escapeHtml(r.collectionCode || 'All Collections')}</span></div>
                <div style="font-size:1.1em;font-weight:bold;color:${checked===total?'#388E3C':'#388E3C'};float:right;">${checked}/${total} <span style="font-weight:normal;color:#888;font-size:0.95em;">Tools Checked</span></div>
                <hr style="margin:8px 0;">
                <div class="d-flex justify-content-between align-items-center">
                    <a href="#" style="color:#1976d2;font-weight:bold;font-size:1.1em;" onclick="event.preventDefault();showCheckupDetails('${r.id}')">View Details</a>
                    <a href="#" style="color:#f44336;font-weight:bold;font-size:1.1em;" onclick="event.preventDefault();deleteCheckupHistoryRecord('${r.id}')">Delete</a>
                </div>
            </div>`;
        });
        listDiv.innerHTML = html;
    }

    async function deleteCheckupHistoryRecord(id) {
        if (!confirm('Delete this checkup record?')) return;
        try {
            await db.collection('checkupResults').doc(id).delete();
            loadCheckupHistory();
        } catch (e) {
            alert('Error deleting record: ' + e.message);
        }
    }

    async function cleanupOldCheckupHistory() {
        if (!confirm('Delete all checkup records older than 1 month?')) return;
        const user = auth.currentUser;
        if (!user) return;
        const fullName = localStorage.getItem('fullName') || user.email;
        const cutoff = new Date();
        cutoff.setMonth(cutoff.getMonth() - 1);
        try {
            const snap = await db.collection('checkupResults')
                .where('technicianName', '==', fullName)
                .where('timestamp', '<', cutoff)
                .get();
            const batch = db.batch();
            snap.docs.forEach(doc => batch.delete(doc.ref));
            await batch.commit();
            loadCheckupHistory();
        } catch (e) {
            alert('Error cleaning up: ' + e.message);
        }
    }

    function showCheckupDetails(id) {
        const record = (window._checkupHistoryRaw || []).find(r => r.id === id);
        if (!record) {
            alert('Checkup record not found.');
            return;
        }

        // Show loading state
        document.getElementById('checkupDetailsContent').innerHTML = '<div class="text-center">Loading...</div>';
        const modal = new bootstrap.Modal(document.getElementById('checkupDetailsModal'));
        modal.show();

        // Get unchecked tool IDs
        const checked = record.checkedToolIds || [];
        const all = record.allToolIds || [];
        const unchecked = all.filter(id => !checked.includes(id));

        // Fetch tool details for unchecked tools and all tools (for location stats)
        (async () => {
            let missingTools = [];
            let allTools = [];
            if (all.length > 0) {
                const dbTools = firebase.firestore().collection('tools');
                for (let i = 0; i < all.length; i += 10) {
                    const batch = all.slice(i, i + 10);
                    const snap = await dbTools.where(firebase.firestore.FieldPath.documentId(), 'in', batch).get();
                    allTools = allTools.concat(snap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                }
            }
            if (unchecked.length > 0) {
                // Batch Firestore gets (max 10 per batch)
                const dbTools = firebase.firestore().collection('tools');
                for (let i = 0; i < unchecked.length; i += 10) {
                    const batch = unchecked.slice(i, i + 10);
                    const snap = await dbTools.where(firebase.firestore.FieldPath.documentId(), 'in', batch).get();
                    missingTools = missingTools.concat(snap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                }
            }

            // Group all tools by location for stats
            const allByLocation = {};
            allTools.forEach(tool => {
                const loc = tool.location || 'Unknown';
                if (!allByLocation[loc]) allByLocation[loc] = [];
                allByLocation[loc].push(tool);
            });
            // Group missing tools by location
            const missingByLocation = {};
            missingTools.forEach(tool => {
                const loc = tool.location || 'Unknown';
                if (!missingByLocation[loc]) missingByLocation[loc] = [];
                missingByLocation[loc].push(tool);
            });
            // Group checked tools by location for stats
            const checkedSet = new Set(checked);
            const checkedByLocation = {};
            allTools.forEach(tool => {
                if (checkedSet.has(tool.id)) {
                    const loc = tool.location || 'Unknown';
                    if (!checkedByLocation[loc]) checkedByLocation[loc] = [];
                    checkedByLocation[loc].push(tool);
                }
            });

            // Build HTML
            let html = `
                <div style="font-size:1.3em;font-weight:bold;margin-bottom:10px;">
                    <span style="background:#f8f8f8;padding:8px 18px;border-radius:12px;display:inline-block;">
                        Checked: ${checked.length}<br>Unchecked: ${unchecked.length}
                    </span>
                </div>
            `;

            if (Object.keys(allByLocation).length > 0) {
                // Sort locations alphabetically
                const sortedLocs = Object.keys(allByLocation).sort((a, b) => a.localeCompare(b, undefined, {numeric: true, sensitivity: 'base'}));
                html += `<style>
                    .expand-arrow { display:inline-block; transition:transform 0.2s; font-size:1.2em; margin-right:6px; }
                    .expand-arrow.open { transform:rotate(90deg); }
                    .location-summary-card { cursor:pointer; }
                    .missing-tools-section { display:none; }
                    .missing-tools-section.open { display:block; }
                </style>`;
                sortedLocs.forEach((loc, idx) => {
                    const total = allByLocation[loc].length;
                    const checkedCount = checkedByLocation[loc] ? checkedByLocation[loc].length : 0;
                    const uncheckedCount = total - checkedCount;
                    const hasMissing = missingByLocation[loc] && missingByLocation[loc].length > 0;
                    const sectionId = `missingToolsSection_${id.replace(/[^a-zA-Z0-9]/g, '')}_${idx}`;
                    const arrowId = `expandArrow_${id.replace(/[^a-zA-Z0-9]/g, '')}_${idx}`;
                    html += `
                        <div class="location-summary-card" onclick="toggleMissingToolsSection('${sectionId}', '${arrowId}')" style="background:#e3f2fd;border-radius:14px;padding:10px 12px 8px 12px;margin-bottom:8px;">
                            <span id="${arrowId}" class="expand-arrow">&#9654;</span>
                            <span style="font-weight:bold;color:#1976d2;font-size:1.1em;">${escapeHtml(loc)}</span>
                            <div style="color:#333;font-size:1.0em;">Total: ${total} &nbsp; Checked: ${checkedCount} &nbsp; Unchecked: ${uncheckedCount}</div>
                        </div>
                    `;
                    // Always show the section, but only fill it if there are missing tools
                    html += `<div id="${sectionId}" class="missing-tools-section" style="margin-bottom:12px;">`;
                    if (hasMissing) {
                        html += `<div style="color:#d32f2f;font-weight:bold;font-size:1.1em;margin:8px 0 4px 0;">Missing Tools (Not Checked):</div>`;
                        missingByLocation[loc].forEach(tool => {
                            html += `
                                <div style="background:#ffebee;border-radius:10px;padding:10px 12px;margin-bottom:8px;">
                                    <div style="color:#d32f2f;font-weight:bold;font-size:1.15em;line-height:1.2;">
                                        <span style="font-size:1.2em;">&#9888;</span> ${escapeHtml(tool.toolName || tool.id)}
                                    </div>
                                    <div style="color:#888;font-size:1em;margin-top:4px;">
                                        Part #: ${escapeHtml(tool.partNumber || tool.id)}<br>
                                        Location: ${escapeHtml(tool.location || 'Unknown')}<br>
                                        Status: ${escapeHtml(tool.status || 'N/A')}
                                    </div>
                                </div>
                            `;
                        });
                    } else {
                        html += `<div style="color:#388e3c;font-size:1em;margin:8px 0 4px 0;">No missing tools in this location.</div>`;
                    }
                    html += `</div>`;
                });
            } else {
                html += `<div class="text-success" style="font-weight:bold;font-size:1.1em;">All tools checked!</div>`;
            }

            // Add the toggleMissingToolsSection function to window
            window.toggleMissingToolsSection = function(sectionId, arrowId) {
                var section = document.getElementById(sectionId);
                var arrow = document.getElementById(arrowId);
                if (section) {
                    var isOpen = section.classList.contains('open');
                    if (isOpen) {
                        section.classList.remove('open');
                        if (arrow) arrow.classList.remove('open');
                    } else {
                        section.classList.add('open');
                        if (arrow) arrow.classList.add('open');
                    }
                }
            };

            document.getElementById('checkupDetailsContent').innerHTML = html;
        })();
    }

        // ============================================
        // END COLLECTION CHECKUP FUNCTIONALITY
        // ============================================

        // Show location photo file upload dialog
        async function showLocationPhotoFileUploadDialog(collectionName, selectedLocation) {
            const modalHtml = `
                <div class="modal fade" id="locationPhotoSourceModal" tabindex="-1" aria-labelledby="locationPhotoSourceModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header bg-success text-white">
                                <h5 class="modal-title" id="locationPhotoSourceModalLabel">Choose Photo Source</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <strong>Collection:</strong> ${collectionName}<br>
                                    <strong>Location:</strong> ${selectedLocation}
                                </div>
                                <div class="d-grid gap-2">
                                    <button id="locationPhotoCameraBtn" class="btn btn-primary">
                                        <i class="fas fa-camera"></i> Take Photo with Camera
                                    </button>
                                    <button id="locationPhotoBrowseBtn" class="btn btn-secondary">
                                        <i class="fas fa-folder-open"></i> Browse from Gallery
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const existingModal = document.getElementById('locationPhotoSourceModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            const modal = document.getElementById('locationPhotoSourceModal');
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            document.getElementById('locationPhotoCameraBtn').onclick = function() {
                bsModal.hide();
                showLocationPhotoCameraDialog(collectionName, selectedLocation);
            };
            
            document.getElementById('locationPhotoBrowseBtn').onclick = function() {
                bsModal.hide();
                showLocationPhotoBrowseDialog(collectionName, selectedLocation);
            };
        }

        // Show location photo camera dialog
        function showLocationPhotoCameraDialog(collectionName, selectedLocation) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.capture = 'environment';
            input.style.display = 'none';

            input.onchange = function(event) {
                const file = event.target.files[0];
                if (file) {
                    uploadLocationPhoto(collectionName, selectedLocation, file);
                }
                document.body.removeChild(input);
            };

            document.body.appendChild(input);
            input.click();
        }

        // Show location photo browse dialog
        function showLocationPhotoBrowseDialog(collectionName, selectedLocation) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.style.display = 'none';

            input.onchange = function(event) {
                const file = event.target.files[0];
                if (file) {
                    uploadLocationPhoto(collectionName, selectedLocation, file);
                }
                document.body.removeChild(input);
            };

            document.body.appendChild(input);
            input.click();
        }

        // Upload location photo
        async function uploadLocationPhoto(collectionName, location, file) {
            try {
                const loadingModal = new bootstrap.Modal(document.getElementById('photoUploadLoadingModal'));
                loadingModal.show();
                document.getElementById('photoUploadProgress').textContent = 'Processing image...';

                const compressedBlob = await compressImage(file);
                if (!compressedBlob) {
                    loadingModal.hide();
                    alert('Failed to compress image');
                    return;
                }

                document.getElementById('photoUploadProgress').textContent = 'Uploading to storage...';

                const documentId = `${collectionName}_${location}`;
                const docRef = db.collection('locationPhotos').doc(documentId);
                const doc = await docRef.get();

                let currentPhotoUrls = [];
                if (doc.exists) {
                    currentPhotoUrls = doc.data().photoUrls || [];
                }

                const photoNumber = currentPhotoUrls.length + 1;
                const fileName = `${collectionName}_${location}_photo${photoNumber}.jpg`;

                const photoRef = storage.ref('Location_Photo/' + fileName);
                const uploadTask = photoRef.put(compressedBlob);

                uploadTask.on('state_changed',
                    (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        document.getElementById('photoUploadProgress').textContent = `Uploading... ${Math.round(progress)}%`;
                    },
                    (error) => {
                        console.error('Upload error:', error);
                        loadingModal.hide();
                        alert('Upload failed: ' + error.message);
                    },
                    async () => {
                        try {
                            document.getElementById('photoUploadProgress').textContent = 'Updating database...';

                            const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                            const newPhotoUrls = [...currentPhotoUrls, downloadURL];

                            await docRef.set({
                                collectionName: collectionName,
                                location: location,
                                photoUrls: newPhotoUrls,
                                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                            }, { merge: true });

                            loadingModal.hide();
                            alert('Location photo uploaded successfully!');

                            if (lastViewedCollectionName) {
                                showMyToolsByCollection(lastViewedCollectionName);
                            }

                        } catch (error) {
                            console.error('Error updating location photo:', error);
                            loadingModal.hide();
                            alert('Error updating location photo: ' + error.message);
                        }
                    }
                );

            } catch (error) {
                console.error('Location photo upload failed:', error);
                const loadingModal = bootstrap.Modal.getInstance(document.getElementById('photoUploadLoadingModal'));
                if (loadingModal) loadingModal.hide();
                alert('Upload failed: ' + error.message);
            }
        }
    </script>
</body>
</html>


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <!-- Deprecated: apple-mobile-web-app-capable is deprecated, but kept for backward compatibility -->
    <!-- <meta name="apple-mobile-web-app-capable" content="yes"> -->
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <title>Tool Tracking</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#FF9800">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <style>
        /* Reset body and html margins for full-width title bars */
        body, html {
            margin: 0;
            padding: 0;
        }
        
        /* Full-width title bar styles */
        .full-width-title-bar {
            width: 100vw !important;
            margin-left: calc(50% - 50vw) !important;
            margin-right: calc(50% - 50vw) !important;
            margin-top: 0 !important;
        }
        
        /* Splash Screen Styles */
        #splashScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #FF9800, #F57C00);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 0.5s ease-out;
        }
        
        #splashVideo {
            width: 100vw;
            height: 100vh;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
        }
        
        @media (min-width: 800px) {
          #splashVideo {
            max-width: 430px;
            max-height: 932px;
            width: auto;
            height: auto;
            object-fit: contain;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            border-radius: 24px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
          }
        }
        
        @media (min-width: 768px) and (max-width: 1024px) {
          #splashVideo {
            width: 100vw;
            height: 100vh;
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            left: 0;
            top: 0;
            transform: none;
            border-radius: 0;
          }
        }
        
        #splashContent {
            position: relative;
            z-index: 2;
            text-align: center;
            color: white;
            background: rgba(0, 0, 0, 0.3);
            padding: 2rem;
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }
        
        #splashLogo {
            width: 120px;
            height: 120px;
            margin-bottom: 1rem;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        #splashTitle {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        #splashSubtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-bottom: 1rem;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        
        #splashLoading {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .splash-hidden {
            opacity: 0 !important;
            pointer-events: none !important;
        }
        
        .tool-out { color: red; font-weight: bold; }
        .tool-in { color: green; }
        .hidden { display: none; }
        
        /* Orange Button Styles with Shadow Floating Effect */
        .btn-primary {
            background-color: #FF9800 !important;
            border-color: #FF9800 !important;
            color: white !important;
            font-weight: bold;
            border-radius: 24px !important;
            padding: 12px 24px !important;
            box-shadow: 0 4px 8px rgba(255, 152, 0, 0.3);
            transition: all 0.3s ease;
            border: none;
        }
        
        .btn-primary:hover {
            background-color: #F57C00 !important;
            border-color: #F57C00 !important;
            color: white !important;
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(255, 152, 0, 0.4);
        }
        
        .btn-primary:active {
            transform: translateY(-1px);
            box-shadow: 0 6px 12px rgba(255, 152, 0, 0.4);
        }
        
        .btn-warning {
            background-color: #FF9800 !important;
            border-color: #FF9800 !important;
            color: white !important;
            font-weight: bold;
            border-radius: 24px !important;
            padding: 12px 24px !important;
            box-shadow: 0 4px 8px rgba(255, 152, 0, 0.3);
            transition: all 0.3s ease;
            border: none;
        }
        
        .btn-warning:hover {
            background-color: #F57C00 !important;
            border-color: #F57C00 !important;
            color: white !important;
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(255, 152, 0, 0.4);
        }
        
        .btn-warning:active {
            transform: translateY(-1px);
            box-shadow: 0 6px 12px rgba(255, 152, 0, 0.4);
        }
        
        /* 3D Grey button styles for My Tools - darker than other buttons */
        #menuMyToolsBtn {
            background: linear-gradient(135deg, #9e9e9e 0%, #757575 100%) !important;
            border-color: #757575 !important;
            color: white !important;
            font-weight: bold;
            border-radius: 24px !important;
            padding: 12px 24px !important;
            box-shadow: 0 4px 8px rgba(117, 117, 117, 0.4),
                        inset 0 1px 0 rgba(255, 255, 255, 0.2),
                        inset 0 -1px 0 rgba(0, 0, 0, 0.2) !important;
            transition: all 0.3s ease;
            border: 2px solid #616161 !important;
            transform: perspective(1000px) rotateX(2deg);
        }
        
        #menuMyToolsBtn:hover {
            background: linear-gradient(135deg, #8e8e8e 0%, #616161 100%) !important;
            border-color: #616161 !important;
            color: white !important;
            transform: perspective(1000px) rotateX(0deg) translateY(-3px);
            box-shadow: 0 8px 16px rgba(117, 117, 117, 0.5),
                        inset 0 1px 0 rgba(255, 255, 255, 0.3),
                        inset 0 -1px 0 rgba(0, 0, 0, 0.3) !important;
        }
        
        #menuMyToolsBtn:active {
            transform: perspective(1000px) rotateX(2deg) translateY(-1px);
            box-shadow: 0 6px 12px rgba(117, 117, 117, 0.4),
                        inset 0 1px 0 rgba(255, 255, 255, 0.2),
                        inset 0 -1px 0 rgba(0, 0, 0, 0.2) !important;
        }
        
        /* Helicopter Model Selection Styles */
        .helicopter-model-option {
            transition: all 0.3s ease;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            margin-bottom: 8px;
        }
        
        .helicopter-model-option:hover {
            border-color: #FF9800;
            background-color: #fff3e0;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(255, 152, 0, 0.2);
        }
        
        .helicopter-model-option.active {
            border-color: #FF9800;
            background-color: #FF9800;
            color: white;
        }
        
        .helicopter-model-option.active small {
            color: rgba(255, 255, 255, 0.8) !important;
        }
        
        /* Work Location Option Styles */
        .work-location-option {
            transition: all 0.3s ease;
            border-radius: 8px;
            font-weight: 600;
        }
        
        .work-location-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
        }
        
        /* Form label styles */
        .form-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 0.5rem;
        }
        
        /* Forgot password link styles */
        #forgotPasswordLink {
            color: #FF9800;
            font-weight: 500;
            text-decoration: none;
            transition: color 0.3s ease;
        }
        
        #forgotPasswordLink:hover {
            color: #F57C00;
            text-decoration: underline;
        }
        
        /* ToolScanner Menu Button Styles with Shadow Floating Effect */
        .btn-success {
            background-color: #4CAF50 !important;
            border-color: #4CAF50 !important;
            color: white !important;
            font-weight: bold;
            border-radius: 24px !important;
            padding: 12px 24px !important;
            box-shadow: 0 4px 8px rgba(76, 175, 80, 0.3);
            transition: all 0.3s ease;
            border: none;
        }
        
        .btn-success:hover {
            background-color: #45a049 !important;
            border-color: #45a049 !important;
            color: white !important;
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(76, 175, 80, 0.4);
        }
        
        .btn-success:active {
            transform: translateY(-1px);
            box-shadow: 0 6px 12px rgba(76, 175, 80, 0.4);
        }
        
        .btn-danger {
            background-color: #f44336 !important;
            border-color: #f44336 !important;
            color: white !important;
            font-weight: bold;
            border-radius: 24px !important;
            padding: 12px 24px !important;
            box-shadow: 0 4px 8px rgba(244, 67, 54, 0.3);
            transition: all 0.3s ease;
            border: none;
        }
        
        .btn-danger:hover {
            background-color: #da190b !important;
            border-color: #da190b !important;
            color: white !important;
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(244, 67, 54, 0.4);
        }
        
        .btn-danger:active {
            transform: translateY(-1px);
            box-shadow: 0 6px 12px rgba(244, 67, 54, 0.4);
        }
        
        .btn-secondary {
            background-color: #6c757d !important;
            border-color: #6c757d !important;
            color: white !important;
            font-weight: bold;
            border-radius: 24px !important;
            padding: 12px 24px !important;
            box-shadow: 0 4px 8px rgba(108, 117, 125, 0.3);
            transition: all 0.3s ease;
            border: none;
        }
        
        .btn-secondary:hover {
            background-color: #5a6268 !important;
            border-color: #5a6268 !important;
            color: white !important;
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(108, 117, 125, 0.4);
        }
        
        .btn-secondary:active {
            transform: translateY(-1px);
            box-shadow: 0 6px 12px rgba(108, 117, 125, 0.4);
        }
        
        .btn-info {
            background-color: #17a2b8 !important;
            border-color: #17a2b8 !important;
            color: white !important;
            font-weight: bold;
            border-radius: 24px !important;
            padding: 12px 24px !important;
            box-shadow: 0 4px 8px rgba(23, 162, 184, 0.3);
            transition: all 0.3s ease;
            border: none;
        }
        
        .btn-info:hover {
            background-color: #17a2b8 !important;
            border-color: #17a2b8 !important;
            color: white !important;
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(23, 162, 184, 0.4);
        }
        
        .btn-info:active {
            transform: translateY(-1px);
            box-shadow: 0 6px 12px rgba(23, 162, 184, 0.4);
        }
        
        /* 3D Grey button styles for Tools by Work Location - darker than other buttons */
        #menuWorkLocationBtn {
            background: linear-gradient(135deg, #9e9e9e 0%, #757575 100%) !important;
            border-color: #757575 !important;
            color: white !important;
            font-weight: bold;
            border-radius: 24px !important;
            padding: 12px 24px !important;
            box-shadow: 0 4px 8px rgba(117, 117, 117, 0.4),
                        inset 0 1px 0 rgba(255, 255, 255, 0.2),
                        inset 0 -1px 0 rgba(0, 0, 0, 0.2) !important;
            transition: all 0.3s ease;
            border: 2px solid #616161 !important;
            transform: perspective(1000px) rotateX(2deg);
        }
        
        #menuWorkLocationBtn:hover {
            background: linear-gradient(135deg, #8e8e8e 0%, #616161 100%) !important;
            border-color: #616161 !important;
            color: white !important;
            transform: perspective(1000px) rotateX(0deg) translateY(-3px);
            box-shadow: 0 8px 16px rgba(117, 117, 117, 0.5),
                        inset 0 1px 0 rgba(255, 255, 255, 0.3),
                        inset 0 -1px 0 rgba(0, 0, 0, 0.3) !important;
        }
        
        #menuWorkLocationBtn:active {
            transform: perspective(1000px) rotateX(2deg) translateY(-1px);
            box-shadow: 0 6px 12px rgba(117, 117, 117, 0.4),
                        inset 0 1px 0 rgba(255, 255, 255, 0.2),
                        inset 0 -1px 0 rgba(0, 0, 0, 0.2) !important;
        }
        
        /* Larger text and icon for Logout button */
        #menuLogoutBtn {
            font-size: 1.2rem !important;
        }
        
        #menuLogoutBtn i {
            font-size: 1.3rem !important;
            margin-right: 8px;
        }
        
        /* Tablet styles for ToolScanner menu buttons */
        @media (min-width: 768px) and (max-width: 1024px) {
            /* Make button container wider on tablets */
            #toolScannerMenu .d-grid.col-6 {
                max-width: 85% !important;
                width: 85% !important;
                flex: 0 0 85% !important;
            }
            
            /* Increase font size and padding for all menu buttons */
            #toolScannerMenu .btn {
                font-size: 1.5rem !important;
                padding: 16px 32px !important;
                min-height: 60px !important;
            }
            
            /* Increase icon size */
            #toolScannerMenu .btn i {
                font-size: 1.3rem !important;
                margin-right: 8px !important;
            }
        }
        
        /* Google Sign-In Button Styles */
        .btn-outline-dark {
            background-color: white !important;
            border-color: #ddd !important;
            color: #333 !important;
            font-weight: 500;
            border-radius: 24px !important;
            padding: 12px 24px !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: 1px solid #ddd !important;
        }
        
        .btn-outline-dark:hover {
            background-color: #f8f9fa !important;
            border-color: #ccc !important;
            color: #333 !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .btn-outline-dark:active {
            transform: translateY(-1px);
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
        }
        
        .camera-view {
            width: 100%;
            max-width: 320px;
            margin: 10px auto;
        }
        #reader {
            border: 1px solid #ccc !important;
            width: 100% !important;
            max-width: 320px;
            aspect-ratio: 1/1 !important; /* Make the reader square */
            overflow: hidden !important;
        }
        #reader video {
            object-fit: cover !important;
            width: 100% !important;
            height: 100% !important;
        }
        .tool-item {
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 8px;
            transition: background-color 0.3s ease;
        }
        .tool-item:hover {
            background-color: #f8f9fa;
        }
        .tool-out-even {
            background-color: #FFF3E0; /* Very light orange */
        }
        .tool-out-odd {
            background-color: #FFE0B2; /* Light orange */
        }
        .tool-in-even {
            background-color: #E8F5E9; /* Very light green */
        }
        .tool-in-odd {
            background-color: #A5D6A7; /* Light green */
        }
        .nav-tabs {
            margin-bottom: 20px;
        }
        
        /* Larger tab titles with 3D interactive display */
        .nav-tabs .nav-link {
            font-size: 1.2rem !important;
            font-weight: 600 !important;
            padding: 12px 20px !important;
            border-radius: 12px 12px 0 0 !important;
            transition: all 0.3s ease !important;
            border: 2px solid transparent !important;
            background: linear-gradient(135deg, #e0e0e0 0%, #bdbdbd 100%) !important;
            color: #666 !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
            transform: perspective(1000px) rotateX(0deg) !important;
        }
        
        .nav-tabs .nav-link:hover:not(.active) {
            background: linear-gradient(135deg, #d0d0d0 0%, #a0a0a0 100%) !important;
            transform: translateY(-2px) perspective(1000px) rotateX(3deg) !important;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15) !important;
            color: #333 !important;
        }
        
        .nav-tabs .nav-link.active {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%) !important;
            color: white !important;
            border-color: #FF9800 !important;
            box-shadow: 0 4px 12px rgba(255, 152, 0, 0.4), 
                        0 2px 4px rgba(0, 0, 0, 0.2) !important;
            transform: translateY(-2px) perspective(1000px) rotateX(5deg) !important;
        }
        
        .nav-tabs .nav-link.active:hover {
            transform: translateY(-3px) perspective(1000px) rotateX(8deg) !important;
            box-shadow: 0 6px 16px rgba(255, 152, 0, 0.5), 
                        0 4px 8px rgba(0, 0, 0, 0.3) !important;
        }
        
        .nav-tabs .nav-link:active:not(.active) {
            transform: translateY(0) perspective(1000px) rotateX(0deg) !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
        }
        
        .nav-tabs .nav-link:active.active {
            transform: translateY(-1px) perspective(1000px) rotateX(3deg) !important;
            box-shadow: 0 4px 10px rgba(255, 152, 0, 0.4), 
                        0 2px 4px rgba(0, 0, 0, 0.2) !important;
        }
        
        /* Smaller tab text on phone screens */
        @media (max-width: 600px) {
            #registerToolsTabs .nav-link {
                font-size: 0.9rem !important;
                padding: 8px 12px !important;
            }
        }
        
        /* Search type buttons styling */
        .search-type-btn {
            flex: 1;
            padding: 12px 20px;
            font-size: 1rem;
            font-weight: bold;
            border-radius: 12px;
            border: 2px solid #2196F3;
            background-color: #2196F3;
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(33, 150, 243, 0.3);
        }
        
        .search-type-btn:not(.active) {
            background: linear-gradient(135deg, #9e9e9e 0%, #757575 100%);
            border-color: #757575;
            color: white;
            box-shadow: 0 2px 4px rgba(117, 117, 117, 0.3);
            transform: perspective(1000px) rotateX(0deg);
        }
        
        .search-type-btn.active {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
            border-color: #FF9800;
            color: white;
            box-shadow: 0 4px 12px rgba(255, 152, 0, 0.4), 
                        0 2px 4px rgba(0, 0, 0, 0.2);
            transform: translateY(-2px) perspective(1000px) rotateX(5deg);
        }
        
        .search-type-btn:hover:not(.active) {
            background: linear-gradient(135deg, #8e8e8e 0%, #656565 100%);
            border-color: #656565;
            transform: translateY(-1px) perspective(1000px) rotateX(3deg);
            box-shadow: 0 3px 6px rgba(117, 117, 117, 0.4);
        }
        
        .search-type-btn:hover.active {
            transform: translateY(-3px) perspective(1000px) rotateX(8deg);
            box-shadow: 0 6px 16px rgba(255, 152, 0, 0.5), 
                        0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .search-type-btn:active:not(.active) {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(33, 150, 243, 0.3);
        }
        
        .search-type-btn:active.active {
            transform: translateY(-1px) perspective(1000px) rotateX(3deg);
            box-shadow: 0 4px 10px rgba(255, 152, 0, 0.4), 
                        0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        /* Search dropdown list styling */
        .search-dropdown-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            margin-top: 4px;
        }
        
        .search-dropdown-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s ease;
        }
        
        .search-dropdown-item:hover {
            background-color: #f5f5f5;
        }
        
        .search-dropdown-item:last-child {
            border-bottom: none;
        }
        
        .search-dropdown-item.selected {
            background-color: #e3f2fd;
        }
        
        .search-dropdown-item .tool-name {
            font-weight: 600;
            color: #333;
            font-size: 1rem;
        }
        
        .search-dropdown-item .tool-part {
            font-size: 0.9rem;
            margin-top: 4px;
        }
        
        .search-dropdown-item .tool-part .label {
            color: #0000FF;
            font-weight: bold;
        }
        
        .search-dropdown-item .tool-part .value {
            color: #87CEEB;
            font-weight: bold;
        }
        
        .search-dropdown-item .tool-collection {
            font-size: 0.85rem;
            margin-top: 2px;
        }
        
        .search-dropdown-item .tool-collection .label {
            color: #0000FF;
            font-weight: bold;
        }
        
        .search-dropdown-item .tool-collection .value {
            color: #87CEEB;
            font-weight: bold;
        }
        
        .search-dropdown-item .tool-owner {
            font-size: 0.85rem;
            margin-top: 2px;
        }
        
        .search-dropdown-item .tool-owner .label {
            color: #0000FF;
            font-weight: bold;
        }
        
        .search-dropdown-item .tool-owner .value {
            color: #87CEEB;
            font-weight: bold;
        }
        
        .highlight-match {
            background-color: #FFD700;
            color: #333;
            font-weight: bold;
            padding: 2px 0;
        }
        
        #scannerView {
            text-align: center;
        }
        .btn-scan {
            margin: 4px 0;
            padding: 8px 12px;
            font-size: 0.85rem;
            font-weight: bold;
            border-radius: 12px;
            border: 2px solid;
            transition: all 0.3s ease;
            flex: 1;
        }
        
        /* Scanner button inactive (gray 3D) */
        .btn-scan:not(.active) {
            background: linear-gradient(135deg, #9e9e9e 0%, #757575 100%);
            border-color: #757575;
            color: white;
            box-shadow: 0 2px 4px rgba(117, 117, 117, 0.3);
            transform: perspective(1000px) rotateX(0deg);
        }
        
        /* Scanner button active (orange 3D) */
        .btn-scan.active {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
            border-color: #FF9800;
            color: white;
            box-shadow: 0 4px 12px rgba(255, 152, 0, 0.4), 
                        0 2px 4px rgba(0, 0, 0, 0.2);
            transform: translateY(-2px) perspective(1000px) rotateX(5deg);
        }
        
        .btn-scan:hover:not(.active) {
            background: linear-gradient(135deg, #8e8e8e 0%, #656565 100%);
            border-color: #656565;
            transform: translateY(-1px) perspective(1000px) rotateX(3deg);
            box-shadow: 0 3px 6px rgba(117, 117, 117, 0.4);
        }
        
        .btn-scan:hover.active {
            transform: translateY(-3px) perspective(1000px) rotateX(8deg);
            box-shadow: 0 6px 16px rgba(255, 152, 0, 0.5), 
                        0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .btn-scan:active:not(.active) {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(117, 117, 117, 0.3);
        }
        
        .btn-scan:active.active {
            transform: translateY(-1px) perspective(1000px) rotateX(3deg);
            box-shadow: 0 4px 10px rgba(255, 152, 0, 0.4), 
                        0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        /* Back to Menu button 3D interactive Grey */
        #backToMenuBtn {
            position: absolute;
            right: 18px;
            top: 50%;
            transform: translateY(-50%) perspective(1000px) rotateX(0deg);
            z-index: 10;
            padding: 6px 12px;
            font-size: 0.9rem;
            font-weight: bold;
            border-radius: 12px;
            border: 2px solid #bdbdbd;
            background: linear-gradient(135deg, #e0e0e0 0%, #bdbdbd 100%);
            color: #333;
            text-decoration: none;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(189, 189, 189, 0.3);
            cursor: pointer;
            white-space: nowrap;
        }
        
        #backToMenuBtn:hover {
            background: linear-gradient(135deg, #d0d0d0 0%, #adadad 100%);
            border-color: #adadad;
            transform: translateY(calc(-50% - 2px)) perspective(1000px) rotateX(5deg);
            box-shadow: 0 4px 12px rgba(189, 189, 189, 0.4),
                        0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        #backToMenuBtn:active {
            transform: translateY(calc(-50% + 0px)) perspective(1000px) rotateX(2deg);
            box-shadow: 0 2px 4px rgba(189, 189, 189, 0.3);
        }
        
        /* Change Station button 3D interactive */
        #changeWorkLocationBtn {
            background: linear-gradient(135deg, #e0e0e0 0%, #bdbdbd 100%) !important;
            border: 2px solid #bdbdbd !important;
            color: #333 !important;
            border-radius: 12px !important;
            padding: 6px 8px !important;
            font-size: 0.9rem !important;
            font-weight: bold !important;
            box-shadow: 0 2px 4px rgba(189, 189, 189, 0.3) !important;
            transform: perspective(1000px) rotateX(0deg) !important;
            transition: all 0.3s ease !important;
            white-space: nowrap !important;
        }
        
        #changeWorkLocationBtn:hover {
            background: linear-gradient(135deg, #d0d0d0 0%, #adadad 100%) !important;
            border-color: #adadad !important;
            transform: translateY(-2px) perspective(1000px) rotateX(5deg) !important;
            box-shadow: 0 4px 12px rgba(189, 189, 189, 0.4),
                        0 2px 4px rgba(0, 0, 0, 0.2) !important;
        }
        
        #changeWorkLocationBtn:active {
            transform: translateY(0) perspective(1000px) rotateX(2deg) !important;
            box-shadow: 0 2px 4px rgba(189, 189, 189, 0.3) !important;
        }
        
        /* 3D Status Dot */
        .status-dot {
            display: inline-block;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            box-shadow: 
                0 2px 4px rgba(76, 175, 80, 0.4),
                0 0 0 2px rgba(76, 175, 80, 0.2),
                inset 0 -2px 4px rgba(0, 0, 0, 0.2),
                inset 0 2px 2px rgba(255, 255, 255, 0.3);
            position: relative;
            transition: all 0.3s ease;
        }
        
        .status-dot::before {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 5px;
            height: 5px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.6);
            box-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
        }
        
        .status-dot.offline {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            box-shadow: 
                0 2px 4px rgba(244, 67, 54, 0.4),
                0 0 0 2px rgba(244, 67, 54, 0.2),
                inset 0 -2px 4px rgba(0, 0, 0, 0.2),
                inset 0 2px 2px rgba(255, 255, 255, 0.3);
        }
        
        .status-badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 18px;
        }
        .status-out {
            background-color: #ffebee;
            color: #d32f2f;
        }
        .status-in {
            background-color: #e8f5e9;
            color: #388E3C;
        }
        .status-broken {
            background-color: #fff3e0;
            color: #ff6f00;
        }
        .status-lost {
            background-color: #ffe0b2;
            color: #ff8f00;
        }
        .status-calibration {
            background-color: #e3f2fd;
            color: #1976d2;
        }
        .tool-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            text-decoration: underline;
        }
        .tool-name {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 5px;
            padding-left: 15px;
            text-align: left;
        }
        .tool-time {
            font-size: 16px;
            color: #666;
            margin-bottom: 10px;
            padding-left: 15px;
            text-align: left;
        }
        .tool-headers {
            color: #388E3C;
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 5px;
        }
        .tool-values {
            font-size: 16px;
        }
        .tool-out-text {
            color: #d32f2f;
        }
        .tool-in-text {
            color: #000;
        }
        .tool-id-value {
            font-weight: bold;
        }
        .tool-pn-value {
            font-weight: bold;
        }
        .mytools-title {
            color: orange; font-weight: bold; font-size: 2.2rem; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 0.5rem;
        }
        .mytools-back {
            background: orange; color: white; font-weight: bold; border: none; border-radius: 6px; padding: 8px 24px; font-size: 1.2rem; margin-bottom: 1rem;
        }
        .mytools-collection {
            background: orange; color: white; font-weight: bold; font-size: 1.2rem; border-radius: 6px 6px 0 0; padding: 6px 12px; display: flex; justify-content: space-between; align-items: center; margin-top: 1.5rem;
        }
        .mytools-location {
            background: #cbe7ff; color: #222; font-weight: bold; font-size: 1.1rem; border-radius: 0 0 6px 6px; padding: 6px 12px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;
        }
        .mytools-tool-item {
            padding: 12px 12px 8px 12px; border-radius: 0 0 6px 6px; margin-bottom: 0.5rem; font-size: 1.08rem;
        }
        .mytools-tool-bg1 { background: #fff; }
        .mytools-tool-bg2 { background: #fff7e6; }
        .mytools-tool-name { font-weight: bold; font-size: 1.13rem; display: block !important; margin-bottom: 4px !important; width: 100% !important; clear: both !important; }
        .mytools-tool-tid { font-weight: bold; display: block !important; margin-bottom: 4px !important; width: 100% !important; clear: both !important; }
        .mytools-tool-part { font-size: 1.01rem; color: #444; }
        .mytools-status-in { color: #388E3C; font-weight: bold; font-size: 1.05rem; }
        .mytools-status-out { color: #d32f2f; font-weight: bold; font-size: 1.05rem; }
        .mytools-status-broken { color: #ff6f00; font-weight: bold; font-size: 1.05rem; }
        .mytools-status-lost { color: #ff8f00; font-weight: bold; font-size: 1.05rem; }
        .mytools-status-calibration { color: #1976d2; font-weight: bold; font-size: 1.05rem; }
        .mytools-tool-extra { font-size: 1.01rem; color: #222; margin-top: 2px; }
        .mytools-tool-cal { color: #388E3C; font-size: 1.01rem; margin-top: 2px; }
        .ams-title {
            color: orange;
            font-weight: bold;
            font-size: 2rem;
            text-align: center;
            margin-bottom: 0.3rem;
            letter-spacing: 2px;
            text-transform: uppercase;
        }
        .ams-logo {
            display: block;
            margin: 0.5rem auto 1.2rem auto;
            max-width: 180px;
            height: auto;
        }
        .ams-subtitle {
            color: #00bfff;
            font-weight: bold;
            font-size: 1.5rem;
            text-align: center;
            margin-bottom: 0.1rem;
            letter-spacing: 1px;
        }
        .auth-container {
            margin-top: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1rem 1rem 0 1rem;
        }
        .auth-card {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
        }
        .technician-name {
            color: #00bfff;
            font-weight: bold;
        }
        
        /* Previous OUT Tools Card Styles - matching Android ToolCard */
        .previous-out-tool-card {
            background: #FFCDD2; /* Light red for OUT status */
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: background-color 0.3s ease;
            width: 100%;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }
        
        /* Responsive previous-out-tool-card widths */
        @media (min-width: 576px) {
            .previous-out-tool-card {
                max-width: 550px;
            }
        }
        
        @media (min-width: 768px) {
            .previous-out-tool-card {
                max-width: 600px;
            }
        }
        
        @media (min-width: 992px) {
            .previous-out-tool-card {
                max-width: 700px;
            }
        }
        
        @media (min-width: 1200px) {
            .previous-out-tool-card {
                max-width: 800px;
            }
        }
        
        .previous-out-tool-card:hover {
            background: #FFB3BA; /* Slightly darker red on hover */
        }
        
        .previous-out-tool-name {
            font-weight: bold;
            font-size: 16px;
            color: #000;
            margin-bottom: 4px;
        }
        
        .previous-out-tool-date {
            font-size: 12px;
            color: #666;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .previous-out-tool-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .previous-out-tool-column {
            flex: 1;
            text-align: center;
        }
        
        .previous-out-tool-column:first-child {
            text-align: left;
        }

        /* Work Location Tool Card Styles */
        .workloc-collection-header {
            background: #FF9800;
            color: white;
            font-weight: bold;
            font-size: 1.3rem;
            border-radius: 6px 6px 0 0;
            padding: 10px 16px;
            margin-top: 1.5rem;
        }

        .workloc-tool-card {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }
        
        /* Responsive workloc-tool-card widths */
        @media (min-width: 576px) {
            .workloc-tool-card {
                max-width: 550px;
            }
        }
        
        @media (min-width: 768px) {
            .workloc-tool-card {
                max-width: 600px;
            }
        }
        
        @media (min-width: 992px) {
            .workloc-tool-card {
                max-width: 700px;
            }
        }
        
        @media (min-width: 1200px) {
            .workloc-tool-card {
                max-width: 800px;
            }
        }

        .workloc-tool-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .workloc-tool-card.out {
            background: #FFCDD2;
            border-color: #EF9A9A;
        }

        .workloc-tool-card.in {
            background: #E8F5E9;
            border-color: #A5D6A7;
        }

        .workloc-tool-name {
            font-weight: bold;
            font-size: 1.2rem;
            color: #000;
            margin-bottom: 8px;
        }

        .workloc-tool-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 1rem;
        }

        .workloc-tool-label {
            font-weight: bold;
            color: #333;
        }

        .workloc-tool-value {
            color: #666;
            font-weight: 500;
        }

        .workloc-status-out {
            color: #d32f2f;
            font-weight: bold;
        }

        .workloc-status-in {
            color: #388E3C;
            font-weight: bold;
        }

        /* Filter date button styles */
        .filter-date-btn.active {
            background-color: #dc3545 !important;
            border-color: #dc3545 !important;
            color: white !important;
        }
        
        .previous-out-tool-column:last-child {
            text-align: right;
        }
        
        .previous-out-tool-label {
            color: #000;
            font-weight: bold;
            font-size: 14px;
            text-decoration: underline;
            margin-bottom: 4px;
        }
        
        .previous-out-tool-value {
            color: #666;
            font-weight: bold;
            font-size: 12px;
        }
        
        .previous-out-tool-status {
            color: #fff;
            font-weight: bold;
            font-size: 14px;
            background: rgba(229, 115, 115, 0.8); /* Red background for OUT status */
            border-radius: 16px;
            padding: 4px 12px;
            display: inline-block;
        }
        
        /* Status colors for different tool statuses */
        .previous-out-tool-card.broken {
            background: #FFF3E0; /* Light orange for BROKEN */
        }
        
        .previous-out-tool-card.broken:hover {
            background: #FFE0B2;
        }
        
        .previous-out-tool-card.broken .previous-out-tool-status {
            background: rgba(255, 152, 0, 0.8); /* Orange background */
        }
        
        .previous-out-tool-card.lost {
            background: #FFE0B2; /* Light amber for LOST */
        }
        
        .previous-out-tool-card.lost:hover {
            background: #FFCC80;
        }
        
        .previous-out-tool-card.lost .previous-out-tool-status {
            background: rgba(255, 179, 0, 0.8); /* Amber background */
        }
        
        .previous-out-tool-card.calibration {
            background: #E3F2FD; /* Light blue for CALIBRATION */
        }
        
        .previous-out-tool-card.calibration:hover {
            background: #BBDEFB;
        }
        
        .previous-out-tool-card.calibration .previous-out-tool-status {
            background: rgba(33, 150, 243, 0.8); /* Blue background */
        }
        
        .previous-out-tool-card.in {
            background: #E8F5E9; /* Light green for IN */
        }
        
        .previous-out-tool-card.in:hover {
            background: #C8E6C9;
        }
        
        .previous-out-tool-card.in .previous-out-tool-status {
            background: rgba(76, 175, 80, 0.8); /* Green background */
        }

        .register-tool-card {
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
            cursor: pointer;
            transition: background-color 0.3s ease;
            width: 100%;
            max-width: 380px;
            margin-left: auto;
            margin-right: auto;
        }
        
        /* Responsive card widths */
        @media (min-width: 576px) {
            .register-tool-card {
                max-width: 450px;
            }
        }
        
        @media (min-width: 768px) {
            .register-tool-card {
                max-width: 500px;
            }
        }
        
        @media (min-width: 992px) {
            .register-tool-card {
                max-width: 600px;
            }
        }
        
        @media (min-width: 1200px) {
            .register-tool-card {
                max-width: 700px;
            }
        }
        
        /* Reduce spacing between elements in register tool cards */
        #toolList .register-tool-card > div,
        #collectionDisplaySection .register-tool-card > div,
        #searchResults .register-tool-card > div {
            line-height: 1.2 !important;
        }
        .register-tool-card.out { background: #FFCDD2; }
        .register-tool-card.broken { background: #FFF3E0; }
        .register-tool-card.lost { background: #FFE0B2; }
        .register-tool-card.calibration { background: #E3F2FD; }
        .register-tool-card.in { background: #E8F5E9; }
        
        /* Search Tools Card Styles - matching My Tools alternating colors and floating effect */
        .search-tool-bg1 { background: #fff; }
        .search-tool-bg2 { background: #fff7e6; }
        
        .search-tool-card {
            transition: box-shadow 0.3s ease, transform 0.3s ease;
            width: 100%;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }
        
        /* Responsive search tool card widths */
        @media (min-width: 576px) {
            .search-tool-card {
                max-width: 550px;
            }
        }
        
        @media (min-width: 768px) {
            .search-tool-card {
                max-width: 600px;
            }
        }
        
        @media (min-width: 992px) {
            .search-tool-card {
                max-width: 700px;
            }
        }
        
        @media (min-width: 1200px) {
            .search-tool-card {
                max-width: 800px;
            }
        }
        
        .search-tool-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        
        /* Search Tools Status-based Background Colors */
        .search-tool-card.out { background: #FFCDD2; }
        .search-tool-card.in { background: #E8F5E9; }
        
        /* Location Selection Modal Styles */
        .location-option {
            font-size: 16px;
            font-weight: 500;
            padding: 12px 16px;
            border: 1px solid #dee2e6;
            transition: all 0.3s ease;
        }
        
        .location-option:hover {
            background-color: #f8f9fa;
            border-color: #007bff;
            transform: translateY(-1px);
        }
        
        .location-option.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }
        
        .register-tool-title {
            font-weight: bold;
            font-size: 18px;
            color: #000;
            margin-bottom: 2px;
            text-align: left;
            line-height: 1.2;
        }
        .register-tool-date {
            font-size: 14px;
            color: #666;
            font-weight: bold;
            margin-bottom: 4px;
            text-align: left;
            display: flex;
            align-items: center;
            justify-content: space-between;
            line-height: 1.2;
        }
        .register-tool-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        .register-tool-col {
            flex: 1;
            text-align: center;
        }
        .register-tool-col:first-child { text-align: left; }
        .register-tool-col:last-child { text-align: right; }
        .register-tool-label {
            color: #000;
            font-weight: bold;
            font-size: 14px;
            text-decoration: underline;
            margin-bottom: 2px;
            line-height: 1.2;
        }
        .register-tool-value {
            color: #666;
            font-weight: bold;
            font-size: 14px;
            line-height: 1.2;
        }
        .register-tool-status {
            color: #fff;
            font-weight: bold;
            font-size: 14px;
            border-radius: 16px;
            padding: 4px 12px;
            display: inline-block;
        }
        .register-tool-status.out { background: rgba(229, 115, 115, 0.8); }
        .register-tool-status.broken { background: rgba(255, 152, 0, 0.8); }
        .register-tool-status.lost { background: rgba(255, 179, 0, 0.8); }
        .register-tool-status.calibration { background: rgba(33, 150, 243, 0.8); }
        .register-tool-status.in { background: rgba(76, 175, 80, 0.8); }
        
        /* Scanner and Search Tools Card Border */
        #scannerView .card,
        #searchToolsView .card {
            border: 4px solid #FF9800 !important;
            border-radius: 12px !important;
            box-shadow: 0 6px 16px rgba(128, 128, 128, 0.5),
                        0 2px 8px rgba(0, 0, 0, 0.2) !important;
        }
        
        /* Tool Details Button - Light Grey 3D Interactive */
        #toolDetailsBtn {
            background: linear-gradient(135deg, #e0e0e0 0%, #bdbdbd 100%) !important;
            border: 2px solid #bdbdbd !important;
            color: #333 !important;
            border-radius: 12px !important;
            padding: 10px 16px !important;
            font-weight: bold !important;
            box-shadow: 0 2px 4px rgba(189, 189, 189, 0.3) !important;
            transform: perspective(1000px) rotateX(0deg) !important;
            transition: all 0.3s ease !important;
        }
        
        #toolDetailsBtn:not(:disabled):hover {
            background: linear-gradient(135deg, #d0d0d0 0%, #adadad 100%) !important;
            border-color: #adadad !important;
            transform: translateY(-2px) perspective(1000px) rotateX(5deg) !important;
            box-shadow: 0 4px 12px rgba(189, 189, 189, 0.4),
                        0 2px 4px rgba(0, 0, 0, 0.2) !important;
        }
        
        #toolDetailsBtn:not(:disabled):active {
            transform: translateY(0) perspective(1000px) rotateX(2deg) !important;
            box-shadow: 0 2px 4px rgba(189, 189, 189, 0.3) !important;
        }
        
        #toolDetailsBtn:disabled {
            background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%) !important;
            border-color: #e0e0e0 !important;
            color: #999 !important;
            cursor: not-allowed !important;
            opacity: 0.6 !important;
        }
        
        /* Tool Code Input Field - Darker and Wider Border */
        #toolCode {
            border: 3px solid #333 !important;
            border-radius: 8px !important;
        }
        
        #toolCode:focus {
            border-color: #FF9800 !important;
            box-shadow: 0 0 0 0.2rem rgba(255, 152, 0, 0.25) !important;
        }
        
        /* Submit Button - 3D Green Checkmark */
        .submit-check-btn {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%) !important;
            border: 2px solid #4CAF50 !important;
            color: white !important;
            border-radius: 12px !important;
            padding: 8px 16px !important;
            font-size: 1.2rem !important;
            font-weight: bold !important;
            box-shadow: 0 2px 4px rgba(76, 175, 80, 0.3) !important;
            transform: perspective(1000px) rotateX(0deg) !important;
            transition: all 0.3s ease !important;
        }
        
        .submit-check-btn:hover {
            background: linear-gradient(135deg, #66BB6A 0%, #4CAF50 100%) !important;
            border-color: #66BB6A !important;
            transform: translateY(-2px) perspective(1000px) rotateX(5deg) !important;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4),
                        0 2px 4px rgba(0, 0, 0, 0.2) !important;
        }
        
        .submit-check-btn:active {
            transform: translateY(0) perspective(1000px) rotateX(2deg) !important;
            box-shadow: 0 2px 4px rgba(76, 175, 80, 0.3) !important;
        }
        
        /* Analytics Button - 3D Interactive Grey */
        .btn-analytics {
            background: linear-gradient(135deg, #e0e0e0 0%, #bdbdbd 100%) !important;
            border: 2px solid #bdbdbd !important;
            color: #333 !important;
            border-radius: 12px !important;
            padding: 6px 12px !important;
            font-size: 0.9rem !important;
            font-weight: bold !important;
            box-shadow: 0 2px 4px rgba(189, 189, 189, 0.3) !important;
            transform: perspective(1000px) rotateX(0deg) !important;
            transition: all 0.3s ease !important;
            cursor: pointer !important;
        }
        
        .btn-analytics:hover {
            background: linear-gradient(135deg, #d0d0d0 0%, #adadad 100%) !important;
            border-color: #adadad !important;
            transform: translateY(-2px) perspective(1000px) rotateX(5deg) !important;
            box-shadow: 0 4px 12px rgba(189, 189, 189, 0.4),
                        0 2px 4px rgba(0, 0, 0, 0.2) !important;
        }
        
        .btn-analytics:active {
            transform: translateY(0) perspective(1000px) rotateX(2deg) !important;
            box-shadow: 0 2px 4px rgba(189, 189, 189, 0.3) !important;
        }
        
        /* Scanner expansion styles */
        .scanner-container {
            transition: all 0.3s ease;
        }
        
        .scanner-container.expanded {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 9999;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .scanner-container.expanded .card {
            max-width: 90vw;
            max-height: 90vh;
            width: 100%;
        }
        
        .scanner-container.expanded #reader {
            width: 100% !important;
            max-width: 500px !important;
            height: auto !important;
            aspect-ratio: 1/1 !important;
        }
        
        .scanner-container.expanded #reader video {
            width: 100% !important;
            height: 100% !important;
            object-fit: cover !important;
        }
        
        .scanner-overlay {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 10000;
        }

        /* Enhanced Scanner Styles */
        .enhanced-scanner-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .scanner-video-container {
            position: relative;
            width: 100%;
            aspect-ratio: 1/1;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
        }

        .scanner-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Scan Area Overlay */
        .scan-area-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 10;
        }

        .scan-area-mask {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
        }

        .scan-area-hole {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            background: transparent;
            border: 2px solid rgba(255, 255, 255, 0.8);
            border-radius: 12px;
        }

        .scan-area-corners {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
        }

        .scan-corner {
            position: absolute;
            width: 30px;
            height: 30px;
            border: 3px solid #fff;
        }

        .scan-corner.top-left {
            top: -3px;
            left: -3px;
            border-right: none;
            border-bottom: none;
            border-top-left-radius: 8px;
        }

        .scan-corner.top-right {
            top: -3px;
            right: -3px;
            border-left: none;
            border-bottom: none;
            border-top-right-radius: 8px;
        }

        .scan-corner.bottom-left {
            bottom: -3px;
            left: -3px;
            border-right: none;
            border-top: none;
            border-bottom-left-radius: 8px;
        }

        .scan-corner.bottom-right {
            bottom: -3px;
            right: -3px;
            border-left: none;
            border-top: none;
            border-bottom-right-radius: 8px;
        }

        /* Scanner Controls */
        .scanner-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 12px;
            align-items: center;
            background: rgba(0, 0, 0, 0.7);
            padding: 12px 20px;
            border-radius: 25px;
            backdrop-filter: blur(10px);
        }

        .scanner-control-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 18px;
        }

        .scanner-control-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .scanner-control-btn.active {
            background: #FF9800;
            color: white;
        }

        .zoom-level {
            color: white;
            font-weight: bold;
            font-size: 14px;
            min-width: 40px;
            text-align: center;
        }

        /* Top Controls */
        .scanner-top-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 8px;
            z-index: 15;
        }

        .torch-btn {
            background: rgba(0, 0, 0, 0.7);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 18px;
            backdrop-filter: blur(10px);
        }

        .torch-btn:hover {
            background: rgba(0, 0, 0, 0.8);
            transform: scale(1.1);
        }

        .torch-btn.active {
            background: #FFD700;
            color: #000;
        }

        /* Instructions */
        .scanner-instructions {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            text-align: center;
            backdrop-filter: blur(10px);
            z-index: 15;
        }

        /* Focus Indicator */
        .focus-indicator {
            position: absolute;
            width: 50px;
            height: 50px;
            border: 2px solid #2196F3;
            border-radius: 50%;
            background: rgba(33, 150, 243, 0.2);
            pointer-events: none;
            z-index: 20;
            animation: focusPulse 2s ease-out;
        }

        @keyframes focusPulse {
            0% {
                transform: scale(0.8);
                opacity: 1;
            }
            100% {
                transform: scale(1.2);
                opacity: 0;
            }
        }

        /* Work Location Flash Animation */
        @keyframes workLocationFlash {
            0%, 100% {
                background-color: transparent;
            }
            50% {
                background-color: red;
            }
        }

        @keyframes workLocationTextFlash {
            0%, 100% {
                color: black;
            }
            50% {
                color: white;
            }
        }

        .work-location-label-flashing {
            animation: workLocationFlash 0.6s ease-in-out infinite, 
                       workLocationTextFlash 0.6s ease-in-out infinite;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .work-location-value-flashing {
            animation: workLocationFlash 0.6s ease-in-out infinite;
            padding: 4px 8px;
            border-radius: 4px;
            color: white !important;
        }

        /* Enhanced Scanner Modal */
        .enhanced-scanner-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .enhanced-scanner-content {
            background: #1a1a1a;
            border-radius: 16px;
            padding: 20px;
            max-width: 90vw;
            max-height: 90vh;
            width: 100%;
            position: relative;
        }

        .enhanced-scanner-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            color: white;
        }

        .enhanced-scanner-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
        }

        .enhanced-scanner-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 18px;
        }

        .enhanced-scanner-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        @media (max-width: 600px) {
            .d-grid.col-6.mx-auto {
                max-width: 100% !important;
                width: 100% !important;
            }
            .d-grid.col-6.mx-auto button {
                width: 100% !important;
                min-width: 100% !important;
                font-size: 1.2em;
                padding: 18px 0 !important;
            }
            
            /* Mobile-specific modal styling */
            .modal-dialog {
                margin: 10px;
                max-width: calc(100% - 20px);
            }
            
            .modal-body {
                font-size: 1.1em;
                line-height: 1.5;
            }
            
            .modal-title {
                font-size: 1.3em;
            }
            
            .modal-footer .btn {
                font-size: 1.1em;
                padding: 10px 20px;
            }
        }
        
        /* Ensure consistent font sizes across all devices */
        .modal-body div[style*="font-size: 1.1em"] {
            line-height: 1.6;
            margin-bottom: 12px;
        }
        
        .modal-body strong {
            font-weight: 600;
            color: #333;
        }
        
        /* Ensure strong tags remain bold on mobile devices */
        @media (max-width: 600px) {
            .modal-body strong {
                font-weight: 600 !important;
                color: #333 !important;
            }
            
            .modal-body div strong {
                font-weight: 600 !important;
            }
        }

        /* Add CSS for orange overlay */
        #orangeOverlay {
          position: fixed;
          top: 0; left: 0; right: 0; bottom: 0;
          width: 100vw; height: 100vh;
          background: #FF9800;
          z-index: 10000;
          transition: opacity 0.3s;
        }
        #orangeOverlay.hidden {
          opacity: 0;
          pointer-events: none;
        }

        /* Custom modal styles for mobile app look */
        .modal-dialog-centered {
          display: flex;
          align-items: center;
          min-height: calc(100% - 1rem);
        }

        .modal-content {
          border: none !important;
          box-shadow: 0 10px 30px rgba(0,0,0,0.3) !important;
        }

        .helicopter-model-option:hover,
        .work-location-option:hover {
          transform: scale(1.02) !important;
          transition: all 0.3s ease !important;
        }

        .helicopter-model-option.active,
        .work-location-option.active {
          background: #FF9800 !important;
          border-color: #FF9800 !important;
          color: white !important;
          transform: scale(1.02) !important;
        }

        /* Mobile-specific modal adjustments */
        @media (max-width: 768px) {
          .modal-dialog {
            margin: 1rem;
            max-width: calc(100% - 2rem);
          }
          
          .modal-body {
            padding: 1.5rem !important;
          }
          
          .helicopter-model-option,
          .work-location-option {
            font-size: 1rem !important;
            padding: 1rem !important;
          }
          
          /* Smaller Work Location font on mobile */
          #workLocationLabel {
            font-size: 1.6rem !important;
          }
          #workLocationValue {
            font-size: 1.6rem !important;
          }
        }

        /* Medium fonts for tool cards on tablets (between mobile and desktop) */
        @media (min-width: 769px) and (max-width: 1024px) {
          #collectionDisplaySection .register-tool-card *,
          #searchResults .register-tool-card *,
          #toolList .register-tool-card *,
          #previousOutToolsList .previous-out-tool-card *,
          #myToolsScreenBody .mytools-tool-item * {
            font-size: 1.1rem !important;
          }

          #collectionDisplaySection .register-tool-card h6,
          #searchResults .register-tool-card h6,
          #toolList .register-tool-card > div:first-child,
          #previousOutToolsList .previous-out-tool-card .previous-out-tool-name,
          #myToolsScreenBody .mytools-tool-item .mytools-tool-name {
            font-size: 1.3rem !important;
          }

          #collectionDisplaySection .register-tool-card .badge,
          #searchResults .register-tool-card .badge,
          #toolList .register-tool-card .badge,
          #previousOutToolsList .previous-out-tool-card .previous-out-tool-status,
          #myToolsScreenBody .mytools-tool-item [class*="mytools-status-"] {
            font-size: 1.0rem !important;
            padding: 5px 10px !important;
          }
        }

        /* Larger fonts for tool cards in modals on desktop screens */
        @media (min-width: 1025px) {
          #collectionDisplaySection .register-tool-card *,
          #searchResults .register-tool-card *,
          #toolList .register-tool-card *,
          #previousOutToolsList .previous-out-tool-card *,
          #myToolsScreenBody .mytools-tool-item * {
            font-size: 1.5rem !important;
          }

          #collectionDisplaySection .register-tool-card h6,
          #searchResults .register-tool-card h6,
          #toolList .register-tool-card > div:first-child,
          #previousOutToolsList .previous-out-tool-card .previous-out-tool-name,
          #myToolsScreenBody .mytools-tool-item .mytools-tool-name {
            font-size: 1.8rem !important;
          }

          #collectionDisplaySection .register-tool-card .badge,
          #searchResults .register-tool-card .badge,
          #toolList .register-tool-card .badge,
          #previousOutToolsList .previous-out-tool-card .previous-out-tool-status,
          #myToolsScreenBody .mytools-tool-item [class*="mytools-status-"] {
            font-size: 1.3rem !important;
            padding: 6px 12px !important;
          }

          #collectionDisplaySection .register-tool-card small,
          #searchResults .register-tool-card small,
          #toolList .register-tool-card small,
          #previousOutToolsList .previous-out-tool-card .previous-out-tool-date,
          #previousOutToolsList .previous-out-tool-card .previous-out-tool-label,
          #previousOutToolsList .previous-out-tool-card .previous-out-tool-value,
          #myToolsScreenBody .mytools-tool-item .mytools-tool-tid,
          #myToolsScreenBody .mytools-tool-item .mytools-tool-part,
          #myToolsScreenBody .mytools-tool-item span {
            font-size: 1.3rem !important;
          }
        }
    </style>
</head>
<body>
    <!-- Immediate script to handle skipSplash before other scripts run -->
    <script>
        // Check skipSplash immediately to prevent login screen flash
        (function() {
            const skipSplash = sessionStorage.getItem('skipSplash');
            if (skipSplash === 'true') {
                console.log('skipSplash detected in immediate script');
                // Hide elements immediately - don't wait for DOMContentLoaded
                const hideElements = function() {
                    try {
                        const loginSection = document.getElementById('loginSection');
                        const splashScreen = document.getElementById('splashScreen');
                        const orangeOverlay = document.getElementById('orangeOverlay');
                        
                        if (loginSection) {
                            loginSection.style.display = 'none';
                            loginSection.classList.add('d-none');
                        }
                        if (splashScreen) {
                            splashScreen.style.display = 'none';
                            splashScreen.style.visibility = 'hidden';
                        }
                        if (orangeOverlay) {
                            orangeOverlay.classList.add('hidden');
                            orangeOverlay.style.display = 'none';
                            orangeOverlay.style.visibility = 'hidden';
                        }
                    } catch(e) {
                        console.error('Error hiding elements:', e);
                    }
                };
                
                // Try immediately
                hideElements();
                
                // Also try on DOMContentLoaded as fallback
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', hideElements);
                } else {
                    hideElements();
                }
                
                // Also try after short delay to catch any late-rendering
                setTimeout(hideElements, 50);
                setTimeout(hideElements, 200);
                setTimeout(hideElements, 500);
            }
        })();
    </script>
    <div id="orangeOverlay"></div>
    <div id="splashScreen">
        <video id="splashVideo" autoplay muted playsinline webkit-playsinline preload="auto">
            <source src="src/main/res/raw/helicopter_animation.mp4" type="video/mp4">
            <source src="src/helicopter_animation.mp4" type="video/mp4">
        </video>
        
        <!-- iOS Fallback: Static splash content (hidden by default) -->
        <div id="splashContent" style="display: none;">
            <img id="splashLogo" src="ams_logo.png" alt="AMS Squadron Logo">
            <div id="splashTitle">AMS SQUADRON</div>
            <div id="splashSubtitle">Tool Tracking System</div>
            <div id="splashLoading"></div>
        </div>
    </div>
    <!-- Removed old static splash/logo section -->

    <div id="headerBranding">
        <h1 class="ams-title">AMS SQUADRON</h1>
        <div class="ams-subtitle">Tool Tracking</div>
        <img src="ams_logo.png" alt="AMS Squadron Logo" class="ams-logo">
    </div>
    <div class="container">
        <!-- Login Section -->
        <div id="loginSection" class="auth-container">
            <div class="card auth-card">
                <div class="card-body">
                    <div id="loginAlert" class="alert alert-danger d-none" role="alert"></div>
                    <div class="mb-2">
                        <label for="loginEmail" class="form-label">Email</label>
                        <input type="email" id="loginEmail" class="form-control" required autocomplete="username">
                    </div>
                    <div class="mb-1">
                        <label for="loginPassword" class="form-label">Password</label>
                        <div class="input-group">
                            <input type="password" id="loginPassword" class="form-control" required autocomplete="current-password">
                            <button class="btn btn-outline-secondary" type="button" id="toggleLoginPassword" tabindex="-1">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    </div>
                    <div class="d-flex justify-content-end mb-1">
                        <a href="#" id="forgotPasswordLink">Forgot my password?</a>
                    </div>
                    <div class="mb-2 form-check">
                        <input type="checkbox" class="form-check-input" id="keepSignedIn">
                        <label class="form-check-label" for="keepSignedIn">Keep me signed in</label>
                    </div>
                    <button onclick="login()" class="btn btn-primary w-100 mb-2" id="loginBtn">
                        <span class="btn-text">Login</span>
                        <span class="btn-loading d-none">
                            <span class="spinner-border spinner-border-sm me-2"></span>Loading...
                        </span>
                    </button>
                    
                    <!-- Divider -->
                    <div class="text-center mb-2">
                        <span class="text-muted">or</span>
                    </div>
                    
                    <!-- Google Sign-In Button -->
                    <button onclick="signInWithGoogle()" class="btn btn-outline-dark w-100 mb-2" id="googleSignInBtn">
                        <img src="https://developers.google.com/identity/images/g-logo.png" alt="Google" style="width: 18px; height: 18px; margin-right: 8px;">
                        Sign in with Google
                    </button>
                    
                    <button onclick="showSignUp()" class="btn btn-primary w-100 mb-2">CREATE ACCOUNT</button>
                    <button onclick="showAdminLogin()" class="btn btn-warning w-100">Tool Admin</button>
                </div>
            </div>
        </div>

        <!-- Sign Up Section -->
        <div id="signUpSection" class="auth-container d-none">
            <div class="card auth-card">
                <div class="card-body">
                    <!-- Back button -->
                    <div class="text-center mb-2">
                        <button onclick="showLogin()" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left"></i> Back to Login
                        </button>
                    </div>
                    
                    <div id="signUpAlert" class="alert alert-danger d-none" role="alert"></div>
                    
                    <div class="mb-2">
                        <label for="signUpFullName" class="form-label">Full Name</label>
                        <input type="text" id="signUpFullName" class="form-control" required autocomplete="name" 
                               oninput="validateFullName(this)" onblur="formatFullName(this)" 
                               placeholder="Enter your full name (English letters only)">
                        <div id="fullNameValidation" class="form-text text-muted"></div>
                    </div>
                    
                    <div class="mb-2">
                        <label for="signUpEmail" class="form-label">Email</label>
                        <input type="email" id="signUpEmail" class="form-control" required autocomplete="username">
                    </div>
                    
                    <div class="mb-2">
                        <label for="signUpPassword" class="form-label">Password</label>
                        <div class="input-group">
                            <input type="password" id="signUpPassword" class="form-control" required autocomplete="new-password">
                            <button class="btn btn-outline-secondary" type="button" id="toggleSignUpPassword" tabindex="-1">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    </div>
                    
                    <div class="mb-2">
                        <label for="signUpConfirmPassword" class="form-label">Confirm Password</label>
                        <div class="input-group">
                            <input type="password" id="signUpConfirmPassword" class="form-control" required autocomplete="new-password">
                            <button class="btn btn-outline-secondary" type="button" id="toggleSignUpConfirmPassword" tabindex="-1">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    </div>
                    
                    <button onclick="signUp()" class="btn btn-primary w-100 mb-2" id="signUpBtn">
                        <span class="btn-text">CREATE ACCOUNT</span>
                        <span class="btn-loading d-none">
                            <span class="spinner-border spinner-border-sm me-2"></span>Loading...
                        </span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Forgot Password Modal -->
        <div class="modal fade" id="forgotPasswordModal" tabindex="-1" aria-labelledby="forgotPasswordModalLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="forgotPasswordModalLabel">Reset Password</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <input type="email" id="resetEmail" class="form-control mb-2" placeholder="Enter your email">
                <div id="resetAlert" class="alert alert-info d-none" role="alert"></div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="resetPassword()">Send Reset Email</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Main App Section -->
        <div id="appSection" style="display: none;">
            <!-- Orange Top Bar with Title -->
            <div class="full-width-title-bar" style="background: #FF9800; color: white; padding: 10px 0 8px 0; position: relative; box-shadow: 0 2px 8px rgba(255,152,0,0.10); margin-bottom: 0.5rem; overflow: visible;">
                <h2 style="margin: 0 0 0 20px; font-size: 1.3rem; font-weight: bold; letter-spacing: 1px; padding-right: 160px;">Register Tools</h2>
                <button id="backToMenuBtn" title="Back to Menu">
                    <i class="fas fa-arrow-left"></i> Back to Menu
                </button>
            </div>
            <!-- Welcome Message (no background) -->
            <div style="margin: 8px 0 10px 0; text-align: left; display: flex; align-items: center; gap: 12px;">
                <span style="font-size: 1.5rem; color: #333; font-weight: bold;">Welcome, <span id="registerScreenName" class="technician-name"></span></span>
                <span id="onlineStatus" class="status-dot"></span>
            </div>
            <div id="registerToolsHeader" style="display: flex; align-items: center; justify-content: flex-start; gap: 16px; margin-bottom: 12px;">
              <span id="workLocationLabel" style="font-weight: bold; font-size: 2rem;">
                <span style="color: black;">Station:</span> 
                <span id="workLocationValue" style="color: red; font-size: 2rem;">(not selected)</span>
              </span>
              <button id="changeWorkLocationBtn" class="btn btn-outline-primary btn-sm" type="button">
                <i class="fas fa-helicopter"></i> Change Station
              </button>
            </div>

            <!-- Register Tools Title -->
            <!-- REMOVE the following block:
            <div class="text-center mb-4">
                <h2 style="color: #FF9800; font-weight: bold; font-size: 2rem;">Register Tools</h2>
            </div>
            -->

            <!-- Tab Navigation -->
            <ul class="nav nav-tabs mb-3" id="registerToolsTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="scanToolTab" data-bs-toggle="tab" data-bs-target="#scannerView" type="button" role="tab" aria-controls="scannerView" aria-selected="true">
                        <i class="fas fa-qrcode"></i> Scan Tool
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="searchToolsTab" data-bs-toggle="tab" data-bs-target="#searchToolsView" type="button" role="tab" aria-controls="searchToolsView" aria-selected="false">
                        <i class="fas fa-search"></i> Search Tools
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content">
                <!-- Scanner View -->
                <div class="tab-pane fade show active" id="scannerView" role="tabpanel">
                    <div class="row">
                        <div class="col-xl-6 mx-auto">
                            <div id="scannerControlsBox" style="display: block;">
                            <div class="scanner-container" id="scannerContainer" style="position: relative;">
                            <div class="card mb-2">
                                <div class="card-body" style="padding-bottom: 10px; padding-top: 12px; position: relative;">
                                    <div class="d-flex gap-2 mb-2" style="margin-top: 4px;">
                                        <button id="basicScannerBtn" onclick="startScanner()" class="btn btn-scan active">
                                            <i class="fas fa-qrcode"></i> Basic Scanner
                                        </button>
                                        <button id="advancedScannerBtn" onclick="startEnhancedScanner()" class="btn btn-scan">
                                            <i class="fas fa-camera"></i> Advanced Scanner
                                        </button>
                                    </div>
                                    <div id="reader" style="display:none; position: relative;">
                                        <!-- Advanced scanner controls (hidden for basic scanner) -->
                                        <div id="advancedScannerControls" style="display: none; position: absolute; top: 10px; right: 10px; z-index: 10;">
                                            <button id="torchBtn" class="btn btn-sm" style="background: rgba(0,0,0,0.5); color: white; border: none; margin-bottom: 5px; border-radius: 50%; width: 40px; height: 40px; padding: 0;" title="Toggle Torch">
                                                <i class="fas fa-star"></i>
                                        </button>
                                    </div>
                                        <div id="advancedScannerBottomControls" style="display: none; position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); z-index: 10; background: rgba(0,0,0,0.5); padding: 8px; border-radius: 20px;">
                                            <button id="zoomOutBtn" class="btn btn-sm" style="background: transparent; color: white; border: 1px solid white; border-radius: 50%; width: 35px; height: 35px; padding: 0; margin-right: 10px;" title="Zoom Out">
                                                <i class="fas fa-search-minus"></i>
                                            </button>
                                            <span id="zoomLevel" style="color: white; font-weight: bold; margin: 0 10px; min-width: 50px; display: inline-block; text-align: center;">1.0x</span>
                                            <button id="zoomInBtn" class="btn btn-sm" style="background: transparent; color: white; border: 1px solid white; border-radius: 50%; width: 35px; height: 35px; padding: 0; margin-left: 10px;" title="Zoom In">
                                                <i class="fas fa-search-plus"></i>
                                            </button>
                                        </div>
                                        <div id="focusIndicator" style="display: none; position: absolute; width: 60px; height: 60px; border: 2px solid #4CAF50; border-radius: 50%; pointer-events: none; z-index: 15;"></div>
                                    </div>
                                    <!-- Bulk Scan Message - positioned above camera -->
                                    <div id="bulkScanMessage" style="display: none; position: absolute; top: 60px; left: 50%; transform: translateX(-50%); z-index: 1000; padding: 12px 24px; border-radius: 8px; font-weight: bold; text-align: center; font-size: 1rem; max-width: 90%; box-shadow: 0 4px 12px rgba(0,0,0,0.5); pointer-events: none; white-space: nowrap;"></div>
                                    <div class="input-group mb-2">
                                        <input type="text" id="toolCode" class="form-control" placeholder="Scan or Type Tool Code">
                                        <button onclick="submitCode()" class="btn btn-primary submit-check-btn">
                                            <i class="fas fa-check"></i>
                                        </button>
                                    </div>
                                    <div class="d-flex gap-2 mb-2">
                                        <button id="bulkScanModeBtn" onclick="toggleBulkScanMode()" class="btn btn-sm" style="background: linear-gradient(135deg, #e0e0e0 0%, #bdbdbd 100%); border: 2px solid #bdbdbd; color: #333; border-radius: 12px; font-weight: bold; flex: 1;">
                                            <i class="fas fa-layer-group"></i> Bulk Scan Mode
                                        </button>
                                        <button id="toolDetailsBtn" class="btn btn-info" style="flex: 1;" disabled onclick="showLastScannedToolDetails()">Tool Details</button>
                                    </div>
                                    </div>
                                </div>
                                <!-- Overlay for expanded scanner -->
                                <div class="scanner-overlay" id="scannerOverlay" style="display:none;">
                                    <button onclick="stopCamera()" class="btn btn-danger btn-lg">
                                        <i class="fas fa-times"></i> Close Scanner
                                    </button>
                                </div>
                                </div>
                            </div>
                            <div id="toolList" class="mt-2">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                                    <h4 style="font-size: 1.5rem; font-weight: bold; margin: 0;">Today's Scanned Tools</h4>
                                    <button id="todayAnalyticsBtn" onclick="showTodayAnalytics()" class="btn-analytics" title="View Today's Analytics">
                                        <i class="fas fa-chart-bar"></i>
                                    </button>
                                </div>
                                <!-- Tools will be listed here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Search Tools View -->
                <div class="tab-pane fade" id="searchToolsView" role="tabpanel">
                    <div class="row">
                        <div class="col-xl-6 mx-auto">
                            <div class="card mb-2">
                                <div class="card-body" style="padding-bottom: 10px; padding-top: 12px;">
                                    <h4 style="font-size: 1.1rem; margin-bottom: 10px;">Search Tools</h4>
                                    <div class="mb-3">
                                        <label class="form-label mb-2 d-block">Search By:</label>
                                        <div class="d-flex gap-2">
                                            <button id="searchTypeToolName" onclick="setSearchType('toolName')" class="btn search-type-btn active">
                                                Tool Name
                                            </button>
                                            <button id="searchTypePartNumber" onclick="setSearchType('partNumber')" class="btn search-type-btn">
                                                Part Number
                                            </button>
                                        </div>
                                    </div>
                                    <div class="mb-2 position-relative">
                                        <input type="text" id="searchToolInput" class="form-control" placeholder="Start typing to search..." onkeyup="handleSearchInputKeyup(event)" onfocus="handleSearchInputFocus()" onblur="handleSearchInputBlur()" autocomplete="off">
                                        <div id="searchDropdownList" class="search-dropdown-list" style="display: none;">
                                            <!-- Dropdown items will be populated here -->
                                        </div>
                                    </div>
                                    <div id="searchResultsContainer" style="display: none;">
                                        <label for="searchResultsDropdown" class="form-label mt-2">Search Results:</label>
                                        <select id="searchResultsDropdown" class="form-select" size="10" onchange="selectToolFromSearch(this.value)">
                                            <option value="">-- Select a tool --</option>
                                        </select>
                                    </div>
                                    <div id="selectedToolDetails" class="mt-3" style="display: none;">
                                        <!-- Selected tool details will be displayed here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Section -->
        <div id="adminSection" class="mt-4" style="display: none;">
            <div class="card">
                <div class="card-body">
                    <h3>Tool Administration</h3>
                    <div class="mb-3">
                        <input type="text" id="adminToolId" class="form-control" placeholder="Tool ID">
                    </div>
                    <div class="mb-3">
                        <input type="text" id="adminToolName" class="form-control" placeholder="Tool Name">
                    </div>
                    <div class="mb-3">
                        <input type="text" id="adminPartNumber" class="form-control" placeholder="Part Number">
                    </div>
                    <div class="mb-3">
                        <input type="text" id="adminLocation" class="form-control" placeholder="Location">
                    </div>
                    <button onclick="saveToolAdmin()" class="btn btn-success">Save Tool</button>
                    <button onclick="runCleanup()" class="btn btn-warning">Cleanup Unverified Accounts</button>
                    <button onclick="toggleAdmin()" class="btn btn-secondary">Close Admin</button>
                </div>
            </div>
        </div>
    </div>

    <!-- My Tools Screen (new, full page) -->
    <div id="myToolsScreen" style="display:none;">
      <div class="container py-4">
        <button id="myToolsBackBtn" class="mytools-back"><i class="fas fa-arrow-left"></i> Back to Menu</button>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
          <h2 class="mytools-title" style="margin:0;">MY TOOLS</h2>
          <div style="display:flex;gap:8px;">
            <button id="editMyToolsBtn" style="background:#2196F3;color:white;border:none;border-radius:16px;padding:8px 16px;font-size:0.9rem;font-weight:bold;cursor:pointer;">Edit My Tools</button>
            <button id="myToolsAddCollectionPhotoBtn" style="background:#4CAF50;color:white;border:none;border-radius:16px;padding:8px 16px;font-size:0.9rem;font-weight:bold;cursor:pointer;"><i class="fas fa-camera"></i> Add Collection Photo</button>
            <button id="myToolsCollectionPhotosBtn" style="background:#9C27B0;color:white;border:none;border-radius:16px;padding:8px 16px;font-size:0.9rem;font-weight:bold;cursor:pointer;"><i class="fas fa-images"></i> Collection Photos</button>
          </div>
        </div>
        <div id="myToolsScreenBody"></div>
      </div>
    </div>

    <!-- Edit My Tools Screen (hidden by default) -->
    <div id="editMyToolsScreen" style="display:none;">
      <div class="container py-4">
        <div style="background:#FF9800;color:white;font-weight:bold;font-size:1.3rem;padding:12px 16px;border-radius:8px 8px 0 0;">Edit My Tools</div>
        <div style="display:flex;gap:8px;margin:16px 0;align-items:center;">
          <input id="editMyToolsSearch" type="text" placeholder="Search or scan tool..." style="flex:1;padding:8px 12px;font-size:1.1rem;border-radius:6px;border:1px solid #ccc;">
          <button id="editMyToolsSearchBtn" style="background:#2196F3;color:white;border:none;border-radius:6px;padding:8px 16px;font-size:1rem;font-weight:bold;cursor:pointer;">Search</button>
          <!-- Optionally add a scan button here if you have barcode scanning support -->
        </div>
        <button id="editMyToolsBackBtn" class="mytools-back"><i class="fas fa-arrow-left"></i> Back</button>
        <div id="editMyToolsResults"></div>
      </div>
    </div>

    <!-- 5-Minute Cooldown Info Modal -->
    <div class="modal fade" id="cooldownInfoModal" tabindex="-1" aria-labelledby="cooldownInfoModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="cooldownInfoModalLabel">5-Minute Cooldown</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            When you check out a tool, you must wait at least 5 minutes before returning it. This helps ensure accurate tool tracking. You will not see this message again today.
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 5-Minute Cooldown Warning Modal -->
    <div class="modal fade" id="cooldownWarnModal" tabindex="-1" aria-labelledby="cooldownWarnModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="cooldownWarnModalLabel">Return Not Allowed</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            You must wait at least 5 minutes after checking out a tool before you can return it.
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Outstanding Tools Notification Modal -->
    <div class="modal fade" id="outstandingToolsModal" tabindex="-1" aria-labelledby="outstandingToolsModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="outstandingToolsModalLabel">
              <i class="fas fa-exclamation-triangle" style="color: #FFD600; margin-right: 8px;"></i>
              YOUR TOOLS CHECKED OUT BY OTHERS
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" id="outstandingToolsBody">
            <!-- Notification content will be set by JS -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" id="outstandingToolsOkBtn" data-bs-dismiss="modal">OK</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Out Tools Notification Modal -->
    <div class="modal fade" id="outToolsNotifModal" tabindex="-1" aria-labelledby="outToolsNotifModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="outToolsNotifModalLabel">
              <i class="fas fa-exclamation-triangle" style="color: #FFD600; margin-right: 8px;"></i>
              TOOLS YOU HAVE CHECKED OUT
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" id="outToolsNotifBody">
            <!-- Content will be set by JS -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" id="outToolsNotifOkBtn" data-bs-dismiss="modal">OK</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ToolScanner Menu Section -->
    <div id="toolScannerMenu" style="display:none;">
        <!-- Orange Top Bar with Title and Settings (now outside container) -->
        <div class="full-width-title-bar" style="background: #FF9800; color: white; min-width: 100vw; padding: 10px 0 8px 0; position: relative; box-shadow: 0 2px 8px rgba(255,152,0,0.10); margin-bottom: 0.5rem; overflow: visible;">
            <h2 style="margin: 0 0 0 20px; font-size: 1.3rem; font-weight: bold; letter-spacing: 1px;">ToolScanner Menu</h2>
            <button id="settingsBtn" class="btn btn-link p-0" style="position: absolute; right: 18px; top: 50%; transform: translateY(-50%); font-size: 2rem; color: white; z-index: 2;" title="Settings">
                <i class="fas fa-cog" style="color: white;"></i>
                </button>
            </div>
        <div class="container py-4">
            <!-- Welcome Message (no background) -->
            <div style="margin: 8px 0 10px 0; text-align: left;">
                <span style="font-size: 1.5rem; color: #333; font-weight: bold;">Welcome, <span id="fullName" class="technician-name"></span></span>
            </div>
            <div class="d-grid gap-3 col-6 mx-auto">
                <button class="btn btn-success" id="menuRegisterBtn"><i class="fas fa-plus"></i> Register Tools</button>
                <button class="btn btn-danger" id="menuOutBtn"><i class="fas fa-sign-out-alt"></i> View OUT Tools</button>
                <button class="btn btn-warning" id="menuMyToolsBtn"><i class="fas fa-toolbox"></i> My Tools</button>
                <button class="btn" id="menuWorkLocationBtn"><i class="fas fa-map-marker-alt"></i> Tools by Work Location</button>
                <button class="btn btn-info" id="menuAdminBtn" style="display: none;"><i class="fas fa-user-shield"></i> Tool Administrator</button>
                <button class="btn btn-primary" id="menuTrainingQuestionsBtn" style="display: none;"><i class="fas fa-question-circle"></i> Create Training Questions</button>
                <button class="btn btn-secondary" id="menuLogoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>
        </div>
    </div>

    <!-- Admin Code Modal -->
    <div class="modal fade" id="adminCodeModal" tabindex="-1" aria-labelledby="adminCodeModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="adminCodeModalLabel">Admin Verification</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <input type="password" id="adminCodeInput" class="form-control mb-2" placeholder="Enter admin code">
            <div id="adminCodeError" class="text-danger mb-2" style="display:none;"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" id="verifyAdminCodeBtn">Verify</button>
          </div>
        </div>
      </div>
    </div>

    <!-- My Account Modal -->
    <div class="modal fade" id="myAccountModal" tabindex="-1" aria-labelledby="myAccountModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="myAccountModalLabel">My Account</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <label for="accountNameInput" class="form-label">Name</label>
            <input type="text" id="accountNameInput" class="form-control mb-2" 
                   oninput="validateFullName(this)" onblur="formatFullName(this)" 
                   placeholder="Enter your full name (English letters only)">
            <div id="accountNameValidation" class="form-text text-muted"></div>
            <div id="myAccountLoading" class="text-center mb-2" style="display:none;">
                <div class="spinner-border text-primary" role="status"></div>
                <div>Please wait...</div>
            </div>
            <div id="myAccountError" class="text-danger mb-2" style="display:none;"></div>
            <div id="myAccountSuccess" class="text-success mb-2" style="display:none;"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" id="saveAccountNameBtn">Save</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Collection Selection Modal -->
    <div class="modal fade" id="collectionSelectModal" tabindex="-1" aria-labelledby="collectionSelectModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="collectionSelectModalLabel">Select Collection</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" id="collectionSelectBody">
            <!-- Collections will be loaded here -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          </div>
        </div>
      </div>
    </div>

    <!-- My Tools by Collection Screen -->
    <div id="myToolsByCollectionScreen" style="display:none;">
      <!-- Orange Title Bar -->
      <div style="background: #FF9800; color: white; padding: 1rem 0; width: 100%; position: relative;">
        <div class="container">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <h2 style="color: white; font-weight: bold; font-size: 2rem; margin: 0;" id="myToolsCollectionTitle"></h2>
            <div style="display:flex;gap:8px;">
              <button id="myToolsByCollectionAddPhotoBtn" style="background:#4CAF50;color:white;border:none;border-radius:16px;padding:8px 16px;font-size:0.9rem;font-weight:bold;cursor:pointer;"><i class="fas fa-camera"></i> Add Collection Photo</button>
              <button id="myToolsByCollectionPhotosBtn" style="background:#9C27B0;color:white;border:none;border-radius:16px;padding:8px 16px;font-size:0.9rem;font-weight:bold;cursor:pointer;"><i class="fas fa-images"></i> Collection Photos</button>
            </div>
          </div>
        </div>
      </div>
      
      <div class="container py-4">
        <button id="backToCollectionSelectBtn" class="btn btn-outline-secondary mb-3"><i class="fas fa-arrow-left"></i> Back to Menu</button>
        <div class="row mb-3">
          <div class="col-6">
            <button id="collectionCheckupBtn" class="btn btn-success w-100"><i class="fas fa-clipboard-check"></i> Collection Checkup</button>
          </div>
          <div class="col-6">
            <button id="selectDifferentCollectionBtn" class="btn btn-primary w-100"><i class="fas fa-exchange-alt"></i> Select Collection</button>
          </div>
        </div>
        <!-- Add Location Photo Button -->
        <div class="mb-3">
          <button id="locationPhotoBtn" class="btn btn-info w-100"><i class="fas fa-camera"></i> Add Location Photo</button>
        </div>
        <div id="myToolsByCollectionList"></div>
      </div>
    </div>

    <!-- Collection Checkup Screen -->
    <div id="collectionCheckupScreen" style="display:none;">
      <!-- Orange Title Bar -->
      <div style="background: #FF9800; color: white; padding: 1rem 0; width: 100%; position: relative;">
        <div class="container">
          <h2 style="color: white; font-weight: bold; font-size: 2rem; margin: 0; text-align: center;">Collection Checkup</h2>
        </div>
      </div>
      
      <div class="container py-4">
        <button id="backToMyToolsByCollectionBtn" class="btn btn-outline-secondary mb-3">
          <i class="fas fa-arrow-left"></i> Back to Collection
        </button>
        
        <!-- Show Results and History buttons -->
        <div class="row mb-3" id="checkupActionButtons" style="display:none;">
          <div class="col-6">
            <button id="showResultsBtn" class="btn btn-primary w-100">
              <i class="fas fa-chart-bar"></i> Show Results
            </button>
          </div>
          <div class="col-6">
            <button id="checkupHistoryBtn" class="btn btn-secondary w-100">
              <i class="fas fa-history"></i> History
            </button>
          </div>
        </div>
        
        <!-- Collection Header with Progress -->
        <div id="checkupCollectionHeader" class="mb-3" style="background: #FF9800; color: white; padding: 12px; border-radius: 8px;">
          <div class="row align-items-center">
            <div class="col-6">
              <div id="checkupLocationTitle" style="font-size: 1.2rem; font-weight: bold;">All Locations</div>
            </div>
            <div class="col-3 text-center">
              <button id="selectAllBtn" class="btn btn-success btn-sm">
                <i class="fas fa-check-double"></i> Select All
              </button>
            </div>
            <div class="col-3 text-end">
              <div><strong>Progress:</strong></div>
              <div id="checkupProgress" style="font-size: 1.1rem; font-weight: bold;">0/0</div>
            </div>
          </div>
        </div>
        
        <!-- Tools List -->
        <div id="checkupToolsList" style="height: calc(100vh - 400px); overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 10px; margin-bottom: 80px;"></div>
        
        <!-- Location Filter Bar -->
        <div id="checkupLocationFilter" class="mt-3" style="background: #f5f5f5; padding: 8px; border-radius: 8px; position: fixed; bottom: 0; left: 0; right: 0; z-index: 1000; border-top: 2px solid #FF9800;">
          <div class="d-flex gap-2 overflow-x-auto" id="checkupLocationButtons"></div>
        </div>
      </div>
    </div>

    <!-- Checkup Results Modal -->
    <div class="modal fade" id="checkupResultsModal" tabindex="-1" aria-labelledby="checkupResultsModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="checkupResultsModalLabel">Checkup Results</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" id="checkupResultsContent">
            <!-- Results content will be populated here -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" id="saveCheckupResultsBtn">
              <i class="fas fa-save"></i> Save Results
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Checkup Save Success Modal -->
    <div class="modal fade" id="checkupSaveSuccessModal" tabindex="-1" aria-labelledby="checkupSaveSuccessModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="checkupSaveSuccessModalLabel">Checkup Results Saved</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            Checkup results have been successfully saved to the database.
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Previous OUT Tools Screen -->
    <div id="previousOutToolsScreen" style="display:none;">
      <!-- Orange Title Bar -->
      <div style="background: #FF9800; color: white; padding: 1rem 0; width: 100%; position: relative;">
        <div class="container">
          <h2 style="color: white; font-weight: bold; font-size: 2rem; margin: 0; text-align: center;">Previous Dates OUT Tools</h2>
        </div>
      </div>
      
      <div class="container py-4">
        <button id="backToMenuFromOutToolsBtn" class="btn btn-outline-secondary mb-3">
          <i class="fas fa-arrow-left"></i> Back to Menu
        </button>
        
        <!-- Summary -->
        <div id="previousOutToolsSummary" class="text-muted mb-3">
            <!-- Summary will be populated here -->
        </div>
        
        <!-- Tools List -->
        <div id="previousOutToolsList" style="height: calc(100vh - 200px); overflow-y: auto;"></div>
      </div>
    </div>

    <!-- Tools by Work Location Screen -->
    <div id="toolsByWorkLocationScreen" style="display:none;">
      <!-- Purple Title Bar -->
      <div style="background: #9C27B0; color: white; padding: 1rem 0; width: 100%; position: relative;">
        <div class="container">
          <h2 style="color: white; font-weight: bold; font-size: 2rem; margin: 0; text-align: center;">Tools by Work Location</h2>
        </div>
      </div>
      
      <div class="container py-4">
        <button id="backToMenuFromWorkLocationBtn" class="btn btn-outline-secondary mb-3">
          <i class="fas fa-arrow-left"></i> Back to Menu
        </button>
        
        <!-- Work Location Selection -->
        <div id="workLocationSelectionDiv" class="card mb-4">
          <div class="card-body">
            <h4 class="mb-3"><i class="fas fa-map-marker-alt"></i> Select Station</h4>
            <select id="workLocationSelect" class="form-select form-select-lg mb-3">
              <option value="">-- Select a Station --</option>
              <option value="ALL">All Locations</option>
            </select>
            <button id="loadToolsByLocationBtn" class="btn btn-primary btn-lg w-100" disabled>
              <i class="fas fa-search"></i> Load Tools
            </button>
          </div>
        </div>

        <!-- Currently OUT Tools Section (hidden initially) -->
        <div id="dateFilterSection" style="display: none;">
          <!-- Currently OUT Tools Section -->
          <div class="card mb-3">
            <div class="card-body">
              <h5 class="mb-3" style="color: #dc3545; font-weight: bold;">
                <i class="fas fa-exclamation-triangle"></i> Currently OUT Tools
              </h5>
              <div id="workLocationCurrentOutSummary" class="text-muted mb-2">
                <!-- Summary will be populated here -->
              </div>
              <div id="workLocationCurrentOutList" style="max-height: 400px; overflow-y: auto;">
                <!-- Currently OUT tools will be populated here -->
              </div>
            </div>
          </div>

          <!-- Date Filter Section -->
          <div class="card mb-3">
            <div class="card-body">
              <h5 class="mb-3"><i class="fas fa-calendar"></i> Filter History by Date</h5>
              <div class="d-flex gap-2 flex-wrap mb-3">
                <button class="btn btn-sm btn-primary filter-date-btn" onclick="filterToolsByDate('today', this)">
                  <i class="fas fa-calendar-day"></i> Today
                </button>
                <button class="btn btn-sm btn-primary filter-date-btn" onclick="filterToolsByDate('week', this)">
                  <i class="fas fa-calendar-week"></i> Last Week
                </button>
                <button class="btn btn-sm btn-primary filter-date-btn" onclick="filterToolsByDate('month', this)">
                  <i class="fas fa-calendar-alt"></i> Last Month
                </button>
                <button class="btn btn-sm btn-primary filter-date-btn active" onclick="filterToolsByDate('all', this)">
                  <i class="fas fa-infinity"></i> All Time
                </button>
              </div>
            </div>
          </div>

          <!-- Tool History Section -->
          <div class="card mb-3">
            <div class="card-body">
              <h5 class="mb-3" style="color: #667eea; font-weight: bold;">
                <i class="fas fa-history"></i> Tool Usage History
              </h5>
              <div id="workLocationToolsSummary" class="text-muted mb-2">
                <!-- Summary will be populated here -->
              </div>
              <!-- Tools List by Collection -->
              <div id="workLocationToolsList" style="max-height: 400px; overflow-y: auto;">
                <!-- Tool history will be populated here -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tool Details Modal for Previous OUT Tools -->
    <div class="modal fade" id="previousOutToolDetailsModal" tabindex="-1" aria-labelledby="previousOutToolDetailsModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="previousOutToolDetailsModalLabel">Tool Details</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" id="previousOutToolDetailsContent">
            <!-- Tool details will be populated here -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Photo Viewer Modal for Previous OUT Tools -->
    <div class="modal fade" id="previousOutPhotoViewerModal" tabindex="-1" aria-labelledby="previousOutPhotoViewerModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="previousOutPhotoViewerModalLabel">Tool Photos</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body text-center" id="previousOutPhotoViewerContent">
            <!-- Photo content will be populated here -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" id="previousOutPhotoPrevBtn">Previous</button>
            <span id="previousOutPhotoCounter" class="mx-3"></span>
            <button type="button" class="btn btn-secondary" id="previousOutPhotoNextBtn">Next</button>
            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Tool Details Modal for Register Tools -->
    <div class="modal fade" id="toolDetailsModal" tabindex="-1" aria-labelledby="toolDetailsModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="toolDetailsModalLabel">Tool Details</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" id="toolDetailsBody">
            <!-- Tool details will be populated here -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Checkout Info Modal for My Tools -->
    <div class="modal fade" id="checkoutInfoModal" tabindex="-1" aria-labelledby="checkoutInfoModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-sm">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="checkoutInfoModalTitle">Tool Checkout Information</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" id="checkoutInfoModalBody">
            <!-- Checkout info will be populated here -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Collection Details Modal -->
    <div class="modal fade" id="collectionDetailsModal" tabindex="-1" aria-labelledby="collectionDetailsModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="collectionDetailsModalLabel">Collection Details</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" id="collectionDetailsBody">
            <!-- Collection details and photos will be populated here -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Collection Details Screen -->
    <div id="collectionDetailsScreen" style="display:none;">
      <!-- Orange Title Bar -->
      <div style="background: #FF9800; color: white; padding: 1rem 0; width: 100%; position: relative;">
        <div class="container">
          <h2 style="color: white; font-weight: bold; font-size: 2rem; margin: 0; text-align: center;">Collection Details</h2>
        </div>
      </div>
      
      <div class="container py-4">
        <button id="backToRegisterToolsBtn" class="btn btn-outline-secondary mb-3">
            <i class="fas fa-arrow-left"></i> Back to Register Tools List
          </button>
        
        <!-- Collection Details Content -->
        <div id="collectionDetailsContent" class="mb-4">
          <!-- Collection details will be populated here -->
        </div>
      </div>
    </div>



    <!-- Tool Photo Gallery Modal -->
    <div class="modal fade" id="toolPhotoGalleryModal" tabindex="-1" aria-labelledby="toolPhotoGalleryModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-fullscreen">
        <div class="modal-content bg-dark text-white">
          <div class="modal-header border-0">
            <h5 class="modal-title" id="toolPhotoGalleryModalLabel">Tool Photos</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body d-flex flex-column align-items-center justify-content-center position-relative" id="toolPhotoGalleryContent">
            <!-- Photo will be shown here -->
            <!-- Navigation arrows -->
            <button type="button" class="btn btn-light position-absolute" id="toolPhotoPrevBtn" style="left: 20px; top: 50%; transform: translateY(-50%); z-index: 1000; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;">
              <i class="fas fa-chevron-left"></i>
            </button>
            <button type="button" class="btn btn-light position-absolute" id="toolPhotoNextBtn" style="right: 20px; top: 50%; transform: translateY(-50%); z-index: 1000; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;">
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
          <div class="modal-footer justify-content-center border-0 bg-dark">
            <span id="toolPhotoCounter" class="text-white"></span>
            <button type="button" class="btn btn-danger ms-3" id="toolPhotoDeleteBtn">
              <i class="fas fa-trash"></i> Delete
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Photo Upload Loading Modal -->
    <div class="modal fade" id="photoUploadLoadingModal" tabindex="-1" aria-labelledby="photoUploadLoadingModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
      <div class="modal-dialog modal-sm">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="photoUploadLoadingModalLabel">Uploading Photo</h5>
          </div>
          <div class="modal-body text-center">
            <div class="spinner-border text-primary mb-3" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <div id="photoUploadProgress">Processing image...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Existing Photo Choice Modal -->
    <div class="modal fade" id="existingPhotoChoiceModal" tabindex="-1" aria-labelledby="existingPhotoChoiceModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content" style="border-radius: 16px; border: none; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
          <div class="modal-header" style="background: #4CAF50; color: white; border-radius: 16px 16px 0 0; border: none; padding: 20px;">
            <h5 class="modal-title" id="existingPhotoChoiceModalLabel" style="font-weight: bold; font-size: 1.3rem;">
              <i class="fas fa-images"></i> Existing Photos Found
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" style="padding: 24px;">
            <div style="margin-bottom: 16px;">
              <strong style="font-size: 1.1rem; color: #333;">Other tools with part number <span id="existingPhotoPartNumber" style="color: #4CAF50;"></span> already have photos:</strong>
            </div>
            <div id="existingPhotoPreview" style="display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 20px; max-height: 400px; overflow-y: auto;"></div>
            <p style="color: #666; margin-bottom: 20px;">Do you want to use the existing photo(s) or add your new photo?</p>
            <div class="d-grid gap-2">
              <button type="button" class="btn" id="useExistingPhotoBtn" style="background: #4CAF50; color: white; font-weight: bold; border-radius: 12px; padding: 12px; font-size: 1rem;">
                <i class="fas fa-check-circle"></i> Use Existing Photo(s)
              </button>
              <button type="button" class="btn" id="addNewPhotoAnywayBtn" style="background: #FF9800; color: white; font-weight: bold; border-radius: 12px; padding: 12px; font-size: 1rem;">
                <i class="fas fa-plus-circle"></i> Add My New Photo (Only to My Tool)
              </button>
            </div>
            <div style="margin-top: 12px; text-align: center; font-size: 0.9rem; color: #999;">
              <i class="fas fa-info-circle"></i> New photos added individually won't be shared with other tools
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Photo Delete Choice Modal -->
    <div class="modal fade" id="photoDeleteChoiceModal" tabindex="-1" aria-labelledby="photoDeleteChoiceModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 16px; border: none; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
          <div class="modal-header" style="background: #FF5722; color: white; border-radius: 16px 16px 0 0; border: none; padding: 20px;">
            <h5 class="modal-title" id="photoDeleteChoiceModalLabel" style="font-weight: bold; font-size: 1.3rem;">
              <i class="fas fa-trash-alt"></i> Delete Photo
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" style="padding: 24px;">
            <div style="margin-bottom: 16px;">
              <strong style="font-size: 1.1rem; color: #333;">Tools with this part number are owned by:</strong>
              <div id="photoDeleteOwnersList" style="margin-top: 8px; padding: 12px; background: #f5f5f5; border-radius: 8px;"></div>
            </div>
            <p style="color: #666; margin-bottom: 20px;">Choose how you want to delete this photo:</p>
            <div class="d-grid gap-2">
              <button type="button" class="btn" id="deleteMyToolOnlyBtn" style="background: #2196F3; color: white; font-weight: bold; border-radius: 12px; padding: 12px; font-size: 1rem;">
                <i class="fas fa-user"></i> Delete from MY Tool Only
              </button>
              <button type="button" class="btn" id="deleteFromAllToolsBtn" style="background: #FF5722; color: white; font-weight: bold; border-radius: 12px; padding: 12px; font-size: 1rem;">
                <i class="fas fa-users"></i> Delete from ALL Tools 
              </button>
            </div>
            <div style="margin-top: 12px; text-align: center; font-size: 0.9rem; color: #999;">
              <i class="fas fa-info-circle"></i> Deleting from all tools requires admin password
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Photo Upload Choice Modal -->
    <div class="modal fade" id="photoUploadChoiceModal" tabindex="-1" aria-labelledby="photoUploadChoiceModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 16px; border: none; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
          <div class="modal-header" style="background: #FF9800; color: white; border-radius: 16px 16px 0 0; border: none; padding: 20px;">
            <h5 class="modal-title" id="photoUploadChoiceModalLabel" style="font-weight: bold; font-size: 1.3rem;">
              <i class="fas fa-camera"></i> Add Photo
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" style="padding: 24px;">
            <div style="margin-bottom: 16px;">
              <strong style="font-size: 1.1rem; color: #333;">Other tools with this part number that have photos:</strong>
              <div id="photoUploadToolsList" style="margin-top: 8px; padding: 12px; background: #f5f5f5; border-radius: 8px;"></div>
            </div>
            <div style="margin-bottom: 16px;">
              <strong style="font-size: 1.1rem; color: #333;">Select photos to use (click to select/deselect):</strong>
              <div id="photoUploadThumbnails" style="margin-top: 8px; padding: 12px; background: #f5f5f5; border-radius: 8px; display: flex; flex-wrap: wrap; gap: 8px; max-height: 250px; overflow-y: auto;"></div>
              <div id="selectedPhotosCount" style="margin-top: 8px; text-align: center; color: #666; font-size: 0.9rem;">
                <span id="selectedCount">0</span> photo(s) selected
              </div>
            </div>
            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #ddd;">
              <div class="d-grid gap-2" id="selectedPhotosActions" style="margin-bottom: 12px;">
                <button type="button" class="btn" id="addSelectedPhotosMyToolBtn" style="background: #2196F3; color: white; font-weight: bold; border-radius: 12px; padding: 12px; font-size: 1rem;" disabled>
                  <i class="fas fa-user-check"></i> Add Selected to MY Tool
                </button>
                <button type="button" class="btn" id="addSelectedPhotosAllToolsBtn" style="background: #673AB7; color: white; font-weight: bold; border-radius: 12px; padding: 12px; font-size: 1rem;" disabled>
                  <i class="fas fa-users"></i> Add Selected to ALL Tools 
                </button>
              </div>
              <div class="d-grid gap-2">
                <button type="button" class="btn" id="addNewPhotoMyToolBtn" style="background: #4CAF50; color: white; font-weight: bold; border-radius: 12px; padding: 12px; font-size: 1rem;">
                  <i class="fas fa-camera"></i> Add New Photo to MY Tool
                </button>
                <button type="button" class="btn" id="addNewPhotoAllToolsBtn" style="background: #FF5722; color: white; font-weight: bold; border-radius: 12px; padding: 12px; font-size: 1rem;">
                  <i class="fas fa-camera-retro"></i> Add New Photo to ALL Tools 
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="checkupHistoryScreen" style="display:none;">
      <!-- Orange Title Bar -->
      <div style="background: #FF9800; color: white; padding: 1rem 0; width: 100%; position: relative;">
        <div class="container">
          <h2 style="color: white; font-weight: bold; font-size: 2rem; margin: 0; text-align: center;">Checkup History - <span id="checkupHistoryTechName"></span></h2>
        </div>
      </div>
      
      <div class="container py-4">
        <button id="checkupHistoryBackBtn" class="btn" style="background:#FF9800;color:white;font-weight:bold;font-size:1.2em;border-radius:24px;padding:8px 32px 8px 32px;margin-bottom:1rem;">
          Back
        </button>
          <div class="row mb-3">
            <div class="col-8 col-md-6 mb-2">
              <input id="checkupHistorySearch" class="form-control" placeholder="Search by date or collection..." />
            </div>
            <div class="col-4 col-md-3 mb-2">
              <select id="checkupHistoryCollectionFilter" class="form-select">
                <option value="All">All</option>
              </select>
            </div>
            <div class="col-12 col-md-3 mb-2 d-flex gap-2">
              <button id="checkupHistoryRefreshBtn" class="btn w-100" style="background:#FF9800;color:white;font-weight:bold;font-size:1em;border-radius:24px;">Refresh History</button>
            </div>
          </div>
          <div class="mb-3">
            <button id="checkupHistoryCleanupBtn" class="btn w-100" style="background:#f44336;color:white;font-weight:bold;font-size:1em;border-radius:24px;">Cleanup Old Records (&gt;1 month)</button>
          </div>
          <div id="checkupHistoryList"></div>
        </div>
      </div>
      <!-- Checkup History Details Modal -->
<div class="modal fade" id="checkupDetailsModal" tabindex="-1" aria-labelledby="checkupDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="checkupDetailsModalLabel">Checkup Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="checkupDetailsContent">
          <!-- Details will be populated here -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
    <!-- Enhanced Scanner Modal -->
    <div class="enhanced-scanner-modal" id="enhancedScannerModal" style="display: none;">
        <div class="enhanced-scanner-content">
            <div class="enhanced-scanner-header">
                <div class="enhanced-scanner-title">Advanced Barcode Scanner</div>
                <button class="enhanced-scanner-close" onclick="closeEnhancedScanner()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="enhanced-scanner-container">
                <div class="scanner-video-container">
                    <video id="enhancedScannerVideo" class="scanner-video" autoplay playsinline muted></video>
                    
                    <!-- Scan Area Overlay -->
                    <div class="scan-area-overlay">
                        <div class="scan-area-mask">
                            <div class="scan-area-hole"></div>
                        </div>
                        <div class="scan-area-corners">
                            <div class="scan-corner top-left"></div>
                            <div class="scan-corner top-right"></div>
                            <div class="scan-corner bottom-left"></div>
                            <div class="scan-corner bottom-right"></div>
                        </div>
                    </div>
                    
                    <!-- Instructions -->
                    <div class="scanner-instructions">
                        Pinch or use buttons to zoom  Tap to focus  Aim at barcode
                    </div>
                    
                    <!-- Top Controls -->
                    <div class="scanner-top-controls">
                        <button class="torch-btn" id="torchBtn" onclick="toggleTorch()">
                            <i class="fas fa-star"></i>
                        </button>
                    </div>
                    
                    <!-- Bottom Controls -->
                    <div class="scanner-controls">
                        <button class="scanner-control-btn" onclick="zoomOut()">
                            <i class="fas fa-search-minus"></i>
                        </button>
                        <div class="zoom-level" id="zoomLevel">1.0x</div>
                        <button class="scanner-control-btn" onclick="zoomIn()">
                            <i class="fas fa-search-plus"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Helicopter Model Selection Modal -->
    <div class="modal fade" id="helicopterModelSelectionModal" tabindex="-1" aria-labelledby="helicopterModelSelectionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="border-radius: 16px; border: none; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                <div class="modal-header" style="background: #FF9800; color: white; border-radius: 16px 16px 0 0; border: none; padding: 20px;">
                    <h5 class="modal-title" id="helicopterModelSelectionModalLabel" style="font-weight: bold; font-size: 1.3rem;">Select Helicopter Model</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" style="padding: 24px;">
                    <p class="mb-4" style="font-size: 1.1rem; color: #333;">Please select the helicopter model:</p>
                    <div class="row g-3">
                        <div class="col-12">
                            <button class="btn helicopter-model-option w-100 text-start p-3" data-model="AW139" style="background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 12px; transition: all 0.3s ease;">
                                <div style="font-weight: bold; font-size: 1.2rem; color: #333;">AW139</div>
                                <div style="font-size: 0.9rem; color: #666; margin-top: 4px;">Work Locations: 701, 702, 703</div>
                            </button>
                        </div>
                        <div class="col-12">
                            <button class="btn helicopter-model-option w-100 text-start p-3" data-model="SA342L" style="background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 12px; transition: all 0.3s ease;">
                                <div style="font-weight: bold; font-size: 1.2rem; color: #333;">SA342L</div>
                                <div style="font-size: 0.9rem; color: #666; margin-top: 4px;">Work Locations: 352, 353, 354, 355</div>
                            </button>
                        </div>
                        <div class="col-12">
                            <button class="btn helicopter-model-option w-100 text-start p-3" data-model="B206L" style="background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 12px; transition: all 0.3s ease;">
                                <div style="font-weight: bold; font-size: 1.2rem; color: #333;">B206L</div>
                                <div style="font-size: 0.9rem; color: #666; margin-top: 4px;">Work Locations: 110, 111</div>
                            </button>
                        </div>
                        <div class="col-12">
                            <button class="btn helicopter-model-option w-100 text-start p-3" data-model="H145M" style="background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 12px; transition: all 0.3s ease;">
                                <div style="font-weight: bold; font-size: 1.2rem; color: #333;">H145M</div>
                                <div style="font-size: 0.9rem; color: #666; margin-top: 4px;">Work Locations: 1955, 1956, 1957, 1958, 1959, 1960</div>
                            </button>
                        </div>
                        <div class="col-12">
                            <button class="btn helicopter-model-option w-100 text-start p-3" data-model="Other" style="background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 12px; transition: all 0.3s ease;">
                                <div style="font-weight: bold; font-size: 1.2rem; color: #333;">Other</div>
                                <div style="font-size: 0.9rem; color: #666; margin-top: 4px;">Work Locations: Other</div>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Work Location Selection Modal -->
    <div class="modal fade" id="workLocationSelectionModal" tabindex="-1" aria-labelledby="workLocationSelectionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="border-radius: 16px; border: none; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                <div class="modal-header" style="background: #FF9800; color: white; border-radius: 16px 16px 0 0; border: none; padding: 20px;">
                    <h5 class="modal-title" id="workLocationSelectionModalLabel" style="font-weight: bold; font-size: 1.3rem;">Select Station</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" style="padding: 24px;">
                    <p class="mb-4" id="workLocationSelectionModalBody" style="font-size: 1.1rem; color: #333;">
                        <!-- Work location options will be dynamically loaded here -->
                    </p>
                    <div class="row g-3" id="workLocationOptions">
                        <!-- Work location buttons will be dynamically loaded here -->
                    </div>
                    <div class="text-center mt-4">
                        <button type="button" class="btn btn-link text-decoration-none" onclick="goBackToHelicopterModels()" style="color: #666; font-size: 1rem;">
                            <i class="fas fa-arrow-left me-2"></i>Back to Models
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <!-- QR Code Scanner -->
    <script src="https://unpkg.com/html5-qrcode"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDmI0v_pVt_qFJlsqmw8QlIOi-4VLjyn54",
            authDomain: "tool-tracking-system-15e84.firebaseapp.com",
            projectId: "tool-tracking-system-15e84",
            storageBucket: "tool-tracking-system-15e84.firebasestorage.app",
            messagingSenderId: "813615362050",
            appId: "1:813615362050:web:1fa435f0b725dd1f8cb71b"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // Configure Firebase Auth to require email verification
        auth.useDeviceLanguage();
        
        // Set custom error messages for unverified emails
        auth.onAuthStateChanged(function(user) {
            if (user && !user.emailVerified) {
                // Force sign out if user is not verified
                auth.signOut();
            }
        });

        // Ensure user stays logged in across refreshes and browser restarts
        auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

        // QR Scanner
        let html5QrCode;
        
        // Bulk Scan Mode
        let bulkScanMode = false;
        let bulkScannedTools = []; // Array of {code, toolName, partNumber, status, data}
        let bulkProcessingCodes = new Set(); // Track codes currently being processed
        let bulkRecentlyProcessed = new Map(); // Track recently processed codes with timestamps
        
        // Online/Offline status
        let isOnline = navigator.onLine;
        
        // IndexedDB for offline storage
        let indexedDB = null;

        // Show/Hide password logic
        const loginPassword = document.getElementById('loginPassword');
        document.getElementById('toggleLoginPassword').onclick = function() {
            if (loginPassword.type === 'password') {
                loginPassword.type = 'text';
                this.innerHTML = '<i class="fas fa-eye-slash"></i>';
            } else {
                loginPassword.type = 'password';
                this.innerHTML = '<i class="fas fa-eye"></i>';
            }
        };
        const signUpPassword = document.getElementById('signUpPassword');
        document.getElementById('toggleSignUpPassword').onclick = function() {
            if (signUpPassword.type === 'password') {
                signUpPassword.type = 'text';
                this.innerHTML = '<i class="fas fa-eye-slash"></i>';
            } else {
                signUpPassword.type = 'password';
                this.innerHTML = '<i class="fas fa-eye"></i>';
            }
        };
        const signUpConfirmPassword = document.getElementById('signUpConfirmPassword');
        document.getElementById('toggleSignUpConfirmPassword').onclick = function() {
            if (signUpConfirmPassword.type === 'password') {
                signUpConfirmPassword.type = 'text';
                this.innerHTML = '<i class="fas fa-eye-slash"></i>';
            } else {
                signUpConfirmPassword.type = 'password';
                this.innerHTML = '<i class="fas fa-eye"></i>';
            }
        };

        // Show/Hide login/signup
        function showSignUp() {
            document.getElementById('loginSection').classList.add('d-none');
            document.getElementById('signUpSection').classList.remove('d-none');
        }
        function showLogin() {
            document.getElementById('signUpSection').classList.add('d-none');
            document.getElementById('loginSection').classList.remove('d-none');
        }

        // Forgot password modal
        const forgotPasswordLink = document.getElementById('forgotPasswordLink');
        forgotPasswordLink.onclick = function() {
            const email = document.getElementById('loginEmail').value;
            document.getElementById('resetEmail').value = email;
            document.getElementById('resetAlert').classList.add('d-none');
            const modal = new bootstrap.Modal(document.getElementById('forgotPasswordModal'));
            modal.show();
        };

        // Hide all main screens
        function hideAllMainScreens() {
            document.getElementById('appSection').style.display = 'none';
            document.getElementById('toolScannerMenu').style.display = 'none';
            document.getElementById('myToolsScreen').style.display = 'none';
            document.getElementById('myToolsByCollectionScreen').style.display = 'none';
            document.getElementById('collectionCheckupScreen').style.display = 'none';
            document.getElementById('previousOutToolsScreen').style.display = 'none';
            // Add any other sections you may have
        }

        // Login logic
        async function login() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            const alertBox = document.getElementById('loginAlert');
            alertBox.classList.add('d-none');
            if (!email || !password) {
                alertBox.textContent = 'Please fill in all fields.';
                alertBox.classList.remove('d-none');
                return;
            }
            
            // Show loading state
            const loginBtn = document.getElementById('loginBtn');
            const originalText = loginBtn.textContent;
            loginBtn.textContent = 'Signing in...';
            loginBtn.disabled = true;
            
            try {
                // First, check if this email exists in pending registrations (unverified)
const pendingRegistrationDoc = await db.collection('pendingRegistrations').doc(email).get();
if (pendingRegistrationDoc.exists) {
    // Try to sign in and reload user
    const userCredential = await auth.signInWithEmailAndPassword(email, password);
    await userCredential.user.reload();
    if (!userCredential.user.emailVerified) {
        await auth.signOut();
        throw new Error('Please verify your email address before signing in. Check your inbox for a verification email.');
    } else {
        // User is verified but still in pendingRegistrations, clean up
        const pendingData = pendingRegistrationDoc.data();
        await db.collection('technicians').doc(userCredential.user.uid).set({
            fullName: pendingData.fullName,
            email: email,
            isAdmin: false,
            lastSignIn: firebase.firestore.FieldValue.serverTimestamp(),
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        await db.collection('pendingRegistrations').doc(email).delete();
        localStorage.setItem('fullName', pendingData.fullName);
        // Continue to main menu...
        document.getElementById('loginSection').classList.add('d-none');
        hideAllMainScreens();
        document.getElementById('toolScannerMenu').style.display = 'block';
        document.getElementById('headerBranding').style.display = 'none';
        updateLoggedInTechnician();
        return;
    }
}
                
                // Now attempt to sign in
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
// Reload user to get latest verification status
await userCredential.user.reload();
if (!userCredential.user.emailVerified) {
    await auth.signOut();
    throw new Error('Please verify your email address before signing in. Check your inbox for a verification email.');
}
                
                // Check if this is the first verified login
                const pendingDoc = await db.collection('pendingRegistrations').doc(email).get();
                if (pendingDoc.exists) {
                    const pendingData = pendingDoc.data();
                    // This is the first verified login, create technician document
                    await db.collection('technicians').doc(userCredential.user.uid).set({
                        fullName: pendingData.fullName,
                        email: email,
                        isAdmin: false,
                        lastSignIn: firebase.firestore.FieldValue.serverTimestamp(),
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Remove from pending registrations
                    await db.collection('pendingRegistrations').doc(email).delete();
                    
                    // Store full name in localStorage
                    localStorage.setItem('fullName', pendingData.fullName);
                } else {
                    // Regular login, update technician data
                    await saveTechnicianToFirestore(userCredential.user);
                }
                
                // Success: hide login, show only main menu
                document.getElementById('loginSection').classList.add('d-none');
                hideAllMainScreens();
                document.getElementById('toolScannerMenu').style.display = 'block';
                document.getElementById('headerBranding').style.display = 'none';
                updateLoggedInTechnician();
            } catch (error) {
                alertBox.textContent = error.message;
                alertBox.classList.remove('d-none');
            } finally {
                // Reset button state
                loginBtn.textContent = originalText;
                loginBtn.disabled = false;
            }
        }

        // Full name validation and formatting functions
        function validateFullName(input) {
            const value = input.value;
            const validationDiv = input.id === 'signUpFullName' ? 
                document.getElementById('fullNameValidation') : 
                document.getElementById('accountNameValidation');
            
            // Remove any non-English letters and spaces immediately
            const cleanedValue = value.replace(/[^A-Za-z ]/g, '');
            if (cleanedValue !== value) {
                input.value = cleanedValue;
            }
            
            // Check if empty
            if (!cleanedValue.trim()) {
                validationDiv.textContent = '';
                validationDiv.className = 'form-text text-muted';
                return;
            }
            
            // Check if contains only valid characters
            if (!/^[A-Za-z ]+$/.test(cleanedValue)) {
                validationDiv.textContent = 'Only English letters and spaces are allowed';
                validationDiv.className = 'form-text text-danger';
                return;
            }
            
            // Check if has at least 2 characters
            if (cleanedValue.trim().length < 2) {
                validationDiv.textContent = 'Name must be at least 2 characters long';
                validationDiv.className = 'form-text text-warning';
                return;
            }
            
            // Check if has at least one space (first and last name)
            const words = cleanedValue.trim().split(' ').filter(word => word.length > 0);
            if (words.length < 2) {
                validationDiv.textContent = 'Please enter both first and last name';
                validationDiv.className = 'form-text text-warning';
                return;
            }
            
            // All validations passed
            validationDiv.textContent = ' Valid name format';
            validationDiv.className = 'form-text text-success';
        }
        
        function formatFullName(input) {
            const value = input.value.trim();
            if (!value) return;
            
            // Split into words, capitalize first letter of each word, lowercase the rest
            const formattedName = value
                .split(' ')
                .filter(word => word.length > 0)
                .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                .join(' ');
            
            input.value = formattedName;
            
            // Update validation message
            const validationDiv = input.id === 'signUpFullName' ? 
                document.getElementById('fullNameValidation') : 
                document.getElementById('accountNameValidation');
            if (formattedName && /^([A-Z][a-z]+)( [A-Z][a-z]+)+$/.test(formattedName)) {
                validationDiv.textContent = ' Name formatted correctly';
                validationDiv.className = 'form-text text-success';
            }
        }

        // Sign up logic
        async function signUp() {
            let fullName = document.getElementById('signUpFullName').value.trim();
            const email = document.getElementById('signUpEmail').value.trim();
            const password = document.getElementById('signUpPassword').value.trim();
            const confirmPassword = document.getElementById('signUpConfirmPassword').value.trim();
            const alertBox = document.getElementById('signUpAlert');
            alertBox.classList.add('d-none');

            // Final validation for full name format
            if (!fullName || !/^([A-Z][a-z]+)( [A-Z][a-z]+)+$/.test(fullName)) {
                alertBox.textContent = 'Please enter a valid full name with both first and last name (English letters only).';
                alertBox.classList.remove('d-none');
                return;
            }

            if (!fullName || !email || !password || !confirmPassword) {
                alertBox.textContent = 'Please fill in all fields.';
                alertBox.classList.remove('d-none');
                return;
            }
            if (password !== confirmPassword) {
                alertBox.textContent = 'Passwords do not match.';
                alertBox.classList.remove('d-none');
                return;
            }
            
            // Check if email already exists in pending registrations
            try {
                const pendingDoc = await db.collection('pendingRegistrations').doc(email).get();
                if (pendingDoc.exists) {
                    alertBox.textContent = 'An account with this email is already pending verification. Please check your email or try again later.';
                    alertBox.classList.remove('d-none');
                    return;
                }
            } catch (error) {
                console.error('Error checking pending registrations:', error);
            }
            
            try {
                // Create Firebase Auth account
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                
                // Send email verification
                await userCredential.user.sendEmailVerification();
                
                // Store pending registration data
                await db.collection('pendingRegistrations').doc(email).set({
                    fullName: fullName,
                    email: email,
                    uid: userCredential.user.uid,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    verified: false
                });
                
                // Sign out the user immediately to prevent access
                await auth.signOut();

                alertBox.classList.add('d-none');
                showLogin();
                alert('Account created! Please check your email and verify your account before signing in. You will not be able to sign in until you verify your email address.');
            } catch (error) {
                alertBox.textContent = error.message;
                alertBox.classList.remove('d-none');
            }
        }

        // Password reset logic
        async function resetPassword() {
            const email = document.getElementById('resetEmail').value.trim();
            const alertBox = document.getElementById('resetAlert');
            alertBox.classList.add('d-none');
            if (!email) {
                alertBox.textContent = 'Please enter your email.';
                alertBox.classList.remove('d-none');
                return;
            }
            try {
                await auth.sendPasswordResetEmail(email);
                alertBox.textContent = 'Password reset email sent!';
                alertBox.classList.remove('d-none');
            } catch (error) {
                alertBox.textContent = error.message;
                alertBox.classList.remove('d-none');
            }
        }

        // Google Sign-In function
        async function signInWithGoogle() {
            const alertBox = document.getElementById('loginAlert');
            alertBox.classList.add('d-none');
            try {
                // Create Google Auth Provider and force account selection every time
                const provider = new firebase.auth.GoogleAuthProvider();
                provider.setCustomParameters({
                    prompt: 'select_account'
                });
                // Sign in with Google
                const result = await auth.signInWithPopup(provider);
                const user = result.user;
                
                // Verify that the user has a valid email
                if (!user.email || !user.emailVerified) {
                    await auth.signOut();
                    throw new Error('Please use a verified Google account with a valid email address');
                }
                
                // Check if this is the first time login for this Google account
                const technicianDoc = await db.collection('technicians').doc(user.uid).get();
                
                if (!technicianDoc.exists) {
                    // First time login - create technician document
                    await db.collection('technicians').doc(user.uid).set({
                        fullName: user.displayName || user.email,
                        email: user.email,
                        isAdmin: false,
                        lastSignIn: firebase.firestore.FieldValue.serverTimestamp(),
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Store full name in localStorage
                    localStorage.setItem('fullName', user.displayName || user.email);
                } else {
                    // Regular login - update technician data
                    await saveTechnicianToFirestore(user);
                }
                
                // Success: hide login, show only main menu
                document.getElementById('loginSection').classList.add('d-none');
                hideAllMainScreens();
                document.getElementById('toolScannerMenu').style.display = 'block';
                document.getElementById('headerBranding').style.display = 'none';
                updateLoggedInTechnician();
            } catch (error) {
                console.error('Google Sign-In Error:', error);
                alertBox.textContent = error.message;
                alertBox.classList.remove('d-none');
            }
        }

        // Run cleanup with user feedback
        async function runCleanup() {
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'Cleaning...';
            button.disabled = true;
            
            try {
                await cleanupUnverifiedAccounts();
                alert('Cleanup completed successfully!');
            } catch (error) {
                console.error('Cleanup error:', error);
                alert('Error during cleanup: ' + error.message);
            } finally {
                button.textContent = originalText;
                button.disabled = false;
            }
        }

        // Cleanup unverified accounts (run periodically)
        async function cleanupUnverifiedAccounts() {
            try {
                const cutoffTime = new Date();
                cutoffTime.setHours(cutoffTime.getHours() - 24); // 24 hours ago
                
                const pendingDocs = await db.collection('pendingRegistrations')
                    .where('createdAt', '<', cutoffTime)
                    .get();

                const currentToolDoc = await db.collection('tools').doc(toolId).get();
                const currentToolPhotoUrls = currentToolDoc.exists ? (currentToolDoc.data().photoUrls || []) : [];
                
                const batch = db.batch();
                
                // Delete unverified Firebase Auth accounts
                for (const doc of pendingDocs.docs) {
                    const data = doc.data();
                    try {
                        // Delete the Firebase Auth account
                        await auth.deleteUser(data.uid);
                        console.log(`Deleted unverified Firebase Auth account: ${data.email}`);
                    } catch (authError) {
                        console.error(`Failed to delete Firebase Auth account for ${data.email}:`, authError);
                    }
                    
                    // Delete the pending registration document
                    batch.delete(doc.ref);
                }
                
                await batch.commit();
                console.log(`Cleaned up ${pendingDocs.docs.length} unverified accounts`);
            } catch (error) {
                console.error('Error cleaning up unverified accounts:', error);
            }
        }

        // Save technician data to Firestore
        async function saveTechnicianToFirestore(user) {
            try {
                // Check if technician already exists
                const technicianDoc = await db.collection('technicians').doc(user.uid).get();
                
                let technicianData = {
                    email: user.email,
                    lastSignIn: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                if (technicianDoc.exists) {
                    // Update existing technician
                    const existingData = technicianDoc.data();
                    technicianData = {
                        ...existingData,
                        ...technicianData
                    };
                } else {
                    // Create new technician (first time login after email verification)
                    // Get the full name from the user's display name or email
                    const fullName = user.displayName || user.email;
                    technicianData = {
                        fullName: fullName,
                        email: user.email,
                        isAdmin: false,
                        lastSignIn: firebase.firestore.FieldValue.serverTimestamp()
                    };
                }
                
                // Save to technicians collection
                await db.collection('technicians').doc(user.uid).set(technicianData, { merge: true });
                
                // Store full name in localStorage for easy access
                localStorage.setItem('fullName', technicianData.fullName || user.email);
                
                console.log('Technician data saved to Firestore');
            } catch (error) {
                console.error('Error saving technician data:', error);
                // Don't throw error here as the sign-in was successful
            }
        }

        // Logout function
        function logout() {
            auth.signOut();
            if (html5QrCode) {
                html5QrCode.clear();
            }
            localStorage.removeItem('fullName'); // Clear stored name on logout
            document.getElementById('headerBranding').style.display = 'block';
            // Hide all app sections
            document.getElementById('toolScannerMenu').style.display = 'none';
            document.getElementById('appSection').style.display = 'none';
            document.getElementById('myToolsScreen').style.display = 'none';
            document.getElementById('myToolsByCollectionScreen').style.display = 'none';
            document.getElementById('collectionCheckupScreen').style.display = 'none';
            document.getElementById('previousOutToolsScreen').style.display = 'none';
            // Show login section
            const loginSection = document.getElementById('loginSection');
            loginSection.classList.remove('d-none');
            loginSection.style.display = 'block'; // Ensure login is visible
        }

        // Toggle Admin Section
        function toggleAdmin() {
            const adminSection = document.getElementById('adminSection');
            adminSection.style.display = adminSection.style.display === 'none' ? 'block' : 'none';
        }

        // Save Tool Admin
        async function saveToolAdmin() {
            const toolId = document.getElementById('adminToolId').value.trim();
            const toolName = document.getElementById('adminToolName').value.trim();
            const partNumber = document.getElementById('adminPartNumber').value.trim();
            const location = document.getElementById('adminLocation').value.trim();

            if (!toolId || !toolName) {
                alert('Tool ID and Name are required');
                return;
            }

            try {
                await db.collection('tools').doc(toolId).set({
                    toolName: toolName,
                    partNumber: partNumber,
                    location: location,
                    status: 'IN',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                alert('Tool saved successfully');
                document.getElementById('adminToolId').value = '';
                document.getElementById('adminToolName').value = '';
                document.getElementById('adminPartNumber').value = '';
                document.getElementById('adminLocation').value = '';
            } catch (error) {
                console.error('Error saving tool:', error);
                alert('Error saving tool: ' + error.message);
            }
        }

        // Store last scanned tool data
        let lastScannedToolData = null;

        // Checkup functionality variables
        let lastViewedCollectionName = null;
        let lastViewedCollectionTools = [];
        let checkupCheckedTools = new Set();
        let checkupSelectedLocation = 'All';
        let checkupLocationStats = {};

        // Submit tool code
        async function submitCode(codeParam = null) {
            // If code is passed as parameter (from scanner), use it; otherwise read from input
            const code = codeParam || document.getElementById('toolCode').value.trim();
    console.log('Submit button pressed. Tool code:', code);
    console.log('Selected work location:', selectedWorkLocation);
    
    if (!code) {
        console.log('No tool code entered');
        return;
    }

    // Check if bulk scan mode is enabled
    if (bulkScanMode) {
        // Process immediately and add to history list
        await processToolInBulkMode(code);
        // Input already cleared in scanner callback
        return;
    }

    // Normal mode - process immediately
    // Only show location selection modal if not already set
    if (!selectedWorkLocation) {
        console.log('No work location selected, showing modal');
        showLocationSelectionModalForToolSubmission(code);
    } else {
        console.log('Work location already selected, processing tool submission');
        processToolSubmission(code);
    }
}

        // Bulk Scan Mode Functions
        function toggleBulkScanMode() {
            bulkScanMode = !bulkScanMode;
            const btn = document.getElementById('bulkScanModeBtn');
            
            if (bulkScanMode) {
                btn.style.background = 'linear-gradient(135deg, #FF9800 0%, #F57C00 100%)';
                btn.style.borderColor = '#FF9800';
                btn.style.color = 'white';
                bulkScannedTools = [];
            } else {
                btn.style.background = 'linear-gradient(135deg, #e0e0e0 0%, #bdbdbd 100%)';
                btn.style.borderColor = '#bdbdbd';
                btn.style.color = '#333';
                bulkScannedTools = [];
            }
        }
        
        async function processToolInBulkMode(code) {
            // Prevent duplicate processing
            if (bulkProcessingCodes.has(code)) {
                return; // Already processing this code
            }
            
            // Check if recently processed (within last 3 seconds)
            const now = Date.now();
            if (bulkRecentlyProcessed.has(code)) {
                const lastProcessed = bulkRecentlyProcessed.get(code);
                if (now - lastProcessed < 3000) {
                    // Clear input to prevent re-detection
                    document.getElementById('toolCode').value = '';
                    return; // Too soon, ignore
                }
            }
            
            // Mark as processing
            bulkProcessingCodes.add(code);
            
            // Clear input immediately to prevent re-detection
            document.getElementById('toolCode').value = '';
            
            try {
                const user = auth.currentUser;
                if (!user) {
                    showBulkScanMessage('Not authenticated', false);
                    bulkProcessingCodes.delete(code);
                    return;
                }
                
                // Check if already processed in this session
                if (bulkScannedTools.some(t => t.code === code)) {
                    showBulkScanMessage('Tool already processed in this session', false);
                    bulkProcessingCodes.delete(code);
                    return;
                }
                
                const toolRef = db.collection('tools').doc(code);
                const doc = await toolRef.get();
                
                if (!doc.exists) {
                    showBulkScanMessage(`Tool not found: ${code}`, false);
                    bulkProcessingCodes.delete(code);
                    return;
                }
                
                const data = doc.data();
                const technicianDoc = await db.collection('technicians').doc(user.uid).get();
                const technicianName = technicianDoc.exists ? technicianDoc.data().fullName : 'Unknown Technician';
                
                // Validation checks (same as normal mode)
                if (data.status === 'OUT' && data.technician !== technicianName) {
                    showBulkScanMessage(`Tool checked out by ${data.technician}`, false);
                    bulkProcessingCodes.delete(code);
                    return;
                }
                
                // Prevent returning previous OUT tools
                if (data.status === 'OUT' && data.timestamp && data.timestamp.toDate) {
                    const toolDate = data.timestamp.toDate();
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    if (toolDate < today) {
                        showBulkScanMessage('Tool checked out on previous day - cannot return', false);
                        bulkProcessingCodes.delete(code);
                        return;
                    }
                }
                
                // Determine new status (toggle)
                const newStatus = data.status === 'OUT' ? 'IN' : 'OUT';
                
                // Check cooldown for check-in
                if (newStatus === 'IN' && data.status === 'OUT' && data.timestamp && data.timestamp.toDate) {
                    const outTime = data.timestamp.toDate();
                    const now = new Date();
                    const diffMs = now - outTime;
                    const settingsDoc = await db.collection('settings').doc('admin').get();
                    let cooldownMinutes = 5;
                    if (settingsDoc.exists && settingsDoc.data().CheckINCooldownMinutes) {
                        cooldownMinutes = settingsDoc.data().CheckINCooldownMinutes;
                    }
                    const cooldownMs = cooldownMinutes * 60 * 1000;
                    
                    if (diffMs < cooldownMs) {
                        const remainingMinutes = Math.ceil((cooldownMs - diffMs) / 60000);
                        showBulkScanMessage(`Cooldown: Wait ${remainingMinutes} more minute(s)`, false);
                        bulkProcessingCodes.delete(code);
                        return;
                    }
                }
                
                // Check if station is selected (required for checkout)
                if (newStatus === 'OUT' && !selectedWorkLocation) {
                    showBulkScanMessage('Please select a Station first', false);
                    bulkProcessingCodes.delete(code);
                    return;
                }
                
                // Update tool
                const updateData = {
                    status: newStatus,
                    technician: technicianName,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                if (newStatus === 'OUT' && selectedWorkLocation) {
                    updateData.WorkOn = selectedWorkLocation;
                }
                
                await toolRef.update(updateData);
                
                // Log movement
                const logData = {
                    toolId: code,
                    toolName: data.toolName || 'Unknown',
                    partNumber: data.partNumber || code,
                    location: data.location || '',
                    status: newStatus,
                    technician: technicianName,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                if (newStatus === 'OUT' && selectedWorkLocation) {
                    logData.WorkOn = selectedWorkLocation;
                }
                
                await db.collection('logtoolmovements').add(logData);
                
                // Add to history list (for reference)
                bulkScannedTools.push({
                    code: code,
                    toolName: data.toolName || 'Unknown',
                    partNumber: data.partNumber || code,
                    oldStatus: data.status,
                    newStatus: newStatus,
                    timestamp: new Date()
                });
                
                // Mark as recently processed (prevents duplicate scans for 3 seconds)
                bulkRecentlyProcessed.set(code, now);
                // Remove from recently processed after 5 seconds
                setTimeout(() => {
                    bulkRecentlyProcessed.delete(code);
                }, 5000);
                
                // Show success message (2 seconds)
                showBulkScanMessage(newStatus === 'OUT' ? 'CHECKED OUT' : 'CHECKED IN', true, newStatus === 'OUT');
                
                // Visual feedback on input
                const toolCodeInput = document.getElementById('toolCode');
                toolCodeInput.style.border = '2px solid #4CAF50';
                setTimeout(() => {
                    toolCodeInput.style.border = '';
                }, 300);
                
                // Refresh tools list
                loadTools();
                
            } catch (error) {
                console.error('Error processing tool in bulk mode:', error);
                showBulkScanMessage('Error: ' + error.message, false);
            } finally {
                // Always remove from processing set
                bulkProcessingCodes.delete(code);
            }
        }
        
        // Show bulk scan message (warning or success)
        function showBulkScanMessage(message, isSuccess = false, isCheckOut = false) {
            const messageDiv = document.getElementById('bulkScanMessage');
            if (!messageDiv) {
                console.log('bulkScanMessage div not found');
                return;
            }
            
            // Ensure the message is visible and positioned correctly
            messageDiv.style.display = 'block';
            messageDiv.style.visibility = 'visible';
            messageDiv.style.opacity = '1';
            
            // Set message with tick icon for success messages
            if (isSuccess) {
                messageDiv.innerHTML = `<i class="fas fa-check-circle" style="margin-right: 8px;"></i>${message}`;
            } else {
                messageDiv.textContent = message;
            }
            
            if (isSuccess) {
                // Green for check-in, red for check-out
                if (isCheckOut) {
                    messageDiv.style.background = '#f44336'; // Red
                    messageDiv.style.color = 'white';
                    messageDiv.style.border = '2px solid #d32f2f';
                } else {
                    messageDiv.style.background = '#4CAF50'; // Green
                    messageDiv.style.color = 'white';
                    messageDiv.style.border = '2px solid #45a049';
                }
                // Show for 2 seconds
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 2000);
            } else {
                messageDiv.style.background = '#ff9800';
                messageDiv.style.color = 'white';
                messageDiv.style.border = '2px solid #F57C00';
                // Show for 2 seconds
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 2000);
            }
        }
        

        // Function to handle tool submission after location selection
        async function processToolSubmission(code) {
            console.log('processToolSubmission called with code:', code);
            try {
                console.log('Getting current user...');
                const user = auth.currentUser;
                console.log('User:', user);
                
                // Check if we're online
                if (!isOnline) {
                    console.log('Offline mode - saving tool to offline storage');
                    await handleOfflineToolSubmission(code, user);
                    return;
                }
                
                console.log('Online mode - processing normally');
                console.log('Getting tool reference...');
                const toolRef = db.collection('tools').doc(code);
                console.log('Tool reference:', toolRef);
                
                console.log('Fetching tool document...');
                const doc = await toolRef.get({ source: 'server' });
                console.log('Tool document exists:', doc.exists);

                if (doc.exists) {
                    console.log('Tool document exists, getting data...');
                    const data = doc.data();
                    console.log('Tool data:', data);
                    
                    // Get current technician name
                    console.log('Getting technician document...');
                    const technicianDoc = await db.collection('technicians').doc(user.uid).get();
                    const technicianName = technicianDoc.exists ? technicianDoc.data().fullName : 'Unknown Technician';
                    console.log('Technician name:', technicianName);

                    // Only show warning if tool is OUT and checked out by a different technician
                    if (data.status === 'OUT' && data.technician !== technicianName) {
                        // Format date
                        let checkedOutDate = 'Unknown';
                        if (data.timestamp && data.timestamp.toDate) {
                            checkedOutDate = data.timestamp.toDate().toLocaleString('en-GB', {
                                day: '2-digit', month: '2-digit', year: 'numeric',
                                hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
                            });
                        }
                        // Set modal message
                        document.getElementById('toolAlreadyCheckedOutModalBody').innerHTML =
                          `This tool was checked out by <b>${data.technician || 'Unknown Technician'}</b> on ${checkedOutDate}<br>You cannot Check Out the tool.`;
                        // Show modal
                        const modal = new bootstrap.Modal(document.getElementById('toolAlreadyCheckedOutModal'));
                        modal.show();
                        return;
                    }
                    // Prevent returning previous OUT tools (checked out before today)
                    if (data.status === 'OUT' && data.timestamp && data.timestamp.toDate) {
                        const toolDate = data.timestamp.toDate();
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        if (toolDate < today) {
                            // Show modal dialog instead of alert
                            const modal = new bootstrap.Modal(document.getElementById('toolPreviousDateModal'));
                            modal.show();
                            document.getElementById('toolCode').value = '';
                            lastScannedToolData = null;
                            document.getElementById('toolDetailsBtn').disabled = true;
                            return;
                        }
                    }
                    // Enforce cooldown for returning tools (only when checking IN)
                    if (data.status === 'OUT' && data.timestamp && data.timestamp.toDate) {
                        const outTime = data.timestamp.toDate();
                        const now = new Date();
                        const diffMs = now - outTime;
                        
                        // Fetch cooldown minutes from Firestore settings
                        const settingsDoc = await db.collection('settings').doc('admin').get();
                        let cooldownMinutes = 5; // default
                        if (settingsDoc.exists && settingsDoc.data().CheckINCooldownMinutes) {
                            cooldownMinutes = settingsDoc.data().CheckINCooldownMinutes;
                        }
                        const cooldownMs = cooldownMinutes * 60 * 1000; // Convert to milliseconds
                        
                        console.log('=== COOLDOWN DEBUG ===');
                        console.log('Tool ID:', code);
                        console.log('Tool status:', data.status);
                        console.log('Tool checkout time:', outTime.toLocaleString());
                        console.log('Current time:', now.toLocaleString());
                        console.log('Time difference (ms):', diffMs);
                        console.log('Time difference (minutes):', diffMs / 60000);
                        console.log('Cooldown required (ms):', cooldownMs);
                        console.log('Cooldown required (minutes):', cooldownMs / 60000);
                        console.log('Can return tool:', diffMs >= cooldownMs);
                        console.log('Will show warning:', diffMs < cooldownMs);
                        console.log('=====================');
                        
                        if (diffMs < cooldownMs) {
                            // Show cooldown warning modal with remaining time
                            setCooldownWarnMessage(cooldownMs - diffMs);
                            const warnModal = new bootstrap.Modal(document.getElementById('cooldownWarnModal'));
                            warnModal.show();
                            document.getElementById('toolCode').value = '';
                            lastScannedToolData = null;
                            document.getElementById('toolDetailsBtn').disabled = true;
                            return;
                        }
                    }
                    const status = data.status === 'OUT' ? 'IN' : 'OUT';
                    const timestamp = firebase.firestore.FieldValue.serverTimestamp();

                    // Show cooldown info dialog only once per day when first tool is checked OUT
                    if (status === 'OUT') {  // Check new status instead of current status
                        // Check if cooldown dialog was already shown today
                        const today = new Date().toDateString();
                        const lastShownDate = localStorage.getItem('cooldownDialogLastShown');
                        
                        if (lastShownDate !== today) {
                        // Fetch cooldown minutes from Firestore settings
                        const settingsDoc = await db.collection('settings').doc('admin').get();
                        let cooldownMinutes = 5; // default
                        if (settingsDoc.exists && settingsDoc.data().CheckINCooldownMinutes) {
                            cooldownMinutes = settingsDoc.data().CheckINCooldownMinutes;
                        }
                        // Update the modal text and title
                        document.querySelector('#cooldownInfoModal .modal-title').textContent = `Cooldown: ${cooldownMinutes} Minute${cooldownMinutes !== 1 ? 's' : ''}`;
                        document.querySelector('#cooldownInfoModal .modal-body').textContent =
                            `When you check out a tool, you must wait at least ${cooldownMinutes} minute${cooldownMinutes !== 1 ? 's' : ''} before returning it. This helps ensure accurate tool tracking. You will not see this message again today.`;
                            
                            // Store today's date to prevent showing again today
                            localStorage.setItem('cooldownDialogLastShown', today);
                            
                        const infoModal = new bootstrap.Modal(document.getElementById('cooldownInfoModal'));
                        infoModal.show();
                        }
                    }

                    // Update tool status with WorkOn field
                    const updateData = {
                        status: status,
                        technician: technicianName,
                        timestamp: timestamp
                    };
                    
                    // Add WorkOn field if a location was selected
                    console.log('Selected work location:', selectedWorkLocation);
                    if (status === 'OUT' && selectedWorkLocation) {
                        updateData.WorkOn = selectedWorkLocation;
                        console.log('Added WorkOn field to updateData:', updateData);
                    }
                    
                    await toolRef.update(updateData);

                    // Add log entry with WorkOn field
                    const logData = {
                        toolId: code,
                        toolName: data.toolName || 'Unknown',
                        partNumber: data.partNumber || code,
                        location: data.location || '',
                        status: status,
                        technician: technicianName,
                        timestamp: timestamp
                    };
                    
                    // Add WorkOn field if a location was selected
                    if (status === 'OUT' && selectedWorkLocation) {
                        logData.WorkOn = selectedWorkLocation;
                        console.log('Added WorkOn field to logData:', logData);
                    }
                    
                    await db.collection('logtoolmovements').add(logData);

                    // Show success message
                    const successMessage = status === 'OUT' ? 'Tool Checked Out Successfully!' : 'Tool Checked In Successfully!';
                    const alertDiv = document.createElement('div');
                    alertDiv.className = `alert alert-success alert-dismissible fade show`;
                    alertDiv.innerHTML = `
                        <i class="fas fa-check-circle me-2"></i>
                        ${successMessage}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    `;
                    
                    // Insert the alert at the top of the scanner view
                    const scannerView = document.getElementById('scannerView');
                    scannerView.insertBefore(alertDiv, scannerView.firstChild);
                    
                    // Auto-dismiss the alert after 3 seconds
                    setTimeout(() => {
                        if (alertDiv.parentNode) {
                            alertDiv.remove();
                        }
                    }, 3000);

                    document.getElementById('toolCode').value = '';
                    loadTools();
                    // Update previous OUT tools count after tool status change
                    updatePreviousOutToolsCount();
                    
                    // Don't clear selected work location - keep it for subsequent submissions
                    // selectedWorkLocation = null;

                    // Store last scanned tool data for modal
                    lastScannedToolData = {
                        toolName: data.toolName || 'Unknown Tool',
                        toolId: doc.id,
                        partNumber: data.partNumber || doc.id,
                        collectionCode: data.collectionCode || '',
                        location: data.location || 'N/A',
                        owner: data.owner || 'N/A',
                    };
                    document.getElementById('toolDetailsBtn').disabled = false;
                } else {
                    alert('Warning: This tool does not exist in the system. Please contact an administrator to add the tool.');
                    document.getElementById('toolCode').value = '';
                    lastScannedToolData = null;
                    document.getElementById('toolDetailsBtn').disabled = true;
                }
            } catch (error) {
                console.error('Error processing tool submission:', error);
                alert('Error processing tool submission. Please try again.');
                document.getElementById('toolCode').value = '';
            }
        }

        // Load today's tools
        async function loadTools() {
            const user = auth.currentUser;
            if (!user) {
                console.log('loadTools: No user logged in');
                return;
            }

            try {
                console.log('loadTools: Starting to load tools...');
                
                // Get technician name
                const technicianDoc = await db.collection('technicians').doc(user.uid).get();
                const technicianName = technicianDoc.exists ? technicianDoc.data().fullName : 'Unknown Technician';
                console.log('loadTools: Technician name:', technicianName);

                const today = new Date();
                today.setHours(0, 0, 0, 0);
                console.log('loadTools: Today date:', today);

                const snapshot = await db.collection('tools')
                    .where('technician', '==', technicianName)
                    .where('timestamp', '>=', today)
                    .get();

                console.log('loadTools: Found', snapshot.size, 'tools');

                const toolList = document.getElementById('toolList');
                if (!toolList) {
                    console.error('loadTools: toolList element not found!');
                    return;
                }
                // Preserve the header with analytics button, only clear the tools container
                const headerDiv = toolList.querySelector('div[style*="display: flex"]');
                if (!headerDiv) {
                    // If header doesn't exist, create it
                    toolList.innerHTML = `
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                            <h4 style="font-size: 1.5rem; font-weight: bold; margin: 0;">Today's Scanned Tools</h4>
                            <button id="todayAnalyticsBtn" onclick="showTodayAnalytics()" class="btn-analytics" title="View Today's Analytics">
                                <i class="fas fa-chart-bar"></i>
                            </button>
                        </div>
                        <div id="toolsContainer"></div>
                    `;
                } else {
                    // Clear only the tools container, preserve header
                    let toolsContainer = toolList.querySelector('#toolsContainer');
                    if (!toolsContainer) {
                        toolsContainer = document.createElement('div');
                        toolsContainer.id = 'toolsContainer';
                        toolList.appendChild(toolsContainer);
                    }
                    toolsContainer.innerHTML = '';
                }

                let allTools = [];

                // Add online tools
                if (!snapshot.empty) {
                    snapshot.docs.forEach(doc => {
                        allTools.push({
                            id: doc.id,
                            data: doc.data(),
                            isOffline: false,
                            doc: doc
                        });
                    });
                }

                // Add offline tools
                try {
                    const offlineTools = await getOfflineTools();
                    offlineTools.forEach(tool => {
                        allTools.push({
                            id: tool.id,
                            data: tool.data,
                            isOffline: true
                        });
                    });
                } catch (error) {
                    console.error('Error loading offline tools:', error);
                }

                const toolsContainer = toolList.querySelector('#toolsContainer') || toolList;

                if (allTools.length === 0) {
                    toolsContainer.innerHTML = '<p>No tools scanned today.</p>';
                    return;
                }

                // Sort tools: OUT first, then IN, and by timestamp within each group
                allTools.sort((a, b) => {
                    const aData = a.data;
                    const bData = b.data;
                    // First sort by status (OUT before IN)
                    if (aData.status !== bData.status) {
                        return aData.status === 'OUT' ? -1 : 1;
                    }
                    // Then sort by timestamp (newest first)
                    const aTime = aData.timestamp ? (aData.timestamp.toDate ? aData.timestamp.toDate() : new Date(aData.timestamp)) : new Date(0);
                    const bTime = bData.timestamp ? (bData.timestamp.toDate ? bData.timestamp.toDate() : new Date(bData.timestamp)) : new Date(0);
                    return bTime - aTime;
                });

                allTools.forEach((tool, index) => {
                    const data = tool.data;
                    const status = (data.status || '').toUpperCase();
                    let statusClass = 'in';
                    if (status === 'OUT') statusClass = 'out';
                    else if (status === 'BROKEN') statusClass = 'broken';
                    else if (status === 'LOST') statusClass = 'lost';
                    else if (status === 'CALIBRATION') statusClass = 'calibration';

                    const time = data.timestamp ? 
                        (data.timestamp.toDate ? 
                            data.timestamp.toDate().toLocaleString('en-GB', {
                                day: '2-digit',
                                month: '2-digit',
                                year: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit',
                                second: '2-digit',
                                hour12: false
                            }) : 
                            new Date(data.timestamp).toLocaleString('en-GB', {
                                day: '2-digit',
                                month: '2-digit',
                                year: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit',
                                second: '2-digit',
                                hour12: false
                            })
                        ) : 'N/A';

                    const card = document.createElement('div');
                    card.className = `register-tool-card ${statusClass}`;
                    if (tool.isOffline) {
                        card.style.border = '2px dashed #ffc107';
                        card.style.background = '#fff3cd';
                    }
                    
                    card.onclick = function() {
                        if (tool.isOffline) {
                            // Show offline tool details
                            showOfflineToolDetails(tool);
                        } else {
                            showToolDetails(buildToolDetailsObject(tool.doc, data), 'registerTools');
                        }
                    };
                    
                    const offlineIndicator = tool.isOffline ? ' (Offline)' : '';
                    const workOnValue = data.WorkOn ? data.WorkOn : 'N/A';
                    const serialNumber = data.serialNumber || data.partNumber || 'N/A';
                    const calDueDate = data.calDueDate && data.calDueDate.toDate 
                        ? data.calDueDate.toDate().toLocaleDateString('en-GB')
                        : 'N/A';
                    
                    // Determine status color
                    const statusColor = status === 'IN' ? 'green' : 'red';
                    
                    card.innerHTML = `
                        <div style="font-weight: bold; font-size: 1.1rem; margin-bottom: 4px; color: #000; text-align: left; line-height: 1.2;">
                            ${index + 1}. ${data.toolName || 'Unknown Tool'}${offlineIndicator}
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; line-height: 1.2;">
                            <div style="color: #666; font-size: 0.9rem;">
                                ${time}
                            </div>
                            <div>
                                <span style="color: black; font-weight: bold;">WorkOn:</span> 
                                <span style="color: #666; font-weight: bold;">${workOnValue}</span>
                            </div>
                            </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 3px; line-height: 1.2;">
                            <div style="text-align: left;">
                                <span style="color: black; font-weight: bold; text-decoration: underline;">TID</span>
                            </div>
                            <div style="text-align: center;">
                                <span style="color: black; font-weight: bold; text-decoration: underline;">P/N</span>
                            </div>
                            <div style="text-align: right;">
                                <span style="color: black; font-weight: bold; text-decoration: underline;">STS</span>
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 3px; line-height: 1.2;">
                            <div style="text-align: left;">
                                <span style="color: #666; font-weight: bold;">${tool.id}</span>
                            </div>
                            <div style="text-align: center;">
                                <span style="color: #666; font-weight: bold;">${serialNumber}</span>
                            </div>
                            <div style="text-align: right;">
                                <span class="badge bg-${status === 'IN' ? 'success' : 'danger'}" style="font-weight: bold; border-radius: 15px; padding: 4px 8px;">${status}</span>
                            </div>
                        </div>
                        <div style="margin-bottom: 6px; text-align: left; line-height: 1.2;">
                            <span style="color: black; font-weight: bold;">Cal Due Date:</span> 
                            <span style="color: blue; font-weight: bold;">${calDueDate}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; gap: 8px;">
                            <div style="color: blue; font-weight: normal; cursor: pointer; text-align: left;">
                                Click For Details
                            </div>
                            ${status === 'OUT' ? `<div id="countdown-${tool.id}" class="cooldown-countdown" style="background: #FF9800; color: white; padding: 6px 8px; border-radius: 4px; font-weight: bold; text-align: center; white-space: nowrap;" onclick="event.stopPropagation();">
                                <span style="font-weight: bold;">Check-in in:</span> <span class="countdown-value">Loading...</span>
                            </div>` : ''}
                        </div>
                    `;
                    toolsContainer.appendChild(card);
                    
                    // Start countdown for OUT tools
                    if (status === 'OUT' && data.timestamp && data.timestamp.toDate) {
                        startCooldownCountdown(tool.id, data.timestamp.toDate());
                    }
                });
                
                console.log('loadTools: Successfully loaded', allTools.length, 'tools');
            } catch (error) {
                console.error('loadTools: Error loading tools:', error);
                const toolList = document.getElementById('toolList');
                if (toolList) {
                    const toolsContainer = toolList.querySelector('#toolsContainer') || toolList;
                    toolsContainer.innerHTML = '<p class="text-danger">Error loading tools. Please try again.</p>';
                }
            }
        }

        // Show Today's Analytics
        async function showTodayAnalytics() {
            try {
                const user = firebase.auth().currentUser;
                if (!user) return;

                // Get technician name
                const technicianDoc = await db.collection('technicians').doc(user.uid).get();
                const technicianName = technicianDoc.exists ? technicianDoc.data().fullName : 'Unknown Technician';

                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const snapshot = await db.collection('tools')
                    .where('technician', '==', technicianName)
                    .where('timestamp', '>=', today)
                    .get();

                let allTools = [];
                if (!snapshot.empty) {
                    snapshot.docs.forEach(doc => {
                        allTools.push(doc.data());
                    });
                }

                // Calculate analytics
                const totalTools = allTools.length;
                const outTools = allTools.filter(t => t.status === 'OUT').length;
                const inTools = allTools.filter(t => t.status === 'IN').length;

                // Create modal HTML
                const modalHtml = `
                    <div class="modal fade" id="todayAnalyticsModal" tabindex="-1" aria-labelledby="todayAnalyticsModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header bg-primary text-white">
                                    <h5 class="modal-title" id="todayAnalyticsModalLabel">
                                        <i class="fas fa-chart-bar"></i> Today's Analytics
                                    </h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="row mb-3">
                                        <div class="col-md-4 mb-2">
                                            <div class="card bg-primary text-white">
                                                <div class="card-body text-center">
                                                    <h3>${totalTools}</h3>
                                                    <p class="mb-0">Total Scanned Tools</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <div class="card bg-success text-white">
                                                <div class="card-body text-center">
                                                    <h3>${inTools}</h3>
                                                    <p class="mb-0">Check In</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <div class="card bg-danger text-white">
                                                <div class="card-body text-center">
                                                    <h3>${outTools}</h3>
                                                    <p class="mb-0">Check Out</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Remove existing modal if any
                const existingModal = document.getElementById('todayAnalyticsModal');
                if (existingModal) existingModal.remove();

                // Add and show modal
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                const modal = new bootstrap.Modal(document.getElementById('todayAnalyticsModal'));
                modal.show();

                // Clean up after hide
                document.getElementById('todayAnalyticsModal').addEventListener('hidden.bs.modal', function() {
                    this.remove();
                });

            } catch (error) {
                console.error('Error loading analytics:', error);
                alert('Error loading analytics: ' + error.message);
            }
        }

        // Show offline tool details
        function showOfflineToolDetails(tool) {
            const modal = new bootstrap.Modal(document.getElementById('toolDetailsModal'));
            const modalBody = document.getElementById('toolDetailsBody');
            
            const time = tool.data.timestamp ? 
                new Date(tool.data.timestamp).toLocaleString('en-GB', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                }) : 'N/A';
            
            modalBody.innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-wifi-slash me-2"></i>
                    This tool was saved offline and will be synced when connection is restored.
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <strong>Tool ID:</strong> ${tool.id}<br>
                        <strong>Tool Name:</strong> ${tool.data.toolName || 'Unknown Tool'}<br>
                        <strong>Part Number:</strong> ${tool.data.partNumber || tool.id}<br>
                        <strong>Status:</strong> <span class="badge bg-warning">${tool.data.status || 'OUT'}</span>
                    </div>
                    <div class="col-md-6">
                        <strong>Technician:</strong> ${tool.data.technician || 'Unknown'}<br>
                        <strong>Work Location:</strong> ${tool.data.WorkOn || 'Unknown'}<br>
                        <strong>Timestamp:</strong> ${time}<br>
                        <strong>Collection:</strong> ${tool.data.collectionName || 'Default Collection'}
                    </div>
                </div>
            `;
            
            modal.show();
        }

        // Load previous out tools
        async function loadPreviousTools() {
            const user = auth.currentUser;
            if (!user) return;

            try {
                // Get technician name
                const technicianDoc = await db.collection('technicians').doc(user.uid).get();
                const technicianName = technicianDoc.exists ? technicianDoc.data().fullName : 'Unknown Technician';

                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const snapshot = await db.collection('tools')
                    .where('technician', '==', technicianName)
                    .where('status', '==', 'OUT')
                    .get();

                const previousList = document.getElementById('previousToolsList');
                previousList.innerHTML = '<h4 class="tool-title">Previous OUT Tools (Total: 0)</h4><p>No previous OUT tools found.</p>';

                if (snapshot.empty) {
                    previousList.innerHTML = '<h4 class="tool-title">Previous OUT Tools (Total: 0)</h4><p>No previous OUT tools found.</p>';
                    document.getElementById('previous-tab').innerHTML = '<i class="fas fa-history"></i> Previous Tools (0)';
                    return;
                }

                const previousTools = snapshot.docs
                    .filter(doc => {
                        const data = doc.data();
                        return data.timestamp && typeof data.timestamp.toDate === 'function' && data.timestamp.toDate() < today;
                    })
                    .sort((a, b) => {
                        const aTime = a.data().timestamp && typeof a.data().timestamp.toDate === 'function' ? a.data().timestamp.toDate() : 0;
                        const bTime = b.data().timestamp && typeof b.data().timestamp.toDate === 'function' ? b.data().timestamp.toDate() : 0;
                        return bTime - aTime;
                    });

                if (previousTools.length === 0) {
                    previousList.innerHTML = '<h4 class="tool-title">Previous OUT Tools (Total: 0)</h4><p>No previous OUT tools found.</p>';
                    document.getElementById('previous-tab').innerHTML = '<i class="fas fa-history"></i> Previous Tools (0)';
                    return;
                }

                previousList.innerHTML = `<h4 class="tool-title">Previous OUT Tools (Total: ${previousTools.length})</h4>`;
                document.getElementById('previous-tab').innerHTML = `<i class="fas fa-history"></i> Previous Tools (${previousTools.length})`;
                let count = 0;
                previousTools.forEach((doc, index) => {
                    const data = doc.data();
                    const div = document.createElement('div');
                    count++;
                    const evenOdd = count % 2 === 0 ? 'even' : 'odd';
                    
                    div.className = `tool-item tool-out-${evenOdd}`;
                    div.style.cursor = 'pointer';
                    div.onclick = function() {
                        showToolDetails(buildToolDetailsObject(doc, data), 'previousOut');
                    };
                    const date = data.timestamp.toDate();
                    const formattedDate = date.toLocaleString('en-GB', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: false
                    });
                    
                    const workOnValue = data.WorkOn || 'N/A';
                    
                    div.innerHTML = `
                        <div class="tool-name tool-out-text">
                            ${index + 1}. ${data.toolName || 'Unknown Tool'}
                        </div>
                        <div class="previous-out-tool-date" style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
                            <span>${formattedDate}</span>
                            <span style="font-size:1em;font-weight:bold;color:#222;display:inline-block;">WorkOn: <span style="color:#888;font-weight:bold;">${workOnValue}</span></span>
                        </div>
                        <div class="tool-headers">
                            <div class="row">
                                <div class="col-4">TID</div>
                                <div class="col-4">P/N</div>
                                <div class="col-4">STS</div>
                            </div>
                        </div>
                        <div class="tool-values tool-out-text">
                            <div class="row">
                                <div class="col-4 tool-id-value">${doc.id}</div>
                                <div class="col-4 tool-pn-value">${data.partNumber || doc.id}</div>
                                <div class="col-4">
                                    <span class="status-badge status-out">OUT</span>
                                </div>
                            </div>
                        </div>
                    `;
                    previousList.appendChild(div);
                });
                // Debug log to help diagnose data issues
                console.log('Previous OUT tools snapshot:', snapshot.docs.map(doc => doc.data()));
            } catch (error) {
                console.error('Error loading previous tools:', error);
                const previousList = document.getElementById('previousToolsList');
                previousList.innerHTML = '<h4 class="tool-title">Previous OUT Tools</h4><p class="text-danger">Error loading previous tools. Please try again.</p>';
            }
        }

        // QR Code Scanner
        function startScanner() {
            // Check if basic scanner is already running - toggle it off
            if (html5QrCode) {
                stopCamera();
                return;
            }
            
            // Stop enhanced scanner if running
            if (enhancedScannerStream) {
                enhancedScannerStream.getTracks().forEach(track => track.stop());
                enhancedScannerStream = null;
            }
            if (enhancedScannerInterval) {
                if (enhancedScannerInterval.html5QrCode) {
                    enhancedScannerInterval.html5QrCode.clear();
                }
                clearInterval(enhancedScannerInterval);
                enhancedScannerInterval = null;
            }
            
            // Toggle active states
            document.getElementById('basicScannerBtn').classList.add('active');
            document.getElementById('advancedScannerBtn').classList.remove('active');
            
            var reader = document.getElementById('reader');
            reader.style.display = 'block';
            reader.style.height = '320px';
            
            html5QrCode = new Html5Qrcode("reader");
            // Basic Scanner: Simple configuration with common formats only
            const config = {
                fps: 10,
                qrbox: { width: 250, height: 250 }, // Square QR box
                aspectRatio: 1.0, // Square aspect ratio
                formatsToSupport: [
                    Html5QrcodeSupportedFormats.QR_CODE,
                    Html5QrcodeSupportedFormats.CODE_128,
                    Html5QrcodeSupportedFormats.CODE_39,
                    Html5QrcodeSupportedFormats.EAN_13,
                    Html5QrcodeSupportedFormats.EAN_8,
                    Html5QrcodeSupportedFormats.UPC_A,
                    Html5QrcodeSupportedFormats.UPC_E
                ]
            };

            // Try to use the environment camera (back camera) first
            html5QrCode.start(
                { facingMode: "environment" },
                config,
                (decodedText) => {
                    const toolCodeInput = document.getElementById('toolCode');
                    toolCodeInput.value = decodedText;
                    document.getElementById('toolDetailsBtn').disabled = false;
                    if (bulkScanMode) {
                        // In bulk mode, pass code directly and clear input
                        toolCodeInput.value = '';
                        setTimeout(() => submitCode(decodedText), 50);
                    } else {
                    stopCamera();
                    }
                },
                (errorMessage) => {
                    // Ignore errors during scanning
                }
            ).catch(err => {
                // If environment camera fails, try user camera (front camera)
                html5QrCode.start(
                    { facingMode: "user" },
                    config,
                    (decodedText) => {
                        document.getElementById('toolCode').value = decodedText;
                        document.getElementById('toolDetailsBtn').disabled = false;
                        if (bulkScanMode) {
                            // In bulk mode, pass code directly and keep scanning
                            const code = decodedText;
                            document.getElementById('toolCode').value = '';
                            setTimeout(() => submitCode(code), 50);
                        } else {
                        stopCamera();
                        }
                    },
                    (errorMessage) => {
                        // Ignore errors during scanning
                    }
                ).catch(err => {
                    alert('Camera error: ' + err);
                    stopCamera();
                });
            });
        }

        function stopCamera() {
            // Remove active states
            document.getElementById('basicScannerBtn').classList.remove('active');
            document.getElementById('advancedScannerBtn').classList.remove('active');
            
            // Stop basic scanner
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    html5QrCode.clear();
                }).catch(err => {
                    console.log('Error stopping basic scanner:', err);
                });
                html5QrCode = null;
            }
            
            // Stop advanced scanner
            if (enhancedScannerStream) {
                enhancedScannerStream.getTracks().forEach(track => track.stop());
                enhancedScannerStream = null;
            }
            
            if (enhancedScannerInterval) {
                if (enhancedScannerInterval.html5QrCode) {
                    enhancedScannerInterval.html5QrCode.clear();
                }
                clearInterval(enhancedScannerInterval);
                enhancedScannerInterval = null;
            }
            
            // Clean up temp div
            const tempDiv = document.getElementById('enhancedScannerTemp');
            if (tempDiv) {
                tempDiv.remove();
            }
            
            enhancedScannerCanvas = null;
            enhancedScannerContext = null;
            
            // Hide advanced controls
            const controls = document.getElementById('advancedScannerControls');
            const bottomControls = document.getElementById('advancedScannerBottomControls');
            if (controls) controls.style.display = 'none';
            if (bottomControls) bottomControls.style.display = 'none';
            
            var reader = document.getElementById('reader');
            // Immediately hide and collapse the scanner area
            reader.style.display = 'none';
            reader.style.height = '0';
            
            // Reset state
            currentZoom = 1.0;
            torchEnabled = false;
            enhancedScannerVideo = null;
        }

        // Enhanced Scanner Functions
        let enhancedScannerStream = null;
        let enhancedScannerVideo = null;
        let enhancedScannerCanvas = null;
        let enhancedScannerContext = null;
        let enhancedScannerInterval = null;
        let currentZoom = 1.0;
        let torchEnabled = false;
        let focusIndicator = null;

        async function startEnhancedScanner() {
            // Check if advanced scanner is already running - toggle it off
            if (enhancedScannerStream || enhancedScannerInterval) {
                stopCamera();
                return;
            }
            
            // Stop basic scanner if running
            if (html5QrCode) {
                try {
                    await html5QrCode.stop();
                    html5QrCode.clear();
                    html5QrCode = null;
                } catch (err) {
                    console.log('Error stopping basic scanner:', err);
                }
            }
            
            // Toggle active states
            document.getElementById('advancedScannerBtn').classList.add('active');
            document.getElementById('basicScannerBtn').classList.remove('active');
            
            var reader = document.getElementById('reader');
            reader.style.display = 'block';
            reader.style.height = '320px';
            reader.style.position = 'relative';
            
            // Clear reader content but preserve the structure
            // Remove all child elements except the ones we'll recreate
            while (reader.firstChild) {
                reader.removeChild(reader.firstChild);
            }
            
            // Create video element
            const video = document.createElement('video');
            video.id = 'enhancedScannerVideo';
            video.style.width = '100%';
            video.style.height = '100%';
            video.style.objectFit = 'cover';
            video.autoplay = true;
            video.playsInline = true;
            video.muted = true;
            reader.appendChild(video);
            
            // Re-add controls
            const controlsDiv = document.createElement('div');
            controlsDiv.id = 'advancedScannerControls';
            controlsDiv.style.cssText = 'display: block; position: absolute; top: 10px; right: 10px; z-index: 10;';
            controlsDiv.innerHTML = `
                <button id="torchBtn" class="btn btn-sm" style="background: rgba(0,0,0,0.5); color: white; border: none; margin-bottom: 5px; border-radius: 50%; width: 40px; height: 40px; padding: 0;" title="Toggle Torch">
                    <i class="fas fa-star"></i>
                </button>
            `;
            reader.appendChild(controlsDiv);
            
            const bottomControlsDiv = document.createElement('div');
            bottomControlsDiv.id = 'advancedScannerBottomControls';
            bottomControlsDiv.style.cssText = 'display: flex; position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); z-index: 10; background: rgba(0,0,0,0.5); padding: 8px; border-radius: 20px; align-items: center;';
            bottomControlsDiv.innerHTML = `
                <button id="zoomOutBtn" class="btn btn-sm" style="background: transparent; color: white; border: 1px solid white; border-radius: 50%; width: 35px; height: 35px; padding: 0; margin-right: 10px;" title="Zoom Out">
                    <i class="fas fa-search-minus"></i>
                </button>
                <span id="zoomLevel" style="color: white; font-weight: bold; margin: 0 10px; min-width: 50px; display: inline-block; text-align: center;">1.0x</span>
                <button id="zoomInBtn" class="btn btn-sm" style="background: transparent; color: white; border: 1px solid white; border-radius: 50%; width: 35px; height: 35px; padding: 0; margin-left: 10px;" title="Zoom In">
                    <i class="fas fa-search-plus"></i>
                </button>
            `;
            reader.appendChild(bottomControlsDiv);
            
            const focusIndicator = document.createElement('div');
            focusIndicator.id = 'focusIndicator';
            focusIndicator.style.cssText = 'display: none; position: absolute; width: 60px; height: 60px; border: 2px solid #4CAF50; border-radius: 50%; pointer-events: none; z-index: 15;';
            reader.appendChild(focusIndicator);
            
            // Reset state
            currentZoom = 1.0;
            torchEnabled = false;
            enhancedScannerVideo = video;
            updateZoomDisplay();
            updateTorchButton();
            
            try {
                // Request camera with high quality
                const constraints = {
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    }
                };
                
                enhancedScannerStream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = enhancedScannerStream;
                
                // Wait for video to load
                await new Promise((resolve) => {
                    video.onloadedmetadata = () => {
                        video.play();
                        resolve();
                    };
                });
                
                // Setup event handlers
                setupAdvancedScannerEvents();
                
                // Start barcode detection
                startAdvancedBarcodeDetection();
                
            } catch (error) {
                console.error('Enhanced scanner error:', error);
                // Try fallback to user camera
                try {
                    const fallbackConstraints = {
                        video: {
                            facingMode: 'user',
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        }
                    };
                    
                    enhancedScannerStream = await navigator.mediaDevices.getUserMedia(fallbackConstraints);
                    video.srcObject = enhancedScannerStream;
                    
                    await new Promise((resolve) => {
                        video.onloadedmetadata = () => {
                            video.play();
                            resolve();
                        };
                    });
                    
                    setupAdvancedScannerEvents();
                    startAdvancedBarcodeDetection();
                } catch (fallbackErr) {
                    console.error('Enhanced scanner fallback error:', fallbackErr);
                    alert('Failed to start enhanced scanner: ' + fallbackErr.message);
                    stopCamera();
                }
            }
        }

        function closeEnhancedScanner() {
            // Enhanced scanner now uses the same reader div, so just call stopCamera
            stopCamera();
        }

        // Advanced Scanner Helper Functions
        function setupAdvancedScannerEvents() {
            const reader = document.getElementById('reader');
            const video = document.getElementById('enhancedScannerVideo');
            
            // Zoom buttons
            const zoomInBtn = document.getElementById('zoomInBtn');
            const zoomOutBtn = document.getElementById('zoomOutBtn');
            if (zoomInBtn) {
                zoomInBtn.onclick = () => {
                    if (currentZoom < 3.0) {
                        currentZoom = Math.min(3.0, currentZoom + 0.5);
                        updateZoomDisplay();
                        applyZoom();
                    }
                };
            }
            if (zoomOutBtn) {
                zoomOutBtn.onclick = () => {
                    if (currentZoom > 1.0) {
                        currentZoom = Math.max(1.0, currentZoom - 0.5);
                        updateZoomDisplay();
                        applyZoom();
                    }
                };
            }
            
            // Torch button
            const torchBtn = document.getElementById('torchBtn');
            if (torchBtn) {
                torchBtn.onclick = toggleTorch;
            }
            
            // Tap to focus
            if (video) {
                video.onclick = (e) => {
                    const rect = video.getBoundingClientRect();
                    const readerRect = reader.getBoundingClientRect();
                    const x = e.clientX - readerRect.left;
                    const y = e.clientY - readerRect.top;
                    showFocusIndicator(x, y);
                    applyFocus(x, y, rect.width, rect.height);
                };
            }
            
            // Pinch to zoom
            let initialDistance = 0;
            let initialZoom = currentZoom;
            
            reader.addEventListener('touchstart', (e) => {
                if (e.touches.length === 2) {
                    initialDistance = getDistance(e.touches[0], e.touches[1]);
                    initialZoom = currentZoom;
                }
            });
            
            reader.addEventListener('touchmove', (e) => {
                if (e.touches.length === 2) {
                    e.preventDefault();
                    const currentDistance = getDistance(e.touches[0], e.touches[1]);
                    const scale = currentDistance / initialDistance;
                    const newZoom = Math.max(1.0, Math.min(3.0, initialZoom * scale));
                    
                    if (Math.abs(newZoom - currentZoom) > 0.05) {
                        currentZoom = newZoom;
            updateZoomDisplay();
                        applyZoom();
                    }
                }
            });
        }
        
        function startAdvancedBarcodeDetection() {
            // Create hidden canvas for frame capture
            if (!enhancedScannerCanvas) {
                enhancedScannerCanvas = document.createElement('canvas');
                enhancedScannerContext = enhancedScannerCanvas.getContext('2d');
            }
            
            // Create Html5Qrcode instance for file scanning
            if (!enhancedScannerInterval) {
                const tempDiv = document.createElement('div');
                tempDiv.id = 'enhancedScannerTemp';
                tempDiv.style.position = 'absolute';
                tempDiv.style.top = '-9999px';
                tempDiv.style.left = '-9999px';
                document.body.appendChild(tempDiv);
                
                const enhancedHtml5QrCode = new Html5Qrcode("enhancedScannerTemp");
                
                // Scan frames periodically
                enhancedScannerInterval = setInterval(() => {
                    if (!enhancedScannerVideo || enhancedScannerVideo.readyState !== enhancedScannerVideo.HAVE_ENOUGH_DATA) {
                        return;
                    }
                    
                    try {
                        // Capture frame to canvas
                        enhancedScannerCanvas.width = enhancedScannerVideo.videoWidth;
                        enhancedScannerCanvas.height = enhancedScannerVideo.videoHeight;
                        enhancedScannerContext.drawImage(enhancedScannerVideo, 0, 0);
                        
                        // Convert to blob and scan
                        enhancedScannerCanvas.toBlob((blob) => {
                            if (blob) {
                                const file = new File([blob], 'frame.jpg', { type: 'image/jpeg' });
                                enhancedHtml5QrCode.scanFile(file, false)
                                    .then(decodedText => {
                                        const toolCodeInput = document.getElementById('toolCode');
                                        toolCodeInput.value = decodedText;
                                        document.getElementById('toolDetailsBtn').disabled = false;
                                        if (bulkScanMode) {
                                            // In bulk mode, pass code directly and clear input
                                            toolCodeInput.value = '';
                                            setTimeout(() => submitCode(decodedText), 50);
                                        } else {
                                            stopCamera();
                                        }
                                    })
                                    .catch(() => {
                                        // Ignore scan errors
                                    });
                            }
                        }, 'image/jpeg', 0.8);
                    } catch (error) {
                        // Ignore errors
                    }
                }, 200); // Scan every 200ms (5 FPS for detection)
                
                // Store reference for cleanup
                enhancedScannerInterval.html5QrCode = enhancedHtml5QrCode;
            }
        }
        
        function toggleTorch() {
            if (!enhancedScannerStream) return;
            
            const track = enhancedScannerStream.getVideoTracks()[0];
            if (!track) return;
            
            const capabilities = track.getCapabilities();
            if (!capabilities.torch) {
                console.log('Torch not supported');
                return;
            }
            
            torchEnabled = !torchEnabled;
            track.applyConstraints({
                advanced: [{ torch: torchEnabled }]
            }).then(() => {
            updateTorchButton();
            }).catch(error => {
                console.log('Torch toggle failed:', error);
                torchEnabled = !torchEnabled; // Revert
            });
        }
        
        function updateTorchButton() {
            const torchBtn = document.getElementById('torchBtn');
            if (torchBtn) {
                if (torchEnabled) {
                    torchBtn.style.background = 'rgba(255, 193, 7, 0.8)';
                    torchBtn.style.color = '#000';
                } else {
                    torchBtn.style.background = 'rgba(0,0,0,0.5)';
                    torchBtn.style.color = 'white';
                }
            }
        }
        
        function applyFocus(x, y, width, height) {
            if (!enhancedScannerStream) return;
            
            const track = enhancedScannerStream.getVideoTracks()[0];
            if (!track) return;
            
            const capabilities = track.getCapabilities();
            
            // Normalize coordinates (0-1)
            const pointX = x / width;
            const pointY = y / height;
            
            // Try different focus methods based on what's supported
            const constraints = {};
            
            // Method 1: Use pointsOfInterest (most common)
            if (capabilities.pointsOfInterest !== undefined) {
                constraints.pointsOfInterest = [{ x: pointX, y: pointY }];
            }
            
            // Method 2: Use focusPointOfInterest if available
            if (capabilities.focusPointOfInterest !== undefined) {
                constraints.focusPointOfInterest = { x: pointX, y: pointY };
            }
            
            // Method 3: Use exposurePointOfInterest for exposure/focus
            if (capabilities.exposurePointOfInterest !== undefined) {
                constraints.exposurePointOfInterest = { x: pointX, y: pointY };
            }
            
            // Apply focus mode - use 'single-shot' for tap-to-focus (focuses once then returns to auto)
            if (capabilities.focusMode) {
                if (capabilities.focusMode.includes('single-shot')) {
                    constraints.focusMode = 'single-shot';
                } else if (capabilities.focusMode.includes('continuous')) {
                    // If single-shot not available, use continuous
                    constraints.focusMode = 'continuous';
                }
            }
            
            // Apply constraints if we have any
            if (Object.keys(constraints).length > 0) {
                track.applyConstraints({
                    advanced: [constraints]
                }).catch(error => {
                    console.log('Focus not supported:', error);
                    // Fallback: try without focusMode
                    if (constraints.focusMode) {
                        delete constraints.focusMode;
                        track.applyConstraints({
                            advanced: [constraints]
                        }).catch(err => {
                            console.log('Focus fallback failed:', err);
                        });
                    }
                });
            }
        }
        
        function showFocusIndicator(x, y) {
            const indicator = document.getElementById('focusIndicator');
            if (indicator) {
                indicator.style.left = (x - 30) + 'px';
                indicator.style.top = (y - 30) + 'px';
                indicator.style.display = 'block';
                
                setTimeout(() => {
                    if (indicator) {
                        indicator.style.display = 'none';
                    }
                }, 2000);
            }
        }
        
        function applyZoom() {
            if (!enhancedScannerStream) return;
            
            const track = enhancedScannerStream.getVideoTracks()[0];
            if (!track) return;
            
            const capabilities = track.getCapabilities();
            if (capabilities.zoom) {
                const zoomValue = Math.max(capabilities.zoom.min || 1, Math.min(capabilities.zoom.max || 3, currentZoom));
                track.applyConstraints({
                    advanced: [{ zoom: zoomValue }]
                }).catch(error => {
                    console.log('Zoom not supported:', error);
                    // Fallback: CSS zoom
                    const video = document.getElementById('enhancedScannerVideo');
                    if (video) {
                        video.style.transform = `scale(${currentZoom})`;
                        video.style.transformOrigin = 'center center';
                    }
                });
            } else {
                // Fallback: CSS zoom
                const video = document.getElementById('enhancedScannerVideo');
                if (video) {
                    video.style.transform = `scale(${currentZoom})`;
                    video.style.transformOrigin = 'center center';
                }
            }
        }

        function startBarcodeDetection() {
            // Create a temporary div for the enhanced scanner
            const tempDiv = document.createElement('div');
            tempDiv.id = 'enhancedScannerTemp';
            tempDiv.style.position = 'absolute';
            tempDiv.style.top = '-9999px';
            tempDiv.style.left = '-9999px';
            document.body.appendChild(tempDiv);
            
            // Create a new Html5Qrcode instance for the enhanced scanner
            const enhancedHtml5QrCode = new Html5Qrcode("enhancedScannerTemp");
            
            const config = {
                fps: 10,
                qrbox: { width: 200, height: 200 },
                aspectRatio: 1.0,
                formatsToSupport: [
                    Html5QrcodeSupportedFormats.QR_CODE,
                    Html5QrcodeSupportedFormats.CODE_128,
                    Html5QrcodeSupportedFormats.CODE_39,
                    Html5QrcodeSupportedFormats.EAN_13,
                    Html5QrcodeSupportedFormats.EAN_8,
                    Html5QrcodeSupportedFormats.UPC_A,
                    Html5QrcodeSupportedFormats.UPC_E,
                    Html5QrcodeSupportedFormats.ITF,
                    Html5QrcodeSupportedFormats.AZTEC,
                    Html5QrcodeSupportedFormats.DATA_MATRIX,
                    Html5QrcodeSupportedFormats.CODABAR,
                    Html5QrcodeSupportedFormats.PDF_417
                ]
            };
            
            // Start detection using the video stream
            enhancedHtml5QrCode.start(
                { facingMode: "environment" },
                config,
                (decodedText) => {
                    const toolCodeInput = document.getElementById('toolCode');
                    toolCodeInput.value = decodedText;
                    document.getElementById('toolDetailsBtn').disabled = false;
                    if (bulkScanMode) {
                        // In bulk mode, pass code directly and clear input
                        toolCodeInput.value = '';
                        setTimeout(() => submitCode(decodedText), 50);
                    } else {
                    closeEnhancedScanner();
                    }
                },
                (errorMessage) => {
                    // Ignore errors during scanning
                }
            ).catch(err => {
                console.error('Enhanced scanner detection error:', err);
                // Fallback: try user camera
                enhancedHtml5QrCode.start(
                    { facingMode: "user" },
                    config,
                    (decodedText) => {
                        const toolCodeInput = document.getElementById('toolCode');
                        toolCodeInput.value = decodedText;
                        document.getElementById('toolDetailsBtn').disabled = false;
                        if (bulkScanMode) {
                            // In bulk mode, pass code directly and clear input
                            toolCodeInput.value = '';
                            setTimeout(() => submitCode(decodedText), 50);
                        } else {
                        closeEnhancedScanner();
                        }
                    },
                    (errorMessage) => {
                        // Ignore errors during scanning
                    }
                ).catch(err2 => {
                    console.error('Enhanced scanner fallback error:', err2);
                });
            });
            
            // Store reference for cleanup
            enhancedScannerInterval = enhancedHtml5QrCode;
        }

        function setupTouchEvents() {
            const videoContainer = document.querySelector('.scanner-video-container');
            let initialDistance = 0;
            let initialZoom = currentZoom;
            
            // Handle tap to focus
            videoContainer.addEventListener('click', (e) => {
                const rect = videoContainer.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                // Show focus indicator
                showFocusIndicator(x, y);
                
                // Try to focus (if supported)
                if (enhancedScannerStream) {
                    const track = enhancedScannerStream.getVideoTracks()[0];
                    if (track && track.getCapabilities && track.getCapabilities().focusMode) {
                        track.applyConstraints({
                            advanced: [{
                                focusMode: 'manual',
                                focusDistance: 0.5
                            }]
                        }).catch(error => {
                            console.log('Focus not supported:', error);
                        });
                    }
                }
            });
            
            // Handle pinch to zoom
            videoContainer.addEventListener('touchstart', (e) => {
                if (e.touches.length === 2) {
                    initialDistance = getDistance(e.touches[0], e.touches[1]);
                    initialZoom = currentZoom;
                }
            });
            
            videoContainer.addEventListener('touchmove', (e) => {
                if (e.touches.length === 2) {
                    e.preventDefault();
                    const currentDistance = getDistance(e.touches[0], e.touches[1]);
                    const scale = currentDistance / initialDistance;
                    const newZoom = Math.max(1.0, Math.min(3.0, initialZoom * scale));
                    
                    if (Math.abs(newZoom - currentZoom) > 0.1) {
                        currentZoom = newZoom;
                        updateZoomDisplay();
                        applyZoom();
                    }
                }
            });
        }
        
        function getDistance(touch1, touch2) {
            const dx = touch1.clientX - touch2.clientX;
            const dy = touch1.clientY - touch2.clientY;
            return Math.sqrt(dx * dx + dy * dy);
        }

        function showFocusIndicator(x, y) {
            // Remove existing focus indicator
            if (focusIndicator) {
                focusIndicator.remove();
            }
            
            // Create new focus indicator
            focusIndicator = document.createElement('div');
            focusIndicator.className = 'focus-indicator';
            focusIndicator.style.left = (x - 25) + 'px';
            focusIndicator.style.top = (y - 25) + 'px';
            
            document.querySelector('.scanner-video-container').appendChild(focusIndicator);
            
            // Remove after animation
            setTimeout(() => {
                if (focusIndicator) {
                    focusIndicator.remove();
                    focusIndicator = null;
                }
            }, 2000);
        }

        function zoomIn() {
            if (currentZoom < 3.0) {
                currentZoom += 0.5;
                updateZoomDisplay();
                applyZoom();
            }
        }

        function zoomOut() {
            if (currentZoom > 1.0) {
                currentZoom -= 0.5;
                updateZoomDisplay();
                applyZoom();
            }
        }

        function updateZoomDisplay() {
            const zoomLevel = document.getElementById('zoomLevel');
            if (zoomLevel) {
                zoomLevel.textContent = currentZoom.toFixed(1) + 'x';
            }
        }

        function applyZoom() {
            if (enhancedScannerStream) {
                const track = enhancedScannerStream.getVideoTracks()[0];
                if (track && track.getCapabilities && track.getCapabilities().zoom) {
                    track.applyConstraints({
                        advanced: [{
                            zoom: currentZoom
                        }]
                    }).catch(error => {
                        console.log('Zoom not supported:', error);
                    });
                } else {
                    // Fallback: use CSS transform for zoom
                    const video = document.getElementById('enhancedScannerVideo');
                    if (video) {
                        video.style.transform = `scale(${currentZoom})`;
                        video.style.transformOrigin = 'center center';
                    }
                }
            }
        }

        function toggleTorch() {
            torchEnabled = !torchEnabled;
            updateTorchButton();
            
            if (enhancedScannerStream) {
                const track = enhancedScannerStream.getVideoTracks()[0];
                if (track && track.getCapabilities && track.getCapabilities().torch) {
                    track.applyConstraints({
                        advanced: [{
                            torch: torchEnabled
                        }]
                    }).catch(error => {
                        console.log('Torch not supported:', error);
                    });
                } else {
                    // Fallback: show a message that torch is not supported
                    if (torchEnabled) {
                        alert('Torch/flashlight is not supported on this device.');
                        torchEnabled = false;
                        updateTorchButton();
                    }
                }
            }
        }

        function updateTorchButton() {
            const torchBtn = document.getElementById('torchBtn');
            if (torchEnabled) {
                torchBtn.classList.add('active');
                torchBtn.innerHTML = '<i class="fas fa-star"></i>';
                torchBtn.style.background = '#FFD700';
                torchBtn.style.color = '#000';
            } else {
                torchBtn.classList.remove('active');
                torchBtn.innerHTML = '<i class="fas fa-star"></i>';
                torchBtn.style.background = 'rgba(0, 0, 0, 0.7)';
                torchBtn.style.color = 'white';
            }
        }

        // Search Tools functionality
        let searchResultsData = [];
        let currentSearchType = 'toolName'; // Default to tool name
        let searchTimeout = null;
        let allToolsCache = [];
        let dropdownSelectedIndex = -1;
        
        function setSearchType(type) {
            currentSearchType = type;
            
            // Update button states
            const toolNameBtn = document.getElementById('searchTypeToolName');
            const partNumberBtn = document.getElementById('searchTypePartNumber');
            
            if (type === 'toolName') {
                toolNameBtn.classList.add('active');
                partNumberBtn.classList.remove('active');
            } else {
                partNumberBtn.classList.add('active');
                toolNameBtn.classList.remove('active');
            }
            
            // Trigger search again if there's text in the input
            const searchInput = document.getElementById('searchToolInput');
            if (searchInput && searchInput.value.trim()) {
                performRealTimeSearch(searchInput.value.trim());
            }
        }
        
        function handleSearchInputKeyup(event) {
            const searchInput = document.getElementById('searchToolInput');
            const searchTerm = searchInput.value.trim();
            const dropdown = document.getElementById('searchDropdownList');
            
            // Handle arrow keys for dropdown navigation
            if (event.key === 'ArrowDown') {
                event.preventDefault();
                navigateDropdown(1);
                return;
            } else if (event.key === 'ArrowUp') {
                event.preventDefault();
                navigateDropdown(-1);
                return;
            } else if (event.key === 'Enter') {
                event.preventDefault();
                if (dropdownSelectedIndex >= 0 && searchResultsData[dropdownSelectedIndex]) {
                    selectToolFromDropdown(searchResultsData[dropdownSelectedIndex].id);
                }
                return;
            } else if (event.key === 'Escape') {
                dropdown.style.display = 'none';
                return;
            }
            
            // Clear previous timeout
            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }
            
            // Debounce search - wait 300ms after user stops typing
            searchTimeout = setTimeout(() => {
                if (searchTerm.length >= 1) {
                    performRealTimeSearch(searchTerm);
                } else {
                    dropdown.style.display = 'none';
                    searchResultsData = [];
                }
            }, 300);
        }
        
        function handleSearchInputFocus() {
            const searchInput = document.getElementById('searchToolInput');
            const searchTerm = searchInput.value.trim();
            if (searchTerm.length >= 1) {
                performRealTimeSearch(searchTerm);
            }
        }
        
        function handleSearchInputBlur() {
            // Delay hiding dropdown to allow click events
            setTimeout(() => {
                const dropdown = document.getElementById('searchDropdownList');
                dropdown.style.display = 'none';
            }, 200);
        }
        
        function navigateDropdown(direction) {
            const dropdown = document.getElementById('searchDropdownList');
            const items = dropdown.querySelectorAll('.search-dropdown-item');
            
            if (items.length === 0) return;
            
            // Remove previous selection
            if (dropdownSelectedIndex >= 0 && items[dropdownSelectedIndex]) {
                items[dropdownSelectedIndex].classList.remove('selected');
            }
            
            // Update index
            dropdownSelectedIndex += direction;
            if (dropdownSelectedIndex < 0) {
                dropdownSelectedIndex = items.length - 1;
            } else if (dropdownSelectedIndex >= items.length) {
                dropdownSelectedIndex = 0;
            }
            
            // Add selection
            if (items[dropdownSelectedIndex]) {
                items[dropdownSelectedIndex].classList.add('selected');
                items[dropdownSelectedIndex].scrollIntoView({ block: 'nearest', behavior: 'smooth' });
            }
        }
        
        async function performRealTimeSearch(searchTerm) {
            const dropdown = document.getElementById('searchDropdownList');
            dropdown.style.display = 'block';
            dropdown.innerHTML = '<div class="search-dropdown-item" style="text-align: center; color: #999;">Loading...</div>';
            dropdownSelectedIndex = -1;
            
            try {
                // Fetch all tools if cache is empty
                if (allToolsCache.length === 0) {
                    const snapshot = await db.collection('tools').get();
                    allToolsCache = [];
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        allToolsCache.push({
                            id: doc.id,
                            toolName: (data.toolName || '').toString(),
                            partNumber: (data.partNumber || doc.id).toString(),
                            collectionCode: (data.collectionCode || '').toString(),
                            owner: (data.owner || '').toString()
                        });
                    });
                }
                
                // Case-insensitive search through all tools
                const searchTermLower = searchTerm.toLowerCase();
                let filtered = allToolsCache.filter(tool => {
                    if (currentSearchType === 'toolName') {
                        return tool.toolName.toLowerCase().includes(searchTermLower);
                    } else {
                        return tool.partNumber.toLowerCase().includes(searchTermLower);
                    }
                });
                
                // Sort alphabetically based on search type
                filtered.sort((a, b) => {
                    if (currentSearchType === 'toolName') {
                        const nameA = (a.toolName || '').toLowerCase();
                        const nameB = (b.toolName || '').toLowerCase();
                        return nameA.localeCompare(nameB);
                    } else {
                        const partA = (a.partNumber || a.id).toLowerCase();
                        const partB = (b.partNumber || b.id).toLowerCase();
                        return partA.localeCompare(partB);
                    }
                });
                
                // Limit to 20 results for performance
                filtered = filtered.slice(0, 20);
                
                // Store results for selection
                searchResultsData = filtered;
                
                // Display results
                if (filtered.length === 0) {
                    dropdown.innerHTML = '<div class="search-dropdown-item" style="text-align: center; color: #999;">No tools found</div>';
                    return;
                }
                
                dropdown.innerHTML = '';
                filtered.forEach((tool, index) => {
                    const item = document.createElement('div');
                    item.className = 'search-dropdown-item';
                    item.onclick = () => selectToolFromDropdown(tool.id);
                    item.onmouseenter = () => {
                        // Remove previous selection
                        dropdown.querySelectorAll('.search-dropdown-item').forEach(el => el.classList.remove('selected'));
                        item.classList.add('selected');
                        dropdownSelectedIndex = index;
                    };
                    
                    // Highlight matching text
                    const highlightText = (text, searchTerm) => {
                        if (!searchTerm) return text;
                        const regex = new RegExp(`(${searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                        return text.replace(regex, '<span class="highlight-match">$1</span>');
                    };
                    
                    const toolName = tool.toolName || 'Unknown Tool';
                    const partNumber = tool.partNumber || tool.id;
                    const collectionCode = tool.collectionCode || 'N/A';
                    const owner = tool.owner || 'N/A';
                    
                    // Determine which field to highlight based on search type
                    let highlightedName = toolName;
                    let highlightedPart = partNumber;
                    
                    if (currentSearchType === 'toolName') {
                        highlightedName = highlightText(toolName, searchTerm);
                    } else {
                        highlightedPart = highlightText(partNumber, searchTerm);
                    }
                    
                    // When searching by part number, swap the display order
                    if (currentSearchType === 'partNumber') {
                        // Part number goes in tool-name position, tool name goes in tool-part position
                        item.innerHTML = `
                            <div class="tool-name">${highlightedPart}</div>
                            <div class="tool-part"><span class="label">Tool Name:</span> <span class="value">${toolName}</span></div>
                            <div class="tool-collection"><span class="label">Collection:</span> <span class="value">${collectionCode}</span></div>
                            <div class="tool-owner"><span class="label">Owner:</span> <span class="value">${owner}</span></div>
                        `;
                    } else {
                        // Normal order: tool name first, part number second
                        item.innerHTML = `
                            <div class="tool-name">${highlightedName}</div>
                            <div class="tool-part"><span class="label">Part #:</span> <span class="value">${highlightedPart}</span></div>
                            <div class="tool-collection"><span class="label">Collection:</span> <span class="value">${collectionCode}</span></div>
                            <div class="tool-owner"><span class="label">Owner:</span> <span class="value">${owner}</span></div>
                        `;
                    }
                    
                    dropdown.appendChild(item);
                });
                
            } catch (error) {
                console.error('Error searching tools:', error);
                dropdown.innerHTML = '<div class="search-dropdown-item" style="text-align: center; color: #f00;">Error loading results</div>';
            }
        }
        
        // Helper function to get collection photo count
        async function getCollectionPhotoCount(collectionCode) {
            if (!collectionCode || collectionCode === 'N/A') return 0;
            try {
                const collectionQuery = await db.collection('collections')
                    .where('collectionName', '==', collectionCode)
                    .get();
                
                if (!collectionQuery.empty) {
                    const collectionDoc = collectionQuery.docs[0];
                    const photoUrls = collectionDoc.data().photoUrls || [];
                    return photoUrls.length;
                }
            } catch (error) {
                console.error('Error getting collection photo count:', error);
            }
            return 0;
        }
        
        // Helper function to get location photo count
        async function getLocationPhotoCount(collectionCode, location) {
            if (!collectionCode || collectionCode === 'N/A' || !location || location === 'N/A') return 0;
            try {
                const documentId = `${collectionCode}_${location}`;
                const locationDoc = await db.collection('locationPhotos').doc(documentId).get();
                
                if (locationDoc.exists) {
                    const data = locationDoc.data();
                    const photoUrls = data.photoUrls || [];
                    return photoUrls.length;
                }
            } catch (error) {
                console.error('Error getting location photo count:', error);
            }
            return 0;
        }
        
        async function selectToolFromDropdown(toolId) {
            const searchInput = document.getElementById('searchToolInput');
            const dropdown = document.getElementById('searchDropdownList');
            const selectedToolDetails = document.getElementById('selectedToolDetails');
            
            // Hide dropdown and clear search field
            dropdown.style.display = 'none';
            searchInput.value = '';
            
            try {
                // Fetch full tool data
                const toolRef = db.collection('tools').doc(toolId);
                const doc = await toolRef.get();
                
                if (doc.exists) {
                    const data = doc.data();
                    const tool = {
                        id: doc.id,
                        ...data
                    };
                    
                    // Show tool details
                    selectedToolDetails.style.display = 'block';
                    
                    // Format tool details
                    const toolName = tool.toolName || 'Unknown Tool';
                    const partNumber = tool.partNumber || toolId;
                    const collectionCode = tool.collectionCode || 'N/A';
                    const location = tool.location || 'N/A';
                    const status = tool.status || 'N/A';
                    const owner = tool.owner || 'N/A';
                    const technician = tool.technician || 'N/A';
                    const calDueDate = tool.calDueDate ? (tool.calDueDate.toDate ? tool.calDueDate.toDate().toLocaleDateString() : tool.calDueDate) : 'N/A';
                    
                    // Get tool photo URLs
                    const toolPhotoUrls = tool.photoUrls || [];
                    const toolPhotoCount = toolPhotoUrls.length;
                    
                    // Get photo counts
                    const collectionPhotoCount = await getCollectionPhotoCount(collectionCode);
                    const locationPhotoCount = await getLocationPhotoCount(collectionCode, location);
                    
                    // Fetch collection and location photo URLs for display
                    let collectionPhotoUrls = [];
                    let locationPhotoUrls = [];
                    
                    if (collectionCode !== 'N/A' && collectionPhotoCount > 0) {
                        try {
                            const collectionQuery = await db.collection('collections')
                                .where('collectionName', '==', collectionCode)
                                .get();
                            if (!collectionQuery.empty) {
                                collectionPhotoUrls = collectionQuery.docs[0].data().photoUrls || [];
                            }
                        } catch (error) {
                            console.error('Error fetching collection photos:', error);
                        }
                    }
                    
                    if (location !== 'N/A' && locationPhotoCount > 0) {
                        try {
                            const documentId = `${collectionCode}_${location}`;
                            const locationDoc = await db.collection('locationPhotos').doc(documentId).get();
                            if (locationDoc.exists) {
                                locationPhotoUrls = locationDoc.data().photoUrls || [];
                            }
                        } catch (error) {
                            console.error('Error fetching location photos:', error);
                        }
                    }
                    
                    // Create tool name display with photos as hyperlink
                    let toolNameDisplay = toolName;
                    if (toolPhotoCount > 0) {
                        const toolPhotoUrlsJson = JSON.stringify(toolPhotoUrls).replace(/'/g, "&#39;");
                        toolNameDisplay = `${toolName} (<a href="#" onclick="showToolPhotoGallery(this); return false;" data-photo-urls='${toolPhotoUrlsJson}' data-tool-id='${toolId}' data-part-number='${partNumber}' style="color: #2196F3; text-decoration: underline; cursor: pointer; font-weight: bold;">${toolPhotoCount} photos</a>)`;
                    } else {
                        toolNameDisplay = `${toolName} (<span style="color: #888; text-decoration: none; cursor: not-allowed; font-weight: bold;">0 photos</span>)`;
                    }
                    
                    // Create collection display with photos as hyperlink
                    let collectionDisplay = collectionCode;
                    if (collectionCode !== 'N/A') {
                        if (collectionPhotoCount > 0) {
                            const collectionPhotoUrlsJson = JSON.stringify(collectionPhotoUrls).replace(/'/g, "&#39;");
                            collectionDisplay = `${collectionCode} (<a href="#" onclick="showCollectionPhotoGallery(this); return false;" data-photo-urls='${collectionPhotoUrlsJson}' style="color: #2196F3; text-decoration: underline; cursor: pointer; font-weight: bold;">${collectionPhotoCount} photos</a>)`;
                        } else {
                            collectionDisplay = `${collectionCode} (0 photos)`;
                        }
                    }
                    
                    // Create location display with photos as hyperlink
                    let locationDisplay = location;
                    if (location !== 'N/A') {
                        if (locationPhotoCount > 0) {
                            const locationPhotoUrlsJson = JSON.stringify(locationPhotoUrls).replace(/'/g, "&#39;");
                            locationDisplay = `${location} (<a href="#" onclick="showLocationPhotoGallery(this); return false;" data-photo-urls='${locationPhotoUrlsJson}' style="color: #2196F3; text-decoration: underline; cursor: pointer; font-weight: bold;">${locationPhotoCount} photos</a>)`;
                        } else {
                            locationDisplay = `${location} (0 photos)`;
                        }
                    }
                    
                    selectedToolDetails.innerHTML = `
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">Tool Details</h5>
                            </div>
                            <div class="card-body">
                                <p><strong>Tool Name:</strong> ${toolNameDisplay}</p>
                                <p><strong>Part Number:</strong> ${partNumber}</p>
                                <p><strong>Collection Code:</strong> ${collectionDisplay}</p>
                                <p><strong>Location:</strong> ${locationDisplay}</p>
                                <p><strong>Status:</strong> <span class="badge ${status === 'OUT' ? 'bg-danger' : 'bg-success'}">${status}</span></p>
                                <p><strong>Owner:</strong> ${owner}</p>
                                <p><strong>Technician:</strong> ${technician}</p>
                                <p><strong>Cal Due Date:</strong> ${calDueDate}</p>
                                <button onclick="useSelectedTool('${toolId}')" class="btn btn-primary mt-2">
                                    <i class="fas fa-check"></i> Use This Tool
                                </button>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error fetching tool details:', error);
                alert('Error fetching tool details. Please try again.');
            }
        }
        
        // Function to show collection photos using the existing tool photo gallery modal
        function showCollectionPhotoGallery(el) {
            const photoUrls = JSON.parse(el.getAttribute('data-photo-urls'));
            if (!photoUrls || photoUrls.length === 0) {
                alert('No photos available for this collection.');
                return;
            }
            // Use the existing showToolPhotoGallery function
            showToolPhotoGallery(el);
        }
        
        // Function to show location photos using the existing tool photo gallery modal
        function showLocationPhotoGallery(el) {
            const photoUrls = JSON.parse(el.getAttribute('data-photo-urls'));
            if (!photoUrls || photoUrls.length === 0) {
                alert('No photos available for this location.');
                return;
            }
            // Use the existing showToolPhotoGallery function
            showToolPhotoGallery(el);
        }
        
        // Legacy function for compatibility
        async function performToolSearch() {
            const searchInput = document.getElementById('searchToolInput');
            const searchTerm = searchInput.value.trim();
            
            if (!searchTerm) {
                alert('Please enter a search term');
                return;
            }
            
            // Use the real-time search function
            await performRealTimeSearch(searchTerm);
        }
        
        function selectToolFromSearch(toolId) {
            // This function is kept for compatibility with the old dropdown
            selectToolFromDropdown(toolId);
        }
        
        function useSelectedTool(toolId) {
            // Set the tool code in the scanner input and switch to Scan Tool tab
            const toolCodeInput = document.getElementById('toolCode');
            toolCodeInput.value = toolId;
            
            // Manually trigger input event to enable Tool Details button
            const inputEvent = new Event('input', { bubbles: true });
            toolCodeInput.dispatchEvent(inputEvent);
            
            // Also directly enable the button as a backup
            const toolDetailsBtn = document.getElementById('toolDetailsBtn');
            if (toolDetailsBtn) {
                toolDetailsBtn.disabled = false;
            }
            
            // Switch to Scan Tool tab
            const scanToolTab = document.getElementById('scanToolTab');
            const searchToolsTab = document.getElementById('searchToolsTab');
            const scannerView = document.getElementById('scannerView');
            const searchToolsView = document.getElementById('searchToolsView');
            
            // Remove active class from search tab
            searchToolsTab.classList.remove('active');
            searchToolsView.classList.remove('show', 'active');
            
            // Add active class to scan tab
            scanToolTab.classList.add('active');
            scannerView.classList.add('show', 'active');
            
            // Trigger tab change event
            const tab = new bootstrap.Tab(scanToolTab);
            tab.show();
            
            // Clear search results
            document.getElementById('searchToolInput').value = '';
            document.getElementById('searchResultsContainer').style.display = 'none';
            document.getElementById('selectedToolDetails').style.display = 'none';
        }

        // Show tool details for the code in the input field, even if not submitted
        async function showLastScannedToolDetails() {
            const code = document.getElementById('toolCode').value.trim();
            if (!code) return;
            try {
                const toolRef = db.collection('tools').doc(code);
                const doc = await toolRef.get();
                if (doc.exists) {
                    const data = doc.data();
                    // Store the data for the modal
                    lastScannedToolData = buildToolDetailsObject(doc, data);
                    
                    // Show the modal with the tool details
                    showToolDetails(lastScannedToolData, 'registerTools');
                } else {
                    alert('Tool not found. Please check the code.');
                }
            } catch (error) {
                console.error('Error fetching tool details:', error);
                alert('Error fetching tool details: ' + error.message);
            }
        }

        // Add this function to show tool details in the modal
        function showToolDetails(tool, sourceScreen = 'registerTools') {
            const body = document.getElementById('toolDetailsBody');
            
            // Format timestamp for display
            const formatTimestamp = (timestamp) => {
                if (!timestamp) return 'N/A';
                if (timestamp.toDate) {
                    return timestamp.toDate().toLocaleString('en-GB', {
                        day: '2-digit', month: '2-digit', year: 'numeric', 
                        hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
                    });
                }
                return timestamp;
            };
            
            // Determine checkout information based on status
            const status = tool.status || 'N/A';
            let checkoutInfo = '';
            
            if (status === 'OUT') {
                // Tool is currently checked out - fetch from tools collection
                const technician = tool.technician || 'N/A';
                const checkoutDate = formatTimestamp(tool.timestamp);
                checkoutInfo = `
                <div class="mb-2" style="font-size: 1.1em;">
                        <span style="font-weight: 600; color: #222; font-size: 1.2em;">Checked Out By:</span> 
                        <span style="font-size: 1.0em; color: #1976d2;">${technician}</span>
                </div>
                <div class="mb-2" style="font-size: 1.1em;">
                        <span style="font-weight: 600; color: #222; font-size: 1.2em;">ChkOut Date:</span> 
                        <span style="font-size: 1.0em; color: #1976d2;">${checkoutDate}</span>
                </div>
                `;
            } else if (status === 'IN') {
                // Tool iimage.pngs currently in - fetch from tools collection
                const lastTechnician = tool.technician || 'N/A';
                const lastCheckoutDate = formatTimestamp(tool.timestamp);
                checkoutInfo = `
                <div class="mb-2" style="font-size: 1.1em;">
                        <span style="font-weight: 600; color: #222; font-size: 1.2em;">Last ChkOut By:</span> 
                        <span style="font-size: 1.0em; color: #1976d2;">${lastTechnician}</span>
                </div>
                <div class="mb-2" style="font-size: 1.1em;">
                        <span style="font-weight: 600; color: #222; font-size: 1.2em;">Last ChkOut:</span> 
                        <span style="font-size: 1.0em; color: #1976d2;">${lastCheckoutDate}</span>
                </div>
            `;
            }
            
            // Always show all fields in a consistent order
            const fields = [
                { label: 'Tool ID', value: tool.documentId || tool.toolId || 'N/A' },
                { label: 'Tool Name', value: tool.toolName || 'N/A' },
                { label: 'Part Number', value: tool.partNumber || 'N/A' },
                { label: 'Serial Number', value: tool.serialNumber || 'N/A' },
                { label: 'Collection', value: tool.collectionCode || 'N/A', isCollection: true },
                { label: 'Location', value: tool.location || 'N/A' },
                // Insert WorkOn after Location
                { label: 'WorkOn', value: (typeof tool.WorkOn === 'string' && tool.WorkOn.trim()) ? tool.WorkOn : 'N/A', isWorkOn: true },
                { label: 'Owner', value: tool.owner || 'N/A' },
                { label: 'Status', value: tool.status || 'N/A' },
                { label: 'Calibration Due', value: tool.calDueDate || 'N/A' },
            ];
            let html = '';
            fields.forEach(f => {
                if (f.isCollection) {
                    html += `<div class="mb-2" style="font-size: 1.22em;"><span style="font-weight: 600; color: #222; font-size: 1.2em;">${f.label}:</span> <a href="#" onclick="showCollectionDetails('${f.value !== 'N/A' ? f.value : ''}', '${sourceScreen}')" style="font-size: 1.18em; color: #FF9800; text-decoration: underline; font-weight: bold;">${f.value}</a></div>`;
                } else if (f.isWorkOn) {
                    html += `<div class=\"mb-2\" style=\"font-size: 1.1em;\"><span style=\"font-weight: 600; color: #222; font-size: 1.2em;\">${f.label}:</span> <span style=\"font-size: 1.0em; color: #888; font-weight: bold;\">${f.value}</span></div>`;
                } else {
                    html += `<div class=\"mb-2\" style=\"font-size: 1.1em;\"><span style=\"font-weight: 600; color: #222; font-size: 1.2em;\">${f.label}:</span> <span style=\"font-size: 1.0em; color: #1976d2;\">${f.value}</span></div>`;
                }
            });
            
            // Add checkout information after the standard fields
            html += checkoutInfo;
            
            html += `<div class="mb-2">
  ${tool.photoUrls && tool.photoUrls.length > 0
    ? `<a style="color: #1976d2; text-decoration: underline; cursor: pointer; font-size: 1.18em; font-weight: bold; display: inline-block; margin-top: 10px;"
         onclick="if(this.hasAttribute('data-photo-urls')) showToolPhotoGallery(this)"
         data-photo-urls='${JSON.stringify(tool.photoUrls)}'
         data-tool-id='${tool.toolId || tool.documentId}'
         data-part-number='${tool.partNumber}'>
        Photo (${tool.photoUrls.length})
      </a>`
    : `<span style="color: #888; text-decoration: none; cursor: not-allowed; font-size: 1.18em; font-weight: bold; display: inline-block; margin-top: 10px;">Photo (0)</span>`}
</div>`;
            body.innerHTML = html;
            const modal = new bootstrap.Modal(document.getElementById('toolDetailsModal'));
            modal.show();
        }

        // Enable/disable Tool Details button based on input
        document.getElementById('toolCode').addEventListener('input', function() {
            const btn = document.getElementById('toolDetailsBtn');
            btn.disabled = !this.value.trim();
        });

        // My Tools Screen with app-like formatting (full page)
        async function showMyTools() {
            const user = auth.currentUser;
            if (!user) return;
            const fullName = localStorage.getItem('fullName') || user.email;
            const myToolsScreenBody = document.getElementById('myToolsScreenBody');
            myToolsScreenBody.innerHTML = '<div class="text-center">Loading...</div>';

            // Hide all other main screens
            navigateToScreen(SCREENS.MY_TOOLS);

            // Update collection photo button counts
            await updateCollectionPhotoButtonCounts();

            try {
                // Query all tools where owner matches the logged-in user
                const snapshot = await db.collection('tools')
                    .where('owner', '==', fullName)
                    .get();

                if (snapshot.empty) {
                    myToolsScreenBody.innerHTML = '<div class="text-center">No tools found for you.</div>';
                } else {
                    // Group by collectionCode and location
                    const tools = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    const grouped = {};
                    tools.forEach(tool => {
                        const collection = tool.collectionCode || 'N/A';
                        const location = tool.location || 'N/A';
                        if (!grouped[collection]) grouped[collection] = {};
                        if (!grouped[collection][location]) grouped[collection][location] = [];
                        grouped[collection][location].push(tool);
                    });

                    let html = '';
                    Object.keys(grouped).forEach(collection => {
                        html += `<div class=\"mytools-collection\"><span>Collection:</span><span>${collection}</span></div>`;
                        Object.keys(grouped[collection]).forEach(location => {
                            const toolsAtLocation = grouped[collection][location];
                            html += `<div class=\"mytools-location\"><span>Location:</span><span>${location} (Total: ${toolsAtLocation.length} tools)</span></div>`;
                            toolsAtLocation.forEach((tool, idx) => {
                                const bgClass = idx % 2 === 0 ? 'mytools-tool-bg1' : 'mytools-tool-bg2';
                                html += `<div class=\"mytools-tool-item ${bgClass}\">`
                                    + `<div style=\"cursor:pointer;\" onclick=\"showToolDetailsFromMyTools(${JSON.stringify(tool).replace(/"/g, '&quot;')})\">`
                                    + `<div class=\"mytools-tool-name\" style="display: block !important; width: 100% !important; margin-bottom: 4px; clear: both;">${idx + 1}. ${tool.toolName || 'Unknown Tool'}</div>`
                                    + `<div class=\"mytools-tool-tid\" style="display: block !important; width: 100% !important; margin-bottom: 4px; clear: both;">TID: ${tool.id}</div>`
                                    + `<span style="display:flex;align-items:center;justify-content:space-between;">
                                        <span style="font-size:1.01rem;color:#444;">Part #: ${tool.partNumber || ''}</span>
                                        <span style="font-size:1.01rem;font-weight:bold;color:#222;">WorkOn: <span style="color:#888;font-weight:bold;">${(typeof tool.WorkOn === 'string' && tool.WorkOn.trim()) ? tool.WorkOn : 'N/A'}</span></span>
                                    </span><br>`
                                    + `<span class=\"mytools-status-${getStatusClass(tool.status)}\">Status: ${tool.status || ''}</span>`;
                                if (tool.status === 'OUT') {
                                    html += `<div class=\"mytools-tool-extra\">Technician: ${tool.technician || ''}</div>`;
                                    if (tool.timestamp && tool.timestamp.toDate) {
                                        const outTime = tool.timestamp.toDate().toLocaleString('en-GB', {
                                            day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
                                        });
                                        html += `<div class=\"mytools-tool-extra\">Checked out: ${outTime}</div>`;
                                    }
                                }
                                if (tool.calDueDate && tool.calDueDate.toDate) {
                                    const calDue = tool.calDueDate.toDate().toLocaleDateString('en-GB');
                                    html += `<div class=\"mytools-tool-cal\">Cal Due: <span style=\"font-weight: bold;\">${calDue}</span></div>`;
                                }
                                html += `</div>`;
                                html += `<div style=\"margin-top:8px;display:flex;gap:8px;justify-content:flex-end;\">`;
                                html += `<button onclick=\"event.stopPropagation(); createPhotoUploadInput('${tool.id}', '${tool.partNumber || tool.id}')\" style=\"background:#FF9800;color:white;border:none;border-radius:16px;padding:6px 12px;font-size:0.9rem;font-weight:bold;cursor:pointer;\"><i class=\"fas fa-camera\"></i> Add Photo</button>`;
                                if (tool.photoUrls && tool.photoUrls.length > 0) {
                                    html += `<button onclick=\"event.stopPropagation(); showToolPhotoGallery(this)\" data-photo-urls='${JSON.stringify(tool.photoUrls)}' data-tool-id='${tool.id}' data-part-number='${tool.partNumber || tool.id}' style=\"background:#1976d2;color:white;border:none;border-radius:16px;padding:6px 12px;font-size:0.9rem;font-weight:bold;cursor:pointer;\"><i class=\"fas fa-images\"></i> Photos (${tool.photoUrls.length})</button>`;
                                }
                                html += `</div>`;
                                html += `</div>`;
                            });
                        });
                    });
                    myToolsScreenBody.innerHTML = html;
                }
            } catch (error) {
                myToolsScreenBody.innerHTML = `<div class=\"text-danger text-center\">Error loading your tools: ${error.message}</div>`;
            }
        }

        // Back button for My Tools screen
        document.getElementById('myToolsBackBtn').onclick = function() {
            document.getElementById('myToolsScreen').style.display = 'none';
            document.getElementById('toolScannerMenu').style.display = 'block';
            // Refresh the OUT tools count when returning to menu
            updatePreviousOutToolsCount();
        };

        // Collection photo buttons for My Tools screen
        document.getElementById('myToolsAddCollectionPhotoBtn').onclick = function() {
            // Show collection selection modal first
            showCollectionSelectionForPhotos();
        };

        document.getElementById('myToolsCollectionPhotosBtn').onclick = function() {
            // Show collection selection modal first
            showCollectionSelectionForPhotos();
        };

        // Update collection photo button counts
        async function updateCollectionPhotoButtonCounts() {
            try {
                // Update My Tools screen buttons
                const myToolsBtn = document.getElementById('myToolsCollectionPhotosBtn');
                if (myToolsBtn) {
                    const user = auth.currentUser;
                    if (user) {
                        const fullName = localStorage.getItem('fullName') || user.email;
                        const snapshot = await db.collection('tools')
                            .where('owner', '==', fullName)
                            .get();
                        
                        if (!snapshot.empty) {
                            const collections = [...new Set(snapshot.docs.map(doc => doc.data().collectionCode).filter(Boolean))];
                            let totalPhotos = 0;
                            
                            for (const collectionName of collections) {
                                const collectionQuery = await db.collection('collections').where('collectionName', '==', collectionName).get();
                                if (!collectionQuery.empty) {
                                    const collectionDoc = collectionQuery.docs[0];
                                    totalPhotos += (collectionDoc.data().photoUrls || []).length;
                                }
                            }
                            
                            myToolsBtn.innerHTML = `<i class="fas fa-images"></i> Collection Photos (${totalPhotos})`;
                        }
                    }
                }

                // Update My Tools by Collection screen buttons
                const myToolsByCollectionBtn = document.getElementById('myToolsByCollectionPhotosBtn');
                if (myToolsByCollectionBtn && lastViewedCollectionName) {
                    const collectionQuery = await db.collection('collections').where('collectionName', '==', lastViewedCollectionName).get();
                    let photoCount = 0;
                    if (!collectionQuery.empty) {
                        const collectionDoc = collectionQuery.docs[0];
                        photoCount = (collectionDoc.data().photoUrls || []).length;
                    }
                    myToolsByCollectionBtn.innerHTML = `<i class="fas fa-images"></i> Collection Photos (${photoCount})`;
                }
            } catch (error) {
                console.error('Error updating collection photo button counts:', error);
            }
        }

        // Collection photo buttons for My Tools by Collection screen
        document.getElementById('myToolsByCollectionAddPhotoBtn').onclick = function() {
            if (lastViewedCollectionName) {
                createCollectionPhotoUploadInput(lastViewedCollectionName);
            }
        };

        document.getElementById('myToolsByCollectionPhotosBtn').onclick = function() {
            if (lastViewedCollectionName) {
                // Create a temporary element to pass to showCollectionPhotoGallery
                const tempElement = document.createElement('div');
                tempElement.setAttribute('data-collection-name', lastViewedCollectionName);
                showCollectionPhotoGallery(tempElement);
            }
        };

        // Show collection selection modal for photos
        async function showCollectionSelectionForPhotos() {
            const user = auth.currentUser;
            if (!user) return;
            const fullName = localStorage.getItem('fullName') || user.email;
            
            try {
                // Get collections where user has tools
                const snapshot = await db.collection('tools')
                    .where('owner', '==', fullName)
                    .get();
                
                if (snapshot.empty) {
                    alert('No collections found.');
                    return;
                }
                
                const collections = [...new Set(snapshot.docs.map(doc => doc.data().collectionCode).filter(Boolean))];
                collections.sort();
                
                if (collections.length === 0) {
                    alert('No collections found.');
                    return;
                }
                
                // Get photo counts for each collection
                const collectionsWithPhotos = [];
                for (const collectionName of collections) {
                    const collectionQuery = await db.collection('collections').where('collectionName', '==', collectionName).get();
                    let photoCount = 0;
                    if (!collectionQuery.empty) {
                        const collectionDoc = collectionQuery.docs[0];
                        photoCount = (collectionDoc.data().photoUrls || []).length;
                    }
                    collectionsWithPhotos.push({ name: collectionName, photoCount });
                }
                
                // Create modal for collection selection
                const modalHtml = `
                    <div class="modal fade" id="collectionPhotoSelectionModal" tabindex="-1" aria-labelledby="collectionPhotoSelectionModalLabel" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header bg-primary text-white">
                                    <h5 class="modal-title" id="collectionPhotoSelectionModalLabel">Select Collection</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="d-grid gap-2">
                                        ${collectionsWithPhotos.map(collection => `
                                            <button type="button" class="btn btn-outline-primary" onclick="selectCollectionForPhotos('${collection.name}')">
                                                ${collection.name} <span class="badge bg-secondary ms-2">${collection.photoCount} photos</span>
                                            </button>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Remove existing modal if any
                const existingModal = document.getElementById('collectionPhotoSelectionModal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                // Add modal to body
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('collectionPhotoSelectionModal'));
                modal.show();
                
                // Clean up modal after it's hidden
                document.getElementById('collectionPhotoSelectionModal').addEventListener('hidden.bs.modal', function() {
                    this.remove();
                });
                
            } catch (error) {
                console.error('Error loading collections:', error);
                alert('Error loading collections: ' + error.message);
            }
        }

        // Select collection for photos
        function selectCollectionForPhotos(collectionName) {
            // Hide the selection modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('collectionPhotoSelectionModal'));
            if (modal) modal.hide();
            
            // Determine which button was clicked and call appropriate function
            const activeElement = document.activeElement;
            if (activeElement && activeElement.id === 'myToolsAddCollectionPhotoBtn') {
                createCollectionPhotoUploadInput(collectionName);
            } else {
                const tempElement = document.createElement('div');
                tempElement.setAttribute('data-collection-name', collectionName);
                showCollectionPhotoGallery(tempElement);
            }
        }

        // Helper to get status CSS class
        function getStatusClass(status) {
            const upperStatus = status ? status.toUpperCase() : 'IN';
            switch (upperStatus) {
                case 'OUT': return 'out';
                case 'BROKEN': return 'broken';
                case 'LOST': return 'lost';
                case 'CALIBRATION': return 'calibration';
                default: return 'in';
            }
        }

        // Helper to set cooldown warning message
        function setCooldownWarnMessage(remainingMs) {
            const mins = Math.floor(remainingMs / 60000);
            const secs = Math.ceil((remainingMs % 60000) / 1000);
            document.querySelector('#cooldownWarnModal .modal-body').textContent = `You must wait ${mins} minute${mins !== 1 ? 's' : ''} and ${secs} second${secs !== 1 ? 's' : ''} before you can return this tool.`;
        }

        // Store active countdown intervals
        let activeCountdowns = {};

        // Start cooldown countdown for a tool card
        async function startCooldownCountdown(toolId, outTime) {
            try {
                // Fetch cooldown minutes from settings
                const settingsDoc = await db.collection('settings').doc('admin').get();
                let cooldownMinutes = 5; // default
                if (settingsDoc.exists && settingsDoc.data().CheckINCooldownMinutes) {
                    cooldownMinutes = settingsDoc.data().CheckINCooldownMinutes;
                }
                const cooldownMs = cooldownMinutes * 60 * 1000;
                
                const countdownElement = document.getElementById(`countdown-${toolId}`);
                if (!countdownElement) return;
                
                const valueSpan = countdownElement.querySelector('.countdown-value');
                if (!valueSpan) return;
                
                // Clear any existing interval for this tool
                if (activeCountdowns[toolId]) {
                    clearInterval(activeCountdowns[toolId]);
                }
                
                // Update countdown every second
                function updateCountdown() {
                    const now = new Date();
                    const diffMs = now - outTime;
                    const remainingMs = cooldownMs - diffMs;
                    
                    if (remainingMs <= 0) {
                        // Change the entire content when ready
                        countdownElement.innerHTML = '<span style="font-weight: bold;">Check/In :</span> <span class="countdown-value">Ready</span>';
                        countdownElement.style.background = '#4CAF50'; // Green when ready
                        if (activeCountdowns[toolId]) {
                            clearInterval(activeCountdowns[toolId]);
                            delete activeCountdowns[toolId];
                        }
                    } else {
                        const mins = Math.floor(remainingMs / 60000);
                        const secs = Math.floor((remainingMs % 60000) / 1000);
                        valueSpan.textContent = `${mins}m ${secs}s`;
                    }
                }
                
                // Initial update
                updateCountdown();
                
                // Update every second
                activeCountdowns[toolId] = setInterval(updateCountdown, 1000);
                
            } catch (error) {
                console.error('Error starting countdown:', error);
            }
        }

        // Clear all countdowns when leaving the page
        function clearAllCountdowns() {
            Object.keys(activeCountdowns).forEach(toolId => {
                clearInterval(activeCountdowns[toolId]);
            });
            activeCountdowns = {};
        }

        // Tab change handler
        // (removed previous-tab event listener as the tab is no longer present)

        // On auth state change, show menu after login (not register tools)
        auth.onAuthStateChanged(function(user) {
            if (user) {
                loginSection.style.display = 'none';
                signUpSection.classList.add('d-none');
                adminSection.style.display = 'none';
                const adminButton = document.getElementById('adminButton');
                if (adminButton) {
                    adminButton.style.display = 'none';
                }
                document.getElementById('headerBranding').style.display = 'none';
                
                // Check if we should skip splash (coming from register-tools, previous-out, or pdf-question-generator)
                const skipSplash = sessionStorage.getItem('skipSplash');
                if (skipSplash === 'true') {
                    console.log('skipSplash detected in auth handler - showing menu immediately');
                    // Hide splash screen immediately if it's still visible
                    const splashScreen = document.getElementById('splashScreen');
                    const orangeOverlay = document.getElementById('orangeOverlay');
                    const loginSection = document.getElementById('loginSection');
                    if (splashScreen) {
                        splashScreen.style.display = 'none';
                        splashScreen.classList.add('splash-hidden');
                    }
                    if (orangeOverlay) {
                        orangeOverlay.classList.add('hidden');
                        orangeOverlay.style.display = 'none';
                    }
                    // Hide login section and show menu immediately
                    if (loginSection) {
                        loginSection.style.display = 'none';
                        loginSection.classList.add('d-none');
                    }
                    // Force show menu - don't wait for anything
                    hideAllMainScreens();
                    const menuElement = document.getElementById('toolScannerMenu');
                    if (menuElement) {
                        menuElement.style.display = 'block';
                        console.log('Menu shown via skipSplash flag in auth handler');
                    } else {
                        console.error('toolScannerMenu element not found!');
                    }
                    // Clear the flag
                    sessionStorage.removeItem('skipSplash');
                    // Continue with normal flow - don't return, we still need to fetch user data
                }
                
                // Always fetch fresh data from Firestore
                db.collection('technicians').doc(user.uid)
                    .get()
                    .then(doc => {
                        if (doc.exists) {
                            const technicianData = doc.data();
                            const name = technicianData.fullName || user.email;
                            // Store the document ID
                            localStorage.setItem('techniciansId', doc.id);
                            localStorage.setItem('fullName', name);
                            document.getElementById('fullName').textContent = name;
                            
                            // Check if user is admin
                            if (technicianData.isAdmin) {
                                const adminButton = document.getElementById('adminButton');
                                if (adminButton) {
                                    adminButton.style.display = 'inline-block';
                                }
                                // Show Tool Administrator button in menu
                                const menuAdminBtn = document.getElementById('menuAdminBtn');
                                if (menuAdminBtn) {
                                    menuAdminBtn.style.display = 'block';
                                }
                            }
                            
                            // Check if user is instructor
                            if (technicianData.isInstructor) {
                                // Show Create Training Questions button in menu
                                const menuTrainingQuestionsBtn = document.getElementById('menuTrainingQuestionsBtn');
                                if (menuTrainingQuestionsBtn) {
                                    menuTrainingQuestionsBtn.style.display = 'block';
                                }
                            }
                        } else {
                            document.getElementById('fullName').textContent = user.email;
                        }
                        updatePreviousToolsTabCount();
                    }).catch(error => {
                        console.error('Error fetching technician data:', error);
                        document.getElementById('fullName').textContent = user.email;
                        updatePreviousToolsTabCount();
                    });
                // Always show only the main menu after login or refresh
                hideAllMainScreens();
                document.getElementById('toolScannerMenu').style.display = 'block';
                updateLoggedInTechnician();
            } else {
                loginSection.style.display = 'block';
                appSection.style.display = 'none';
                adminSection.style.display = 'none';
                const adminButton = document.getElementById('adminButton');
                if (adminButton) {
                    adminButton.style.display = 'none';
                }
                document.getElementById('headerBranding').style.display = 'block';
                localStorage.removeItem('fullName');
            }
        });

        // Navigation logic for ToolScanner Menu
        function toolScannerMenu() {
            document.getElementById('toolScannerMenu').style.display = 'block';
            document.getElementById('appSection').style.display = 'none';
            // Refresh the OUT tools count when showing the menu
            updatePreviousOutToolsCount();
            // Show outstanding and overdue dialogs
            showNotificationsInSequence();
        }
        // Global variable to store selected work location
        let selectedWorkLocation = null;

        function showLocationSelectionModalForToolSubmission(toolCode) {
            console.log('Showing location selection modal for tool code:', toolCode);
            const modal = new bootstrap.Modal(document.getElementById('locationSelectionModal'));
            
            // Clear previous selection
            selectedWorkLocation = null;
            document.querySelectorAll('.location-option').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Add click handlers for location options
            document.querySelectorAll('.location-option').forEach(btn => {
                btn.onclick = function() {
                    // Remove active class from all buttons
                    document.querySelectorAll('.location-option').forEach(b => b.classList.remove('active'));
                    // Add active class to clicked button
                    this.classList.add('active');
                    selectedWorkLocation = this.getAttribute('data-location');
                    console.log('Location selected:', selectedWorkLocation);
                    
                    // Close modal and process tool submission
                    modal.hide();
                    processToolSubmission(toolCode);
                };
            });
            
            // Show the modal
            modal.show();
            
            // Handle modal hidden event (if user cancels)
            const modalElement = document.getElementById('locationSelectionModal');
            const handleModalHidden = function() {
                // Clear the tool code input if user cancels
                if (!selectedWorkLocation) {
                    document.getElementById('toolCode').value = '';
                }
                // Remove this event listener to prevent conflicts
                modalElement.removeEventListener('hidden.bs.modal', handleModalHidden);
            };
            modalElement.addEventListener('hidden.bs.modal', handleModalHidden);
        }



        function updateWorkLocationLabel() {
            const valueSpan = document.getElementById('workLocationValue');
            if (valueSpan) {
                valueSpan.textContent = selectedWorkLocation || '(not selected)';
            }
        }

        // Work Location Flash Effect
        let flashTimeout = null;

        function startWorkLocationFlash() {
            const labelSpan = document.getElementById('workLocationLabel');
            const valueSpan = document.getElementById('workLocationValue');
            
            if (!labelSpan || !valueSpan) return;

            // Clear any existing flash
            clearWorkLocationFlash();

            // Get the label text span (the "Work Location:" part)
            const labelTextSpan = labelSpan.querySelector('span:first-child');
            
            // Add flashing classes to both label and value
            if (labelTextSpan) {
                labelTextSpan.classList.add('work-location-label-flashing');
            }
            valueSpan.classList.add('work-location-value-flashing');

            // Stop flashing after exactly 4 seconds
            flashTimeout = setTimeout(() => {
                clearWorkLocationFlash();
            }, 4000);
        }

        function clearWorkLocationFlash() {
            const labelSpan = document.getElementById('workLocationLabel');
            const valueSpan = document.getElementById('workLocationValue');
            
            if (labelSpan) {
                const labelTextSpan = labelSpan.querySelector('span:first-child');
                if (labelTextSpan) {
                    labelTextSpan.classList.remove('work-location-label-flashing');
                }
            }
            
            if (valueSpan) {
                valueSpan.classList.remove('work-location-value-flashing');
            }
            
            if (flashTimeout) {
                clearTimeout(flashTimeout);
                flashTimeout = null;
            }
        }

        // Add event listener to toolCode input to trigger flash
        // Fix aria-hidden warnings by ensuring focus is properly managed when modals are hidden
        document.addEventListener('DOMContentLoaded', function() {
            // Add event listeners to all modals to handle focus management
            document.querySelectorAll('.modal').forEach(function(modal) {
                modal.addEventListener('hidden.bs.modal', function() {
                    // Blur any focused elements inside the modal
                    const focusedElement = this.querySelector(':focus');
                    if (focusedElement) {
                        focusedElement.blur();
                    }
                });
            });
        });
        
        document.addEventListener('DOMContentLoaded', function() {
            const toolCodeInput = document.getElementById('toolCode');
            if (toolCodeInput) {
                toolCodeInput.addEventListener('input', function() {
                    if (this.value.trim().length > 0) {
                        startWorkLocationFlash();
                    }
                });
            }
        });

        document.getElementById('changeWorkLocationBtn').onclick = function() {
            showLocationSelectionModalForRegisterTools();
        };

        function showRegisterTools(skipModal = false) {
            if (skipModal) {
                // If coming back from another screen, just refresh
                navigateToScreen(SCREENS.REGISTER);
                refreshRegisterToolsScreen();
            } else {
            // Show location selection dialog first, before entering register tools screen
            showLocationSelectionModalForRegisterTools();
            }
        }


        function showLocationSelectionModalForRegisterTools() {
            // Show helicopter model selection first
            showHelicopterModelSelectionModal();
        }

        function showHelicopterModelSelectionModal() {
            const modal = new bootstrap.Modal(document.getElementById('helicopterModelSelectionModal'));
            document.querySelectorAll('.helicopter-model-option').forEach(btn => {
                btn.classList.remove('active');
                // Remove any existing hover effects
                btn.style.background = '#f8f9fa';
                btn.style.borderColor = '#e9ecef';
                btn.style.transform = 'scale(1)';
                
                btn.onclick = function() {
                    document.querySelectorAll('.helicopter-model-option').forEach(b => {
                        b.classList.remove('active');
                        b.style.background = '#f8f9fa';
                        b.style.borderColor = '#e9ecef';
                        b.style.transform = 'scale(1)';
                    });
                    this.classList.add('active');
                    this.style.background = '#FF9800';
                    this.style.borderColor = '#FF9800';
                    this.style.color = 'white';
                    this.style.transform = 'scale(1.02)';
                    
                    const selectedModel = this.getAttribute('data-model');
                    modal.hide();
                    showWorkLocationSelectionModal(selectedModel);
                };
                
                // Add hover effects
                btn.onmouseenter = function() {
                    if (!this.classList.contains('active')) {
                        this.style.background = '#e9ecef';
                        this.style.borderColor = '#FF9800';
                        this.style.transform = 'scale(1.02)';
                    }
                };
                
                btn.onmouseleave = function() {
                    if (!this.classList.contains('active')) {
                        this.style.background = '#f8f9fa';
                        this.style.borderColor = '#e9ecef';
                        this.style.transform = 'scale(1)';
                    }
                };
            });
            modal.show();
        }

        function showWorkLocationSelectionModal(helicopterModel) {
            // Special handling for "Other" helicopter model
            if (helicopterModel === 'Other') {
                selectedWorkLocation = 'Other';
                updateWorkLocationLabel();
                // Enter Register Tools screen after location selection
                enterRegisterToolsScreen();
                return;
            }
            
            const modal = new bootstrap.Modal(document.getElementById('workLocationSelectionModal'));
            const modalTitle = document.getElementById('workLocationSelectionModalLabel');
            const modalBody = document.getElementById('workLocationSelectionModalBody');
            const modalOptions = document.getElementById('workLocationOptions');
            
            // Update modal title
            modalTitle.textContent = `Select Station for ${helicopterModel}`;
            
            // Clear previous content
            modalBody.innerHTML = `Select work location for <strong>${helicopterModel}</strong>:`;
            modalOptions.innerHTML = '';
            
            // Get locations for the selected helicopter model
            const locations = getLocationsForHelicopterModel(helicopterModel);
            
            // Create location buttons
            locations.forEach((location, index) => {
                const colDiv = document.createElement('div');
                colDiv.className = 'col-4 mb-3';
                
                const button = document.createElement('button');
                button.className = 'btn work-location-option w-100 p-3';
                button.setAttribute('data-location', location);
                button.style.cssText = 'background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 12px; transition: all 0.3s ease; font-weight: bold; font-size: 1.1rem; color: #333;';
                button.textContent = location;
                
                // Add hover effects
                button.onmouseenter = function() {
                    if (!this.classList.contains('active')) {
                        this.style.background = '#e9ecef';
                        this.style.borderColor = '#FF9800';
                        this.style.transform = 'scale(1.02)';
                    }
                };
                
                button.onmouseleave = function() {
                    if (!this.classList.contains('active')) {
                        this.style.background = '#f8f9fa';
                        this.style.borderColor = '#e9ecef';
                        this.style.transform = 'scale(1)';
                    }
                };
                
                // Add click handler
                button.onclick = function() {
                    document.querySelectorAll('.work-location-option').forEach(b => {
                        b.classList.remove('active');
                        b.style.background = '#f8f9fa';
                        b.style.borderColor = '#e9ecef';
                        b.style.transform = 'scale(1)';
                    });
                    this.classList.add('active');
                    this.style.background = '#FF9800';
                    this.style.borderColor = '#FF9800';
                    this.style.color = 'white';
                    this.style.transform = 'scale(1.02)';
                    
                    selectedWorkLocation = this.getAttribute('data-location');
                    modal.hide();
                    updateWorkLocationLabel();
                    // Enter Register Tools screen after location selection
                    enterRegisterToolsScreen();
                };
                
                colDiv.appendChild(button);
                modalOptions.appendChild(colDiv);
            });
            
            modal.show();
        }

        function getLocationsForHelicopterModel(model) {
            const locationMap = {
                'AW139': ['701', '702', '703'],
                'SA342L': ['352', '353', '354', '355'],
                'B206L': ['110', '111'],
                'H145M': ['1955', '1956', '1957', '1958', '1959', '1960'],
                'Other': ['Other']
            };
            return locationMap[model] || [];
        }

        function goBackToHelicopterModels() {
            // Get the current work location modal
            const workLocationModalElement = document.getElementById('workLocationSelectionModal');
            const workLocationModal = bootstrap.Modal.getInstance(workLocationModalElement);
            
            if (workLocationModal) {
                // Hide the current modal and show helicopter model modal when hidden
                workLocationModalElement.addEventListener('hidden.bs.modal', function onHidden() {
                    workLocationModalElement.removeEventListener('hidden.bs.modal', onHidden);
                    showHelicopterModelSelectionModal();
                }, { once: true });
                
                workLocationModal.hide();
            } else {
                // Fallback: manually hide and show
                if (workLocationModalElement) {
                    workLocationModalElement.classList.remove('show');
                    workLocationModalElement.style.display = 'none';
                    document.body.classList.remove('modal-open');
                    
                    // Remove backdrop
                    const backdrop = document.querySelector('.modal-backdrop');
                    if (backdrop) {
                        backdrop.remove();
                    }
                    
                    // Show helicopter model modal
                    setTimeout(() => {
                        showHelicopterModelSelectionModal();
                    }, 150);
                }
            }
        }

        function refreshRegisterToolsScreen() {
            // Clear the tool code input
            const toolCodeInput = document.getElementById('toolCode');
            if (toolCodeInput) {
                toolCodeInput.value = '';
            }
            
            // Stop any flashing effects
            clearWorkLocationFlash();
            
            // Clear all active countdowns
            clearAllCountdowns();
            
            // Update the work location label
            updateWorkLocationLabel();
            
            // Reload tools list
            loadTools();
            
            // Show notifications
            showNotificationsInSequence();
        }

        function enterRegisterToolsScreen() {
            // Hide the menu and show the register tools screen
            navigateToScreen(SCREENS.REGISTER);
            
            // Refresh the screen
            refreshRegisterToolsScreen();
        }

        // Track scanner controls box visibility state
        let scannerControlsVisible = true;
        
        // Navigation history for back button support
        let navigationHistory = [];
        const SCREENS = {
            MENU: 'toolScannerMenu',
            REGISTER: 'appSection',
            MY_TOOLS: 'myToolsScreen'
        };
        
        // Track current screen
        function getCurrentScreen() {
            const menu = document.getElementById('toolScannerMenu');
            const register = document.getElementById('appSection');
            const myTools = document.getElementById('myToolsScreen');
            
            if (menu && menu.style.display !== 'none') return SCREENS.MENU;
            if (register && register.style.display !== 'none') return SCREENS.REGISTER;
            if (myTools && myTools.style.display !== 'none') return SCREENS.MY_TOOLS;
            return SCREENS.MENU; // Default
        }
        
        // Navigate to a screen and track history
        function navigateToScreen(targetScreen, addToHistory = true) {
            const currentScreen = getCurrentScreen();
            
            // Hide all screens
            document.getElementById('toolScannerMenu').style.display = 'none';
            document.getElementById('appSection').style.display = 'none';
            document.getElementById('myToolsScreen').style.display = 'none';
            
            // Show target screen
            document.getElementById(targetScreen).style.display = 'block';
            
            // Add to history if navigating forward (not going back)
            if (addToHistory && currentScreen !== targetScreen) {
                navigationHistory.push(currentScreen);
                // Limit history to prevent memory issues
                if (navigationHistory.length > 10) {
                    navigationHistory.shift();
                }
            }
        }
        
        // Go back to previous screen
        function goBack() {
            if (navigationHistory.length > 0) {
                const previousScreen = navigationHistory.pop();
                navigateToScreen(previousScreen, false);
                
                // Special handling for different screens
                if (previousScreen === SCREENS.MENU) {
                    updatePreviousOutToolsCount();
                } else if (previousScreen === SCREENS.REGISTER) {
                    refreshRegisterToolsScreen();
                }
                
                // Stop camera if going back from register tools
                if (getCurrentScreen() !== SCREENS.REGISTER) {
                    stopCamera();
                }
                
                return true; // Successfully went back
            }
            return false; // No history to go back to
        }
        
        // Toggle scanner controls box
        function toggleScannerControls() {
            const scannerBox = document.getElementById('scannerControlsBox');
            if (scannerBox) {
                scannerControlsVisible = !scannerControlsVisible;
                scannerBox.style.display = scannerControlsVisible ? 'block' : 'none';
                
                // If hiding the scanner box, stop the camera
                if (!scannerControlsVisible) {
                    stopCamera();
                }
            }
        }
        
        // Handle browser back button and Android back button
        window.addEventListener('popstate', function(event) {
            // Go back in navigation history
            if (!goBack()) {
                // If no history, allow default browser behavior (go to previous page)
                // This prevents getting stuck
            }
        });
        
        // Handle Android hardware back button (Cordova/PhoneGap)
        document.addEventListener('backbutton', function(event) {
            event.preventDefault();
            if (!goBack()) {
                // If no history, exit app (for mobile apps)
                if (window.cordova || window.PhoneGap) {
                    navigator.app.exitApp();
                } else {
                    // For web, go to login or close
                    const loginSection = document.getElementById('loginSection');
                    if (loginSection && loginSection.style.display !== 'none') {
                        // Already at login, do nothing
                    } else {
                        // Go back to menu if at a screen
                        navigateToScreen(SCREENS.MENU, false);
                    }
                }
            }
        }, false);
        
        // Also handle backspace key (for desktop browsers) - disabled to avoid conflicts
        // Users can use browser back button or Alt+Left Arrow instead

        document.addEventListener('DOMContentLoaded', function() {
            // Set up automatic cleanup every 24 hours
            setInterval(cleanupUnverifiedAccounts, 24 * 60 * 60 * 1000); // Every 24 hours
            
            // Also run cleanup on page load (once per day)
            const lastCleanup = localStorage.getItem('lastCleanupDate');
            const today = new Date().toDateString();
            if (lastCleanup !== today) {
                cleanupUnverifiedAccounts();
                localStorage.setItem('lastCleanupDate', today);
            }
            
            // Set up Scan Tool tab toggle functionality
            const scanToolTab = document.getElementById('scanToolTab');
            if (scanToolTab) {
                scanToolTab.addEventListener('click', function(e) {
                    const scannerView = document.getElementById('scannerView');
                    
                    // Check if tab is already active before Bootstrap processes the click
                    const wasActive = scannerView && scannerView.classList.contains('active');
                    
                    // If tab was already active, toggle scanner box instead of switching tabs
                    if (wasActive) {
                        e.preventDefault();
                        e.stopPropagation();
                        toggleScannerControls();
                        // Manually ensure tab stays active
                        scanToolTab.classList.add('active');
                        scanToolTab.setAttribute('aria-selected', 'true');
                        return false;
                    }
                });
            }
            
            // Set up menu button event handlers
            const menuRegisterBtn = document.getElementById('menuRegisterBtn');
            const menuLogoutBtn = document.getElementById('menuLogoutBtn');
            const menuAdminBtn = document.getElementById('menuAdminBtn');
            const menuTrainingQuestionsBtn = document.getElementById('menuTrainingQuestionsBtn');
            
            if (menuRegisterBtn) {
                menuRegisterBtn.addEventListener('click', function() {
                    console.log('Register Tools button clicked');
                    // Navigate to register-tools.html
                    window.location.href = 'register-tools.html';
                });
            }
            
            if (menuAdminBtn) {
                menuAdminBtn.addEventListener('click', function() {
                    console.log('Tool Administrator button clicked');
                    // Redirect to admin.html
                    window.location.href = 'admin.html';
                });
            }
            
            if (menuTrainingQuestionsBtn) {
                menuTrainingQuestionsBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    console.log('Create Training Questions button clicked');
                    
                    // Force navigation within the same window
                    // Use replace to avoid opening new window/tab
                    const targetUrl = 'pdf-question-generator.html';
                    
                    // Try multiple methods to ensure it works
                    if (window.location.replace) {
                        window.location.replace(targetUrl);
                    } else if (window.location.assign) {
                        window.location.assign(targetUrl);
                    } else {
                        window.location.href = targetUrl;
                    }
                    
                    return false;
                });
            }
            
            if (menuLogoutBtn) {
                menuLogoutBtn.addEventListener('click', function() {
                    console.log('Logout button clicked');
                    logout();
                });
            }
            
            // Orange overlay logic
            const orangeOverlay = document.getElementById('orangeOverlay');
            const splashScreen = document.getElementById('splashScreen');
            const splashVideo = document.getElementById('splashVideo');
            
            // Check if we should skip splash (coming from register-tools or other pages)
            const skipSplash = sessionStorage.getItem('skipSplash');
            if (skipSplash === 'true') {
                console.log('skipSplash detected - hiding splash and showing menu');
                // Hide splash screen immediately
                if (splashScreen) {
                    splashScreen.style.display = 'none';
                    splashScreen.classList.add('splash-hidden');
                }
                if (orangeOverlay) {
                    orangeOverlay.classList.add('hidden');
                    orangeOverlay.style.display = 'none';
                }
                // Hide login section immediately
                const loginSection = document.getElementById('loginSection');
                if (loginSection) {
                    loginSection.style.display = 'none';
                    loginSection.classList.add('d-none');
                }
                
                // Force show menu - auth handler already handled it, just ensure it stays visible
                // The auth.onAuthStateChanged handler above should have already shown the menu
                // But ensure it's visible here too as backup
                setTimeout(() => {
                    const menuEl = document.getElementById('toolScannerMenu');
                    if (menuEl && menuEl.style.display !== 'block') {
                        hideAllMainScreens();
                        menuEl.style.display = 'block';
                        console.log('Menu shown via skipSplash backup check');
                    }
                }, 100);
                
                // CRITICAL: Return immediately to prevent ANY splash screen logic from running
                return; // Exit early, don't show splash
            }
            
            // iOS Safari autoplay workaround
            function attemptVideoPlay() {
                if (splashVideo) {
                    console.log('Attempting to play video...');
                    console.log('Video readyState:', splashVideo.readyState);
                    console.log('Video networkState:', splashVideo.networkState);
                    console.log('Video src:', splashVideo.currentSrc);
                    
                    splashVideo.currentTime = 0;
                    const playPromise = splashVideo.play();
                    
                    if (playPromise !== undefined) {
                        playPromise.then(() => {
                            console.log('Video started playing successfully');
                        }).catch(error => {
                            console.log('Video autoplay failed:', error);
                            console.log('Error name:', error.name);
                            console.log('Error message:', error.message);
                            // On iOS, we might need to show a play button or skip video
                            showFallbackSplash();
                        });
                    }
                } else {
                    console.log('No video element found');
                    showFallbackSplash();
                }
            }
            
            function showFallbackSplash() {
                // Hide video and show static splash content
                if (splashVideo) {
                    splashVideo.style.display = 'none';
                }
                const splashContent = document.getElementById('splashContent');
                if (splashContent) {
                    splashContent.style.display = 'block';
                }
                
                // Hide splash after 3 seconds
                setTimeout(() => {
                    splashScreen.classList.add('splash-hidden');
                    setTimeout(() => {
                        splashScreen.style.display = 'none';
                    }, 500);
                }, 3000);
            }
            
            // Show orange overlay for 0.5s, then attempt video splash
            // BUT skip if skipSplash flag is set
            const skipSplashCheck = sessionStorage.getItem('skipSplash');
            if (skipSplashCheck === 'true') {
                // Already handled above, don't show splash video
                console.log('Skipping splash video - skipSplash flag is set');
                return; // Exit early, don't show splash
            }
            
            setTimeout(() => {
                orangeOverlay.classList.add('hidden');
                
                if (splashVideo) {
                    let splashHidden = false;
                    function hideSplashScreen() {
                        if (!splashHidden) {
                            splashScreen.classList.add('splash-hidden');
                            setTimeout(() => {
                                splashScreen.style.display = 'none';
                            }, 500);
                            splashHidden = true;
                        }
                    }
                    
                    // Try to play video
                    attemptVideoPlay();
                    
                    // Listen for video events
                    splashVideo.addEventListener('ended', hideSplashScreen);
                    
                    // One-time event listeners (only log once)
                    let videoEventsLogged = {
                        canplaythrough: false,
                        canplay: false,
                        loadeddata: false,
                        loadstart: false
                    };
                    
                    splashVideo.addEventListener('canplaythrough', () => {
                        if (!videoEventsLogged.canplaythrough) {
                        console.log('Video can play through');
                            videoEventsLogged.canplaythrough = true;
                        }
                    });
                    splashVideo.addEventListener('canplay', () => {
                        if (!videoEventsLogged.canplay) {
                        console.log('Video can play');
                            videoEventsLogged.canplay = true;
                        }
                    });
                    splashVideo.addEventListener('loadeddata', () => {
                        if (!videoEventsLogged.loadeddata) {
                        console.log('Video loaded data');
                            videoEventsLogged.loadeddata = true;
                        }
                    });
                    splashVideo.addEventListener('loadstart', () => {
                        if (!videoEventsLogged.loadstart) {
                        console.log('Video load started');
                            videoEventsLogged.loadstart = true;
                        }
                    });
                    splashVideo.addEventListener('error', (e) => {
                        console.log('Video error:', e);
                        console.log('Video error details:', splashVideo.error);
                        showFallbackSplash();
                    });
                    
                    // Fallback: hide after 6 seconds if video doesn't end
                    setTimeout(hideSplashScreen, 6000);
                } else {
                    showFallbackSplash();
                }
            }, 500); // 0.5 seconds orange overlay
            
            // iOS Safari: Add user interaction handler to trigger video playback
            let userInteracted = false;
            function handleUserInteraction() {
                if (!userInteracted && splashVideo && splashVideo.paused) {
                    userInteracted = true;
                    console.log('User interaction detected, attempting to play video');
                    splashVideo.play().then(() => {
                        console.log('Video started playing after user interaction');
                    }).catch(error => {
                        console.log('Video play failed even after user interaction:', error);
                    });
                }
            }
            
            // Listen for various user interactions
            document.addEventListener('touchstart', handleUserInteraction, { once: true });
            document.addEventListener('click', handleUserInteraction, { once: true });
            document.addEventListener('keydown', handleUserInteraction, { once: true });
        });

        document.getElementById('backToMenuBtn').onclick = function() {
            navigateToScreen(SCREENS.MENU);
            // Refresh the OUT tools count when returning to menu
            updatePreviousOutToolsCount();
        };

        // My Tools menu button handler: navigate to my-tools.html
        document.getElementById('menuMyToolsBtn').onclick = function() {
            // Navigate to my-tools.html
            window.location.href = 'my-tools.html';
        };

        // Show My Tools by Collection screen
        // Function to detect if device is mobile
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                   window.innerWidth <= 768;
        }

        // Function to get responsive button text
        function getResponsiveButtonText(desktopText, mobileText) {
            return isMobileDevice() ? mobileText : desktopText;
        }

        // Function to get location photo count
        async function getLocationPhotoCount(collectionName, location) {
            try {
                const documentId = `${collectionName}_${location}`;
                const docRef = db.collection('locationPhotos').doc(documentId);
                const doc = await docRef.get();
                
                if (doc.exists) {
                    const data = doc.data();
                    return data.photoUrls ? data.photoUrls.length : 0;
                }
                return 0;
            } catch (error) {
                console.error('Error getting photo count:', error);
                return 0;
            }
        }

        async function showMyToolsByCollection(collectionName) {
            lastViewedCollectionName = collectionName;
            const user = auth.currentUser;
            const fullName = localStorage.getItem('fullName') || (user ? user.email : '');
            console.log('showMyToolsByCollection called with:', collectionName);
            console.log('Querying tools for owner:', fullName, 'and collectionCode:', collectionName);
            document.getElementById('toolScannerMenu').style.display = 'none';
            document.getElementById('appSection').style.display = 'none';
            document.getElementById('myToolsByCollectionScreen').style.display = 'block';
            document.getElementById('collectionCheckupScreen').style.display = 'none';
            const title = document.getElementById('myToolsCollectionTitle');
            const list = document.getElementById('myToolsByCollectionList');
            title.textContent = `Collection: ${collectionName}`;
            list.innerHTML = '<div class="text-center">Loading...</div>';
            
            // Update button text based on device type
            updateResponsiveButtonText();
            
            // Update collection photo button counts
            await updateCollectionPhotoButtonCounts();
            try {
                // Query tools where collectionCode matches the collectionName
                const snapshot = await db.collection('tools')
                    .where('owner', '==', fullName)
                    .where('collectionCode', '==', collectionName)
                    .get();
                console.log('Tools found:', snapshot.size);
                snapshot.docs.forEach(doc => {
                    console.log('Tool:', doc.id, doc.data());
                });
                if (snapshot.empty) {
                    list.innerHTML = '<div class="text-center text-danger">No tools found in this collection.</div>';
                    lastViewedCollectionTools = [];
                    return;
                }
                // Group tools by location
                const tools = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                lastViewedCollectionTools = tools;
                const locations = [...new Set(tools.map(t => t.location || 'No Location'))];
                locations.sort();
                // OUT tools first, then IN, then others
                const getStatusOrder = status => {
                    if (!status) return 2;
                    const s = status.toUpperCase();
                    if (s === 'OUT') return 0;
                    if (s === 'IN') return 1;
                    return 2;
                };
                // Filtering state
                let selectedLocation = 'All';
                // Render location filter row (make sticky)
                let filterHtml = '<div id="locationFilterBar" style="display:flex;gap:8px;overflow-x:auto;position:sticky;top:0;z-index:10;background:#fff;padding:8px 0 8px 0;border-bottom:2px solid #FF9800;margin-bottom:10px;">';
                filterHtml += `<button class="btn btn-sm ${selectedLocation==='All'?'btn-orange':'btn-outline-secondary'}" data-location="All" style="${selectedLocation==='All'?'background-color:#FF9800;color:white;border-color:#FF9800;':'background-color:transparent;color:#6c757d;border-color:#6c757d;'}">All</button>`;
                locations.forEach(loc => {
                  filterHtml += `<button class="btn btn-sm ${selectedLocation===loc?'btn-orange':'btn-outline-secondary'}" data-location="${loc}" style="${selectedLocation===loc?'background-color:#FF9800;color:white;border-color:#FF9800;':'background-color:transparent;color:#6c757d;border-color:#6c757d;'}">${loc}</button>`;
                });
                filterHtml += '</div>';
                // Initial filtered tools
                let filteredTools = tools.slice();
                // Render function
                async function renderToolsByLocation(selectedLoc) {
                    // Update the filter bar with new selected state
                    let filterHtml = '<div id="locationFilterBar" style="display:flex;gap:8px;overflow-x:auto;position:sticky;top:0;z-index:10;background:#fff;padding:8px 0 8px 0;border-bottom:2px solid #FF9800;margin-bottom:10px;">';
                    filterHtml += `<button class="btn btn-sm ${selectedLoc==='All'?'btn-orange':'btn-outline-secondary'}" data-location="All" style="${selectedLoc==='All'?'background-color:#FF9800;color:white;border-color:#FF9800;':'background-color:transparent;color:#6c757d;border-color:#6c757d;'}">All</button>`;
                    locations.forEach(loc => {
                      filterHtml += `<button class="btn btn-sm ${selectedLoc===loc?'btn-orange':'btn-outline-secondary'}" data-location="${loc}" style="${selectedLoc===loc?'background-color:#FF9800;color:white;border-color:#FF9800;':'background-color:transparent;color:#6c757d;border-color:#6c757d;'}">${loc}</button>`;
                    });
                    filterHtml += '</div>';
                    
                    let html = '';
                    const locs = selectedLoc === 'All' ? locations : [selectedLoc];
                    
                    // Fetch photo counts for all locations
                    console.log('Fetching photo counts for locations:', locs);
                    const photoCountPromises = locs.map(loc => getLocationPhotoCount(collectionName, loc));
                    const photoCounts = await Promise.all(photoCountPromises);
                    console.log('Photo counts received:', photoCounts);
                    
                    locs.forEach((loc, locIndex) => {
                        const toolsAtLoc = tools.filter(t => (t.location || 'No Location') === loc);
                        if (!toolsAtLoc.length) return;
                        
                        const photoCount = photoCounts[locIndex];
                        console.log(`Location: ${loc}, Photo count: ${photoCount}`);
                        const photoText = getResponsiveButtonText(`Photos (${photoCount})`, `Pics (${photoCount})`);
                        
                        html += `<div style="background:#FF9800;color:white;font-weight:bold;font-size:1.1em;padding:4px 12px;border-radius:6px 6px 0 0;position:sticky;top:0;z-index:5;display:flex;align-items:center;justify-content:space-between;">
                            <span>Location: ${loc} (Total: ${toolsAtLoc.length} tools)</span>
                            <button class="btn btn-sm btn-info ms-2" style="background:#1976d2;color:white;font-weight:bold;" onclick="event.stopPropagation(); showLocationPhotosFromTitleBar('${collectionName}','${loc}')">
                                <i class="fas fa-images"></i> ${photoText}
                            </button>
                        </div>`;
                        // OUT first, then IN, then others
                        const sorted = toolsAtLoc.slice().sort((a, b) => getStatusOrder(a.status) - getStatusOrder(b.status));
                        sorted.forEach((tool, idx) => {
                            const status = (tool.status || '').toUpperCase();
                            let bg = '#E8F5E9';
                            let statusColor = '#388E3C';
                            if (status === 'OUT') { bg = '#FFEBEE'; statusColor = '#d32f2f'; }
                            else if (status === 'BROKEN') { bg = '#FFF3E0'; statusColor = '#ff6f00'; }
                            else if (status === 'LOST') { bg = '#FFE0B2'; statusColor = '#ff8f00'; }
                            else if (status === 'CALIBRATION') { bg = '#E3F2FD'; statusColor = '#1976d2'; }
                            
                            html += `<div style="background:${bg};border-radius:0 0 6px 6px;margin-bottom:8px;padding:12px 12px 8px 12px;">
                                <div style="cursor:pointer;" onclick="showToolDetailsFromMyTools(${JSON.stringify(tool).replace(/"/g, '&quot;')})">
                                <div style="font-weight:bold;font-size:1.13rem;color:#1976d2;display:block !important;margin-bottom:4px;">${idx + 1}. ${tool.toolName || 'Unknown Tool'}</div>
                                <div style="font-weight:bold;display:block !important;margin-bottom:4px;">TID: ${tool.id}</div>
                                <span style="display:flex;align-items:center;justify-content:space-between;">
                                    <span style="font-size:1.01rem;color:#444;">Part #: ${tool.partNumber || ''}</span>
                                    <span style="font-size:1.01rem;font-weight:bold;color:#222;">WorkOn: <span style="color:#888;font-weight:bold;">${(typeof tool.WorkOn === 'string' && tool.WorkOn.trim()) ? tool.WorkOn : 'N/A'}</span></span>
                                </span><br>
                                <span style="font-weight:bold;color:${statusColor};">Status: ${tool.status || ''}</span><br>
                                <span style="font-size:1.01rem;color:#222;">Location: ${tool.location || ''}</span><br>
                                <span style="font-size:1.01rem;color:#1976d2;font-weight:bold;">Cal Due Date: ${tool.calDueDate || 'N/A'}</span>
                                </div>
                                <div style="margin-top:8px;display:flex;gap:8px;justify-content:flex-end;">
                                    <button onclick="event.stopPropagation(); createPhotoUploadInput('${tool.id}', '${tool.partNumber || tool.id}')" 
                                            style="background:#FF9800;color:white;border:none;border-radius:16px;padding:6px 12px;font-size:0.9rem;font-weight:bold;cursor:pointer;">
                                        <i class="fas fa-camera"></i> ${getResponsiveButtonText('Add Photo', 'Add')}
                                    </button>
                                    ${tool.photoUrls && tool.photoUrls.length > 0 ? 
                                        `<button onclick="event.stopPropagation(); showToolPhotoGallery(this)" 
                                                data-photo-urls='${JSON.stringify(tool.photoUrls)}'
                                                data-tool-id='${tool.id}'
                                                data-part-number='${tool.partNumber || tool.id}'
                                                style="background:#1976d2;color:white;border:none;border-radius:16px;padding:6px 12px;font-size:0.9rem;font-weight:bold;cursor:pointer;">
                                            <i class="fas fa-images"></i> ${getResponsiveButtonText('Photos', 'Pics')} (${tool.photoUrls.length})
                                        </button>` : ''
                                    }
                                </div>
                            </div>`;
                        });
                    });
                    list.innerHTML = filterHtml + `<div style="height:calc(100vh - 300px);overflow-y:auto;padding-right:5px;">` + html + `</div>`;
                    // Add event listeners for filter buttons
                    list.querySelectorAll('button[data-location]').forEach(btn => {
                        btn.onclick = async function() {
                            selectedLocation = this.getAttribute('data-location');
                            await renderToolsByLocation(selectedLocation);
                        };
                    });
                    

                }
                await renderToolsByLocation(selectedLocation);
            } catch (e) {
                title.textContent = `Collection: ${collectionName}`;
                list.innerHTML = '<div class="text-center text-danger">Error loading tools.</div>';
                lastViewedCollectionTools = [];
            }
        }

        // Function to update button text based on device type
        function updateResponsiveButtonText() {
            // Title bar buttons
            const addPhotoBtn = document.getElementById('myToolsByCollectionAddPhotoBtn');
            const photosBtn = document.getElementById('myToolsByCollectionPhotosBtn');
            
            if (addPhotoBtn) {
                addPhotoBtn.innerHTML = `<i class="fas fa-camera"></i> ${getResponsiveButtonText('Add Collection Photo', 'Add Photo')}`;
            }
            
            if (photosBtn) {
                photosBtn.innerHTML = `<i class="fas fa-images"></i> ${getResponsiveButtonText('Collection Photos', 'Photos')}`;
            }
            
            // Main action buttons
            const checkupBtn = document.getElementById('collectionCheckupBtn');
            const selectCollectionBtn = document.getElementById('selectDifferentCollectionBtn');
            const locationPhotoBtn = document.getElementById('locationPhotoBtn');
            const backBtn = document.getElementById('backToCollectionSelectBtn');
            
            if (checkupBtn) {
                checkupBtn.innerHTML = `<i class="fas fa-clipboard-check"></i> ${getResponsiveButtonText('Collection Checkup', 'Checkup')}`;
            }
            
            if (selectCollectionBtn) {
                selectCollectionBtn.innerHTML = `<i class="fas fa-exchange-alt"></i> ${getResponsiveButtonText('Select Collection', 'Change')}`;
            }
            
            if (locationPhotoBtn) {
                locationPhotoBtn.innerHTML = `<i class="fas fa-camera"></i> ${getResponsiveButtonText('Add Location Photo', 'Add Location Photo')}`;
            }
            
            if (backBtn) {
                backBtn.innerHTML = `<i class="fas fa-arrow-left"></i> ${getResponsiveButtonText('Back to Menu', 'Back')}`;
            }
        }

        // Function to show checkout info dialog from My Tools screen
        async function showToolDetailsFromMyTools(tool) {
            // Format timestamp for display
            const formatTimestamp = (timestamp) => {
                if (!timestamp) return 'N/A';
                if (timestamp.toDate) {
                    return timestamp.toDate().toLocaleString('en-GB', {
                        day: '2-digit', month: '2-digit', year: 'numeric', 
                        hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
                    });
                }
                if (timestamp.seconds) {
                    // Firestore Timestamp object
                    return new Date(timestamp.seconds * 1000).toLocaleString('en-GB', {
                        day: '2-digit', month: '2-digit', year: 'numeric',
                        hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
                    });
                }
                return timestamp;
            };
            
            // Show loading state
            const modal = new bootstrap.Modal(document.getElementById('checkoutInfoModal'));
            const modalTitle = document.getElementById('checkoutInfoModalTitle');
            const modalBody = document.getElementById('checkoutInfoModalBody');
            
            modalTitle.textContent = 'Loading...';
            modalBody.innerHTML = '<div class="text-center">Loading checkout information...</div>';
            modal.show();
            
            try {
                const status = tool.status || 'N/A';
                let title = '';
                let field1Label = '';
                let field1Value = '';
                let field2Label = '';
                let field2Value = '';
                
                if (status === 'OUT') {
                    // Tool is currently checked out - get data from tools collection
                    title = 'Tool Checkout Information';
                    field1Label = 'Checked Out By:';
                    field2Label = 'ChkOut Date:';
                    
                    // Get fresh data from tools collection
                    const toolDoc = await db.collection('tools').doc(tool.id).get();
                    if (toolDoc.exists) {
                        const toolData = toolDoc.data();
                        field1Value = toolData.technician || 'N/A';
                        field2Value = formatTimestamp(toolData.timestamp);
                    } else {
                        field1Value = 'N/A';
                        field2Value = 'N/A';
                    }
                } else if (status === 'IN') {
                    // Tool is currently in - get the most recent movement for this tool
                    title = 'Last Tool Movement Information';
                    field1Label = 'Technician:';
                    field2Label = 'Date:';
                    try {
                        const logSnapshot = await db.collection('logtoolmovements')
                            .where('toolId', '==', tool.id)
                            .orderBy('timestamp', 'desc')
                            .limit(1)
                            .get();
                        if (!logSnapshot.empty) {
                            const lastLogEntry = logSnapshot.docs[0].data();
                            field1Value = lastLogEntry.technician || 'N/A';
                            field2Value = formatTimestamp(lastLogEntry.timestamp);
                        } else {
                            field1Value = tool.technician || 'N/A';
                            field2Value = formatTimestamp(tool.timestamp);
                        }
                    } catch (logError) {
                        console.error('Error querying logtoolmovements:', logError);
                        field1Value = tool.technician || 'N/A';
                        field2Value = formatTimestamp(tool.timestamp);
                    }
                } else {
                    // Other statuses
                    title = 'Tool Information';
                    field1Label = 'Status:';
                    field1Value = tool.status || 'N/A';
                    field2Label = 'Technician:';
                    field2Value = tool.technician || 'N/A';
                }
                
                // Update the modal with fetched data
                modalTitle.textContent = title;
                modalBody.innerHTML = `
                    <div class="mb-3">
                        <strong style="color: #222; font-size: 1.1em;">${field1Label}</strong>
                        <div style="color: #1976d2; font-size: 1.0em; margin-top: 4px;">${field1Value}</div>
                    </div>
                    <div class="mb-3">
                        <strong style="color: #222; font-size: 1.1em;">${field2Label}</strong>
                        <div style="color: #1976d2; font-size: 1.0em; margin-top: 4px;">${field2Value}</div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error fetching checkout information:', error);
                console.error('Tool data:', tool);
                console.error('Tool status:', tool.status);
                console.error('Tool ID:', tool.id);
                
                modalTitle.textContent = 'Error';
                modalBody.innerHTML = `
                    <div class="text-center text-danger">
                        Error loading checkout information. Please try again.<br>
                        <small>Status: ${tool.status || 'N/A'}<br>
                        Tool ID: ${tool.id || 'N/A'}</small>
                    </div>
                `;
            }
        }

        // Back button for My Tools by Collection
        const backToCollectionSelectBtn = document.getElementById('backToCollectionSelectBtn');
        if (backToCollectionSelectBtn) {
            backToCollectionSelectBtn.textContent = 'Back to Menu';
            backToCollectionSelectBtn.onclick = function() {
                document.getElementById('myToolsByCollectionScreen').style.display = 'none';
                document.getElementById('toolScannerMenu').style.display = 'block';
                // Refresh the OUT tools count when returning to menu
                updatePreviousOutToolsCount();
            };
        }

        // Show notifications in sequence, not simultaneously
        async function showNotificationsInSequence() {
            console.log('showNotificationsInSequence called');
            let outstandingNeeded = false;
            let overdueNeeded = false;
            let outstandingMsg = '';
            let overdueMsg = '';

            const user = auth.currentUser;
            console.log('Current user:', user);
            const afterNotif = await isAfterNotificationTime();
            console.log('After notification time:', afterNotif);
            if (user && afterNotif) {
                const fullName = localStorage.getItem('fullName') || user.email;
                const now = new Date();
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                // Query all OUT tools for this user as owner
                const snapshot = await db.collection('tools')
                    .where('owner', '==', fullName)
                    .where('status', '==', 'OUT')
                    .get();
                console.log('Tools where user is owner and OUT:', snapshot.docs.length);
                let ownerToday = 0;
                let ownerPrev = 0;
                let techToolIds = new Set();
                // Also collect tool IDs where user is technician for later
                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    // Only count if technician is NOT the owner
                    if (data.technician !== fullName) {
                        if (data.timestamp && data.timestamp.toDate) {
                            const outTime = data.timestamp.toDate();
                            if (outTime >= today) {
                                ownerToday++;
                            } else {
                                ownerPrev++;
                            }
                        }
                    } else {
                        techToolIds.add(doc.id);
                    }
                });
                console.log('ownerToday:', ownerToday, 'ownerPrev:', ownerPrev);
                if (ownerToday > 0 || ownerPrev > 0) {
                    outstandingNeeded = true;
                    outstandingMsg = '<b>ACTION REQUIRED:</b> THE FOLLOWING TOOLS YOU OWN ARE STILL CHECKED OUT BY OTHERS.';
                    if (ownerToday > 0) outstandingMsg += `<br>- <b>${ownerToday} TOOL${ownerToday > 1 ? 'S' : ''} CHECKED OUT TODAY</b>.`;
                    if (ownerPrev > 0) outstandingMsg += `<br>- <b>${ownerPrev} TOOL${ownerPrev > 1 ? 'S' : ''} CHECKED OUT FROM PREVIOUS DATES</b>.`;
                    outstandingMsg += `<br><span style="display: flex; align-items: center; margin-top: 8px;"><i class='fas fa-bell' style='color: #1976D2; margin-right: 4px;'></i>PLEASE FOLLOW UP TO ENSURE THESE TOOLS ARE RETURNED.</span>`;
                }
                // Now check as technician, count all tools where user is technician (regardless of owner)
                const technicianDoc = await db.collection('technicians').doc(user.uid).get();
                const technicianName = technicianDoc.exists ? technicianDoc.data().fullName : 'UNKNOWN TECHNICIAN';
                console.log('Technician name:', technicianName);
                const techSnapshot = await db.collection('tools')
                    .where('technician', '==', technicianName)
                    .where('status', '==', 'OUT')
                    .get();
                console.log('Tools where user is technician and OUT:', techSnapshot.docs.length);
                let techToday = 0;
                let techPrev = 0;
                techSnapshot.docs.forEach(doc => {
                    const data = doc.data();
                    if (data.timestamp && data.timestamp.toDate) {
                        const outTime = data.timestamp.toDate();
                        if (outTime >= today) {
                            techToday++;
                        } else {
                            techPrev++;
                        }
                    }
                });
                console.log('techToday:', techToday, 'techPrev:', techPrev);
                if (techToday > 0 || techPrev > 0) {
                    overdueNeeded = true;
                    overdueMsg = '<b>REMINDER:</b> YOU HAVE TOOLS CHECKED OUT THAT NEED TO BE RETURNED.';
                    if (techToday > 0) overdueMsg += `<br>- <b>${techToday} TOOL${techToday > 1 ? 'S' : ''} CHECKED OUT TODAY</b>.`;
                    if (techPrev > 0) overdueMsg += `<br>- <b>${techPrev} TOOL${techPrev > 1 ? 'S' : ''} CHECKED OUT FROM PREVIOUS DATES</b>.`;
                    overdueMsg += `<br><span style="display: flex; align-items: center; margin-top: 8px;"><i class='fas fa-undo' style='color: #1976D2; margin-right: 4px;'></i>PLEASE RETURN THESE TOOLS AS SOON AS POSSIBLE.</span>`;
                }
            } else {
                console.log('User not logged in or before notification time');
            }
            // Show modals in sequence
            console.log('outstandingNeeded:', outstandingNeeded, 'overdueNeeded:', overdueNeeded);
            if (outstandingNeeded) {
                document.getElementById('outstandingToolsBody').innerHTML = outstandingMsg;
                const outstandingModal = new bootstrap.Modal(document.getElementById('outstandingToolsModal'));
                document.getElementById('outstandingToolsOkBtn').onclick = function() {
                    outstandingModal.hide();
                    if (overdueNeeded) {
                        setTimeout(() => {
                            document.getElementById('outToolsNotifBody').innerHTML = overdueMsg;
                            const notifModal = new bootstrap.Modal(document.getElementById('outToolsNotifModal'));
                            notifModal.show();
                        }, 300);
                    }
                };
                console.log('Showing outstandingToolsModal');
                outstandingModal.show();
            } else if (overdueNeeded) {
                document.getElementById('outToolsNotifBody').innerHTML = overdueMsg;
                const notifModal = new bootstrap.Modal(document.getElementById('outToolsNotifModal'));
                console.log('Showing outToolsNotifModal');
                notifModal.show();
            } else {
                console.log('No outstanding or overdue tools to show');
            }
        }

        // Helper to check if current time is after notificationTime (HH:mm)
        async function isAfterNotificationTime() {
            return true;
        }

        // Fetch and update previous OUT tools count for the tab
        async function updatePreviousToolsTabCount() {
            const user = auth.currentUser;
            if (!user) return;
            const technicianDoc = await db.collection('technicians').doc(user.uid).get();
            const technicianName = technicianDoc.exists ? technicianDoc.data().fullName : 'Unknown Technician';
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const snapshot = await db.collection('tools')
                .where('technician', '==', technicianName)
                .where('status', '==', 'OUT')
                .get();
            const previousTools = snapshot.docs.filter(doc => {
                const data = doc.data();
                return data.timestamp && data.timestamp.toDate() < today;
            });
            const elem = document.getElementById('previous-tab');
            if (elem) {
                elem.innerHTML = `<i class="fas fa-history"></i> Previous Tools (${previousTools.length})`;
            } else {
                console.warn('previous-tab element not found');
            }
        }

        // After login or on auth state change, update the logged-in technician display
        function updateLoggedInTechnician() {
            const user = auth.currentUser;
            if (!user) return;
            const fullName = localStorage.getItem('fullName') || user.email;
            
            // Update register screen name
            const registerScreenNameElem = document.getElementById('registerScreenName');
            if (registerScreenNameElem) {
                registerScreenNameElem.textContent = fullName;
            }
            
            // Update previous OUT tools count
            updatePreviousOutToolsCount();
        }

        // Service Worker registration with protocol check
        if ((window.location.protocol === 'https:' || window.location.hostname === 'localhost') && 'serviceWorker' in navigator) {
          navigator.serviceWorker.register('service-worker.js')
            .then(function(reg) {
              // Registration successful
            })
            .catch(function(error) {
              // Registration failed
              console.error('ServiceWorker registration failed:', error);
            });
        }

        // Collection Checkup logic
        const collectionCheckupBtn = document.getElementById('collectionCheckupBtn');
        if (collectionCheckupBtn) {
            collectionCheckupBtn.onclick = function() {
                showCollectionCheckupScreen();
            };
        }

        // Select Different Collection logic
        const selectDifferentCollectionBtn = document.getElementById('selectDifferentCollectionBtn');
        if (selectDifferentCollectionBtn) {
            selectDifferentCollectionBtn.onclick = function() {
                showCollectionSelectionDialog();
            };
        }

        // Add Location Photo logic
        const locationPhotoBtn = document.getElementById('locationPhotoBtn');
        if (locationPhotoBtn) {
            locationPhotoBtn.onclick = function() {
                showLocationPhotoUploadDialog(lastViewedCollectionName, '');
            };
        }

        async function showLocationPhotoUploadDialog(collectionName, location) {
            // Query tools collection to get all locations for this collection
            try {
                const toolsSnapshot = await db.collection('tools')
                    .where('collectionCode', '==', collectionName)
                    .get();
                
                if (toolsSnapshot.empty) {
                    alert('No tools found for this collection.');
                    return;
                }
                
                // Extract unique locations
                const locations = [...new Set(toolsSnapshot.docs.map(doc => doc.data().location).filter(Boolean))].sort();
                
                if (locations.length === 0) {
                    alert('No locations found for this collection.');
                    return;
                }
                
                // Create or show location selection modal
                let modal = document.getElementById('locationPhotoLocationSelectModal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.className = 'modal fade';
                    modal.id = 'locationPhotoLocationSelectModal';
                    modal.tabIndex = -1;
                    modal.innerHTML = `
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header bg-success text-white">
                                    <h5 class="modal-title">Select Location for Photo</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <strong>Collection:</strong> ${collectionName}
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label"><strong>Select Location:</strong></label>
                                        <select id="locationPhotoLocationSelect" class="form-select">
                                            <option value="">Choose a location...</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="button" class="btn btn-success" id="locationPhotoLocationConfirmBtn">Continue</button>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                }
                
                // Update modal content
                const locationSelect = modal.querySelector('#locationPhotoLocationSelect');
                locationSelect.innerHTML = '<option value="">Choose a location...</option>';
                locations.forEach(loc => {
                    locationSelect.innerHTML += `<option value="${loc}">${loc}</option>`;
                });
                
                // Show modal
                const bsModal = new bootstrap.Modal(modal);
                bsModal.show();
                
                // Set up continue button handler
                document.getElementById('locationPhotoLocationConfirmBtn').onclick = function() {
                    const selectedLocation = locationSelect.value;
                    if (!selectedLocation) {
                        alert('Please select a location.');
                        return;
                    }
                    
                    bsModal.hide();
                    showLocationPhotoFileUploadDialog(collectionName, selectedLocation);
                };
                
            } catch (error) {
                console.error('Error loading locations:', error);
                alert('Error loading locations. Please try again.');
            }
        }

        async function showLocationPhotoFileUploadDialog(collectionName, selectedLocation) {
            // Create or show photo source selection modal
            let modal = document.getElementById('locationPhotoSourceModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.className = 'modal fade';
                modal.id = 'locationPhotoSourceModal';
                modal.tabIndex = -1;
                modal.innerHTML = `
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header bg-success text-white">
                                <h5 class="modal-title">Choose Photo Source</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <strong>Collection:</strong> ${collectionName}<br>
                                    <strong>Location:</strong> ${selectedLocation}
                                </div>
                                <div class="d-grid gap-2">
                                    <button id="locationPhotoCameraBtn" class="btn btn-primary">
                                        <i class="fas fa-camera"></i> Take Photo with Camera
                                    </button>
                                    <button id="locationPhotoBrowseBtn" class="btn btn-secondary">
                                        <i class="fas fa-folder-open"></i> Browse from Gallery
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            // Update modal content
            const modalBody = modal.querySelector('.modal-body');
            modalBody.innerHTML = `
                <div class="mb-3">
                    <strong>Collection:</strong> ${collectionName}<br>
                    <strong>Location:</strong> ${selectedLocation}
                </div>
                <div class="d-grid gap-2">
                    <button id="locationPhotoCameraBtn" class="btn btn-primary">
                        <i class="fas fa-camera"></i> Take Photo with Camera
                    </button>
                    <button id="locationPhotoBrowseBtn" class="btn btn-secondary">
                        <i class="fas fa-folder-open"></i> Browse from Gallery
                    </button>
                </div>
            `;
            
            // Show modal
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            // Set up button handlers
            document.getElementById('locationPhotoCameraBtn').onclick = function() {
                bsModal.hide();
                showLocationPhotoCameraDialog(collectionName, selectedLocation);
            };
            
            document.getElementById('locationPhotoBrowseBtn').onclick = function() {
                bsModal.hide();
                showLocationPhotoBrowseDialog(collectionName, selectedLocation);
            };
        }

        async function showLocationPhotoCameraDialog(collectionName, selectedLocation) {
            // Create or show camera modal
            let modal = document.getElementById('locationPhotoCameraModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.className = 'modal fade';
                modal.id = 'locationPhotoCameraModal';
                modal.tabIndex = -1;
                modal.innerHTML = `
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title">Take Photo with Camera</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <strong>Collection:</strong> ${collectionName}<br>
                                    <strong>Location:</strong> ${selectedLocation}
                                </div>
                                <div class="text-center mb-3">
                                    <video id="locationPhotoCamera" autoplay playsinline style="width: 100%; max-width: 400px; border: 1px solid #ddd;"></video>
                                </div>
                                <div class="text-center">
                                    <button id="locationPhotoCaptureBtn" class="btn btn-success me-2">
                                        <i class="fas fa-camera"></i> Capture Photo
                                    </button>
                                    <button id="locationPhotoRetakeBtn" class="btn btn-warning" style="display:none;">
                                        <i class="fas fa-redo"></i> Retake
                                    </button>
                                </div>
                                <canvas id="locationPhotoCanvas" style="display:none;"></canvas>
                                <div id="locationPhotoCameraStatus" class="mt-2"></div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            // Update modal content
            const modalBody = modal.querySelector('.modal-body');
            modalBody.innerHTML = `
                <div class="mb-3">
                    <strong>Collection:</strong> ${collectionName}<br>
                    <strong>Location:</strong> ${selectedLocation}
                </div>
                <div class="text-center mb-3">
                    <video id="locationPhotoCamera" autoplay playsinline style="width: 100%; max-width: 400px; border: 1px solid #ddd;"></video>
                </div>
                <div class="text-center">
                    <button id="locationPhotoCaptureBtn" class="btn btn-success me-2">
                        <i class="fas fa-camera"></i> Capture Photo
                    </button>
                    <button id="locationPhotoRetakeBtn" class="btn btn-warning" style="display:none;">
                        <i class="fas fa-redo"></i> Retake
                    </button>
                </div>
                <canvas id="locationPhotoCanvas" style="display:none;"></canvas>
                <div id="locationPhotoCameraStatus" class="mt-2"></div>
            `;
            
            // Show modal
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            // Initialize camera
            try {
                const video = document.getElementById('locationPhotoCamera');
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                
                // Set up capture button
                document.getElementById('locationPhotoCaptureBtn').onclick = function() {
                    captureLocationPhoto(collectionName, selectedLocation);
                };
                
                // Set up retake button
                document.getElementById('locationPhotoRetakeBtn').onclick = function() {
                    document.getElementById('locationPhotoCaptureBtn').style.display = 'inline-block';
                    document.getElementById('locationPhotoRetakeBtn').style.display = 'none';
                    document.getElementById('locationPhotoCanvas').style.display = 'none';
                    video.style.display = 'block';
                };
                
            } catch (error) {
                console.error('Error accessing camera:', error);
                document.getElementById('locationPhotoCameraStatus').innerHTML = '<div class="text-danger">Error accessing camera. Please use browse option instead.</div>';
            }
        }

        async function showLocationPhotoBrowseDialog(collectionName, selectedLocation) {
            // Create or show browse modal
            let modal = document.getElementById('locationPhotoBrowseModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.className = 'modal fade';
                modal.id = 'locationPhotoBrowseModal';
                modal.tabIndex = -1;
                modal.innerHTML = `
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header bg-secondary text-white">
                                <h5 class="modal-title">Browse Photo from Gallery</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <strong>Collection:</strong> ${collectionName}<br>
                                    <strong>Location:</strong> ${selectedLocation}
                                </div>
                                <input type="file" id="locationPhotoFileInput" accept="image/*" class="form-control mb-3">
                                <div id="locationPhotoBrowseStatus" class="mt-2"></div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-success" id="locationPhotoBrowseConfirmBtn">Upload</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            // Update modal content
            const modalBody = modal.querySelector('.modal-body');
            modalBody.innerHTML = `
                <div class="mb-3">
                    <strong>Collection:</strong> ${collectionName}<br>
                    <strong>Location:</strong> ${selectedLocation}
                </div>
                <input type="file" id="locationPhotoFileInput" accept="image/*" class="form-control mb-3">
                <div id="locationPhotoBrowseStatus" class="mt-2"></div>
            `;
            
            // Show modal
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            // Set up upload handler
            document.getElementById('locationPhotoBrowseConfirmBtn').onclick = function() {
                const fileInput = document.getElementById('locationPhotoFileInput');
                if (fileInput.files && fileInput.files[0]) {
                    uploadLocationPhoto(collectionName, selectedLocation, fileInput.files[0]);
                } else {
                    document.getElementById('locationPhotoBrowseStatus').innerHTML = '<div class="text-danger">Please select a file first.</div>';
                }
            };
        }

        async function captureLocationPhoto(collectionName, selectedLocation) {
            try {
                const video = document.getElementById('locationPhotoCamera');
                const canvas = document.getElementById('locationPhotoCanvas');
                const context = canvas.getContext('2d');
                
                // Set canvas size to match video
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                // Draw video frame to canvas
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                // Hide video and show canvas
                video.style.display = 'none';
                canvas.style.display = 'block';
                
                // Show retake button and hide capture button
                document.getElementById('locationPhotoCaptureBtn').style.display = 'none';
                document.getElementById('locationPhotoRetakeBtn').style.display = 'inline-block';
                
                // Convert canvas to blob and upload
                canvas.toBlob(async function(blob) {
                    if (blob) {
                        // Create a File object from the blob
                        const file = new File([blob], `camera_photo_${Date.now()}.jpg`, { type: 'image/jpeg' });
                        await uploadLocationPhoto(collectionName, selectedLocation, file);
                    }
                }, 'image/jpeg', 0.8);
                
            } catch (error) {
                console.error('Error capturing photo:', error);
                document.getElementById('locationPhotoCameraStatus').innerHTML = '<div class="text-danger">Error capturing photo. Please try again.</div>';
            }
        }

        async function uploadLocationPhoto(collectionName, location, file) {
            try {
                // Show loading status
                const statusElement = document.getElementById('locationPhotoUploadStatus') || 
                                    document.getElementById('locationPhotoBrowseStatus') || 
                                    document.getElementById('locationPhotoCameraStatus');
                if (statusElement) {
                    statusElement.innerHTML = '<div class="text-info">Uploading photo...</div>';
                }

                // Generate custom filename: (collection)_(Location)_photo(N)
                // First, get the current photo count to determine the next number
                const documentId = `${collectionName}_${location}`;
                const docRef = db.collection('locationPhotos').doc(documentId);
                const doc = await docRef.get();
                
                let photoNumber = 1;
                if (doc.exists) {
                    const data = doc.data();
                    const existingPhotos = data.photoUrls || [];
                    photoNumber = existingPhotos.length + 1;
                }
                
                const fileName = `${collectionName}_${location}_photo${photoNumber}.jpg`;
                const storagePath = `Location_Photo/${fileName}`;

                // Upload to Firebase Storage
                const storageRef = storage.ref(storagePath);
                const uploadTask = storageRef.put(file);

                // Monitor upload progress
                uploadTask.on('state_changed',
                    (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        if (statusElement) {
                            statusElement.innerHTML = `<div class="text-info">Uploading: ${Math.round(progress)}%</div>`;
                        }
                    },
                    (error) => {
                        console.error('Upload error:', error);
                        if (statusElement) {
                            statusElement.innerHTML = '<div class="text-danger">Upload failed. Please try again.</div>';
                        }
                    },
                    async () => {
                        // Upload completed successfully
                        try {
                            // Get download URL
                            const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                            
                            // Save to locationPhotos collection
                            const documentId = `${collectionName}_${location}`;
                            const photoData = {
                                collectionName: collectionName,
                                location: location,
                                photoUrls: firebase.firestore.FieldValue.arrayUnion(downloadURL),
                                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                            };

                            // Check if document exists
                            const docRef = db.collection('locationPhotos').doc(documentId);
                            const doc = await docRef.get();

                            if (doc.exists) {
                                // Update existing document
                                await docRef.update({
                                    photoUrls: firebase.firestore.FieldValue.arrayUnion(downloadURL),
                                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                                });
                            } else {
                                // Create new document
                                await docRef.set(photoData);
                            }

                            // Show success message
                            if (statusElement) {
                                statusElement.innerHTML = '<div class="text-success">Photo uploaded successfully!</div>';
                            }

                            // Close modal after a short delay
                            setTimeout(() => {
                                const modal = document.querySelector('.modal.show');
                                if (modal) {
                                    const bsModal = bootstrap.Modal.getInstance(modal);
                                    if (bsModal) {
                                        bsModal.hide();
                                    }
                                }
                            }, 2000);

                        } catch (error) {
                            console.error('Error saving to database:', error);
                            if (statusElement) {
                                statusElement.innerHTML = '<div class="text-danger">Error saving photo data. Please try again.</div>';
                            }
                        }
                    }
                );

            } catch (error) {
                console.error('Error uploading location photo:', error);
                const statusElement = document.getElementById('locationPhotoUploadStatus') || 
                                    document.getElementById('locationPhotoBrowseStatus') || 
                                    document.getElementById('locationPhotoCameraStatus');
                if (statusElement) {
                    statusElement.innerHTML = '<div class="text-danger">Upload failed. Please try again.</div>';
                }
            }
        }

        async function showLocationPhotoViewDialog(collectionName, location) {
            // Create or show view modal
            let modal = document.getElementById('locationPhotoViewModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.className = 'modal fade';
                modal.id = 'locationPhotoViewModal';
                modal.tabIndex = -1;
                modal.innerHTML = `
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header bg-info text-white">
                                <h5 class="modal-title">View Location Photos</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body" id="locationPhotoViewContent">
                                <div class="text-center">Loading...</div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            // Show modal
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            // Load and display photos
            await viewLocationPhotos(collectionName, location);
        }

        async function showLocationPhotosFromTitleBar(collectionName, location) {
            try {
                // Query locationPhotos collection directly
                const documentId = `${collectionName}_${location}`;
                const docRef = db.collection('locationPhotos').doc(documentId);
                const doc = await docRef.get();

                if (!doc.exists) {
                    alert('No photos found for this location.');
                    return;
                }

                const data = doc.data();
                const photoUrls = data.photoUrls || [];

                if (photoUrls.length === 0) {
                    alert('No photos found for this location.');
                    return;
                }

                // Go directly to full-screen gallery starting from first photo
                showLocationPhotoFullscreen(JSON.stringify(photoUrls), 0, collectionName, location);
                
            } catch (error) {
                console.error('Error loading location photos:', error);
                alert('Error loading photos. Please try again.');
            }
        }

        async function viewLocationPhotos(collectionName, location) {
            try {
                const contentElement = document.getElementById('locationPhotoViewContent');
                contentElement.innerHTML = '<div class="text-center">Loading photos...</div>';

                // Query locationPhotos collection
                const documentId = `${collectionName}_${location}`;
                const docRef = db.collection('locationPhotos').doc(documentId);
                const doc = await docRef.get();

                if (!doc.exists) {
                    contentElement.innerHTML = `
                        <div class="text-center text-muted">
                            <i class="fas fa-images fa-3x mb-3"></i>
                            <h5>No photos found</h5>
                            <p>No photos have been uploaded for this location yet.</p>
                        </div>
                    `;
                    return;
                }

                const data = doc.data();
                const photoUrls = data.photoUrls || [];

                if (photoUrls.length === 0) {
                    contentElement.innerHTML = `
                        <div class="text-center text-muted">
                            <i class="fas fa-images fa-3x mb-3"></i>
                            <h5>No photos found</h5>
                            <p>No photos have been uploaded for this location yet.</p>
                        </div>
                    `;
                    return;
                }

                // Display photos in a grid
                let html = `
                    <div class="mb-3">
                        <strong>Collection:</strong> ${collectionName}<br>
                        <strong>Location:</strong> ${location}<br>
                        <strong>Total Photos:</strong> ${photoUrls.length}
                    </div>
                    <div class="row" id="locationPhotoGrid">
                `;

                photoUrls.forEach((url, index) => {
                    html += `
                        <div class="col-md-4 col-sm-6 mb-3">
                            <div class="card">
                                <img src="${url}" class="card-img-top" alt="Location Photo ${index + 1}" 
                                     style="height: 200px; object-fit: cover; cursor: pointer;"
                                     onclick="showLocationPhotoFullscreen('${JSON.stringify(photoUrls)}', ${index}, '${collectionName}', '${location}')">
                                <div class="card-body">
                                    <p class="card-text text-center">Photo ${index + 1}</p>
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
                contentElement.innerHTML = html;

            } catch (error) {
                console.error('Error loading location photos:', error);
                const contentElement = document.getElementById('locationPhotoViewContent');
                contentElement.innerHTML = `
                    <div class="text-center text-danger">
                        <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                        <h5>Error loading photos</h5>
                        <p>An error occurred while loading the photos. Please try again.</p>
                    </div>
                `;
            }
        }

        function showLocationPhotoFullscreen(photoUrlsJson, startIndex, collectionName, location) {
            const photoUrls = JSON.parse(photoUrlsJson);
            if (!photoUrls || photoUrls.length === 0) return;
            
            let currentPhotoIndex = startIndex;
            
            // Create or show fullscreen modal
            let modal = document.getElementById('locationPhotoFullscreenModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.className = 'modal fade';
                modal.id = 'locationPhotoFullscreenModal';
                modal.tabIndex = -1;
                modal.innerHTML = `
                    <div class="modal-dialog modal-fullscreen">
                        <div class="modal-content bg-dark text-white">
                            <div class="modal-header border-0">
                                <h5 class="modal-title">Location Photos: ${collectionName} / ${location}</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body d-flex flex-column align-items-center justify-content-center position-relative" id="locationPhotoFullscreenContent">
                                <!-- Photo will be shown here -->
                            </div>
                            <div class="modal-footer justify-content-center border-0 bg-dark">
                                <span id="locationPhotoCounter" class="text-white"></span>
                                <button type="button" class="btn btn-danger ms-3" id="locationPhotoDeleteBtn">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            const contentElement = document.getElementById('locationPhotoFullscreenContent');
            const counter = document.getElementById('locationPhotoCounter');
            
            function updatePhoto() {
                // Clear the content and add the image
                contentElement.innerHTML = `<img src="${photoUrls[currentPhotoIndex]}" class="img-fluid rounded shadow" style="max-height:80vh;max-width:100vw;object-fit:contain;">`;
                
                // Add back the navigation arrows
                const prevArrow = document.createElement('button');
                prevArrow.type = 'button';
                prevArrow.className = 'btn btn-light position-absolute';
                prevArrow.style = 'left: 20px; top: 50%; transform: translateY(-50%); z-index: 1000; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;';
                prevArrow.innerHTML = '<i class="fas fa-chevron-left"></i>';
                prevArrow.onclick = function() {
                    if (currentPhotoIndex > 0) {
                        currentPhotoIndex--;
                        updatePhoto();
                    }
                };
                
                const nextArrow = document.createElement('button');
                nextArrow.type = 'button';
                nextArrow.className = 'btn btn-light position-absolute';
                nextArrow.style = 'right: 20px; top: 50%; transform: translateY(-50%); z-index: 1000; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;';
                nextArrow.innerHTML = '<i class="fas fa-chevron-right"></i>';
                nextArrow.onclick = function() {
                    if (currentPhotoIndex < photoUrls.length - 1) {
                        currentPhotoIndex++;
                        updatePhoto();
                    }
                };
                
                contentElement.appendChild(prevArrow);
                contentElement.appendChild(nextArrow);
                
                // Update counter
                counter.textContent = `${currentPhotoIndex + 1} / ${photoUrls.length}`;
                
                // Show/hide arrows based on position
                prevArrow.style.display = currentPhotoIndex === 0 ? 'none' : 'flex';
                nextArrow.style.display = currentPhotoIndex === photoUrls.length - 1 ? 'none' : 'flex';
                
                // Update delete button
                const deleteBtn = document.getElementById('locationPhotoDeleteBtn');
                if (deleteBtn) {
                    deleteBtn.onclick = function() {
                        deleteLocationPhoto(collectionName, location, currentPhotoIndex, photoUrls[currentPhotoIndex]);
                    };
                }
            }
            
            updatePhoto();
            
            // Show modal
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
        }

        // Delete location photo function
        async function deleteLocationPhoto(collectionName, location, photoIndex, photoUrl) {
            if (!confirm('Are you sure you want to delete this photo? This action cannot be undone.')) {
                return;
            }

            try {
                console.log('=== LOCATION PHOTO DELETE STARTED ===');
                console.log('Collection:', collectionName);
                console.log('Location:', location);
                console.log('Photo Index:', photoIndex);
                console.log('Photo URL:', photoUrl);

                // Show loading modal
                const loadingModal = new bootstrap.Modal(document.getElementById('photoUploadLoadingModal'));
                loadingModal.show();
                document.getElementById('photoUploadProgress').textContent = 'Deleting photo...';

                // Get current photo URLs for this location
                const documentId = `${collectionName}_${location}`;
                const docRef = db.collection('locationPhotos').doc(documentId);
                const doc = await docRef.get();
                
                if (!doc.exists) {
                    throw new Error('Location photo document not found');
                }
                
                const currentPhotoUrls = doc.data().photoUrls || [];
                
                // Remove the photo from the array
                const updatedPhotoUrls = currentPhotoUrls.filter((url, index) => index !== photoIndex);
                
                // Update the location's photoUrls array
                await docRef.update({
                    photoUrls: updatedPhotoUrls
                });

                // Try to delete from Firebase Storage (optional - may fail if file doesn't exist)
                try {
                    console.log('Original photo URL:', photoUrl);
                    
                    // Extract the full path from the Firebase Storage URL
                    // URL format: https://firebasestorage.googleapis.com/v0/b/project-id/o/Location_Photo%2Ffilename.jpg?alt=media&token=...
                    const urlParts = photoUrl.split('/');
                    const encodedPath = urlParts[urlParts.length - 1].split('?')[0]; // Get the encoded path
                    const decodedPath = decodeURIComponent(encodedPath); // Decode the URL encoding
                    console.log('Attempting to delete from storage path:', decodedPath);
                    
                    const photoRef = storage.ref().child(decodedPath);
                    console.log('Storage reference:', photoRef.toString());
                    
                    await photoRef.delete();
                    console.log('Photo deleted from storage successfully:', decodedPath);
                } catch (storageError) {
                    console.warn('Could not delete from storage (file may not exist):', storageError);
                    console.warn('Storage error details:', storageError.message);
                    console.warn('Storage error code:', storageError.code);
                }

                console.log('=== LOCATION PHOTO DELETE COMPLETED ===');
                loadingModal.hide();
                alert('Photo deleted successfully!');

                // Close the photo gallery modal
                const galleryModal = bootstrap.Modal.getInstance(document.getElementById('locationPhotoFullscreenModal'));
                if (galleryModal) galleryModal.hide();

                // Refresh the current view if we're on the My Tools by Collection screen
                if (lastViewedCollectionName) {
                    showMyToolsByCollection(lastViewedCollectionName);
                }

            } catch (error) {
                console.error('=== LOCATION PHOTO DELETE FAILED ===', error);
                const loadingModal = bootstrap.Modal.getInstance(document.getElementById('photoUploadLoadingModal'));
                if (loadingModal) loadingModal.hide();
                alert('Delete failed: ' + error.message);
            }
        }



        async function showCollectionSelectionDialog() {
            const user = auth.currentUser;
            if (!user) return;
            const fullName = localStorage.getItem('fullName') || user.email;
            console.log('WebApp: Querying tools for owner:', fullName);
            const modal = new bootstrap.Modal(document.getElementById('collectionSelectModal'));
            const body = document.getElementById('collectionSelectBody');
            body.innerHTML = '<div class="text-center">Loading...</div>';
            try {
                // 1. Query tools for this owner
                const toolsSnapshot = await db.collection('tools').where('owner', '==', fullName).get();
                if (toolsSnapshot.empty) {
                    body.innerHTML = '<div class="text-center text-danger">No tools found for you.</div>';
                    modal.show();
                    return;
                }
                // 2. Extract unique collectionCodes
                const collectionCodes = [...new Set(toolsSnapshot.docs.map(doc => doc.data().collectionCode).filter(Boolean))];
                if (collectionCodes.length === 0) {
                    body.innerHTML = '<div class="text-center text-danger">No collections found for your tools.</div>';
                    modal.show();
                    return;
                }
                // 3. Query collections for those codes (batch if >10)
                let collections = [];
                if (collectionCodes.length <= 10) {
                  const colSnap = await db.collection('collections').where('collectionName', 'in', collectionCodes).get();
                  collections = colSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        } else {
                  // Firestore 'in' query limit is 10, so batch if needed
                  for (let i = 0; i < collectionCodes.length; i += 10) {
                    const batch = collectionCodes.slice(i, i + 10);
                    const colSnap = await db.collection('collections').where('collectionName', 'in', batch).get();
                    collections = collections.concat(colSnap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                  }
                }
                if (collections.length === 0) {
                    body.innerHTML = '<div class="text-center text-danger">No collections found for your tools.</div>';
                } else {
                    let html = '<div class="list-group">';
                    collections.forEach(data => {
                        const isCurrentCollection = data.collectionName === lastViewedCollectionName;
                        html += `<button class="list-group-item list-group-item-action ${isCurrentCollection ? 'active' : ''}" style="font-weight:bold;color:${isCurrentCollection ? 'white' : '#1976d2'};" data-collection="${data.collectionName}">
                            <span style="font-size:1.1em;">${data.collectionName}</span><br>
                            <span style="font-size:0.9em;color:${isCurrentCollection ? 'rgba(255,255,255,0.8)' : '#888'};">
                                ${isCurrentCollection ? 'Current Collection' : 'Code: ' + data.collectionName}
                            </span>
                        </button>`;
                    });
                    html += '</div>';
                    body.innerHTML = html;
                    // Add click handlers
                    body.querySelectorAll('button[data-collection]').forEach(btn => {
                        btn.onclick = function() {
                            modal.hide();
                            showMyToolsByCollection(this.getAttribute('data-collection'));
                        };
                    });
                }
                modal.show();
            } catch (e) {
                body.innerHTML = '<div class="text-center text-danger">Error loading collections.</div>';
                modal.show();
            }
        }

        function showCollectionCheckupScreen() {
            document.getElementById('myToolsByCollectionScreen').style.display = 'none';
            document.getElementById('collectionCheckupScreen').style.display = 'block';
            
            // Reset checkup state
            checkupCheckedTools = new Set();
            // Set initial location to first available location instead of 'All'
            const tools = lastViewedCollectionTools;
            const locations = [...new Set(tools.map(t => t.location || 'No Location'))].sort();
            checkupSelectedLocation = locations.length > 0 ? locations[0] : 'No Location';
            
            // Update the main title bar
            const mainTitle = document.querySelector('#collectionCheckupScreen h2');
            if (mainTitle && lastViewedCollectionName) {
                mainTitle.textContent = `${lastViewedCollectionName} Collection Checkup`;
            }
            
            // Set initial location title
            const locationTitle = document.getElementById('checkupLocationTitle');
            if (locationTitle) {
                locationTitle.textContent = checkupSelectedLocation;
            }
            
            if (!lastViewedCollectionTools.length) {
                document.getElementById('checkupToolsList').innerHTML = '<div class="text-center text-danger">No tools found for checkup.</div>';
                document.getElementById('checkupActionButtons').style.display = 'none';
                return;
            }
            
            // Show action buttons
            document.getElementById('checkupActionButtons').style.display = 'block';
            
            // Render tools and location filter
            renderCheckupTools();
            renderCheckupLocationFilter();
            updateCheckupProgress();
        }

        function renderCheckupTools() {
            const list = document.getElementById('checkupToolsList');
            const tools = lastViewedCollectionTools;
            
            // Filter tools by selected location
            const filteredTools = tools.filter(t => (t.location || 'No Location') === checkupSelectedLocation);
            
            if (filteredTools.length === 0) {
                list.innerHTML = '<div class="text-center text-muted">No tools in selected location.</div>';
                return;
            }
            
            let html = '';
            filteredTools.forEach((tool, index) => {
                const isChecked = checkupCheckedTools.has(tool.id);
                const status = (tool.status || '').toUpperCase();
                
                // Determine background color based on status and checked state
                let bgColor = '#f5f5f5'; // Default gray
                if (isChecked) {
                    bgColor = '#e8f5e8'; // Light green for checked
                } else if (status === 'OUT') {
                    bgColor = '#ffebee'; // Light red for out
                } else if (status === 'BROKEN') {
                    bgColor = '#fff3e0'; // Light orange for broken
                } else if (status === 'LOST') {
                    bgColor = '#ffe0b2'; // Light amber for lost
                } else if (status === 'CALIBRATION') {
                    bgColor = '#e3f2fd'; // Light blue for calibration
                }
                
                html += `
                    <div class="card mb-2" style="background-color: ${bgColor}; border: 1px solid #ddd;">
                        <div class="card-body p-3">
                            <div class="row align-items-center">
                                <div class="col-auto">
                                    <input type="checkbox" class="form-check-input" id="checkupTool${tool.id}" 
                                           ${isChecked ? 'checked' : ''} 
                                           onchange="toggleCheckupTool('${tool.id}', this.checked)"
                                           style="transform: scale(1.2);">
                                </div>
                                <div class="col">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <h6 class="mb-1"><strong>${index + 1}. ${tool.toolName || 'Unknown Tool'}</strong></h6>
                                            <div class="text-muted small">Part #: ${tool.partNumber || 'N/A'}</div>
                                            <div class="text-muted small">Location: ${tool.location || 'No Location'}</div>
                                            <div class="small">
                                                <strong>Status: </strong>
                                                <span style="color: ${getStatusColor(status)};">${tool.status || 'N/A'}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            list.innerHTML = html;
        }

        function renderCheckupLocationFilter() {
            const tools = lastViewedCollectionTools;
            const locations = [...new Set(tools.map(t => t.location || 'No Location'))].sort();
            
            let html = '';
            locations.forEach(loc => {
                const isSelected = checkupSelectedLocation === loc;
                html += `
                    <button class="btn btn-sm ${isSelected ? 'btn-orange' : 'btn-outline-secondary'}" 
                            onclick="selectCheckupLocation('${loc}')"
                            style="${isSelected ? 'background-color:#FF9800;color:white;border-color:#FF9800;' : 'background-color:transparent;color:#6c757d;border-color:#6c757d;'}">
                        ${loc}
                    </button>
                `;
            });
            
            document.getElementById('checkupLocationButtons').innerHTML = html;
        }

        function selectCheckupLocation(location) {
            checkupSelectedLocation = location;
            
            // Update the location title
            const locationTitle = document.getElementById('checkupLocationTitle');
            if (locationTitle) {
                locationTitle.textContent = location;
            }
            
            renderCheckupTools();
            renderCheckupLocationFilter();
            updateCheckupProgress();
        }

        function toggleCheckupTool(toolId, checked) {
            if (checked) {
                checkupCheckedTools.add(toolId);
            } else {
                checkupCheckedTools.delete(toolId);
            }
            updateCheckupProgress();
        }

        function updateCheckupProgress() {
            const totalTools = lastViewedCollectionTools.length;
            const checkedCount = checkupCheckedTools.size;
            document.getElementById('checkupProgress').textContent = `${checkedCount}/${totalTools}`;
        }

        // Select All functionality
        document.getElementById('selectAllBtn').onclick = function() {
            const tools = lastViewedCollectionTools.filter(t => (t.location || 'No Location') === checkupSelectedLocation);
            
            tools.forEach(tool => {
                checkupCheckedTools.add(tool.id);
            });
            
            renderCheckupTools();
            updateCheckupProgress();
        };

        // Show Results functionality
        document.getElementById('showResultsBtn').onclick = function() {
            showCheckupResults();
        };

        function showCheckupResults() {
            const tools = lastViewedCollectionTools;
            const totalTools = tools.length;
            const checkedCount = checkupCheckedTools.size;
            const uncheckedCount = totalTools - checkedCount;
            
            // Calculate location stats
            const locationStats = {};
            const locations = [...new Set(tools.map(t => t.location || 'No Location'))];
            locations.forEach(loc => {
                const locationTools = tools.filter(t => (t.location || 'No Location') === loc);
                const locationChecked = locationTools.filter(t => checkupCheckedTools.has(t.id)).length;
                locationStats[loc] = {
                    total: locationTools.length,
                    checked: locationChecked,
                    unchecked: locationTools.length - locationChecked
                };
            });
            
            let html = `
                <div class="mb-4">
                    <h6><strong>Overall Summary:</strong></h6>
                    <div class="row">
                        <div class="col-4">
                            <div class="text-center">
                                <div class="h4 text-primary">${totalTools}</div>
                                <small class="text-muted">Total Tools</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="text-center">
                                <div class="h4 text-success">${checkedCount}</div>
                                <small class="text-muted">Checked</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="text-center">
                                <div class="h4 text-warning">${uncheckedCount}</div>
                                <small class="text-muted">Unchecked</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div>
                    <h6><strong>By Location:</strong></h6>
        `;
        
        Object.entries(locationStats).forEach(([location, stats]) => {
            html += `
                <div class="card mb-2">
                    <div class="card-body p-3">
                        <h6 class="card-title">${location}</h6>
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="text-primary">${stats.total}</div>
                                <small class="text-muted">Total</small>
                            </div>
                            <div class="col-4">
                                <div class="text-success">${stats.checked}</div>
                                <small class="text-muted">Checked</small>
                            </div>
                            <div class="col-4">
                                <div class="text-warning">${stats.unchecked}</div>
                                <small class="text-muted">Unchecked</small>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        
        document.getElementById('checkupResultsContent').innerHTML = html;
        
        const modal = new bootstrap.Modal(document.getElementById('checkupResultsModal'));
        modal.show();
    }

    // Save Results functionality
    document.getElementById('saveCheckupResultsBtn').onclick = function() {
        saveCheckupResults();
    };

    async function saveCheckupResults() {
        const tools = lastViewedCollectionTools;
        const totalTools = tools.length;
        const checkedCount = checkupCheckedTools.size;
        const uncheckedCount = totalTools - checkedCount;
        
        // Calculate location stats
        const locationStats = {};
        const locations = [...new Set(tools.map(t => t.location || 'No Location'))];
        locations.forEach(loc => {
            const locationTools = tools.filter(t => (t.location || 'No Location') === loc);
            const locationChecked = locationTools.filter(t => checkupCheckedTools.has(t.id)).length;
            locationStats[loc] = {
                total: locationTools.length,
                checked: locationChecked,
                unchecked: locationTools.length - locationChecked
            };
        });
        
        try {
            const user = auth.currentUser;
            const fullName = localStorage.getItem('fullName') || user.email;
            
            const checkupData = {
                technicianName: fullName,
                collectionCode: lastViewedCollectionName,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                totalTools: totalTools,
                checkedTools: checkedCount,
                uncheckedTools: uncheckedCount,
                locationStats: locationStats,
                checkedToolIds: Array.from(checkupCheckedTools),
                allToolIds: tools.map(t => t.id),
                checkupDate: new Date().toLocaleString('en-GB')
            };
            
            // Create custom document ID
            const technicianNameWithoutSpaces = fullName.replace(/\s+/g, '');
            const timestamp = new Date();
            const timestampString = timestamp.toLocaleString('en-GB', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            }).replace(/[/:]/g, '').replace(/\s+/g, '-');
            
            const documentId = `${technicianNameWithoutSpaces}_${timestampString}`;
            
            await db.collection('checkupResults').doc(documentId).set(checkupData);
            
            // Close results modal and show success modal
            const resultsModal = bootstrap.Modal.getInstance(document.getElementById('checkupResultsModal'));
            resultsModal.hide();
            
            const successModal = new bootstrap.Modal(document.getElementById('checkupSaveSuccessModal'));
            successModal.show();
            
        } catch (error) {
            console.error('Error saving checkup results:', error);
            alert('Error saving checkup results: ' + error.message);
        }
    }

    // History button (placeholder for now)
    document.getElementById('checkupHistoryBtn').onclick = function() {
        showCheckupHistoryScreen();
    };

    function getStatusColor(status) {
        switch (status) {
            case 'OUT': return '#d32f2f';
            case 'BROKEN': return '#ff6f00';
            case 'LOST': return '#ff8f00';
            case 'CALIBRATION': return '#1976d2';
            default: return '#388e3c';
        }
    }

    document.getElementById('backToMyToolsByCollectionBtn').onclick = function() {
        document.getElementById('collectionCheckupScreen').style.display = 'none';
        document.getElementById('myToolsByCollectionScreen').style.display = 'block';
    };

    // Previous OUT Tools functionality
    document.getElementById('menuOutBtn').onclick = function() {
        // Navigate to previous-out.html
        window.location.href = 'previous-out.html';
    };

    // Back button for Previous OUT Tools
    document.getElementById('backToMenuFromOutToolsBtn').onclick = function() {
        document.getElementById('previousOutToolsScreen').style.display = 'none';
        document.getElementById('toolScannerMenu').style.display = 'block';
        // Update the count when returning to menu to ensure it's current
        updatePreviousOutToolsCount();
    };

    // Tools by Work Location functionality
    let workLocationToolsData = [];
    let workLocationCurrentOutTools = [];
    let currentWorkLocation = '';
    let currentDateFilter = 'all';

    // Menu button handler
    document.getElementById('menuWorkLocationBtn').onclick = async function() {
        document.getElementById('toolScannerMenu').style.display = 'none';
        document.getElementById('toolsByWorkLocationScreen').style.display = 'block';
        
        // Load available work locations
        await loadWorkLocations();
    };

    // Back button
    document.getElementById('backToMenuFromWorkLocationBtn').onclick = function() {
        document.getElementById('toolsByWorkLocationScreen').style.display = 'none';
        document.getElementById('toolScannerMenu').style.display = 'block';
        // Reset screen
        document.getElementById('workLocationSelect').value = '';
        document.getElementById('loadToolsByLocationBtn').disabled = true;
        document.getElementById('dateFilterSection').style.display = 'none';
    };

    // Load available work locations from tools
    async function loadWorkLocations() {
        try {
            const snapshot = await db.collection('tools').get();
            const locations = new Set();
            
            snapshot.forEach(doc => {
                const workOn = doc.data().WorkOn;
                if (workOn && workOn.trim()) {
                    locations.add(workOn.trim());
                }
            });
            
            const select = document.getElementById('workLocationSelect');
            // Keep first two options (empty and ALL)
            select.innerHTML = '<option value="">-- Select a Station --</option><option value="ALL">All Locations</option>';
            
            // Add all unique locations alphabetically
            Array.from(locations).sort().forEach(location => {
                const option = document.createElement('option');
                option.value = location;
                option.textContent = location;
                select.appendChild(option);
            });
        } catch (error) {
            console.error('Error loading work locations:', error);
            alert('Error loading work locations. Please try again.');
        }
    }

    // Enable load button when location is selected
    document.getElementById('workLocationSelect').onchange = function() {
        document.getElementById('loadToolsByLocationBtn').disabled = !this.value;
    };

    // Load tools by location
    document.getElementById('loadToolsByLocationBtn').onclick = async function() {
        currentWorkLocation = document.getElementById('workLocationSelect').value;
        if (!currentWorkLocation) return;
        
        document.getElementById('workLocationCurrentOutList').innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div><div class="mt-2">Loading currently OUT tools...</div></div>';
        document.getElementById('workLocationToolsList').innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div><div class="mt-2">Loading tool history...</div></div>';
        document.getElementById('dateFilterSection').style.display = 'block';
        
        try {
            // Load currently OUT tools from tools collection
            await loadCurrentOutTools();
            
            // Load tool history from logtoolmovements
            await loadToolHistory();
            
            // Apply default date filter (all time) to history only
            filterToolsByDate('all');
            
        } catch (error) {
            console.error('Error loading tools by work location:', error);
            document.getElementById('workLocationCurrentOutList').innerHTML = '<div class="text-center text-danger">Error loading tools. Please try again.</div>';
            document.getElementById('workLocationToolsList').innerHTML = '<div class="text-center text-danger">Error loading history. Please try again.</div>';
        }
    };

    // Load currently OUT tools from tools collection
    async function loadCurrentOutTools() {
        try {
            let query = db.collection('tools').where('status', '==', 'OUT');
            
            if (currentWorkLocation !== 'ALL') {
                query = query.where('WorkOn', '==', currentWorkLocation);
            }
            
            const snapshot = await query.get();
            
            workLocationCurrentOutTools = [];
            snapshot.forEach(doc => {
                const toolData = doc.data();
                workLocationCurrentOutTools.push({
                    id: doc.id,
                    toolId: doc.id,
                    toolName: toolData.toolName || 'Unknown Tool',
                    serialNumber: toolData.serialNumber || toolData.partNumber || 'N/A',
                    calDueDate: toolData.calDueDate,
                    technician: toolData.technician || 'N/A',
                    WorkOn: toolData.WorkOn || currentWorkLocation,
                    status: 'OUT',
                    timestamp: toolData.timestamp,
                    collectionCode: toolData.collectionCode || 'Unknown Collection',
                    ...toolData
                });
            });
            
            console.log('Loaded', workLocationCurrentOutTools.length, 'currently OUT tools');
            displayCurrentOutTools();
            
        } catch (error) {
            console.error('Error loading currently OUT tools:', error);
            // Check if index error - try without WorkOn filter for ALL
            if (currentWorkLocation === 'ALL') {
                try {
                    const snapshot = await db.collection('tools').where('status', '==', 'OUT').get();
                    workLocationCurrentOutTools = [];
                    snapshot.forEach(doc => {
                        const toolData = doc.data();
                        workLocationCurrentOutTools.push({
                            id: doc.id,
                            toolId: doc.id,
                            toolName: toolData.toolName || 'Unknown Tool',
                            serialNumber: toolData.serialNumber || toolData.partNumber || 'N/A',
                            calDueDate: toolData.calDueDate,
                            technician: toolData.technician || 'N/A',
                            WorkOn: toolData.WorkOn || 'N/A',
                            status: 'OUT',
                            timestamp: toolData.timestamp,
                            collectionCode: toolData.collectionCode || 'Unknown Collection',
                            ...toolData
                        });
                    });
                    displayCurrentOutTools();
                } catch (error2) {
                    console.error('Error loading currently OUT tools (fallback):', error2);
                    document.getElementById('workLocationCurrentOutList').innerHTML = '<div class="text-center text-danger">Error loading currently OUT tools. Please try again.</div>';
                }
            } else {
                document.getElementById('workLocationCurrentOutList').innerHTML = '<div class="text-center text-danger">Error loading currently OUT tools. Please check Firebase indexes.</div>';
            }
        }
    }

    // Load tool history from logtoolmovements
    async function loadToolHistory() {
        try {
            // Query logtoolmovements for all movements (both CHECK-IN and CHECK-OUT)
            let query = db.collection('logtoolmovements');
            
            if (currentWorkLocation !== 'ALL') {
                query = query.where('WorkOn', '==', currentWorkLocation);
            }
            
            const snapshot = await query.orderBy('timestamp', 'desc').get();
            
            // Get all unique tool IDs from history
            const toolIds = new Set();
            const historyEntries = [];
            
            snapshot.forEach(doc => {
                const data = doc.data();
                historyEntries.push({
                    id: doc.id,
                    ...data
                });
                if (data.toolId) {
                    toolIds.add(data.toolId);
                }
            });
            
            // Fetch collection names and owner from tools collection
            const toolsMap = new Map();
            if (toolIds.size > 0) {
                const toolPromises = Array.from(toolIds).map(async (toolId) => {
                    try {
                        const toolDoc = await db.collection('tools').doc(toolId).get();
                        if (toolDoc.exists) {
                            const toolData = toolDoc.data();
                            toolsMap.set(toolId, {
                                collectionCode: toolData.collectionCode || 'Unknown Collection',
                                toolName: toolData.toolName,
                                serialNumber: toolData.serialNumber || toolData.partNumber,
                                calDueDate: toolData.calDueDate,
                                owner: toolData.owner || 'N/A'
                            });
                        }
                    } catch (err) {
                        console.warn(`Error fetching tool ${toolId}:`, err);
                    }
                });
                
                await Promise.all(toolPromises);
            }
            
            // Enrich history entries with collection and owner information
            workLocationToolsData = historyEntries.map(entry => {
                const toolInfo = toolsMap.get(entry.toolId);
                return {
                    ...entry,
                    collectionCode: toolInfo?.collectionCode || entry.collectionCode || 'Unknown Collection',
                    toolName: toolInfo?.toolName || entry.toolName || 'Unknown Tool',
                    serialNumber: toolInfo?.serialNumber || entry.serialNumber || entry.partNumber || 'N/A',
                    calDueDate: toolInfo?.calDueDate || entry.calDueDate,
                    owner: toolInfo?.owner || entry.owner || 'N/A'
                };
            });
            
            console.log('Loaded', workLocationToolsData.length, 'tool history entries (including checked-in tools)');
            
        } catch (error) {
            console.error('Error loading tool history:', error);
            document.getElementById('workLocationToolsList').innerHTML = '<div class="text-center text-danger">Error loading tool history. Please check Firebase indexes.</div>';
        }
    }

    // Display currently OUT tools
    function displayCurrentOutTools() {
        const container = document.getElementById('workLocationCurrentOutList');
        const summaryContainer = document.getElementById('workLocationCurrentOutSummary');
        
        if (workLocationCurrentOutTools.length === 0) {
            container.innerHTML = '<div class="text-center text-muted">No tools currently OUT at this work location.</div>';
            summaryContainer.innerHTML = '<strong>Total OUT Tools:</strong> 0';
            return;
        }
        
        // Group by collection and owner
        const byCollection = {};
        workLocationCurrentOutTools.forEach(tool => {
            const collection = tool.collectionCode || 'Unknown Collection';
            const owner = tool.owner || 'N/A';
            
            if (!byCollection[collection]) {
                byCollection[collection] = {
                    owner: owner,
                    tools: []
                };
            }
            byCollection[collection].tools.push(tool);
        });
        
        // Update summary
        summaryContainer.innerHTML = `<strong>Total OUT Tools:</strong> ${workLocationCurrentOutTools.length}`;
        
        // Build HTML
        let html = '';
        const collections = Object.keys(byCollection).sort();
        
        collections.forEach(collection => {
            const collectionData = byCollection[collection];
            const owner = collectionData.owner || 'N/A';
            
            html += `<div class="workloc-collection-header">
                ${collection} - Owner: ${owner} (${collectionData.tools.length} tools)
            </div>`;
            
            collectionData.tools.forEach(tool => {
                html += createWorkLocationToolCard(tool, 'out');
            });
        });
        
        container.innerHTML = html;
    }

    // Filter tools by date (only applies to history, not current OUT tools)
    window.filterToolsByDate = function(period, clickedButton = null) {
        currentDateFilter = period;
        
        // Update button states - remove active class from all buttons
        document.querySelectorAll('.filter-date-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // Set the clicked button as active with red color
        if (clickedButton) {
            clickedButton.classList.add('active');
        } else {
            // If no button was clicked (programmatic call), find and activate the correct button
            const buttons = document.querySelectorAll('.filter-date-btn');
            buttons.forEach(btn => {
                const onclickAttr = btn.getAttribute('onclick');
                if (onclickAttr && onclickAttr.includes(`'${period}'`)) {
                    btn.classList.add('active');
                }
            });
        }
        
        // Calculate date range
        const now = new Date();
        let startDate;
        
        switch(period) {
            case 'today':
                startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                break;
            case 'week':
                startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                break;
            case 'month':
                startDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                break;
            case 'all':
                startDate = new Date(0);
                break;
        }
        
        // Filter history data by date - show all entries (both check-in and check-out)
        const filtered = workLocationToolsData.filter(entry => {
            if (!entry.timestamp) return false;
            const entryDate = entry.timestamp.toDate ? entry.timestamp.toDate() : new Date(entry.timestamp);
            return entryDate >= startDate;
        });
        
        // Sort by timestamp (newest first)
        filtered.sort((a, b) => {
            const aTime = a.timestamp?.toDate ? a.timestamp.toDate() : new Date(a.timestamp || 0);
            const bTime = b.timestamp?.toDate ? b.timestamp.toDate() : new Date(b.timestamp || 0);
            return bTime - aTime;
        });
        
        // Display all history entries (both check-in and check-out)
        displayWorkLocationTools(filtered);
    };

    // Display tools grouped by collection
    function displayWorkLocationTools(tools) {
        const container = document.getElementById('workLocationToolsList');
        
        if (tools.length === 0) {
            container.innerHTML = '<div class="text-center text-muted">No tool history found for the selected date range.</div>';
            document.getElementById('workLocationToolsSummary').innerHTML = '<strong>Total History Entries:</strong> 0';
            return;
        }
        
        // Group by collection and owner
        const byCollection = {};
        tools.forEach(tool => {
            const collection = tool.collectionCode || 'Unknown Collection';
            const owner = tool.owner || tool.technician || 'N/A';
            
            if (!byCollection[collection]) {
                byCollection[collection] = {
                    owner: owner,
                    out: [],
                    in: []
                };
            }
            
            const status = (tool.status || tool.action || '').toUpperCase();
            if (status === 'OUT' || status === 'CHECK-OUT') {
                byCollection[collection].out.push(tool);
            } else {
                byCollection[collection].in.push(tool);
            }
        });
        
        // Count OUT tools in history
        const outCount = tools.filter(t => {
            const status = (t.status || t.action || '').toUpperCase();
            return status === 'OUT' || status === 'CHECK-OUT';
        }).length;
        
        // Update summary for history
        document.getElementById('workLocationToolsSummary').innerHTML = 
            `<strong>Total History Entries:</strong> ${tools.length} | <strong>OUT:</strong> ${outCount} | <strong>IN:</strong> ${tools.length - outCount}`;
        
        // Build HTML
        let html = '';
        const collections = Object.keys(byCollection).sort();
        
        collections.forEach(collection => {
            const collectionTools = byCollection[collection];
            const totalInCollection = collectionTools.out.length + collectionTools.in.length;
            const owner = collectionTools.owner || 'N/A';
            
            html += `<div class="workloc-collection-header">
                ${collection} - Owner: ${owner} (${totalInCollection} entries - OUT: ${collectionTools.out.length}, IN: ${collectionTools.in.length})
            </div>`;
            
            // Display OUT tools first
            collectionTools.out.forEach(tool => {
                html += createWorkLocationToolCard(tool, 'out');
            });
            
            // Then IN tools
            collectionTools.in.forEach(tool => {
                html += createWorkLocationToolCard(tool, 'in');
            });
        });
        
        container.innerHTML = html;
    }

    // Create tool card HTML
    function createWorkLocationToolCard(tool, statusClass) {
        const toolName = tool.toolName || 'Unknown Tool';
        const toolId = tool.toolId || tool.id || 'N/A';
        const partNumber = tool.serialNumber || tool.partNumber || 'N/A';
        const status = (tool.status || tool.action || 'N/A').toUpperCase();
        const technician = tool.technician || 'N/A';
        const calDueDate = tool.calDueDate ? 
            (tool.calDueDate.toDate ? tool.calDueDate.toDate().toLocaleDateString('en-GB') : tool.calDueDate) : 
            'N/A';
        
        const timestamp = tool.timestamp ? 
            (tool.timestamp.toDate ? 
                tool.timestamp.toDate().toLocaleString('en-GB', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                }) : 
                new Date(tool.timestamp).toLocaleString('en-GB')) : 
            'N/A';
        
        const statusColorClass = statusClass === 'out' ? 'workloc-status-out' : 'workloc-status-in';
        
        return `
            <div class="workloc-tool-card ${statusClass}">
                <div class="workloc-tool-name" style="font-weight: bold; margin-bottom: 8px;">${toolName}</div>
                <div class="workloc-tool-info" style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                    <span><span class="workloc-tool-label">Tid:</span> <span class="workloc-tool-value">${toolId}</span></span>
                    <span><span class="workloc-tool-label">P/N:</span> <span class="workloc-tool-value">${partNumber}</span></span>
                </div>
                <div class="workloc-tool-info" style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                    <span><span class="workloc-tool-label">Cal Due Date:</span> <span class="workloc-tool-value">${calDueDate}</span></span>
                    <span><span class="workloc-tool-label">Status:</span> <span class="${statusColorClass}">${status}</span></span>
                </div>
                <div class="workloc-tool-info" style="margin-bottom: 6px;">
                    <span class="workloc-tool-label">Last Technician:</span> <span class="workloc-tool-value">${technician}</span>
                </div>
                <div class="workloc-tool-info">
                    <span class="workloc-tool-label">Time:</span> <span class="workloc-tool-value">${timestamp}</span>
                </div>
            </div>
        `;
    }

    // Variables for previous OUT tools
    let previousOutToolsCount = 0;
    let previousOutToolsData = [];

    // Function to fetch and update previous OUT tools count
    async function updatePreviousOutToolsCount() {
        const user = auth.currentUser;
        if (!user) {
            console.log('updatePreviousOutToolsCount: No user logged in');
            return;
        }
        
        const fullName = localStorage.getItem('fullName') || user.email;
        console.log('updatePreviousOutToolsCount: Searching for tools with technician:', fullName);
        
        try {
            const snapshot = await db.collection('tools')
                .where('technician', '==', fullName)
                .where('status', '==', 'OUT')
                .get();
            
            console.log('updatePreviousOutToolsCount: Found', snapshot.docs.length, 'OUT tools for technician:', fullName);
            
            if (!snapshot.empty) {
                // Get today's start time in local timezone
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                console.log('updatePreviousOutToolsCount: Today start time (local):', today.toISOString());
                console.log('updatePreviousOutToolsCount: Today start time (local date):', today.toDateString());
                
                // Filter tools from previous days
                const previousTools = snapshot.docs.filter(doc => {
                    const timestamp = doc.data().timestamp;
                    console.log('updatePreviousOutToolsCount: Tool', doc.id, 'timestamp:', timestamp);
                    
                    if (timestamp && timestamp.toDate) {
                        const toolDate = timestamp.toDate();
                        // Compare dates in local timezone
                        const toolDateLocal = new Date(toolDate.getFullYear(), toolDate.getMonth(), toolDate.getDate());
                        const isPrevious = toolDateLocal < today;
                        console.log('updatePreviousOutToolsCount: Tool', doc.id, 'date (UTC):', toolDate.toISOString(), 'date (local):', toolDateLocal.toDateString(), 'isPrevious:', isPrevious);
                        return isPrevious;
                    }
                    console.log('updatePreviousOutToolsCount: Tool', doc.id, 'has no valid timestamp');
                    return false;
                });
                
                console.log('updatePreviousOutToolsCount: Previous tools count:', previousTools.length);
                
                previousOutToolsCount = previousTools.length;
                previousOutToolsData = previousTools.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // Update button text with previous OUT tools count
                const menuOutBtn = document.getElementById('menuOutBtn');
                if (menuOutBtn) {
                    menuOutBtn.innerHTML = `<i class="fas fa-sign-out-alt"></i> View OUT Tools (${previousOutToolsCount})`;
                    menuOutBtn.disabled = previousOutToolsCount === 0;
                }
            } else {
                console.log('updatePreviousOutToolsCount: No OUT tools found for technician:', fullName);
                previousOutToolsCount = 0;
                previousOutToolsData = [];
                const menuOutBtn = document.getElementById('menuOutBtn');
                if (menuOutBtn) {
                    menuOutBtn.innerHTML = `<i class="fas fa-sign-out-alt"></i> View OUT Tools (0)`;
                    menuOutBtn.disabled = true;
                }
            }
        } catch (error) {
            console.error('Error fetching previous OUT tools count:', error);
            previousOutToolsCount = 0;
            previousOutToolsData = [];
            const menuOutBtn = document.getElementById('menuOutBtn');
            if (menuOutBtn) {
                menuOutBtn.innerHTML = `<i class="fas fa-sign-out-alt"></i> View OUT Tools (0)`;
                menuOutBtn.disabled = true;
            }
        }
    }

    async function showPreviousOutTools() {
        const user = auth.currentUser;
        if (!user) {
            console.log('showPreviousOutTools: No user logged in');
            return;
        }
        
        // Hide other screens and show previous OUT tools screen
        document.getElementById('toolScannerMenu').style.display = 'none';
        document.getElementById('appSection').style.display = 'none';
        document.getElementById('myToolsScreen').style.display = 'none';
        document.getElementById('myToolsByCollectionScreen').style.display = 'none';
        document.getElementById('collectionCheckupScreen').style.display = 'none';
        document.getElementById('previousOutToolsScreen').style.display = 'block';
        
        const previousOutToolsList = document.getElementById('previousOutToolsList');
        
        // Show loading state
        previousOutToolsList.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div><div class="mt-2">Refreshing previous OUT tools...</div></div>';
        document.getElementById('previousOutToolsSummary').innerHTML = '<strong>Refreshing...</strong>';
        
        try {
            // Fetch fresh data
            const fullName = localStorage.getItem('fullName') || user.email;
            console.log('showPreviousOutTools: Searching for tools with technician:', fullName);
            
            const snapshot = await db.collection('tools')
                .where('technician', '==', fullName)
                .where('status', '==', 'OUT')
                .get();
            
            console.log('showPreviousOutTools: Found', snapshot.docs.length, 'OUT tools for technician:', fullName);
            
            if (snapshot.empty) {
                console.log('showPreviousOutTools: No OUT tools found for technician:', fullName);
                previousOutToolsList.innerHTML = '<div class="text-center text-muted">No previous OUT tools found.</div>';
                const now = new Date();
                const timeString = now.toLocaleString('en-GB', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                });
                document.getElementById('previousOutToolsSummary').innerHTML = `
                    <strong>Total: 0 tools</strong>
                    <br><small class="text-muted">Last updated: ${timeString}</small>
                `;
                return;
            }
            
            // Get today's start time in local timezone
            const currentTime = new Date();
            const today = new Date(currentTime.getFullYear(), currentTime.getMonth(), currentTime.getDate());
            console.log('showPreviousOutTools: Today start time (local):', today.toISOString());
            console.log('showPreviousOutTools: Today start time (local date):', today.toDateString());
            
            // Filter tools from previous days
            const previousTools = snapshot.docs.filter(doc => {
                const timestamp = doc.data().timestamp;
                console.log('showPreviousOutTools: Tool', doc.id, 'timestamp:', timestamp);
                
                if (timestamp && timestamp.toDate) {
                    const toolDate = timestamp.toDate();
                    // Compare dates in local timezone
                    const toolDateLocal = new Date(toolDate.getFullYear(), toolDate.getMonth(), toolDate.getDate());
                    const isPrevious = toolDateLocal < today;
                    console.log('showPreviousOutTools: Tool', doc.id, 'date (UTC):', toolDate.toISOString(), 'date (local):', toolDateLocal.toDateString(), 'isPrevious:', isPrevious);
                    return isPrevious;
                }
                console.log('showPreviousOutTools: Tool', doc.id, 'has no valid timestamp');
                return false;
            });
            
            console.log('showPreviousOutTools: Previous tools count:', previousTools.length);
            
            if (previousTools.length === 0) {
                console.log('showPreviousOutTools: No previous tools found after filtering');
                previousOutToolsList.innerHTML = '<div class="text-center text-muted">No previous OUT tools found.</div>';
                const now = new Date();
                const timeString = now.toLocaleString('en-GB', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                });
                document.getElementById('previousOutToolsSummary').innerHTML = `
                    <strong>Total: 0 tools</strong>
                    <br><small class="text-muted">Last updated: ${timeString}</small>
                `;
                return;
            }
            
            // Update the global data
            previousOutToolsData = previousTools.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            
            // Update summary with timestamp
            const now = new Date();
            const timeString = now.toLocaleString('en-GB', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
            document.getElementById('previousOutToolsSummary').innerHTML = `
                <strong>Total: ${previousTools.length} tool${previousTools.length !== 1 ? 's' : ''}</strong>
                <br><small class="text-muted">Last updated: ${timeString}</small>
            `;
            
            // Sort tools by timestamp (newest first)
            const sortedTools = previousOutToolsData.sort((a, b) => {
                const timestampA = a.timestamp ? a.timestamp.toDate() : new Date(0);
                const timestampB = b.timestamp ? b.timestamp.toDate() : new Date(0);
                return timestampB - timestampA;
            });
            
            let html = '';
            sortedTools.forEach((tool, index) => {
                const status = (tool.status || '').toUpperCase();
                const statusClass = status.toLowerCase();
                
                // Format timestamp
                const formattedDate = tool.timestamp ? tool.timestamp.toDate().toLocaleString('en-GB', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                }) : 'Unknown';
                // Get WorkOn value or N/A
                const workOnValue = (typeof tool.WorkOn === 'string' && tool.WorkOn.trim()) ? tool.WorkOn : 'N/A';
                html += `
                    <div class="previous-out-tool-card ${statusClass}" onclick="showPreviousOutToolDetails('${tool.id}')">
                        <div class="previous-out-tool-name">${index + 1}. ${tool.toolName || 'Unknown Tool'}</div>
                        <div class="previous-out-tool-date" style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
                            <span>${formattedDate}</span>
                            <span style="font-size:1em;font-weight:bold;color:#222;display:inline-block;">WorkOn: <span style="color:#888;font-weight:bold;">${workOnValue}</span></span>
                        </div>
                        <div class="previous-out-tool-row">
                            <div class="previous-out-tool-column">
                                <div class="previous-out-tool-label">TID</div>
                                <div class="previous-out-tool-value">${tool.id}</div>
                            </div>
                            <div class="previous-out-tool-column">
                                <div class="previous-out-tool-label">P/N</div>
                                <div class="previous-out-tool-value">${tool.partNumber || 'N/A'}</div>
                            </div>
                            <div class="previous-out-tool-column">
                                <div class="previous-out-tool-label">STS</div>
                                <div class="previous-out-tool-status">${status}</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            previousOutToolsList.innerHTML = html;
            
        } catch (error) {
            console.error('Error loading previous OUT tools:', error);
            previousOutToolsList.innerHTML = '<div class="text-center text-danger">Error loading previous OUT tools. Please try again.</div>';
            const now = new Date();
            const timeString = now.toLocaleString('en-GB', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
            document.getElementById('previousOutToolsSummary').innerHTML = `
                <strong class="text-danger">Error loading data</strong>
                <br><small class="text-muted">Last attempt: ${timeString}</small>
            `;
        }
    }

    async function showPreviousOutToolDetails(toolId) {
        const tool = previousOutToolsData.find(t => t.id === toolId);
        if (!tool) {
            alert('Tool not found.');
            return;
        }
        // Build the tool object in the format expected by showToolDetails
        const formattedTimestamp = tool.timestamp && tool.timestamp.toDate ? tool.timestamp.toDate().toLocaleString('en-GB', {
            day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
        }) : 'N/A';
        const calDueDate = tool.calDueDate && tool.calDueDate.toDate ? tool.calDueDate.toDate().toLocaleDateString('en-GB') : 'N/A';
        showToolDetails({
            toolName: tool.toolName || 'Unknown Tool',
            toolId: tool.id,
            partNumber: tool.partNumber || tool.id,
            collectionCode: tool.collectionCode || '',
            location: tool.location || 'N/A',
            owner: tool.owner || 'N/A',
            status: tool.status || 'N/A',
            technician: tool.technician || 'N/A',
            timestamp: formattedTimestamp,
            calDueDate: calDueDate,
            photoUrls: tool.photoUrls || []
        }, 'previousOut');
    }

    // Add a global variable to track the source screen
    let lastCollectionDetailsSource = 'registerTools';

    async function showCollectionDetails(collectionCode, sourceScreen) {
        if (!collectionCode) return;
        // Track the source screen
        lastCollectionDetailsSource = sourceScreen || 'registerTools';
        // Hide all main screens
        document.getElementById('toolScannerMenu').style.display = 'none';
        document.getElementById('appSection').style.display = 'none';
        document.getElementById('myToolsScreen').style.display = 'none';
        document.getElementById('myToolsByCollectionScreen').style.display = 'none';
        document.getElementById('collectionCheckupScreen').style.display = 'none';
        document.getElementById('previousOutToolsScreen').style.display = 'none';
        document.getElementById('collectionDetailsScreen').style.display = 'block';
        
        // Force-hide the tool details modal and remove any modal backdrop
        const toolDetailsModalEl = document.getElementById('toolDetailsModal');
        if (toolDetailsModalEl) {
            // Blur any focused elements inside the modal first
            const focusedElement = toolDetailsModalEl.querySelector(':focus');
            if (focusedElement) {
                focusedElement.blur();
            }
            toolDetailsModalEl.classList.remove('show');
            toolDetailsModalEl.style.display = 'none';
            toolDetailsModalEl.setAttribute('aria-hidden', 'true');
            toolDetailsModalEl.removeAttribute('aria-modal');
            toolDetailsModalEl.removeAttribute('role');
        }
        // Remove any modal-backdrop
        document.querySelectorAll('.modal-backdrop').forEach(el => el.parentNode.removeChild(el));
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';

        // Update the title to show "Collection (value)"
        const titleElement = document.querySelector('#collectionDetailsScreen h2');
        if (titleElement) {
            titleElement.textContent = `Collection (${collectionCode})`;
        }

        // Get owner from tools collection
        let ownerFromTools = 'N/A';
        try {
            const toolsSnapshot = await db.collection('tools')
                .where('collectionCode', '==', collectionCode)
                .limit(1)
                .get();
            if (!toolsSnapshot.empty) {
                const toolData = toolsSnapshot.docs[0].data();
                ownerFromTools = toolData.owner || 'N/A';
            }
        } catch (error) {
            console.log('Error getting owner from tools:', error);
        }

        // Add owner information below back button
        const backButton = document.getElementById('backToRegisterToolsBtn');
        if (backButton) {
            // Check if owner div already exists
            let ownerDiv = document.getElementById('collectionOwnerDiv');
            
            if (!ownerDiv) {
                // Create new owner div only if it doesn't exist
                ownerDiv = document.createElement('div');
                ownerDiv.id = 'collectionOwnerDiv';
            backButton.parentNode.insertBefore(ownerDiv, backButton.nextSibling);
            }
            
            // Update the content (whether new or existing)
            ownerDiv.innerHTML = `<div style="color: #1976d2; font-weight: bold; font-size: 1.1em; margin-bottom: 1rem;">Owner: ${ownerFromTools}</div>`;
        }

        const content = document.getElementById('collectionDetailsContent');
        content.innerHTML = '<div class="text-center">Loading collection details...</div>';
        
        try {
            // Query collections collection where collectionName matches the collectionCode from tools
            const querySnapshot = await db.collection('collections').where('collectionName', '==', collectionCode).get();
            if (querySnapshot.empty) {
                content.innerHTML = `<div class="text-center text-danger">Collection not found.</div>`;
            } else {
                const doc = querySnapshot.docs[0]; // Get the first matching document
                const data = doc.data();
                let html = `<div class="card mb-4">
                    <div class="card-body">`;
                if (data.description) html += `<p class="card-text"><strong>Description:</strong> ${data.description}</p>`;
                html += `</div></div>`;
                
                if (data.photoUrls && Array.isArray(data.photoUrls) && data.photoUrls.length > 0) {
                    html += `<h5 class="mb-3">Photos <span style='color:#FF9800;font-weight:bold;'>(${data.photoUrls.length})</span></h5><div class="row">`;
                    data.photoUrls.forEach(url => {
                        html += `<div class="col-6 col-md-4 col-lg-3 mb-3">
                            <img src="${url}" alt="Collection Photo" class="img-fluid rounded shadow" style="width: 100%; height: 200px; object-fit: cover;">
                        </div>`;
                    });
                    html += `</div>`;
                } else {
                    html += `<div class="text-center text-muted"><em>No photos available for this collection.</em></div>`;
                }
                content.innerHTML = html;
            }
        } catch (error) {
            content.innerHTML = `<div class="text-center text-danger">Error loading collection details: ${error.message}</div>`;
        }
        // At the end, update the back button text
        safeUpdateCollectionDetailsBackButton();
    }

    // Update all calls to showCollectionDetails from previous out to pass 'previousOut' as the source
    function navigateToCollection(collectionCode) {
        if (collectionCode && collectionCode !== 'N/A') {
            // Close the current modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('previousOutToolDetailsModal'));
            modal.hide();
            // Show the full collection details screen (same as Register Tool dialog)
            showCollectionDetails(collectionCode, 'previousOut');
        }
    }

    // Add this after DOMContentLoaded or at the end of the script
    document.addEventListener('DOMContentLoaded', function() {
        var collectionCancelBtn = document.querySelector('#collectionSelectModal .btn-secondary[data-bs-dismiss="modal"]');
        if (collectionCancelBtn) {
            collectionCancelBtn.onclick = function() {
                // Let Bootstrap close the modal, then show the menu
                setTimeout(function() {
                    toolScannerMenu();
                }, 300); // Wait for modal animation
            };
        }
    });





    // Function to show tool list and hide collection details
    function showToolList() {
        const toolList = document.getElementById('toolList');
        const collectionDetailsContainer = document.getElementById('collectionDetailsContainer');
        
        if (collectionDetailsContainer) {
            collectionDetailsContainer.style.display = 'none';
        }
        toolList.style.display = 'block';
    }



    // Add the showToolPhotoGallery function
    function showToolPhotoGallery(el) {
        const photoUrls = JSON.parse(el.getAttribute('data-photo-urls'));
            const toolId = el.getAttribute('data-tool-id');
            const partNumber = el.getAttribute('data-part-number');
        if (!photoUrls || photoUrls.length === 0) return;
        let currentPhotoIndex = 0;
        const galleryContent = document.getElementById('toolPhotoGalleryContent');
        const counter = document.getElementById('toolPhotoCounter');
        const prevBtn = document.getElementById('toolPhotoPrevBtn');
        const nextBtn = document.getElementById('toolPhotoNextBtn');
            
        function updatePhoto() {
            // Clear the content and add the image
            galleryContent.innerHTML = `<img src="${photoUrls[currentPhotoIndex]}" class="img-fluid rounded shadow" style="max-height:80vh;max-width:100vw;object-fit:contain;">`;
            
            // Add back the navigation arrows
            const prevArrow = document.createElement('button');
            prevArrow.type = 'button';
            prevArrow.className = 'btn btn-light position-absolute';
            prevArrow.id = 'toolPhotoPrevBtn';
            prevArrow.style = 'left: 20px; top: 50%; transform: translateY(-50%); z-index: 1000; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;';
            prevArrow.innerHTML = '<i class="fas fa-chevron-left"></i>';
            prevArrow.onclick = function() {
            if (currentPhotoIndex > 0) {
                currentPhotoIndex--;
                updatePhoto();
            }
        };
            
            const nextArrow = document.createElement('button');
            nextArrow.type = 'button';
            nextArrow.className = 'btn btn-light position-absolute';
            nextArrow.id = 'toolPhotoNextBtn';
            nextArrow.style = 'right: 20px; top: 50%; transform: translateY(-50%); z-index: 1000; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;';
            nextArrow.innerHTML = '<i class="fas fa-chevron-right"></i>';
            nextArrow.onclick = function() {
            if (currentPhotoIndex < photoUrls.length - 1) {
                currentPhotoIndex++;
                updatePhoto();
            }
        };
            
            galleryContent.appendChild(prevArrow);
            galleryContent.appendChild(nextArrow);
            
            // Update counter
            counter.textContent = `${currentPhotoIndex + 1} / ${photoUrls.length}`;
            
            // Show/hide arrows based on position
            prevArrow.style.display = currentPhotoIndex === 0 ? 'none' : 'flex';
            nextArrow.style.display = currentPhotoIndex === photoUrls.length - 1 ? 'none' : 'flex';
                
            // Update delete button
            const deleteBtn = document.getElementById('toolPhotoDeleteBtn');
            if (deleteBtn) {
                deleteBtn.onclick = function() {
                    deletePhoto(toolId, partNumber, currentPhotoIndex, photoUrls[currentPhotoIndex]);
                };
            }
        }
        
        updatePhoto();
        const modal = new bootstrap.Modal(document.getElementById('toolPhotoGalleryModal'));
        modal.show();
    }

        // Delete photo function
        async function deletePhoto(toolId, partNumber, photoIndex, photoUrl) {
            return new Promise(async (resolve, reject) => {
            try {
                console.log('=== PHOTO DELETE STARTED ===');
                console.log('Tool ID:', toolId);
                console.log('Part Number:', partNumber);
                console.log('Photo Index:', photoIndex);
                console.log('Photo URL:', photoUrl);

                    // Find all tools with the same part number to show owners
                    const toolsWithSamePart = await db.collection('tools')
                        .where('partNumber', '==', partNumber)
                        .get();

                    // Get unique owners
                    const owners = [...new Set(toolsWithSamePart.docs.map(doc => doc.data().owner))].filter(Boolean);
                    
                    // Format owners as numbered vertical list
                    let ownersListHTML = '';
                    if (owners.length === 0) {
                        ownersListHTML = '<div style="font-size: 1.15rem; font-weight: bold; color: #666;">Unknown</div>';
                    } else {
                        ownersListHTML = owners.map((owner, index) => 
                            `<div style="font-size: 1.15rem; font-weight: bold; color: #333; margin-bottom: 6px;">${index + 1}. ${owner}</div>`
                        ).join('');
                    }
                    
                    // Show custom modal with owner information
                    document.getElementById('photoDeleteOwnersList').innerHTML = ownersListHTML;
                    const choiceModal = new bootstrap.Modal(document.getElementById('photoDeleteChoiceModal'));
                    choiceModal.show();
                    
                    let deleteFromAll = false;
                    
                    // Handle "Delete from MY Tool Only" button
                    document.getElementById('deleteMyToolOnlyBtn').onclick = function() {
                        choiceModal.hide();
                        
                        // Ask for confirmation before deleting from my tool
                        if (!confirm(' Are you sure you want to delete this photo from YOUR tool?\n\nThis action cannot be undone.')) {
                            return;
                        }
                        
                        deleteFromAll = false;
                        proceedWithDeletion();
                    };
                    
                    // Handle "Delete from ALL Tools" button
                    document.getElementById('deleteFromAllToolsBtn').onclick = async function() {
                        choiceModal.hide();
                        
                        // Fetch admin code from Firestore
                        const settingsDoc = await db.collection('settings').doc('admin').get();
                        const adminCode = settingsDoc.exists ? settingsDoc.data().adminCode : null;
                        
                        if (!adminCode) {
                            alert('Admin code not configured. Please contact system administrator.');
                            return;
                        }
                        
                        // Prompt for admin code
                        const enteredCode = prompt(' Enter admin code to delete photo from ALL tools:');
                        
                        if (enteredCode === null) {
                            // User cancelled
                            return;
                        }
                        
                        if (enteredCode !== adminCode) {
                            alert(' Incorrect admin code. Photo deletion cancelled.');
                            return;
                        }
                        
                        // After successful admin code verification, ask for final confirmation
                        if (!confirm(` Are you sure you want to delete this photo from ALL ${toolsWithSamePart.docs.length} tools?\n\nThis will permanently remove the photo from:\n${owners.join('\n')}\n\nThis action CANNOT be undone!`)) {
                            return;
                        }
                        
                        deleteFromAll = true;
                        proceedWithDeletion();
                    };
                    
                    async function proceedWithDeletion() {

                // Show loading modal
                const loadingModal = new bootstrap.Modal(document.getElementById('photoUploadLoadingModal'));
                loadingModal.show();
                document.getElementById('photoUploadProgress').textContent = 'Deleting photo...';

                // Get current photo URLs for this tool
                const toolDoc = await db.collection('tools').doc(toolId).get();
                const currentPhotoUrls = toolDoc.exists ? (toolDoc.data().photoUrls || []) : [];
                
                // Remove the photo from the array
                const updatedPhotoUrls = currentPhotoUrls.filter((url, index) => index !== photoIndex);
                
                // Update the current tool's photoUrls array
                await db.collection('tools').doc(toolId).update({
                    photoUrls: updatedPhotoUrls
                });

                let affectedToolsCount = 1;

                if (deleteFromAll) {
                    // Delete from all tools with the same part number
                const updatePromises = toolsWithSamePart.docs.map(async (doc) => {
                    if (doc.id !== toolId) { // Don't update the original tool again
                        const existingPhotoUrls = doc.data().photoUrls || [];
                        const updatedUrls = existingPhotoUrls.filter(url => url !== photoUrl);
                        await doc.ref.update({
                            photoUrls: updatedUrls
                        });
                        console.log('Updated tool', doc.id, 'removed same photo');
                    }
                });

                await Promise.all(updatePromises);
                    affectedToolsCount = toolsWithSamePart.docs.length;

                    // Try to delete from Firebase Storage
                try {
                    console.log('Original photo URL:', photoUrl);
                    
                    // Extract the full path from the Firebase Storage URL
                    const urlParts = photoUrl.split('/');
                        const encodedPath = urlParts[urlParts.length - 1].split('?')[0];
                        const decodedPath = decodeURIComponent(encodedPath);
                    console.log('Attempting to delete from storage path:', decodedPath);
                    
                    const photoRef = storage.ref().child(decodedPath);
                    console.log('Storage reference:', photoRef.toString());
                    
                    await photoRef.delete();
                    console.log('Photo deleted from storage successfully:', decodedPath);
                } catch (storageError) {
                    console.warn('Could not delete from storage (file may not exist):', storageError);
                    console.warn('Storage error details:', storageError.message);
                    console.warn('Storage error code:', storageError.code);
                    }
                }

                console.log('=== PHOTO DELETE COMPLETED ===');
                loadingModal.hide();
                
                if (deleteFromAll) {
                    alert(`Photo deleted from ALL ${affectedToolsCount} tools with part number "${partNumber}".`);
                } else {
                    alert(`Photo deleted from your tool only. Other tools with part number "${partNumber}" still have this photo.`);
                }

                // Close the photo gallery modal
                const galleryModal = bootstrap.Modal.getInstance(document.getElementById('toolPhotoGalleryModal'));
                if (galleryModal) galleryModal.hide();

                // Refresh the current view
                if (lastViewedCollectionName) {
                    showMyToolsByCollection(lastViewedCollectionName);
                } else {
                    // Refresh other views
                    loadTools(); // Refresh register tools
                    updatePreviousOutToolsCount(); // Refresh previous out tools count
                }
                
                        resolve();
                }

            } catch (error) {
                console.error('=== PHOTO DELETE FAILED ===', error);
                const loadingModal = bootstrap.Modal.getInstance(document.getElementById('photoUploadLoadingModal'));
                if (loadingModal) loadingModal.hide();
                alert('Delete failed: ' + error.message);
                    reject(error);
            }
            });
    }

    // Settings button logic
    const settingsBtn = document.getElementById('settingsBtn');
    if (settingsBtn) {
        settingsBtn.onclick = function() {
            document.getElementById('adminCodeInput').value = '';
            document.getElementById('adminCodeError').style.display = 'none';
            const modal = new bootstrap.Modal(document.getElementById('adminCodeModal'));
            modal.show();
        };
    }

    // Verify admin code logic
    const verifyAdminCodeBtn = document.getElementById('verifyAdminCodeBtn');
    if (verifyAdminCodeBtn) {
        verifyAdminCodeBtn.onclick = async function() {
            const inputCode = document.getElementById('adminCodeInput').value.trim();
            const errorDiv = document.getElementById('adminCodeError');
            errorDiv.style.display = 'none';
            try {
                const settingsDoc = await db.collection('settings').doc('admin').get();
                const adminCode = settingsDoc.exists ? settingsDoc.data().adminCode : null;
                if (inputCode === adminCode) {
                    // Hide admin code modal
                    bootstrap.Modal.getInstance(document.getElementById('adminCodeModal')).hide();
                    // Show My Account modal
                    const user = auth.currentUser;
                    if (!user) return;
                    const fullName = localStorage.getItem('fullName') || user.email;
                    document.getElementById('accountNameInput').value = fullName;
                    window.originalNameForUpdate = fullName;
                    console.log('originalNameForUpdate set to:', window.originalNameForUpdate);
                    document.getElementById('myAccountError').style.display = 'none';
                    document.getElementById('myAccountSuccess').style.display = 'none';
                    const modal = new bootstrap.Modal(document.getElementById('myAccountModal'));
                    modal.show();
                } else {
                    errorDiv.textContent = 'Incorrect admin code.';
                    errorDiv.style.display = 'block';
                }
            } catch (e) {
                errorDiv.textContent = 'Error verifying admin code.';
                errorDiv.style.display = 'block';
            }
        };
    }

    // Save account name logic (no email change)
    const saveAccountNameBtn = document.getElementById('saveAccountNameBtn');
    if (saveAccountNameBtn) {
        saveAccountNameBtn.onclick = async function() {
            const newName = document.getElementById('accountNameInput').value.trim();
            const errorDiv = document.getElementById('myAccountError');
            const successDiv = document.getElementById('myAccountSuccess');
            const loadingDiv = document.getElementById('myAccountLoading');
            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';
            loadingDiv.style.display = 'block';
            
            // Validate name format
            if (!newName || !/^([A-Z][a-z]+)( [A-Z][a-z]+)+$/.test(newName)) {
                loadingDiv.style.display = 'none';
                errorDiv.textContent = 'Please enter a valid full name with both first and last name (English letters only).';
                errorDiv.style.display = 'block';
                return;
            }
            try {
                const user = auth.currentUser;
                if (!user) throw new Error('No user logged in');
                const oldName = window.originalNameForUpdate;
                console.log('oldName used for update:', oldName);
                // Update technicians collection (name only)
                const techSnap = await db.collection('technicians').where('fullName', '==', oldName).get();
                if (!techSnap.empty) {
                    await Promise.all(techSnap.docs.map(doc => doc.ref.update({ fullName: newName })));
                }
                // Update tools collection (owner and technician fields)
                const toolsOwnerSnap = await db.collection('tools').where('owner', '==', oldName).get();
                await Promise.all(toolsOwnerSnap.docs.map(doc => doc.ref.update({ owner: newName })));
                const toolsTechSnap = await db.collection('tools').where('technician', '==', oldName).get();
                await Promise.all(toolsTechSnap.docs.map(doc => doc.ref.update({ technician: newName })));
                // Update logtoolmovements collection (owner and technician fields)
                const logsOwnerSnap = await db.collection('logtoolmovements').where('owner', '==', oldName).get();
                await Promise.all(logsOwnerSnap.docs.map(doc => doc.ref.update({ owner: newName })));
                const logsTechSnap = await db.collection('logtoolmovements').where('technician', '==', oldName).get();
                await Promise.all(logsTechSnap.docs.map(doc => doc.ref.update({ technician: newName })));
                // Update checkupResults collection (technicianName field) with debug
                const checkupSnap = await db.collection('checkupResults').where('technicianName', '==', oldName).get();
                console.log('Docs found for update:', checkupSnap.docs.length);
                if (checkupSnap.docs.length > 0) {
                    console.log('First doc:', checkupSnap.docs[0].id, checkupSnap.docs[0].data());
                }
                await Promise.all(checkupSnap.docs.map(doc => doc.ref.update({ technicianName: newName })));
                // Update localStorage and UI
                localStorage.setItem('fullName', newName);
                document.getElementById('fullName').textContent = newName;
                loadingDiv.style.display = 'none';
                successDiv.textContent = 'Name updated successfully.';
                successDiv.style.display = 'block';
                // Change Cancel button to Exit, red with white bold letters
                const cancelBtn = document.querySelector('#myAccountModal .btn-secondary');
                if (cancelBtn) {
                    cancelBtn.textContent = 'Exit';
                    cancelBtn.classList.remove('btn-secondary');
                    cancelBtn.classList.add('btn-danger');
                    cancelBtn.style.color = 'white';
                    cancelBtn.style.fontWeight = 'bold';
                }
            } catch (e) {
                loadingDiv.style.display = 'none';
                errorDiv.textContent = 'Error updating name: ' + (e.message || e);
                errorDiv.style.display = 'block';
            }
        };
    }

    // Replace or add this function in your script:
    function updateCollectionDetailsBackButton() {
        const backBtn = document.getElementById('backToRegisterToolsBtn');
        if (!backBtn) return;
        if (lastCollectionDetailsSource === 'previousOut') {
            backBtn.textContent = 'Back to Previous Out screen';
            backBtn.onclick = function() {
                document.getElementById('collectionDetailsScreen').style.display = 'none';
                document.getElementById('previousOutToolsScreen').style.display = 'block';
            };
        } else {
            backBtn.textContent = 'Back to Register Tools List';
            backBtn.onclick = function() {
                document.getElementById('collectionDetailsScreen').style.display = 'none';
                showRegisterTools(true); // Skip modal and refresh when coming back
            };
        }
    }
    // At the end of showCollectionDetails, call:
    // updateCollectionDetailsBackButton();

    // Add this function to your script:
    function safeUpdateCollectionDetailsBackButton(retries = 5) {
        const backBtn = document.getElementById('backToRegisterToolsBtn');
        if (backBtn) {
            updateCollectionDetailsBackButton();
        } else if (retries > 0) {
            setTimeout(() => safeUpdateCollectionDetailsBackButton(retries - 1), 100);
        }
    }
    // At the end of showCollectionDetails, replace updateCollectionDetailsBackButton() with:
    safeUpdateCollectionDetailsBackButton();

            // Helper to build a tool details object with all fields formatted consistently
        function buildToolDetailsObject(doc, data) {
            return {
                toolName: data.toolName || 'Unknown Tool',
                toolId: doc.id,
                partNumber: data.partNumber || doc.id,
                collectionCode: data.collectionCode || '',
                location: data.location || 'N/A',
                status: data.status || 'N/A',
                owner: data.owner || 'N/A',
                technician: data.technician || 'N/A',
                timestamp: data.timestamp && data.timestamp.toDate ? data.timestamp.toDate().toLocaleString('en-GB', {
                    day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
                }) : 'N/A',
                calDueDate: data.calDueDate && data.calDueDate.toDate ? data.calDueDate.toDate().toLocaleDateString('en-GB') : 'N/A',
                photoUrls: data.photoUrls || []
            };
        }

        // Photo upload functionality for My Tools
        async function uploadToolPhoto(toolId, partNumber, file, forceUpload = false) {
            try {
                console.log('=== PHOTO UPLOAD STARTED ===');
                console.log('Tool ID:', toolId);
                console.log('Part Number:', partNumber);
                console.log('File:', file.name, file.size, 'bytes');
                console.log('Force Upload:', forceUpload);
                
                // Check if other tools with same part number have photos (unless forceUpload is true or user already made a choice)
                // Skip this check if user already went through the choice modal
                const userAlreadyChose = currentPhotoUploadToolId === toolId && currentPhotoUploadPartNumber === partNumber;
                
                if (!forceUpload && !userAlreadyChose) {
                    const toolsWithSamePart = await db.collection('tools')
                        .where('partNumber', '==', partNumber)
                        .get();
                    
                    // Collect all existing photos from other tools
                    let existingPhotos = [];
                    toolsWithSamePart.docs.forEach(doc => {
                        if (doc.id !== toolId) { // Don't check the current tool
                            const photoUrls = doc.data().photoUrls || [];
                            photoUrls.forEach(url => {
                                if (!existingPhotos.includes(url)) {
                                    existingPhotos.push(url);
                                }
                            });
                        }
                    });
                    
                    // If other tools have photos, show the choice modal
                    if (existingPhotos.length > 0) {
                        console.log('Found existing photos:', existingPhotos.length);
                        
                        // Show modal with existing photos
                        document.getElementById('existingPhotoPartNumber').textContent = partNumber;
                        const previewContainer = document.getElementById('existingPhotoPreview');
                        previewContainer.innerHTML = existingPhotos.map(url => 
                            `<img src="${url}" style="width: 150px; height: 150px; object-fit: cover; border-radius: 8px; border: 2px solid #ddd; cursor: pointer;" onclick="window.open('${url}', '_blank')">`
                        ).join('');
                        
                        const choiceModal = new bootstrap.Modal(document.getElementById('existingPhotoChoiceModal'));
                        choiceModal.show();
                        
                        // Handle "Use Existing Photo(s)" button
                        document.getElementById('useExistingPhotoBtn').onclick = async function() {
                            choiceModal.hide();
                            
                            // Add existing photos to current tool
                            const toolDoc = await db.collection('tools').doc(toolId).get();
                            const currentPhotoUrls = toolDoc.exists ? (toolDoc.data().photoUrls || []) : [];
                            const newPhotoUrls = [...currentPhotoUrls, ...existingPhotos];
                            
                            await db.collection('tools').doc(toolId).update({
                                photoUrls: newPhotoUrls
                            });
                            
                            alert(` Existing photo(s) added to your tool!`);
                            
                            // Refresh the view
                            if (lastViewedCollectionName) {
                                showMyToolsByCollection(lastViewedCollectionName);
                            } else {
                                loadTools();
                                updatePreviousOutToolsCount();
                            }
                        };
                        
                        // Handle "Add My New Photo (Only to My Tool)" button
                        document.getElementById('addNewPhotoAnywayBtn').onclick = function() {
                            choiceModal.hide();
                            // Proceed with upload but don't share with other tools
                            uploadToolPhoto(toolId, partNumber, file, true);
                        };
                        
                        return; // Stop here and wait for user choice
                    }
                }
                
                // Show loading modal
                const loadingModal = new bootstrap.Modal(document.getElementById('photoUploadLoadingModal'));
                loadingModal.show();
                document.getElementById('photoUploadProgress').textContent = 'Processing image...';
                
                // Compress the image
                const compressedBlob = await compressImage(file);
                if (!compressedBlob) {
                    loadingModal.hide();
                    alert('Failed to compress image');
                    return;
                }
                
                console.log('Compressed size:', compressedBlob.size, 'bytes');
                document.getElementById('photoUploadProgress').textContent = 'Uploading to storage...';
                
                // Get current photo count for this tool
                const toolDoc = await db.collection('tools').doc(toolId).get();
                const currentPhotoUrls = toolDoc.exists ? (toolDoc.data().photoUrls || []) : [];
                const photoNumber = currentPhotoUrls.length + 1;
                
                // Create filename: partNumber_photo#.jpg
                const fileName = `${partNumber}_photo${photoNumber}.jpg`;
                console.log('Generated filename:', fileName);
                
                // Upload to Tool_Photos folder
                const photoRef = storage.ref('Tool_Photos/' + fileName);
                const uploadTask = photoRef.put(compressedBlob);
                
                uploadTask.on('state_changed',
                    (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        console.log('Upload progress:', progress + '%');
                        document.getElementById('photoUploadProgress').textContent = `Uploading... ${Math.round(progress)}%`;
                    },
                    (error) => {
                        console.error('Upload error:', error);
                        loadingModal.hide();
                        alert('Upload failed: ' + error.message);
                    },
                    async () => {
                        try {
                            document.getElementById('photoUploadProgress').textContent = 'Updating database...';
                            
                            // Get download URL
                            const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                            console.log('Download URL:', downloadURL);
                            
                            // Update the tool's photoUrls array
                            const newPhotoUrls = [...currentPhotoUrls, downloadURL];
                            await db.collection('tools').doc(toolId).update({
                                photoUrls: newPhotoUrls
                            });
                            
                            // Share with other tools if user chose "Add to ALL Tools"
                            // Check if this is the same tool/partNumber from the choice modal
                            const shouldAddToAll = photoUploadToAllTools && currentPhotoUploadToolId === toolId && currentPhotoUploadPartNumber === partNumber;
                            
                            if (shouldAddToAll) {
                            // Find all tools with the same part number and add the same photo
                            const toolsWithSamePart = await db.collection('tools')
                                .where('partNumber', '==', partNumber)
                                .get();
                            
                            const updatePromises = toolsWithSamePart.docs.map(async (doc) => {
                                if (doc.id !== toolId) { // Don't update the original tool again
                                    const existingPhotoUrls = doc.data().photoUrls || [];
                                    const updatedPhotoUrls = [...existingPhotoUrls, downloadURL];
                                    await doc.ref.update({
                                        photoUrls: updatedPhotoUrls
                                    });
                                    console.log('Updated tool', doc.id, 'with same photo');
                                }
                            });
                            
                            await Promise.all(updatePromises);
                            
                            console.log('=== PHOTO UPLOAD COMPLETED ===');
                            loadingModal.hide();
                            alert('Photo uploaded successfully! Added to ' + (toolsWithSamePart.docs.length) + ' tools with the same part number.');
                            } else if (photoUploadAutoShareTargets.length > 0) {
                                const sharePromises = photoUploadAutoShareTargets.map(async (target) => {
                                    const existingPhotoUrls = target.photoUrls || [];
                                    if (!existingPhotoUrls.includes(downloadURL)) {
                                        const updatedPhotoUrls = [...existingPhotoUrls, downloadURL];
                                        await target.ref.update({
                                            photoUrls: updatedPhotoUrls
                                        });
                                        console.log('Auto-shared photo with tool', target.id);
                                    }
                                });

                                await Promise.all(sharePromises);

                                console.log('=== PHOTO UPLOAD COMPLETED (AUTO-SHARED) ===');
                                loadingModal.hide();
                                const reportLines = photoUploadAutoShareTargets.map(target => `${target.toolName} (${target.owner})`);
                                alert(` Photo uploaded successfully! Also shared with ${photoUploadAutoShareTargets.length} other tool(s) that previously had no photos:\n${reportLines.join('\n')}`);
                            } else {
                                console.log('=== PHOTO UPLOAD COMPLETED (INDIVIDUAL) ===');
                                loadingModal.hide();
                                alert(' Photo uploaded successfully! Added to YOUR tool only.');
                            }
                            
                            // Reset the global variables
                            photoUploadToAllTools = false;
                            currentPhotoUploadToolId = null;
                            currentPhotoUploadPartNumber = null;
                            photoUploadAutoShareTargets = [];
                            
                            // Refresh the current view
                            if (lastViewedCollectionName) {
                                showMyToolsByCollection(lastViewedCollectionName);
                            } else {
                                // Refresh other views
                                loadTools(); // Refresh register tools
                                updatePreviousOutToolsCount(); // Refresh previous out tools count
                            }
                            
                        } catch (error) {
                            console.error('Error updating tool:', error);
                            loadingModal.hide();
                            alert('Error updating tool: ' + error.message);
                        }
                    }
                );
                
            } catch (error) {
                console.error('=== PHOTO UPLOAD FAILED ===', error);
                const loadingModal = bootstrap.Modal.getInstance(document.getElementById('photoUploadLoadingModal'));
                if (loadingModal) loadingModal.hide();
                alert('Upload failed: ' + error.message);
            }
        }

        // Image compression function
        function compressImage(file) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    console.log('Original image size:', img.width, 'x', img.height);
                    
                    // Calculate new dimensions (max 1200px width/height)
                    let newWidth = img.width;
                    let newHeight = img.height;
                    const maxSize = 1200;
                    
                    if (newWidth > maxSize || newHeight > maxSize) {
                        if (newWidth > newHeight) {
                            newHeight = (newHeight * maxSize) / newWidth;
                            newWidth = maxSize;
                        } else {
                            newWidth = (newWidth * maxSize) / newHeight;
                            newHeight = maxSize;
                        }
                    }
                    
                    console.log('Resized to:', newWidth, 'x', newHeight);
                    
                    // Set canvas size
                    canvas.width = newWidth;
                    canvas.height = newHeight;
                    
                    // Draw and compress
                    ctx.drawImage(img, 0, 0, newWidth, newHeight);
                    
                    // Try different quality levels to get under 800KB
                    let quality = 0.95;
                    
                    function tryCompression() {
                        canvas.toBlob((result) => {
                            console.log('Compressed size:', result.size, 'bytes, Quality:', quality);
                            
                            if (result.size <= 800 * 1024 || quality <= 0.1) {
                                console.log('Final compressed size:', result.size, 'bytes, Quality:', quality);
                                resolve(result);
                            } else {
                                quality -= 0.05;
                                tryCompression();
                            }
                        }, 'image/jpeg', quality);
                    }
                    
                    tryCompression();
                };
                
                img.onerror = function() {
                    console.error('Failed to load image');
                    resolve(null);
                };
                
                img.src = URL.createObjectURL(file);
            });
        }

        // Global variable to store photo upload choice
        let photoUploadToAllTools = false;
        let currentPhotoUploadToolId = null;
        let currentPhotoUploadPartNumber = null;
        let photoUploadAutoShareTargets = [];

        async function verifyAdminCode(actionDescription = 'perform this action') {
            try {
                const settingsDoc = await db.collection('settings').doc('admin').get();
                const adminCode = settingsDoc.exists ? settingsDoc.data().adminCode : null;

                if (!adminCode) {
                    alert('Admin code not configured. Please contact system administrator.');
                    return false;
                }

                const enteredCode = prompt(` Enter admin code to ${actionDescription}:`);
                if (enteredCode === null) {
                    return false;
                }

                if (enteredCode !== adminCode) {
                    alert(' Incorrect admin code.');
                    return false;
                }

                return true;
            } catch (error) {
                console.error('Error verifying admin code:', error);
                alert('Unable to verify admin code. Please try again.');
                return false;
            }
        }

        // Create photo upload options (camera or gallery)
        async function createPhotoUploadInput(toolId, partNumber) {
            currentPhotoUploadToolId = toolId;
            currentPhotoUploadPartNumber = partNumber;
            photoUploadToAllTools = false; // Reset choice
            photoUploadAutoShareTargets = [];

            try {
                // Check if there are other tools with the same part number that have photos
                const toolsWithSamePart = await db.collection('tools')
                    .where('partNumber', '==', partNumber)
                    .get();

                // Filter tools that have photos (excluding current tool)
                const toolsWithPhotos = toolsWithSamePart.docs
                    .filter(doc => doc.id !== toolId && doc.data().photoUrls && doc.data().photoUrls.length > 0)
                    .map(doc => ({
                        id: doc.id,
                        toolName: doc.data().toolName || 'Unknown Tool',
                        owner: doc.data().owner || 'Unknown',
                        photoCount: (doc.data().photoUrls || []).length,
                        photoUrls: doc.data().photoUrls || []
                    }));

                // If other tools with photos exist, show choice modal
                if (toolsWithPhotos.length > 0) {
                    // Format tools list
                    let toolsListHTML = '';
                    toolsListHTML = toolsWithPhotos.map((tool, index) => 
                        `<div style="font-size: 1.15rem; font-weight: bold; color: #333; margin-bottom: 6px;">
                            ${index + 1}. ${tool.toolName} (Owner: ${tool.owner}) - ${tool.photoCount} photo(s)
                        </div>`
                    ).join('');

                    // Collect all unique photo URLs from all tools
                    const allPhotoUrls = [];
                    toolsWithPhotos.forEach(tool => {
                        tool.photoUrls.forEach(url => {
                            if (!allPhotoUrls.includes(url) && !currentToolPhotoUrls.includes(url)) {
                                allPhotoUrls.push(url);
                            }
                        });
                    });

                    // Initialize selected photos array
                    window.selectedPhotos = [];

                    // Format photo thumbnails with selection handlers
                    let thumbnailsHTML = '';
                    if (allPhotoUrls.length > 0) {
                        thumbnailsHTML = allPhotoUrls.map((url, index) => 
                            `<div style="position: relative; display: inline-block;">
                                <img src="${url}" 
                                     data-photo-url="${url}"
                                     data-photo-index="${index}"
                                     class="photo-thumbnail-selectable"
                                     style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px; border: 2px solid #ddd; cursor: pointer; transition: all 0.2s;" 
                                     onclick="togglePhotoSelection('${url}', ${index})"
                                     onmouseover="this.style.transform='scale(1.05)';"
                                     onmouseout="if(!this.classList.contains('selected')) { this.style.transform='scale(1)'; }"
                                     title="Click to select/deselect">
                                <div class="photo-selected-indicator" style="display: none; position: absolute; top: -5px; right: -5px; background: #4CAF50; color: white; border-radius: 50%; width: 24px; height: 24px; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                                    <i class="fas fa-check"></i>
                                </div>
                            </div>`
                        ).join('');
                    } else {
                        thumbnailsHTML = '<div style="color: #999; font-style: italic;">No new shared photos available (your tool already has all of them).</div>';
                    }

                    // Show choice modal
                    document.getElementById('photoUploadToolsList').innerHTML = toolsListHTML;
                    document.getElementById('photoUploadThumbnails').innerHTML = thumbnailsHTML;
                    document.getElementById('selectedCount').textContent = '0';

                    const addSelectedMyBtn = document.getElementById('addSelectedPhotosMyToolBtn');
                    const addSelectedAllBtn = document.getElementById('addSelectedPhotosAllToolsBtn');
                    if (addSelectedMyBtn) addSelectedMyBtn.disabled = true;
                    if (addSelectedAllBtn) addSelectedAllBtn.disabled = true;

                    const choiceModal = new bootstrap.Modal(document.getElementById('photoUploadChoiceModal'));
                    choiceModal.show();

                    // Store toolsWithSamePart for use in useSelectedPhotos function
                    window.currentPhotoUploadData = {
                        toolId: toolId,
                        partNumber: partNumber,
                        toolsWithSamePart: toolsWithSamePart,
                        toolsWithPhotos: toolsWithPhotos,
                        allPhotoUrls: allPhotoUrls,
                        currentToolPhotoUrls: currentToolPhotoUrls
                    };

                    if (addSelectedMyBtn) {
                        addSelectedMyBtn.onclick = function() {
                            if (window.selectedPhotos.length > 0) {
                                useSelectedPhotos(toolId, partNumber, toolsWithSamePart.docs, false);
                            }
                        };
                    }

                    if (addSelectedAllBtn) {
                        addSelectedAllBtn.onclick = function() {
                            if (window.selectedPhotos.length > 0) {
                                useSelectedPhotos(toolId, partNumber, toolsWithSamePart.docs, true);
                            }
                        };
                    }

                    const addNewPhotoMyBtn = document.getElementById('addNewPhotoMyToolBtn');
                    if (addNewPhotoMyBtn) {
                        addNewPhotoMyBtn.onclick = function() {
                            photoUploadToAllTools = false;
                            photoUploadAutoShareTargets = [];
                            window.selectedPhotos = [];
                            choiceModal.hide();
                            showPhotoSourceModal(toolId, partNumber);
                        };
                    }

                    const addNewPhotoAllBtn = document.getElementById('addNewPhotoAllToolsBtn');
                    if (addNewPhotoAllBtn) {
                        addNewPhotoAllBtn.onclick = async function() {
                            const authorized = await verifyAdminCode('add a new photo to ALL matching tools');
                            if (!authorized) {
                                return;
                            }
                            photoUploadToAllTools = true;
                            photoUploadAutoShareTargets = [];
                            window.selectedPhotos = [];
                            choiceModal.hide();
                            showPhotoSourceModal(toolId, partNumber);
                        };
                    }
                } else {
                    // No other tools with photos, proceed directly to source selection
                    const toolsWithoutPhotos = toolsWithSamePart.docs
                        .filter(doc => doc.id !== toolId && (!doc.data().photoUrls || doc.data().photoUrls.length === 0));

                    photoUploadAutoShareTargets = toolsWithoutPhotos.map(doc => ({
                        id: doc.id,
                        ref: doc.ref,
                        owner: doc.data().owner || 'Unknown',
                        toolName: doc.data().toolName || 'Unknown Tool',
                        photoUrls: doc.data().photoUrls || []
                    }));

                    photoUploadToAllTools = false;
                    window.selectedPhotos = [];
                    showPhotoSourceModal(toolId, partNumber);
                }
            } catch (error) {
                console.error('Error checking tools with same part number:', error);
                // On error, proceed with normal flow (add to my tool only)
                photoUploadToAllTools = false;
                showPhotoSourceModal(toolId, partNumber);
            }
        }

        // Toggle photo selection
        function togglePhotoSelection(photoUrl, index) {
            const img = document.querySelector(`img[data-photo-index="${index}"]`);
            const indicator = img.nextElementSibling;
            
            if (!window.selectedPhotos) {
                window.selectedPhotos = [];
            }
            
            const isSelected = window.selectedPhotos.includes(photoUrl);
            
            if (isSelected) {
                // Deselect
                window.selectedPhotos = window.selectedPhotos.filter(url => url !== photoUrl);
                img.classList.remove('selected');
                img.style.border = '2px solid #ddd';
                img.style.opacity = '1';
                indicator.style.display = 'none';
            } else {
                // Select
                window.selectedPhotos.push(photoUrl);
                img.classList.add('selected');
                img.style.border = '3px solid #4CAF50';
                img.style.opacity = '0.9';
                indicator.style.display = 'flex';
            }
            
            // Update count and button states
            const count = window.selectedPhotos.length;
            const selectedCountEl = document.getElementById('selectedCount');
            if (selectedCountEl) {
                selectedCountEl.textContent = count;
            }

            const addSelectedMyBtn = document.getElementById('addSelectedPhotosMyToolBtn');
            const addSelectedAllBtn = document.getElementById('addSelectedPhotosAllToolsBtn');
            if (addSelectedMyBtn) {
                addSelectedMyBtn.disabled = count === 0;
            }
            if (addSelectedAllBtn) {
                addSelectedAllBtn.disabled = count === 0;
            }
        }

        // Use multiple selected photos
        async function useSelectedPhotos(toolId, partNumber, toolsWithSamePartDocs = [], addToAll = false) {
            if (!window.selectedPhotos || window.selectedPhotos.length === 0) {
                alert('Please select at least one photo.');
                return;
            }

            // Hide the choice modal
            const choiceModal = bootstrap.Modal.getInstance(document.getElementById('photoUploadChoiceModal'));
            if (choiceModal) choiceModal.hide();

            try {
                if (addToAll) {
                    const authorized = await verifyAdminCode('add the selected photos to ALL matching tools');
                    if (!authorized) {
                        return;
                    }

                    const updatePromises = toolsWithSamePartDocs.map(async (doc) => {
                        const existingPhotoUrls = doc.data().photoUrls || [];
                        const updatedPhotoUrls = [...existingPhotoUrls];

                        window.selectedPhotos.forEach(photoUrl => {
                            if (!updatedPhotoUrls.includes(photoUrl)) {
                                updatedPhotoUrls.push(photoUrl);
                            }
                        });

                        if (updatedPhotoUrls.length > existingPhotoUrls.length) {
                            await doc.ref.update({
                                photoUrls: updatedPhotoUrls
                            });
                            console.log('Added selected photos to tool', doc.id);
                        }
                    });

                    await Promise.all(updatePromises);
                    alert(` ${window.selectedPhotos.length} photo(s) added to ALL ${toolsWithSamePartDocs.length} tool(s)!`);
                } else {
                    // Add photos only to current tool
                    const toolDoc = await db.collection('tools').doc(toolId).get();
                    if (toolDoc.exists) {
                        const currentPhotoUrls = toolDoc.data().photoUrls || [];
                        let newPhotoUrls = [...currentPhotoUrls];

                        window.selectedPhotos.forEach(photoUrl => {
                            if (!newPhotoUrls.includes(photoUrl)) {
                                newPhotoUrls.push(photoUrl);
                            }
                        });

                        if (newPhotoUrls.length > currentPhotoUrls.length) {
                            await db.collection('tools').doc(toolId).update({
                                photoUrls: newPhotoUrls
                            });
                            alert(` ${newPhotoUrls.length - currentPhotoUrls.length} photo(s) added to YOUR tool!`);
                        } else {
                            alert(' All selected photos are already in your tool.');
                        }
                    }
                }

                // Reset selection UI
                window.selectedPhotos = [];
                const selectedCountEl = document.getElementById('selectedCount');
                if (selectedCountEl) selectedCountEl.textContent = '0';
                const addSelectedMyBtn = document.getElementById('addSelectedPhotosMyToolBtn');
                const addSelectedAllBtn = document.getElementById('addSelectedPhotosAllToolsBtn');
                if (addSelectedMyBtn) addSelectedMyBtn.disabled = true;
                if (addSelectedAllBtn) addSelectedAllBtn.disabled = true;

                // Refresh the view
                if (lastViewedCollectionName) {
                    showMyToolsByCollection(lastViewedCollectionName);
                } else {
                    loadTools();
                    updatePreviousOutToolsCount();
                }

            } catch (error) {
                console.error('Error using selected photos:', error);
                alert('Error adding photos: ' + error.message);
            }
        }

        // Use existing photo from another tool (single photo - kept for backward compatibility)
        async function useExistingPhoto(photoUrl, toolId, partNumber, totalToolsCount) {
            // Hide the choice modal
            const choiceModal = bootstrap.Modal.getInstance(document.getElementById('photoUploadChoiceModal'));
            if (choiceModal) choiceModal.hide();

            try {
                // Ask user where to add the photo
                const addToAll = confirm(`Do you want to add this photo to ALL ${totalToolsCount} tools with part number "${partNumber}"?\n\nClick OK for ALL tools, or Cancel to add only to YOUR tool.`);
                
                if (addToAll) {
                    // Fetch admin code from Firestore
                    const settingsDoc = await db.collection('settings').doc('admin').get();
                    const adminCode = settingsDoc.exists ? settingsDoc.data().adminCode : null;
                    
                    if (!adminCode) {
                        alert('Admin code not configured. Please contact system administrator.');
                        return;
                    }
                    
                    // Prompt for admin code
                    const enteredCode = prompt(' Enter admin code to add photo to ALL tools:');
                    
                    if (enteredCode === null) {
                        // User cancelled
                        return;
                    }
                    
                    if (enteredCode !== adminCode) {
                        alert(' Incorrect admin code. Photo addition cancelled.');
                        return;
                    }
                    
                    // Get tools with same part number
                    const toolsWithSamePart = await db.collection('tools')
                        .where('partNumber', '==', partNumber)
                        .get();
                    
                    const owners = [...new Set(toolsWithSamePart.docs.map(doc => doc.data().owner))].filter(Boolean);
                    if (!confirm(` Are you sure you want to add this photo to ALL ${toolsWithSamePart.docs.length} tools?\n\nThis will add the photo to:\n${owners.join('\n')}\n\nContinue?`)) {
                        return;
                    }
                    
                    // Add photo to all tools
                    const updatePromises = toolsWithSamePart.docs.map(async (doc) => {
                        const existingPhotoUrls = doc.data().photoUrls || [];
                        // Only add if not already present
                        if (!existingPhotoUrls.includes(photoUrl)) {
                            const updatedPhotoUrls = [...existingPhotoUrls, photoUrl];
                            await doc.ref.update({
                                photoUrls: updatedPhotoUrls
                            });
                            console.log('Added photo to tool', doc.id);
                        }
                    });
                    
                    await Promise.all(updatePromises);
                    alert(` Photo added successfully to ALL ${toolsWithSamePart.docs.length} tools!`);
                } else {
                    // Add photo only to current tool
                    const toolDoc = await db.collection('tools').doc(toolId).get();
                    if (toolDoc.exists) {
                        const currentPhotoUrls = toolDoc.data().photoUrls || [];
                        // Only add if not already present
                        if (!currentPhotoUrls.includes(photoUrl)) {
                            const newPhotoUrls = [...currentPhotoUrls, photoUrl];
                            await db.collection('tools').doc(toolId).update({
                                photoUrls: newPhotoUrls
                            });
                            alert(' Photo added successfully to YOUR tool!');
                        } else {
                            alert(' This photo is already in your tool.');
                        }
                    }
                }
                
                // Refresh the view
                if (lastViewedCollectionName) {
                    showMyToolsByCollection(lastViewedCollectionName);
                } else {
                    loadTools();
                    updatePreviousOutToolsCount();
                }
                
            } catch (error) {
                console.error('Error using existing photo:', error);
                alert('Error adding photo: ' + error.message);
            }
        }

        // Show photo source selection modal
        function showPhotoSourceModal(toolId, partNumber) {
            // Create modal for photo source selection
            const modalHtml = `
                <div class="modal fade" id="photoSourceModal" tabindex="-1" aria-labelledby="photoSourceModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-sm">
                        <div class="modal-content">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title" id="photoSourceModalLabel">Add Photo</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body text-center">
                                <div class="d-grid gap-3">
                                    <button type="button" class="btn btn-primary btn-lg" onclick="takePhotoWithCamera('${toolId}', '${partNumber}')">
                                        <i class="fas fa-camera"></i> Take Photo
                                    </button>
                                    <button type="button" class="btn btn-secondary btn-lg" onclick="selectPhotoFromGallery('${toolId}', '${partNumber}')">
                                        <i class="fas fa-images"></i> Choose from Gallery
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('photoSourceModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('photoSourceModal'));
            modal.show();
            
            // Clean up modal after it's hidden
            document.getElementById('photoSourceModal').addEventListener('hidden.bs.modal', function() {
                this.remove();
            });
        }

        // Take photo with camera
        function takePhotoWithCamera(toolId, partNumber) {
            // Hide the source selection modal
            const sourceModal = bootstrap.Modal.getInstance(document.getElementById('photoSourceModal'));
            if (sourceModal) sourceModal.hide();
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.capture = 'environment'; // Use back camera on mobile
            input.style.display = 'none';
            
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (file) {
                    uploadToolPhoto(toolId, partNumber, file);
                }
                // Remove the input element
                document.body.removeChild(input);
            };
            
            document.body.appendChild(input);
            input.click();
        }

        // Select photo from gallery
        function selectPhotoFromGallery(toolId, partNumber) {
            // Hide the source selection modal
            const sourceModal = bootstrap.Modal.getInstance(document.getElementById('photoSourceModal'));
            if (sourceModal) sourceModal.hide();
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.style.display = 'none';
            
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (file) {
                    uploadToolPhoto(toolId, partNumber, file);
                }
                // Remove the input element
                document.body.removeChild(input);
            };
            
            document.body.appendChild(input);
            input.click();
        }

        // Collection photo upload functionality
        async function uploadCollectionPhoto(collectionName, file) {
            try {
                console.log('=== COLLECTION PHOTO UPLOAD STARTED ===');
                console.log('Collection Name:', collectionName);
                console.log('File:', file.name, file.size, 'bytes');
                
                // Show loading modal
                const loadingModal = new bootstrap.Modal(document.getElementById('photoUploadLoadingModal'));
                loadingModal.show();
                document.getElementById('photoUploadProgress').textContent = 'Processing image...';
                
                // Compress the image
                const compressedBlob = await compressImage(file);
                if (!compressedBlob) {
                    loadingModal.hide();
                    alert('Failed to compress image');
                    return;
                }
                
                console.log('Compressed size:', compressedBlob.size, 'bytes');
                document.getElementById('photoUploadProgress').textContent = 'Uploading to storage...';
                
                // Get current photo count for this collection
                const collectionQuery = await db.collection('collections').where('collectionName', '==', collectionName).get();
                let currentPhotoUrls = [];
                let collectionDocId = null;
                
                if (!collectionQuery.empty) {
                    const collectionDoc = collectionQuery.docs[0];
                    collectionDocId = collectionDoc.id;
                    currentPhotoUrls = collectionDoc.data().photoUrls || [];
                }
                
                const photoNumber = currentPhotoUrls.length + 1;
                
                // Create filename: collectionname_photo#.jpg
                const fileName = `${collectionName}_photo${photoNumber}.jpg`;
                console.log('Generated filename:', fileName);
                
                // Upload to Collection%20Photo folder
                const photoRef = storage.ref('Collection%20Photo/' + fileName);
                const uploadTask = photoRef.put(compressedBlob);
                
                uploadTask.on('state_changed',
                    (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        console.log('Upload progress:', progress + '%');
                        document.getElementById('photoUploadProgress').textContent = `Uploading... ${Math.round(progress)}%`;
                    },
                    (error) => {
                        console.error('Upload error:', error);
                        loadingModal.hide();
                        alert('Upload failed: ' + error.message);
                    },
                    async () => {
                        try {
                            document.getElementById('photoUploadProgress').textContent = 'Updating database...';
                            
                            // Get download URL
                            const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                            console.log('Download URL:', downloadURL);
                            
                            // Update the collection's photoUrls array
                            const newPhotoUrls = [...currentPhotoUrls, downloadURL];
                            
                            if (collectionDocId) {
                                // Update existing collection
                                await db.collection('collections').doc(collectionDocId).update({
                                    photoUrls: newPhotoUrls
                                });
                            } else {
                                // Create new collection document
                                await db.collection('collections').add({
                                    collectionName: collectionName,
                                    photoUrls: newPhotoUrls,
                                    createdAt: new Date()
                                });
                            }
                            
                            console.log('=== COLLECTION PHOTO UPLOAD COMPLETED ===');
                            loadingModal.hide();
                            alert('Collection photo uploaded successfully!');
                            
                            // Refresh the current view
                            if (lastViewedCollectionName) {
                                showMyToolsByCollection(lastViewedCollectionName);
                            } else {
                                showMyTools();
                            }
                            
                            // Update button counts
                            await updateCollectionPhotoButtonCounts();
                            
                        } catch (error) {
                            console.error('Error updating collection:', error);
                            loadingModal.hide();
                            alert('Error updating collection: ' + error.message);
                        }
                    }
                );
                
            } catch (error) {
                console.error('=== COLLECTION PHOTO UPLOAD FAILED ===', error);
                const loadingModal = bootstrap.Modal.getInstance(document.getElementById('photoUploadLoadingModal'));
                if (loadingModal) loadingModal.hide();
                alert('Upload failed: ' + error.message);
            }
        }

        // Create collection photo upload options (camera or gallery)
        function createCollectionPhotoUploadInput(collectionName) {
            // Create modal for photo source selection
            const modalHtml = `
                <div class="modal fade" id="collectionPhotoSourceModal" tabindex="-1" aria-labelledby="collectionPhotoSourceModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-sm">
                        <div class="modal-content">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title" id="collectionPhotoSourceModalLabel">Add Collection Photo</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body text-center">
                                <div class="d-grid gap-3">
                                    <button type="button" class="btn btn-primary btn-lg" onclick="takeCollectionPhotoWithCamera('${collectionName}')">
                                        <i class="fas fa-camera"></i> Take Photo
                                    </button>
                                    <button type="button" class="btn btn-secondary btn-lg" onclick="selectCollectionPhotoFromGallery('${collectionName}')">
                                        <i class="fas fa-images"></i> Choose from Gallery
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('collectionPhotoSourceModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('collectionPhotoSourceModal'));
            modal.show();
            
            // Clean up modal after it's hidden
            document.getElementById('collectionPhotoSourceModal').addEventListener('hidden.bs.modal', function() {
                this.remove();
            });
        }

        // Take collection photo with camera
        function takeCollectionPhotoWithCamera(collectionName) {
            // Hide the source selection modal
            const sourceModal = bootstrap.Modal.getInstance(document.getElementById('collectionPhotoSourceModal'));
            if (sourceModal) sourceModal.hide();
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.capture = 'environment'; // Use back camera on mobile
            input.style.display = 'none';
            
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (file) {
                    uploadCollectionPhoto(collectionName, file);
                }
                // Remove the input element
                document.body.removeChild(input);
            };
            
            document.body.appendChild(input);
            input.click();
        }

        // Select collection photo from gallery
        function selectCollectionPhotoFromGallery(collectionName) {
            // Hide the source selection modal
            const sourceModal = bootstrap.Modal.getInstance(document.getElementById('collectionPhotoSourceModal'));
            if (sourceModal) sourceModal.hide();
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.style.display = 'none';
            
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (file) {
                    uploadCollectionPhoto(collectionName, file);
                }
                // Remove the input element
                document.body.removeChild(input);
            };
            
            document.body.appendChild(input);
            input.click();
        }

        // Show collection photo gallery
        async function showCollectionPhotoGallery(element) {
            const collectionName = element.getAttribute('data-collection-name');
            
            try {
                // Get collection photos from database
                const collectionQuery = await db.collection('collections').where('collectionName', '==', collectionName).get();
                let photoUrls = [];
                
                if (!collectionQuery.empty) {
                    const collectionDoc = collectionQuery.docs[0];
                    photoUrls = collectionDoc.data().photoUrls || [];
                }
                
                if (photoUrls.length === 0) {
                    alert('No photos found for this collection.');
                    return;
                }
                
                // Go directly to full-screen gallery starting from first photo
                showCollectionPhotoFullscreen(photoUrls[0], 0, JSON.stringify(photoUrls));
                
            } catch (error) {
                console.error('Error loading collection photos:', error);
                alert('Error loading collection photos: ' + error.message);
            }
        }

        // Show collection photo in fullscreen
        function showCollectionPhotoFullscreen(photoUrl, photoIndex, allPhotoUrls) {
            const photoUrls = JSON.parse(allPhotoUrls);
            if (!photoUrls || photoUrls.length === 0) return;
            
            let currentPhotoIndex = photoIndex;
            
            // Create or show fullscreen modal
            let modal = document.getElementById('collectionPhotoFullscreenModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.className = 'modal fade';
                modal.id = 'collectionPhotoFullscreenModal';
                modal.tabIndex = -1;
                modal.innerHTML = `
                    <div class="modal-dialog modal-fullscreen">
                        <div class="modal-content bg-dark text-white">
                            <div class="modal-header border-0">
                                <h5 class="modal-title">Collection Photos</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body d-flex flex-column align-items-center justify-content-center position-relative" id="collectionPhotoFullscreenContent">
                                <!-- Photo will be shown here -->
                                </div>
                            <div class="modal-footer justify-content-center border-0 bg-dark">
                                <span id="collectionPhotoCounter" class="text-white"></span>
                                <button type="button" class="btn btn-danger ms-3" id="collectionPhotoDeleteBtn">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                        </div>
                    </div>
                </div>
            `;
                document.body.appendChild(modal);
            }
            
            const contentElement = document.getElementById('collectionPhotoFullscreenContent');
            const counter = document.getElementById('collectionPhotoCounter');
            
            function updatePhoto() {
                // Clear the content and add the image
                contentElement.innerHTML = `<img src="${photoUrls[currentPhotoIndex]}" class="img-fluid rounded shadow" style="max-height:80vh;max-width:100vw;object-fit:contain;">`;
                
                // Add back the navigation arrows
                const prevArrow = document.createElement('button');
                prevArrow.type = 'button';
                prevArrow.className = 'btn btn-light position-absolute';
                prevArrow.style = 'left: 20px; top: 50%; transform: translateY(-50%); z-index: 1000; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;';
                prevArrow.innerHTML = '<i class="fas fa-chevron-left"></i>';
                prevArrow.onclick = function() {
                if (currentPhotoIndex > 0) {
                    currentPhotoIndex--;
                        updatePhoto();
                    }
                };
                
                const nextArrow = document.createElement('button');
                nextArrow.type = 'button';
                nextArrow.className = 'btn btn-light position-absolute';
                nextArrow.style = 'right: 20px; top: 50%; transform: translateY(-50%); z-index: 1000; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;';
                nextArrow.innerHTML = '<i class="fas fa-chevron-right"></i>';
                nextArrow.onclick = function() {
                if (currentPhotoIndex < photoUrls.length - 1) {
                    currentPhotoIndex++;
                        updatePhoto();
                    }
                };
                
                contentElement.appendChild(prevArrow);
                contentElement.appendChild(nextArrow);
                
                // Update counter
                counter.textContent = `${currentPhotoIndex + 1} / ${photoUrls.length}`;
                
                // Show/hide arrows based on position
                prevArrow.style.display = currentPhotoIndex === 0 ? 'none' : 'flex';
                nextArrow.style.display = currentPhotoIndex === photoUrls.length - 1 ? 'none' : 'flex';
                
                // Update delete button
                const deleteBtn = document.getElementById('collectionPhotoDeleteBtn');
                if (deleteBtn) {
                    deleteBtn.onclick = function() {
                        deleteCollectionPhoto(currentPhotoIndex, photoUrls[currentPhotoIndex]);
                    };
                }
            }
            
            updatePhoto();
            
            // Show modal
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
        }

        // Delete collection photo function
        async function deleteCollectionPhoto(photoIndex, photoUrl) {
            if (!confirm('Are you sure you want to delete this photo? This action cannot be undone.')) {
                return;
            }

            try {
                console.log('=== COLLECTION PHOTO DELETE STARTED ===');
                console.log('Photo Index:', photoIndex);
                console.log('Photo URL:', photoUrl);

                // Show loading modal
                const loadingModal = new bootstrap.Modal(document.getElementById('photoUploadLoadingModal'));
                loadingModal.show();
                document.getElementById('photoUploadProgress').textContent = 'Deleting photo...';

                // Get the collection name from the current context
                const collectionName = lastViewedCollectionName;
                if (!collectionName) {
                    throw new Error('Collection name not found');
                }

                // Get current photo URLs for this collection
                const collectionDoc = await db.collection('collections').doc(collectionName).get();
                
                if (!collectionDoc.exists) {
                    throw new Error('Collection document not found');
                }
                
                const currentPhotoUrls = collectionDoc.data().photoUrls || [];
                
                // Remove the photo from the array
                const updatedPhotoUrls = currentPhotoUrls.filter((url, index) => index !== photoIndex);
                
                // Update the collection's photoUrls array
                await db.collection('collections').doc(collectionName).update({
                    photoUrls: updatedPhotoUrls
                });

                // Try to delete from Firebase Storage (optional - may fail if file doesn't exist)
                try {
                    console.log('Original photo URL:', photoUrl);
                    
                    // Extract the full path from the Firebase Storage URL
                    // URL format: https://firebasestorage.googleapis.com/v0/b/project-id/o/Collection%20Photo%2Ffilename.jpg?alt=media&token=...
                    const urlParts = photoUrl.split('/');
                    const encodedPath = urlParts[urlParts.length - 1].split('?')[0]; // Get the encoded path
                    const decodedPath = decodeURIComponent(encodedPath); // Decode the URL encoding
                    console.log('Attempting to delete from storage path:', decodedPath);
                    
                    const photoRef = storage.ref().child(decodedPath);
                    console.log('Storage reference:', photoRef.toString());
                    
                    await photoRef.delete();
                    console.log('Photo deleted from storage successfully:', decodedPath);
                } catch (storageError) {
                    console.warn('Could not delete from storage (file may not exist):', storageError);
                    console.warn('Storage error details:', storageError.message);
                    console.warn('Storage error code:', storageError.code);
                }

                console.log('=== COLLECTION PHOTO DELETE COMPLETED ===');
                loadingModal.hide();
                alert('Photo deleted successfully!');

                // Close the photo gallery modal
                const galleryModal = bootstrap.Modal.getInstance(document.getElementById('collectionPhotoFullscreenModal'));
                if (galleryModal) galleryModal.hide();

                // Refresh the current view and update button counts
                if (lastViewedCollectionName) {
                    showMyToolsByCollection(lastViewedCollectionName);
                }
                await updateCollectionPhotoButtonCounts();

            } catch (error) {
                console.error('=== COLLECTION PHOTO DELETE FAILED ===', error);
                const loadingModal = bootstrap.Modal.getInstance(document.getElementById('photoUploadLoadingModal'));
                if (loadingModal) loadingModal.hide();
                alert('Delete failed: ' + error.message);
            }
        }

      

    // In script section, after document.getElementById('checkupHistoryBtn').onclick ...
    document.getElementById('checkupHistoryBtn').onclick = function() {
      showCheckupHistoryScreen();
    };

    function showCheckupHistoryScreen() {
      // Hide all other main screens
      document.getElementById('toolScannerMenu').style.display = 'none';
      document.getElementById('appSection').style.display = 'none';
      document.getElementById('myToolsScreen').style.display = 'none';
      document.getElementById('myToolsByCollectionScreen').style.display = 'none';
      document.getElementById('collectionCheckupScreen').style.display = 'none';
      document.getElementById('checkupHistoryScreen').style.display = 'block';
      // Set technician name
      const user = auth.currentUser;
      const fullName = localStorage.getItem('fullName') || (user ? user.email : '');
      document.getElementById('checkupHistoryTechName').textContent = fullName;
      // Load history
      loadCheckupHistory();
    }

    document.getElementById('checkupHistoryBackBtn').onclick = function() {
      document.getElementById('checkupHistoryScreen').style.display = 'none';
      document.getElementById('collectionCheckupScreen').style.display = 'block';
    };

    document.getElementById('checkupHistoryRefreshBtn').onclick = function() {
      loadCheckupHistory();
    };

    document.getElementById('checkupHistoryCleanupBtn').onclick = function() {
      cleanupOldCheckupHistory();
    };

    document.getElementById('checkupHistorySearch').oninput = function() {
      renderCheckupHistoryList(window._checkupHistoryRaw || []);
    };
    document.getElementById('checkupHistoryCollectionFilter').onchange = function() {
      renderCheckupHistoryList(window._checkupHistoryRaw || []);
    };

    async function loadCheckupHistory() {
      const user = auth.currentUser;
      if (!user) return;
      const fullName = localStorage.getItem('fullName') || user.email;
      const listDiv = document.getElementById('checkupHistoryList');
      listDiv.innerHTML = '<div class="text-center">Loading...</div>';
      try {
        const snap = await db.collection('checkupResults')
          .where('technicianName', '==', fullName)
          .orderBy('timestamp', 'desc')
          .get();
        const records = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        window._checkupHistoryRaw = records;
        // Populate collection filter
        const collections = Array.from(new Set(records.map(r => r.collectionCode || 'All')));
        const filter = document.getElementById('checkupHistoryCollectionFilter');
        filter.innerHTML = '<option value="All">All</option>' + collections.map(c => `<option value="${c}">${c}</option>`).join('');
        renderCheckupHistoryList(records);
      } catch (e) {
        listDiv.innerHTML = `<div class='text-danger text-center'>Error loading history: ${e.message}</div>`;
      }
    }

    function renderCheckupHistoryList(records) {
      const search = document.getElementById('checkupHistorySearch').value.trim().toLowerCase();
      const filter = document.getElementById('checkupHistoryCollectionFilter').value;
      let filtered = records;
      if (filter && filter !== 'All') {
        filtered = filtered.filter(r => (r.collectionCode || 'All') === filter);
      }
      if (search) {
        filtered = filtered.filter(r =>
          (r.collectionCode || '').toLowerCase().includes(search) ||
          (r.checkupDate || '').toLowerCase().includes(search)
        );
      }
      const listDiv = document.getElementById('checkupHistoryList');
      if (!filtered.length) {
        listDiv.innerHTML = '<div class="text-center text-muted">No checkup history found.</div>';
        return;
      }
      let html = '';
      filtered.forEach(r => {
        const checked = r.checkedTools || 0;
        const total = r.totalTools || 0;
        const isAll = (r.collectionCode || '').toLowerCase().includes('all');
        html += `<div style="background:#fff;border-radius:16px;padding:16px 12px;margin-bottom:16px;box-shadow:0 2px 4px rgba(0,0,0,0.07);border:1px solid #ddd;">
          <div style="font-size:1.15em;font-weight:bold;color:#000;">${r.checkupDate || 'Unknown'}</div>
          <div style="color:#888;font-size:1.05em;">Collection: <span style="color:${isAll ? '#888' : '#FF9800'};font-weight:bold;">${r.collectionCode || 'All Collections'}</span></div>
          <div style="font-size:1.1em;font-weight:bold;color:${checked===total?'#388E3C':'#388E3C'};float:right;">${checked}/${total} <span style="font-weight:normal;color:#888;font-size:0.95em;">Tools Checked</span></div>
          <hr style="margin:8px 0;">
          <div class="d-flex justify-content-between align-items-center">
            <a href="#" style="color:#1976d2;font-weight:bold;font-size:1.1em;" onclick="event.preventDefault();showCheckupDetails('${r.id}')">View Details</a>
            <a href="#" style="color:#f44336;font-weight:bold;font-size:1.1em;" onclick="event.preventDefault();deleteCheckupHistoryRecord('${r.id}')">Delete</a>
          </div>
        </div>`;
      });
      listDiv.innerHTML = html;
    }

    async function deleteCheckupHistoryRecord(id) {
      if (!confirm('Delete this checkup record?')) return;
      try {
        await db.collection('checkupResults').doc(id).delete();
        loadCheckupHistory();
      } catch (e) {
        alert('Error deleting record: ' + e.message);
      }
    }

    async function cleanupOldCheckupHistory() {
      if (!confirm('Delete all checkup records older than 1 month?')) return;
      const user = auth.currentUser;
      if (!user) return;
      const fullName = localStorage.getItem('fullName') || user.email;
      const cutoff = new Date();
      cutoff.setMonth(cutoff.getMonth() - 1);
      try {
        const snap = await db.collection('checkupResults')
          .where('technicianName', '==', fullName)
          .where('timestamp', '<', cutoff)
          .get();
        const batch = db.batch();
        snap.docs.forEach(doc => batch.delete(doc.ref));
        await batch.commit();
        loadCheckupHistory();
      } catch (e) {
        alert('Error cleaning up: ' + e.message);
      }
    }


    // Add the showCheckupDetails function to the script:
    function showCheckupDetails(id) {
      const record = (window._checkupHistoryRaw || []).find(r => r.id === id);
      if (!record) {
        alert('Checkup record not found.');
        return;
      }

      // Show loading state
      document.getElementById('checkupDetailsContent').innerHTML = '<div class="text-center">Loading...</div>';
      const modal = new bootstrap.Modal(document.getElementById('checkupDetailsModal'));
      modal.show();

      // Get unchecked tool IDs
      const checked = record.checkedToolIds || [];
      const all = record.allToolIds || [];
      const unchecked = all.filter(id => !checked.includes(id));

      // Fetch tool details for unchecked tools and all tools (for location stats)
      (async () => {
        let missingTools = [];
        let allTools = [];
        if (all.length > 0) {
          const dbTools = firebase.firestore().collection('tools');
          for (let i = 0; i < all.length; i += 10) {
            const batch = all.slice(i, i + 10);
            const snap = await dbTools.where(firebase.firestore.FieldPath.documentId(), 'in', batch).get();
            allTools = allTools.concat(snap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
          }
        }
        if (unchecked.length > 0) {
          // Batch Firestore gets (max 10 per batch)
          const dbTools = firebase.firestore().collection('tools');
          for (let i = 0; i < unchecked.length; i += 10) {
            const batch = unchecked.slice(i, i + 10);
            const snap = await dbTools.where(firebase.firestore.FieldPath.documentId(), 'in', batch).get();
            missingTools = missingTools.concat(snap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
          }
        }

        // Group all tools by location for stats
        const allByLocation = {};
        allTools.forEach(tool => {
          const loc = tool.location || 'Unknown';
          if (!allByLocation[loc]) allByLocation[loc] = [];
          allByLocation[loc].push(tool);
        });
        // Group missing tools by location
        const missingByLocation = {};
        missingTools.forEach(tool => {
          const loc = tool.location || 'Unknown';
          if (!missingByLocation[loc]) missingByLocation[loc] = [];
          missingByLocation[loc].push(tool);
        });
        // Group checked tools by location for stats
        const checkedSet = new Set(checked);
        const checkedByLocation = {};
        allTools.forEach(tool => {
          if (checkedSet.has(tool.id)) {
            const loc = tool.location || 'Unknown';
            if (!checkedByLocation[loc]) checkedByLocation[loc] = [];
            checkedByLocation[loc].push(tool);
          }
        });

        // Build HTML
        let html = `
          <div style="font-size:1.3em;font-weight:bold;margin-bottom:10px;">
            <span style="background:#f8f8f8;padding:8px 18px;border-radius:12px;display:inline-block;">
              Checked: ${checked.length}<br>Unchecked: ${unchecked.length}
            </span>
          </div>
        `;

        if (Object.keys(allByLocation).length > 0) {
          // Sort locations alphabetically
          const sortedLocs = Object.keys(allByLocation).sort((a, b) => a.localeCompare(b, undefined, {numeric: true, sensitivity: 'base'}));
          html += `<style>
            .expand-arrow { display:inline-block; transition:transform 0.2s; font-size:1.2em; margin-right:6px; }
            .expand-arrow.open { transform:rotate(90deg); }
            .location-summary-card { cursor:pointer; }
            .missing-tools-section { display:none; }
            .missing-tools-section.open { display:block; }
          </style>`;
          sortedLocs.forEach((loc, idx) => {
            const total = allByLocation[loc].length;
            const checkedCount = checkedByLocation[loc] ? checkedByLocation[loc].length : 0;
            const uncheckedCount = total - checkedCount;
            const hasMissing = missingByLocation[loc] && missingByLocation[loc].length > 0;
            const sectionId = `missingToolsSection_${id.replace(/[^a-zA-Z0-9]/g, '')}_${idx}`;
            const arrowId = `expandArrow_${id.replace(/[^a-zA-Z0-9]/g, '')}_${idx}`;
            html += `
              <div class="location-summary-card" onclick="toggleMissingToolsSection('${sectionId}', '${arrowId}')" style="background:#e3f2fd;border-radius:14px;padding:10px 12px 8px 12px;margin-bottom:8px;">
                <span id="${arrowId}" class="expand-arrow">&#9654;</span>
                <span style="font-weight:bold;color:#1976d2;font-size:1.1em;">${loc}</span>
                <div style="color:#333;font-size:1.0em;">Total: ${total} &nbsp; Checked: ${checkedCount} &nbsp; Unchecked: ${uncheckedCount}</div>
              </div>
            `;
            // Always show the section, but only fill it if there are missing tools
            html += `<div id="${sectionId}" class="missing-tools-section" style="margin-bottom:12px;">`;
            if (hasMissing) {
              html += `<div style=\"color:#d32f2f;font-weight:bold;font-size:1.1em;margin:8px 0 4px 0;\">Missing Tools (Not Checked):</div>`;
              missingByLocation[loc].forEach(tool => {
                html += `
                  <div style="background:#ffebee;border-radius:10px;padding:10px 12px;margin-bottom:8px;">
                    <div style="color:#d32f2f;font-weight:bold;font-size:1.15em;line-height:1.2;">
                      <span style="font-size:1.2em;">&#9888;</span> ${tool.toolName || tool.id}
                    </div>
                    <div style="color:#888;font-size:1em;margin-top:4px;">
                      Part #: ${tool.partNumber || tool.id}<br>
                      Location: ${tool.location || 'Unknown'}<br>
                      Status: ${tool.status || 'N/A'}
                    </div>
                  </div>
                `;
              });
            } else {
              html += `<div style=\"color:#388e3c;font-size:1em;margin:8px 0 4px 0;\">No missing tools in this location.</div>`;
            }
            html += `</div>`;
          });
        } else {
          html += `<div class=\"text-success\" style=\"font-weight:bold;font-size:1.1em;\">All tools checked!</div>`;
        }

        // Add the toggleMissingToolsSection function to window
        window.toggleMissingToolsSection = function(sectionId, arrowId) {
          var section = document.getElementById(sectionId);
          var arrow = document.getElementById(arrowId);
          if (section) {
            var isOpen = section.classList.contains('open');
            if (isOpen) {
              section.classList.remove('open');
              if (arrow) arrow.classList.remove('open');
            } else {
              section.classList.add('open');
              if (arrow) arrow.classList.add('open');
            }
          }
        };

        document.getElementById('checkupDetailsContent').innerHTML = html;
      })();
    }

    

    </script>

    <script>
    // Sync offline tools when back online
    async function syncOfflineTools() {
        try {
            const offlineTools = await getOfflineTools();
            
            if (offlineTools.length === 0) {
                console.log('No offline tools to sync');
                return;
            }
            
            console.log(`Syncing ${offlineTools.length} offline tools`);
            
            for (const tool of offlineTools) {
                try {
                    // Add tool to Firestore
                    await db.collection('tools').doc(tool.id).set(tool.data);
                    
                    // Remove from offline storage
                    await removeOfflineTool(tool.id);
                    
                    console.log(`Successfully synced tool: ${tool.id}`);
                } catch (error) {
                    console.error(`Failed to sync tool ${tool.id}:`, error);
                }
            }
            
            // Refresh the tool list
            loadTools();
            
            // Show success message
            showNotification(`Successfully synced ${offlineTools.length} offline tools`, 'success');
            
        } catch (error) {
            console.error('Error syncing offline tools:', error);
            showNotification('Error syncing offline tools', 'error');
        }
    }
    
    // Check online status and update UI
    function updateOnlineStatus() {
        isOnline = navigator.onLine;
        const statusElement = document.getElementById('onlineStatus');
        
        if (statusElement) {
            if (isOnline) {
                statusElement.className = 'status-dot';
                // Trigger sync when back online
                syncOfflineTools();
            } else {
                statusElement.className = 'status-dot offline';
            }
        }
    }
    
    // Enhanced notification function
    function showNotification(message, type = 'info') {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info'} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        // Insert at the top of the app section
        const appSection = document.getElementById('appSection');
        if (appSection) {
            appSection.insertBefore(alertDiv, appSection.firstChild);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }
    }
    
            // Handle offline tool submission
        async function handleOfflineToolSubmission(code, user) {
            try {
                // Get technician name
                const technicianName = localStorage.getItem('fullName') || user.email || 'Unknown Technician';
                
                // Create tool data for offline storage
                const toolData = {
                    id: code,
                    data: {
                        toolName: `Tool ${code}`,
                        partNumber: code,
                        technician: technicianName,
                        owner: technicianName,
                        status: 'OUT',
                        timestamp: new Date(),
                        WorkOn: selectedWorkLocation || 'Unknown',
                        collectionCode: 'DEFAULT',
                        collectionName: 'Default Collection',
                        isOfflineSubmission: true
                    }
                };
                
                // Save to offline storage
                await saveToolOffline(toolData);
                
                // Show success message
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-warning alert-dismissible fade show`;
                alertDiv.innerHTML = `
                    <i class="fas fa-wifi-slash me-2"></i>
                    Tool saved offline. Will sync when connection is restored.
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                
                const scannerView = document.getElementById('scannerView');
                scannerView.insertBefore(alertDiv, scannerView.firstChild);
                
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.remove();
                    }
                }, 5000);
                
                // Clear input
                document.getElementById('toolCode').value = '';
                document.getElementById('toolDetailsBtn').disabled = true;
                
                // Load tools to show in the list (including offline)
                loadTools();
                
            } catch (error) {
                console.error('Error handling offline tool submission:', error);
                showNotification('Error saving tool offline', 'error');
            }
        }
        


            // IndexedDB operations for offline storage

    async function initIndexedDB() {
        return new Promise((resolve, reject) => {
            const request = window.indexedDB.open('ToolTrackingDB', 1);
            
            request.onerror = () => reject(request.error);
            request.onsuccess = () => {
                indexedDB = request.result;
                resolve(indexedDB);
            };
            
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains('offlineTools')) {
                    db.createObjectStore('offlineTools', { keyPath: 'id' });
                }
            };
        });
    }

    async function getOfflineTools() {
        return new Promise((resolve, reject) => {
            if (!indexedDB) {
                resolve([]);
                return;
            }
            
            const transaction = indexedDB.transaction(['offlineTools'], 'readonly');
            const store = transaction.objectStore('offlineTools');
            const getAllRequest = store.getAll();
            
            getAllRequest.onsuccess = () => resolve(getAllRequest.result);
            getAllRequest.onerror = () => reject(getAllRequest.error);
        });
    }

    async function saveToolOffline(toolData) {
        return new Promise((resolve, reject) => {
            if (!indexedDB) {
                reject(new Error('Database not initialized'));
                return;
            }
            
            const transaction = indexedDB.transaction(['offlineTools'], 'readwrite');
            const store = transaction.objectStore('offlineTools');
            const addRequest = store.put(toolData);
            
            addRequest.onsuccess = () => resolve();
            addRequest.onerror = () => reject(addRequest.error);
        });
    }

    async function removeOfflineTool(toolId) {
        return new Promise((resolve, reject) => {
            if (!indexedDB) {
                resolve();
                return;
            }
            
            const transaction = indexedDB.transaction(['offlineTools'], 'readwrite');
            const store = transaction.objectStore('offlineTools');
            const deleteRequest = store.delete(toolId);
            
            deleteRequest.onsuccess = () => resolve();
            deleteRequest.onerror = () => reject(deleteRequest.error);
        });
    }

    // Initialize offline functionality
    document.addEventListener('DOMContentLoaded', async function() {
        // Initialize IndexedDB
        await initIndexedDB();
        
        // Set up online/offline event listeners
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        
        // Initial status check
        updateOnlineStatus();
        
        // Register service worker
        if ('serviceWorker' in navigator) {
            try {
                const registration = await navigator.serviceWorker.register('/service-worker.js');
                console.log('Service Worker registered:', registration);
                
                // Listen for messages from service worker
                navigator.serviceWorker.addEventListener('message', event => {
                    if (event.data.type === 'OFFLINE_SYNC_COMPLETE') {
                        showNotification(`Synced ${event.data.syncedCount} offline tools`, 'success');
                    }
                });
                
            } catch (error) {
                console.error('Service Worker registration failed:', error);
            }
        }
    });
    </script>
</body>
</html> 
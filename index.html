<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tool Tracking</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#FF9800">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <style>
        .tool-out { color: red; font-weight: bold; }
        .tool-in { color: green; }
        .hidden { display: none; }
        
        /* Orange Button Styles with Shadow Floating Effect */
        .btn-primary {
            background-color: #FF9800 !important;
            border-color: #FF9800 !important;
            color: white !important;
            font-weight: bold;
            border-radius: 24px !important;
            padding: 12px 24px !important;
            box-shadow: 0 4px 8px rgba(255, 152, 0, 0.3);
            transition: all 0.3s ease;
            border: none;
        }
        
        .btn-primary:hover {
            background-color: #F57C00 !important;
            border-color: #F57C00 !important;
            color: white !important;
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(255, 152, 0, 0.4);
        }
        
        .btn-primary:active {
            transform: translateY(-1px);
            box-shadow: 0 6px 12px rgba(255, 152, 0, 0.4);
        }
        
        .btn-warning {
            background-color: #FF9800 !important;
            border-color: #FF9800 !important;
            color: white !important;
            font-weight: bold;
            border-radius: 24px !important;
            padding: 12px 24px !important;
            box-shadow: 0 4px 8px rgba(255, 152, 0, 0.3);
            transition: all 0.3s ease;
            border: none;
        }
        
        .btn-warning:hover {
            background-color: #F57C00 !important;
            border-color: #F57C00 !important;
            color: white !important;
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(255, 152, 0, 0.4);
        }
        
        .btn-warning:active {
            transform: translateY(-1px);
            box-shadow: 0 6px 12px rgba(255, 152, 0, 0.4);
        }
        
        /* Form label styles */
        .form-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 0.5rem;
        }
        
        /* Forgot password link styles */
        #forgotPasswordLink {
            color: #FF9800;
            font-weight: 500;
            text-decoration: none;
            transition: color 0.3s ease;
        }
        
        #forgotPasswordLink:hover {
            color: #F57C00;
            text-decoration: underline;
        }
        
        /* ToolScanner Menu Button Styles with Shadow Floating Effect */
        .btn-success {
            background-color: #4CAF50 !important;
            border-color: #4CAF50 !important;
            color: white !important;
            font-weight: bold;
            border-radius: 24px !important;
            padding: 12px 24px !important;
            box-shadow: 0 4px 8px rgba(76, 175, 80, 0.3);
            transition: all 0.3s ease;
            border: none;
        }
        
        .btn-success:hover {
            background-color: #45a049 !important;
            border-color: #45a049 !important;
            color: white !important;
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(76, 175, 80, 0.4);
        }
        
        .btn-success:active {
            transform: translateY(-1px);
            box-shadow: 0 6px 12px rgba(76, 175, 80, 0.4);
        }
        
        .btn-danger {
            background-color: #f44336 !important;
            border-color: #f44336 !important;
            color: white !important;
            font-weight: bold;
            border-radius: 24px !important;
            padding: 12px 24px !important;
            box-shadow: 0 4px 8px rgba(244, 67, 54, 0.3);
            transition: all 0.3s ease;
            border: none;
        }
        
        .btn-danger:hover {
            background-color: #da190b !important;
            border-color: #da190b !important;
            color: white !important;
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(244, 67, 54, 0.4);
        }
        
        .btn-danger:active {
            transform: translateY(-1px);
            box-shadow: 0 6px 12px rgba(244, 67, 54, 0.4);
        }
        
        .btn-secondary {
            background-color: #6c757d !important;
            border-color: #6c757d !important;
            color: white !important;
            font-weight: bold;
            border-radius: 24px !important;
            padding: 12px 24px !important;
            box-shadow: 0 4px 8px rgba(108, 117, 125, 0.3);
            transition: all 0.3s ease;
            border: none;
        }
        
        .btn-secondary:hover {
            background-color: #5a6268 !important;
            border-color: #5a6268 !important;
            color: white !important;
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(108, 117, 125, 0.4);
        }
        
        .btn-secondary:active {
            transform: translateY(-1px);
            box-shadow: 0 6px 12px rgba(108, 117, 125, 0.4);
        }
        
        .camera-view {
            width: 100%;
            max-width: 320px;
            margin: 10px auto;
        }
        #reader {
            border: 1px solid #ccc !important;
            width: 100% !important;
            max-width: 320px;
            aspect-ratio: 1/1 !important; /* Make the reader square */
            overflow: hidden !important;
        }
        #reader video {
            object-fit: cover !important;
            width: 100% !important;
            height: 100% !important;
        }
        .tool-item {
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 8px;
            transition: background-color 0.3s ease;
        }
        .tool-item:hover {
            background-color: #f8f9fa;
        }
        .tool-out-even {
            background-color: #FFF3E0; /* Very light orange */
        }
        .tool-out-odd {
            background-color: #FFE0B2; /* Light orange */
        }
        .tool-in-even {
            background-color: #E8F5E9; /* Very light green */
        }
        .tool-in-odd {
            background-color: #A5D6A7; /* Light green */
        }
        .nav-tabs {
            margin-bottom: 20px;
        }
        #scannerView {
            text-align: center;
        }
        .btn-scan {
            margin: 10px 0;
        }
        .status-badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 18px;
        }
        .status-out {
            background-color: #ffebee;
            color: #d32f2f;
        }
        .status-in {
            background-color: #e8f5e9;
            color: #388E3C;
        }
        .status-broken {
            background-color: #fff3e0;
            color: #ff6f00;
        }
        .status-lost {
            background-color: #ffe0b2;
            color: #ff8f00;
        }
        .status-calibration {
            background-color: #e3f2fd;
            color: #1976d2;
        }
        .tool-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            text-decoration: underline;
        }
        .tool-name {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 5px;
            padding-left: 15px;
            text-align: left;
        }
        .tool-time {
            font-size: 16px;
            color: #666;
            margin-bottom: 10px;
            padding-left: 15px;
            text-align: left;
        }
        .tool-headers {
            color: #388E3C;
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 5px;
        }
        .tool-values {
            font-size: 16px;
        }
        .tool-out-text {
            color: #d32f2f;
        }
        .tool-in-text {
            color: #000;
        }
        .tool-id-value {
            font-weight: bold;
        }
        .tool-pn-value {
            font-weight: bold;
        }
        .mytools-title {
            color: orange; font-weight: bold; font-size: 2.2rem; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 0.5rem;
        }
        .mytools-back {
            background: orange; color: white; font-weight: bold; border: none; border-radius: 6px; padding: 8px 24px; font-size: 1.2rem; margin-bottom: 1rem;
        }
        .mytools-collection {
            background: orange; color: white; font-weight: bold; font-size: 1.2rem; border-radius: 6px 6px 0 0; padding: 6px 12px; display: flex; justify-content: space-between; align-items: center; margin-top: 1.5rem;
        }
        .mytools-location {
            background: #cbe7ff; color: #222; font-weight: bold; font-size: 1.1rem; border-radius: 0 0 6px 6px; padding: 6px 12px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;
        }
        .mytools-tool-item {
            padding: 12px 12px 8px 12px; border-radius: 0 0 6px 6px; margin-bottom: 0.5rem; font-size: 1.08rem;
        }
        .mytools-tool-bg1 { background: #fff; }
        .mytools-tool-bg2 { background: #fff7e6; }
        .mytools-tool-name { font-weight: bold; font-size: 1.13rem; }
        .mytools-tool-tid { font-weight: bold; }
        .mytools-tool-part { font-size: 1.01rem; color: #444; }
        .mytools-status-in { color: #388E3C; font-weight: bold; font-size: 1.05rem; }
        .mytools-status-out { color: #d32f2f; font-weight: bold; font-size: 1.05rem; }
        .mytools-status-broken { color: #ff6f00; font-weight: bold; font-size: 1.05rem; }
        .mytools-status-lost { color: #ff8f00; font-weight: bold; font-size: 1.05rem; }
        .mytools-status-calibration { color: #1976d2; font-weight: bold; font-size: 1.05rem; }
        .mytools-tool-extra { font-size: 1.01rem; color: #222; margin-top: 2px; }
        .mytools-tool-cal { color: #388E3C; font-size: 1.01rem; margin-top: 2px; }
        .ams-title {
            color: orange;
            font-weight: bold;
            font-size: 2.5rem;
            text-align: center;
            margin-bottom: 0.5rem;
            letter-spacing: 2px;
            text-transform: uppercase;
        }
        .ams-logo {
            display: block;
            margin: 0.5rem auto 1.2rem auto;
            max-width: 180px;
            height: auto;
        }
        .ams-subtitle {
            color: #00bfff;
            font-weight: bold;
            font-size: 2rem;
            text-align: center;
            margin-bottom: 0.2rem;
            letter-spacing: 1px;
        }
        .auth-container {
            margin-top: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem 1rem 0 1rem;
        }
        .auth-card {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
        }
        .technician-name {
            color: #00bfff;
            font-weight: bold;
        }
        
        /* Previous OUT Tools Card Styles - matching Android ToolCard */
        .previous-out-tool-card {
            background: #FFCDD2; /* Light red for OUT status */
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        
        .previous-out-tool-card:hover {
            background: #FFB3BA; /* Slightly darker red on hover */
        }
        
        .previous-out-tool-name {
            font-weight: bold;
            font-size: 16px;
            color: #000;
            margin-bottom: 4px;
        }
        
        .previous-out-tool-date {
            font-size: 12px;
            color: #666;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .previous-out-tool-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .previous-out-tool-column {
            flex: 1;
            text-align: center;
        }
        
        .previous-out-tool-column:first-child {
            text-align: left;
        }
        
        .previous-out-tool-column:last-child {
            text-align: right;
        }
        
        .previous-out-tool-label {
            color: #000;
            font-weight: bold;
            font-size: 14px;
            text-decoration: underline;
            margin-bottom: 4px;
        }
        
        .previous-out-tool-value {
            color: #666;
            font-weight: bold;
            font-size: 12px;
        }
        
        .previous-out-tool-status {
            color: #fff;
            font-weight: bold;
            font-size: 14px;
            background: rgba(229, 115, 115, 0.8); /* Red background for OUT status */
            border-radius: 16px;
            padding: 4px 12px;
            display: inline-block;
        }
        
        /* Status colors for different tool statuses */
        .previous-out-tool-card.broken {
            background: #FFF3E0; /* Light orange for BROKEN */
        }
        
        .previous-out-tool-card.broken:hover {
            background: #FFE0B2;
        }
        
        .previous-out-tool-card.broken .previous-out-tool-status {
            background: rgba(255, 152, 0, 0.8); /* Orange background */
        }
        
        .previous-out-tool-card.lost {
            background: #FFE0B2; /* Light amber for LOST */
        }
        
        .previous-out-tool-card.lost:hover {
            background: #FFCC80;
        }
        
        .previous-out-tool-card.lost .previous-out-tool-status {
            background: rgba(255, 179, 0, 0.8); /* Amber background */
        }
        
        .previous-out-tool-card.calibration {
            background: #E3F2FD; /* Light blue for CALIBRATION */
        }
        
        .previous-out-tool-card.calibration:hover {
            background: #BBDEFB;
        }
        
        .previous-out-tool-card.calibration .previous-out-tool-status {
            background: rgba(33, 150, 243, 0.8); /* Blue background */
        }
        
        .previous-out-tool-card.in {
            background: #E8F5E9; /* Light green for IN */
        }
        
        .previous-out-tool-card.in:hover {
            background: #C8E6C9;
        }
        
        .previous-out-tool-card.in .previous-out-tool-status {
            background: rgba(76, 175, 80, 0.8); /* Green background */
        }

        .register-tool-card {
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .register-tool-card.out { background: #FFCDD2; }
        .register-tool-card.broken { background: #FFF3E0; }
        .register-tool-card.lost { background: #FFE0B2; }
        .register-tool-card.calibration { background: #E3F2FD; }
        .register-tool-card.in { background: #E8F5E9; }
        .register-tool-title {
            font-weight: bold;
            font-size: 18px;
            color: #000;
            margin-bottom: 4px;
            text-align: left;
        }
        .register-tool-date {
            font-size: 14px;
            color: #666;
            font-weight: bold;
            margin-bottom: 8px;
            text-align: left;
        }
        .register-tool-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        .register-tool-col {
            flex: 1;
            text-align: center;
        }
        .register-tool-col:first-child { text-align: left; }
        .register-tool-col:last-child { text-align: right; }
        .register-tool-label {
            color: #000;
            font-weight: bold;
            font-size: 14px;
            text-decoration: underline;
            margin-bottom: 4px;
        }
        .register-tool-value {
            color: #666;
            font-weight: bold;
            font-size: 14px;
        }
        .register-tool-status {
            color: #fff;
            font-weight: bold;
            font-size: 14px;
            border-radius: 16px;
            padding: 4px 12px;
            display: inline-block;
        }
        .register-tool-status.out { background: rgba(229, 115, 115, 0.8); }
        .register-tool-status.broken { background: rgba(255, 152, 0, 0.8); }
        .register-tool-status.lost { background: rgba(255, 179, 0, 0.8); }
        .register-tool-status.calibration { background: rgba(33, 150, 243, 0.8); }
        .register-tool-status.in { background: rgba(76, 175, 80, 0.8); }
        
        /* Scanner expansion styles */
        .scanner-container {
            transition: all 0.3s ease;
        }
        
        .scanner-container.expanded {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 9999;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .scanner-container.expanded .card {
            max-width: 90vw;
            max-height: 90vh;
            width: 100%;
        }
        
        .scanner-container.expanded #reader {
            width: 100% !important;
            max-width: 500px !important;
            height: auto !important;
            aspect-ratio: 1/1 !important;
        }
        
        .scanner-container.expanded #reader video {
            width: 100% !important;
            height: 100% !important;
            object-fit: cover !important;
        }
        
        .scanner-overlay {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 10000;
        }

        @media (max-width: 600px) {
            .d-grid.col-6.mx-auto {
                max-width: 100% !important;
                width: 100% !important;
            }
            .d-grid.col-6.mx-auto button {
                width: 100% !important;
                min-width: 100% !important;
                font-size: 1.2em;
                padding: 18px 0 !important;
            }
            
            /* Mobile-specific modal styling */
            .modal-dialog {
                margin: 10px;
                max-width: calc(100% - 20px);
            }
            
            .modal-body {
                font-size: 1.1em;
                line-height: 1.5;
            }
            
            .modal-title {
                font-size: 1.3em;
            }
            
            .modal-footer .btn {
                font-size: 1.1em;
                padding: 10px 20px;
            }
        }
        
        /* Ensure consistent font sizes across all devices */
        .modal-body div[style*="font-size: 1.1em"] {
            line-height: 1.6;
            margin-bottom: 12px;
        }
        
        .modal-body strong {
            font-weight: 600;
            color: #333;
        }
        
        /* Ensure strong tags remain bold on mobile devices */
        @media (max-width: 600px) {
            .modal-body strong {
                font-weight: 600 !important;
                color: #333 !important;
            }
            
            .modal-body div strong {
                font-weight: 600 !important;
            }
        }
    </style>
</head>
<body>
    <div id="headerBranding">
        <h1 class="ams-title">AMS SQUADRON</h1>
        <div class="ams-subtitle">Tool Tracking</div>
        <img src="ams_logo.png" alt="AMS Squadron Logo" class="ams-logo">
    </div>
    <div class="container">
        <!-- Login Section -->
        <div id="loginSection" class="auth-container">
            <div class="card auth-card">
                <div class="card-body">
                    <div id="loginAlert" class="alert alert-danger d-none" role="alert"></div>
                    <div class="mb-3">
                        <label for="loginEmail" class="form-label">Email</label>
                        <input type="email" id="loginEmail" class="form-control" required autocomplete="username">
                    </div>
                    <div class="mb-1">
                        <label for="loginPassword" class="form-label">Password</label>
                        <div class="input-group">
                            <input type="password" id="loginPassword" class="form-control" required autocomplete="current-password">
                            <button class="btn btn-outline-secondary" type="button" id="toggleLoginPassword" tabindex="-1">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    </div>
                    <div class="d-flex justify-content-end mb-2">
                        <a href="#" id="forgotPasswordLink">Forgot my password?</a>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="keepSignedIn">
                        <label class="form-check-label" for="keepSignedIn">Keep me signed in</label>
                    </div>
                    <button onclick="login()" class="btn btn-primary w-100 mb-3" id="loginBtn">
                        <span class="btn-text">Login</span>
                        <span class="btn-loading d-none">
                            <span class="spinner-border spinner-border-sm me-2"></span>Loading...
                        </span>
                    </button>
                    <button onclick="showSignUp()" class="btn btn-primary w-100 mb-3">CREATE ACCOUNT</button>
                    <button onclick="showAdminLogin()" class="btn btn-warning w-100">Tool Admin</button>
                </div>
            </div>
        </div>

        <!-- Sign Up Section -->
        <div id="signUpSection" class="auth-container d-none">
            <div class="card auth-card">
                <div class="card-body">
                    <!-- Back button -->
                    <div class="text-center mb-3">
                        <button onclick="showLogin()" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left"></i> Back to Login
                        </button>
                    </div>
                    
                    <div id="signUpAlert" class="alert alert-danger d-none" role="alert"></div>
                    
                    <div class="mb-3">
                        <label for="signUpFullName" class="form-label">Full Name</label>
                        <input type="text" id="signUpFullName" class="form-control" required autocomplete="name">
                    </div>
                    
                    <div class="mb-3">
                        <label for="signUpEmail" class="form-label">Email</label>
                        <input type="email" id="signUpEmail" class="form-control" required autocomplete="username">
                    </div>
                    
                    <div class="mb-3">
                        <label for="signUpPassword" class="form-label">Password</label>
                        <div class="input-group">
                            <input type="password" id="signUpPassword" class="form-control" required autocomplete="new-password">
                            <button class="btn btn-outline-secondary" type="button" id="toggleSignUpPassword" tabindex="-1">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="signUpConfirmPassword" class="form-label">Confirm Password</label>
                        <div class="input-group">
                            <input type="password" id="signUpConfirmPassword" class="form-control" required autocomplete="new-password">
                            <button class="btn btn-outline-secondary" type="button" id="toggleSignUpConfirmPassword" tabindex="-1">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    </div>
                    
                    <button onclick="signUp()" class="btn btn-primary w-100 mb-3" id="signUpBtn">
                        <span class="btn-text">CREATE ACCOUNT</span>
                        <span class="btn-loading d-none">
                            <span class="spinner-border spinner-border-sm me-2"></span>Loading...
                        </span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Forgot Password Modal -->
        <div class="modal fade" id="forgotPasswordModal" tabindex="-1" aria-labelledby="forgotPasswordModalLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="forgotPasswordModalLabel">Reset Password</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <input type="email" id="resetEmail" class="form-control mb-2" placeholder="Enter your email">
                <div id="resetAlert" class="alert alert-info d-none" role="alert"></div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="resetPassword()">Send Reset Email</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Main App Section -->
        <div id="appSection" style="display: none;">
            <button id="backToMenuBtn" class="btn btn-outline-secondary mb-3">
                <i class="fas fa-arrow-left"></i> Back to Menu
            </button>
            <div class="mb-2">
                <h2 class="mb-0">Welcome, <span id="fullName" class="technician-name"></span></h2>
            </div>
            <div class="row align-items-center mb-4">
                <div class="col-6 d-flex align-items-center">
                    <!-- Remove the My Tools button from appSection -->
                    <!-- <button onclick="showMyTools()" id="myToolsButton" class="btn btn-warning">
                        <i class="fas fa-toolbox"></i> My Tools
                    </button> -->
                </div>
                <div class="col-6 d-flex justify-content-end align-items-center">
                    <button onclick="toggleAdmin()" id="adminButton" class="btn btn-info me-2" style="display: none;">
                        <i class="fas fa-cog"></i> Admin
                    </button>
                    <button onclick="logout()" class="btn btn-secondary">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>

            <!-- Navigation Tabs -->
            <ul class="nav nav-tabs" id="mainTabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" id="scanner-tab" data-bs-toggle="tab" href="#scannerView" role="tab">
                        <i class="fas fa-barcode"></i> Scanner
                    </a>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content">
                <!-- Scanner View -->
                <div class="tab-pane fade show active" id="scannerView" role="tabpanel">
                    <div class="row">
                        <div class="col-md-6 mx-auto">
                            <div class="scanner-container" id="scannerContainer">
                            <div class="card mb-4">
                                <div class="card-body">
                                    <h4>Scan Tool</h4>
                                    <button onclick="startScanner()" class="btn btn-primary btn-scan mb-3">
                                        <i class="fas fa-camera"></i> Start Scanner
                                    </button>
                                    <button id="stopScannerBtn" onclick="stopCamera()" class="btn btn-danger mb-3" style="display:none;">Stop Scanner</button>
                                    <div id="reader" style="display:none;"></div>
                                    <div class="input-group mb-3">
                                        <input type="text" id="toolCode" class="form-control" placeholder="Enter Tool Code">
                                        <button onclick="submitCode()" class="btn btn-primary">
                                            <i class="fas fa-check"></i> Submit
                                        </button>
                                    </div>
                                    <button id="toolDetailsBtn" class="btn btn-info w-100 mb-2" disabled onclick="showLastScannedToolDetails()">Tool Details</button>
                                    </div>
                                </div>
                                <!-- Overlay for expanded scanner -->
                                <div class="scanner-overlay" id="scannerOverlay" style="display:none;">
                                    <button onclick="stopCamera()" class="btn btn-danger btn-lg">
                                        <i class="fas fa-times"></i> Close Scanner
                                    </button>
                                </div>
                            </div>

                            <div id="toolList" class="mt-4">
                                <h4>Today's Tools</h4>
                                <!-- Tools will be listed here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Section -->
        <div id="adminSection" class="mt-4" style="display: none;">
            <div class="card">
                <div class="card-body">
                    <h3>Tool Administration</h3>
                    <div class="mb-3">
                        <input type="text" id="adminToolId" class="form-control" placeholder="Tool ID">
                    </div>
                    <div class="mb-3">
                        <input type="text" id="adminToolName" class="form-control" placeholder="Tool Name">
                    </div>
                    <div class="mb-3">
                        <input type="text" id="adminPartNumber" class="form-control" placeholder="Part Number">
                    </div>
                    <div class="mb-3">
                        <input type="text" id="adminLocation" class="form-control" placeholder="Location">
                    </div>
                    <button onclick="saveToolAdmin()" class="btn btn-success">Save Tool</button>
                    <button onclick="toggleAdmin()" class="btn btn-secondary">Close Admin</button>
                </div>
            </div>
        </div>
    </div>

    <!-- My Tools Screen (new, full page) -->
    <div id="myToolsScreen" style="display:none;">
      <div class="container py-4">
        <button id="myToolsBackBtn" class="mytools-back"><i class="fas fa-arrow-left"></i> Back to Menu</button>
        <h2 class="text-center mytools-title">MY TOOLS</h2>
        <div id="myToolsScreenBody"></div>
      </div>
    </div>

    <!-- 5-Minute Cooldown Info Modal -->
    <div class="modal fade" id="cooldownInfoModal" tabindex="-1" aria-labelledby="cooldownInfoModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="cooldownInfoModalLabel">5-Minute Cooldown</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            When you check out a tool, you must wait at least 5 minutes before returning it. This helps ensure accurate tool tracking. You will not see this message again today.
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 5-Minute Cooldown Warning Modal -->
    <div class="modal fade" id="cooldownWarnModal" tabindex="-1" aria-labelledby="cooldownWarnModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="cooldownWarnModalLabel">Return Not Allowed</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            You must wait at least 5 minutes after checking out a tool before you can return it.
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Outstanding Tools Notification Modal -->
    <div class="modal fade" id="outstandingToolsModal" tabindex="-1" aria-labelledby="outstandingToolsModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="outstandingToolsModalLabel">YOUR TOOLS CHECKED OUT BY OTHERS</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" id="outstandingToolsBody">
            <!-- Notification content will be set by JS -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Overdue OUT Tools Notification Modal -->
    <div class="modal fade" id="outToolsNotifModal" tabindex="-1" aria-labelledby="outToolsNotifModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="outToolsNotifModalLabel">TOOLS YOU HAVE CHECKED OUT</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" id="outToolsNotifBody">
            <!-- Content will be set by JS -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ToolScanner Menu Section -->
    <div id="toolScannerMenu" style="display:none;">
        <div class="container py-4">
            <div class="mb-3 text-center">
                <span id="loggedInTechnician" style="font-weight:bold;color:#1976d2;font-size:1.2em;"></span>
            </div>
            <h2 class="text-center mb-4">ToolScanner Menu</h2>
            <div class="d-grid gap-3 col-6 mx-auto">
                <button class="btn btn-success" id="menuRegisterBtn"><i class="fas fa-plus"></i> Register Tools</button>
                <button class="btn btn-danger" id="menuOutBtn"><i class="fas fa-sign-out-alt"></i> View OUT Tools</button>
                <button class="btn btn-warning" id="menuMyToolsBtn"><i class="fas fa-toolbox"></i> My Tools</button>
                <button class="btn btn-primary" id="menuSearchBtn"><i class="fas fa-search"></i> Search for Tools</button>
                <button class="btn btn-secondary" id="menuLogoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>
        </div>
    </div>

    <!-- Collection Selection Modal -->
    <div class="modal fade" id="collectionSelectModal" tabindex="-1" aria-labelledby="collectionSelectModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="collectionSelectModalLabel">Select Collection</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" id="collectionSelectBody">
            <!-- Collections will be loaded here -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          </div>
        </div>
      </div>
    </div>

    <!-- My Tools by Collection Screen -->
    <div id="myToolsByCollectionScreen" style="display:none;">
      <div class="container py-4">
        <button id="backToCollectionSelectBtn" class="btn btn-outline-secondary mb-3"><i class="fas fa-arrow-left"></i> Back to Menu</button>
        <h3 id="myToolsCollectionTitle" class="mb-3" style="color: orange; font-weight: bold;"></h3>
        <div class="row mb-3">
          <div class="col-6">
            <button id="collectionCheckupBtn" class="btn btn-success w-100"><i class="fas fa-clipboard-check"></i> Collection Checkup</button>
          </div>
          <div class="col-6">
            <button id="selectDifferentCollectionBtn" class="btn btn-primary w-100"><i class="fas fa-exchange-alt"></i> Select Collection</button>
          </div>
        </div>
        <div id="myToolsByCollectionList"></div>
      </div>
    </div>

    <!-- Collection Checkup Screen -->
    <div id="collectionCheckupScreen" style="display:none;">
      <div class="container py-4">
        <button id="backToMyToolsByCollectionBtn" class="btn btn-outline-secondary mb-3">
          <i class="fas fa-arrow-left"></i> Back to Collection
        </button>
        
        <!-- Header -->
        <div class="text-center mb-4">
          <h2 style="color: #FF9800; font-weight: bold; font-size: 2rem;">Collection Checkup</h2>
        </div>
        
        <!-- Show Results and History buttons -->
        <div class="row mb-3" id="checkupActionButtons" style="display:none;">
          <div class="col-6">
            <button id="showResultsBtn" class="btn btn-primary w-100">
              <i class="fas fa-chart-bar"></i> Show Results
            </button>
          </div>
          <div class="col-6">
            <button id="checkupHistoryBtn" class="btn btn-secondary w-100">
              <i class="fas fa-history"></i> History
            </button>
          </div>
        </div>
        
        <!-- Collection Header with Progress -->
        <div id="checkupCollectionHeader" class="mb-3" style="background: #FF9800; color: white; padding: 12px; border-radius: 8px;">
          <div class="row align-items-center">
            <div class="col-6">
              <div><strong>Collection:</strong></div>
              <div id="checkupCollectionTitle" style="font-size: 1.2rem; font-weight: bold;"></div>
            </div>
            <div class="col-3 text-center">
              <button id="selectAllBtn" class="btn btn-success btn-sm">
                <i class="fas fa-check-double"></i> Select All
              </button>
            </div>
            <div class="col-3 text-end">
              <div><strong>Progress:</strong></div>
              <div id="checkupProgress" style="font-size: 1.1rem; font-weight: bold;">0/0</div>
            </div>
          </div>
        </div>
        
        <!-- Tools List -->
        <div id="checkupToolsList" style="height: calc(100vh - 400px); overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 10px; margin-bottom: 80px;"></div>
        
        <!-- Location Filter Bar -->
        <div id="checkupLocationFilter" class="mt-3" style="background: #f5f5f5; padding: 8px; border-radius: 8px; position: fixed; bottom: 0; left: 0; right: 0; z-index: 1000; border-top: 2px solid #FF9800;">
          <div class="d-flex gap-2 overflow-x-auto" id="checkupLocationButtons"></div>
        </div>
      </div>
    </div>

    <!-- Checkup Results Modal -->
    <div class="modal fade" id="checkupResultsModal" tabindex="-1" aria-labelledby="checkupResultsModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="checkupResultsModalLabel">Checkup Results</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" id="checkupResultsContent">
            <!-- Results content will be populated here -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" id="saveCheckupResultsBtn">
              <i class="fas fa-save"></i> Save Results
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Checkup Save Success Modal -->
    <div class="modal fade" id="checkupSaveSuccessModal" tabindex="-1" aria-labelledby="checkupSaveSuccessModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="checkupSaveSuccessModalLabel">Checkup Results Saved</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            Checkup results have been successfully saved to the database.
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Previous OUT Tools Screen -->
    <div id="previousOutToolsScreen" style="display:none;">
      <div class="container py-4">
        <button id="backToMenuFromOutToolsBtn" class="btn btn-outline-secondary mb-3">
          <i class="fas fa-arrow-left"></i> Back to Menu
        </button>
        
        <!-- Header -->
        <div class="text-center mb-4">
          <h2 style="color: #FF9800; font-weight: bold; font-size: 2rem;">Previous Dates OUT Tools</h2>
        </div>
        
        <!-- Tools List -->
        <div id="previousOutToolsList" style="height: calc(100vh - 200px); overflow-y: auto;"></div>
      </div>
    </div>

    <!-- Tool Details Modal for Previous OUT Tools -->
    <div class="modal fade" id="previousOutToolDetailsModal" tabindex="-1" aria-labelledby="previousOutToolDetailsModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="previousOutToolDetailsModalLabel">Tool Details</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" id="previousOutToolDetailsContent">
            <!-- Tool details will be populated here -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Photo Viewer Modal for Previous OUT Tools -->
    <div class="modal fade" id="previousOutPhotoViewerModal" tabindex="-1" aria-labelledby="previousOutPhotoViewerModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="previousOutPhotoViewerModalLabel">Tool Photos</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body text-center" id="previousOutPhotoViewerContent">
            <!-- Photo content will be populated here -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" id="previousOutPhotoPrevBtn">Previous</button>
            <span id="previousOutPhotoCounter" class="mx-3"></span>
            <button type="button" class="btn btn-secondary" id="previousOutPhotoNextBtn">Next</button>
            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Tool Details Modal for Register Tools -->
    <div class="modal fade" id="toolDetailsModal" tabindex="-1" aria-labelledby="toolDetailsModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="toolDetailsModalLabel">Tool Details</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" id="toolDetailsBody">
            <!-- Tool details will be populated here -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Collection Details Modal -->
    <div class="modal fade" id="collectionDetailsModal" tabindex="-1" aria-labelledby="collectionDetailsModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="collectionDetailsModalLabel">Collection Details</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" id="collectionDetailsBody">
            <!-- Collection details and photos will be populated here -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Collection Details Screen -->
    <div id="collectionDetailsScreen" style="display:none;">
      <div class="container py-4">
        <button id="backToRegisterToolsBtn" class="btn btn-outline-secondary mb-3">
            <i class="fas fa-arrow-left"></i> Back to Register Tools List
          </button>
        <!-- Header -->
        <div class="text-center mb-4">
          <h2 style="color: #FF9800; font-weight: bold; font-size: 2rem;">Collection Details</h2>
        </div>
        
        <!-- Collection Details Content -->
        <div id="collectionDetailsContent" class="mb-4">
          <!-- Collection details will be populated here -->
        </div>
      </div>
    </div>

    <!-- Collection Details Screen (Full Page) -->
    <div id="collectionDetailsScreen" style="display:none;">
      <div class="container py-4">
        
        <div class="text-center mb-4">
          <h2 style="color: #FF9800; font-weight: bold; font-size: 2rem;">Collection Details</h2>
        </div>
        <div id="collectionDetailsContent" class="mb-4">
          <!-- Collection details will be populated here -->
        </div>
      </div>
    </div>

    <!-- Tool Photo Gallery Modal -->
    <div class="modal fade" id="toolPhotoGalleryModal" tabindex="-1" aria-labelledby="toolPhotoGalleryModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-fullscreen">
        <div class="modal-content bg-dark text-white">
          <div class="modal-header border-0">
            <h5 class="modal-title" id="toolPhotoGalleryModalLabel">Tool Photos</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body d-flex flex-column align-items-center justify-content-center" id="toolPhotoGalleryContent">
            <!-- Photo will be shown here -->
          </div>
          <div class="modal-footer justify-content-between border-0 bg-dark">
            <button type="button" class="btn btn-light" id="toolPhotoPrevBtn">Previous</button>
            <span id="toolPhotoCounter"></span>
            <button type="button" class="btn btn-light" id="toolPhotoNextBtn">Next</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <!-- QR Code Scanner -->
    <script src="https://unpkg.com/html5-qrcode"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDmI0v_pVt_qFJlsqmw8QlIOi-4VLjyn54",
            authDomain: "tool-tracking-system-15e84.firebaseapp.com",
            projectId: "tool-tracking-system-15e84",
            storageBucket: "tool-tracking-system-15e84.firebasestorage.app",
            messagingSenderId: "813615362050",
            appId: "1:813615362050:web:1fa435f0b725dd1f8cb71b"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Ensure user stays logged in across refreshes and browser restarts
        auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

        // QR Scanner
        let html5QrCode;

        // Show/Hide password logic
        const loginPassword = document.getElementById('loginPassword');
        document.getElementById('toggleLoginPassword').onclick = function() {
            if (loginPassword.type === 'password') {
                loginPassword.type = 'text';
                this.innerHTML = '<i class="fas fa-eye-slash"></i>';
            } else {
                loginPassword.type = 'password';
                this.innerHTML = '<i class="fas fa-eye"></i>';
            }
        };
        const signUpPassword = document.getElementById('signUpPassword');
        document.getElementById('toggleSignUpPassword').onclick = function() {
            if (signUpPassword.type === 'password') {
                signUpPassword.type = 'text';
                this.innerHTML = '<i class="fas fa-eye-slash"></i>';
            } else {
                signUpPassword.type = 'password';
                this.innerHTML = '<i class="fas fa-eye"></i>';
            }
        };
        const signUpConfirmPassword = document.getElementById('signUpConfirmPassword');
        document.getElementById('toggleSignUpConfirmPassword').onclick = function() {
            if (signUpConfirmPassword.type === 'password') {
                signUpConfirmPassword.type = 'text';
                this.innerHTML = '<i class="fas fa-eye-slash"></i>';
            } else {
                signUpConfirmPassword.type = 'password';
                this.innerHTML = '<i class="fas fa-eye"></i>';
            }
        };

        // Show/Hide login/signup
        function showSignUp() {
            document.getElementById('loginSection').classList.add('d-none');
            document.getElementById('signUpSection').classList.remove('d-none');
        }
        function showLogin() {
            document.getElementById('signUpSection').classList.add('d-none');
            document.getElementById('loginSection').classList.remove('d-none');
        }

        // Forgot password modal
        const forgotPasswordLink = document.getElementById('forgotPasswordLink');
        forgotPasswordLink.onclick = function() {
            const email = document.getElementById('loginEmail').value;
            document.getElementById('resetEmail').value = email;
            document.getElementById('resetAlert').classList.add('d-none');
            const modal = new bootstrap.Modal(document.getElementById('forgotPasswordModal'));
            modal.show();
        };

        // Login logic
        async function login() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            const alertBox = document.getElementById('loginAlert');
            alertBox.classList.add('d-none');
            if (!email || !password) {
                alertBox.textContent = 'Please fill in all fields.';
                alertBox.classList.remove('d-none');
                return;
            }
            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                // Always keep user signed in until logout
                // No need to handle keep_signed_in logic
                // Success: hide login, show app
                document.getElementById('loginSection').classList.add('d-none');
                document.getElementById('appSection').style.display = 'block';
                document.getElementById('headerBranding').style.display = 'none';
                updateLoggedInTechnician();
            } catch (error) {
                alertBox.textContent = error.message;
                alertBox.classList.remove('d-none');
            }
        }

        // Sign up logic
        async function signUp() {
            const fullName = document.getElementById('signUpFullName').value.trim();
            const email = document.getElementById('signUpEmail').value.trim();
            const password = document.getElementById('signUpPassword').value.trim();
            const confirmPassword = document.getElementById('signUpConfirmPassword').value.trim();
            const alertBox = document.getElementById('signUpAlert');
            alertBox.classList.add('d-none');
            if (!fullName || !email || !password || !confirmPassword) {
                alertBox.textContent = 'Please fill in all fields.';
                alertBox.classList.remove('d-none');
                return;
            }
            if (password !== confirmPassword) {
                alertBox.textContent = 'Passwords do not match.';
                alertBox.classList.remove('d-none');
                return;
            }
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                
                // Create technician document with just name and email
                await db.collection('technicians').doc(userCredential.user.uid).set({
                    fullName: fullName,
                    email: email
                });

                alertBox.classList.add('d-none');
                showLogin();
                alert('Account created! You can now sign in.');
            } catch (error) {
                alertBox.textContent = error.message;
                alertBox.classList.remove('d-none');
            }
        }

        // Password reset logic
        async function resetPassword() {
            const email = document.getElementById('resetEmail').value.trim();
            const alertBox = document.getElementById('resetAlert');
            alertBox.classList.add('d-none');
            if (!email) {
                alertBox.textContent = 'Please enter your email.';
                alertBox.classList.remove('d-none');
                return;
            }
            try {
                await auth.sendPasswordResetEmail(email);
                alertBox.textContent = 'Password reset email sent!';
                alertBox.classList.remove('d-none');
            } catch (error) {
                alertBox.textContent = error.message;
                alertBox.classList.remove('d-none');
            }
        }

        // Logout function
        function logout() {
            auth.signOut();
            if (html5QrCode) {
                html5QrCode.clear();
            }
            localStorage.removeItem('fullName'); // Clear stored name on logout
            document.getElementById('headerBranding').style.display = 'block';
        }

        // Toggle Admin Section
        function toggleAdmin() {
            const adminSection = document.getElementById('adminSection');
            adminSection.style.display = adminSection.style.display === 'none' ? 'block' : 'none';
        }

        // Save Tool Admin
        async function saveToolAdmin() {
            const toolId = document.getElementById('adminToolId').value.trim();
            const toolName = document.getElementById('adminToolName').value.trim();
            const partNumber = document.getElementById('adminPartNumber').value.trim();
            const location = document.getElementById('adminLocation').value.trim();

            if (!toolId || !toolName) {
                alert('Tool ID and Name are required');
                return;
            }

            try {
                await db.collection('tools').doc(toolId).set({
                    toolName: toolName,
                    partNumber: partNumber,
                    location: location,
                    status: 'IN',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                alert('Tool saved successfully');
                document.getElementById('adminToolId').value = '';
                document.getElementById('adminToolName').value = '';
                document.getElementById('adminPartNumber').value = '';
                document.getElementById('adminLocation').value = '';
            } catch (error) {
                console.error('Error saving tool:', error);
                alert('Error saving tool: ' + error.message);
            }
        }

        // Store last scanned tool data
        let lastScannedToolData = null;

        // Checkup functionality variables
        let lastViewedCollectionName = null;
        let lastViewedCollectionTools = [];
        let checkupCheckedTools = new Set();
        let checkupSelectedLocation = 'All';
        let checkupLocationStats = {};

        // Submit tool code
        async function submitCode() {
            const code = document.getElementById('toolCode').value.trim();
            if (!code) return;

            try {
                const user = auth.currentUser;
                const toolRef = db.collection('tools').doc(code);
                const doc = await toolRef.get();

                if (doc.exists) {
                    const data = doc.data();
                    
                    // Get current technician name
                    const technicianDoc = await db.collection('technicians').doc(user.uid).get();
                    const technicianName = technicianDoc.exists ? technicianDoc.data().fullName : 'Unknown Technician';

                    // Only show warning if tool is OUT and checked out by a different technician
                    if (data.status === 'OUT' && data.technician !== technicianName) {
                        alert(`This tool is currently checked out by ${data.technician}`);
                        return;
                    }
                    // Prevent returning previous OUT tools (checked out before today)
                    if (data.status === 'OUT' && data.timestamp && data.timestamp.toDate) {
                        const toolDate = data.timestamp.toDate();
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        if (toolDate < today) {
                            alert('This tool was checked out on a previous day and cannot be returned. Please contact an administrator if you believe this is an error.');
                            document.getElementById('toolCode').value = '';
                            lastScannedToolData = null;
                            document.getElementById('toolDetailsBtn').disabled = true;
                            return;
                        }
                    }
                    // Enforce 5-minute cooldown for returning tools
                    if (data.status === 'OUT' && data.timestamp && data.timestamp.toDate) {
                        const outTime = data.timestamp.toDate();
                        const now = new Date();
                        const diffMs = now - outTime;
                        if (diffMs < 5 * 60 * 1000) {
                            // Show cooldown warning modal with remaining time
                            setCooldownWarnMessage(5 * 60 * 1000 - diffMs);
                            const warnModal = new bootstrap.Modal(document.getElementById('cooldownWarnModal'));
                            warnModal.show();
                            document.getElementById('toolCode').value = '';
                            lastScannedToolData = null;
                            document.getElementById('toolDetailsBtn').disabled = true;
                            return;
                        }
                    }
                    const status = data.status === 'OUT' ? 'IN' : 'OUT';
                    const timestamp = firebase.firestore.FieldValue.serverTimestamp();

                    // Show 5-minute cooldown info dialog only once per day, when first tool is checked OUT
                    if (status === 'OUT') {  // Check new status instead of current status
                        const todayKey = 'cooldownInfoShown_' + (new Date()).toISOString().slice(0, 10);
                        if (!localStorage.getItem(todayKey)) {
                            const infoModal = new bootstrap.Modal(document.getElementById('cooldownInfoModal'));
                            infoModal.show();
                            localStorage.setItem(todayKey, '1');
                        }
                    }

                    // Update tool status
                    await toolRef.update({
                        status: status,
                        technician: technicianName,
                        timestamp: timestamp
                    });

                    // Add log entry
                    await db.collection('logtoolmovements').add({
                        toolId: code,
                        toolName: data.toolName || 'Unknown',
                        partNumber: data.partNumber || code,
                        location: data.location || '',
                        status: status,
                        technician: technicianName,
                        timestamp: timestamp
                    });

                    document.getElementById('toolCode').value = '';
                    loadTools();
                    // Update previous OUT tools count after tool status change
                    updatePreviousOutToolsCount();

                    // Store last scanned tool data for modal
                    lastScannedToolData = {
                        toolName: data.toolName || 'Unknown Tool',
                        toolId: doc.id,
                        partNumber: data.partNumber || doc.id,
                        collectionCode: data.collectionCode || '',
                        location: data.location || 'N/A',
                        owner: data.owner || 'N/A',
                    };
                    document.getElementById('toolDetailsBtn').disabled = false;
                } else {
                    alert('Warning: This tool does not exist in the system. Please contact an administrator to add the tool.');
                    document.getElementById('toolCode').value = '';
                    lastScannedToolData = null;
                    document.getElementById('toolDetailsBtn').disabled = true;
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error: ' + error.message);
                lastScannedToolData = null;
                document.getElementById('toolDetailsBtn').disabled = true;
            }
        }

        // Load today's tools
        async function loadTools() {
            const user = auth.currentUser;
            if (!user) return;

            try {
                // Get technician name
                const technicianDoc = await db.collection('technicians').doc(user.uid).get();
                const technicianName = technicianDoc.exists ? technicianDoc.data().fullName : 'Unknown Technician';

                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const snapshot = await db.collection('tools')
                    .where('technician', '==', technicianName)
                    .where('timestamp', '>=', today)
                    .get();

                const toolList = document.getElementById('toolList');
                toolList.innerHTML = '<h4 class="tool-title">Scanned Tools:</h4>';

                if (snapshot.empty) {
                    toolList.innerHTML += '<p>No tools scanned today.</p>';
                    return;
                }

                // Sort tools: OUT first, then IN, and by timestamp within each group
                const sortedTools = snapshot.docs.sort((a, b) => {
                    const aData = a.data();
                    const bData = b.data();
                    // First sort by status (OUT before IN)
                    if (aData.status !== bData.status) {
                        return aData.status === 'OUT' ? -1 : 1;
                    }
                    // Then sort by timestamp (newest first)
                    return bData.timestamp.toDate() - aData.timestamp.toDate();
                });

                sortedTools.forEach((doc, index) => {
                    const data = doc.data();
                    const status = (data.status || '').toUpperCase();
                    let statusClass = 'in';
                    if (status === 'OUT') statusClass = 'out';
                    else if (status === 'BROKEN') statusClass = 'broken';
                    else if (status === 'LOST') statusClass = 'lost';
                    else if (status === 'CALIBRATION') statusClass = 'calibration';

                    const time = data.timestamp ? data.timestamp.toDate().toLocaleString('en-GB', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: false
                    }) : 'N/A';

                    const card = document.createElement('div');
                    card.className = `register-tool-card ${statusClass}`;
                    card.onclick = function() {
                        showToolDetails({
                            toolName: data.toolName || 'Unknown Tool',
                            toolId: doc.id,
                            partNumber: data.partNumber || doc.id,
                            collectionCode: data.collectionCode || '',
                            location: data.location || 'N/A',
                            status: data.status || status,
                            owner: data.owner || 'N/A',
                            technician: data.technician || 'N/A',
                            timestamp: time,
                            photoUrls: data.photoUrls || []
                        });
                    };
                    card.innerHTML = `
                        <div class="register-tool-title">${index + 1}. ${data.toolName || 'Unknown Tool'}</div>
                        <div class="register-tool-date">${time}</div>
                        <div class="register-tool-row">
                            <div class="register-tool-col">
                                <div class="register-tool-label">TID</div>
                                <div class="register-tool-value">${doc.id}</div>
                        </div>
                            <div class="register-tool-col">
                                <div class="register-tool-label">P/N</div>
                                <div class="register-tool-value">${data.partNumber || doc.id}</div>
                        </div>
                            <div class="register-tool-col">
                                <div class="register-tool-label">STS</div>
                                <div class="register-tool-status ${statusClass}">${status}</div>
                            </div>
                        </div>
                    `;
                    toolList.appendChild(card);
                });
            } catch (error) {
                console.error('Error loading tools:', error);
                const toolList = document.getElementById('toolList');
                toolList.innerHTML = '<h4 class="tool-title">Scanned Tools:</h4><p class="text-danger">Error loading tools. Please try again.</p>';
            }
        }

        // Load previous out tools
        async function loadPreviousTools() {
            const user = auth.currentUser;
            if (!user) return;

            try {
                // Get technician name
                const technicianDoc = await db.collection('technicians').doc(user.uid).get();
                const technicianName = technicianDoc.exists ? technicianDoc.data().fullName : 'Unknown Technician';

                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const snapshot = await db.collection('tools')
                    .where('technician', '==', technicianName)
                    .where('status', '==', 'OUT')
                    .get();

                const previousList = document.getElementById('previousToolsList');
                previousList.innerHTML = '<h4 class="tool-title">Previous OUT Tools (Total: 0)</h4><p>No previous OUT tools found.</p>';

                if (snapshot.empty) {
                    previousList.innerHTML = '<h4 class="tool-title">Previous OUT Tools (Total: 0)</h4><p>No previous OUT tools found.</p>';
                    document.getElementById('previous-tab').innerHTML = '<i class="fas fa-history"></i> Previous Tools (0)';
                    return;
                }

                const previousTools = snapshot.docs
                    .filter(doc => {
                        const data = doc.data();
                        return data.timestamp && typeof data.timestamp.toDate === 'function' && data.timestamp.toDate() < today;
                    })
                    .sort((a, b) => {
                        const aTime = a.data().timestamp && typeof a.data().timestamp.toDate === 'function' ? a.data().timestamp.toDate() : 0;
                        const bTime = b.data().timestamp && typeof b.data().timestamp.toDate === 'function' ? b.data().timestamp.toDate() : 0;
                        return bTime - aTime;
                    });

                if (previousTools.length === 0) {
                    previousList.innerHTML = '<h4 class="tool-title">Previous OUT Tools (Total: 0)</h4><p>No previous OUT tools found.</p>';
                    document.getElementById('previous-tab').innerHTML = '<i class="fas fa-history"></i> Previous Tools (0)';
                    return;
                }

                previousList.innerHTML = `<h4 class="tool-title">Previous OUT Tools (Total: ${previousTools.length})</h4>`;
                document.getElementById('previous-tab').innerHTML = `<i class="fas fa-history"></i> Previous Tools (${previousTools.length})`;
                let count = 0;
                previousTools.forEach((doc, index) => {
                    const data = doc.data();
                    const div = document.createElement('div');
                    count++;
                    const evenOdd = count % 2 === 0 ? 'even' : 'odd';
                    
                    div.className = `tool-item tool-out-${evenOdd}`;
                    div.style.cursor = 'pointer';
                    div.onclick = function() {
                        showToolDetails({
                            toolName: data.toolName || 'Unknown Tool',
                            toolId: doc.id,
                            partNumber: data.partNumber || doc.id,
                            collectionCode: data.collectionCode || '',
                            location: data.location || 'N/A',
                            status: data.status || 'OUT',
                            owner: data.owner || 'N/A',
                            technician: data.technician || 'N/A',
                            timestamp: data.timestamp ? data.timestamp.toDate().toLocaleString('en-GB', {
                                day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
                            }) : 'N/A',
                            photoUrls: data.photoUrls || []
                        });
                    };
                    const date = data.timestamp.toDate();
                    const formattedDate = date.toLocaleString('en-GB', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: false
                    });
                    
                    div.innerHTML = `
                        <div class="tool-name tool-out-text">
                            ${index + 1}. ${data.toolName || 'Unknown Tool'}
                        </div>
                        <div class="tool-time tool-out-text">
                            ${formattedDate}
                        </div>
                        <div class="tool-headers">
                            <div class="row">
                                <div class="col-4">TID</div>
                                <div class="col-4">P/N</div>
                                <div class="col-4">STS</div>
                            </div>
                        </div>
                        <div class="tool-values tool-out-text">
                            <div class="row">
                                <div class="col-4 tool-id-value">${doc.id}</div>
                                <div class="col-4 tool-pn-value">${data.partNumber || doc.id}</div>
                                <div class="col-4">
                                    <span class="status-badge status-out">OUT</span>
                                </div>
                            </div>
                        </div>
                    `;
                    previousList.appendChild(div);
                });
                // Debug log to help diagnose data issues
                console.log('Previous OUT tools snapshot:', snapshot.docs.map(doc => doc.data()));
            } catch (error) {
                console.error('Error loading previous tools:', error);
                const previousList = document.getElementById('previousToolsList');
                previousList.innerHTML = '<h4 class="tool-title">Previous OUT Tools</h4><p class="text-danger">Error loading previous tools. Please try again.</p>';
            }
        }

        // QR Code Scanner
        function startScanner() {
            var reader = document.getElementById('reader');
            reader.style.display = 'block';
            reader.style.height = '320px';
            document.getElementById('stopScannerBtn').style.display = 'inline-block';
            
            html5QrCode = new Html5Qrcode("reader");
            const config = {
                fps: 10,
                qrbox: { width: 250, height: 250 }, // Square QR box
                aspectRatio: 1.0, // Square aspect ratio
                formatsToSupport: [
                    Html5QrcodeSupportedFormats.QR_CODE,
                    Html5QrcodeSupportedFormats.CODE_128,
                    Html5QrcodeSupportedFormats.CODE_39,
                    Html5QrcodeSupportedFormats.EAN_13,
                    Html5QrcodeSupportedFormats.EAN_8,
                    Html5QrcodeSupportedFormats.UPC_A,
                    Html5QrcodeSupportedFormats.UPC_E,
                    Html5QrcodeSupportedFormats.ITF,
                    Html5QrcodeSupportedFormats.AZTEC,
                    Html5QrcodeSupportedFormats.DATA_MATRIX,
                    Html5QrcodeSupportedFormats.CODABAR,
                    Html5QrcodeSupportedFormats.PDF_417
                ]
            };

            // Try to use the environment camera (back camera) first
            html5QrCode.start(
                { facingMode: "environment" },
                config,
                (decodedText) => {
                    document.getElementById('toolCode').value = decodedText;
                    document.getElementById('toolDetailsBtn').disabled = false;
                    stopCamera();
                },
                (errorMessage) => {
                    // Ignore errors during scanning
                }
            ).catch(err => {
                // If environment camera fails, try user camera (front camera)
                html5QrCode.start(
                    { facingMode: "user" },
                    config,
                    (decodedText) => {
                        document.getElementById('toolCode').value = decodedText;
                        document.getElementById('toolDetailsBtn').disabled = false;
                        stopCamera();
                    },
                    (errorMessage) => {
                        // Ignore errors during scanning
                    }
                ).catch(err => {
                    alert('Camera error: ' + err);
                    stopCamera();
                });
            });
        }

        function stopCamera() {
            var reader = document.getElementById('reader');
            // Immediately hide and collapse the scanner area
            reader.style.display = 'none';
            reader.style.height = '0';
            document.getElementById('stopScannerBtn').style.display = 'none';
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    html5QrCode.clear();
                });
                html5QrCode = null;
            }
        }

        // Show tool details for the code in the input field, even if not submitted
        async function showLastScannedToolDetails() {
            const code = document.getElementById('toolCode').value.trim();
            if (!code) return;
            try {
                const toolRef = db.collection('tools').doc(code);
                const doc = await toolRef.get();
                if (doc.exists) {
                    const data = doc.data();
                    // Store the data for the modal
                    lastScannedToolData = {
                        toolName: data.toolName || 'Unknown Tool',
                        toolId: doc.id,
                        partNumber: data.partNumber || doc.id,
                        collectionCode: data.collectionCode || '',
                        location: data.location || 'N/A',
                        owner: data.owner || 'N/A',
                        status: data.status || 'N/A',
                        technician: data.technician || 'N/A',
                        timestamp: data.timestamp && data.timestamp.toDate ? data.timestamp.toDate().toLocaleString('en-GB', {
                            day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
                        }) : 'N/A',
                        calDueDate: data.calDueDate && data.calDueDate.toDate ? data.calDueDate.toDate().toLocaleDateString('en-GB') : 'N/A',
                        photoUrls: data.photoUrls || []
                    };
                    
                    // Show the modal with the tool details
                    showToolDetails(lastScannedToolData);
                } else {
                    alert('Tool not found. Please check the code.');
                }
            } catch (error) {
                console.error('Error fetching tool details:', error);
                alert('Error fetching tool details: ' + error.message);
            }
        }

        // Add this function to show tool details in the modal
        function showToolDetails(tool) {
            const body = document.getElementById('toolDetailsBody');
            let photoLinkHtml = '';
            if (tool.photoUrls && Array.isArray(tool.photoUrls) && tool.photoUrls.length > 0) {
                photoLinkHtml = `<strong style="color: #1976d2; text-decoration: underline; cursor: pointer; font-size: 1.1em; display: inline-block; margin-top: 10px;" onclick="showToolPhotoGallery(this)" data-photo-urls='${JSON.stringify(tool.photoUrls)}'>Photo (${tool.photoUrls.length})</strong>`;
            } else {
                photoLinkHtml = `<span style="color: #888; text-decoration: none; cursor: not-allowed; font-size: 1.1em; display: inline-block; margin-top: 10px;">Photo</span>`;
            }
            body.innerHTML = `
                <div class="mb-2" style="font-size: 1.1em;"><strong>Tool ID:</strong> ${tool.toolId}</div>
                <div class="mb-2" style="font-size: 1.1em;"><strong>Tool Name:</strong> ${tool.toolName}</div>
                <div class="mb-2" style="font-size: 1.1em;"><strong>Part Number:</strong> ${tool.partNumber}</div>
                <div class="mb-2" style="font-size: 1.1em;"><strong>Owner:</strong> ${tool.owner}</div>
                <div class="mb-2" style="font-size: 1.1em;"><strong>Collection:</strong> <a href="#" onclick="showCollectionDetails('${tool.collectionCode || ''}')" style="font-size: 1.1em; color: #1976d2; text-decoration: underline;">${tool.collectionCode}</a></div>
                <div class="mb-2" style="font-size: 1.1em;"><strong>Location:</strong> ${tool.location}</div>
                ${tool.status === 'OUT' ? `
                    <div class="mb-2" style="font-size: 1.1em;"><strong>Status:</strong> ${tool.status}</div>
                    <div class="mb-2" style="font-size: 1.1em;"><strong>Technician:</strong> ${tool.technician}</div>
                    <div class="mb-2" style="font-size: 1.1em;"><strong>Last Updated:</strong> ${tool.timestamp}</div>
                ` : ''}
                ${tool.calDueDate !== 'N/A' ? `<div class="mb-2" style="font-size: 1.1em;"><strong>Calibration Due:</strong> ${tool.calDueDate}</div>` : ''}
                <div class="mb-2">${photoLinkHtml}</div>
            `;
            const modal = new bootstrap.Modal(document.getElementById('toolDetailsModal'));
            modal.show();
        }

        // Enable/disable Tool Details button based on input
        document.getElementById('toolCode').addEventListener('input', function() {
            const btn = document.getElementById('toolDetailsBtn');
            btn.disabled = !this.value.trim();
        });

        // My Tools Screen with app-like formatting (full page)
        async function showMyTools() {
            const user = auth.currentUser;
            if (!user) return;
            const fullName = localStorage.getItem('fullName') || user.email;
            const myToolsScreenBody = document.getElementById('myToolsScreenBody');
            myToolsScreenBody.innerHTML = '<div class="text-center">Loading...</div>';

            // Hide all other main screens
            document.getElementById('toolScannerMenu').style.display = 'none';
            document.getElementById('appSection').style.display = 'none';
            document.getElementById('myToolsScreen').style.display = 'block';

            try {
                // Query all tools where owner matches the logged-in user
                const snapshot = await db.collection('tools')
                    .where('owner', '==', fullName)
                    .get();

                if (snapshot.empty) {
                    myToolsScreenBody.innerHTML = '<div class="text-center">No tools found for you.</div>';
                } else {
                    // Group by collectionCode and location
                    const tools = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    const grouped = {};
                    tools.forEach(tool => {
                        const collection = tool.collectionCode || 'N/A';
                        const location = tool.location || 'N/A';
                        if (!grouped[collection]) grouped[collection] = {};
                        if (!grouped[collection][location]) grouped[collection][location] = [];
                        grouped[collection][location].push(tool);
                    });

                    let html = '';
                    Object.keys(grouped).forEach(collection => {
                        html += `<div class=\"mytools-collection\"><span>Collection:</span><span>${collection}</span></div>`;
                        Object.keys(grouped[collection]).forEach(location => {
                            const toolsAtLocation = grouped[collection][location];
                            html += `<div class=\"mytools-location\"><span>Location:</span><span>${location} (Total: ${toolsAtLocation.length} tools)</span></div>`;
                            toolsAtLocation.forEach((tool, idx) => {
                                const bgClass = idx % 2 === 0 ? 'mytools-tool-bg1' : 'mytools-tool-bg2';
                                html += `<div class=\"mytools-tool-item ${bgClass}\">`
                                    + `<span class=\"mytools-tool-name\">${idx + 1}. ${tool.toolName || 'Unknown Tool'}</span> - <span class=\"mytools-tool-tid\">TID: ${tool.id}</span><br>`
                                    + `<span class=\"mytools-tool-part\">Part #: ${tool.partNumber || ''}</span><br>`
                                    + `<span class=\"mytools-status-${getStatusClass(tool.status)}\">Status: ${tool.status || ''}</span>`;
                                if (tool.status === 'OUT') {
                                    html += `<div class=\"mytools-tool-extra\">Technician: ${tool.technician || ''}</div>`;
                                    if (tool.timestamp && tool.timestamp.toDate) {
                                        const outTime = tool.timestamp.toDate().toLocaleString('en-GB', {
                                            day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
                                        });
                                        html += `<div class=\"mytools-tool-extra\">Checked out: ${outTime}</div>`;
                                    }
                                }
                                if (tool.calDueDate && tool.calDueDate.toDate) {
                                    const calDue = tool.calDueDate.toDate().toLocaleDateString('en-GB');
                                    html += `<div class=\"mytools-tool-cal\">Cal Due: <span style=\"font-weight: bold;\">${calDue}</span></div>`;
                                }
                                html += `</div>`;
                            });
                        });
                    });
                    myToolsScreenBody.innerHTML = html;
                }
            } catch (error) {
                myToolsScreenBody.innerHTML = `<div class=\"text-danger text-center\">Error loading your tools: ${error.message}</div>`;
            }
        }

        // Back button for My Tools screen
        document.getElementById('myToolsBackBtn').onclick = function() {
            document.getElementById('myToolsScreen').style.display = 'none';
            document.getElementById('toolScannerMenu').style.display = 'block';
        };

        // Helper to get status CSS class
        function getStatusClass(status) {
            const upperStatus = status ? status.toUpperCase() : 'IN';
            switch (upperStatus) {
                case 'OUT': return 'out';
                case 'BROKEN': return 'broken';
                case 'LOST': return 'lost';
                case 'CALIBRATION': return 'calibration';
                default: return 'in';
            }
        }

        // Helper to set cooldown warning message
        function setCooldownWarnMessage(remainingMs) {
            const mins = Math.floor(remainingMs / 60000);
            const secs = Math.ceil((remainingMs % 60000) / 1000);
            document.querySelector('#cooldownWarnModal .modal-body').textContent = `You must wait ${mins} minute${mins !== 1 ? 's' : ''} and ${secs} second${secs !== 1 ? 's' : ''} before you can return this tool.`;
        }

        // Tab change handler
        // (removed previous-tab event listener as the tab is no longer present)

        // On auth state change, show menu after login (not register tools)
        auth.onAuthStateChanged(function(user) {
            if (user) {
                loginSection.style.display = 'none';
                signUpSection.classList.add('d-none');
                adminSection.style.display = 'none';
                document.getElementById('adminButton').style.display = 'none';
                document.getElementById('headerBranding').style.display = 'none';
                // Always fetch fresh data from Firestore
                db.collection('technicians').doc(user.uid)
                    .get()
                    .then(doc => {
                        if (doc.exists) {
                            const technicianData = doc.data();
                            const name = technicianData.fullName || user.email;
                            // Store the document ID
                            localStorage.setItem('techniciansId', doc.id);
                            localStorage.setItem('fullName', name);
                            document.getElementById('fullName').textContent = name;
                            if (technicianData.isAdmin) {
                                document.getElementById('adminButton').style.display = 'inline-block';
                            }
                        } else {
                            document.getElementById('fullName').textContent = user.email;
                        }
                        updatePreviousToolsTabCount();
                    }).catch(error => {
                        console.error('Error fetching technician data:', error);
                        document.getElementById('fullName').textContent = user.email;
                        updatePreviousToolsTabCount();
                    });
                // Always show the menu after login or refresh
                showToolScannerMenu();
                updateLoggedInTechnician();
            } else {
                loginSection.style.display = 'block';
                appSection.style.display = 'none';
                adminSection.style.display = 'none';
                document.getElementById('adminButton').style.display = 'none';
                document.getElementById('headerBranding').style.display = 'block';
                localStorage.removeItem('fullName');
            }
        });

        // Navigation logic for ToolScanner Menu
        function showToolScannerMenu() {
            document.getElementById('toolScannerMenu').style.display = 'block';
            document.getElementById('appSection').style.display = 'none';
        }
        function showRegisterTools() {
            document.getElementById('toolScannerMenu').style.display = 'none';
            document.getElementById('appSection').style.display = 'block';
            // Load today's tools when entering Register Tools screen
            loadTools();
        }
        document.addEventListener('DOMContentLoaded', function() {
            // After login, show ToolScanner Menu instead of appSection
            const originalLogin = window.login;
            window.login = async function() {
                await originalLogin();
                document.getElementById('loginSection').style.display = 'none';
                showToolScannerMenu();
            };
            // Menu button handlers
            document.getElementById('menuRegisterBtn').onclick = async function() {
                await showNotificationsInSequence();
                showRegisterTools();
            };
            document.getElementById('menuLogoutBtn').onclick = function() {
                logout();
                document.getElementById('toolScannerMenu').style.display = 'none';
            };
        });

        document.getElementById('backToMenuBtn').onclick = function() {
            document.getElementById('appSection').style.display = 'none';
            document.getElementById('toolScannerMenu').style.display = 'block';
        };

        // My Tools menu button handler: show collection selection dialog
        console.log('Script loaded');
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM fully loaded');
            const myToolsBtn = document.getElementById('menuMyToolsBtn');
            if (myToolsBtn) {
                console.log('Setting My Tools button handler');
                myToolsBtn.onclick = async function() {
                    console.log('My Tools button clicked');
                    // Hide all main screens
                    document.getElementById('toolScannerMenu').style.display = 'none';
                    document.getElementById('appSection').style.display = 'none';
                    document.getElementById('myToolsScreen').style.display = 'none';
                    document.getElementById('myToolsByCollectionScreen').style.display = 'none';
                    // Fetch tools where user is owner
            const user = auth.currentUser;
            if (!user) return;
                    const fullName = localStorage.getItem('fullName') || user.email;
                    console.log('WebApp: Querying tools for owner:', fullName);
                    const modal = new bootstrap.Modal(document.getElementById('collectionSelectModal'));
                    const body = document.getElementById('collectionSelectBody');
                    body.innerHTML = '<div class="text-center">Loading...</div>';
                    try {
                        // 1. Query tools for this owner
                        const toolsSnapshot = await db.collection('tools').where('owner', '==', fullName).get();
                        if (toolsSnapshot.empty) {
                            body.innerHTML = '<div class="text-center text-danger">No tools found for you.</div>';
                            modal.show();
                            return;
                        }
                        // 2. Extract unique collectionCodes
                        const collectionCodes = [...new Set(toolsSnapshot.docs.map(doc => doc.data().collectionCode).filter(Boolean))];
                        if (collectionCodes.length === 0) {
                            body.innerHTML = '<div class="text-center text-danger">No collections found for your tools.</div>';
                            modal.show();
                            return;
                        }
                        // 3. Query collections for those codes (batch if >10)
                        let collections = [];
                        if (collectionCodes.length <= 10) {
                          const colSnap = await db.collection('collections').where('collectionName', 'in', collectionCodes).get();
                          collections = colSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        } else {
                          // Firestore 'in' query limit is 10, so batch if needed
                          for (let i = 0; i < collectionCodes.length; i += 10) {
                            const batch = collectionCodes.slice(i, i + 10);
                            const colSnap = await db.collection('collections').where('collectionName', 'in', batch).get();
                            collections = collections.concat(colSnap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                          }
                        }
                        if (collections.length === 0) {
                            body.innerHTML = '<div class="text-center text-danger">No collections found for your tools.</div>';
                        } else {
                            let html = '<div class="list-group">';
                            collections.forEach(data => {
                                html += `<button class="list-group-item list-group-item-action" style="font-weight:bold;color:#1976d2;" data-collection="${data.collectionName}">
                                    <span style="font-size:1.1em;">${data.collectionName}</span><br>
                                    <span style="font-size:0.9em;color:#888;">Code: ${data.collectionName}</span>
                                </button>`;
                            });
                            html += '</div>';
                            body.innerHTML = html;
                            // Add click handlers
                            body.querySelectorAll('button[data-collection]').forEach(btn => {
                                btn.onclick = function() {
                                    modal.hide();
                                    showMyToolsByCollection(this.getAttribute('data-collection'));
                                };
                            });
                        }
                        modal.show();
                    } catch (e) {
                        body.innerHTML = '<div class="text-center text-danger">Error loading collections.</div>';
                        modal.show();
                    }
                };
            } else {
                console.log('My Tools button not found');
            }
        });

        // Show My Tools by Collection screen
        async function showMyToolsByCollection(collectionName) {
            lastViewedCollectionName = collectionName;
            document.getElementById('toolScannerMenu').style.display = 'none';
            document.getElementById('appSection').style.display = 'none';
            document.getElementById('myToolsByCollectionScreen').style.display = 'block';
            document.getElementById('collectionCheckupScreen').style.display = 'none';
            const title = document.getElementById('myToolsCollectionTitle');
            const list = document.getElementById('myToolsByCollectionList');
            title.textContent = collectionName;
            list.innerHTML = '<div class="text-center">Loading...</div>';
            try {
                // Get tools in this collection owned by user
                const user = auth.currentUser;
                const fullName = localStorage.getItem('fullName') || user.email;
                const snapshot = await db.collection('tools')
                    .where('owner', '==', fullName)
                    .where('collectionCode', '==', collectionName)
                    .get();
                if (snapshot.empty) {
                    list.innerHTML = '<div class="text-center text-danger">No tools found in this collection.</div>';
                    lastViewedCollectionTools = [];
                    return;
                }
                // Group tools by location
                const tools = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                lastViewedCollectionTools = tools;
                const locations = [...new Set(tools.map(t => t.location || 'No Location'))];
                locations.sort();
                // OUT tools first, then IN, then others
                const getStatusOrder = status => {
                    if (!status) return 2;
                    const s = status.toUpperCase();
                    if (s === 'OUT') return 0;
                    if (s === 'IN') return 1;
                    return 2;
                };
                // Filtering state
                let selectedLocation = 'All';
                // Render location filter row (make sticky)
                let filterHtml = '<div id="locationFilterBar" style="display:flex;gap:8px;overflow-x:auto;position:sticky;top:0;z-index:10;background:#fff;padding:8px 0 8px 0;border-bottom:2px solid #FF9800;margin-bottom:10px;">';
                filterHtml += `<button class="btn btn-sm ${selectedLocation==='All'?'btn-orange':'btn-outline-secondary'}" data-location="All" style="${selectedLocation==='All'?'background-color:#FF9800;color:white;border-color:#FF9800;':'background-color:transparent;color:#6c757d;border-color:#6c757d;'}">All</button>`;
                locations.forEach(loc => {
                  filterHtml += `<button class="btn btn-sm ${selectedLocation===loc?'btn-orange':'btn-outline-secondary'}" data-location="${loc}" style="${selectedLocation===loc?'background-color:#FF9800;color:white;border-color:#FF9800;':'background-color:transparent;color:#6c757d;border-color:#6c757d;'}">${loc}</button>`;
                });
                filterHtml += '</div>';
                // Initial filtered tools
                let filteredTools = tools.slice();
                // Render function
                function renderToolsByLocation(selectedLoc) {
                    // Update the filter bar with new selected state
                    let filterHtml = '<div id="locationFilterBar" style="display:flex;gap:8px;overflow-x:auto;position:sticky;top:0;z-index:10;background:#fff;padding:8px 0 8px 0;border-bottom:2px solid #FF9800;margin-bottom:10px;">';
                    filterHtml += `<button class="btn btn-sm ${selectedLoc==='All'?'btn-orange':'btn-outline-secondary'}" data-location="All" style="${selectedLoc==='All'?'background-color:#FF9800;color:white;border-color:#FF9800;':'background-color:transparent;color:#6c757d;border-color:#6c757d;'}">All</button>`;
                    locations.forEach(loc => {
                      filterHtml += `<button class="btn btn-sm ${selectedLoc===loc?'btn-orange':'btn-outline-secondary'}" data-location="${loc}" style="${selectedLoc===loc?'background-color:#FF9800;color:white;border-color:#FF9800;':'background-color:transparent;color:#6c757d;border-color:#6c757d;'}">${loc}</button>`;
                    });
                    filterHtml += '</div>';
                    
                    let html = '';
                    const locs = selectedLoc === 'All' ? locations : [selectedLoc];
                    locs.forEach(loc => {
                        const toolsAtLoc = tools.filter(t => (t.location || 'No Location') === loc);
                        if (!toolsAtLoc.length) return;
                        html += `<div style="background:#FF9800;color:white;font-weight:bold;font-size:1.1em;padding:4px 12px;border-radius:6px 6px 0 0;position:sticky;top:0;z-index:5;">Location: ${loc} (Total: ${toolsAtLoc.length} tools)</div>`;
                        // OUT first, then IN, then others
                        const sorted = toolsAtLoc.slice().sort((a, b) => getStatusOrder(a.status) - getStatusOrder(b.status));
                        sorted.forEach((tool, idx) => {
                            const status = (tool.status || '').toUpperCase();
                            let bg = '#E8F5E9';
                            let statusColor = '#388E3C';
                            if (status === 'OUT') { bg = '#FFEBEE'; statusColor = '#d32f2f'; }
                            else if (status === 'BROKEN') { bg = '#FFF3E0'; statusColor = '#ff6f00'; }
                            else if (status === 'LOST') { bg = '#FFE0B2'; statusColor = '#ff8f00'; }
                            else if (status === 'CALIBRATION') { bg = '#E3F2FD'; statusColor = '#1976d2'; }
                            html += `<div style="background:${bg};border-radius:0 0 6px 6px;margin-bottom:8px;padding:12px 12px 8px 12px;">
                                <span style="font-weight:bold;font-size:1.13rem;color:#1976d2;">${idx + 1}. ${tool.toolName || 'Unknown Tool'}</span> - <span style="font-weight:bold;">TID: ${tool.id}</span><br>
                                <span style="font-size:1.01rem;color:#444;">Part #: ${tool.partNumber || ''}</span><br>
                                <span style="font-weight:bold;color:${statusColor};">Status: ${tool.status || ''}</span><br>
                                <span style="font-size:1.01rem;color:#222;">Location: ${tool.location || ''}</span>
                            </div>`;
                        });
                    });
                    list.innerHTML = filterHtml + `<div style="height:calc(100vh - 300px);overflow-y:auto;padding-right:5px;">` + html + `</div>`;
                    // Add event listeners for filter buttons
                    list.querySelectorAll('button[data-location]').forEach(btn => {
                        btn.onclick = function() {
                            selectedLocation = this.getAttribute('data-location');
                            renderToolsByLocation(selectedLocation);
                        };
                    });
                }
                renderToolsByLocation(selectedLocation);
            } catch (e) {
                title.textContent = collectionName;
                list.innerHTML = '<div class="text-center text-danger">Error loading tools.</div>';
                lastViewedCollectionTools = [];
            }
        }
        // Back button for My Tools by Collection
        const backToCollectionSelectBtn = document.getElementById('backToCollectionSelectBtn');
        if (backToCollectionSelectBtn) {
            backToCollectionSelectBtn.textContent = 'Back to Menu';
            backToCollectionSelectBtn.onclick = function() {
                document.getElementById('myToolsByCollectionScreen').style.display = 'none';
                document.getElementById('toolScannerMenu').style.display = 'block';
            };
        }

        // Show notifications in sequence, not simultaneously
        async function showNotificationsInSequence() {
            let outstandingNeeded = false;
            let overdueNeeded = false;
            let outstandingMsg = '';
            let overdueMsg = '';

            const user = auth.currentUser;
            if (user && await isAfterNotificationTime()) {
                const fullName = localStorage.getItem('fullName') || user.email;
                const now = new Date();
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                // Query all OUT tools for this user as owner
                const snapshot = await db.collection('tools')
                    .where('owner', '==', fullName)
                    .where('status', '==', 'OUT')
                    .get();
                let ownerToday = 0;
                let ownerPrev = 0;
                let techToolIds = new Set();
                // Also collect tool IDs where user is technician for later
                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    // Only count if technician is NOT the owner
                    if (data.technician !== fullName) {
                        if (data.timestamp && data.timestamp.toDate) {
                            const outTime = data.timestamp.toDate();
                            if (outTime >= today) {
                                ownerToday++;
                            } else {
                                ownerPrev++;
                            }
                        }
                    } else {
                        techToolIds.add(doc.id);
                    }
                });
                if (ownerToday > 0 || ownerPrev > 0) {
                    outstandingNeeded = true;
                    outstandingMsg = '<b>ACTION REQUIRED:</b> THE FOLLOWING TOOLS YOU OWN ARE STILL CHECKED OUT BY OTHERS.';
                    if (ownerToday > 0) outstandingMsg += `<br>- <b>${ownerToday}</b> TOOL${ownerToday > 1 ? 'S' : ''} CHECKED OUT TODAY.`;
                    if (ownerPrev > 0) outstandingMsg += `<br>- <b>${ownerPrev}</b> TOOL${ownerPrev > 1 ? 'S' : ''} CHECKED OUT FROM PREVIOUS DATES.`;
                    outstandingMsg += '<br>PLEASE FOLLOW UP TO ENSURE THESE TOOLS ARE RETURNED.';
                }
                // Now check as technician, count all tools where user is technician (regardless of owner)
                const technicianDoc = await db.collection('technicians').doc(user.uid).get();
                const technicianName = technicianDoc.exists ? technicianDoc.data().fullName : 'UNKNOWN TECHNICIAN';
                const techSnapshot = await db.collection('tools')
                    .where('technician', '==', technicianName)
                    .where('status', '==', 'OUT')
                    .get();
                let techToday = 0;
                let techPrev = 0;
                techSnapshot.docs.forEach(doc => {
                    const data = doc.data();
                    if (data.timestamp && data.timestamp.toDate) {
                        const outTime = data.timestamp.toDate();
                        if (outTime >= today) {
                            techToday++;
                        } else {
                            techPrev++;
                        }
                    }
                });
                if (techToday > 0 || techPrev > 0) {
                    overdueNeeded = true;
                    overdueMsg = '<b>REMINDER:</b> YOU HAVE TOOLS CHECKED OUT THAT NEED TO BE RETURNED.';
                    if (techToday > 0) overdueMsg += `<br>- <b>${techToday}</b> TOOL${techToday > 1 ? 'S' : ''} CHECKED OUT TODAY.`;
                    if (techPrev > 0) overdueMsg += `<br>- <b>${techPrev}</b> TOOL${techPrev > 1 ? 'S' : ''} CHECKED OUT FROM PREVIOUS DATES.`;
                    overdueMsg += '<br>PLEASE RETURN THESE TOOLS AS SOON AS POSSIBLE.';
                }
            }
            // Show modals in sequence
            if (outstandingNeeded) {
                document.getElementById('outstandingToolsBody').innerHTML = outstandingMsg;
                const outstandingModal = new bootstrap.Modal(document.getElementById('outstandingToolsModal'));
                document.querySelector('#outstandingToolsModal .btn-primary').onclick = function() {
                    outstandingModal.hide();
                    if (overdueNeeded) {
                        setTimeout(() => {
                            document.getElementById('outToolsNotifBody').innerHTML = overdueMsg;
                            const notifModal = new bootstrap.Modal(document.getElementById('outToolsNotifModal'));
                            notifModal.show();
                        }, 300);
                    }
                };
                outstandingModal.show();
            } else if (overdueNeeded) {
                document.getElementById('outToolsNotifBody').innerHTML = overdueMsg;
                const notifModal = new bootstrap.Modal(document.getElementById('outToolsNotifModal'));
                notifModal.show();
            }
        }

        // Helper to check if current time is after notificationTime (HH:mm)
        async function isAfterNotificationTime() {
            try {
                const settingsDoc = await db.collection('settings').doc('admin').get();
                if (settingsDoc.exists && settingsDoc.data().notificationTime) {
                    const [notifHour, notifMin] = settingsDoc.data().notificationTime.split(':').map(Number);
                    const now = new Date();
                    const notifTime = new Date(now);
                    notifTime.setHours(notifHour, notifMin, 0, 0);
                    return now >= notifTime;
                }
            } catch (e) {
                console.error('Error fetching notification time:', e);
            }
            // If missing or error, do nothing (return false)
            return false;
        }

        // Fetch and update previous OUT tools count for the tab
        async function updatePreviousToolsTabCount() {
            const user = auth.currentUser;
            if (!user) return;
            const technicianDoc = await db.collection('technicians').doc(user.uid).get();
            const technicianName = technicianDoc.exists ? technicianDoc.data().fullName : 'Unknown Technician';
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const snapshot = await db.collection('tools')
                .where('technician', '==', technicianName)
                .where('status', '==', 'OUT')
                .get();
            const previousTools = snapshot.docs.filter(doc => {
                const data = doc.data();
                return data.timestamp && data.timestamp.toDate() < today;
            });
            document.getElementById('previous-tab').innerHTML = `<i class="fas fa-history"></i> Previous Tools (${previousTools.length})`;
        }

        // After login or on auth state change, update the logged-in technician display
        function updateLoggedInTechnician() {
            const user = auth.currentUser;
            if (!user) return;
            const fullName = localStorage.getItem('fullName') || user.email;
            document.getElementById('loggedInTechnician').textContent = `Logged in as: ${fullName} (${user.email})`;
            // Update previous OUT tools count
            updatePreviousOutToolsCount();
        }

        if ('serviceWorker' in navigator) {
          navigator.serviceWorker.register('service-worker.js')
            .then(function(reg) {
              // Registration successful
            })
            .catch(function(error) {
              // Registration failed
              console.error('ServiceWorker registration failed:', error);
            });
        }

        // Collection Checkup logic
        const collectionCheckupBtn = document.getElementById('collectionCheckupBtn');
        if (collectionCheckupBtn) {
            collectionCheckupBtn.onclick = function() {
                showCollectionCheckupScreen();
            };
        }

        // Select Different Collection logic
        const selectDifferentCollectionBtn = document.getElementById('selectDifferentCollectionBtn');
        if (selectDifferentCollectionBtn) {
            selectDifferentCollectionBtn.onclick = function() {
                showCollectionSelectionDialog();
            };
        }

        async function showCollectionSelectionDialog() {
            const user = auth.currentUser;
            if (!user) return;
            const fullName = localStorage.getItem('fullName') || user.email;
            console.log('WebApp: Querying tools for owner:', fullName);
            const modal = new bootstrap.Modal(document.getElementById('collectionSelectModal'));
            const body = document.getElementById('collectionSelectBody');
            body.innerHTML = '<div class="text-center">Loading...</div>';
            try {
                // 1. Query tools for this owner
                const toolsSnapshot = await db.collection('tools').where('owner', '==', fullName).get();
                if (toolsSnapshot.empty) {
                    body.innerHTML = '<div class="text-center text-danger">No tools found for you.</div>';
                    modal.show();
                    return;
                }
                // 2. Extract unique collectionCodes
                const collectionCodes = [...new Set(toolsSnapshot.docs.map(doc => doc.data().collectionCode).filter(Boolean))];
                if (collectionCodes.length === 0) {
                    body.innerHTML = '<div class="text-center text-danger">No collections found for your tools.</div>';
                    modal.show();
                    return;
                }
                // 3. Query collections for those codes (batch if >10)
                let collections = [];
                if (collectionCodes.length <= 10) {
                  const colSnap = await db.collection('collections').where('collectionName', 'in', collectionCodes).get();
                  collections = colSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        } else {
                  // Firestore 'in' query limit is 10, so batch if needed
                  for (let i = 0; i < collectionCodes.length; i += 10) {
                    const batch = collectionCodes.slice(i, i + 10);
                    const colSnap = await db.collection('collections').where('collectionName', 'in', batch).get();
                    collections = collections.concat(colSnap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                  }
                }
                if (collections.length === 0) {
                    body.innerHTML = '<div class="text-center text-danger">No collections found for your tools.</div>';
                } else {
                    let html = '<div class="list-group">';
                    collections.forEach(data => {
                        const isCurrentCollection = data.collectionName === lastViewedCollectionName;
                        html += `<button class="list-group-item list-group-item-action ${isCurrentCollection ? 'active' : ''}" style="font-weight:bold;color:${isCurrentCollection ? 'white' : '#1976d2'};" data-collection="${data.collectionName}">
                            <span style="font-size:1.1em;">${data.collectionName}</span><br>
                            <span style="font-size:0.9em;color:${isCurrentCollection ? 'rgba(255,255,255,0.8)' : '#888'};">
                                ${isCurrentCollection ? 'Current Collection' : 'Code: ' + data.collectionName}
                            </span>
                        </button>`;
                    });
                    html += '</div>';
                    body.innerHTML = html;
                    // Add click handlers
                    body.querySelectorAll('button[data-collection]').forEach(btn => {
                        btn.onclick = function() {
                            modal.hide();
                            showMyToolsByCollection(this.getAttribute('data-collection'));
                        };
                    });
                }
                modal.show();
            } catch (e) {
                body.innerHTML = '<div class="text-center text-danger">Error loading collections.</div>';
                modal.show();
            }
        }

        function showCollectionCheckupScreen() {
            document.getElementById('myToolsByCollectionScreen').style.display = 'none';
            document.getElementById('collectionCheckupScreen').style.display = 'block';
            
            // Reset checkup state
            checkupCheckedTools = new Set();
            checkupSelectedLocation = 'All';
            
            const title = document.getElementById('checkupCollectionTitle');
            title.textContent = lastViewedCollectionName;
            
            if (!lastViewedCollectionTools.length) {
                document.getElementById('checkupToolsList').innerHTML = '<div class="text-center text-danger">No tools found for checkup.</div>';
                document.getElementById('checkupActionButtons').style.display = 'none';
                return;
            }
            
            // Show action buttons
            document.getElementById('checkupActionButtons').style.display = 'block';
            
            // Render tools and location filter
            renderCheckupTools();
            renderCheckupLocationFilter();
            updateCheckupProgress();
        }

        function renderCheckupTools() {
            const list = document.getElementById('checkupToolsList');
            const tools = lastViewedCollectionTools;
            
            // Filter tools by selected location
            const filteredTools = checkupSelectedLocation === 'All' 
                ? tools 
                : tools.filter(t => (t.location || 'No Location') === checkupSelectedLocation);
            
            if (filteredTools.length === 0) {
                list.innerHTML = '<div class="text-center text-muted">No tools in selected location.</div>';
                return;
            }
            
            let html = '';
            filteredTools.forEach((tool, index) => {
                const isChecked = checkupCheckedTools.has(tool.id);
                const status = (tool.status || '').toUpperCase();
                
                // Determine background color based on status and checked state
                let bgColor = '#f5f5f5'; // Default gray
                if (isChecked) {
                    bgColor = '#e8f5e8'; // Light green for checked
                } else if (status === 'OUT') {
                    bgColor = '#ffebee'; // Light red for out
                } else if (status === 'BROKEN') {
                    bgColor = '#fff3e0'; // Light orange for broken
                } else if (status === 'LOST') {
                    bgColor = '#ffe0b2'; // Light amber for lost
                } else if (status === 'CALIBRATION') {
                    bgColor = '#e3f2fd'; // Light blue for calibration
                }
                
                html += `
                    <div class="card mb-2" style="background-color: ${bgColor}; border: 1px solid #ddd;">
                        <div class="card-body p-3">
                            <div class="row align-items-center">
                                <div class="col-auto">
                                    <input type="checkbox" class="form-check-input" id="checkupTool${tool.id}" 
                                           ${isChecked ? 'checked' : ''} 
                                           onchange="toggleCheckupTool('${tool.id}', this.checked)"
                                           style="transform: scale(1.2);">
                                </div>
                                <div class="col">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <h6 class="mb-1"><strong>${index + 1}. ${tool.toolName || 'Unknown Tool'}</strong></h6>
                                            <div class="text-muted small">Part #: ${tool.partNumber || 'N/A'}</div>
                                            <div class="text-muted small">Location: ${tool.location || 'No Location'}</div>
                                            <div class="small">
                                                <strong>Status: </strong>
                                                <span style="color: ${getStatusColor(status)};">${tool.status || 'N/A'}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            list.innerHTML = html;
        }

        function renderCheckupLocationFilter() {
            const tools = lastViewedCollectionTools;
            const locations = ['All', ...new Set(tools.map(t => t.location || 'No Location'))].sort();
            
            let html = '';
            locations.forEach(loc => {
                const isSelected = checkupSelectedLocation === loc;
                html += `
                    <button class="btn btn-sm ${isSelected ? 'btn-orange' : 'btn-outline-secondary'}" 
                            onclick="selectCheckupLocation('${loc}')"
                            style="${isSelected ? 'background-color:#FF9800;color:white;border-color:#FF9800;' : 'background-color:transparent;color:#6c757d;border-color:#6c757d;'}">
                        ${loc}
                    </button>
                `;
            });
            
            document.getElementById('checkupLocationButtons').innerHTML = html;
        }

        function selectCheckupLocation(location) {
            checkupSelectedLocation = location;
            renderCheckupTools();
            renderCheckupLocationFilter();
            updateCheckupProgress();
        }

        function toggleCheckupTool(toolId, checked) {
            if (checked) {
                checkupCheckedTools.add(toolId);
            } else {
                checkupCheckedTools.delete(toolId);
            }
            updateCheckupProgress();
        }

        function updateCheckupProgress() {
            const totalTools = lastViewedCollectionTools.length;
            const checkedCount = checkupCheckedTools.size;
            document.getElementById('checkupProgress').textContent = `${checkedCount}/${totalTools}`;
        }

        // Select All functionality
        document.getElementById('selectAllBtn').onclick = function() {
            const tools = checkupSelectedLocation === 'All' 
                ? lastViewedCollectionTools 
                : lastViewedCollectionTools.filter(t => (t.location || 'No Location') === checkupSelectedLocation);
            
            tools.forEach(tool => {
                checkupCheckedTools.add(tool.id);
            });
            
            renderCheckupTools();
            updateCheckupProgress();
        };

        // Show Results functionality
        document.getElementById('showResultsBtn').onclick = function() {
            showCheckupResults();
        };

        function showCheckupResults() {
            const tools = lastViewedCollectionTools;
            const totalTools = tools.length;
            const checkedCount = checkupCheckedTools.size;
            const uncheckedCount = totalTools - checkedCount;
            
            // Calculate location stats
            const locationStats = {};
            const locations = [...new Set(tools.map(t => t.location || 'No Location'))];
            locations.forEach(loc => {
                const locationTools = tools.filter(t => (t.location || 'No Location') === loc);
                const locationChecked = locationTools.filter(t => checkupCheckedTools.has(t.id)).length;
                locationStats[loc] = {
                    total: locationTools.length,
                    checked: locationChecked,
                    unchecked: locationTools.length - locationChecked
                };
            });
            
            let html = `
                <div class="mb-4">
                    <h6><strong>Overall Summary:</strong></h6>
                    <div class="row">
                        <div class="col-4">
                            <div class="text-center">
                                <div class="h4 text-primary">${totalTools}</div>
                                <small class="text-muted">Total Tools</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="text-center">
                                <div class="h4 text-success">${checkedCount}</div>
                                <small class="text-muted">Checked</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="text-center">
                                <div class="h4 text-warning">${uncheckedCount}</div>
                                <small class="text-muted">Unchecked</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div>
                    <h6><strong>By Location:</strong></h6>
        `;
        
        Object.entries(locationStats).forEach(([location, stats]) => {
            html += `
                <div class="card mb-2">
                    <div class="card-body p-3">
                        <h6 class="card-title">${location}</h6>
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="text-primary">${stats.total}</div>
                                <small class="text-muted">Total</small>
                            </div>
                            <div class="col-4">
                                <div class="text-success">${stats.checked}</div>
                                <small class="text-muted">Checked</small>
                            </div>
                            <div class="col-4">
                                <div class="text-warning">${stats.unchecked}</div>
                                <small class="text-muted">Unchecked</small>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        
        document.getElementById('checkupResultsContent').innerHTML = html;
        
        const modal = new bootstrap.Modal(document.getElementById('checkupResultsModal'));
        modal.show();
    }

    // Save Results functionality
    document.getElementById('saveCheckupResultsBtn').onclick = function() {
        saveCheckupResults();
    };

    async function saveCheckupResults() {
        const tools = lastViewedCollectionTools;
        const totalTools = tools.length;
        const checkedCount = checkupCheckedTools.size;
        const uncheckedCount = totalTools - checkedCount;
        
        // Calculate location stats
        const locationStats = {};
        const locations = [...new Set(tools.map(t => t.location || 'No Location'))];
        locations.forEach(loc => {
            const locationTools = tools.filter(t => (t.location || 'No Location') === loc);
            const locationChecked = locationTools.filter(t => checkupCheckedTools.has(t.id)).length;
            locationStats[loc] = {
                total: locationTools.length,
                checked: locationChecked,
                unchecked: locationTools.length - locationChecked
            };
        });
        
        try {
            const user = auth.currentUser;
            const fullName = localStorage.getItem('fullName') || user.email;
            
            const checkupData = {
                technicianName: fullName,
                collectionCode: lastViewedCollectionName,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                totalTools: totalTools,
                checkedTools: checkedCount,
                uncheckedTools: uncheckedCount,
                locationStats: locationStats,
                checkedToolIds: Array.from(checkupCheckedTools),
                allToolIds: tools.map(t => t.id),
                checkupDate: new Date().toLocaleString('en-GB')
            };
            
            // Create custom document ID
            const technicianNameWithoutSpaces = fullName.replace(/\s+/g, '');
            const timestamp = new Date();
            const timestampString = timestamp.toLocaleString('en-GB', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            }).replace(/[/:]/g, '').replace(/\s+/g, '-');
            
            const documentId = `${technicianNameWithoutSpaces}_${timestampString}`;
            
            await db.collection('checkupResults').doc(documentId).set(checkupData);
            
            // Close results modal and show success modal
            const resultsModal = bootstrap.Modal.getInstance(document.getElementById('checkupResultsModal'));
            resultsModal.hide();
            
            const successModal = new bootstrap.Modal(document.getElementById('checkupSaveSuccessModal'));
            successModal.show();
            
        } catch (error) {
            console.error('Error saving checkup results:', error);
            alert('Error saving checkup results: ' + error.message);
        }
    }

    // History button (placeholder for now)
    document.getElementById('checkupHistoryBtn').onclick = function() {
        alert('Checkup history feature coming soon!');
    };

    function getStatusColor(status) {
        switch (status) {
            case 'OUT': return '#d32f2f';
            case 'BROKEN': return '#ff6f00';
            case 'LOST': return '#ff8f00';
            case 'CALIBRATION': return '#1976d2';
            default: return '#388e3c';
        }
    }

    document.getElementById('backToMyToolsByCollectionBtn').onclick = function() {
        document.getElementById('collectionCheckupScreen').style.display = 'none';
        document.getElementById('myToolsByCollectionScreen').style.display = 'block';
    };

    // Previous OUT Tools functionality
    document.getElementById('menuOutBtn').onclick = function() {
        showPreviousOutTools();
    };

    // Back button for Previous OUT Tools
    document.getElementById('backToMenuFromOutToolsBtn').onclick = function() {
        document.getElementById('previousOutToolsScreen').style.display = 'none';
        document.getElementById('toolScannerMenu').style.display = 'block';
    };

    // Variables for previous OUT tools
    let previousOutToolsCount = 0;
    let previousOutToolsData = [];

    // Function to fetch and update previous OUT tools count
    async function updatePreviousOutToolsCount() {
        const user = auth.currentUser;
        if (!user) return;
        
        const fullName = localStorage.getItem('fullName') || user.email;
        try {
            const snapshot = await db.collection('tools')
                .where('technician', '==', fullName)
                .where('status', '==', 'OUT')
                .get();
            
            if (!snapshot.empty) {
                // Get today's start time
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                // Filter tools from previous days
                const previousTools = snapshot.docs.filter(doc => {
                    const timestamp = doc.data().timestamp;
                    if (timestamp && timestamp.toDate) {
                        const toolDate = timestamp.toDate();
                        return toolDate < today;
                    }
                    return false;
                });
                
                previousOutToolsCount = previousTools.length;
                previousOutToolsData = previousTools.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // Update button text with count
                const menuOutBtn = document.getElementById('menuOutBtn');
                if (menuOutBtn) {
                    menuOutBtn.innerHTML = `<i class="fas fa-sign-out-alt"></i> View OUT Tools (${previousOutToolsCount})`;
                    menuOutBtn.disabled = previousOutToolsCount === 0;
                }
            } else {
                previousOutToolsCount = 0;
                previousOutToolsData = [];
                const menuOutBtn = document.getElementById('menuOutBtn');
                if (menuOutBtn) {
                    menuOutBtn.innerHTML = `<i class="fas fa-sign-out-alt"></i> View OUT Tools (0)`;
                    menuOutBtn.disabled = true;
                }
            }
        } catch (error) {
            console.error('Error fetching previous OUT tools count:', error);
            previousOutToolsCount = 0;
            previousOutToolsData = [];
        }
    }

    async function showPreviousOutTools() {
        const user = auth.currentUser;
        if (!user) return;
        
        // Hide other screens and show previous OUT tools screen
        document.getElementById('toolScannerMenu').style.display = 'none';
        document.getElementById('appSection').style.display = 'none';
        document.getElementById('myToolsScreen').style.display = 'none';
        document.getElementById('myToolsByCollectionScreen').style.display = 'none';
        document.getElementById('collectionCheckupScreen').style.display = 'none';
        document.getElementById('previousOutToolsScreen').style.display = 'block';
        
        const previousOutToolsList = document.getElementById('previousOutToolsList');
        
        if (previousOutToolsData.length === 0) {
            previousOutToolsList.innerHTML = '<div class="text-center text-muted">No previous OUT tools found.</div>';
            return;
        }
        
        // Sort tools by timestamp (newest first)
        const sortedTools = previousOutToolsData.sort((a, b) => {
            const timestampA = a.timestamp ? a.timestamp.toDate() : new Date(0);
            const timestampB = b.timestamp ? b.timestamp.toDate() : new Date(0);
            return timestampB - timestampA;
        });
        
        let html = '';
        sortedTools.forEach((tool, index) => {
            const status = (tool.status || '').toUpperCase();
            const statusClass = status.toLowerCase();
            
            // Format timestamp
            const formattedDate = tool.timestamp ? tool.timestamp.toDate().toLocaleString('en-GB', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            }) : 'Unknown';
            
            html += `
                <div class="previous-out-tool-card ${statusClass}" onclick="showPreviousOutToolDetails('${tool.id}')">
                    <div class="previous-out-tool-name">${index + 1}. ${tool.toolName || 'Unknown Tool'}</div>
                    <div class="previous-out-tool-date">${formattedDate}</div>
                    <div class="previous-out-tool-row">
                        <div class="previous-out-tool-column">
                            <div class="previous-out-tool-label">TID</div>
                            <div class="previous-out-tool-value">${tool.id}</div>
                        </div>
                        <div class="previous-out-tool-column">
                            <div class="previous-out-tool-label">P/N</div>
                            <div class="previous-out-tool-value">${tool.partNumber || 'N/A'}</div>
                        </div>
                        <div class="previous-out-tool-column">
                            <div class="previous-out-tool-label">STS</div>
                            <div class="previous-out-tool-status">${status}</div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        previousOutToolsList.innerHTML = html;
    }

    async function showPreviousOutToolDetails(toolId) {
        const tool = previousOutToolsData.find(t => t.id === toolId);
        if (!tool) {
            alert('Tool not found.');
            return;
        }
        
        const formattedDate = tool.timestamp ? tool.timestamp.toDate().toLocaleString('en-GB', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false
        }) : 'Unknown';
        
        const previousOutToolDetailsContent = document.getElementById('previousOutToolDetailsContent');
        previousOutToolDetailsContent.innerHTML = `
            <div class="mb-2"><strong>Tool Name:</strong> ${tool.toolName || 'Unknown Tool'}</div>
            <div class="mb-2"><strong>Tool ID:</strong> ${tool.id}</div>
            <div class="mb-2"><strong>Part Number:</strong> ${tool.partNumber || 'N/A'}</div>
            <div class="mb-2">
                <strong>Collection:</strong> 
                <span style="color: #1976d2; font-weight: bold; text-decoration: underline; cursor: pointer;" 
                      onclick="navigateToCollection('${tool.collectionCode || ''}')">
                    ${tool.collectionCode || 'N/A'}
                </span>
            </div>
            <div class="mb-2"><strong>Checked Out:</strong> ${formattedDate}</div>
            ${tool.photoUrls && tool.photoUrls.length > 0 ? `
                <div class="mb-2">
                    <strong style="color: #1976d2; text-decoration: underline; cursor: pointer;" 
                            onclick="showPreviousOutPhotos('${toolId}')">
                        Photos (${tool.photoUrls.length})
                    </strong>
                </div>
            ` : ''}
        `;
        
        const modal = new bootstrap.Modal(document.getElementById('previousOutToolDetailsModal'));
        modal.show();
    }

    function navigateToCollection(collectionCode) {
        if (collectionCode && collectionCode !== 'N/A') {
            // Close the current modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('previousOutToolDetailsModal'));
            modal.hide();
            
            // Navigate to the collection
            showMyToolsByCollection(collectionCode);
        }
    }

    async function showPreviousOutPhotos(toolId) {
        const tool = previousOutToolsData.find(t => t.id === toolId);
        if (!tool || !tool.photoUrls || tool.photoUrls.length === 0) {
            alert('No photos available for this tool.');
            return;
        }
        
        const previousOutPhotoViewerContent = document.getElementById('previousOutPhotoViewerContent');
        let currentPhotoIndex = 0;
        
        function updatePhotoDisplay() {
            previousOutPhotoViewerContent.innerHTML = `
                <img src="${tool.photoUrls[currentPhotoIndex]}" class="img-fluid" alt="Tool Photo ${currentPhotoIndex + 1}" style="max-height: 60vh;">
            `;
            document.getElementById('previousOutPhotoCounter').textContent = `${currentPhotoIndex + 1} / ${tool.photoUrls.length}`;
            
            // Update button states
            document.getElementById('previousOutPhotoPrevBtn').disabled = currentPhotoIndex === 0;
            document.getElementById('previousOutPhotoNextBtn').disabled = currentPhotoIndex === tool.photoUrls.length - 1;
        }
        
        // Set up navigation buttons
        document.getElementById('previousOutPhotoPrevBtn').onclick = function() {
            if (currentPhotoIndex > 0) {
                currentPhotoIndex--;
                updatePhotoDisplay();
            }
        };
        
        document.getElementById('previousOutPhotoNextBtn').onclick = function() {
            if (currentPhotoIndex < tool.photoUrls.length - 1) {
                currentPhotoIndex++;
                updatePhotoDisplay();
            }
        };
        
        updatePhotoDisplay();
        
        const modal = new bootstrap.Modal(document.getElementById('previousOutPhotoViewerModal'));
        modal.show();
    }

    // Add this after DOMContentLoaded or at the end of the script
    document.addEventListener('DOMContentLoaded', function() {
        var collectionCancelBtn = document.querySelector('#collectionSelectModal .btn-secondary[data-bs-dismiss="modal"]');
        if (collectionCancelBtn) {
            collectionCancelBtn.onclick = function() {
                // Let Bootstrap close the modal, then show the menu
                setTimeout(function() {
                    showToolScannerMenu();
                }, 300); // Wait for modal animation
            };
        }
    });

    async function showCollectionDetails(collectionCode) {
        if (!collectionCode) return;
        // Hide all main screens
        document.getElementById('toolScannerMenu').style.display = 'none';
        document.getElementById('appSection').style.display = 'none';
        document.getElementById('collectionDetailsScreen').style.display = 'block';
        
        // Force-hide the tool details modal and remove any modal backdrop
        const toolDetailsModalEl = document.getElementById('toolDetailsModal');
        if (toolDetailsModalEl) {
            toolDetailsModalEl.classList.remove('show');
            toolDetailsModalEl.style.display = 'none';
            toolDetailsModalEl.setAttribute('aria-hidden', 'true');
            toolDetailsModalEl.removeAttribute('aria-modal');
            toolDetailsModalEl.removeAttribute('role');
        }
        // Remove any modal-backdrop
        document.querySelectorAll('.modal-backdrop').forEach(el => el.parentNode.removeChild(el));
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';

        const content = document.getElementById('collectionDetailsContent');
        content.innerHTML = '<div class="text-center">Loading collection details...</div>';
        
        try {
            // Query collections collection where collectionName matches the collectionCode from tools
            const querySnapshot = await db.collection('collections').where('collectionName', '==', collectionCode).get();
            if (querySnapshot.empty) {
                content.innerHTML = `<div class="text-center text-danger">Collection not found.</div>`;
            } else {
                const doc = querySnapshot.docs[0]; // Get the first matching document
                const data = doc.data();
                let html = `<div class="card mb-4">
                    <div class="card-body">
                        <h4 class="card-title mb-3">${data.collectionName || collectionCode}</h4>`;
                if (data.description) html += `<p class="card-text"><strong>Description:</strong> ${data.description}</p>`;
                if (data.owner) html += `<p class="card-text"><strong>Owner:</strong> ${data.owner}</p>`;
                html += `</div></div>`;
                
                if (data.photoUrls && Array.isArray(data.photoUrls) && data.photoUrls.length > 0) {
                    html += `<h5 class="mb-3">Photos</h5><div class="row">`;
                    data.photoUrls.forEach(url => {
                        html += `<div class="col-6 col-md-4 col-lg-3 mb-3">
                            <img src="${url}" alt="Collection Photo" class="img-fluid rounded shadow" style="width: 100%; height: 200px; object-fit: cover;">
                        </div>`;
                    });
                    html += `</div>`;
                } else {
                    html += `<div class="text-center text-muted"><em>No photos available for this collection.</em></div>`;
                }
                content.innerHTML = html;
            }
        } catch (error) {
            content.innerHTML = `<div class="text-center text-danger">Error loading collection details: ${error.message}</div>`;
        }
    }

    // Back button for Collection Details screen
    document.getElementById('backToRegisterToolsBtn').onclick = function() {
        document.getElementById('collectionDetailsScreen').style.display = 'none';
        // Re-show the tool details modal
        const modal = new bootstrap.Modal(document.getElementById('toolDetailsModal'));
        modal.show();
    };

    // Function to show tool list and hide collection details
    function showToolList() {
        const toolList = document.getElementById('toolList');
        const collectionDetailsContainer = document.getElementById('collectionDetailsContainer');
        
        if (collectionDetailsContainer) {
            collectionDetailsContainer.style.display = 'none';
        }
        toolList.style.display = 'block';
    }

    // Back button for Collection Details full page screen
    document.getElementById('backToRegisterToolsBtn').onclick = function() {
        // Hide collection details screen
        document.getElementById('collectionDetailsScreen').style.display = 'none';
        // Force-hide the tool details modal and remove any modal backdrop
        const toolDetailsModalEl = document.getElementById('toolDetailsModal');
        if (toolDetailsModalEl) {
            toolDetailsModalEl.classList.remove('show');
            toolDetailsModalEl.style.display = 'none';
            toolDetailsModalEl.setAttribute('aria-hidden', 'true');
            toolDetailsModalEl.removeAttribute('aria-modal');
            toolDetailsModalEl.removeAttribute('role');
        }
        document.querySelectorAll('.modal-backdrop').forEach(el => el.parentNode.removeChild(el));
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
        // Show Register Tools screen and reload tool list
        showRegisterTools();
    };

    // Add the showToolPhotoGallery function
    function showToolPhotoGallery(el) {
        const photoUrls = JSON.parse(el.getAttribute('data-photo-urls'));
        if (!photoUrls || photoUrls.length === 0) return;
        let currentPhotoIndex = 0;
        const galleryContent = document.getElementById('toolPhotoGalleryContent');
        const counter = document.getElementById('toolPhotoCounter');
        const prevBtn = document.getElementById('toolPhotoPrevBtn');
        const nextBtn = document.getElementById('toolPhotoNextBtn');
        function updatePhoto() {
            galleryContent.innerHTML = `<img src="${photoUrls[currentPhotoIndex]}" class="img-fluid rounded shadow" style="max-height:80vh;max-width:100vw;object-fit:contain;">`;
            counter.textContent = `${currentPhotoIndex + 1} / ${photoUrls.length}`;
            prevBtn.disabled = currentPhotoIndex === 0;
            nextBtn.disabled = currentPhotoIndex === photoUrls.length - 1;
        }
        prevBtn.onclick = function() {
            if (currentPhotoIndex > 0) {
                currentPhotoIndex--;
                updatePhoto();
            }
        };
        nextBtn.onclick = function() {
            if (currentPhotoIndex < photoUrls.length - 1) {
                currentPhotoIndex++;
                updatePhoto();
            }
        };
        updatePhoto();
        const modal = new bootstrap.Modal(document.getElementById('toolPhotoGalleryModal'));
        modal.show();
    }
    </script>
</body>
</html> 
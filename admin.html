<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tool Administrator - AMS Tool Tracking</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }

        /* Login Screen Styles */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .login-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 450px;
            width: 100%;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-header i {
            font-size: 4rem;
            color: #667eea;
            margin-bottom: 10px;
        }

        .login-header h2 {
            color: #333;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .login-header p {
            color: #666;
            font-size: 0.95rem;
        }

        .form-control {
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            padding: 12px 15px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }

        .btn-login {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 10px;
            padding: 12px;
            font-size: 1.1rem;
            font-weight: bold;
            color: white;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .btn-login:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
            color: white;
        }

        .btn-google {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 12px;
            font-size: 1rem;
            font-weight: bold;
            color: #666;
            transition: all 0.2s ease;
        }

        .btn-google:hover {
            border-color: #4285f4;
            color: #4285f4;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(66, 133, 244, 0.2);
        }

        .divider {
            text-align: center;
            margin: 20px 0;
            position: relative;
        }

        .divider::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            width: 40%;
            height: 1px;
            background: #e0e0e0;
        }

        .divider::after {
            content: '';
            position: absolute;
            right: 0;
            top: 50%;
            width: 40%;
            height: 1px;
            background: #e0e0e0;
        }

        .divider span {
            background: white;
            padding: 0 10px;
            color: #999;
            font-size: 0.9rem;
        }

        /* Admin Dashboard Styles */
        .admin-dashboard {
            display: none;
            background: #f5f7fa;
            min-height: 100vh;
        }

        .admin-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .admin-header h1 {
            margin: 0;
            font-size: 1.8rem;
            font-weight: bold;
        }

        .admin-welcome {
            font-size: 1rem;
            opacity: 0.9;
        }

        .admin-content {
            padding: 30px 0;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            margin-bottom: 20px;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
        }

        .stat-card .icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }

        .stat-card h3 {
            font-size: 2rem;
            font-weight: bold;
            margin: 10px 0;
        }

        .stat-card p {
            color: #666;
            margin: 0;
            font-size: 1rem;
        }

        .admin-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
        }

        .admin-card h4 {
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        /* Animated Push Buttons */
        .nav-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 15px;
            padding: 20px 30px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
            margin: 10px;
        }

        .nav-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .nav-button:active {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
        }

        .nav-button.active {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
        }

        .nav-button i {
            margin-right: 10px;
            font-size: 1.2rem;
        }

        .nav-button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .nav-button:hover::before {
            width: 300px;
            height: 300px;
        }

        .nav-buttons-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
        }

        .section-content {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }

        .section-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* User List Styles */
        .user-list-item {
            background: white;
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid #667eea;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .user-list-item:not([style*="cursor: not-allowed"]):hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-left-color: #28a745;
        }

        .user-number {
            background: #667eea;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-weight: bold;
            font-size: 1.1rem;
            color: #333;
            margin-bottom: 3px;
        }

        .user-checkup-count {
            color: #666;
            font-size: 0.9rem;
        }

        .user-arrow {
            color: #667eea;
            font-size: 1.5rem;
        }

        /* Activity Search Dropdown */
        .activity-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #667eea;
            border-top: none;
            border-radius: 0 0 10px 10px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: none;
        }

        .activity-dropdown-item {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s ease;
        }

        .activity-dropdown-item:hover {
            background: #f8f9fa;
        }

        .activity-dropdown-item:last-child {
            border-bottom: none;
        }

        .activity-dropdown-item .tool-id {
            font-weight: bold;
            color: #667eea;
            font-size: 1rem;
        }

        .activity-dropdown-item .tool-name {
            color: #666;
            font-size: 0.9rem;
            margin-top: 3px;
        }

        .activity-dropdown-item .tool-owner {
            color: #999;
            font-size: 0.85rem;
            margin-top: 2px;
        }

        .activity-dropdown-empty {
            padding: 15px;
            text-align: center;
            color: #999;
            font-style: italic;
        }

        .btn-admin-action {
            border-radius: 10px;
            padding: 10px 20px;
            font-weight: bold;
            transition: all 0.2s ease;
        }

        .btn-admin-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
        }

        .settings-group {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .settings-group label {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .user-table {
            margin-top: 20px;
        }

        /* Mobile-friendly user cards */
        .user-card-mobile {
            display: none;
        }

        @media (max-width: 768px) {
            .user-table {
                display: none;
            }

            .user-card-mobile {
                display: block;
            }

            .user-card-item {
                background: white;
                border: 1px solid #dee2e6;
                border-radius: 8px;
                padding: 12px;
                margin-bottom: 10px;
            }

            .user-card-item h6 {
                margin: 0 0 5px 0;
                font-size: 1rem;
                color: #333;
            }

            .user-card-item p {
                margin: 0 0 8px 0;
                font-size: 0.85rem;
                color: #666;
            }

            .user-card-item .btn {
                font-size: 0.75rem;
                padding: 5px 10px;
            }
        }

        .user-table th {
            background: #667eea;
            color: white;
            font-weight: bold;
        }

        /* Tool Cards (matching index.html style) */
        .register-tool-card {
            background: white;
            border: 2px solid #ddd;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .register-tool-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .register-tool-card.in {
            background: #C8E6C9; /* Light green for IN status */
            border-color: #4CAF50;
        }

        .register-tool-card.out {
            background: #FFCDD2; /* Light red for OUT status */
            border-color: #F44336;
        }

        .register-tool-card.broken {
            background: #FFE082;
            border-color: #FFC107;
        }

        .register-tool-card.lost {
            background: #B0BEC5;
            border-color: #607D8B;
        }

        .register-tool-card.calibration {
            background: #BBDEFB;
            border-color: #2196F3;
        }

        .filter-time-btn {
            margin: 2px;
        }

        .filter-time-btn.active {
            background: #667eea !important;
            border-color: #667eea !important;
        }

        .user-tool-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .user-tool-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .user-tool-card .out-badge {
            background: #dc3545;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
        }

        .badge-admin {
            background: #28a745;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.85rem;
        }

        .badge-user {
            background: #6c757d;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.85rem;
        }

        .alert-custom {
            border-radius: 10px;
            border: none;
            padding: 15px 20px;
        }

        .loading-spinner {
            display: none;
            text-align: center;
            padding: 20px;
        }

        /* Section Modal/Overlay */
        .section-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            overflow-y: auto;
            animation: fadeIn 0.3s ease;
        }

        .section-modal.active {
            display: block;
        }

        .section-modal-content {
            background: #f5f7fa;
            min-height: 100%;
            animation: slideUp 0.3s ease;
        }

        .section-modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .section-modal-header h3 {
            font-size: 1.3rem;
        }

        .section-modal-header small {
            font-size: 0.85rem;
        }

        .section-modal-body {
            padding: 15px;
            max-width: 1400px;
            margin: 0 auto;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }
            to {
                transform: translateY(0);
            }
        }

        /* Desktop: Centered modal */
        @media (min-width: 769px) {
            .section-modal-content {
                max-width: 1200px;
                margin: 40px auto;
                min-height: auto;
                border-radius: 20px;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                animation: slideUp 0.3s ease, fadeIn 0.3s ease;
            }

            .section-modal-header {
                border-radius: 20px 20px 0 0;
            }
        }

        @media (max-width: 768px) {
            .login-card {
                padding: 30px 20px;
            }

            .admin-header h1 {
                font-size: 1.2rem !important;
            }

            .admin-header {
                padding: 10px 0 !important;
            }

            /* Much smaller statistics on mobile */
            .stat-card {
                padding: 6px !important;
                margin-bottom: 6px !important;
                border-radius: 8px !important;
            }

            .stat-card .icon {
                font-size: 1.2rem !important;
            }

            .stat-card h3 {
                font-size: 0.9rem !important;
                margin: 2px 0 1px 0 !important;
                font-weight: bold !important;
            }

            .stat-card p {
                font-size: 0.65rem !important;
                margin: 0 !important;
            }

            /* Compact button grid on mobile */
            .nav-buttons-container {
                padding: 5px !important;
                gap: 5px !important;
                margin-bottom: 15px !important;
            }

            .nav-button {
                flex: 0 0 calc(50% - 2px) !important;
                padding: 8px 10px !important;
                font-size: 0.8rem !important;
                margin: 1px !important;
                min-height: auto !important;
                border-radius: 8px !important;
            }

            .nav-button i {
                display: block !important;
                margin: 0 0 3px 0 !important;
                font-size: 1rem !important;
            }

        /* Modal adjustments for mobile */
        .section-modal-header {
            padding: 12px;
        }

        /* Fix z-index for tool history modal */
        #toolHistoryModal {
            z-index: 15000 !important;
        }

        #toolHistoryModal .modal-dialog {
            z-index: 15001 !important;
        }

            .section-modal-header h3 {
                font-size: 1.1rem;
            }

            .section-modal-header small {
                font-size: 0.75rem;
            }

            .section-modal-header .btn {
                padding: 6px 12px;
                font-size: 0.85rem;
            }

            .section-modal-body {
                padding: 10px;
            }

            /* Admin cards smaller on mobile */
            .admin-card {
                padding: 15px;
                margin-bottom: 15px;
            }

            .admin-card h4 {
                font-size: 1.1rem;
                margin-bottom: 15px;
            }

            /* Form elements smaller */
            .form-control {
                font-size: 0.9rem;
                padding: 8px 10px;
            }

            .btn {
                font-size: 0.85rem;
                padding: 8px 12px;
            }

            /* Table responsive - make scrollable */
            .table-responsive {
                font-size: 0.85rem;
            }

            .user-table table {
                min-width: 100%;
                font-size: 0.8rem;
            }

            .user-table th,
            .user-table td {
                padding: 8px 6px;
                white-space: nowrap;
            }

            /* Settings groups */
            .settings-group {
                margin-bottom: 15px;
            }

            .settings-group label {
                font-size: 0.9rem;
            }

            /* User list items */
            .user-list-item {
                padding: 10px;
                margin-bottom: 8px;
            }

            /* Checkup cards */
            .checkup-user-card {
                padding: 12px;
                margin-bottom: 10px;
            }

            /* Reduce margins and padding globally in modals */
            .section-modal-body .row {
                margin-left: -5px;
                margin-right: -5px;
            }

            .section-modal-body .col-md-6,
            .section-modal-body .col-sm-6 {
                padding-left: 5px;
                padding-right: 5px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginSection" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <i class="fas fa-user-shield"></i>
                <h2>Tool Administrator</h2>
                <p>AMS Tool Tracking System</p>
            </div>

            <div id="loginAlert" class="alert alert-custom" style="display: none;"></div>

            <form id="loginForm">
                <div class="mb-3">
                    <label for="adminEmail" class="form-label">
                        <i class="fas fa-envelope"></i> Email Address
                    </label>
                    <input type="email" class="form-control" id="adminEmail" placeholder="admin@example.com" required>
                </div>
                <div class="mb-3">
                    <label for="adminPassword" class="form-label">
                        <i class="fas fa-lock"></i> Password
                    </label>
                    <input type="password" class="form-control" id="adminPassword" placeholder="Enter your password" required>
                </div>
                <button type="submit" class="btn btn-login w-100 mb-3">
                    <i class="fas fa-sign-in-alt"></i> Sign In
                </button>
            </form>

            <div class="divider">
                <span>OR</span>
            </div>

            <button id="googleSignInBtn" class="btn btn-google w-100">
                <i class="fab fa-google"></i> Sign in with Google
            </button>

            <div class="text-center mt-4">
                <a href="index.html" class="text-decoration-none" style="color: #667eea;">
                    <i class="fas fa-arrow-left"></i> Back to Main App
                </a>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="admin-dashboard">
        <!-- Header -->
        <div class="admin-header">
            <div class="container">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1><i class="fas fa-user-shield"></i> Tool Administrator</h1>
                        <p class="admin-welcome mb-0">Welcome, <span id="adminName">Admin</span></p>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-light btn-admin-action" onclick="location.href='index.html'">
                            <i class="fas fa-home"></i> Main App
                        </button>
                        <button class="btn btn-danger btn-admin-action" id="logoutBtn">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Content -->
        <div class="admin-content">
            <div class="container">
                <!-- Statistics -->
                <div class="row mb-4">
                    <div class="col-md-3 col-sm-6">
                        <div class="stat-card text-center">
                            <div class="icon" style="color: #667eea;">
                                <i class="fas fa-tools"></i>
                            </div>
                            <h3 id="totalTools">0</h3>
                            <p>Total Tools</p>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div class="stat-card text-center">
                            <div class="icon" style="color: #28a745;">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <h3 id="toolsIn">0</h3>
                            <p>Tools Checked IN</p>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div class="stat-card text-center">
                            <div class="icon" style="color: #dc3545;">
                                <i class="fas fa-sign-out-alt"></i>
                            </div>
                            <h3 id="toolsOut">0</h3>
                            <p>Tools Checked OUT</p>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div class="stat-card text-center">
                            <div class="icon" style="color: #ff9800;">
                                <i class="fas fa-users"></i>
                            </div>
                            <h3 id="totalUsers">0</h3>
                            <p>Total Users</p>
                        </div>
                    </div>
                </div>

                <!-- Animated Push Buttons -->
                <div class="nav-buttons-container">
                    <button class="nav-button" onclick="openSectionModal('settings')">
                        <i class="fas fa-cog"></i> Settings
                    </button>
                    <button class="nav-button" onclick="openSectionModal('users')">
                        <i class="fas fa-users"></i> Users
                    </button>
                    <button class="nav-button" onclick="openSectionModal('tools')">
                        <i class="fas fa-toolbox"></i> Tools
                    </button>
                    <button class="nav-button" onclick="openSectionModal('analytics')">
                        <i class="fas fa-chart-bar"></i> Analytics
                    </button>
                    <button class="nav-button" onclick="openSectionModal('checkups')">
                        <i class="fas fa-clipboard-check"></i> Checkups
                    </button>
                    <button class="nav-button" onclick="openSectionModal('activity')">
                        <i class="fas fa-user-check"></i> Check User Activity
                    </button>
                </div>

                <!-- Section Content (hidden templates for modals) -->
                <div id="adminSectionsContent" style="display: none;">
                    <!-- Settings Section -->
                    <div class="section-content active" id="settings">
                        <div class="admin-card">
                            <h4><i class="fas fa-cog"></i> System Settings</h4>
                            
                            <div class="settings-group">
                                <label for="adminPassword">Admin Password</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="adminPasswordInput" placeholder="Enter new admin password">
                                    <button class="btn btn-primary" id="updatePasswordBtn">
                                        <i class="fas fa-save"></i> Update
                                    </button>
                                </div>
                                <small class="text-muted">Used for sensitive operations like deleting photos from all tools</small>
                            </div>

                            <div class="settings-group">
                                <label for="cooldownMinutes">Check-In Cooldown (Minutes)</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="cooldownMinutes" placeholder="15" min="1">
                                    <button class="btn btn-primary" id="updateCooldownBtn">
                                        <i class="fas fa-save"></i> Update
                                    </button>
                                </div>
                                <small class="text-muted">Time users must wait before checking in a tool after checkout</small>
                            </div>

                            <div class="settings-group">
                                <label>System Information</label>
                                <table class="table table-sm">
                                    <tbody>
                                        <tr>
                                            <td><strong>Firebase Project:</strong></td>
                                            <td id="projectId">Loading...</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Last Settings Update:</strong></td>
                                            <td id="lastUpdate">Loading...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Users Section -->
                    <div class="section-content" id="users">
                        <div class="admin-card">
                            <h4><i class="fas fa-users"></i> User Management</h4>
                            
                            <div class="mb-3">
                                <input type="text" class="form-control" id="userSearch" placeholder="Search users by name or email...">
                            </div>

                            <div class="loading-spinner" id="usersLoading">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p>Loading users...</p>
                            </div>

                            <div class="table-responsive user-table">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Email</th>
                                            <th>Role</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="usersTableBody">
                                        <!-- Users will be populated here -->
                                    </tbody>
                                </table>
                            </div>

                            <!-- Mobile-friendly card view -->
                            <div class="user-card-mobile" id="userCardsMobile">
                                <!-- User cards will be populated here for mobile -->
                            </div>
                        </div>
                    </div>

                    <!-- Tools Section -->
                    <div class="section-content" id="tools">
                        <!-- Tools Main Menu -->
                        <div id="toolsMainMenu" class="admin-card">
                            <h4><i class="fas fa-toolbox"></i> Tool Management</h4>
                            <p style="color: #666; margin-bottom: 20px;">Select an option to manage tools</p>
                            
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <button class="btn btn-primary w-100 py-3" onclick="showToolsByUser()">
                                        <i class="fas fa-user-tag fa-2x d-block mb-2"></i>
                                        <strong>Tools By User</strong>
                                        <small class="d-block">View tool history by technician</small>
                                    </button>
                                </div>
                                <div class="col-md-6">
                                    <button class="btn btn-success w-100 py-3" onclick="showToolsByOwner()">
                                        <i class="fas fa-users-cog fa-2x d-block mb-2"></i>
                                        <strong>Tools By Owner</strong>
                                        <small class="d-block">View tools grouped by collection owner</small>
                                    </button>
                                </div>
                                <div class="col-md-4">
                                    <button class="btn btn-info w-100 py-3" onclick="showAddEditTool()">
                                        <i class="fas fa-edit fa-2x d-block mb-2"></i>
                                        <strong>Add/Edit Tool</strong>
                                        <small class="d-block">Manually add or edit tools</small>
                                    </button>
                                </div>
                                <div class="col-md-4">
                                    <button class="btn btn-warning w-100 py-3" onclick="showImportExcel()">
                                        <i class="fas fa-file-excel fa-2x d-block mb-2"></i>
                                        <strong>Import from Excel</strong>
                                        <small class="d-block">Bulk import tools</small>
                                    </button>
                                </div>
                                <div class="col-md-4">
                                    <button class="btn btn-secondary w-100 py-3" onclick="showExportTools()">
                                        <i class="fas fa-download fa-2x d-block mb-2"></i>
                                        <strong>Export Tools</strong>
                                        <small class="d-block">Download tools data</small>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Tools By User Section -->
                        <div id="toolsByUserSection" style="display: none;">
                            <!-- User Selection -->
                            <div id="toolsUserSelection" class="admin-card">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h4><i class="fas fa-user-tag"></i> Select Technician</h4>
                                    <button class="btn btn-secondary btn-sm" onclick="backToToolsMenu()">
                                        <i class="fas fa-arrow-left"></i> Back
                                    </button>
                                </div>
                                
                                <div class="mb-3">
                                    <input type="text" class="form-control" id="toolsUserSearch" placeholder="Search technicians...">
                                </div>

                                <div class="loading-spinner" id="toolsUsersLoading">
                                    <div class="spinner-border text-primary" role="status"></div>
                                    <p>Loading technicians...</p>
                                </div>

                                <div id="toolsUsersList" class="row g-3">
                                    <!-- User cards will be populated here -->
                                </div>
                            </div>

                            <!-- Tool History Section -->
                            <div id="toolHistorySection" style="display: none;" class="admin-card">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h4><i class="fas fa-history"></i> Tool History - <span id="selectedUserNameTools" style="color: #667eea;"></span></h4>
                                    <button class="btn btn-secondary btn-sm" onclick="backToToolsUserSelection()">
                                        <i class="fas fa-arrow-left"></i> Back to Users
                                    </button>
                                </div>

                                <!-- Time Filters -->
                                <div class="mb-3 d-flex gap-2 flex-wrap">
                                    <button class="btn btn-sm btn-primary filter-time-btn active" onclick="filterToolHistory('today', this)">
                                        <i class="fas fa-calendar-day"></i> Today
                                    </button>
                                    <button class="btn btn-sm btn-primary filter-time-btn" onclick="filterToolHistory('week', this)">
                                        <i class="fas fa-calendar-week"></i> Last Week
                                    </button>
                                    <button class="btn btn-sm btn-primary filter-time-btn" onclick="filterToolHistory('month', this)">
                                        <i class="fas fa-calendar-alt"></i> Last Month
                                    </button>
                                    <button class="btn btn-sm btn-primary filter-time-btn" onclick="filterToolHistory('year', this)">
                                        <i class="fas fa-calendar"></i> Last Year
                                    </button>
                                    <button class="btn btn-sm btn-primary filter-time-btn" onclick="filterToolHistory('all', this)">
                                        <i class="fas fa-infinity"></i> All Time
                                    </button>
                                </div>

                                <!-- Search Tool -->
                                <div class="mb-3">
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="toolHistorySearch" placeholder="Scan or enter tool code...">
                                        <button class="btn btn-primary" onclick="searchToolHistory()">
                                            <i class="fas fa-search"></i> Search
                                        </button>
                                        <button class="btn btn-secondary" id="scanToolHistoryBtn">
                                            <i class="fas fa-qrcode"></i> Scan
                                        </button>
                                    </div>
                                </div>

                                <!-- Toggle for OUT tools only -->
                                <div class="mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="showOutToolsOnly" onchange="toggleOutToolsOnly()">
                                        <label class="form-check-label" for="showOutToolsOnly">
                                            <strong>Show only currently OUT tools registered to this user</strong>
                                        </label>
                                    </div>
                                </div>

                                <!-- Tool History Cards -->
                                <div id="toolHistoryCards">
                                    <p class="text-muted">Select a time period or search for a specific tool</p>
                                </div>
                            </div>
                        </div>

                        <!-- Other sections placeholders -->
                        <div id="toolsByOwnerSection" style="display: none;" class="admin-card">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h4><i class="fas fa-users-cog"></i> Tools By Owner</h4>
                                <button class="btn btn-secondary btn-sm" onclick="backToToolsMenu()">
                                    <i class="fas fa-arrow-left"></i> Back
                                </button>
                            </div>
                            <p class="text-muted">Coming soon...</p>
                        </div>

                        <div id="addEditToolSection" style="display: none;" class="admin-card">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h4><i class="fas fa-edit"></i> Add/Edit Tool</h4>
                                <button class="btn btn-secondary btn-sm" onclick="backToToolsMenu()">
                                    <i class="fas fa-arrow-left"></i> Back
                                </button>
                            </div>
                            <p class="text-muted">Coming soon...</p>
                        </div>

                        <div id="importExcelSection" style="display: none;" class="admin-card">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h4><i class="fas fa-file-excel"></i> Import from Excel</h4>
                                <button class="btn btn-secondary btn-sm" onclick="backToToolsMenu()">
                                    <i class="fas fa-arrow-left"></i> Back
                                </button>
                            </div>
                            <p class="text-muted">Coming soon...</p>
                        </div>

                        <div id="exportToolsSection" style="display: none;" class="admin-card">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h4><i class="fas fa-download"></i> Export Tools</h4>
                                <button class="btn btn-secondary btn-sm" onclick="backToToolsMenu()">
                                    <i class="fas fa-arrow-left"></i> Back
                                </button>
                            </div>
                            <p class="text-muted">Coming soon...</p>
                        </div>
                    </div>

                    <!-- Analytics Section -->
                    <div class="section-content" id="analytics">
                        <div class="admin-card">
                            <h4><i class="fas fa-chart-bar"></i> Analytics & Reports</h4>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="settings-group">
                                        <h5>Today's Activity</h5>
                                        <table class="table table-sm">
                                            <tbody>
                                                <tr>
                                                    <td><i class="fas fa-check-circle text-success"></i> Check-Ins Today:</td>
                                                    <td><strong id="checkInsToday">0</strong></td>
                                                </tr>
                                                <tr>
                                                    <td><i class="fas fa-sign-out-alt text-danger"></i> Check-Outs Today:</td>
                                                    <td><strong id="checkOutsToday">0</strong></td>
                                                </tr>
                                                <tr>
                                                    <td><i class="fas fa-tools text-primary"></i> Active Users Today:</td>
                                                    <td><strong id="activeUsersToday">0</strong></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="settings-group">
                                        <h5>Most Active Users</h5>
                                        <div id="topUsersList">
                                            <p class="text-muted">Loading...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="settings-group mt-3">
                                <h5>Recent Activity Log</h5>
                                <div id="recentActivityLog" style="max-height: 400px; overflow-y: auto;">
                                    <p class="text-muted">Loading recent activities...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Checkups Section -->
                    <div class="section-content" id="checkups">
                        <div class="admin-card">
                            <h4><i class="fas fa-clipboard-check"></i> Collection Checkups Management</h4>
                            
                            <!-- Step 1: Select User -->
                            <div id="checkupStep1" class="settings-group">
                                <h5><i class="fas fa-user"></i> Select User</h5>
                                <div class="mb-3">
                                    <input type="text" class="form-control" id="checkupUserSearch" placeholder="Search users...">
                                </div>
                                <div class="loading-spinner" id="checkupUsersLoading">
                                    <div class="spinner-border text-primary" role="status"></div>
                                    <p>Loading users...</p>
                                </div>
                                <div id="checkupUsersList">
                                    <!-- Users will be populated here as numbered list -->
                                </div>
                            </div>

                            <!-- Step 2: Select Collection -->
                            <div id="checkupStep2" class="settings-group" style="display: none;">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5><i class="fas fa-folder"></i> Step 2: Select Collection for <span id="selectedUserName" style="color: #667eea;"></span></h5>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="resetCheckupSelection()">
                                        <i class="fas fa-arrow-left"></i> Back to Users
                                    </button>
                                </div>
                                <div id="checkupCollectionsList" class="row g-3">
                                    <!-- Collections will be populated here -->
                                </div>
                            </div>

                            <!-- Step 3: View Checkup History -->
                            <div id="checkupStep3" class="settings-group" style="display: none;">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5><i class="fas fa-history"></i> <span id="selectedCollectionName" style="color: #667eea;"></span></h5>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="backToCollections()">
                                        <i class="fas fa-arrow-left"></i> Back to Users
                                    </button>
                                </div>

                                <!-- Filter Buttons -->
                                <div class="mb-3 d-flex gap-2 flex-wrap">
                                    <button class="btn btn-sm btn-primary" onclick="filterCheckups('today')">
                                        <i class="fas fa-calendar-day"></i> Today
                                    </button>
                                    <button class="btn btn-sm btn-primary" onclick="filterCheckups('week')">
                                        <i class="fas fa-calendar-week"></i> Last Week
                                    </button>
                                    <button class="btn btn-sm btn-primary" onclick="filterCheckups('month')">
                                        <i class="fas fa-calendar-alt"></i> Last Month
                                    </button>
                                    <button class="btn btn-sm btn-primary" onclick="filterCheckups('year')">
                                        <i class="fas fa-calendar"></i> Last Year
                                    </button>
                                    <button class="btn btn-sm btn-outline-primary" onclick="filterCheckups('all')">
                                        <i class="fas fa-list"></i> All Time
                                    </button>
                                    <div class="ms-auto">
                                        <button class="btn btn-sm btn-danger" id="deleteSelectedCheckupsBtn" onclick="deleteSelectedCheckups()" disabled>
                                            <i class="fas fa-trash"></i> Delete Selected (<span id="selectedCheckupsCount">0</span>)
                                        </button>
                                    </div>
                                </div>

                                <!-- Analytics Summary -->
                                <div class="row mb-3">
                                    <div class="col-md-3">
                                        <div class="stat-card text-center" style="padding: 15px;">
                                            <div class="icon" style="font-size: 2rem; color: #667eea;">
                                                <i class="fas fa-clipboard-list"></i>
                                            </div>
                                            <h4 id="totalCheckups">0</h4>
                                            <p style="font-size: 0.9rem;">Total Checkups</p>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="stat-card text-center" style="padding: 15px;">
                                            <div class="icon" style="font-size: 2rem; color: #28a745;">
                                                <i class="fas fa-percentage"></i>
                                            </div>
                                            <h4 id="avgCompletion">0%</h4>
                                            <p style="font-size: 0.9rem;">Avg Completion</p>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="stat-card text-center" style="padding: 15px;">
                                            <div class="icon" style="font-size: 2rem; color: #ff9800;">
                                                <i class="fas fa-tools"></i>
                                            </div>
                                            <h4 id="avgToolsChecked">0</h4>
                                            <p style="font-size: 0.9rem;">Avg Tools Checked</p>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="stat-card text-center" style="padding: 15px;">
                                            <div class="icon" style="font-size: 2rem; color: #dc3545;">
                                                <i class="fas fa-calendar-check"></i>
                                            </div>
                                            <h4 id="lastCheckupDate">N/A</h4>
                                            <p style="font-size: 0.9rem;">Last Checkup</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Checkup History Table -->
                                <div class="loading-spinner" id="checkupHistoryLoading">
                                    <div class="spinner-border text-primary" role="status"></div>
                                    <p>Loading checkup history...</p>
                                </div>

                                <div class="table-responsive" id="checkupHistoryTableContainer" style="display: none;">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                <th style="width: 50px;">
                                    <input type="checkbox" id="selectAllCheckups" onchange="toggleSelectAllCheckups()">
                                </th>
                                <th>Date & Time</th>
                                <th>Collection</th>
                                <th>Total Tools</th>
                                <th>Checked</th>
                                <th>Unchecked</th>
                                <th>Completion %</th>
                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="checkupHistoryTableBody">
                                            <!-- Checkup history will be populated here -->
                                        </tbody>
                                    </table>
                                </div>

                                <div id="noCheckupsMessage" style="display: none; text-align: center; padding: 40px; color: #999;">
                                    <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 15px;"></i>
                                    <p style="font-size: 1.1rem;">No checkups found for the selected period.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Check User Activity Section -->
                    <div class="section-content" id="activity">
                        <div class="admin-card">
                            <h4><i class="fas fa-user-check"></i> Check User Activity - Tool Registration Verification</h4>
                            
                            <div class="settings-group">
                                <p style="color: #666; margin-bottom: 20px;">
                                    <i class="fas fa-info-circle"></i> Scan or enter a tool code to check who is currently using it and when it was registered.
                                </p>

                                <!-- Search Input with QR Scanner -->
                                <div class="mb-3">
                                    <label for="activityToolSearch" class="form-label" style="font-weight: bold; font-size: 1.1rem;">
                                        <i class="fas fa-search"></i> Enter Tool Code or Scan QR
                                    </label>
                                    <div style="position: relative;">
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="activityToolSearch" 
                                                   placeholder="Enter tool code (e.g., AMS-001) or scan QR code..." 
                                                   style="font-size: 1.1rem; padding: 12px;"
                                                   autocomplete="off">
                                            <button class="btn btn-primary" id="activitySearchBtn" onclick="searchToolActivity()">
                                                <i class="fas fa-search"></i> Search
                                            </button>
                                            <button class="btn btn-success" id="activityScanBtn" onclick="toggleActivityScanner()">
                                                <i class="fas fa-qrcode"></i> Scan QR
                                            </button>
                                        </div>
                                        <!-- Dropdown for suggestions -->
                                        <div id="activityDropdown" class="activity-dropdown"></div>
                                    </div>
                                    <small class="text-muted">Case-insensitive search - searches Tool ID, Tool Name, and Part Number. Start typing to see suggestions.</small>
                                </div>

                                <!-- QR Scanner Container -->
                                <div id="activityQrReader" style="display: none; margin-bottom: 20px;">
                                    <div id="activityQrReaderElement" style="border: 3px solid #667eea; border-radius: 10px; overflow: hidden;"></div>
                                    <button class="btn btn-danger mt-2" onclick="stopActivityScanner()">
                                        <i class="fas fa-stop"></i> Stop Scanner
                                    </button>
                                </div>

                                <!-- Results Container -->
                                <div id="activityResults" style="display: none;">
                                    <!-- Results will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Section Modals -->
    <div id="settingsModal" class="section-modal"></div>
    <div id="usersModal" class="section-modal"></div>
    <div id="toolsModal" class="section-modal"></div>
    <div id="analyticsModal" class="section-modal"></div>
    <div id="checkupsModal" class="section-modal"></div>
    <div id="activityModal" class="section-modal"></div>

    <!-- Checkup Details Modal -->
    <div class="modal fade" id="checkupDetailsModal" tabindex="-1" aria-labelledby="checkupDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header" style="background: #667eea; color: white;">
                    <h5 class="modal-title" id="checkupDetailsModalLabel">
                        <i class="fas fa-clipboard-check"></i> Checkup Details
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="checkupDetailsModalBody">
                    <!-- Details will be populated here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDmI0v_pVt_qFJlsqmw8QlIOi-4VLjyn54",
            authDomain: "tool-tracking-system-15e84.firebaseapp.com",
            projectId: "tool-tracking-system-15e84",
            storageBucket: "tool-tracking-system-15e84.firebasestorage.app",
            messagingSenderId: "813615362050",
            appId: "1:813615362050:web:1fa435f0b725dd1f8cb71b"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // DOM Elements
        const loginSection = document.getElementById('loginSection');
        const adminDashboard = document.getElementById('adminDashboard');
        const loginAlert = document.getElementById('loginAlert');
        const loginForm = document.getElementById('loginForm');
        const googleSignInBtn = document.getElementById('googleSignInBtn');

        // Show alert message
        function showAlert(message, type = 'danger') {
            loginAlert.className = `alert alert-custom alert-${type}`;
            loginAlert.textContent = message;
            loginAlert.style.display = 'block';
            setTimeout(() => {
                loginAlert.style.display = 'none';
            }, 5000);
        }

        // Check if user is admin
        async function checkAdminStatus(user) {
            try {
                const doc = await db.collection('technicians').doc(user.uid).get();
                if (doc.exists) {
                    const userData = doc.data();
                    if (userData.isAdmin === true) {
                        return { isAdmin: true, name: userData.fullName || user.email };
                    }
                }
                return { isAdmin: false, name: null };
            } catch (error) {
                console.error('Error checking admin status:', error);
                return { isAdmin: false, name: null };
            }
        }

        // Email/Password Login
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('adminEmail').value.trim();
            const password = document.getElementById('adminPassword').value;

            try {
                showAlert('Signing in...', 'info');
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;

                // Check if user is admin
                const { isAdmin, name } = await checkAdminStatus(user);
                if (isAdmin) {
                    showAlert('Success! Loading admin dashboard...', 'success');
                    loadAdminDashboard(name);
                } else {
                    await auth.signOut();
                    showAlert('Access Denied: You do not have administrator privileges.', 'danger');
                }
            } catch (error) {
                console.error('Login error:', error);
                if (error.code === 'auth/user-not-found') {
                    showAlert('User not found. Please check your email.', 'danger');
                } else if (error.code === 'auth/wrong-password') {
                    showAlert('Incorrect password. Please try again.', 'danger');
                } else if (error.code === 'auth/invalid-email') {
                    showAlert('Invalid email address.', 'danger');
                } else {
                    showAlert('Login failed: ' + error.message, 'danger');
                }
            }
        });

        // Google Sign-In
        googleSignInBtn.addEventListener('click', async () => {
            try {
                showAlert('Opening Google Sign-In...', 'info');
                const provider = new firebase.auth.GoogleAuthProvider();
                const userCredential = await auth.signInWithPopup(provider);
                const user = userCredential.user;

                // Check if user is admin
                const { isAdmin, name } = await checkAdminStatus(user);
                if (isAdmin) {
                    showAlert('Success! Loading admin dashboard...', 'success');
                    loadAdminDashboard(name);
                } else {
                    await auth.signOut();
                    showAlert('Access Denied: You do not have administrator privileges.', 'danger');
                }
            } catch (error) {
                console.error('Google Sign-In error:', error);
                if (error.code === 'auth/popup-closed-by-user') {
                    showAlert('Sign-in cancelled.', 'warning');
                } else {
                    showAlert('Google Sign-In failed: ' + error.message, 'danger');
                }
            }
        });

        // Load Admin Dashboard
        function loadAdminDashboard(adminName) {
            loginSection.style.display = 'none';
            adminDashboard.style.display = 'block';
            document.getElementById('adminName').textContent = adminName;
            
            // Load all dashboard data
            loadStatistics();
            loadSettings();
            loadUsers();
            loadTools();
            loadAnalytics();
        }

        // Load Statistics
        async function loadStatistics() {
            try {
                // Total Tools
                const toolsSnapshot = await db.collection('tools').get();
                document.getElementById('totalTools').textContent = toolsSnapshot.size;

                // Tools IN/OUT
                let toolsIn = 0;
                let toolsOut = 0;
                toolsSnapshot.forEach(doc => {
                    const status = doc.data().status;
                    if (status === 'IN') toolsIn++;
                    else if (status === 'OUT') toolsOut++;
                });
                document.getElementById('toolsIn').textContent = toolsIn;
                document.getElementById('toolsOut').textContent = toolsOut;

                // Total Users
                const usersSnapshot = await db.collection('technicians').get();
                document.getElementById('totalUsers').textContent = usersSnapshot.size;

            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }

        // Load Settings
        async function loadSettings() {
            try {
                const doc = await db.collection('settings').doc('admin').get();
                if (doc.exists) {
                    const data = doc.data();
                    document.getElementById('adminPasswordInput').placeholder = data.AdminPassword ? '' : 'Not set';
                    document.getElementById('cooldownMinutes').value = data.CheckINCooldownMinutes || 15;
                    
                    if (data.lastUpdated) {
                        const date = data.lastUpdated.toDate();
                        document.getElementById('lastUpdate').textContent = date.toLocaleString();
                    } else {
                        document.getElementById('lastUpdate').textContent = 'Never';
                    }
                }
                document.getElementById('projectId').textContent = firebaseConfig.projectId;
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        // Update Admin Password
        const updatePasswordBtn = document.getElementById('updatePasswordBtn');
        if (updatePasswordBtn) {
            updatePasswordBtn.addEventListener('click', async () => {
            const newPassword = document.getElementById('adminPasswordInput').value.trim();
            if (!newPassword) {
                alert('Please enter a password');
                return;
            }

            try {
                await db.collection('settings').doc('admin').set({
                    AdminPassword: newPassword,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                
                alert(' Admin password updated successfully!');
                document.getElementById('adminPasswordInput').value = '';
                document.getElementById('adminPasswordInput').placeholder = '';
            } catch (error) {
                console.error('Error updating password:', error);
                alert('Failed to update password: ' + error.message);
            }
        });
        }

        // Update Cooldown
        const updateCooldownBtn = document.getElementById('updateCooldownBtn');
        if (updateCooldownBtn) {
            updateCooldownBtn.addEventListener('click', async () => {
            const cooldownMinutes = parseInt(document.getElementById('cooldownMinutes').value);
            if (!cooldownMinutes || cooldownMinutes < 1) {
                alert('Please enter a valid number of minutes (minimum 1)');
                return;
            }

            try {
                await db.collection('settings').doc('admin').set({
                    CheckINCooldownMinutes: cooldownMinutes,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                
                alert(' Cooldown period updated successfully!');
            } catch (error) {
                console.error('Error updating cooldown:', error);
                alert('Failed to update cooldown: ' + error.message);
            }
        });
        }

        // Load Users
        async function loadUsers() {
            const tableBody = document.getElementById('usersTableBody');
            const mobileCards = document.getElementById('userCardsMobile');
            const loading = document.getElementById('usersLoading');
            
            try {
                loading.style.display = 'block';
                const snapshot = await db.collection('technicians').get();
                tableBody.innerHTML = '';
                mobileCards.innerHTML = '';

                snapshot.forEach(doc => {
                    const userData = doc.data();
                    
                    // Desktop table row
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${userData.fullName || 'N/A'}</td>
                        <td>${userData.email || 'N/A'}</td>
                        <td>
                            ${userData.isAdmin ? '<span class="badge-admin"><i class="fas fa-shield-alt"></i> Admin</span>' : '<span class="badge-user">User</span>'}
                        </td>
                        <td>
                            <button class="btn btn-sm btn-${userData.isAdmin ? 'danger' : 'success'}" onclick="toggleAdmin('${doc.id}', ${!userData.isAdmin})">
                                ${userData.isAdmin ? '<i class="fas fa-user-minus"></i> Remove Admin' : '<i class="fas fa-user-plus"></i> Make Admin'}
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(row);

                    // Mobile card
                    const card = document.createElement('div');
                    card.className = 'user-card-item';
                    card.innerHTML = `
                        <h6><i class="fas fa-user"></i> ${userData.fullName || 'N/A'}</h6>
                        <p><i class="fas fa-envelope"></i> ${userData.email || 'N/A'}</p>
                        <p>
                            ${userData.isAdmin ? '<span class="badge-admin"><i class="fas fa-shield-alt"></i> Admin</span>' : '<span class="badge-user">User</span>'}
                        </p>
                        <button class="btn btn-${userData.isAdmin ? 'danger' : 'success'}" onclick="toggleAdmin('${doc.id}', ${!userData.isAdmin})">
                            ${userData.isAdmin ? '<i class="fas fa-user-minus"></i> Remove Admin' : '<i class="fas fa-user-plus"></i> Make Admin'}
                        </button>
                    `;
                    mobileCards.appendChild(card);
                });

                loading.style.display = 'none';
            } catch (error) {
                console.error('Error loading users:', error);
                tableBody.innerHTML = '<tr><td colspan="4" class="text-danger">Error loading users</td></tr>';
                mobileCards.innerHTML = '<p class="text-danger">Error loading users</p>';
                loading.style.display = 'none';
            }
        }

        // Toggle Admin Status
        window.toggleAdmin = async function(userId, makeAdmin) {
            const confirmMsg = makeAdmin 
                ? 'Are you sure you want to grant admin privileges to this user?' 
                : 'Are you sure you want to remove admin privileges from this user?';
            
            if (!confirm(confirmMsg)) return;

            try {
                await db.collection('technicians').doc(userId).update({
                    isAdmin: makeAdmin
                });
                alert(` User ${makeAdmin ? 'promoted to' : 'removed from'} admin successfully!`);
                loadUsers(); // Reload users list
                loadStatistics(); // Refresh stats
            } catch (error) {
                console.error('Error updating user:', error);
                alert('Failed to update user: ' + error.message);
            }
        };

        // User Search
        const userSearchElement = document.getElementById('userSearch');
        if (userSearchElement) {
            userSearchElement.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            
            // Search in table rows
            const rows = document.querySelectorAll('#usersTableBody tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });

            // Search in mobile cards
            const cards = document.querySelectorAll('.user-card-item');
            cards.forEach(card => {
                const text = card.textContent.toLowerCase();
                card.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        });
        }

        // ========================================
        // TOOLS MANAGEMENT FUNCTIONS
        // ========================================

        let currentToolsUser = null;
        let currentToolsFilter = 'today';
        let allToolHistory = [];

        // Show Tools By User
        window.showToolsByUser = function() {
            document.getElementById('toolsMainMenu').style.display = 'none';
            document.getElementById('toolsByUserSection').style.display = 'block';
            document.getElementById('toolsUserSelection').style.display = 'block';
            document.getElementById('toolHistorySection').style.display = 'none';
            loadToolsUsers();
        };

        // Show other sections (placeholders)
        window.showToolsByOwner = function() {
            hideAllToolsSections();
            document.getElementById('toolsByOwnerSection').style.display = 'block';
        };

        window.showAddEditTool = function() {
            hideAllToolsSections();
            document.getElementById('addEditToolSection').style.display = 'block';
        };

        window.showImportExcel = function() {
            hideAllToolsSections();
            document.getElementById('importExcelSection').style.display = 'block';
        };

        window.showExportTools = function() {
            hideAllToolsSections();
            document.getElementById('exportToolsSection').style.display = 'block';
        };

        function hideAllToolsSections() {
            document.getElementById('toolsMainMenu').style.display = 'none';
            document.getElementById('toolsByUserSection').style.display = 'none';
            document.getElementById('toolsByOwnerSection').style.display = 'none';
            document.getElementById('addEditToolSection').style.display = 'none';
            document.getElementById('importExcelSection').style.display = 'none';
            document.getElementById('exportToolsSection').style.display = 'none';
        }

        window.backToToolsMenu = function() {
            hideAllToolsSections();
            document.getElementById('toolsMainMenu').style.display = 'block';
        };

        window.backToToolsUserSelection = function() {
            document.getElementById('toolsUserSelection').style.display = 'block';
            document.getElementById('toolHistorySection').style.display = 'none';
        };

        // Load users for Tools By User section
        async function loadToolsUsers() {
            const loading = document.getElementById('toolsUsersLoading');
            const usersList = document.getElementById('toolsUsersList');
            
            try {
                loading.style.display = 'block';
                const snapshot = await db.collection('technicians').get();
                usersList.innerHTML = '';

                // Get OUT tool counts for each user
                const toolsSnapshot = await db.collection('tools').where('status', '==', 'OUT').get();
                const outCounts = {};
                
                toolsSnapshot.forEach(doc => {
                    const owner = doc.data().currentOwner || 'Unknown';
                    outCounts[owner] = (outCounts[owner] || 0) + 1;
                });

                // Collect all users and sort alphabetically
                const users = [];
                snapshot.forEach(doc => {
                    const userData = doc.data();
                    const userName = userData.fullName || 'Unknown';
                    users.push({
                        id: doc.id,
                        name: userName,
                        email: userData.email || 'N/A',
                        outCount: outCounts[userName] || 0
                    });
                });

                // Sort users alphabetically by name
                users.sort((a, b) => a.name.localeCompare(b.name));

                // Display sorted users
                users.forEach(user => {
                    const card = document.createElement('div');
                    card.className = 'col-md-4 col-sm-6';
                    card.innerHTML = `
                        <div class="user-tool-card" onclick="selectToolsUser('${user.id}', '${user.name}')">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1"><i class="fas fa-user"></i> ${user.name}</h6>
                                    <small class="text-muted">${user.email}</small>
                                </div>
                                ${user.outCount > 0 ? `<span class="out-badge">OUT: ${user.outCount}</span>` : '<span style="color: #28a745;"><i class="fas fa-check-circle"></i> All IN</span>'}
                            </div>
                        </div>
                    `;
                    usersList.appendChild(card);
                });

                loading.style.display = 'none';
            } catch (error) {
                console.error('Error loading users:', error);
                usersList.innerHTML = '<p class="text-danger">Error loading users</p>';
                loading.style.display = 'none';
            }
        }

        // Search users in tools section
        const toolsUserSearchElement = document.getElementById('toolsUserSearch');
        if (toolsUserSearchElement) {
            toolsUserSearchElement.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const cards = document.querySelectorAll('#toolsUsersList .user-tool-card');
                cards.forEach(card => {
                    const text = card.textContent.toLowerCase();
                    card.parentElement.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            });
        }

        // Select a user to view their tool history
        window.selectToolsUser = async function(userId, userName) {
            currentToolsUser = { id: userId, name: userName };
            document.getElementById('selectedUserNameTools').textContent = userName;
            document.getElementById('toolsUserSelection').style.display = 'none';
            document.getElementById('toolHistorySection').style.display = 'block';
            
            // Load all tool history for this user
            await loadUserToolHistory(userName);
            
            // Apply default filter (today)
            filterToolHistory('today');
        };

        // Load all tool history for a user from logtoolmovements collection
        async function loadUserToolHistory(userName) {
            try {
                // Use logtoolmovements collection with existing index (technician field, not technicianName)
                const snapshot = await db.collection('logtoolmovements')
                    .where('technician', '==', userName)
                    .orderBy('timestamp', 'desc')
                    .limit(500)
                    .get();

                allToolHistory = [];
                snapshot.forEach(doc => {
                    allToolHistory.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                console.log(`Loaded ${allToolHistory.length} history entries for ${userName} from logtoolmovements collection`);
            } catch (error) {
                console.error('Error loading tool history from logtoolmovements:', error);
                allToolHistory = [];
            }
        }

        // Filter tool history by time period
        window.filterToolHistory = function(period, clickedButton = null) {
            currentToolsFilter = period;
            
            // Update button states
            document.querySelectorAll('.filter-time-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // If a button was clicked, activate it
            if (clickedButton) {
                clickedButton.classList.add('active');
            } else {
                // Find the button with the matching period and activate it
                const targetButton = document.querySelector(`[onclick*="filterToolHistory('${period}')"]`);
                if (targetButton) {
                    targetButton.classList.add('active');
                }
            }
            
            const now = new Date();
            let startDate;
            
            switch(period) {
                case 'today':
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    break;
                case 'week':
                    startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    break;
                case 'month':
                    startDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                    break;
                case 'year':
                    startDate = new Date(now.getTime() - 365 * 24 * 60 * 60 * 1000);
                    break;
                case 'all':
                    startDate = new Date(0);
                    break;
            }
            
            const filtered = allToolHistory.filter(entry => {
                const entryDate = entry.timestamp?.toDate ? entry.timestamp.toDate() : new Date(entry.timestamp);
                return entryDate >= startDate;
            });
            
            displayToolHistory(filtered);
        };

        // Toggle OUT tools only
        window.toggleOutToolsOnly = async function() {
            const showOutOnly = document.getElementById('showOutToolsOnly').checked;
            
            if (showOutOnly) {
                // Fetch current OUT tools for this user from tools collection
                const snapshot = await db.collection('tools')
                    .where('currentOwner', '==', currentToolsUser.name)
                    .where('status', '==', 'OUT')
                    .get();
                
                const outTools = [];
                snapshot.forEach(doc => {
                    outTools.push({
                        id: doc.id,
                        toolId: doc.id,
                        toolName: doc.data().toolName,
                        status: 'OUT',
                        timestamp: doc.data().timestamp,
                        WorkOn: doc.data().WorkOn,
                        workLocation: doc.data().WorkOn,
                        serialNumber: doc.data().serialNumber,
                        partNumber: doc.data().partNumber,
                        calDueDate: doc.data().calDueDate,
                        technician: doc.data().technician,
                        ...doc.data()
                    });
                });
                
                displayToolHistory(outTools, true);
            } else {
                // Show filtered history
                filterToolHistory(currentToolsFilter);
            }
        };

        // Search tool in history
        window.searchToolHistory = async function() {
            const searchTerm = document.getElementById('toolHistorySearch').value.trim().toUpperCase();
            
            if (!searchTerm) {
                alert('Please enter a tool code');
                return;
            }
            
            // Filter by specific tool
            const filtered = allToolHistory.filter(entry => {
                return entry.toolId?.toUpperCase().includes(searchTerm) || 
                       entry.toolName?.toUpperCase().includes(searchTerm);
            });
            
            if (filtered.length === 0) {
                document.getElementById('toolHistoryCards').innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-info-circle"></i> No history found for tool code: ${searchTerm}
                    </div>
                `;
            } else {
                displayToolHistory(filtered);
            }
        };

        // Display tool history as cards
        function displayToolHistory(historyEntries, isCurrentOut = false) {
            const container = document.getElementById('toolHistoryCards');
            
            if (historyEntries.length === 0) {
                container.innerHTML = '<p class="text-muted">No tools found for the selected period.</p>';
                return;
            }
            
            container.innerHTML = '';
            
            // Group by tool ID for better organization
            const groupedByTool = {};
            historyEntries.forEach(entry => {
                const toolId = entry.toolId || entry.id;
                if (!groupedByTool[toolId]) {
                    groupedByTool[toolId] = [];
                }
                groupedByTool[toolId].push(entry);
            });
            
            // Sort tools by newest entry first
            const sortedTools = Object.keys(groupedByTool).sort((a, b) => {
                const aLatest = groupedByTool[a][0];
                const bLatest = groupedByTool[b][0];
                const aTime = aLatest.timestamp?.toDate ? aLatest.timestamp.toDate() : new Date(aLatest.timestamp || 0);
                const bTime = bLatest.timestamp?.toDate ? bLatest.timestamp.toDate() : new Date(bLatest.timestamp || 0);
                return bTime - aTime; // Newest first
            });
            
            // Display each tool's history with numbering
            sortedTools.forEach((toolId, index) => {
                const toolEntries = groupedByTool[toolId];
                const latestEntry = toolEntries[0];
                
                const status = (latestEntry.status || latestEntry.action || '').toUpperCase();
                let statusClass = 'in';
                if (status === 'OUT' || status === 'CHECK-OUT') statusClass = 'out';
                else if (status === 'BROKEN') statusClass = 'broken';
                else if (status === 'LOST') statusClass = 'lost';
                else if (status === 'CALIBRATION') statusClass = 'calibration';
                
                const workOnValue = latestEntry.WorkOn || latestEntry.workLocation || 'N/A';
                const serialNumber = latestEntry.serialNumber || latestEntry.partNumber || 'N/A';
                const calDueDate = latestEntry.calDueDate ? 
                    (latestEntry.calDueDate.toDate ? latestEntry.calDueDate.toDate().toLocaleDateString('en-GB') : latestEntry.calDueDate) : 
                    'N/A';
                
                const time = latestEntry.timestamp ? 
                    (latestEntry.timestamp.toDate ? 
                        latestEntry.timestamp.toDate().toLocaleString('en-GB', {
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit',
                            hour12: false
                        }) : 
                        new Date(latestEntry.timestamp).toLocaleString('en-GB')) : 
                    'N/A';
                
                const statusColor = (status === 'IN' || status === 'CHECK-IN') ? 'green' : 'red';
                
                const card = document.createElement('div');
                card.className = `register-tool-card ${statusClass}`;
                card.onclick = function() {
                    showToolHistoryDetails(toolId, toolEntries);
                };
                
                card.innerHTML = `
                    <div style="font-weight: bold; font-size: 1.1rem; margin-bottom: 8px; color: #000; text-align: left;">
                        ${index + 1}. ${latestEntry.toolName || 'Unknown Tool'}
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <div style="color: #666; font-size: 0.9rem;">
                            ${time}
                        </div>
                        <div>
                            <span style="color: black; font-weight: bold;">WorkOn:</span> 
                            <span style="color: #666; font-weight: bold;">${workOnValue}</span>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                        <div style="text-align: left;">
                            <span style="color: black; font-weight: bold; text-decoration: underline;">TID</span>
                        </div>
                        <div style="text-align: center;">
                            <span style="color: black; font-weight: bold; text-decoration: underline;">P/N</span>
                        </div>
                        <div style="text-align: right;">
                            <span style="color: black; font-weight: bold; text-decoration: underline;">STS</span>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                        <div style="text-align: left;">
                            <span style="color: #666; font-weight: bold;">${toolId}</span>
                        </div>
                        <div style="text-align: center;">
                            <span style="color: #666; font-weight: bold;">${serialNumber}</span>
                        </div>
                        <div style="text-align: right;">
                            <span class="badge bg-${status === 'IN' || status === 'CHECK-IN' ? 'success' : 'danger'}" style="font-weight: bold; border-radius: 15px; padding: 4px 8px;">${status}</span>
                        </div>
                    </div>
                    <div style="margin-bottom: 12px; text-align: left;">
                        <span style="color: black; font-weight: bold;">Cal Due Date:</span> 
                        <span style="color: blue; font-weight: bold;">${calDueDate}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="color: blue; font-weight: normal; cursor: pointer;">
                            Click For Details (${toolEntries.length} ${toolEntries.length === 1 ? 'entry' : 'entries'})
                        </div>
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        // Show detailed history for a specific tool
        function showToolHistoryDetails(toolId, entries) {
            // Create modal content
            let historyHtml = '<div class="list-group">';
            
            entries.forEach((entry, index) => {
                const time = entry.timestamp ? 
                    (entry.timestamp.toDate ? 
                        entry.timestamp.toDate().toLocaleString('en-GB') : 
                        new Date(entry.timestamp).toLocaleString('en-GB')) : 
                    'N/A';
                
                const action = entry.action || entry.status || 'Unknown';
                const location = entry.WorkOn || entry.workLocation || 'N/A';
                const actionColor = action.toUpperCase().includes('OUT') ? 'text-danger' : 'text-success';
                
                historyHtml += `
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between">
                            <h6 class="mb-1">${index + 1}. <span class="${actionColor}">${action}</span></h6>
                            <small>${time}</small>
                        </div>
                        <p class="mb-1"><strong>Location:</strong> ${location}</p>
                        ${entry.notes ? `<p class="mb-0"><strong>Notes:</strong> ${entry.notes}</p>` : ''}
                    </div>
                `;
            });
            
            historyHtml += '</div>';
            
            // Show in Bootstrap modal
            const modalHtml = `
                <div class="modal fade" id="toolHistoryModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header" style="background: #667eea; color: white;">
                                <h5 class="modal-title">
                                    <i class="fas fa-history"></i> Complete History - ${toolId}
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                ${historyHtml}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('toolHistoryModal');
            if (existingModal) existingModal.remove();
            
            // Add and show modal
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modal = new bootstrap.Modal(document.getElementById('toolHistoryModal'));
            modal.show();
            
            // Clean up after hide
            document.getElementById('toolHistoryModal').addEventListener('hidden.bs.modal', function() {
                this.remove();
            });
        }

        // Load Tools (legacy - not used in new menu)
        async function loadTools() {
            // This function is replaced by the new tools menu system
            console.log('Tools section now uses submenu navigation');
        }

        // Delete Tool
        window.deleteTool = async function(toolId, toolName) {
            if (!confirm(`Are you sure you want to delete "${toolName}"?\n\nThis action cannot be undone!`)) {
                return;
            }

            try {
                await db.collection('tools').doc(toolId).delete();
                alert(' Tool deleted successfully!');
                loadTools(); // Reload tools list
                loadStatistics(); // Refresh stats
            } catch (error) {
                console.error('Error deleting tool:', error);
                alert('Failed to delete tool: ' + error.message);
            }
        };

        // Tool Search (legacy - not used in new menu)
        // This element doesn't exist in the new Tools menu structure
        // const toolSearchElement = document.getElementById('toolSearch');
        // if (toolSearchElement) {
        //     toolSearchElement.addEventListener('input', function() {
        //         const searchTerm = this.value.toLowerCase();
        //         const cards = document.querySelectorAll('#toolsListContainer .settings-group');
        //         cards.forEach(card => {
        //             const text = card.textContent.toLowerCase();
        //             card.style.display = text.includes(searchTerm) ? '' : 'none';
        //         });
        //     });
        // }

        // Load Analytics
        async function loadAnalytics() {
            try {
                // Get today's date range
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);

                // Get today's tools (registered today)
                const toolsSnapshot = await db.collection('tools')
                    .where('registeredAt', '>=', firebase.firestore.Timestamp.fromDate(today))
                    .where('registeredAt', '<', firebase.firestore.Timestamp.fromDate(tomorrow))
                    .get();

                let checkIns = 0;
                let checkOuts = 0;
                const activeUsers = new Set();

                toolsSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.status === 'IN') checkIns++;
                    else if (data.status === 'OUT') checkOuts++;
                    if (data.loggedInTechnician) activeUsers.add(data.loggedInTechnician);
                });

                document.getElementById('checkInsToday').textContent = checkIns;
                document.getElementById('checkOutsToday').textContent = checkOuts;
                document.getElementById('activeUsersToday').textContent = activeUsers.size;

                // Top users (simplified - just show count of tools per user)
                const userToolCounts = {};
                const allToolsSnapshot = await db.collection('tools').get();
                allToolsSnapshot.forEach(doc => {
                    const owner = doc.data().collectionName;
                    if (owner) {
                        userToolCounts[owner] = (userToolCounts[owner] || 0) + 1;
                    }
                });

                const topUsers = Object.entries(userToolCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);

                const topUsersList = document.getElementById('topUsersList');
                if (topUsers.length > 0) {
                    topUsersList.innerHTML = topUsers.map(([user, count], index) => 
                        `<div style="padding: 8px 0; border-bottom: 1px solid #eee;">
                            <strong>${index + 1}. ${user}</strong> - ${count} tools
                        </div>`
                    ).join('');
                } else {
                    topUsersList.innerHTML = '<p class="text-muted">No data available</p>';
                }

                // Recent activity log (last 20 tools registered)
                const recentSnapshot = await db.collection('tools')
                    .orderBy('registeredAt', 'desc')
                    .limit(20)
                    .get();

                const activityLog = document.getElementById('recentActivityLog');
                if (!recentSnapshot.empty) {
                    activityLog.innerHTML = recentSnapshot.docs.map(doc => {
                        const data = doc.data();
                        const date = data.registeredAt ? data.registeredAt.toDate().toLocaleString() : 'Unknown';
                        const statusColor = data.status === 'IN' ? '#28a745' : '#dc3545';
                        return `<div style="padding: 10px; border-bottom: 1px solid #eee;">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div>
                                    <strong>${data.toolName || 'Unknown Tool'}</strong>
                                    <span style="color: ${statusColor}; font-weight: bold; margin-left: 10px;">${data.status || 'N/A'}</span>
                                    <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">
                                        ${data.loggedInTechnician || 'Unknown'} | ${data.location || 'No location'}
                                    </div>
                                </div>
                                <small style="color: #999;">${date}</small>
                            </div>
                        </div>`;
                    }).join('');
                } else {
                    activityLog.innerHTML = '<p class="text-muted">No recent activity</p>';
                }

            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            if (confirm('Are you sure you want to logout?')) {
                try {
                    await auth.signOut();
                    loginSection.style.display = 'flex';
                    adminDashboard.style.display = 'none';
                    document.getElementById('adminEmail').value = '';
                    document.getElementById('adminPassword').value = '';
                    showAlert('Logged out successfully', 'success');
                } catch (error) {
                    console.error('Logout error:', error);
                    alert('Logout failed: ' + error.message);
                }
            }
        });

        // Check auth state on page load
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                const { isAdmin, name } = await checkAdminStatus(user);
                if (isAdmin) {
                    loadAdminDashboard(name);
                } else {
                    await auth.signOut();
                    showAlert('Access Denied: Admin privileges required.', 'danger');
                }
            } else {
                loginSection.style.display = 'flex';
                adminDashboard.style.display = 'none';
            }
        });

        // Session timeout (30 minutes of inactivity)
        let sessionTimeout;
        function resetSessionTimeout() {
            clearTimeout(sessionTimeout);
            sessionTimeout = setTimeout(async () => {
                if (auth.currentUser) {
                    alert('Session expired due to inactivity. Please login again.');
                    await auth.signOut();
                }
            }, 30 * 60 * 1000); // 30 minutes
        }

        // Reset timeout on user activity
        ['mousedown', 'keydown', 'scroll', 'touchstart'].forEach(event => {
            document.addEventListener(event, resetSessionTimeout, true);
        });

        // ========================================
        // SECTION NAVIGATION
        // ========================================

        // Show section and handle button states
        // Section titles and icons
        const sectionConfig = {
            settings: { title: 'Settings', icon: 'fa-cog', subtitle: 'Manage system configurations' },
            users: { title: 'User Management', icon: 'fa-users', subtitle: 'Manage users and permissions' },
            tools: { title: 'Tool Management', icon: 'fa-toolbox', subtitle: 'View and manage all tools' },
            analytics: { title: 'Analytics & Reports', icon: 'fa-chart-bar', subtitle: 'View system analytics and activity' },
            checkups: { title: 'Collection Checkups', icon: 'fa-clipboard-check', subtitle: 'Review checkup history' },
            activity: { title: 'Check User Activity', icon: 'fa-user-check', subtitle: 'Track tool usage and registration' }
        };

        // Ensure functions are available immediately
        console.log('Defining openSectionModal function...');

        // Open section in modal
        window.openSectionModal = function(sectionId) {
            console.log('openSectionModal called with:', sectionId);
            const modal = document.getElementById(sectionId + 'Modal');
            const content = document.getElementById(sectionId);
            const config = sectionConfig[sectionId];
            
            console.log('Modal element:', modal);
            console.log('Content element:', content);
            console.log('Config:', config);
            
            if (!modal || !content || !config) {
                console.error('Missing elements:', { modal, content, config });
                return;
            }
            
            // Create modal structure
            const modalContent = document.createElement('div');
            modalContent.className = 'section-modal-content';
            modalContent.innerHTML = `
                <div class="section-modal-header">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <h3 class="mb-0"><i class="fas ${config.icon}"></i> ${config.title}</h3>
                            <small>${config.subtitle}</small>
                        </div>
                        <button class="btn btn-light" onclick="closeSectionModal('${sectionId}Modal')">
                            <i class="fas fa-times"></i> Close
                        </button>
                    </div>
                </div>
                <div class="section-modal-body" id="${sectionId}ModalBody">
                </div>
            `;
            
            // Move the actual content into the modal
            const modalBody = modalContent.querySelector('.section-modal-body');
            modalBody.appendChild(content);
            content.style.display = 'block';
            
            // Append to modal
            modal.innerHTML = '';
            modal.appendChild(modalContent);
            
            // Show modal
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // Load data for specific sections
            if (sectionId === 'checkups') {
                setTimeout(() => loadCheckupUsers(), 100);
            } else if (sectionId === 'users') {
                setTimeout(() => loadUsers(), 100);
            } else if (sectionId === 'tools') {
                setTimeout(() => loadTools(), 100);
            } else if (sectionId === 'analytics') {
                setTimeout(() => loadAnalytics(), 100);
            } else if (sectionId === 'activity') {
                setTimeout(() => loadAllToolsForActivity(), 100);
            }
        };

        console.log('openSectionModal function defined successfully');

        // Close section modal
        window.closeSectionModal = function(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            
            const sectionId = modalId.replace('Modal', '');
            const content = document.getElementById(sectionId);
            const hiddenContainer = document.getElementById('adminSectionsContent');
            
            // Move content back to hidden container
            if (content && hiddenContainer) {
                hiddenContainer.appendChild(content);
            }
            
            modal.classList.remove('active');
            document.body.style.overflow = '';
            
            // Clear modal content after animation
            setTimeout(() => {
                modal.innerHTML = '';
            }, 300);
        };

        // Close modal on background click
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('section-modal')) {
                closeSectionModal(e.target.id);
            }
        });

        // Close modal on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                document.querySelectorAll('.section-modal.active').forEach(modal => {
                    closeSectionModal(modal.id);
                });
            }
        });

        // Load all tools for activity dropdown
        async function loadAllToolsForActivity() {
            if (allToolsForActivity.length > 0) return; // Already loaded

            try {
                const toolsSnapshot = await db.collection('tools').get();
                allToolsForActivity = [];
                
                toolsSnapshot.forEach(doc => {
                    allToolsForActivity.push({
                        id: doc.id,
                        toolName: doc.data().toolName || 'Unknown Tool',
                        partNumber: doc.data().partNumber || '',
                        owner: doc.data().collectionName || 'Unknown',
                        status: doc.data().status || 'Unknown'
                    });
                });

                // Sort by tool ID
                allToolsForActivity.sort((a, b) => a.id.toLowerCase().localeCompare(b.id.toLowerCase()));
            } catch (error) {
                console.error('Error loading tools for activity:', error);
            }
        }

        // ========================================
        // CHECKUPS MANAGEMENT FUNCTIONALITY
        // ========================================

        let allCheckupData = [];
        let filteredCheckupData = [];
        let selectedCheckupIds = new Set();
        let currentSelectedUser = null;
        let currentSelectedCollection = null;

        // Load all users (showing those without checkups as disabled)
        async function loadCheckupUsers() {
            const loading = document.getElementById('checkupUsersLoading');
            const usersList = document.getElementById('checkupUsersList');
            
            try {
                loading.style.display = 'block';
                usersList.innerHTML = '';

                // Get all checkup results
                const checkupsSnapshot = await db.collection('checkupResults').get();
                
                // Group by technician name and count checkups
                const userCheckupCounts = {};
                checkupsSnapshot.forEach(doc => {
                    const data = doc.data();
                    const techName = data.technician || 'Unknown';
                    userCheckupCounts[techName] = (userCheckupCounts[techName] || 0) + 1;
                });

                // Get all technicians from the technicians collection
                const techniciansSnapshot = await db.collection('technicians').get();
                const usersWithCheckups = [];
                const usersWithoutCheckups = [];
                
                techniciansSnapshot.forEach(doc => {
                    const userData = doc.data();
                    const userName = userData.fullName || userData.email || 'Unknown';
                    const checkupCount = userCheckupCounts[userName] || 0;
                    
                    const userObj = {
                        name: userName,
                        checkupCount: checkupCount,
                        hasCheckups: checkupCount > 0
                    };

                    if (checkupCount > 0) {
                        usersWithCheckups.push(userObj);
                    } else {
                        usersWithoutCheckups.push(userObj);
                    }
                });

                // Sort both groups alphabetically
                usersWithCheckups.sort((a, b) => a.name.toLowerCase().localeCompare(b.name.toLowerCase()));
                usersWithoutCheckups.sort((a, b) => a.name.toLowerCase().localeCompare(b.name.toLowerCase()));

                if (usersWithCheckups.length === 0 && usersWithoutCheckups.length === 0) {
                    usersList.innerHTML = '<p class="text-muted text-center">No users found in the system.</p>';
                } else {
                    let currentNumber = 1;

                    // Group 1: Users WITH checkups
                    if (usersWithCheckups.length > 0) {
                        // Add group header
                        const groupHeader1 = document.createElement('div');
                        groupHeader1.style.cssText = 'background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 12px 20px; border-radius: 10px; margin-bottom: 15px; font-weight: bold; font-size: 1.1rem; box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);';
                        groupHeader1.innerHTML = `
                            <i class="fas fa-check-circle"></i> Active Users (${usersWithCheckups.length})
                            <span style="float: right; font-size: 0.9rem; opacity: 0.9;">Has performed checkups</span>
                        `;
                        usersList.appendChild(groupHeader1);

                        usersWithCheckups.forEach((user) => {
                            const userItem = document.createElement('div');
                            userItem.className = 'user-list-item';
                            userItem.onclick = () => selectCheckupUser(user.name);
                            
                            userItem.innerHTML = `
                                <div class="user-number">${currentNumber}</div>
                                <div class="user-info">
                                    <div class="user-name">${user.name}</div>
                                    <div class="user-checkup-count">${user.checkupCount} checkup${user.checkupCount !== 1 ? 's' : ''}</div>
                                </div>
                                <div class="user-arrow">
                                    <i class="fas fa-chevron-right"></i>
                                </div>
                            `;
                            usersList.appendChild(userItem);
                            currentNumber++;
                        });
                    }

                    // Group 2: Users WITHOUT checkups
                    if (usersWithoutCheckups.length > 0) {
                        // Add spacing and group header
                        const spacer = document.createElement('div');
                        spacer.style.height = '30px';
                        usersList.appendChild(spacer);

                        const groupHeader2 = document.createElement('div');
                        groupHeader2.style.cssText = 'background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%); color: white; padding: 12px 20px; border-radius: 10px; margin-bottom: 15px; font-weight: bold; font-size: 1.1rem; box-shadow: 0 2px 8px rgba(108, 117, 125, 0.3);';
                        groupHeader2.innerHTML = `
                            <i class="fas fa-user-times"></i> Inactive Users (${usersWithoutCheckups.length})
                            <span style="float: right; font-size: 0.9rem; opacity: 0.9;">No checkups performed yet</span>
                        `;
                        usersList.appendChild(groupHeader2);

                        usersWithoutCheckups.forEach((user) => {
                            const userItem = document.createElement('div');
                            userItem.className = 'user-list-item';
                            userItem.style.opacity = '0.5';
                            userItem.style.cursor = 'not-allowed';
                            userItem.style.borderLeftColor = '#ccc';
                            
                            userItem.innerHTML = `
                                <div class="user-number" style="background: #ccc;">${currentNumber}</div>
                                <div class="user-info">
                                    <div class="user-name">${user.name}</div>
                                    <div class="user-checkup-count">0 checkups</div>
                                </div>
                                <div class="user-arrow" style="color: #ccc;">
                                    <i class="fas fa-ban"></i>
                                </div>
                            `;
                            usersList.appendChild(userItem);
                            currentNumber++;
                        });
                    }
                }

                loading.style.display = 'none';
            } catch (error) {
                console.error('Error loading checkup users:', error);
                usersList.innerHTML = '<p class="text-danger text-center">Error loading users</p>';
                loading.style.display = 'none';
            }
        }

        // User search functionality
        document.getElementById('checkupUserSearch').addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const userItems = document.querySelectorAll('#checkupUsersList .user-list-item');
            userItems.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(searchTerm) ? 'flex' : 'none';
            });
        });

        // Select a user and load all their checkups
        window.selectCheckupUser = async function(userName) {
            currentSelectedUser = userName;
            currentSelectedCollection = 'All'; // Show all collections
            
            // Update header
            document.getElementById('selectedCollectionName').textContent = `All Checkups for ${userName}`;
            
            // Hide step 1, show step 3 directly
            document.getElementById('checkupStep1').style.display = 'none';
            document.getElementById('checkupStep2').style.display = 'none';
            document.getElementById('checkupStep3').style.display = 'block';

            // Load all checkup history for this user
            await loadCheckupHistoryForUser(userName);
        };

        // Reset to user selection
        window.resetCheckupSelection = function() {
            currentSelectedUser = null;
            currentSelectedCollection = null;
            document.getElementById('checkupStep1').style.display = 'block';
            document.getElementById('checkupStep2').style.display = 'none';
            document.getElementById('checkupStep3').style.display = 'none';
            document.getElementById('checkupUserSearch').value = '';
        };

        // Back to user list (renamed from backToCollections)
        window.backToCollections = function() {
            resetCheckupSelection();
        };

        // Select a collection and show checkup history
        window.selectCheckupCollection = async function(collectionName) {
            currentSelectedCollection = collectionName;
            document.getElementById('selectedCollectionName').textContent = collectionName;
            
            // Hide step 2, show step 3
            document.getElementById('checkupStep2').style.display = 'none';
            document.getElementById('checkupStep3').style.display = 'block';

            // Load checkup history
            await loadCheckupHistory();
        };

        // Load checkup history for a user (all collections)
        async function loadCheckupHistoryForUser(userName) {
            const loading = document.getElementById('checkupHistoryLoading');
            const tableContainer = document.getElementById('checkupHistoryTableContainer');
            const noMessage = document.getElementById('noCheckupsMessage');
            
            try {
                loading.style.display = 'block';
                tableContainer.style.display = 'none';
                noMessage.style.display = 'none';

                // Get all checkups for this user (all collections)
                const checkupsSnapshot = await db.collection('checkupResults')
                    .where('technician', '==', userName)
                    .get();

                allCheckupData = [];
                checkupsSnapshot.forEach(doc => {
                    allCheckupData.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                // Sort by timestamp (newest first)
                allCheckupData.sort((a, b) => {
                    const timeA = a.timestamp ? a.timestamp.toDate() : new Date(0);
                    const timeB = b.timestamp ? b.timestamp.toDate() : new Date(0);
                    return timeB - timeA;
                });

                // Initially show all
                filteredCheckupData = [...allCheckupData];
                renderCheckupHistory();

                loading.style.display = 'none';
            } catch (error) {
                console.error('Error loading checkup history:', error);
                loading.style.display = 'none';
                alert('Error loading checkup history: ' + error.message);
            }
        }

        // Load checkup history for selected user and collection
        async function loadCheckupHistory() {
            const loading = document.getElementById('checkupHistoryLoading');
            const tableContainer = document.getElementById('checkupHistoryTableContainer');
            const noMessage = document.getElementById('noCheckupsMessage');
            
            try {
                loading.style.display = 'block';
                tableContainer.style.display = 'none';
                noMessage.style.display = 'none';

                // Get all checkups for this user and collection
                const checkupsSnapshot = await db.collection('checkupResults')
                    .where('technician', '==', currentSelectedUser)
                    .where('collectionCode', '==', currentSelectedCollection)
                    .get();

                allCheckupData = [];
                checkupsSnapshot.forEach(doc => {
                    allCheckupData.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                // Sort by timestamp (newest first)
                allCheckupData.sort((a, b) => {
                    const timeA = a.timestamp ? a.timestamp.toDate() : new Date(0);
                    const timeB = b.timestamp ? b.timestamp.toDate() : new Date(0);
                    return timeB - timeA;
                });

                // Initially show all
                filteredCheckupData = [...allCheckupData];
                renderCheckupHistory();

                loading.style.display = 'none';
            } catch (error) {
                console.error('Error loading checkup history:', error);
                loading.style.display = 'none';
                alert('Error loading checkup history: ' + error.message);
            }
        }

        // Filter checkups by time period
        window.filterCheckups = function(period) {
            const now = new Date();
            let startDate;

            switch (period) {
                case 'today':
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    break;
                case 'week':
                    startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    break;
                case 'month':
                    startDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                    break;
                case 'year':
                    startDate = new Date(now.getTime() - 365 * 24 * 60 * 60 * 1000);
                    break;
                case 'all':
                default:
                    filteredCheckupData = [...allCheckupData];
                    renderCheckupHistory();
                    return;
            }

            filteredCheckupData = allCheckupData.filter(checkup => {
                const checkupDate = checkup.timestamp ? checkup.timestamp.toDate() : new Date(0);
                return checkupDate >= startDate;
            });

            renderCheckupHistory();
        };

        // Render checkup history table
        function renderCheckupHistory() {
            const tableBody = document.getElementById('checkupHistoryTableBody');
            const tableContainer = document.getElementById('checkupHistoryTableContainer');
            const noMessage = document.getElementById('noCheckupsMessage');
            
            selectedCheckupIds.clear();
            document.getElementById('selectAllCheckups').checked = false;
            updateDeleteButton();

            if (filteredCheckupData.length === 0) {
                tableContainer.style.display = 'none';
                noMessage.style.display = 'block';
                updateAnalytics([]);
                return;
            }

            tableContainer.style.display = 'block';
            noMessage.style.display = 'none';
            tableBody.innerHTML = '';

            filteredCheckupData.forEach(checkup => {
                const completionPercent = checkup.totalTools > 0 
                    ? Math.round((checkup.checkedTools / checkup.totalTools) * 100) 
                    : 0;
                
                const dateStr = checkup.timestamp 
                    ? checkup.timestamp.toDate().toLocaleString('en-GB')
                    : checkup.checkupDate || 'Unknown';

                const collectionName = checkup.collectionCode || 'Unknown';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <input type="checkbox" class="checkup-checkbox" data-id="${checkup.id}" onchange="updateDeleteButton()">
                    </td>
                    <td>${dateStr}</td>
                    <td><span style="color: #667eea; font-weight: bold;">${collectionName}</span></td>
                    <td>${checkup.totalTools || 0}</td>
                    <td><span style="color: #28a745; font-weight: bold;">${checkup.checkedTools || 0}</span></td>
                    <td><span style="color: #dc3545; font-weight: bold;">${checkup.uncheckedTools || 0}</span></td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="flex: 1; background: #e0e0e0; border-radius: 10px; height: 20px; overflow: hidden;">
                                <div style="background: ${completionPercent >= 80 ? '#28a745' : completionPercent >= 50 ? '#ff9800' : '#dc3545'}; height: 100%; width: ${completionPercent}%; transition: width 0.3s ease;"></div>
                            </div>
                            <span style="font-weight: bold; min-width: 45px;">${completionPercent}%</span>
                        </div>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="viewCheckupDetails('${checkup.id}')">
                            <i class="fas fa-eye"></i> View
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteSingleCheckup('${checkup.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            updateAnalytics(filteredCheckupData);
        }

        // Update analytics summary
        function updateAnalytics(data) {
            if (data.length === 0) {
                document.getElementById('totalCheckups').textContent = '0';
                document.getElementById('avgCompletion').textContent = '0%';
                document.getElementById('avgToolsChecked').textContent = '0';
                document.getElementById('lastCheckupDate').textContent = 'N/A';
                return;
            }

            // Total checkups
            document.getElementById('totalCheckups').textContent = data.length;

            // Average completion
            const avgCompletion = data.reduce((sum, c) => {
                const percent = c.totalTools > 0 ? (c.checkedTools / c.totalTools) * 100 : 0;
                return sum + percent;
            }, 0) / data.length;
            document.getElementById('avgCompletion').textContent = Math.round(avgCompletion) + '%';

            // Average tools checked
            const avgToolsChecked = data.reduce((sum, c) => sum + (c.checkedTools || 0), 0) / data.length;
            document.getElementById('avgToolsChecked').textContent = Math.round(avgToolsChecked);

            // Last checkup date
            const lastCheckup = data[0]; // Already sorted by newest first
            const lastDate = lastCheckup.timestamp 
                ? lastCheckup.timestamp.toDate().toLocaleDateString('en-GB')
                : lastCheckup.checkupDate || 'Unknown';
            document.getElementById('lastCheckupDate').textContent = lastDate;
        }

        // Toggle select all checkups
        window.toggleSelectAllCheckups = function() {
            const selectAll = document.getElementById('selectAllCheckups').checked;
            const checkboxes = document.querySelectorAll('.checkup-checkbox');
            
            selectedCheckupIds.clear();
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll;
                if (selectAll) {
                    selectedCheckupIds.add(checkbox.dataset.id);
                }
            });
            
            updateDeleteButton();
        };

        // Update delete button state
        function updateDeleteButton() {
            selectedCheckupIds.clear();
            document.querySelectorAll('.checkup-checkbox:checked').forEach(checkbox => {
                selectedCheckupIds.add(checkbox.dataset.id);
            });
            
            const deleteBtn = document.getElementById('deleteSelectedCheckupsBtn');
            const count = selectedCheckupIds.size;
            document.getElementById('selectedCheckupsCount').textContent = count;
            deleteBtn.disabled = count === 0;
        }

        // Delete selected checkups
        window.deleteSelectedCheckups = async function() {
            if (selectedCheckupIds.size === 0) return;

            const confirmMsg = `Are you sure you want to delete ${selectedCheckupIds.size} checkup(s)?\n\nThis action cannot be undone!`;
            if (!confirm(confirmMsg)) return;

            try {
                const deletePromises = Array.from(selectedCheckupIds).map(id => 
                    db.collection('checkupResults').doc(id).delete()
                );
                
                await Promise.all(deletePromises);
                
                alert(` Successfully deleted ${selectedCheckupIds.size} checkup(s)!`);
                
                // Reload checkup history
                await loadCheckupHistory();
            } catch (error) {
                console.error('Error deleting checkups:', error);
                alert('Error deleting checkups: ' + error.message);
            }
        };

        // Delete single checkup
        window.deleteSingleCheckup = async function(checkupId) {
            if (!confirm('Are you sure you want to delete this checkup?\n\nThis action cannot be undone!')) {
                return;
            }

            try {
                await db.collection('checkupResults').doc(checkupId).delete();
                alert(' Checkup deleted successfully!');
                await loadCheckupHistory();
            } catch (error) {
                console.error('Error deleting checkup:', error);
                alert('Error deleting checkup: ' + error.message);
            }
        };

        // View checkup details
        window.viewCheckupDetails = async function(checkupId) {
            const checkup = allCheckupData.find(c => c.id === checkupId);
            if (!checkup) {
                alert('Checkup not found.');
                return;
            }

            const modalBody = document.getElementById('checkupDetailsModalBody');
            modalBody.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div><p>Loading details...</p></div>';
            
            const modal = new bootstrap.Modal(document.getElementById('checkupDetailsModal'));
            modal.show();

            try {
                const dateStr = checkup.timestamp 
                    ? checkup.timestamp.toDate().toLocaleString('en-GB')
                    : checkup.checkupDate || 'Unknown';

                const completionPercent = checkup.totalTools > 0 
                    ? Math.round((checkup.checkedTools / checkup.totalTools) * 100) 
                    : 0;

                let detailsHTML = `
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6><i class="fas fa-user"></i> Technician:</h6>
                            <p style="font-size: 1.1rem; font-weight: bold;">${checkup.technician || 'Unknown'}</p>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-calendar"></i> Date & Time:</h6>
                            <p style="font-size: 1.1rem; font-weight: bold;">${dateStr}</p>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="text-center p-3" style="background: #f8f9fa; border-radius: 10px;">
                                <h6>Total Tools</h6>
                                <h3 style="color: #667eea;">${checkup.totalTools || 0}</h3>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-3" style="background: #f8f9fa; border-radius: 10px;">
                                <h6>Checked</h6>
                                <h3 style="color: #28a745;">${checkup.checkedTools || 0}</h3>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-3" style="background: #f8f9fa; border-radius: 10px;">
                                <h6>Unchecked</h6>
                                <h3 style="color: #dc3545;">${checkup.uncheckedTools || 0}</h3>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-3" style="background: #f8f9fa; border-radius: 10px;">
                                <h6>Completion</h6>
                                <h3 style="color: ${completionPercent >= 80 ? '#28a745' : completionPercent >= 50 ? '#ff9800' : '#dc3545'};">${completionPercent}%</h3>
                            </div>
                        </div>
                    </div>
                `;

                // Location stats
                if (checkup.locationStats && Object.keys(checkup.locationStats).length > 0) {
                    detailsHTML += `
                        <h6 class="mt-4 mb-3"><i class="fas fa-map-marker-alt"></i> Location Statistics:</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead style="background: #667eea; color: white;">
                                    <tr>
                                        <th>Location</th>
                                        <th>Total Tools</th>
                                        <th>Checked</th>
                                        <th>Unchecked</th>
                                        <th>Completion %</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;

                    Object.entries(checkup.locationStats).forEach(([location, stats]) => {
                        const locCompletion = stats.total > 0 ? Math.round((stats.checked / stats.total) * 100) : 0;
                        detailsHTML += `
                            <tr>
                                <td><strong>${location}</strong></td>
                                <td>${stats.total}</td>
                                <td style="color: #28a745; font-weight: bold;">${stats.checked}</td>
                                <td style="color: #dc3545; font-weight: bold;">${stats.unchecked}</td>
                                <td>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <div style="flex: 1; background: #e0e0e0; border-radius: 10px; height: 15px; overflow: hidden;">
                                            <div style="background: ${locCompletion >= 80 ? '#28a745' : locCompletion >= 50 ? '#ff9800' : '#dc3545'}; height: 100%; width: ${locCompletion}%;"></div>
                                        </div>
                                        <span style="font-weight: bold; min-width: 40px;">${locCompletion}%</span>
                                    </div>
                                </td>
                            </tr>
                        `;
                    });

                    detailsHTML += `
                                </tbody>
                            </table>
                        </div>
                    `;
                }

                // Unchecked tools list
                if (checkup.uncheckedTools > 0 && checkup.allToolIds && checkup.checkedToolIds) {
                    const uncheckedIds = checkup.allToolIds.filter(id => !checkup.checkedToolIds.includes(id));
                    
                    if (uncheckedIds.length > 0) {
                        detailsHTML += `
                            <h6 class="mt-4 mb-3"><i class="fas fa-exclamation-triangle text-warning"></i> Unchecked Tools (${uncheckedIds.length}):</h6>
                            <div style="max-height: 300px; overflow-y: auto; background: #f8f9fa; padding: 15px; border-radius: 10px;">
                        `;

                        // Fetch tool details
                        const toolDetails = [];
                        for (let i = 0; i < uncheckedIds.length; i += 10) {
                            const batch = uncheckedIds.slice(i, i + 10);
                            const snapshot = await db.collection('tools')
                                .where(firebase.firestore.FieldPath.documentId(), 'in', batch)
                                .get();
                            snapshot.forEach(doc => {
                                toolDetails.push({ id: doc.id, ...doc.data() });
                            });
                        }

                        toolDetails.forEach(tool => {
                            detailsHTML += `
                                <div style="padding: 10px; margin-bottom: 10px; background: white; border-radius: 8px; border-left: 4px solid #dc3545;">
                                    <strong>${tool.toolName || 'Unknown Tool'}</strong><br>
                                    <small style="color: #666;">
                                        TID: ${tool.id} | P/N: ${tool.partNumber || 'N/A'} | Location: ${tool.location || 'N/A'}
                                    </small>
                                </div>
                            `;
                        });

                        detailsHTML += `</div>`;
                    }
                }

                modalBody.innerHTML = detailsHTML;
            } catch (error) {
                console.error('Error loading checkup details:', error);
                modalBody.innerHTML = '<p class="text-danger">Error loading details: ' + error.message + '</p>';
            }
        };

        // ========================================
        // USER ACTIVITY CHECKER FUNCTIONALITY
        // ========================================

        let activityQrCodeScanner = null;
        let allToolsForActivity = []; // Cache all tools for dropdown

        // Toggle QR Scanner
        window.toggleActivityScanner = async function() {
            const qrReaderDiv = document.getElementById('activityQrReader');
            const scanBtn = document.getElementById('activityScanBtn');

            if (qrReaderDiv.style.display === 'none') {
                // Show and start scanner
                qrReaderDiv.style.display = 'block';
                scanBtn.innerHTML = '<i class="fas fa-qrcode"></i> Scanning...';
                scanBtn.disabled = true;

                try {
                    activityQrCodeScanner = new Html5Qrcode("activityQrReaderElement");
                    
                    await activityQrCodeScanner.start(
                        { facingMode: "environment" },
                        {
                            fps: 10,
                            qrbox: { width: 250, height: 250 }
                        },
                        (decodedText) => {
                            // On scan success
                            document.getElementById('activityToolSearch').value = decodedText;
                            document.getElementById('activityDropdown').style.display = 'none';
                            stopActivityScanner();
                            searchToolActivity();
                        },
                        (errorMessage) => {
                            // Scan error (can be ignored)
                        }
                    );
                } catch (error) {
                    console.error('Error starting scanner:', error);
                    alert('Error starting camera: ' + error.message);
                    stopActivityScanner();
                }
            } else {
                stopActivityScanner();
            }
        };

        // Stop QR Scanner
        window.stopActivityScanner = function() {
            const qrReaderDiv = document.getElementById('activityQrReader');
            const scanBtn = document.getElementById('activityScanBtn');

            if (activityQrCodeScanner) {
                activityQrCodeScanner.stop().then(() => {
                    activityQrCodeScanner.clear();
                    activityQrCodeScanner = null;
                }).catch(err => {
                    console.error('Error stopping scanner:', err);
                });
            }

            qrReaderDiv.style.display = 'none';
            scanBtn.innerHTML = '<i class="fas fa-qrcode"></i> Scan QR';
            scanBtn.disabled = false;
        };

        // Search for tool activity
        window.searchToolActivity = async function() {
            const searchInput = document.getElementById('activityToolSearch');
            const toolCode = searchInput.value.trim();
            const resultsDiv = document.getElementById('activityResults');

            if (!toolCode) {
                alert('Please enter a tool code or scan a QR code');
                return;
            }

            // Show loading
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = `
                <div class="text-center" style="padding: 40px;">
                    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p style="margin-top: 20px; font-size: 1.1rem;">Searching for tool: <strong>${toolCode}</strong></p>
                </div>
            `;

            try {
                // Search for the tool (case-insensitive)
                const toolsSnapshot = await db.collection('tools').get();
                let foundTool = null;

                // Find tool with case-insensitive match
                toolsSnapshot.forEach(doc => {
                    if (doc.id.toLowerCase() === toolCode.toLowerCase()) {
                        foundTool = { id: doc.id, ...doc.data() };
                    }
                });

                if (!foundTool) {
                    // Tool not found
                    resultsDiv.innerHTML = `
                        <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 12px; padding: 30px; text-align: center;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #ffc107; margin-bottom: 15px;"></i>
                            <h4 style="color: #856404;">Tool Not Found</h4>
                            <p style="color: #856404; font-size: 1.1rem;">
                                No tool found with code: <strong>${toolCode}</strong>
                            </p>
                            <p style="color: #666;">Please check the code and try again.</p>
                        </div>
                    `;
                    return;
                }

                // Get the most recent log entry for this tool
                const logsSnapshot = await db.collection('logtoolmovements')
                    .where('toolId', '==', foundTool.id)
                    .orderBy('timestamp', 'desc')
                    .limit(1)
                    .get();

                let lastActivity = null;
                if (!logsSnapshot.empty) {
                    lastActivity = logsSnapshot.docs[0].data();
                }

                // Determine current owner
                const currentOwner = foundTool.collectionName || 'Unknown';
                const currentStatus = foundTool.status || 'Unknown';
                const registeredAt = foundTool.registeredAt ? foundTool.registeredAt.toDate().toLocaleString('en-GB') : 'Unknown';
                const lastUser = lastActivity ? lastActivity.technician : 'N/A';
                const lastActionTime = lastActivity && lastActivity.timestamp ? lastActivity.timestamp.toDate().toLocaleString('en-GB') : 'N/A';
                const lastAction = lastActivity ? lastActivity.status : 'N/A';
                const workLocation = foundTool.WorkOn || 'N/A';

                // Build result HTML
                let statusColor = currentStatus === 'IN' ? '#28a745' : currentStatus === 'OUT' ? '#dc3545' : '#6c757d';
                let statusIcon = currentStatus === 'IN' ? 'fa-check-circle' : currentStatus === 'OUT' ? 'fa-sign-out-alt' : 'fa-question-circle';

                resultsDiv.innerHTML = `
                    <div style="background: white; border: 3px solid ${statusColor}; border-radius: 15px; padding: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        <!-- Tool Header -->
                        <div style="text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #e0e0e0;">
                            <i class="fas fa-tools" style="font-size: 3rem; color: #667eea; margin-bottom: 15px;"></i>
                            <h3 style="margin: 0; color: #333;">${foundTool.toolName || 'Unknown Tool'}</h3>
                            <p style="color: #666; font-size: 1.1rem; margin: 5px 0;">
                                <strong>TID:</strong> ${foundTool.id}
                            </p>
                            <div style="display: inline-block; background: ${statusColor}; color: white; padding: 8px 20px; border-radius: 20px; font-weight: bold; font-size: 1.1rem; margin-top: 10px;">
                                <i class="fas ${statusIcon}"></i> ${currentStatus}
                            </div>
                        </div>

                        <!-- Tool Information Grid -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; height: 100%;">
                                    <h5 style="color: #667eea; margin-bottom: 15px;">
                                        <i class="fas fa-user"></i> Current Owner
                                    </h5>
                                    <p style="font-size: 1.2rem; font-weight: bold; color: #333; margin: 0;">
                                        ${currentOwner}
                                    </p>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; height: 100%;">
                                    <h5 style="color: #667eea; margin-bottom: 15px;">
                                        <i class="fas fa-map-marker-alt"></i> Work Location
                                    </h5>
                                    <p style="font-size: 1.2rem; font-weight: bold; color: #333; margin: 0;">
                                        ${workLocation}
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Registration Details -->
                        <div style="background: #e3f2fd; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                            <h5 style="color: #1976d2; margin-bottom: 15px;">
                                <i class="fas fa-calendar-plus"></i> Registration Information
                            </h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <p style="margin: 5px 0;">
                                        <strong>Registered On:</strong> ${registeredAt}
                                    </p>
                                </div>
                                <div class="col-md-6">
                                    <p style="margin: 5px 0;">
                                        <strong>Part Number:</strong> ${foundTool.partNumber || 'N/A'}
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Last Activity -->
                        <div style="background: #fff3e0; padding: 20px; border-radius: 10px;">
                            <h5 style="color: #f57c00; margin-bottom: 15px;">
                                <i class="fas fa-history"></i> Last Activity
                            </h5>
                            <div class="row">
                                <div class="col-md-4">
                                    <p style="margin: 5px 0;">
                                        <strong>Last User:</strong><br>
                                        <span style="color: #333; font-size: 1.1rem;">${lastUser}</span>
                                    </p>
                                </div>
                                <div class="col-md-4">
                                    <p style="margin: 5px 0;">
                                        <strong>Last Action:</strong><br>
                                        <span style="color: ${lastAction === 'IN' ? '#28a745' : '#dc3545'}; font-size: 1.1rem; font-weight: bold;">${lastAction}</span>
                                    </p>
                                </div>
                                <div class="col-md-4">
                                    <p style="margin: 5px 0;">
                                        <strong>Action Time:</strong><br>
                                        <span style="color: #333; font-size: 1.1rem;">${lastActionTime}</span>
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Additional Details -->
                        ${foundTool.location ? `
                            <div style="margin-top: 20px; padding: 15px; background: #f1f8e9; border-left: 4px solid #8bc34a; border-radius: 8px;">
                                <p style="margin: 0;">
                                    <i class="fas fa-map-pin"></i> <strong>Storage Location:</strong> ${foundTool.location}
                                </p>
                            </div>
                        ` : ''}

                        <!-- Action Buttons -->
                        <div style="margin-top: 30px; text-align: center; display: flex; gap: 15px; justify-content: center;">
                            <button class="btn btn-primary btn-lg" onclick="viewToolHistory('${foundTool.id}')">
                                <i class="fas fa-history"></i> View Full History
                            </button>
                            <button class="btn btn-secondary btn-lg" onclick="clearActivityResults()">
                                <i class="fas fa-search"></i> Search Another Tool
                            </button>
                        </div>
                    </div>
                `;

            } catch (error) {
                console.error('Error searching for tool:', error);
                resultsDiv.innerHTML = `
                    <div style="background: #f8d7da; border: 2px solid #dc3545; border-radius: 12px; padding: 30px; text-align: center;">
                        <i class="fas fa-exclamation-circle" style="font-size: 3rem; color: #dc3545; margin-bottom: 15px;"></i>
                        <h4 style="color: #721c24;">Error</h4>
                        <p style="color: #721c24;">An error occurred while searching for the tool.</p>
                        <p style="color: #666;">${error.message}</p>
                    </div>
                `;
            }
        };

        // Clear activity results
        window.clearActivityResults = function() {
            document.getElementById('activityResults').style.display = 'none';
            document.getElementById('activityToolSearch').value = '';
            document.getElementById('activityToolSearch').focus();
        };

        // View tool history (shows all log entries)
        window.viewToolHistory = async function(toolId) {
            const resultsDiv = document.getElementById('activityResults');
            
            resultsDiv.innerHTML = `
                <div class="text-center" style="padding: 40px;">
                    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
                    <p style="margin-top: 20px;">Loading tool history...</p>
                </div>
            `;

            try {
                const logsSnapshot = await db.collection('logtoolmovements')
                    .where('toolId', '==', toolId)
                    .orderBy('timestamp', 'desc')
                    .limit(20)
                    .get();

                let historyHTML = `
                    <div style="background: white; border: 3px solid #667eea; border-radius: 15px; padding: 30px;">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <h4><i class="fas fa-history"></i> Tool Activity History - ${toolId}</h4>
                            <button class="btn btn-secondary" onclick="searchToolActivity()">
                                <i class="fas fa-arrow-left"></i> Back to Tool Details
                            </button>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead style="background: #667eea; color: white;">
                                    <tr>
                                        <th>Date & Time</th>
                                        <th>User</th>
                                        <th>Action</th>
                                        <th>Work Location</th>
                                        <th>Tool Location</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;

                if (logsSnapshot.empty) {
                    historyHTML += `
                        <tr>
                            <td colspan="5" class="text-center text-muted">No activity history found</td>
                        </tr>
                    `;
                } else {
                    logsSnapshot.forEach(doc => {
                        const log = doc.data();
                        const timestamp = log.timestamp ? log.timestamp.toDate().toLocaleString('en-GB') : 'Unknown';
                        const statusColor = log.status === 'IN' ? '#28a745' : '#dc3545';
                        
                        historyHTML += `
                            <tr>
                                <td>${timestamp}</td>
                                <td><strong>${log.technician || 'Unknown'}</strong></td>
                                <td><span style="color: ${statusColor}; font-weight: bold;">${log.status || 'N/A'}</span></td>
                                <td>${log.WorkOn || 'N/A'}</td>
                                <td>${log.location || 'N/A'}</td>
                            </tr>
                        `;
                    });
                }

                historyHTML += `
                                </tbody>
                            </table>
                        </div>
                        <p class="text-muted text-center mt-3">
                            <i class="fas fa-info-circle"></i> Showing last 20 activities
                        </p>
                    </div>
                `;

                resultsDiv.innerHTML = historyHTML;

            } catch (error) {
                console.error('Error loading tool history:', error);
                resultsDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle"></i> Error loading history: ${error.message}
                    </div>
                `;
            }
        };

        // Show dropdown with tool suggestions
        function showActivityDropdown(searchTerm) {
            const dropdown = document.getElementById('activityDropdown');
            
            if (!searchTerm || searchTerm.length < 1) {
                dropdown.style.display = 'none';
                return;
            }

            // Filter tools based on search term (case-insensitive)
            const lowerSearch = searchTerm.toLowerCase();
            const matches = allToolsForActivity.filter(tool => 
                tool.id.toLowerCase().includes(lowerSearch) ||
                tool.toolName.toLowerCase().includes(lowerSearch) ||
                (tool.partNumber && tool.partNumber.toLowerCase().includes(lowerSearch))
            ).slice(0, 10); // Limit to 10 results

            if (matches.length === 0) {
                dropdown.innerHTML = '<div class="activity-dropdown-empty">No tools found matching "' + searchTerm + '"</div>';
                dropdown.style.display = 'block';
                return;
            }

            // Build dropdown HTML
            dropdown.innerHTML = matches.map(tool => {
                const statusColor = tool.status === 'IN' ? '#28a745' : tool.status === 'OUT' ? '#dc3545' : '#6c757d';
                const partNumberDisplay = tool.partNumber ? `P/N: ${tool.partNumber} | ` : '';
                return `
                    <div class="activity-dropdown-item" onclick="selectToolFromDropdown('${tool.id}')">
                        <div class="tool-id">${tool.id}</div>
                        <div class="tool-name">${tool.toolName}</div>
                        <div class="tool-owner">
                            ${partNumberDisplay}Owner: ${tool.owner} | 
                            <span style="color: ${statusColor}; font-weight: bold;">${tool.status}</span>
                        </div>
                    </div>
                `;
            }).join('');

            dropdown.style.display = 'block';
        }

        // Select tool from dropdown
        window.selectToolFromDropdown = function(toolId) {
            document.getElementById('activityToolSearch').value = toolId;
            document.getElementById('activityDropdown').style.display = 'none';
            searchToolActivity();
        };

        // Hide dropdown when clicking outside
        document.addEventListener('click', function(e) {
            const searchInput = document.getElementById('activityToolSearch');
            const dropdown = document.getElementById('activityDropdown');
            
            if (searchInput && dropdown && 
                e.target !== searchInput && 
                !dropdown.contains(e.target)) {
                dropdown.style.display = 'none';
            }
        });

        // Allow Enter key to trigger search and setup input listener
        document.addEventListener('DOMContentLoaded', function() {
            const activitySearch = document.getElementById('activityToolSearch');
            if (activitySearch) {
                // Enter key to search
                activitySearch.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        document.getElementById('activityDropdown').style.display = 'none';
                        searchToolActivity();
                    }
                });

                // Input event to show dropdown
                activitySearch.addEventListener('input', function(e) {
                    showActivityDropdown(e.target.value);
                });

                // Focus event to show dropdown if there's text
                activitySearch.addEventListener('focus', function(e) {
                    if (e.target.value) {
                        showActivityDropdown(e.target.value);
                    }
                });
            }
        });
    </script>
</body>
</html>


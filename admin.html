<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tool Administrator - AMS Tool Tracking</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }

        /* Login Screen Styles */
        .login-container {
            min-height: 100vh;
            display: none; /* Hidden by default - use seamless navigation */
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .login-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 450px;
            width: 100%;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-header i {
            font-size: 4rem;
            color: #667eea;
            margin-bottom: 10px;
        }

        .login-header h2 {
            color: #333;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .login-header p {
            color: #666;
            font-size: 0.95rem;
        }

        .form-control {
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            padding: 12px 15px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }

        .btn-login {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 10px;
            padding: 12px;
            font-size: 1.1rem;
            font-weight: bold;
            color: white;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .btn-login:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
            color: white;
        }

        .btn-google {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 12px;
            font-size: 1rem;
            font-weight: bold;
            color: #666;
            transition: all 0.2s ease;
        }

        .btn-google:hover {
            border-color: #4285f4;
            color: #4285f4;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(66, 133, 244, 0.2);
        }

        .divider {
            text-align: center;
            margin: 20px 0;
            position: relative;
        }

        .divider::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            width: 40%;
            height: 1px;
            background: #e0e0e0;
        }

        .divider::after {
            content: '';
            position: absolute;
            right: 0;
            top: 50%;
            width: 40%;
            height: 1px;
            background: #e0e0e0;
        }

        .divider span {
            background: white;
            padding: 0 10px;
            color: #999;
            font-size: 0.9rem;
        }

        /* Admin Dashboard Styles */
        .admin-dashboard {
            display: none;
            background: #f5f7fa;
            min-height: 100vh;
        }

        .admin-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .admin-header h1 {
            margin: 0;
            font-size: 2.5rem;
            font-weight: bold;
        }

        .admin-welcome {
            font-size: 1.4rem;
            opacity: 0.9;
        }

        /* Back to Menu button 3D interactive Grey */
        .back-to-menu-btn {
            padding: 6px 12px;
            font-size: 0.9rem;
            font-weight: bold;
            border-radius: 12px;
            border: 2px solid #bdbdbd;
            background: linear-gradient(135deg, #e0e0e0 0%, #bdbdbd 100%);
            color: #333;
            text-decoration: none;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(189, 189, 189, 0.3);
            cursor: pointer;
            white-space: nowrap;
            transform: perspective(1000px) rotateX(0deg);
        }

        .back-to-menu-btn:hover {
            background: linear-gradient(135deg, #d0d0d0 0%, #adadad 100%);
            border-color: #adadad;
            transform: perspective(1000px) rotateX(5deg) translateY(-2px);
            box-shadow: 0 4px 12px rgba(189, 189, 189, 0.4),
                        0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .back-to-menu-btn:active {
            transform: perspective(1000px) rotateX(2deg) translateY(0px);
            box-shadow: 0 2px 4px rgba(189, 189, 189, 0.3);
        }

        .admin-content {
            padding: 30px 0;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            margin-bottom: 20px;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
        }

        .stat-card .icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }

        .stat-card h3 {
            font-size: 2rem;
            font-weight: bold;
            margin: 10px 0;
        }

        .stat-card p {
            color: #666;
            margin: 0;
            font-size: 1rem;
        }

        .admin-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
        }

        .admin-card h4 {
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        /* Animated Push Buttons */
        .nav-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 15px;
            padding: 20px 30px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
            margin: 10px;
        }

        .nav-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .nav-button:active {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
        }

        .nav-button.active {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
        }

        .nav-button i {
            margin-right: 10px;
            font-size: 1.2rem;
        }

        .nav-button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .nav-button:hover::before {
            width: 300px;
            height: 300px;
        }

        .nav-buttons-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
        }

        .section-content {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }

        .section-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* User List Styles */
        .user-list-item {
            background: white;
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid #667eea;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .user-list-item:not([style*="cursor: not-allowed"]):hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-left-color: #28a745;
        }

        .user-number {
            background: #667eea;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-weight: bold;
            font-size: 1.1rem;
            color: #333;
            margin-bottom: 3px;
        }

        .user-checkup-count {
            color: #666;
            font-size: 0.9rem;
        }

        .user-arrow {
            color: #667eea;
            font-size: 1.5rem;
        }

        /* Activity Search Dropdown */
        .activity-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #667eea;
            border-top: none;
            border-radius: 0 0 10px 10px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: none;
        }

        .activity-dropdown-item {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s ease;
        }

        .activity-dropdown-item:hover {
            background: #f8f9fa;
        }

        .activity-dropdown-item:last-child {
            border-bottom: none;
        }

        .activity-dropdown-item .tool-id {
            font-weight: bold;
            color: #667eea;
            font-size: 1rem;
        }

        .activity-dropdown-item .tool-name {
            color: #666;
            font-size: 0.9rem;
            margin-top: 3px;
        }

        .activity-dropdown-item .tool-owner {
            color: #999;
            font-size: 0.85rem;
            margin-top: 2px;
        }

        .activity-dropdown-empty {
            padding: 15px;
            text-align: center;
            color: #999;
            font-style: italic;
        }

        .btn-admin-action {
            border-radius: 10px;
            padding: 10px 20px;
            font-weight: bold;
            transition: all 0.2s ease;
        }

        .btn-admin-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
        }

        .settings-group {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .settings-group label {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .user-table {
            margin-top: 20px;
        }

        /* Mobile-friendly user cards */
        .user-card-mobile {
            display: none;
        }

        @media (max-width: 768px) {
            .user-table {
                display: none;
            }

            .user-card-mobile {
                display: block;
            }

            .user-card-item {
                background: white;
                border: 1px solid #dee2e6;
                border-radius: 8px;
                padding: 12px;
                margin-bottom: 10px;
            }

            .user-card-item h6 {
                margin: 0 0 5px 0;
                font-size: 1rem;
                color: #333;
            }

            .user-card-item p {
                margin: 0 0 8px 0;
                font-size: 0.85rem;
                color: #666;
            }

            .user-card-item .btn {
                font-size: 0.75rem;
                padding: 5px 10px;
            }
        }

        .user-table th {
            background: #667eea;
            color: white;
            font-weight: bold;
        }

        /* Tool Cards (matching index.html style) */
        .register-tool-card {
            background: white;
            border: 2px solid #ddd;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .register-tool-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .register-tool-card.in {
            background: #C8E6C9; /* Light green for IN status */
            border-color: #4CAF50;
        }

        .register-tool-card.out {
            background: #FFCDD2; /* Light red for OUT status */
            border-color: #F44336;
        }

        .register-tool-card.broken {
            background: #FFE082;
            border-color: #FFC107;
        }

        .register-tool-card.lost {
            background: #B0BEC5;
            border-color: #607D8B;
        }

        .register-tool-card.calibration {
            background: #BBDEFB;
            border-color: #2196F3;
        }

        .filter-time-btn {
            margin: 2px;
        }

        /* High specificity rules to override Bootstrap */
        button.btn-primary.filter-time-btn.active,
        .btn-primary.filter-time-btn.active,
        button.filter-time-btn.active,
        .filter-time-btn.active {
            background: #ff9800 !important;
            background-color: #ff9800 !important;
            border-color: #ff9800 !important;
            color: white !important;
            font-weight: bold !important;
        }

        /* Additional rule for any active filter button */
        .nav-buttons-container .filter-time-btn.active,
        .admin-card .filter-time-btn.active {
            background: #ff9800 !important;
            background-color: #ff9800 !important;
            border-color: #ff9800 !important;
            color: white !important;
            font-weight: bold !important;
        }

        .user-tool-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: 1px solid #e9ecef;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08),
                        0 1px 3px rgba(0,0,0,0.1);
            position: relative;
            text-align: center;
            transform: perspective(1000px) rotateX(0deg);
        }

        .user-tool-card:hover {
            transform: perspective(1000px) rotateX(-2deg) translateY(-8px) scale(1.02);
            box-shadow: 0 12px 40px rgba(102, 126, 234, 0.25),
                        0 6px 20px rgba(0,0,0,0.15),
                        inset 0 1px 0 rgba(255,255,255,0.9);
            border-color: #667eea;
        }

        .user-tool-card:active {
            transform: perspective(1000px) rotateX(0deg) translateY(-2px) scale(0.98);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.2),
                        0 3px 10px rgba(0,0,0,0.1);
        }

        .user-tool-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 15px 15px 0 0;
        }

        /* Universal layout for all devices - status at bottom center */
        .user-tool-card .d-flex {
            flex-direction: column !important;
            align-items: center !important;
        }

        .user-tool-card h6 {
            margin-bottom: 8px !important;
            font-size: 1rem !important;
            color: #333 !important;
        }

        .user-tool-card small {
            margin-bottom: 15px !important;
            color: #666 !important;
        }

        /* Status badges positioned at bottom center for all devices */
        .user-tool-card .out-badge,
        .user-tool-card span[style*="color: #28a745"] {
            margin-top: 10px !important;
            align-self: center !important;
            font-weight: bold !important;
        }

        .user-tool-card .out-badge {
            background: linear-gradient(135deg, #dc3545, #c82333) !important;
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3) !important;
            border-radius: 20px !important;
            padding: 6px 15px !important;
            font-size: 0.9rem !important;
            color: white !important;
        }

        .user-tool-card span[style*="color: #28a745"] {
            background: linear-gradient(135deg, #28a745, #20c997) !important;
            color: white !important;
            padding: 6px 15px !important;
            border-radius: 20px !important;
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3) !important;
            font-size: 0.9rem !important;
        }

        /* Orange button hover effects */
        button[style*="background-color: #FF9800"] {
            transition: all 0.3s ease;
        }

        button[style*="background-color: #FF9800"]:hover {
            background-color: #F57C00 !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 152, 0, 0.4);
        }

        button[style*="background-color: #FF9800"]:active {
            background-color: #E65100 !important;
            transform: translateY(0);
            box-shadow: 0 2px 6px rgba(255, 152, 0, 0.3);
        }

        .badge-admin {
            background: #28a745;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.85rem;
        }

        .badge-user {
            background: #6c757d;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.85rem;
        }

        .badge-instructor {
            background: #17a2b8;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.85rem;
        }

        .badge-avionics {
            background: #ffc107;
            color: #212529;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.85rem;
        }

        .role-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .role-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .role-buttons .btn {
            font-size: 0.75rem;
            padding: 4px 8px;
        }

        /* 3D Numbering Style for Users */
        .user-number-3d {
            display: inline-block;
            width: 35px;
            height: 35px;
            line-height: 35px;
            text-align: center;
            font-weight: bold;
            font-size: 1rem;
            color: #333;
            background: linear-gradient(135deg, #e0e0e0 0%, #bdbdbd 100%);
            border: 2px solid #9e9e9e;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(158, 158, 158, 0.3),
                        inset 0 1px 0 rgba(255, 255, 255, 0.4),
                        inset 0 -1px 0 rgba(0, 0, 0, 0.2);
            transform: perspective(1000px) rotateX(2deg);
            transition: all 0.3s ease;
        }

        .user-number-3d:hover {
            background: linear-gradient(135deg, #d0d0d0 0%, #adadad 100%);
            border-color: #757575;
            transform: perspective(1000px) rotateX(0deg) translateY(-2px);
            box-shadow: 0 4px 8px rgba(158, 158, 158, 0.4),
                        inset 0 1px 0 rgba(255, 255, 255, 0.5),
                        inset 0 -1px 0 rgba(0, 0, 0, 0.25);
        }

        /* 3D Delete Button Style */
        .delete-user-btn-3d {
            position: relative;
            font-size: 0.75rem;
            padding: 4px 8px;
            font-weight: bold;
            border-radius: 8px;
            border: 2px solid #c62828;
            background: linear-gradient(135deg, #e53935 0%, #c62828 100%);
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(198, 40, 40, 0.3),
                        inset 0 1px 0 rgba(255, 255, 255, 0.3),
                        inset 0 -1px 0 rgba(0, 0, 0, 0.2);
            transform: perspective(1000px) rotateX(2deg);
        }

        .delete-user-btn-3d:hover {
            background: linear-gradient(135deg, #c62828 0%, #b71c1c 100%);
            border-color: #b71c1c;
            transform: perspective(1000px) rotateX(0deg) translateY(-2px);
            box-shadow: 0 4px 8px rgba(198, 40, 40, 0.4),
                        0 2px 4px rgba(0, 0, 0, 0.2),
                        inset 0 1px 0 rgba(255, 255, 255, 0.4),
                        inset 0 -1px 0 rgba(0, 0, 0, 0.25);
        }

        .delete-user-btn-3d:active {
            transform: perspective(1000px) rotateX(2deg) translateY(0px);
            box-shadow: 0 2px 4px rgba(198, 40, 40, 0.3),
                        inset 0 1px 0 rgba(255, 255, 255, 0.3),
                        inset 0 -1px 0 rgba(0, 0, 0, 0.2);
        }

        .alert-custom {
            border-radius: 10px;
            border: none;
            padding: 15px 20px;
        }

        .loading-spinner {
            display: none;
            text-align: center;
            padding: 20px;
        }

        /* Section Modal/Overlay */
        .section-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            overflow-y: auto;
            animation: fadeIn 0.3s ease;
        }

        .section-modal.active {
            display: block;
        }

        .section-modal-content {
            background: #f5f7fa;
            min-height: 100%;
            animation: slideUp 0.3s ease;
        }

        .section-modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .section-modal-header h3 {
            font-size: 1.3rem;
        }

        .section-modal-header small {
            font-size: 0.85rem;
        }

        .section-modal-body {
            padding: 15px;
            max-width: 1400px;
            margin: 0 auto;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }
            to {
                transform: translateY(0);
            }
        }

        /* Desktop: Centered modal */
        @media (min-width: 769px) {
            .section-modal-content {
                max-width: 100% !important;
                margin: 0 !important;
                min-height: 100vh !important;
                border-radius: 0 !important;
                box-shadow: none !important;
            }

            .section-modal-header {
                border-radius: 0 !important;
            }

            /* Larger fonts for tool cards in modals on desktop and tablets */
            #toolHistoryCards .register-tool-card * {
                font-size: 1.5rem !important;
            }

            #toolHistoryCards .register-tool-card h6 {
                font-size: 1.8rem !important;
            }

            #toolHistoryCards .register-tool-card .badge {
                font-size: 1.3rem !important;
                padding: 6px 12px !important;
            }

            #toolHistoryCards .register-tool-card small {
                font-size: 1.3rem !important;
            }
        }

        /* Single vertical row for user cards on very small screens (below 500px) */
        @media (max-width: 500px) {
            #toolsUsersList .col-sm-6,
            #toolsUsersList .col-md-4 {
                flex: 0 0 100% !important;
                max-width: 100% !important;
            }
        }

        @media (max-width: 768px) {
            .login-card {
                padding: 30px 20px;
            }

            .admin-header h1 {
                font-size: 1.2rem !important;
            }

            .admin-header {
                padding: 10px 0 !important;
            }

            /* Much smaller statistics on mobile */
            .stat-card {
                padding: 6px !important;
                margin-bottom: 6px !important;
                border-radius: 8px !important;
            }

            /* Force statistics cards to appear in rows of 2 on mobile */
            .row .col-sm-6 {
                flex: 0 0 50% !important;
                max-width: 50% !important;
            }

            .stat-card .icon {
                font-size: 1.2rem !important;
            }

            .stat-card h3 {
                font-size: 0.9rem !important;
                margin: 2px 0 1px 0 !important;
                font-weight: bold !important;
            }

            .stat-card p {
                font-size: 0.65rem !important;
                margin: 0 !important;
            }

            /* Compact button grid on mobile */
            .nav-buttons-container {
                padding: 5px !important;
                gap: 5px !important;
                margin-bottom: 15px !important;
                display: grid !important;
                grid-template-columns: 1fr 1fr !important;
                justify-items: center !important;
            }

            .nav-button {
                width: 100% !important;
                padding: 8px 10px !important;
                font-size: 0.8rem !important;
                margin: 1px !important;
                min-height: auto !important;
                border-radius: 8px !important;
                box-sizing: border-box !important;
            }

            .nav-button i {
                display: block !important;
                margin: 0 0 3px 0 !important;
                font-size: 1rem !important;
            }

        /* Modal adjustments for mobile */
        .section-modal-header {
            padding: 12px;
        }

        /* Fix z-index for tool history modal to appear above all modals */
        #toolHistoryModal {
            z-index: 99999 !important;
        }

        .modal-backdrop.show + #toolHistoryModal {
            z-index: 99999 !important;
        }

        #toolHistoryModal .modal-backdrop {
            z-index: 99998 !important;
        }

        #toolHistoryModal .modal-dialog {
            z-index: 99999 !important;
            margin: 0 !important;
            max-width: 100% !important;
        }

        /* Full screen modal styling */
        .modal-fullscreen {
            width: 100vw !important;
            max-width: 100vw !important;
            height: 100vh !important;
            max-height: 100vh !important;
            margin: 0 !important;
        }

            .section-modal-header h3 {
                font-size: 1.1rem;
            }

            .section-modal-header small {
                font-size: 0.75rem;
            }

            .section-modal-header .btn {
                padding: 6px 12px;
                font-size: 0.85rem;
            }

            .section-modal-body {
                padding: 10px;
            }

            /* Admin cards smaller on mobile */
            .admin-card {
                padding: 15px;
                margin-bottom: 15px;
            }

            .admin-card h4 {
                font-size: 1.1rem;
                margin-bottom: 15px;
            }

            /* Form elements smaller */
            .form-control {
                font-size: 0.9rem;
                padding: 8px 10px;
            }

            .btn {
                font-size: 0.85rem;
                padding: 8px 12px;
            }

            /* Table responsive - make scrollable */
            .table-responsive {
                font-size: 0.85rem;
            }

            .user-table table {
                min-width: 100%;
                font-size: 0.8rem;
            }

            .user-table th,
            .user-table td {
                padding: 8px 6px;
                white-space: nowrap;
            }

            /* Settings groups */
            .settings-group {
                margin-bottom: 15px;
            }

            .settings-group label {
                font-size: 0.9rem;
            }

            /* User list items */
            .user-list-item {
                padding: 10px;
                margin-bottom: 8px;
            }

            /* Checkup cards */
            .checkup-user-card {
                padding: 12px;
                margin-bottom: 10px;
            }

            /* Reduce margins and padding globally in modals */
            .section-modal-body .row {
                margin-left: -5px;
                margin-right: -5px;
            }

            .section-modal-body .col-md-6,
            .section-modal-body .col-sm-6 {
                padding-left: 5px;
                padding-right: 5px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginSection" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <i class="fas fa-user-shield"></i>
                <h2>Tool Administrator</h2>
                <p>AMS Tool Tracking System</p>
            </div>

            <div id="loginAlert" class="alert alert-custom" style="display: none;"></div>

            <form id="loginForm">
                <div class="mb-3">
                    <label for="adminEmail" class="form-label">
                        <i class="fas fa-envelope"></i> Email Address
                    </label>
                    <input type="email" class="form-control" id="adminEmail" placeholder="admin@example.com" required>
                </div>
                <div class="mb-3">
                    <label for="adminPassword" class="form-label">
                        <i class="fas fa-lock"></i> Password
                    </label>
                    <input type="password" class="form-control" id="adminPassword" placeholder="Enter your password" required>
                </div>
                <button type="submit" class="btn btn-login w-100 mb-3">
                    <i class="fas fa-sign-in-alt"></i> Sign In
                </button>
            </form>

            <div class="divider">
                <span>OR</span>
            </div>

            <button id="googleSignInBtn" class="btn btn-google w-100">
                <i class="fab fa-google"></i> Sign in with Google
            </button>

            <div class="text-center mt-4">
                <a href="index.html" class="text-decoration-none" style="color: #667eea;">
                    <i class="fas fa-arrow-left"></i> Back to Main App
                </a>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="admin-dashboard">
        <!-- Header -->
        <div class="admin-header">
            <div class="container">
                <div>
                    <h1><i class="fas fa-user-shield"></i> Tool Administrator</h1>
                    <p class="admin-welcome mb-2">Welcome, <span id="adminName">Admin</span></p>
                    <div class="d-flex gap-2 align-items-center">
                        <button id="backToMenuBtn" class="back-to-menu-btn" onclick="window.location.href='main-menu.html'">
                            <i class="fas fa-arrow-left"></i> Back to Menu
                        </button>
                        <button class="btn btn-danger btn-admin-action" id="logoutBtn">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Content -->
        <div class="admin-content">
            <div class="container">
                <!-- Statistics -->
                <div class="row mb-4">
                    <div class="col-md-3 col-sm-6">
                        <div class="stat-card text-center">
                            <div class="icon" style="color: #667eea;">
                                <i class="fas fa-tools"></i>
                            </div>
                            <h3 id="totalTools">0</h3>
                            <p>Total Tools</p>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div class="stat-card text-center">
                            <div class="icon" style="color: #28a745;">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <h3 id="toolsIn">0</h3>
                            <p>Tools Checked IN</p>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div class="stat-card text-center">
                            <div class="icon" style="color: #dc3545;">
                                <i class="fas fa-sign-out-alt"></i>
                            </div>
                            <h3 id="toolsOut">0</h3>
                            <p>Tools Checked OUT</p>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div class="stat-card text-center">
                            <div class="icon" style="color: #ff9800;">
                                <i class="fas fa-users"></i>
                            </div>
                            <h3 id="totalUsers">0</h3>
                            <p>Total Users</p>
                        </div>
                    </div>
                </div>

                <!-- Animated Push Buttons -->
                <div class="nav-buttons-container">
                    <button class="nav-button" onclick="openSectionModal('settings')">
                        <i class="fas fa-cog"></i> Settings
                    </button>
                    <button class="nav-button" onclick="openSectionModal('users')">
                        <i class="fas fa-users"></i> Users
                    </button>
                    <button class="nav-button" onclick="openSectionModal('tools')">
                        <i class="fas fa-toolbox"></i> Tools
                    </button>
                    <button class="nav-button" onclick="openSectionModal('analytics')">
                        <i class="fas fa-chart-bar"></i> Analytics
                    </button>
                    <button class="nav-button" onclick="openSectionModal('checkups')">
                        <i class="fas fa-clipboard-check"></i> Checkups
                    </button>
                    <button class="nav-button" onclick="openSectionModal('activity')">
                        <i class="fas fa-user-check"></i> Check User Activity
                    </button>
                </div>

                <!-- Section Content (hidden templates for modals) -->
                <div id="adminSectionsContent" style="display: none;">
                    <!-- Settings Section -->
                    <div class="section-content active" id="settings">
                        <div class="admin-card">
                            <h4><i class="fas fa-cog"></i> System Settings</h4>
                            
                            <div class="settings-group">
                                <label for="adminPassword">Admin Code</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="adminPasswordInput" placeholder="Enter new admin code">
                                    <button class="btn btn-primary" id="updatePasswordBtn">
                                        <i class="fas fa-save"></i> Update
                                    </button>
                                </div>
                                <small class="text-muted">Used for sensitive operations like deleting photos from all tools</small>
                            </div>

                            <div class="settings-group">
                                <label for="cooldownMinutes">Check-In Cooldown (Minutes)</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="cooldownMinutes" placeholder="15" min="1">
                                    <button class="btn btn-primary" id="updateCooldownBtn">
                                        <i class="fas fa-save"></i> Update
                                    </button>
                                </div>
                                <small class="text-muted">Time users must wait before checking in a tool after checkout</small>
                            </div>

                            <div class="settings-group">
                                <label><i class="fas fa-envelope"></i> Email Notification Configuration</label>
                                <div class="card" style="margin-top: 10px;">
                                    <div class="card-body">
                                        <h6 class="card-title">Gmail Account Settings</h6>
                                        
                                        <div class="mb-3">
                                            <label for="emailAccount" class="form-label">Gmail Address</label>
                                            <input type="email" class="form-control" id="emailAccount" placeholder="your-email@gmail.com">
                                            <small class="text-muted">The Gmail account used to send notification emails</small>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="emailAppPassword" class="form-label">Gmail App Password</label>
                                            <input type="password" class="form-control" id="emailAppPassword" placeholder="Enter app password">
                                            <small class="text-muted">
                                                <a href="https://myaccount.google.com/apppasswords" target="_blank">Get App Password</a> - 
                                                Not your regular Gmail password. Generate an app-specific password from Google Account settings.
                                            </small>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="emailFrom" class="form-label">From Email Address</label>
                                            <input type="text" class="form-control" id="emailFrom" placeholder="noreply@tooltracking.com">
                                            <small class="text-muted">The "From" address shown in email headers</small>
                                        </div>
                                        
                                        <button class="btn btn-primary" id="updateEmailConfigBtn">
                                            <i class="fas fa-save"></i> Update Email Configuration
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="settings-group">
                                <label for="emailNotificationTime">Daily Email Notification Time</label>
                                <div class="input-group">
                                    <input type="time" class="form-control" id="emailNotificationTime" placeholder="09:00">
                                    <button class="btn btn-primary" id="updateEmailTimeBtn">
                                        <i class="fas fa-save"></i> Update
                                    </button>
                                </div>
                                <small class="text-muted">Time to send daily emails to users with OUT tools and administrators (24-hour format, Nicosia timezone)</small>
                            </div>

                            <div class="settings-group">
                                <label for="emailToleranceWindow">Email Time Tolerance Window (Minutes)</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="emailToleranceWindow" placeholder="1" min="0" max="60" value="1">
                                    <button class="btn btn-primary" id="updateEmailToleranceBtn">
                                        <i class="fas fa-save"></i> Update
                                    </button>
                                </div>
                                <small class="text-muted">
                                    How many minutes before/after the notification time should emails be sent? 
                                    <br>
                                    Example: If notification time is 09:00 and tolerance is 2 minutes, emails will be sent if the function runs between 08:58 and 09:02.
                                    <br>
                                    <strong>Recommended:</strong> 1-5 minutes (default: 1 minute)
                                </small>
                            </div>

                            <div class="settings-group">
                                <label><i class="fas fa-clock"></i> Email Check Frequency</label>
                                <div class="card" style="margin-top: 10px;">
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label for="emailCheckFrequency" class="form-label">How often should the system check if it's time to send emails?</label>
                                            <select class="form-select" id="emailCheckFrequency">
                                                <option value="* * * * *">Every minute (Recommended for precise timing)</option>
                                                <option value="*/5 * * * *">Every 5 minutes</option>
                                                <option value="*/10 * * * *">Every 10 minutes</option>
                                                <option value="*/15 * * * *">Every 15 minutes</option>
                                                <option value="*/30 * * * *">Every 30 minutes</option>
                                                <option value="0 * * * *">Every hour</option>
                                                <option value="0 */2 * * *">Every 2 hours</option>
                                                <option value="0 */6 * * *">Every 6 hours</option>
                                                <option value="0 9 * * *">Once daily at 9:00 AM</option>
                                                <option value="custom">Custom schedule (choose days/time below)</option>
                                            </select>
                                            <small class="text-muted">
                                                This controls how often the Cloud Function runs to check if it's time to send emails.
                                                <br>
                                                <strong>Note:</strong> The actual schedule is managed by Google Cloud Scheduler. 
                                                After updating here, you'll need to update it in Google Cloud Console.
                                            </small>
                                        </div>

                                        <div id="customScheduleContainer" class="mt-3" style="display:none;">
                                            <div class="card border-primary">
                                                <div class="card-body">
                                                    <h6 class="card-title"><i class="fas fa-calendar-alt me-2"></i>Custom schedule</h6>
                                                    <p class="text-muted mb-2">Select the days of the week and the exact time (Asia/Nicosia) when the system should run. We'll convert it to the correct cron expression automatically.</p>
                                                    
                                                    <div class="mb-3">
                                                        <label class="form-label">Days of the week</label>
                                                        <div class="d-flex flex-wrap gap-2">
                                                            <div class="form-check form-check-inline">
                                                                <input class="form-check-input custom-day-checkbox" type="checkbox" id="daySun" value="0">
                                                                <label class="form-check-label" for="daySun">Sun</label>
                                                            </div>
                                                            <div class="form-check form-check-inline">
                                                                <input class="form-check-input custom-day-checkbox" type="checkbox" id="dayMon" value="1">
                                                                <label class="form-check-label" for="dayMon">Mon</label>
                                                            </div>
                                                            <div class="form-check form-check-inline">
                                                                <input class="form-check-input custom-day-checkbox" type="checkbox" id="dayTue" value="2">
                                                                <label class="form-check-label" for="dayTue">Tue</label>
                                                            </div>
                                                            <div class="form-check form-check-inline">
                                                                <input class="form-check-input custom-day-checkbox" type="checkbox" id="dayWed" value="3">
                                                                <label class="form-check-label" for="dayWed">Wed</label>
                                                            </div>
                                                            <div class="form-check form-check-inline">
                                                                <input class="form-check-input custom-day-checkbox" type="checkbox" id="dayThu" value="4">
                                                                <label class="form-check-label" for="dayThu">Thu</label>
                                                            </div>
                                                            <div class="form-check form-check-inline">
                                                                <input class="form-check-input custom-day-checkbox" type="checkbox" id="dayFri" value="5">
                                                                <label class="form-check-label" for="dayFri">Fri</label>
                                                            </div>
                                                            <div class="form-check form-check-inline">
                                                                <input class="form-check-input custom-day-checkbox" type="checkbox" id="daySat" value="6">
                                                                <label class="form-check-label" for="daySat">Sat</label>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div class="mb-3">
                                                        <label for="customScheduleTime" class="form-label">Run at time</label>
                                                        <input type="time" class="form-control" id="customScheduleTime" value="09:00">
                                                    </div>

                                                    <div class="alert alert-secondary mb-0" id="customScheduleSummary" style="display:none;"></div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="mt-3">
                                            <label class="form-label">Generated cron expression (copy &amp; paste into Cloud Scheduler)</label>
                                            <div class="input-group">
                                                <input type="text" class="form-control" id="emailFrequencyCron" readonly value="* * * * *">
                                                <button type="button" class="btn btn-outline-secondary" id="copyCronBtn" title="Copy cron expression">
                                                    <i class="fas fa-copy"></i>
                                                </button>
                                            </div>
                                            <small class="text-muted">Matches your selection above. Use this when editing the Cloud Scheduler job.</small>
                                        </div>
                                        
                                        <div class="alert alert-info" role="alert">
                                            <i class="fas fa-info-circle"></i> 
                                            <strong>How to point Google Cloud Scheduler to the new HTTP function:</strong>
                                            <ol style="margin-top: 10px; margin-bottom: 0; padding-left: 20px;">
                                                <li>Go to <a href="https://console.cloud.google.com/cloudscheduler" target="_blank">Google Cloud Scheduler</a></li>
                                                <li>Create (or edit) a job for email notifications</li>
                                                <li>Set <strong>Target type</strong> to <strong>HTTP</strong> and use:<br><code>https://us-central1-tool-tracking-system-15e84.cloudfunctions.net/sendDailyToolNotifications</code></li>
                                                <li>Choose <strong>POST</strong> (empty body) and enable <strong>OIDC authentication</strong> using the App Engine default service account (<code>tool-tracking-system-15e84@appspot.gserviceaccount.com</code>)</li>
                                                <li>Set the <strong>Frequency</strong> cron expression (e.g., <code>* * * * *</code>) and <strong>Timezone</strong> to Asia/Nicosia or Eastern European Time</li>
                                                <li>Save the job. Future Firebase deployments will not overwrite this schedule.</li>
                                            </ol>
                                            <p class="mt-3 mb-0" style="font-size: 0.9rem;">
                                                Tip: Keep the scheduler frequency at "Every minute" for best accuracy. The setting you choose above still controls how often the function actually runs, even if the scheduler triggers more often.
                                            </p>
                                        </div>
                                        
                                        <button class="btn btn-primary" id="updateEmailFrequencyBtn">
                                            <i class="fas fa-save"></i> Save Frequency Preference
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="settings-group">
                                <label><i class="fas fa-edit"></i> Email Template Customization</label>
                                <div class="card" style="margin-top: 10px;">
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label for="emailSubjectUser" class="form-label">User Email Subject</label>
                                            <input type="text" class="form-control" id="emailSubjectUser" placeholder="Tool Tracking Reminder: {count} Tool(s) Checked Out">
                                            <small class="text-muted">Use {count} to insert the number of tools</small>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="emailSubjectAdmin" class="form-label">Admin Email Subject</label>
                                            <input type="text" class="form-control" id="emailSubjectAdmin" placeholder="Daily Tool Status Report: {count} Tool(s) Currently OUT">
                                            <small class="text-muted">Use {count} to insert the number of tools</small>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="emailBodyUser" class="form-label">User Email Body (HTML)</label>
                                            <textarea class="form-control" id="emailBodyUser" rows="6" placeholder="Hello {userName},&#10;&#10;This is a reminder that you currently have {count} tool(s) checked out:&#10;&#10;{toolList}&#10;&#10;Please remember to check in these tools when you're done using them.&#10;&#10;Thank you!"></textarea>
                                            <small class="text-muted">
                                                Available variables: {userName}, {count}, {toolList}<br>
                                                {toolList} will be replaced with a formatted table of tools
                                            </small>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="emailBodyAdmin" class="form-label">Admin Email Body (HTML)</label>
                                            <textarea class="form-control" id="emailBodyAdmin" rows="6" placeholder="Hello Administrators,&#10;&#10;This is the daily summary of tools currently checked out:&#10;&#10;Total Tools OUT: {count}&#10;&#10;{toolList}&#10;&#10;Thank you!"></textarea>
                                            <small class="text-muted">
                                                Available variables: {count}, {toolList}<br>
                                                {toolList} will be replaced with a formatted table of tools
                                            </small>
                                        </div>
                                        
                                        <button class="btn btn-primary" id="updateEmailTemplateBtn">
                                            <i class="fas fa-save"></i> Update Email Templates
                                        </button>
                                        <button class="btn btn-secondary" id="resetEmailTemplateBtn" style="margin-left: 10px;">
                                            <i class="fas fa-undo"></i> Reset to Default
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="settings-group">
                                <label><i class="fas fa-table"></i> Email Table Customization</label>
                                <div class="card" style="margin-top: 10px;">
                                    <div class="card-body">
                                        <h6 class="card-title">User Email Table Columns</h6>
                                        <div class="mb-3">
                                            <label class="form-label">Select columns to show:</label>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="tableColToolName" checked>
                                                <label class="form-check-label" for="tableColToolName">Tool Name</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="tableColPartNumber" checked>
                                                <label class="form-check-label" for="tableColPartNumber">Part Number</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="tableColCheckoutDate" checked>
                                                <label class="form-check-label" for="tableColCheckoutDate">Checkout Date</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="tableColLocation">
                                                <label class="form-check-label" for="tableColLocation">Location</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="tableColOwner">
                                                <label class="form-check-label" for="tableColOwner">Owner</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="tableColCalDueDate">
                                                <label class="form-check-label" for="tableColCalDueDate">Cal Due Date</label>
                                            </div>
                                        </div>
                                        
                                        <h6 class="card-title mt-4">Admin Email Table Columns</h6>
                                        <div class="mb-3">
                                            <label class="form-label">Select columns to show:</label>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="adminTableColToolName" checked>
                                                <label class="form-check-label" for="adminTableColToolName">Tool Name</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="adminTableColPartNumber" checked>
                                                <label class="form-check-label" for="adminTableColPartNumber">Part Number</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="adminTableColTechnician" checked>
                                                <label class="form-check-label" for="adminTableColTechnician">Technician</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="adminTableColCheckoutDate" checked>
                                                <label class="form-check-label" for="adminTableColCheckoutDate">Checkout Date</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="adminTableColLocation">
                                                <label class="form-check-label" for="adminTableColLocation">Location</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="adminTableColOwner">
                                                <label class="form-check-label" for="adminTableColOwner">Owner</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="adminTableColCalDueDate">
                                                <label class="form-check-label" for="adminTableColCalDueDate">Cal Due Date</label>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="tableHeaderColor" class="form-label">Table Header Background Color</label>
                                            <input type="color" class="form-control form-control-color" id="tableHeaderColor" value="#FF9800" title="Choose header color">
                                            <small class="text-muted">Color for table header background</small>
                                        </div>
                                        
                                        <button class="btn btn-primary" id="updateTableConfigBtn">
                                            <i class="fas fa-save"></i> Update Table Configuration
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="settings-group">
                                <label>Administrator Notifications</label>
                                <div class="alert alert-info" role="alert">
                                    <i class="fas fa-info-circle"></i> Administrator emails are automatically detected from technicians with <code>isAdmin = true</code> in the database. No manual configuration needed!
                                </div>
                            </div>

                            <div class="settings-group">
                                <label>System Information</label>
                                <table class="table table-sm">
                                    <tbody>
                                        <tr>
                                            <td><strong>Firebase Project:</strong></td>
                                            <td id="projectId">Loading...</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Last Settings Update:</strong></td>
                                            <td id="lastUpdate">Loading...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Users Section -->
                    <div class="section-content" id="users">
                        <div class="admin-card">
                            <h4><i class="fas fa-users"></i> User Management</h4>
                            
                            <div class="mb-3">
                                <input type="text" class="form-control" id="userSearch" placeholder="Search users by name or email...">
                            </div>

                            <div class="loading-spinner" id="usersLoading">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p>Loading users...</p>
                            </div>

                            <div class="table-responsive user-table">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th style="width: 60px;">#</th>
                                            <th>Name</th>
                                            <th>Email</th>
                                            <th>Roles</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="usersTableBody">
                                        <!-- Users will be populated here -->
                                    </tbody>
                                </table>
                            </div>

                            <!-- Mobile-friendly card view -->
                            <div class="user-card-mobile" id="userCardsMobile">
                                <!-- User cards will be populated here for mobile -->
                            </div>
                        </div>
                    </div>

                    <!-- Tools Section -->
                    <div class="section-content" id="tools">
                        <!-- Tools Main Menu -->
                        <div id="toolsMainMenu" class="admin-card">
                            <h4><i class="fas fa-toolbox"></i> Tool Management</h4>
                            <p style="color: #666; margin-bottom: 20px;">Select an option to manage tools</p>
                            
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <button class="btn btn-primary w-100 py-3" onclick="showToolsByUser()">
                                        <i class="fas fa-user-tag fa-2x d-block mb-2"></i>
                                        <strong>Tools By User</strong>
                                        <small class="d-block">View tool history by technician</small>
                                    </button>
                                </div>
                                <div class="col-md-6">
                                    <button class="btn btn-success w-100 py-3" onclick="window.location.href='tools-by-owner.html'">
                                        <i class="fas fa-users-cog fa-2x d-block mb-2"></i>
                                        <strong>Tools By Owner</strong>
                                        <small class="d-block">View tools grouped by collection owner</small>
                                    </button>
                                </div>
                                <div class="col-md-4">
                                    <button class="btn btn-info w-100 py-3" onclick="showAddEditTool()">
                                        <i class="fas fa-edit fa-2x d-block mb-2"></i>
                                        <strong>Add/Edit Tool</strong>
                                        <small class="d-block">Manually add or edit tools</small>
                                    </button>
                                </div>
                                <div class="col-md-4">
                                    <button class="btn btn-warning w-100 py-3" onclick="showImportExcel()">
                                        <i class="fas fa-file-excel fa-2x d-block mb-2"></i>
                                        <strong>Import from Excel</strong>
                                        <small class="d-block">Bulk import tools</small>
                                    </button>
                                </div>
                                <div class="col-md-4">
                                    <button class="btn btn-secondary w-100 py-3" onclick="showExportTools()">
                                        <i class="fas fa-download fa-2x d-block mb-2"></i>
                                        <strong>Export Tools</strong>
                                        <small class="d-block">Download tools data</small>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Tools By User Section -->
                        <div id="toolsByUserSection" style="display: none;">
                            <!-- User Selection -->
                            <div id="toolsUserSelection" class="admin-card">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h4><i class="fas fa-user-tag"></i> Select Technician</h4>
                                    <button class="btn btn-secondary btn-sm" onclick="backToToolsMenu()">
                                        <i class="fas fa-arrow-left"></i> Back
                                    </button>
                                </div>
                                
                                <div class="mb-3">
                                    <input type="text" class="form-control" id="toolsUserSearch" placeholder="Search technicians...">
                                </div>

                                <div class="loading-spinner" id="toolsUsersLoading">
                                    <div class="spinner-border text-primary" role="status"></div>
                                    <p>Loading technicians...</p>
                                </div>

                                <div id="toolsUsersList" class="row g-3">
                                    <!-- User cards will be populated here -->
                                </div>
                            </div>

                            <!-- Tool History Section -->
                            <div id="toolHistorySection" style="display: none;" class="admin-card">
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h4><i class="fas fa-history"></i> Tool History</h4>
                                        <button class="btn btn-sm" style="background-color: #FF9800; color: white; border: none;" onclick="backToToolsUserSelection()">
                                            <i class="fas fa-arrow-left"></i> Back to Users
                                        </button>
                                    </div>
                                    <p class="text-muted mb-0" style="color: #667eea; font-weight: bold;">
                                        <i class="fas fa-user"></i> <span id="selectedUserNameTools"></span>
                                    </p>
                                </div>

                                <!-- Time Filters -->
                                <div class="mb-3 d-flex gap-2 flex-wrap">
                                    <button class="btn btn-sm btn-primary filter-time-btn" onclick="filterToolHistory('today', this)">
                                        <i class="fas fa-calendar-day"></i> Today
                                    </button>
                                    <button class="btn btn-sm btn-primary filter-time-btn" onclick="filterToolHistory('week', this)">
                                        <i class="fas fa-calendar-week"></i> Last Week
                                    </button>
                                    <button class="btn btn-sm btn-primary filter-time-btn" onclick="filterToolHistory('month', this)">
                                        <i class="fas fa-calendar-alt"></i> Last Month
                                    </button>
                                    <button class="btn btn-sm btn-primary filter-time-btn" onclick="filterToolHistory('year', this)">
                                        <i class="fas fa-calendar"></i> Last Year
                                    </button>
                                    <button class="btn btn-sm btn-primary filter-time-btn active" onclick="filterToolHistory('all', this)">
                                        <i class="fas fa-infinity"></i> All Time
                                    </button>
                                </div>

                                <!-- Search Tool -->
                                <div class="mb-3">
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="toolHistorySearch" placeholder="Scan or enter tool code...">
                                        <button class="btn btn-primary" onclick="searchToolHistory()">
                                            <i class="fas fa-search"></i> Search
                                        </button>
                                        <button class="btn" id="scanToolHistoryBtn" style="background-color: #FF9800; color: white; border: none;">
                                            <i class="fas fa-qrcode"></i> Scan
                                        </button>
                                    </div>
                                </div>

                                <!-- Toggle for OUT tools only -->
                                <div class="mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="showOutToolsOnly" onchange="toggleOutToolsOnly()">
                                        <label class="form-check-label" for="showOutToolsOnly">
                                            <strong>Show only currently OUT tools registered to this user</strong>
                                        </label>
                                    </div>
                                </div>

                                <!-- Bulk Check-in Controls (hidden by default) -->
                                <div id="bulkCheckinControls" class="mb-3" style="display: none;">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="selectAllTools" onchange="toggleSelectAllTools()">
                                            <label class="form-check-label" for="selectAllTools">
                                                <strong>Select All OUT Tools</strong>
                                            </label>
                                        </div>
                                        <button class="btn btn-success" onclick="checkInSelectedTools()">
                                            <i class="fas fa-check-circle"></i> Check In Selected Tools
                                        </button>
                                    </div>
                                </div>

                                <!-- Tool History Cards -->
                                <div id="toolHistoryCards">
                                    <p class="text-muted">Select a time period or search for a specific tool</p>
                                </div>
                            </div>
                        </div>

                        <!-- Other sections placeholders -->
                        <div id="toolsByOwnerSection" style="display: none;" class="admin-card">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h4><i class="fas fa-users-cog"></i> Tools By Owner</h4>
                                <button class="btn btn-secondary btn-sm" onclick="backToToolsMenu()">
                                    <i class="fas fa-arrow-left"></i> Back
                                </button>
                            </div>
                            <p class="text-muted">Coming soon...</p>
                        </div>

                        <div id="addEditToolSection" style="display: none;" class="admin-card">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h4><i class="fas fa-edit"></i> Add/Edit Tool</h4>
                                <button class="btn btn-secondary btn-sm" onclick="backToToolsMenu()">
                                    <i class="fas fa-arrow-left"></i> Back
                                </button>
                            </div>
                            <p class="text-muted">Coming soon...</p>
                        </div>

                        <div id="importExcelSection" style="display: none;" class="admin-card">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h4><i class="fas fa-file-excel"></i> Import from Excel</h4>
                                <button class="btn btn-secondary btn-sm" onclick="backToToolsMenu()">
                                    <i class="fas fa-arrow-left"></i> Back
                                </button>
                            </div>
                            <p class="text-muted">Coming soon...</p>
                        </div>

                        <div id="exportToolsSection" style="display: none;" class="admin-card">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h4><i class="fas fa-download"></i> Export Tools</h4>
                                <button class="btn btn-secondary btn-sm" onclick="backToToolsMenu()">
                                    <i class="fas fa-arrow-left"></i> Back
                                </button>
                            </div>
                            <p class="text-muted">Coming soon...</p>
                        </div>
                    </div>

                    <!-- Analytics Section -->
                    <div class="section-content" id="analytics">
                        <div class="admin-card">
                            <h4><i class="fas fa-chart-bar"></i> Analytics & Reports</h4>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="settings-group">
                                        <h5>Today's Activity</h5>
                                        <table class="table table-sm">
                                            <tbody>
                                                <tr>
                                                    <td><i class="fas fa-check-circle text-success"></i> Check-Ins Today:</td>
                                                    <td><strong id="checkInsToday">0</strong></td>
                                                </tr>
                                                <tr>
                                                    <td><i class="fas fa-sign-out-alt text-danger"></i> Check-Outs Today:</td>
                                                    <td><strong id="checkOutsToday">0</strong></td>
                                                </tr>
                                                <tr>
                                                    <td><i class="fas fa-tools text-primary"></i> Active Users Today:</td>
                                                    <td><strong id="activeUsersToday">0</strong></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="settings-group">
                                        <h5>Most Active Users</h5>
                                        <div id="topUsersList">
                                            <p class="text-muted">Loading...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="settings-group mt-3">
                                <h5>Recent Activity Log</h5>
                                <div id="recentActivityLog" style="max-height: 400px; overflow-y: auto;">
                                    <p class="text-muted">Loading recent activities...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Checkups Section -->
                    <div class="section-content" id="checkups">
                        <div class="admin-card">
                            <h4><i class="fas fa-clipboard-check"></i> Collection Checkups Management</h4>
                            
                            <!-- Step 1: Select User -->
                            <div id="checkupStep1" class="settings-group">
                                <h5><i class="fas fa-user"></i> Select User</h5>
                                <div class="mb-3">
                                    <input type="text" class="form-control" id="checkupUserSearch" placeholder="Search users...">
                                </div>
                                <div class="loading-spinner" id="checkupUsersLoading">
                                    <div class="spinner-border text-primary" role="status"></div>
                                    <p>Loading users...</p>
                                </div>
                                <div id="checkupUsersList">
                                    <!-- Users will be populated here as numbered list -->
                                </div>
                            </div>

                            <!-- Step 2: Select Collection -->
                            <div id="checkupStep2" class="settings-group" style="display: none;">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5><i class="fas fa-folder"></i> Step 2: Select Collection for <span id="selectedUserName" style="color: #667eea;"></span></h5>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="resetCheckupSelection()">
                                        <i class="fas fa-arrow-left"></i> Back to Users
                                    </button>
                                </div>
                                <div id="checkupCollectionsList" class="row g-3">
                                    <!-- Collections will be populated here -->
                                </div>
                            </div>

                            <!-- Step 3: View Checkup History -->
                            <div id="checkupStep3" class="settings-group" style="display: none;">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5><i class="fas fa-history"></i> <span id="selectedCollectionName" style="color: #667eea;"></span></h5>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="backToCollections()">
                                        <i class="fas fa-arrow-left"></i> Back to Users
                                    </button>
                                </div>

                                <!-- Filter Buttons -->
                                <div class="mb-3 d-flex gap-2 flex-wrap">
                                    <button class="btn btn-sm btn-primary" onclick="filterCheckups('today')">
                                        <i class="fas fa-calendar-day"></i> Today
                                    </button>
                                    <button class="btn btn-sm btn-primary" onclick="filterCheckups('week')">
                                        <i class="fas fa-calendar-week"></i> Last Week
                                    </button>
                                    <button class="btn btn-sm btn-primary" onclick="filterCheckups('month')">
                                        <i class="fas fa-calendar-alt"></i> Last Month
                                    </button>
                                    <button class="btn btn-sm btn-primary" onclick="filterCheckups('year')">
                                        <i class="fas fa-calendar"></i> Last Year
                                    </button>
                                    <button class="btn btn-sm btn-outline-primary" onclick="filterCheckups('all')">
                                        <i class="fas fa-list"></i> All Time
                                    </button>
                                    <div class="ms-auto">
                                        <button class="btn btn-sm btn-danger" id="deleteSelectedCheckupsBtn" onclick="deleteSelectedCheckups()" disabled>
                                            <i class="fas fa-trash"></i> Delete Selected (<span id="selectedCheckupsCount">0</span>)
                                        </button>
                                    </div>
                                </div>

                                <!-- Analytics Summary -->
                                <div class="row mb-3">
                                    <div class="col-md-3">
                                        <div class="stat-card text-center" style="padding: 15px;">
                                            <div class="icon" style="font-size: 2rem; color: #667eea;">
                                                <i class="fas fa-clipboard-list"></i>
                                            </div>
                                            <h4 id="totalCheckups">0</h4>
                                            <p style="font-size: 0.9rem;">Total Checkups</p>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="stat-card text-center" style="padding: 15px;">
                                            <div class="icon" style="font-size: 2rem; color: #28a745;">
                                                <i class="fas fa-percentage"></i>
                                            </div>
                                            <h4 id="avgCompletion">0%</h4>
                                            <p style="font-size: 0.9rem;">Avg Completion</p>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="stat-card text-center" style="padding: 15px;">
                                            <div class="icon" style="font-size: 2rem; color: #ff9800;">
                                                <i class="fas fa-tools"></i>
                                            </div>
                                            <h4 id="avgToolsChecked">0</h4>
                                            <p style="font-size: 0.9rem;">Avg Tools Checked</p>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="stat-card text-center" style="padding: 15px;">
                                            <div class="icon" style="font-size: 2rem; color: #dc3545;">
                                                <i class="fas fa-calendar-check"></i>
                                            </div>
                                            <h4 id="lastCheckupDate">N/A</h4>
                                            <p style="font-size: 0.9rem;">Last Checkup</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Checkup History Table -->
                                <div class="loading-spinner" id="checkupHistoryLoading">
                                    <div class="spinner-border text-primary" role="status"></div>
                                    <p>Loading checkup history...</p>
                                </div>

                                <div class="table-responsive" id="checkupHistoryTableContainer" style="display: none;">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                <th style="width: 50px;">
                                    <input type="checkbox" id="selectAllCheckups" onchange="toggleSelectAllCheckups()">
                                </th>
                                <th>Date & Time</th>
                                <th>Collection</th>
                                <th>Total Tools</th>
                                <th>Checked</th>
                                <th>Unchecked</th>
                                <th>Completion %</th>
                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="checkupHistoryTableBody">
                                            <!-- Checkup history will be populated here -->
                                        </tbody>
                                    </table>
                                </div>

                                <div id="noCheckupsMessage" style="display: none; text-align: center; padding: 40px; color: #999;">
                                    <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 15px;"></i>
                                    <p style="font-size: 1.1rem;">No checkups found for the selected period.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Check User Activity Section -->
                    <div class="section-content" id="activity">
                        <div class="admin-card">
                            <h4><i class="fas fa-user-check"></i> Check User Activity - Tool Registration Verification</h4>
                            
                            <div class="settings-group">
                                <p style="color: #666; margin-bottom: 20px;">
                                    <i class="fas fa-info-circle"></i> Scan or enter a tool code to check who is currently using it and when it was registered.
                                </p>

                                <!-- Search Input with QR Scanner -->
                                <div class="mb-3">
                                    <label for="activityToolSearch" class="form-label" style="font-weight: bold; font-size: 1.1rem;">
                                        <i class="fas fa-search"></i> Enter Tool Code or Scan QR
                                    </label>
                                    <div style="position: relative;">
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="activityToolSearch" 
                                                   placeholder="Enter tool code (e.g., AMS-001) or scan QR code..." 
                                                   style="font-size: 1.1rem; padding: 12px;"
                                                   autocomplete="off">
                                            <button class="btn btn-primary" id="activitySearchBtn" onclick="searchToolActivity()">
                                                <i class="fas fa-search"></i> Search
                                            </button>
                                            <button class="btn btn-success" id="activityScanBtn" onclick="toggleActivityScanner()">
                                                <i class="fas fa-qrcode"></i> Scan QR
                                            </button>
                                        </div>
                                        <!-- Dropdown for suggestions -->
                                        <div id="activityDropdown" class="activity-dropdown"></div>
                                    </div>
                                    <small class="text-muted">Case-insensitive search - searches Tool ID, Tool Name, and Part Number. Start typing to see suggestions.</small>
                                </div>

                                <!-- QR Scanner Container -->
                                <div id="activityQrReader" style="display: none; margin-bottom: 20px;">
                                    <div id="activityQrReaderElement" style="border: 3px solid #667eea; border-radius: 10px; overflow: hidden;"></div>
                                    <button class="btn btn-danger mt-2" onclick="stopActivityScanner()">
                                        <i class="fas fa-stop"></i> Stop Scanner
                                    </button>
                                </div>

                                <!-- Results Container -->
                                <div id="activityResults" style="display: none;">
                                    <!-- Results will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Section Modals -->
    <div id="settingsModal" class="section-modal"></div>
    <div id="usersModal" class="section-modal"></div>
    <div id="toolsModal" class="section-modal"></div>
    <div id="analyticsModal" class="section-modal"></div>
    <div id="checkupsModal" class="section-modal"></div>
    <div id="activityModal" class="section-modal"></div>

    <!-- Checkup Details Modal -->
    <div class="modal fade" id="checkupDetailsModal" tabindex="-1" aria-labelledby="checkupDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header" style="background: #667eea; color: white;">
                    <h5 class="modal-title" id="checkupDetailsModalLabel">
                        <i class="fas fa-clipboard-check"></i> Checkup Details
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="checkupDetailsModalBody">
                    <!-- Details will be populated here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Common Firebase configuration and utilities -->
    <script src="js/common.js"></script>

    <script>
        // Use global Firebase instances from common.js
        // Wait for common.js to load
        document.addEventListener('DOMContentLoaded', function() {
            function waitForAuth() {
                const auth = window.auth;
                const db = window.db;
                const storage = window.storage;
                
                if (!auth || !db || !storage) {
                    console.log('[ADMIN] Waiting for common.js to load...');
                    setTimeout(waitForAuth, 50);
                    return;
                }
                
                console.log('[ADMIN]  Using global Firebase instances from common.js');
                initializeAdmin(auth, db, storage);
            }
            
            async function initializeAdmin(auth, db, storage) {

        // DOM Elements
        const loginSection = document.getElementById('loginSection');
        const adminDashboard = document.getElementById('adminDashboard');
                
                // Hide login screen by default - use seamless navigation
                if (loginSection) loginSection.style.display = 'none';
                if (adminDashboard) adminDashboard.style.display = 'none';

        // Check if user is admin
        async function checkAdminStatus(user) {
                    const db = window.db || firebase.firestore();
            try {
                const doc = await db.collection('technicians').doc(user.uid).get();
                if (doc.exists) {
                    const userData = doc.data();
                    if (userData.isAdmin === true) {
                        return { isAdmin: true, name: userData.fullName || user.email };
                    }
                }
                return { isAdmin: false, name: null };
            } catch (error) {
                console.error('Error checking admin status:', error);
                return { isAdmin: false, name: null };
            }
        }

                // Load Admin Dashboard
                function loadAdminDashboard(adminName) {
                    if (adminDashboard) adminDashboard.style.display = 'block';
                    const adminNameElement = document.getElementById('adminName');
                    if (adminNameElement) adminNameElement.textContent = adminName;
                    
                    // Load all dashboard data
                    loadStatistics();
                    loadSettings();
                    loadUsers();
                    loadTools();
                    loadAnalytics();
                }
                
                // Make functions available globally
                window.checkAdminStatus = checkAdminStatus;
                window.loadAdminDashboard = loadAdminDashboard;

                // Logout button handler
                const logoutBtn = document.getElementById('logoutBtn');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', async () => {
                        if (confirm('Are you sure you want to logout?')) {
                            try {
                                await auth.signOut();
                                localStorage.removeItem('authVerified');
                                localStorage.removeItem('fullName');
                                window.location.href = 'main-menu.html';
                            } catch (error) {
                                console.error('Logout error:', error);
                                alert('Logout failed: ' + error.message);
                            }
                        }
                    });
                }

                // SEAMLESS NAVIGATION: Check localStorage first - if flag exists, proceed IMMEDIATELY
                const authVerified = localStorage.getItem('authVerified');
                const storedFullName = localStorage.getItem('fullName');
                
                console.log('[ADMIN] Checking auth flags...');
                console.log('[ADMIN] authVerified:', authVerified);
                console.log('[ADMIN] storedFullName:', storedFullName);
                console.log('[ADMIN] auth.currentUser (sync):', auth ? (auth.currentUser ? auth.currentUser.email : 'null') : 'auth not initialized');
                
                if (authVerified === 'true' && storedFullName) {
                    // User was authenticated in main-menu - proceed IMMEDIATELY (no waiting)
                    console.log('[ADMIN]  Auth verified flag found - checking admin status immediately');
                    
                    // Wait for user to be available (Firebase may need time to restore session)
                    let user = auth.currentUser;
                    if (!user) {
                        console.log('[ADMIN] auth.currentUser is null, waiting for user...');
                        // Wait up to 2 seconds for Firebase to restore the session
                        let waitCount = 0;
                        while (!user && waitCount < 20) {
                            await new Promise(resolve => setTimeout(resolve, 100));
                            user = auth.currentUser;
                            waitCount++;
                        }
                    }
                    
                    if (user) {
                        console.log('[ADMIN] User found, checking admin status...');
                const { isAdmin, name } = await checkAdminStatus(user);
                if (isAdmin) {
                            console.log('[ADMIN]  Admin confirmed, loading dashboard');
                    loadAdminDashboard(name);
                            
                            // Verify auth in background (non-blocking)
                            setTimeout(() => {
                                const currentUser = auth.currentUser;
                                if (currentUser) {
                                    console.log('[ADMIN]  Auth confirmed via currentUser:', currentUser.email);
                                    localStorage.setItem('authVerified', 'true');
                } else {
                                    // Set up onAuthStateChanged listener
                                    const unsubscribe = auth.onAuthStateChanged(async function(user) {
                                        if (user) {
                                            const { isAdmin } = await checkAdminStatus(user);
                                            if (isAdmin) {
                                                console.log('[ADMIN]  Auth confirmed via onAuthStateChanged');
                                                localStorage.setItem('authVerified', 'true');
                                            } else {
                                                console.log('[ADMIN]  User is not admin, redirecting to main-menu.html');
                                                localStorage.removeItem('authVerified');
                                                window.location.href = 'main-menu.html';
                                            }
                } else {
                                            console.log('[ADMIN]  No user found, redirecting to main-menu.html');
                                            localStorage.removeItem('authVerified');
                                            window.location.href = 'main-menu.html';
                                        }
                                        unsubscribe();
                                    });
            }
                            }, 300);
                            
                            return; // Exit - page initialized
                        } else {
                            console.log('[ADMIN]  User is not admin, redirecting to main-menu.html');
                            localStorage.removeItem('authVerified');
                            window.location.href = 'main-menu.html';
                            return;
                        }
                    } else {
                        console.log('[ADMIN]  No user found after waiting, redirecting to main-menu.html');
                        localStorage.removeItem('authVerified');
                        window.location.href = 'main-menu.html';
                        return;
                    }
                }
                
                // No stored flag - check current user immediately, then wait for Firebase auth if needed
                console.log('[ADMIN]  No auth flag found - checking current user');
                let user = auth.currentUser;
                
                // If no current user, wait briefly for Firebase to restore session (max 1 second)
                if (!user) {
                    console.log('[ADMIN] No current user, waiting briefly for session restore...');
                    let waitCount = 0;
                    while (!user && waitCount < 10) { // 10 * 100ms = 1 second
                        await new Promise(resolve => setTimeout(resolve, 100));
                        user = auth.currentUser;
                        waitCount++;
                    }
                }
                
                // If still no user after waiting, redirect immediately
                if (!user) {
                    console.log('[ADMIN]  No user found after waiting, redirecting to main-menu.html');
                    localStorage.removeItem('authVerified');
                    window.location.href = 'main-menu.html';
                    return;
                }
                
                // User found - check admin status
                console.log('[ADMIN] User found, checking admin status...');
                const { isAdmin, name } = await checkAdminStatus(user);
                if (isAdmin) {
                    console.log('[ADMIN]  User authenticated and is admin, loading dashboard');
                    localStorage.setItem('authVerified', 'true');
                    if (!localStorage.getItem('fullName')) {
                        localStorage.setItem('fullName', name || user.email);
                    }
                    loadAdminDashboard(name);
                } else {
                    console.log('[ADMIN]  User is not admin, redirecting to main-menu.html');
                    await auth.signOut();
                    localStorage.removeItem('authVerified');
                    window.location.href = 'main-menu.html';
                }
                
                // Also set up onAuthStateChanged as backup (in case auth state changes)
                auth.onAuthStateChanged(async function(user) {
                    if (!user) {
                        console.log('[ADMIN] Auth state changed - user logged out, redirecting to main-menu.html');
                        localStorage.removeItem('authVerified');
                        window.location.href = 'main-menu.html';
                    }
                });
            }
            
            // Start waiting for common.js
            waitForAuth();
        });

        // Custom schedule helpers for email frequency (defined outside initializeAdmin)
        const emailCheckFrequencySelect = document.getElementById('emailCheckFrequency');
        const customScheduleContainer = document.getElementById('customScheduleContainer');
        const customScheduleTimeInput = document.getElementById('customScheduleTime');
        const customScheduleSummary = document.getElementById('customScheduleSummary');
        const customDayCheckboxes = document.querySelectorAll('.custom-day-checkbox');
        const cronPreviewInput = document.getElementById('emailFrequencyCron');
        const copyCronBtn = document.getElementById('copyCronBtn');

        function padNumber(num) {
            return String(num).padStart(2, '0');
        }

        function toggleCustomSchedule(show) {
            if (customScheduleContainer) {
                customScheduleContainer.style.display = show ? 'block' : 'none';
            }
            if (!show && customScheduleSummary) {
                customScheduleSummary.style.display = 'none';
            }
            updateCronPreview();
        }

        function updateCustomScheduleSummary() {
            if (!customScheduleSummary) return;
            const selectedDays = Array.from(customDayCheckboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.nextElementSibling ? cb.nextElementSibling.textContent : cb.value);
            const timeValue = customScheduleTimeInput?.value || '';

            if (selectedDays.length === 0 || !timeValue) {
                customScheduleSummary.style.display = 'none';
                return;
            }

            customScheduleSummary.style.display = 'block';
            customScheduleSummary.textContent = `Will run on ${selectedDays.join(', ')} at ${timeValue} (Asia/Nicosia)`;
        }

        customDayCheckboxes.forEach(cb => cb.addEventListener('change', () => {
            updateCustomScheduleSummary();
            updateCronPreview();
        }));
        if (customScheduleTimeInput) {
            customScheduleTimeInput.addEventListener('input', () => {
                updateCustomScheduleSummary();
                updateCronPreview();
            });
        }

        if (emailCheckFrequencySelect) {
            emailCheckFrequencySelect.addEventListener('change', () => {
                const isCustom = emailCheckFrequencySelect.value === 'custom';
                toggleCustomSchedule(isCustom);
                if (isCustom) {
                    updateCustomScheduleSummary();
                }
                updateCronPreview();
            });
        }

        function parseCustomCron(cronExpression) {
            if (!cronExpression) return null;
            const parts = cronExpression.trim().split(/\s+/);
            if (parts.length !== 5) return null;
            const [minute, hour, , , dayOfWeek] = parts;
            return { minute, hour, dayOfWeek };
        }

        function setCustomFieldsFromCron(cronExpression) {
            const parsed = parseCustomCron(cronExpression);
            if (!parsed || !customScheduleTimeInput) return;

            const hour = padNumber(parsed.hour);
            const minute = padNumber(parsed.minute);
            customScheduleTimeInput.value = `${hour}:${minute}`;

            const dayValues = parsed.dayOfWeek === '*' ? ['0','1','2','3','4','5','6'] : parsed.dayOfWeek.split(',');
            customDayCheckboxes.forEach(cb => {
                cb.checked = dayValues.includes(cb.value);
            });
            updateCustomScheduleSummary();
            updateCronPreview();
        }

        function getCustomCronExpression(showAlerts = false) {
            if (!customScheduleTimeInput) return null;
            const timeValue = customScheduleTimeInput.value;
            const selectedDays = Array.from(customDayCheckboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);

            if (!timeValue) {
                if (showAlerts) alert('Please select a time for the custom schedule.');
                return null;
            }

            if (selectedDays.length === 0) {
                if (showAlerts) alert('Please select at least one day for the custom schedule.');
                return null;
            }

            const [hours, minutes] = timeValue.split(':');
            const dayPart = selectedDays.length === 7 ? '*' : selectedDays.join(',');
            return `${parseInt(minutes, 10)} ${parseInt(hours, 10)} * * ${dayPart}`;
        }

        function updateCronPreview() {
            if (!cronPreviewInput || !emailCheckFrequencySelect) return;
            let cronValue = '';
            if (emailCheckFrequencySelect.value === 'custom') {
                cronValue = getCustomCronExpression(false) || '';
            } else {
                cronValue = emailCheckFrequencySelect.value || '';
            }
            cronPreviewInput.value = cronValue;
        }

        function isPresetFrequency(value) {
            if (!emailCheckFrequencySelect) return false;
            return Array.from(emailCheckFrequencySelect.options)
                .filter(option => option.value !== 'custom')
                .some(option => option.value === value);
        }

        // Load Statistics
        async function loadStatistics() {
            const db = window.db || firebase.firestore();
            try {
                // Total Tools
                const toolsSnapshot = await db.collection('tools').get();
                document.getElementById('totalTools').textContent = toolsSnapshot.size;

                // Tools IN/OUT
                let toolsIn = 0;
                let toolsOut = 0;
                toolsSnapshot.forEach(doc => {
                    const status = doc.data().status;
                    if (status === 'IN') toolsIn++;
                    else if (status === 'OUT') toolsOut++;
                });
                document.getElementById('toolsIn').textContent = toolsIn;
                document.getElementById('toolsOut').textContent = toolsOut;

                // Total Users
                const usersSnapshot = await db.collection('technicians').get();
                document.getElementById('totalUsers').textContent = usersSnapshot.size;

            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }

        // Load Settings
        async function loadSettings() {
            const db = window.db || firebase.firestore();
            try {
                const doc = await db.collection('settings').doc('admin').get();
                if (doc.exists) {
                    const data = doc.data();
                    document.getElementById('adminPasswordInput').placeholder = data.adminCode ? '' : 'Not set';
                    document.getElementById('cooldownMinutes').value = data.CheckINCooldownMinutes || 15;
                    
                    // Load email notification time
                    if (data.emailNotificationTime) {
                        document.getElementById('emailNotificationTime').value = data.emailNotificationTime;
                    }
                    
                    // Load email tolerance window
                    if (data.emailToleranceWindow !== undefined) {
                        document.getElementById('emailToleranceWindow').value = data.emailToleranceWindow;
                    } else {
                        document.getElementById('emailToleranceWindow').value = 1; // Default
                    }
                    
                    // Load email check frequency
                    const frequencySelect = document.getElementById('emailCheckFrequency');
                    const savedFrequency = data.emailCheckFrequency || '* * * * *';
                    if (frequencySelect) {
                        if (isPresetFrequency(savedFrequency)) {
                            frequencySelect.value = savedFrequency;
                            toggleCustomSchedule(false);
                        } else {
                            frequencySelect.value = 'custom';
                            toggleCustomSchedule(true);
                            setCustomFieldsFromCron(savedFrequency);
                        }
                        updateCronPreview();
                    }
                    
                    // Load email configuration
                    if (data.emailAccount) {
                        document.getElementById('emailAccount').value = data.emailAccount;
                    }
                    if (data.emailAppPassword) {
                        document.getElementById('emailAppPassword').placeholder = '';
                    }
                    if (data.emailFrom) {
                        document.getElementById('emailFrom').value = data.emailFrom;
                    }
                    
                    // Load email templates
                    if (data.emailSubjectUser) {
                        document.getElementById('emailSubjectUser').value = data.emailSubjectUser;
                    }
                    if (data.emailSubjectAdmin) {
                        document.getElementById('emailSubjectAdmin').value = data.emailSubjectAdmin;
                    }
                    if (data.emailBodyUser) {
                        document.getElementById('emailBodyUser').value = data.emailBodyUser;
                    }
                    if (data.emailBodyAdmin) {
                        document.getElementById('emailBodyAdmin').value = data.emailBodyAdmin;
                    }
                    
                    // Load table configuration
                    const userTableCols = data.userTableColumns || {
                        toolName: true,
                        partNumber: true,
                        checkoutDate: true,
                        location: false,
                        owner: false,
                        calDueDate: false
                    };
                    document.getElementById('tableColToolName').checked = userTableCols.toolName !== false;
                    document.getElementById('tableColPartNumber').checked = userTableCols.partNumber !== false;
                    document.getElementById('tableColCheckoutDate').checked = userTableCols.checkoutDate !== false;
                    document.getElementById('tableColLocation').checked = userTableCols.location === true;
                    document.getElementById('tableColOwner').checked = userTableCols.owner === true;
                    document.getElementById('tableColCalDueDate').checked = userTableCols.calDueDate === true;
                    
                    const adminTableCols = data.adminTableColumns || {
                        toolName: true,
                        partNumber: true,
                        technician: true,
                        checkoutDate: true,
                        location: false,
                        owner: false,
                        calDueDate: false
                    };
                    document.getElementById('adminTableColToolName').checked = adminTableCols.toolName !== false;
                    document.getElementById('adminTableColPartNumber').checked = adminTableCols.partNumber !== false;
                    document.getElementById('adminTableColTechnician').checked = adminTableCols.technician !== false;
                    document.getElementById('adminTableColCheckoutDate').checked = adminTableCols.checkoutDate !== false;
                    document.getElementById('adminTableColLocation').checked = adminTableCols.location === true;
                    document.getElementById('adminTableColOwner').checked = adminTableCols.owner === true;
                    document.getElementById('adminTableColCalDueDate').checked = adminTableCols.calDueDate === true;
                    
                    if (data.tableHeaderColor) {
                        document.getElementById('tableHeaderColor').value = data.tableHeaderColor;
                    }
                    
                    if (data.lastUpdated) {
                        const date = data.lastUpdated.toDate();
                        document.getElementById('lastUpdate').textContent = date.toLocaleString();
                    } else {
                        document.getElementById('lastUpdate').textContent = 'Never';
                    }
                }
                document.getElementById('projectId').textContent = 'tool-tracking-system-15e84';
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        // Update Admin Password
        const updatePasswordBtn = document.getElementById('updatePasswordBtn');
        if (updatePasswordBtn) {
            updatePasswordBtn.addEventListener('click', async () => {
            const db = window.db || firebase.firestore();
            const newPassword = document.getElementById('adminPasswordInput').value.trim();
            if (!newPassword) {
                alert('Please enter an admin code');
                return;
            }

            try {
                await db.collection('settings').doc('admin').set({
                    adminCode: newPassword,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                
                alert(' Admin code updated successfully!');
                document.getElementById('adminPasswordInput').value = '';
                document.getElementById('adminPasswordInput').placeholder = '';
            } catch (error) {
                console.error('Error updating admin code:', error);
                alert('Failed to update admin code: ' + error.message);
            }
        });
        }

        // Update Cooldown
        const updateCooldownBtn = document.getElementById('updateCooldownBtn');
        if (updateCooldownBtn) {
            updateCooldownBtn.addEventListener('click', async () => {
            const db = window.db || firebase.firestore();
            const cooldownMinutes = parseInt(document.getElementById('cooldownMinutes').value);
            if (!cooldownMinutes || cooldownMinutes < 1) {
                alert('Please enter a valid number of minutes (minimum 1)');
                return;
            }

            try {
                await db.collection('settings').doc('admin').set({
                    CheckINCooldownMinutes: cooldownMinutes,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                
                alert(' Cooldown period updated successfully!');
            } catch (error) {
                console.error('Error updating cooldown:', error);
                alert('Failed to update cooldown: ' + error.message);
            }
        });
        }

        // Update Email Notification Time
        const updateEmailTimeBtn = document.getElementById('updateEmailTimeBtn');
        if (updateEmailTimeBtn) {
            updateEmailTimeBtn.addEventListener('click', async () => {
                const db = window.db || firebase.firestore();
                const emailTime = document.getElementById('emailNotificationTime').value;
                if (!emailTime) {
                    alert('Please enter a time for email notifications');
                    return;
                }

                try {
                    await db.collection('settings').doc('admin').set({
                        emailNotificationTime: emailTime,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                    
                    alert(' Email notification time updated successfully!');
                } catch (error) {
                    console.error('Error updating email notification time:', error);
                    alert('Failed to update email notification time: ' + error.message);
                }
            });
        }

        // Update Email Tolerance Window
        const updateEmailToleranceBtn = document.getElementById('updateEmailToleranceBtn');
        if (updateEmailToleranceBtn) {
            updateEmailToleranceBtn.addEventListener('click', async () => {
                const db = window.db || firebase.firestore();
                const toleranceWindow = parseInt(document.getElementById('emailToleranceWindow').value);
                
                if (isNaN(toleranceWindow) || toleranceWindow < 0 || toleranceWindow > 60) {
                    alert('Please enter a valid number between 0 and 60 minutes');
                    return;
                }

                try {
                    await db.collection('settings').doc('admin').set({
                        emailToleranceWindow: toleranceWindow,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                    
                    alert(` Email tolerance window updated successfully!\n\nEmails will now be sent if the function runs within ${toleranceWindow} minute(s) of the notification time.`);
                } catch (error) {
                    console.error('Error updating email tolerance window:', error);
                    alert('Failed to update email tolerance window: ' + error.message);
                }
            });
        }

        // Update Email Check Frequency
        const updateEmailFrequencyBtn = document.getElementById('updateEmailFrequencyBtn');
        if (updateEmailFrequencyBtn) {
            updateEmailFrequencyBtn.addEventListener('click', async () => {
                const db = window.db || firebase.firestore();
                if (!emailCheckFrequencySelect) {
                    alert('Frequency selector not found');
                    return;
                }

                let frequencyValue = emailCheckFrequencySelect.value;

                if (frequencyValue === 'custom') {
                    const cronExpression = getCustomCronExpression(true);
                    if (!cronExpression) {
                        return;
                    }
                    frequencyValue = cronExpression;
                }

                try {
                    await db.collection('settings').doc('admin').set({
                        emailCheckFrequency: frequencyValue,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                    
                    alert(' Email check frequency updated!\n\nYour Cloud Scheduler job should continue pointing to the HTTP function. The function now uses this preference to decide when to send notifications.');
                    updateCronPreview();
                } catch (error) {
                    console.error('Error updating email check frequency:', error);
                    alert('Failed to update email check frequency: ' + error.message);
                }
            });
        }

        if (copyCronBtn && cronPreviewInput) {
            copyCronBtn.addEventListener('click', async () => {
                const value = cronPreviewInput.value.trim();
                if (!value) {
                    alert('No cron expression to copy yet.');
                    return;
                }
                try {
                    await navigator.clipboard.writeText(value);
                    copyCronBtn.innerHTML = '<i class="fas fa-check"></i>';
                    setTimeout(() => {
                        copyCronBtn.innerHTML = '<i class="fas fa-copy"></i>';
                    }, 1500);
                } catch (err) {
                    console.error('Clipboard write failed:', err);
                    alert('Unable to copy. Please copy manually.');
                }
            });
        }

        // Update Email Configuration
        const updateEmailConfigBtn = document.getElementById('updateEmailConfigBtn');
        if (updateEmailConfigBtn) {
            updateEmailConfigBtn.addEventListener('click', async () => {
                const db = window.db || firebase.firestore();
                const emailAccount = document.getElementById('emailAccount').value.trim();
                const emailAppPassword = document.getElementById('emailAppPassword').value.trim();
                const emailFrom = document.getElementById('emailFrom').value.trim();

                if (!emailAccount) {
                    alert('Please enter a Gmail address');
                    return;
                }

                if (!emailAppPassword && !document.getElementById('emailAppPassword').placeholder.includes('')) {
                    alert('Please enter a Gmail app password');
                    return;
                }

                if (!emailFrom) {
                    alert('Please enter a "From" email address');
                    return;
                }

                try {
                    const updateData = {
                        emailAccount: emailAccount,
                        emailFrom: emailFrom,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    // Only update password if a new one was entered
                    if (emailAppPassword) {
                        updateData.emailAppPassword = emailAppPassword;
                    }

                    await db.collection('settings').doc('admin').set(updateData, { merge: true });
                    
                    // Clear password field and show placeholder
                    document.getElementById('emailAppPassword').value = '';
                    document.getElementById('emailAppPassword').placeholder = '';
                    
                    alert(' Email configuration updated successfully!\n\nNote: You may need to update Firebase Functions config manually using:\nfirebase functions:config:set email.user="' + emailAccount + '"\nfirebase functions:config:set email.password="your-app-password"\nfirebase functions:config:set email.from="' + emailFrom + '"');
                } catch (error) {
                    console.error('Error updating email configuration:', error);
                    alert('Failed to update email configuration: ' + error.message);
                }
            });
        }

        // Update Email Templates
        const updateEmailTemplateBtn = document.getElementById('updateEmailTemplateBtn');
        if (updateEmailTemplateBtn) {
            updateEmailTemplateBtn.addEventListener('click', async () => {
                const db = window.db || firebase.firestore();
                const emailSubjectUser = document.getElementById('emailSubjectUser').value.trim();
                const emailSubjectAdmin = document.getElementById('emailSubjectAdmin').value.trim();
                const emailBodyUser = document.getElementById('emailBodyUser').value.trim();
                const emailBodyAdmin = document.getElementById('emailBodyAdmin').value.trim();

                if (!emailSubjectUser || !emailSubjectAdmin || !emailBodyUser || !emailBodyAdmin) {
                    alert('Please fill in all email template fields');
                    return;
                }

                try {
                    await db.collection('settings').doc('admin').set({
                        emailSubjectUser: emailSubjectUser,
                        emailSubjectAdmin: emailSubjectAdmin,
                        emailBodyUser: emailBodyUser,
                        emailBodyAdmin: emailBodyAdmin,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                    
                    alert(' Email templates updated successfully!');
                } catch (error) {
                    console.error('Error updating email templates:', error);
                    alert('Failed to update email templates: ' + error.message);
                }
            });
        }

        // Reset Email Templates to Default
        const resetEmailTemplateBtn = document.getElementById('resetEmailTemplateBtn');
        if (resetEmailTemplateBtn) {
            resetEmailTemplateBtn.addEventListener('click', async () => {
                const db = window.db || firebase.firestore();
                if (!confirm('Are you sure you want to reset email templates to default values?')) {
                    return;
                }

                const defaultSubjectUser = 'Tool Tracking Reminder: {count} Tool(s) Checked Out';
                const defaultSubjectAdmin = 'Daily Tool Status Report: {count} Tool(s) Currently OUT';
                const defaultBodyUser = `Hello {userName},

This is a reminder that you currently have <strong>{count}</strong> tool(s) checked out:

{toolList}

Please remember to check in these tools when you're done using them.

Thank you!`;
                const defaultBodyAdmin = `Hello Administrators,

This is the daily summary of tools currently checked out:

<strong>Total Tools OUT: {count}</strong>

{toolList}

Thank you!`;

                document.getElementById('emailSubjectUser').value = defaultSubjectUser;
                document.getElementById('emailSubjectAdmin').value = defaultSubjectAdmin;
                document.getElementById('emailBodyUser').value = defaultBodyUser;
                document.getElementById('emailBodyAdmin').value = defaultBodyAdmin;

                try {
                    await db.collection('settings').doc('admin').set({
                        emailSubjectUser: defaultSubjectUser,
                        emailSubjectAdmin: defaultSubjectAdmin,
                        emailBodyUser: defaultBodyUser,
                        emailBodyAdmin: defaultBodyAdmin,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                    
                    alert(' Email templates reset to default values!');
                } catch (error) {
                    console.error('Error resetting email templates:', error);
                    alert('Failed to reset email templates: ' + error.message);
                }
            });
        }

        // Update Table Configuration
        const updateTableConfigBtn = document.getElementById('updateTableConfigBtn');
        if (updateTableConfigBtn) {
            updateTableConfigBtn.addEventListener('click', async () => {
                const db = window.db || firebase.firestore();
                try {
                    // Get user table columns
                    const userTableColumns = {
                        toolName: document.getElementById('tableColToolName').checked,
                        partNumber: document.getElementById('tableColPartNumber').checked,
                        checkoutDate: document.getElementById('tableColCheckoutDate').checked,
                        location: document.getElementById('tableColLocation').checked,
                        owner: document.getElementById('tableColOwner').checked,
                        calDueDate: document.getElementById('tableColCalDueDate').checked
                    };
                    
                    // Get admin table columns
                    const adminTableColumns = {
                        toolName: document.getElementById('adminTableColToolName').checked,
                        partNumber: document.getElementById('adminTableColPartNumber').checked,
                        technician: document.getElementById('adminTableColTechnician').checked,
                        checkoutDate: document.getElementById('adminTableColCheckoutDate').checked,
                        location: document.getElementById('adminTableColLocation').checked,
                        owner: document.getElementById('adminTableColOwner').checked,
                        calDueDate: document.getElementById('adminTableColCalDueDate').checked
                    };
                    
                    // Get table header color
                    const tableHeaderColor = document.getElementById('tableHeaderColor').value;
                    
                    await db.collection('settings').doc('admin').set({
                        userTableColumns: userTableColumns,
                        adminTableColumns: adminTableColumns,
                        tableHeaderColor: tableHeaderColor,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                    
                    alert(' Table configuration updated successfully!');
                } catch (error) {
                    console.error('Error updating table configuration:', error);
                    alert('Failed to update table configuration: ' + error.message);
                }
            });
        }

        // Load Users
        async function loadUsers() {
            const db = window.db || firebase.firestore();
            const tableBody = document.getElementById('usersTableBody');
            const mobileCards = document.getElementById('userCardsMobile');
            const loading = document.getElementById('usersLoading');
            
            try {
                loading.style.display = 'block';
                const snapshot = await db.collection('technicians').get();
                tableBody.innerHTML = '';
                mobileCards.innerHTML = '';

                snapshot.forEach(doc => {
                    const userData = doc.data();
                    
                    // Desktop table row
                    const isAdmin = userData.isAdmin || false;
                    const isInstructor = userData.isInstructor || false;
                    const isAvionics = userData.isAvionics || false;
                    
                    const badges = [];
                    if (isAdmin) badges.push('<span class="badge-admin"><i class="fas fa-shield-alt"></i> Admin</span>');
                    if (isInstructor) badges.push('<span class="badge-instructor"><i class="fas fa-chalkboard-teacher"></i> Instructor</span>');
                    if (isAvionics) badges.push('<span class="badge-avionics"><i class="fas fa-cog"></i> Avionics</span>');
                    if (badges.length === 0) badges.push('<span class="badge-user">User</span>');
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${userData.fullName || 'N/A'}</td>
                        <td>${userData.email || 'N/A'}</td>
                        <td>
                            <div class="role-badges">${badges.join('')}</div>
                        </td>
                        <td>
                            <div class="role-buttons">
                                <button class="btn btn-sm btn-${isAdmin ? 'danger' : 'success'}" onclick="toggleAdmin('${doc.id}', ${!isAdmin})">
                                    ${isAdmin ? '<i class="fas fa-shield-alt"></i> Remove Admin' : '<i class="fas fa-shield-alt"></i> Make Admin'}
                                </button>
                                <button class="btn btn-sm btn-${isInstructor ? 'danger' : 'info'}" onclick="toggleInstructor('${doc.id}', ${!isInstructor})">
                                    ${isInstructor ? '<i class="fas fa-chalkboard-teacher"></i> Remove Instructor' : '<i class="fas fa-chalkboard-teacher"></i> Make Instructor'}
                                </button>
                                <button class="btn btn-sm btn-${isAvionics ? 'danger' : 'warning'}" onclick="toggleAvionics('${doc.id}', ${!isAvionics})">
                                    ${isAvionics ? '<i class="fas fa-cog"></i> Remove Avionics' : '<i class="fas fa-cog"></i> Make Avionics'}
                                </button>
                            </div>
                        </td>
                    `;
                    tableBody.appendChild(row);

                    // Mobile card
                    const card = document.createElement('div');
                    card.className = 'user-card-item';
                    const mobileBadges = [];
                    if (isAdmin) mobileBadges.push('<span class="badge-admin"><i class="fas fa-shield-alt"></i> Admin</span>');
                    if (isInstructor) mobileBadges.push('<span class="badge-instructor"><i class="fas fa-chalkboard-teacher"></i> Instructor</span>');
                    if (isAvionics) mobileBadges.push('<span class="badge-avionics"><i class="fas fa-cog"></i> Avionics</span>');
                    if (mobileBadges.length === 0) mobileBadges.push('<span class="badge-user">User</span>');
                    
                    card.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <span class="user-number-3d">${userIndex}</span>
                            <h6 style="margin: 0; flex: 1;"><i class="fas fa-user"></i> ${userData.fullName || 'N/A'}</h6>
                        </div>
                        <p><i class="fas fa-envelope"></i> ${userData.email || 'N/A'}</p>
                        <p>
                            <div class="role-badges">${mobileBadges.join('')}</div>
                        </p>
                        <div class="role-buttons" style="flex-direction: column; gap: 8px;">
                            <button class="btn btn-sm btn-${isAdmin ? 'danger' : 'success'}" onclick="toggleAdmin('${doc.id}', ${!isAdmin})">
                                ${isAdmin ? '<i class="fas fa-shield-alt"></i> Remove Admin' : '<i class="fas fa-shield-alt"></i> Make Admin'}
                            </button>
                            <button class="btn btn-sm btn-${isInstructor ? 'danger' : 'info'}" onclick="toggleInstructor('${doc.id}', ${!isInstructor})">
                                ${isInstructor ? '<i class="fas fa-chalkboard-teacher"></i> Remove Instructor' : '<i class="fas fa-chalkboard-teacher"></i> Make Instructor'}
                            </button>
                            <button class="btn btn-sm btn-${isAvionics ? 'danger' : 'warning'}" onclick="toggleAvionics('${doc.id}', ${!isAvionics})">
                                ${isAvionics ? '<i class="fas fa-cog"></i> Remove Avionics' : '<i class="fas fa-cog"></i> Make Avionics'}
                            </button>
                            <button class="btn btn-sm btn-danger delete-user-btn-3d" onclick="deleteUser('${doc.id}', '${(userData.email || '').replace(/'/g, "\\'")}', '${(userData.fullName || 'N/A').replace(/'/g, "\\'")}')" title="Delete User">
                                <i class="fas fa-trash-alt"></i> Delete
                            </button>
                        </div>
                    `;
                    mobileCards.appendChild(card);
                });

                loading.style.display = 'none';
            } catch (error) {
                console.error('Error loading users:', error);
                tableBody.innerHTML = '<tr><td colspan="5" class="text-danger">Error loading users</td></tr>';
                mobileCards.innerHTML = '<p class="text-danger">Error loading users</p>';
                loading.style.display = 'none';
            }
        }

        // Toggle Admin Status
        window.toggleAdmin = async function(userId, makeAdmin) {
            const db = window.db || firebase.firestore();
            const confirmMsg = makeAdmin 
                ? 'Are you sure you want to grant admin privileges to this user?' 
                : 'Are you sure you want to remove admin privileges from this user?';
            
            if (!confirm(confirmMsg)) return;

            try {
                await db.collection('technicians').doc(userId).update({
                    isAdmin: makeAdmin
                });
                alert(` User ${makeAdmin ? 'promoted to' : 'removed from'} admin successfully!`);
                loadUsers(); // Reload users list
                loadStatistics(); // Refresh stats
            } catch (error) {
                console.error('Error updating user:', error);
                alert('Failed to update user: ' + error.message);
            }
        };

        // Toggle Instructor Status
        window.toggleInstructor = async function(userId, makeInstructor) {
            const db = window.db || firebase.firestore();
            const confirmMsg = makeInstructor 
                ? 'Are you sure you want to grant instructor privileges to this user?' 
                : 'Are you sure you want to remove instructor privileges from this user?';
            
            if (!confirm(confirmMsg)) return;

            try {
                await db.collection('technicians').doc(userId).update({
                    isInstructor: makeInstructor
                });
                alert(` User ${makeInstructor ? 'promoted to' : 'removed from'} instructor successfully!`);
                loadUsers(); // Reload users list
            } catch (error) {
                console.error('Error updating user:', error);
                alert('Failed to update user: ' + error.message);
            }
        };

        // Toggle Avionics Status
        window.toggleAvionics = async function(userId, makeAvionics) {
            const db = window.db || firebase.firestore();
            const confirmMsg = makeAvionics 
                ? 'Are you sure you want to grant avionics privileges to this user?' 
                : 'Are you sure you want to remove avionics privileges from this user?';
            
            if (!confirm(confirmMsg)) return;

            try {
                await db.collection('technicians').doc(userId).update({
                    isAvionics: makeAvionics
                });
                alert(` User ${makeAvionics ? 'promoted to' : 'removed from'} avionics successfully!`);
                loadUsers(); // Reload users list
            } catch (error) {
                console.error('Error updating user:', error);
                alert('Failed to update user: ' + error.message);
            }
        };

        // Delete User
        window.deleteUser = async function(userId, userEmail, userName) {
            const db = window.db || firebase.firestore();
            
            const confirmMsg = `Are you sure you want to delete user "${userName}" (${userEmail})?\n\nThis will:\n- Delete the user from the technicians collection\n\n Note: To delete from Firebase Authentication, you'll need to:\n1. Use Firebase Console (Authentication > Users)\n2. Or implement a Cloud Function with Admin SDK\n\nThis action cannot be undone!`;
            
            if (!confirm(confirmMsg)) return;

            try {
                // Delete from technicians collection
                await db.collection('technicians').doc(userId).delete();
                console.log('User deleted from technicians collection:', userId);

                alert(` User "${userName}" deleted from technicians collection successfully!\n\n Remember: Delete the user from Firebase Authentication manually via Firebase Console (Authentication > Users) or implement a Cloud Function with Admin SDK for automatic deletion.`);

                // Reload users list
                loadUsers();
                loadStatistics(); // Refresh stats
            } catch (error) {
                console.error('Error deleting user:', error);
                alert('Failed to delete user: ' + error.message);
            }
        };

        // User Search
        const userSearchElement = document.getElementById('userSearch');
        if (userSearchElement) {
            userSearchElement.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            
            // Search in table rows
            const rows = document.querySelectorAll('#usersTableBody tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });

            // Search in mobile cards
            const cards = document.querySelectorAll('.user-card-item');
            cards.forEach(card => {
                const text = card.textContent.toLowerCase();
                card.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        });
        }

        // ========================================
        // TOOLS MANAGEMENT FUNCTIONS
        // ========================================

        let currentToolsUser = null;
        let currentToolsFilter = 'today';
        let allToolHistory = [];

        // Show Tools By User
        window.showToolsByUser = function() {
            document.getElementById('toolsMainMenu').style.display = 'none';
            document.getElementById('toolsByUserSection').style.display = 'block';
            document.getElementById('toolsUserSelection').style.display = 'block';
            document.getElementById('toolHistorySection').style.display = 'none';
            loadToolsUsers();
        };

        // Show other sections (placeholders)
        window.showToolsByOwner = function() {
            hideAllToolsSections();
            document.getElementById('toolsByOwnerSection').style.display = 'block';
        };

        window.showAddEditTool = function() {
            hideAllToolsSections();
            document.getElementById('addEditToolSection').style.display = 'block';
        };

        window.showImportExcel = function() {
            hideAllToolsSections();
            document.getElementById('importExcelSection').style.display = 'block';
        };

        window.showExportTools = function() {
            hideAllToolsSections();
            document.getElementById('exportToolsSection').style.display = 'block';
        };

        function hideAllToolsSections() {
            document.getElementById('toolsMainMenu').style.display = 'none';
            document.getElementById('toolsByUserSection').style.display = 'none';
            document.getElementById('toolsByOwnerSection').style.display = 'none';
            document.getElementById('addEditToolSection').style.display = 'none';
            document.getElementById('importExcelSection').style.display = 'none';
            document.getElementById('exportToolsSection').style.display = 'none';
        }

        window.backToToolsMenu = function() {
            hideAllToolsSections();
            document.getElementById('toolsMainMenu').style.display = 'block';
        };

        window.backToToolsUserSelection = function() {
            document.getElementById('toolsUserSelection').style.display = 'block';
            document.getElementById('toolHistorySection').style.display = 'none';
        };

        // Load users for Tools By User section
        async function loadToolsUsers() {
            const db = window.db || firebase.firestore();
            const loading = document.getElementById('toolsUsersLoading');
            const usersList = document.getElementById('toolsUsersList');
            
            try {
                loading.style.display = 'block';
                const snapshot = await db.collection('technicians').get();
                usersList.innerHTML = '';

                // Get OUT tool counts for each user
                const toolsSnapshot = await db.collection('tools').where('status', '==', 'OUT').get();
                const outCounts = {};
                
                console.log('=== DEBUGGING OUT TOOLS COUNT ===');
                toolsSnapshot.forEach(doc => {
                    const owner = doc.data().technician || 'Unknown';
                    outCounts[owner] = (outCounts[owner] || 0) + 1;
                    console.log(`Tool ${doc.id}: technician="${owner}", count=${outCounts[owner]}`);
                });
                console.log('Final outCounts:', outCounts);

                // Collect all users and sort alphabetically
                const users = [];
                snapshot.forEach(doc => {
                    const userData = doc.data();
                    const userName = userData.fullName || 'Unknown';
                    const outCount = outCounts[userName] || 0;
                    console.log(`Technician: "${userName}", outCount: ${outCount}`);
                    users.push({
                        id: doc.id,
                        name: userName,
                        email: userData.email || 'N/A',
                        outCount: outCount
                    });
                });

                // Separate users into two groups
                const outUsers = users.filter(u => u.outCount > 0).sort((a, b) => a.name.localeCompare(b.name));
                const allInUsers = users.filter(u => u.outCount === 0).sort((a, b) => a.name.localeCompare(b.name));

                // Display users with OUT tools first
                if (outUsers.length > 0) {
                    // Group header for OUT users
                    const headerDiv = document.createElement('div');
                    headerDiv.className = 'col-12';
                    headerDiv.innerHTML = `
                        <h5 class="mb-3 mt-3" style="color: #dc3545; font-weight: bold;">
                            <i class="fas fa-exclamation-triangle"></i> Users with Checked-OUT Tools (${outUsers.length})
                        </h5>
                    `;
                    usersList.appendChild(headerDiv);

                    // Display OUT users with numbering
                    outUsers.forEach((user, index) => {
                        const card = document.createElement('div');
                        card.className = 'col-md-4 col-sm-6';
                        card.innerHTML = `
                            <div class="user-tool-card" onclick="selectToolsUser('${user.id}', '${user.name}')">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1"><i class="fas fa-user"></i> ${index + 1}. ${user.name}</h6>
                                        <small class="text-muted">${user.email}</small>
                                    </div>
                                    <span class="out-badge">OUT: ${user.outCount}</span>
                                </div>
                            </div>
                        `;
                        usersList.appendChild(card);
                    });
                }

                // Display users with all IN tools
                if (allInUsers.length > 0) {
                    // Group header for all IN users
                    const headerDiv = document.createElement('div');
                    headerDiv.className = 'col-12';
                    headerDiv.innerHTML = `
                        <h5 class="mb-3 mt-3" style="color: #28a745; font-weight: bold;">
                            <i class="fas fa-check-circle"></i> Users With All Tools Checked-IN (${allInUsers.length})
                        </h5>
                    `;
                    usersList.appendChild(headerDiv);

                    // Display all IN users with separate numbering
                    allInUsers.forEach((user, index) => {
                        const card = document.createElement('div');
                        card.className = 'col-md-4 col-sm-6';
                        card.innerHTML = `
                            <div class="user-tool-card" onclick="selectToolsUser('${user.id}', '${user.name}')">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1"><i class="fas fa-user"></i> ${index + 1}. ${user.name}</h6>
                                        <small class="text-muted">${user.email}</small>
                                    </div>
                                    <span style="color: #28a745; font-size: 0.85rem; white-space: nowrap;"><i class="fas fa-check-circle"></i> All IN</span>
                                </div>
                            </div>
                        `;
                        usersList.appendChild(card);
                    });
                }

                loading.style.display = 'none';
            } catch (error) {
                console.error('Error loading users:', error);
                usersList.innerHTML = '<p class="text-danger">Error loading users</p>';
                loading.style.display = 'none';
            }
        }

        // Search users in tools section
        const toolsUserSearchElement = document.getElementById('toolsUserSearch');
        if (toolsUserSearchElement) {
            toolsUserSearchElement.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const cards = document.querySelectorAll('#toolsUsersList .user-tool-card');
                cards.forEach(card => {
                    const text = card.textContent.toLowerCase();
                    card.parentElement.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            });
        }

        // Select a user to view their tool history
        window.selectToolsUser = async function(userId, userName) {
            currentToolsUser = { id: userId, name: userName };
            document.getElementById('selectedUserNameTools').textContent = userName;
            document.getElementById('toolsUserSelection').style.display = 'none';
            document.getElementById('toolHistorySection').style.display = 'block';
            
            // Load all tool history for this user
            await loadUserToolHistory(userName);
            
            // Apply default filter (all time) with a small delay to ensure DOM is ready
            setTimeout(() => {
                console.log('Applying default filter: all');
                
                // First, manually activate the All Time button using a more reliable selector
                const allTimeBtn = document.querySelector('#toolHistorySection button[onclick*="all"]');
                if (allTimeBtn) {
                    console.log('Found All Time button with ID selector, manually activating...');
                    allTimeBtn.classList.add('active');
                } else {
                    console.log('All Time button not found with ID selector, trying text content...');
                    // Try finding by text content
                    const buttons = document.querySelectorAll('#toolHistorySection .filter-time-btn');
                    buttons.forEach(btn => {
                        if (btn.textContent.includes('All Time')) {
                            console.log('Found All Time button by text content, activating...');
                            btn.classList.add('active');
                        }
                    });
                }
                
                // Then apply the filter
                filterToolHistory('all');
                
                // Double-check the button state after a short delay
                setTimeout(() => {
                    const finalBtn = document.querySelector('#toolHistorySection button[onclick*="all"]') || 
                                   Array.from(document.querySelectorAll('#toolHistorySection .filter-time-btn'))
                                        .find(btn => btn.textContent.includes('All Time'));
                    console.log('Final All Time button check:', finalBtn);
                    console.log('Button classes:', finalBtn ? finalBtn.className : 'Button not found');
                    console.log('Button computed styles:', finalBtn ? window.getComputedStyle(finalBtn).backgroundColor : 'Button not found');
                }, 200);
            }, 100);
        };

        // Load all tool history for a user from logtoolmovements collection
        async function loadUserToolHistory(userName) {
            const db = window.db || firebase.firestore();
            try {
                // Use logtoolmovements collection with existing index (technician field, not technicianName)
                const snapshot = await db.collection('logtoolmovements')
                    .where('technician', '==', userName)
                    .orderBy('timestamp', 'desc')
                    .limit(500)
                    .get();

                allToolHistory = [];
                snapshot.forEach(doc => {
                    allToolHistory.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                console.log(`Loaded ${allToolHistory.length} history entries for ${userName} from logtoolmovements collection`);
            } catch (error) {
                console.error('Error loading tool history from logtoolmovements:', error);
                allToolHistory = [];
            }
        }

        // Filter tool history by time period
        window.filterToolHistory = function(period, clickedButton = null) {
            currentToolsFilter = period;
            
            // Update button states
            document.querySelectorAll('.filter-time-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // If a button was clicked, activate it
            if (clickedButton) {
                clickedButton.classList.add('active');
            } else {
                // Find the button with the matching period and activate it using multiple approaches
                console.log(`Looking for button with period: ${period}`);
                
                // Try different selectors
                let targetButton = document.querySelector(`#toolHistorySection button[onclick*="${period}"]`);
                
                if (!targetButton) {
                    // Try finding by text content
                    const buttons = document.querySelectorAll('#toolHistorySection .filter-time-btn');
                    const periodTexts = {
                        'today': 'Today',
                        'week': 'Last Week', 
                        'month': 'Last Month',
                        'year': 'Last Year',
                        'all': 'All Time'
                    };
                    
                    targetButton = Array.from(buttons).find(btn => 
                        btn.textContent.includes(periodTexts[period])
                    );
                }
                
                console.log(`Found target button:`, targetButton);
                if (targetButton) {
                    targetButton.classList.add('active');
                    console.log(`Activated button for period: ${period}`);
                } else {
                    console.log(`No button found for period: ${period}`);
                }
            }
            
            const now = new Date();
            let startDate;
            
            switch(period) {
                case 'today':
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    break;
                case 'week':
                    startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    break;
                case 'month':
                    startDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                    break;
                case 'year':
                    startDate = new Date(now.getTime() - 365 * 24 * 60 * 60 * 1000);
                    break;
                case 'all':
                    startDate = new Date(0);
                    break;
            }
            
            const filtered = allToolHistory.filter(entry => {
                const entryDate = entry.timestamp?.toDate ? entry.timestamp.toDate() : new Date(entry.timestamp);
                return entryDate >= startDate;
            });
            
            displayToolHistory(filtered);
        };

        // Toggle OUT tools only
        window.toggleOutToolsOnly = async function() {
            const showOutOnly = document.getElementById('showOutToolsOnly').checked;
            const bulkControls = document.getElementById('bulkCheckinControls');
            
            if (showOutOnly) {
                // Show bulk check-in controls
                bulkControls.style.display = 'block';
                
                // Fetch current OUT tools for this user from tools collection
                const snapshot = await db.collection('tools')
                    .where('technician', '==', currentToolsUser.name)
                    .where('status', '==', 'OUT')
                    .get();
                
                const outTools = [];
                snapshot.forEach(doc => {
                    outTools.push({
                        id: doc.id,
                        toolId: doc.id,
                        toolName: doc.data().toolName,
                        status: 'OUT',
                        timestamp: doc.data().timestamp,
                        WorkOn: doc.data().WorkOn,
                        workLocation: doc.data().WorkOn,
                        serialNumber: doc.data().serialNumber,
                        partNumber: doc.data().partNumber,
                        calDueDate: doc.data().calDueDate,
                        technician: doc.data().technician,
                        ...doc.data()
                    });
                });
                
                displayToolHistory(outTools, true);
            } else {
                // Hide bulk check-in controls
                bulkControls.style.display = 'none';
                
                // Show filtered history
                filterToolHistory(currentToolsFilter);
            }
        };

        // Toggle select all tools checkbox
        window.toggleSelectAllTools = function() {
            const selectAllCheckbox = document.getElementById('selectAllTools');
            const toolCheckboxes = document.querySelectorAll('.tool-checkbox');
            
            toolCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
        };

        // Check in selected tools
        window.checkInSelectedTools = async function() {
            const selectedCheckboxes = document.querySelectorAll('.tool-checkbox:checked');
            
            if (selectedCheckboxes.length === 0) {
                alert('Please select at least one tool to check in.');
                return;
            }
            
            const confirmMessage = `Are you sure you want to check in ${selectedCheckboxes.length} tool(s)?`;
            if (!confirm(confirmMessage)) {
                return;
            }
            
            try {
                const batch = db.batch();
                const toolIds = [];
                
                selectedCheckboxes.forEach(checkbox => {
                    const toolId = checkbox.getAttribute('data-tool-id');
                    toolIds.push(toolId);
                    
                    // Update tool status to IN
                    const toolRef = db.collection('tools').doc(toolId);
                    batch.update(toolRef, {
                        status: 'IN',
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        technician: currentToolsUser.name
                    });
                });
                
                // Commit the batch update
                await batch.commit();
                
                // Log the check-in action
                const logPromises = toolIds.map(toolId => {
                    return db.collection('logtoolmovements').add({
                        toolId: toolId,
                        technician: currentToolsUser.name,
                        action: 'CHECK-IN',
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        WorkOn: 'Admin Check-in',
                        status: 'IN'
                    });
                });
                
                await Promise.all(logPromises);
                
                alert(`Successfully checked in ${toolIds.length} tool(s)!`);
                
                // Refresh the OUT tools list
                await toggleOutToolsOnly();
                
            } catch (error) {
                console.error('Error checking in tools:', error);
                alert('Error checking in tools. Please try again.');
            }
        };

        // Search tool in history
        window.searchToolHistory = async function() {
            const searchTerm = document.getElementById('toolHistorySearch').value.trim().toUpperCase();
            
            if (!searchTerm) {
                alert('Please enter a tool code');
                return;
            }
            
            // Filter by specific tool
            const filtered = allToolHistory.filter(entry => {
                return entry.toolId?.toUpperCase().includes(searchTerm) || 
                       entry.toolName?.toUpperCase().includes(searchTerm);
            });
            
            if (filtered.length === 0) {
                document.getElementById('toolHistoryCards').innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-info-circle"></i> No history found for tool code: ${searchTerm}
                    </div>
                `;
            } else {
                displayToolHistory(filtered);
            }
        };

        // Display tool history as cards
        function displayToolHistory(historyEntries, isCurrentOut = false) {
            const container = document.getElementById('toolHistoryCards');
            
            if (historyEntries.length === 0) {
                container.innerHTML = '<p class="text-muted">No tools found for the selected period.</p>';
                return;
            }
            
            container.innerHTML = '';
            
            // Group by tool ID for better organization
            const groupedByTool = {};
            historyEntries.forEach(entry => {
                const toolId = entry.toolId || entry.id;
                if (!groupedByTool[toolId]) {
                    groupedByTool[toolId] = [];
                }
                groupedByTool[toolId].push(entry);
            });
            
            // Sort tools by newest entry first
            const sortedTools = Object.keys(groupedByTool).sort((a, b) => {
                const aLatest = groupedByTool[a][0];
                const bLatest = groupedByTool[b][0];
                const aTime = aLatest.timestamp?.toDate ? aLatest.timestamp.toDate() : new Date(aLatest.timestamp || 0);
                const bTime = bLatest.timestamp?.toDate ? bLatest.timestamp.toDate() : new Date(bLatest.timestamp || 0);
                return bTime - aTime; // Newest first
            });
            
            // Display each tool's history with numbering
            sortedTools.forEach((toolId, index) => {
                const toolEntries = groupedByTool[toolId];
                const latestEntry = toolEntries[0];
                
                const status = (latestEntry.status || latestEntry.action || '').toUpperCase();
                let statusClass = 'in';
                if (status === 'OUT' || status === 'CHECK-OUT') statusClass = 'out';
                else if (status === 'BROKEN') statusClass = 'broken';
                else if (status === 'LOST') statusClass = 'lost';
                else if (status === 'CALIBRATION') statusClass = 'calibration';
                
                const workOnValue = latestEntry.WorkOn || latestEntry.workLocation || 'N/A';
                const serialNumber = latestEntry.serialNumber || latestEntry.partNumber || 'N/A';
                const calDueDate = latestEntry.calDueDate ? 
                    (latestEntry.calDueDate.toDate ? latestEntry.calDueDate.toDate().toLocaleDateString('en-GB') : latestEntry.calDueDate) : 
                    'N/A';
                
                const time = latestEntry.timestamp ? 
                    (latestEntry.timestamp.toDate ? 
                        latestEntry.timestamp.toDate().toLocaleString('en-GB', {
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit',
                            hour12: false
                        }) : 
                        new Date(latestEntry.timestamp).toLocaleString('en-GB')) : 
                    'N/A';
                
                const statusColor = (status === 'IN' || status === 'CHECK-IN') ? 'green' : 'red';
                
                const card = document.createElement('div');
                card.className = `register-tool-card ${statusClass}`;
                
                // For OUT tools when toggle is enabled, add checkbox instead of click handler
                if (isCurrentOut) {
                    card.style.position = 'relative';
                    card.innerHTML = `
                        <div style="position: absolute; top: 10px; right: 10px;">
                            <input type="checkbox" class="form-check-input tool-checkbox" data-tool-id="${toolId}" style="transform: scale(1.2);">
                        </div>
                        <div style="font-weight: bold; font-size: 1.1rem; margin-bottom: 8px; color: #000; text-align: left; padding-right: 30px;">
                            ${index + 1}. ${latestEntry.toolName || 'Unknown Tool'}
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <div style="color: #666; font-size: 0.9rem;">
                                ${time}
                            </div>
                            <div>
                                <span style="color: black; font-weight: bold;">WorkOn:</span> 
                                <span style="color: #666; font-weight: bold;">${workOnValue}</span>
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                            <div style="text-align: left;">
                                <span style="color: black; font-weight: bold; text-decoration: underline;">TID</span>
                            </div>
                            <div style="text-align: center;">
                                <span style="color: black; font-weight: bold; text-decoration: underline;">P/N</span>
                            </div>
                            <div style="text-align: right;">
                                <span style="color: black; font-weight: bold; text-decoration: underline;">STS</span>
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                            <div style="text-align: left;">
                                <span style="color: #666; font-weight: bold;">${toolId}</span>
                            </div>
                            <div style="text-align: center;">
                                <span style="color: #666; font-weight: bold;">${serialNumber}</span>
                            </div>
                            <div style="text-align: right;">
                                <span class="badge bg-danger" style="font-weight: bold; border-radius: 15px; padding: 4px 8px;">OUT</span>
                            </div>
                        </div>
                        <div style="margin-bottom: 12px; text-align: left;">
                            <span style="color: black; font-weight: bold;">Cal Due Date:</span> 
                            <span style="color: blue; font-weight: bold;">${calDueDate}</span>
                        </div>
                    `;
                } else {
                    // Normal history view with click handler
                    card.onclick = function() {
                        showToolHistoryDetails(toolId, toolEntries);
                    };
                    
                    card.innerHTML = `
                        <div style="font-weight: bold; font-size: 1.1rem; margin-bottom: 8px; color: #000; text-align: left;">
                            ${index + 1}. ${latestEntry.toolName || 'Unknown Tool'}
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <div style="color: #666; font-size: 0.9rem;">
                                ${time}
                            </div>
                            <div>
                                <span style="color: black; font-weight: bold;">WorkOn:</span> 
                                <span style="color: #666; font-weight: bold;">${workOnValue}</span>
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                            <div style="text-align: left;">
                                <span style="color: black; font-weight: bold; text-decoration: underline;">TID</span>
                            </div>
                            <div style="text-align: center;">
                                <span style="color: black; font-weight: bold; text-decoration: underline;">P/N</span>
                            </div>
                            <div style="text-align: right;">
                                <span style="color: black; font-weight: bold; text-decoration: underline;">STS</span>
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                            <div style="text-align: left;">
                                <span style="color: #666; font-weight: bold;">${toolId}</span>
                            </div>
                            <div style="text-align: center;">
                                <span style="color: #666; font-weight: bold;">${serialNumber}</span>
                            </div>
                            <div style="text-align: right;">
                                <span class="badge bg-${status === 'IN' || status === 'CHECK-IN' ? 'success' : 'danger'}" style="font-weight: bold; border-radius: 15px; padding: 4px 8px;">${status}</span>
                            </div>
                        </div>
                        <div style="margin-bottom: 12px; text-align: left;">
                            <span style="color: black; font-weight: bold;">Cal Due Date:</span> 
                            <span style="color: blue; font-weight: bold;">${calDueDate}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="color: blue; font-weight: normal; cursor: pointer; font-size: 1.5rem;">
                                Click To Filter
                            </div>
                        </div>
                    `;
                }
                
                container.appendChild(card);
            });
        }

        // Show detailed history for a specific tool
        function showToolHistoryDetails(toolId, entries) {
            // Create modal content
            let historyHtml = '<div class="list-group">';
            
            entries.forEach((entry, index) => {
                const time = entry.timestamp ? 
                    (entry.timestamp.toDate ? 
                        entry.timestamp.toDate().toLocaleString('en-GB') : 
                        new Date(entry.timestamp).toLocaleString('en-GB')) : 
                    'N/A';
                
                const action = entry.action || entry.status || 'Unknown';
                const location = entry.WorkOn || entry.workLocation || 'N/A';
                const actionColor = action.toUpperCase().includes('OUT') ? 'text-danger' : 'text-success';
                
                historyHtml += `
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between">
                            <h6 class="mb-1">${index + 1}. <span class="${actionColor}">${action}</span></h6>
                            <small>${time}</small>
                        </div>
                        <p class="mb-1"><strong>Location:</strong> ${location}</p>
                        ${entry.notes ? `<p class="mb-0"><strong>Notes:</strong> ${entry.notes}</p>` : ''}
                    </div>
                `;
            });
            
            historyHtml += '</div>';
            
            // Show in Bootstrap modal - full screen
            const modalHtml = `
                <div class="modal fade" id="toolHistoryModal" tabindex="-1" style="z-index: 99999 !important;">
                    <div class="modal-dialog modal-fullscreen">
                        <div class="modal-content" style="height: 100vh; border-radius: 0; border: none;">
                            <div class="modal-header" style="background: #667eea; color: white; border-bottom: 2px solid #5a6fd8;">
                                <h5 class="modal-title">
                                    <i class="fas fa-history"></i> Complete History - ${toolId}
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body" style="overflow-y: auto; max-height: calc(100vh - 120px);">
                                ${historyHtml}
                            </div>
                            <div class="modal-footer" style="background: #f5f7fa; border-top: 2px solid #dee2e6;">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('toolHistoryModal');
            if (existingModal) existingModal.remove();
            
            // Add and show modal
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modal = new bootstrap.Modal(document.getElementById('toolHistoryModal'));
            modal.show();
            
            // Clean up after hide
            document.getElementById('toolHistoryModal').addEventListener('hidden.bs.modal', function() {
                this.remove();
            });
        }

        // Load Tools (legacy - not used in new menu)
        async function loadTools() {
            const db = window.db || firebase.firestore();
            // This function is replaced by the new tools menu system
            console.log('Tools section now uses submenu navigation');
        }

        // Delete Tool
        window.deleteTool = async function(toolId, toolName) {
            const db = window.db || firebase.firestore();
            if (!confirm(`Are you sure you want to delete "${toolName}"?\n\nThis action cannot be undone!`)) {
                return;
            }

            try {
                await db.collection('tools').doc(toolId).delete();
                alert(' Tool deleted successfully!');
                loadTools(); // Reload tools list
                loadStatistics(); // Refresh stats
            } catch (error) {
                console.error('Error deleting tool:', error);
                alert('Failed to delete tool: ' + error.message);
            }
        };

        // Tool Search (legacy - not used in new menu)
        // This element doesn't exist in the new Tools menu structure
        // const toolSearchElement = document.getElementById('toolSearch');
        // if (toolSearchElement) {
        //     toolSearchElement.addEventListener('input', function() {
        //         const searchTerm = this.value.toLowerCase();
        //         const cards = document.querySelectorAll('#toolsListContainer .settings-group');
        //         cards.forEach(card => {
        //             const text = card.textContent.toLowerCase();
        //             card.style.display = text.includes(searchTerm) ? '' : 'none';
        //         });
        //     });
        // }

        // Load Analytics
        async function loadAnalytics() {
            const db = window.db || firebase.firestore();
            try {
                // Get today's date range
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);

                // Get today's tools (registered today)
                const toolsSnapshot = await db.collection('tools')
                    .where('registeredAt', '>=', firebase.firestore.Timestamp.fromDate(today))
                    .where('registeredAt', '<', firebase.firestore.Timestamp.fromDate(tomorrow))
                    .get();

                let checkIns = 0;
                let checkOuts = 0;
                const activeUsers = new Set();

                toolsSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.status === 'IN') checkIns++;
                    else if (data.status === 'OUT') checkOuts++;
                    if (data.loggedInTechnician) activeUsers.add(data.loggedInTechnician);
                });

                document.getElementById('checkInsToday').textContent = checkIns;
                document.getElementById('checkOutsToday').textContent = checkOuts;
                document.getElementById('activeUsersToday').textContent = activeUsers.size;

                // Top users (simplified - just show count of tools per user)
                const userToolCounts = {};
                const allToolsSnapshot = await db.collection('tools').get();
                allToolsSnapshot.forEach(doc => {
                    const owner = doc.data().collectionName;
                    if (owner) {
                        userToolCounts[owner] = (userToolCounts[owner] || 0) + 1;
                    }
                });

                const topUsers = Object.entries(userToolCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);

                const topUsersList = document.getElementById('topUsersList');
                if (topUsers.length > 0) {
                    topUsersList.innerHTML = topUsers.map(([user, count], index) => 
                        `<div style="padding: 8px 0; border-bottom: 1px solid #eee;">
                            <strong>${index + 1}. ${user}</strong> - ${count} tools
                        </div>`
                    ).join('');
                } else {
                    topUsersList.innerHTML = '<p class="text-muted">No data available</p>';
                }

                // Recent activity log (last 20 tools registered)
                const recentSnapshot = await db.collection('tools')
                    .orderBy('registeredAt', 'desc')
                    .limit(20)
                    .get();

                const activityLog = document.getElementById('recentActivityLog');
                if (!recentSnapshot.empty) {
                    activityLog.innerHTML = recentSnapshot.docs.map(doc => {
                        const data = doc.data();
                        const date = data.registeredAt ? data.registeredAt.toDate().toLocaleString() : 'Unknown';
                        const statusColor = data.status === 'IN' ? '#28a745' : '#dc3545';
                        return `<div style="padding: 10px; border-bottom: 1px solid #eee;">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div>
                                    <strong>${data.toolName || 'Unknown Tool'}</strong>
                                    <span style="color: ${statusColor}; font-weight: bold; margin-left: 10px;">${data.status || 'N/A'}</span>
                                    <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">
                                        ${data.loggedInTechnician || 'Unknown'} | ${data.location || 'No location'}
                                    </div>
                                </div>
                                <small style="color: #999;">${date}</small>
                            </div>
                        </div>`;
                    }).join('');
                } else {
                    activityLog.innerHTML = '<p class="text-muted">No recent activity</p>';
                }

            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }

        
        // Continue with rest of script using auth, db, storage from scope
        (function() {
            // Make them available globally for other functions
            window.getAuth = () => window.auth;
            window.getDb = () => window.db;
            window.getStorage = () => window.storage;

        // Session timeout (30 minutes of inactivity)
        let sessionTimeout;
        function resetSessionTimeout() {
            clearTimeout(sessionTimeout);
            const auth = window.auth;
            if (!auth) return;
            sessionTimeout = setTimeout(async () => {
                if (auth.currentUser) {
                    alert('Session expired due to inactivity. Please login again.');
                    await auth.signOut();
                    localStorage.removeItem('authVerified');
                    window.location.href = 'main-menu.html';
                }
            }, 30 * 60 * 1000); // 30 minutes
        }

        // Reset timeout on user activity
        ['mousedown', 'keydown', 'scroll', 'touchstart'].forEach(event => {
            document.addEventListener(event, resetSessionTimeout, true);
        });

        // ========================================
        // SECTION NAVIGATION
        // ========================================

        // Show section and handle button states
        // Section titles and icons
        const sectionConfig = {
            settings: { title: 'Settings', icon: 'fa-cog', subtitle: 'Manage system configurations' },
            users: { title: 'User Management', icon: 'fa-users', subtitle: 'Manage users and permissions' },
            tools: { title: 'Tool Management', icon: 'fa-toolbox', subtitle: 'View and manage all tools' },
            analytics: { title: 'Analytics & Reports', icon: 'fa-chart-bar', subtitle: 'View system analytics and activity' },
            checkups: { title: 'Collection Checkups', icon: 'fa-clipboard-check', subtitle: 'Review checkup history' },
            activity: { title: 'Check User Activity', icon: 'fa-user-check', subtitle: 'Track tool usage and registration' }
        };

        // Ensure functions are available immediately
        console.log('Defining openSectionModal function...');

        // Open section in modal
        window.openSectionModal = function(sectionId) {
            console.log('openSectionModal called with:', sectionId);
            const modal = document.getElementById(sectionId + 'Modal');
            const content = document.getElementById(sectionId);
            const config = sectionConfig[sectionId];
            
            console.log('Modal element:', modal);
            console.log('Content element:', content);
            console.log('Config:', config);
            
            if (!modal || !content || !config) {
                console.error('Missing elements:', { modal, content, config });
                return;
            }
            
            // Create modal structure
            const modalContent = document.createElement('div');
            modalContent.className = 'section-modal-content';
            modalContent.innerHTML = `
                <div class="section-modal-header">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <h3 class="mb-0"><i class="fas ${config.icon}"></i> ${config.title}</h3>
                            <small>${config.subtitle}</small>
                        </div>
                        <button class="btn btn-light" onclick="closeSectionModal('${sectionId}Modal')">
                            <i class="fas fa-times"></i> Close
                        </button>
                    </div>
                </div>
                <div class="section-modal-body" id="${sectionId}ModalBody">
                </div>
            `;
            
            // Move the actual content into the modal
            const modalBody = modalContent.querySelector('.section-modal-body');
            modalBody.appendChild(content);
            content.style.display = 'block';
            
            // Append to modal
            modal.innerHTML = '';
            modal.appendChild(modalContent);
            
            // Show modal
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // Load data for specific sections
            if (sectionId === 'checkups') {
                setTimeout(() => loadCheckupUsers(), 100);
            } else if (sectionId === 'users') {
                setTimeout(() => loadUsers(), 100);
            } else if (sectionId === 'tools') {
                setTimeout(() => loadTools(), 100);
            } else if (sectionId === 'analytics') {
                setTimeout(() => loadAnalytics(), 100);
            } else if (sectionId === 'activity') {
                setTimeout(() => loadAllToolsForActivity(), 100);
            }
        };

        console.log('openSectionModal function defined successfully');

        // Close section modal
        window.closeSectionModal = function(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            
            const sectionId = modalId.replace('Modal', '');
            const content = document.getElementById(sectionId);
            const hiddenContainer = document.getElementById('adminSectionsContent');
            
            // Move content back to hidden container
            if (content && hiddenContainer) {
                hiddenContainer.appendChild(content);
            }
            
            modal.classList.remove('active');
            document.body.style.overflow = '';
            
            // Clear modal content after animation
            setTimeout(() => {
                modal.innerHTML = '';
            }, 300);
        };

        // Close modal on background click
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('section-modal')) {
                closeSectionModal(e.target.id);
            }
        });

        // Close modal on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                document.querySelectorAll('.section-modal.active').forEach(modal => {
                    closeSectionModal(modal.id);
                });
            }
        });

        // Load all tools for activity dropdown
        async function loadAllToolsForActivity() {
            const db = window.db || firebase.firestore();
            if (allToolsForActivity.length > 0) return; // Already loaded

            try {
                const toolsSnapshot = await db.collection('tools').get();
                allToolsForActivity = [];
                
                toolsSnapshot.forEach(doc => {
                    allToolsForActivity.push({
                        id: doc.id,
                        toolName: doc.data().toolName || 'Unknown Tool',
                        partNumber: doc.data().partNumber || '',
                        owner: doc.data().collectionName || 'Unknown',
                        status: doc.data().status || 'Unknown'
                    });
                });

                // Sort by tool ID
                allToolsForActivity.sort((a, b) => a.id.toLowerCase().localeCompare(b.id.toLowerCase()));
            } catch (error) {
                console.error('Error loading tools for activity:', error);
            }
        }

        // ========================================
        // CHECKUPS MANAGEMENT FUNCTIONALITY
        // ========================================

        let allCheckupData = [];
        let filteredCheckupData = [];
        let selectedCheckupIds = new Set();
        let currentSelectedUser = null;
        let currentSelectedCollection = null;

        // Load all users (showing those without checkups as disabled)
        async function loadCheckupUsers() {
            const db = window.db || firebase.firestore();
            const loading = document.getElementById('checkupUsersLoading');
            const usersList = document.getElementById('checkupUsersList');
            
            try {
                loading.style.display = 'block';
                usersList.innerHTML = '';

                // Get all checkup results
                const checkupsSnapshot = await db.collection('checkupResults').get();
                
                // Group by technician name and count checkups
                const userCheckupCounts = {};
                checkupsSnapshot.forEach(doc => {
                    const data = doc.data();
                    const techName = data.technician || 'Unknown';
                    userCheckupCounts[techName] = (userCheckupCounts[techName] || 0) + 1;
                });

                // Get all technicians from the technicians collection
                const techniciansSnapshot = await db.collection('technicians').get();
                const usersWithCheckups = [];
                const usersWithoutCheckups = [];
                
                techniciansSnapshot.forEach(doc => {
                    const userData = doc.data();
                    const userName = userData.fullName || userData.email || 'Unknown';
                    const checkupCount = userCheckupCounts[userName] || 0;
                    
                    const userObj = {
                        name: userName,
                        checkupCount: checkupCount,
                        hasCheckups: checkupCount > 0
                    };

                    if (checkupCount > 0) {
                        usersWithCheckups.push(userObj);
                    } else {
                        usersWithoutCheckups.push(userObj);
                    }
                });

                // Sort both groups alphabetically
                usersWithCheckups.sort((a, b) => a.name.toLowerCase().localeCompare(b.name.toLowerCase()));
                usersWithoutCheckups.sort((a, b) => a.name.toLowerCase().localeCompare(b.name.toLowerCase()));

                if (usersWithCheckups.length === 0 && usersWithoutCheckups.length === 0) {
                    usersList.innerHTML = '<p class="text-muted text-center">No users found in the system.</p>';
                } else {
                    let currentNumber = 1;

                    // Group 1: Users WITH checkups
                    if (usersWithCheckups.length > 0) {
                        // Add group header
                        const groupHeader1 = document.createElement('div');
                        groupHeader1.style.cssText = 'background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 12px 20px; border-radius: 10px; margin-bottom: 15px; font-weight: bold; font-size: 1.1rem; box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);';
                        groupHeader1.innerHTML = `
                            <i class="fas fa-check-circle"></i> Active Users (${usersWithCheckups.length})
                            <span style="float: right; font-size: 0.9rem; opacity: 0.9;">Has performed checkups</span>
                        `;
                        usersList.appendChild(groupHeader1);

                        usersWithCheckups.forEach((user) => {
                            const userItem = document.createElement('div');
                            userItem.className = 'user-list-item';
                            userItem.onclick = () => selectCheckupUser(user.name);
                            
                            userItem.innerHTML = `
                                <div class="user-number">${currentNumber}</div>
                                <div class="user-info">
                                    <div class="user-name">${user.name}</div>
                                    <div class="user-checkup-count">${user.checkupCount} checkup${user.checkupCount !== 1 ? 's' : ''}</div>
                                </div>
                                <div class="user-arrow">
                                    <i class="fas fa-chevron-right"></i>
                                </div>
                            `;
                            usersList.appendChild(userItem);
                            currentNumber++;
                        });
                    }

                    // Group 2: Users WITHOUT checkups
                    if (usersWithoutCheckups.length > 0) {
                        // Add spacing and group header
                        const spacer = document.createElement('div');
                        spacer.style.height = '30px';
                        usersList.appendChild(spacer);

                        const groupHeader2 = document.createElement('div');
                        groupHeader2.style.cssText = 'background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%); color: white; padding: 12px 20px; border-radius: 10px; margin-bottom: 15px; font-weight: bold; font-size: 1.1rem; box-shadow: 0 2px 8px rgba(108, 117, 125, 0.3);';
                        groupHeader2.innerHTML = `
                            <i class="fas fa-user-times"></i> Inactive Users (${usersWithoutCheckups.length})
                            <span style="float: right; font-size: 0.9rem; opacity: 0.9;">No checkups performed yet</span>
                        `;
                        usersList.appendChild(groupHeader2);

                        usersWithoutCheckups.forEach((user) => {
                            const userItem = document.createElement('div');
                            userItem.className = 'user-list-item';
                            userItem.style.opacity = '0.5';
                            userItem.style.cursor = 'not-allowed';
                            userItem.style.borderLeftColor = '#ccc';
                            
                            userItem.innerHTML = `
                                <div class="user-number" style="background: #ccc;">${currentNumber}</div>
                                <div class="user-info">
                                    <div class="user-name">${user.name}</div>
                                    <div class="user-checkup-count">0 checkups</div>
                                </div>
                                <div class="user-arrow" style="color: #ccc;">
                                    <i class="fas fa-ban"></i>
                                </div>
                            `;
                            usersList.appendChild(userItem);
                            currentNumber++;
                        });
                    }
                }

                loading.style.display = 'none';
            } catch (error) {
                console.error('Error loading checkup users:', error);
                usersList.innerHTML = '<p class="text-danger text-center">Error loading users</p>';
                loading.style.display = 'none';
            }
        }

        // User search functionality
        document.getElementById('checkupUserSearch').addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const userItems = document.querySelectorAll('#checkupUsersList .user-list-item');
            userItems.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(searchTerm) ? 'flex' : 'none';
            });
        });

        // Select a user and load all their checkups
        window.selectCheckupUser = async function(userName) {
            currentSelectedUser = userName;
            currentSelectedCollection = 'All'; // Show all collections
            
            // Update header
            document.getElementById('selectedCollectionName').textContent = `All Checkups for ${userName}`;
            
            // Hide step 1, show step 3 directly
            document.getElementById('checkupStep1').style.display = 'none';
            document.getElementById('checkupStep2').style.display = 'none';
            document.getElementById('checkupStep3').style.display = 'block';

            // Load all checkup history for this user
            await loadCheckupHistoryForUser(userName);
        };

        // Reset to user selection
        window.resetCheckupSelection = function() {
            currentSelectedUser = null;
            currentSelectedCollection = null;
            document.getElementById('checkupStep1').style.display = 'block';
            document.getElementById('checkupStep2').style.display = 'none';
            document.getElementById('checkupStep3').style.display = 'none';
            document.getElementById('checkupUserSearch').value = '';
        };

        // Back to user list (renamed from backToCollections)
        window.backToCollections = function() {
            resetCheckupSelection();
        };

        // Select a collection and show checkup history
        window.selectCheckupCollection = async function(collectionName) {
            currentSelectedCollection = collectionName;
            document.getElementById('selectedCollectionName').textContent = collectionName;
            
            // Hide step 2, show step 3
            document.getElementById('checkupStep2').style.display = 'none';
            document.getElementById('checkupStep3').style.display = 'block';

            // Load checkup history
            await loadCheckupHistory();
        };

        // Load checkup history for a user (all collections)
        async function loadCheckupHistoryForUser(userName) {
            const db = window.db || firebase.firestore();
            const loading = document.getElementById('checkupHistoryLoading');
            const tableContainer = document.getElementById('checkupHistoryTableContainer');
            const noMessage = document.getElementById('noCheckupsMessage');
            
            try {
                loading.style.display = 'block';
                tableContainer.style.display = 'none';
                noMessage.style.display = 'none';

                // Get all checkups for this user (all collections)
                const checkupsSnapshot = await db.collection('checkupResults')
                    .where('technician', '==', userName)
                    .get();

                allCheckupData = [];
                checkupsSnapshot.forEach(doc => {
                    allCheckupData.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                // Sort by timestamp (newest first)
                allCheckupData.sort((a, b) => {
                    const timeA = a.timestamp ? a.timestamp.toDate() : new Date(0);
                    const timeB = b.timestamp ? b.timestamp.toDate() : new Date(0);
                    return timeB - timeA;
                });

                // Initially show all
                filteredCheckupData = [...allCheckupData];
                renderCheckupHistory();

                loading.style.display = 'none';
            } catch (error) {
                console.error('Error loading checkup history:', error);
                loading.style.display = 'none';
                alert('Error loading checkup history: ' + error.message);
            }
        }

        // Load checkup history for selected user and collection
        async function loadCheckupHistory() {
            const db = window.db || firebase.firestore();
            const loading = document.getElementById('checkupHistoryLoading');
            const tableContainer = document.getElementById('checkupHistoryTableContainer');
            const noMessage = document.getElementById('noCheckupsMessage');
            
            try {
                loading.style.display = 'block';
                tableContainer.style.display = 'none';
                noMessage.style.display = 'none';

                // Get all checkups for this user and collection
                const checkupsSnapshot = await db.collection('checkupResults')
                    .where('technician', '==', currentSelectedUser)
                    .where('collectionCode', '==', currentSelectedCollection)
                    .get();

                allCheckupData = [];
                checkupsSnapshot.forEach(doc => {
                    allCheckupData.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                // Sort by timestamp (newest first)
                allCheckupData.sort((a, b) => {
                    const timeA = a.timestamp ? a.timestamp.toDate() : new Date(0);
                    const timeB = b.timestamp ? b.timestamp.toDate() : new Date(0);
                    return timeB - timeA;
                });

                // Initially show all
                filteredCheckupData = [...allCheckupData];
                renderCheckupHistory();

                loading.style.display = 'none';
            } catch (error) {
                console.error('Error loading checkup history:', error);
                loading.style.display = 'none';
                alert('Error loading checkup history: ' + error.message);
            }
        }

        // Filter checkups by time period
        window.filterCheckups = function(period) {
            const now = new Date();
            let startDate;

            switch (period) {
                case 'today':
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    break;
                case 'week':
                    startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    break;
                case 'month':
                    startDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                    break;
                case 'year':
                    startDate = new Date(now.getTime() - 365 * 24 * 60 * 60 * 1000);
                    break;
                case 'all':
                default:
                    filteredCheckupData = [...allCheckupData];
                    renderCheckupHistory();
                    return;
            }

            filteredCheckupData = allCheckupData.filter(checkup => {
                const checkupDate = checkup.timestamp ? checkup.timestamp.toDate() : new Date(0);
                return checkupDate >= startDate;
            });

            renderCheckupHistory();
        };

        // Render checkup history table
        function renderCheckupHistory() {
            const tableBody = document.getElementById('checkupHistoryTableBody');
            const tableContainer = document.getElementById('checkupHistoryTableContainer');
            const noMessage = document.getElementById('noCheckupsMessage');
            
            selectedCheckupIds.clear();
            document.getElementById('selectAllCheckups').checked = false;
            updateDeleteButton();

            if (filteredCheckupData.length === 0) {
                tableContainer.style.display = 'none';
                noMessage.style.display = 'block';
                updateAnalytics([]);
                return;
            }

            tableContainer.style.display = 'block';
            noMessage.style.display = 'none';
            tableBody.innerHTML = '';

            filteredCheckupData.forEach(checkup => {
                const completionPercent = checkup.totalTools > 0 
                    ? Math.round((checkup.checkedTools / checkup.totalTools) * 100) 
                    : 0;
                
                const dateStr = checkup.timestamp 
                    ? checkup.timestamp.toDate().toLocaleString('en-GB')
                    : checkup.checkupDate || 'Unknown';

                const collectionName = checkup.collectionCode || 'Unknown';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <input type="checkbox" class="checkup-checkbox" data-id="${checkup.id}" onchange="updateDeleteButton()">
                    </td>
                    <td>${dateStr}</td>
                    <td><span style="color: #667eea; font-weight: bold;">${collectionName}</span></td>
                    <td>${checkup.totalTools || 0}</td>
                    <td><span style="color: #28a745; font-weight: bold;">${checkup.checkedTools || 0}</span></td>
                    <td><span style="color: #dc3545; font-weight: bold;">${checkup.uncheckedTools || 0}</span></td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="flex: 1; background: #e0e0e0; border-radius: 10px; height: 20px; overflow: hidden;">
                                <div style="background: ${completionPercent >= 80 ? '#28a745' : completionPercent >= 50 ? '#ff9800' : '#dc3545'}; height: 100%; width: ${completionPercent}%; transition: width 0.3s ease;"></div>
                            </div>
                            <span style="font-weight: bold; min-width: 45px;">${completionPercent}%</span>
                        </div>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="viewCheckupDetails('${checkup.id}')">
                            <i class="fas fa-eye"></i> View
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteSingleCheckup('${checkup.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            updateAnalytics(filteredCheckupData);
        }

        // Update analytics summary
        function updateAnalytics(data) {
            if (data.length === 0) {
                document.getElementById('totalCheckups').textContent = '0';
                document.getElementById('avgCompletion').textContent = '0%';
                document.getElementById('avgToolsChecked').textContent = '0';
                document.getElementById('lastCheckupDate').textContent = 'N/A';
                return;
            }

            // Total checkups
            document.getElementById('totalCheckups').textContent = data.length;

            // Average completion
            const avgCompletion = data.reduce((sum, c) => {
                const percent = c.totalTools > 0 ? (c.checkedTools / c.totalTools) * 100 : 0;
                return sum + percent;
            }, 0) / data.length;
            document.getElementById('avgCompletion').textContent = Math.round(avgCompletion) + '%';

            // Average tools checked
            const avgToolsChecked = data.reduce((sum, c) => sum + (c.checkedTools || 0), 0) / data.length;
            document.getElementById('avgToolsChecked').textContent = Math.round(avgToolsChecked);

            // Last checkup date
            const lastCheckup = data[0]; // Already sorted by newest first
            const lastDate = lastCheckup.timestamp 
                ? lastCheckup.timestamp.toDate().toLocaleDateString('en-GB')
                : lastCheckup.checkupDate || 'Unknown';
            document.getElementById('lastCheckupDate').textContent = lastDate;
        }

        // Toggle select all checkups
        window.toggleSelectAllCheckups = function() {
            const selectAll = document.getElementById('selectAllCheckups').checked;
            const checkboxes = document.querySelectorAll('.checkup-checkbox');
            
            selectedCheckupIds.clear();
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll;
                if (selectAll) {
                    selectedCheckupIds.add(checkbox.dataset.id);
                }
            });
            
            updateDeleteButton();
        };

        // Update delete button state
        function updateDeleteButton() {
            selectedCheckupIds.clear();
            document.querySelectorAll('.checkup-checkbox:checked').forEach(checkbox => {
                selectedCheckupIds.add(checkbox.dataset.id);
            });
            
            const deleteBtn = document.getElementById('deleteSelectedCheckupsBtn');
            const count = selectedCheckupIds.size;
            document.getElementById('selectedCheckupsCount').textContent = count;
            deleteBtn.disabled = count === 0;
        }

        // Delete selected checkups
        window.deleteSelectedCheckups = async function() {
            if (selectedCheckupIds.size === 0) return;

            const confirmMsg = `Are you sure you want to delete ${selectedCheckupIds.size} checkup(s)?\n\nThis action cannot be undone!`;
            if (!confirm(confirmMsg)) return;

            try {
                const deletePromises = Array.from(selectedCheckupIds).map(id => 
                    db.collection('checkupResults').doc(id).delete()
                );
                
                await Promise.all(deletePromises);
                
                alert(` Successfully deleted ${selectedCheckupIds.size} checkup(s)!`);
                
                // Reload checkup history
                await loadCheckupHistory();
            } catch (error) {
                console.error('Error deleting checkups:', error);
                alert('Error deleting checkups: ' + error.message);
            }
        };

        // Delete single checkup
        window.deleteSingleCheckup = async function(checkupId) {
            if (!confirm('Are you sure you want to delete this checkup?\n\nThis action cannot be undone!')) {
                return;
            }

            try {
                await db.collection('checkupResults').doc(checkupId).delete();
                alert(' Checkup deleted successfully!');
                await loadCheckupHistory();
            } catch (error) {
                console.error('Error deleting checkup:', error);
                alert('Error deleting checkup: ' + error.message);
            }
        };

        // View checkup details
        window.viewCheckupDetails = async function(checkupId) {
            const checkup = allCheckupData.find(c => c.id === checkupId);
            if (!checkup) {
                alert('Checkup not found.');
                return;
            }

            const modalBody = document.getElementById('checkupDetailsModalBody');
            modalBody.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div><p>Loading details...</p></div>';
            
            const modal = new bootstrap.Modal(document.getElementById('checkupDetailsModal'));
            modal.show();

            try {
                const dateStr = checkup.timestamp 
                    ? checkup.timestamp.toDate().toLocaleString('en-GB')
                    : checkup.checkupDate || 'Unknown';

                const completionPercent = checkup.totalTools > 0 
                    ? Math.round((checkup.checkedTools / checkup.totalTools) * 100) 
                    : 0;

                let detailsHTML = `
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6><i class="fas fa-user"></i> Technician:</h6>
                            <p style="font-size: 1.1rem; font-weight: bold;">${checkup.technician || 'Unknown'}</p>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-calendar"></i> Date & Time:</h6>
                            <p style="font-size: 1.1rem; font-weight: bold;">${dateStr}</p>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="text-center p-3" style="background: #f8f9fa; border-radius: 10px;">
                                <h6>Total Tools</h6>
                                <h3 style="color: #667eea;">${checkup.totalTools || 0}</h3>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-3" style="background: #f8f9fa; border-radius: 10px;">
                                <h6>Checked</h6>
                                <h3 style="color: #28a745;">${checkup.checkedTools || 0}</h3>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-3" style="background: #f8f9fa; border-radius: 10px;">
                                <h6>Unchecked</h6>
                                <h3 style="color: #dc3545;">${checkup.uncheckedTools || 0}</h3>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-3" style="background: #f8f9fa; border-radius: 10px;">
                                <h6>Completion</h6>
                                <h3 style="color: ${completionPercent >= 80 ? '#28a745' : completionPercent >= 50 ? '#ff9800' : '#dc3545'};">${completionPercent}%</h3>
                            </div>
                        </div>
                    </div>
                `;

                // Location stats
                if (checkup.locationStats && Object.keys(checkup.locationStats).length > 0) {
                    detailsHTML += `
                        <h6 class="mt-4 mb-3"><i class="fas fa-map-marker-alt"></i> Location Statistics:</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead style="background: #667eea; color: white;">
                                    <tr>
                                        <th>Location</th>
                                        <th>Total Tools</th>
                                        <th>Checked</th>
                                        <th>Unchecked</th>
                                        <th>Completion %</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;

                    Object.entries(checkup.locationStats).forEach(([location, stats]) => {
                        const locCompletion = stats.total > 0 ? Math.round((stats.checked / stats.total) * 100) : 0;
                        detailsHTML += `
                            <tr>
                                <td><strong>${location}</strong></td>
                                <td>${stats.total}</td>
                                <td style="color: #28a745; font-weight: bold;">${stats.checked}</td>
                                <td style="color: #dc3545; font-weight: bold;">${stats.unchecked}</td>
                                <td>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <div style="flex: 1; background: #e0e0e0; border-radius: 10px; height: 15px; overflow: hidden;">
                                            <div style="background: ${locCompletion >= 80 ? '#28a745' : locCompletion >= 50 ? '#ff9800' : '#dc3545'}; height: 100%; width: ${locCompletion}%;"></div>
                                        </div>
                                        <span style="font-weight: bold; min-width: 40px;">${locCompletion}%</span>
                                    </div>
                                </td>
                            </tr>
                        `;
                    });

                    detailsHTML += `
                                </tbody>
                            </table>
                        </div>
                    `;
                }

                // Unchecked tools list
                if (checkup.uncheckedTools > 0 && checkup.allToolIds && checkup.checkedToolIds) {
                    const uncheckedIds = checkup.allToolIds.filter(id => !checkup.checkedToolIds.includes(id));
                    
                    if (uncheckedIds.length > 0) {
                        detailsHTML += `
                            <h6 class="mt-4 mb-3"><i class="fas fa-exclamation-triangle text-warning"></i> Unchecked Tools (${uncheckedIds.length}):</h6>
                            <div style="max-height: 300px; overflow-y: auto; background: #f8f9fa; padding: 15px; border-radius: 10px;">
                        `;

                        // Fetch tool details
                        const toolDetails = [];
                        for (let i = 0; i < uncheckedIds.length; i += 10) {
                            const batch = uncheckedIds.slice(i, i + 10);
                            const snapshot = await db.collection('tools')
                                .where(firebase.firestore.FieldPath.documentId(), 'in', batch)
                                .get();
                            snapshot.forEach(doc => {
                                toolDetails.push({ id: doc.id, ...doc.data() });
                            });
                        }

                        toolDetails.forEach(tool => {
                            detailsHTML += `
                                <div style="padding: 10px; margin-bottom: 10px; background: white; border-radius: 8px; border-left: 4px solid #dc3545;">
                                    <strong>${tool.toolName || 'Unknown Tool'}</strong><br>
                                    <small style="color: #666;">
                                        TID: ${tool.id} | P/N: ${tool.partNumber || 'N/A'} | Location: ${tool.location || 'N/A'}
                                    </small>
                                </div>
                            `;
                        });

                        detailsHTML += `</div>`;
                    }
                }

                modalBody.innerHTML = detailsHTML;
            } catch (error) {
                console.error('Error loading checkup details:', error);
                modalBody.innerHTML = '<p class="text-danger">Error loading details: ' + error.message + '</p>';
            }
        };

        // ========================================
        // USER ACTIVITY CHECKER FUNCTIONALITY
        // ========================================

        let activityQrCodeScanner = null;
        let allToolsForActivity = []; // Cache all tools for dropdown

        // Toggle QR Scanner
        window.toggleActivityScanner = async function() {
            const qrReaderDiv = document.getElementById('activityQrReader');
            const scanBtn = document.getElementById('activityScanBtn');

            if (qrReaderDiv.style.display === 'none') {
                // Show and start scanner
                qrReaderDiv.style.display = 'block';
                scanBtn.innerHTML = '<i class="fas fa-qrcode"></i> Scanning...';
                scanBtn.disabled = true;

                try {
                    activityQrCodeScanner = new Html5Qrcode("activityQrReaderElement");
                    
                    await activityQrCodeScanner.start(
                        { facingMode: "environment" },
                        {
                            fps: 10,
                            qrbox: { width: 250, height: 250 }
                        },
                        (decodedText) => {
                            // On scan success
                            document.getElementById('activityToolSearch').value = decodedText;
                            document.getElementById('activityDropdown').style.display = 'none';
                            stopActivityScanner();
                            searchToolActivity();
                        },
                        (errorMessage) => {
                            // Scan error (can be ignored)
                        }
                    );
                } catch (error) {
                    console.error('Error starting scanner:', error);
                    alert('Error starting camera: ' + error.message);
                    stopActivityScanner();
                }
            } else {
                stopActivityScanner();
            }
        };

        // Stop QR Scanner
        window.stopActivityScanner = function() {
            const qrReaderDiv = document.getElementById('activityQrReader');
            const scanBtn = document.getElementById('activityScanBtn');

            if (activityQrCodeScanner) {
                activityQrCodeScanner.stop().then(() => {
                    activityQrCodeScanner.clear();
                    activityQrCodeScanner = null;
                }).catch(err => {
                    console.error('Error stopping scanner:', err);
                });
            }

            qrReaderDiv.style.display = 'none';
            scanBtn.innerHTML = '<i class="fas fa-qrcode"></i> Scan QR';
            scanBtn.disabled = false;
        };

        // Search for tool activity
        window.searchToolActivity = async function() {
            const db = window.db || firebase.firestore();
            const searchInput = document.getElementById('activityToolSearch');
            const toolCode = searchInput.value.trim();
            const resultsDiv = document.getElementById('activityResults');

            if (!toolCode) {
                alert('Please enter a tool code or scan a QR code');
                return;
            }

            // Show loading
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = `
                <div class="text-center" style="padding: 40px;">
                    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p style="margin-top: 20px; font-size: 1.1rem;">Searching for tool: <strong>${toolCode}</strong></p>
                </div>
            `;

            try {
                // Search for the tool (case-insensitive)
                const db = window.db || firebase.firestore();
                const toolsSnapshot = await db.collection('tools').get();
                let foundTool = null;

                // Find tool with case-insensitive match
                toolsSnapshot.forEach(doc => {
                    if (doc.id.toLowerCase() === toolCode.toLowerCase()) {
                        foundTool = { id: doc.id, ...doc.data() };
                    }
                });

                if (!foundTool) {
                    // Tool not found
                    resultsDiv.innerHTML = `
                        <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 12px; padding: 30px; text-align: center;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #ffc107; margin-bottom: 15px;"></i>
                            <h4 style="color: #856404;">Tool Not Found</h4>
                            <p style="color: #856404; font-size: 1.1rem;">
                                No tool found with code: <strong>${toolCode}</strong>
                            </p>
                            <p style="color: #666;">Please check the code and try again.</p>
                        </div>
                    `;
                    return;
                }

                // Get the most recent log entry for this tool
                const logsSnapshot = await db.collection('logtoolmovements')
                    .where('toolId', '==', foundTool.id)
                    .orderBy('timestamp', 'desc')
                    .limit(1)
                    .get();

                let lastActivity = null;
                if (!logsSnapshot.empty) {
                    lastActivity = logsSnapshot.docs[0].data();
                }

                // Determine current owner
                const currentOwner = foundTool.collectionName || 'Unknown';
                const currentStatus = foundTool.status || 'Unknown';
                const registeredAt = foundTool.registeredAt ? foundTool.registeredAt.toDate().toLocaleString('en-GB') : 'Unknown';
                const lastUser = lastActivity ? lastActivity.technician : 'N/A';
                const lastActionTime = lastActivity && lastActivity.timestamp ? lastActivity.timestamp.toDate().toLocaleString('en-GB') : 'N/A';
                const lastAction = lastActivity ? lastActivity.status : 'N/A';
                const workLocation = foundTool.WorkOn || 'N/A';

                // Build result HTML
                let statusColor = currentStatus === 'IN' ? '#28a745' : currentStatus === 'OUT' ? '#dc3545' : '#6c757d';
                let statusIcon = currentStatus === 'IN' ? 'fa-check-circle' : currentStatus === 'OUT' ? 'fa-sign-out-alt' : 'fa-question-circle';

                resultsDiv.innerHTML = `
                    <div style="background: white; border: 3px solid ${statusColor}; border-radius: 15px; padding: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        <!-- Tool Header -->
                        <div style="text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #e0e0e0;">
                            <i class="fas fa-tools" style="font-size: 3rem; color: #667eea; margin-bottom: 15px;"></i>
                            <h3 style="margin: 0; color: #333;">${foundTool.toolName || 'Unknown Tool'}</h3>
                            <p style="color: #666; font-size: 1.1rem; margin: 5px 0;">
                                <strong>TID:</strong> ${foundTool.id}
                            </p>
                            <div style="display: inline-block; background: ${statusColor}; color: white; padding: 8px 20px; border-radius: 20px; font-weight: bold; font-size: 1.1rem; margin-top: 10px;">
                                <i class="fas ${statusIcon}"></i> ${currentStatus}
                            </div>
                        </div>

                        <!-- Tool Information Grid -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; height: 100%;">
                                    <h5 style="color: #667eea; margin-bottom: 15px;">
                                        <i class="fas fa-user"></i> Current Owner
                                    </h5>
                                    <p style="font-size: 1.2rem; font-weight: bold; color: #333; margin: 0;">
                                        ${currentOwner}
                                    </p>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; height: 100%;">
                                    <h5 style="color: #667eea; margin-bottom: 15px;">
                                        <i class="fas fa-map-marker-alt"></i> Work Location
                                    </h5>
                                    <p style="font-size: 1.2rem; font-weight: bold; color: #333; margin: 0;">
                                        ${workLocation}
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Registration Details -->
                        <div style="background: #e3f2fd; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                            <h5 style="color: #1976d2; margin-bottom: 15px;">
                                <i class="fas fa-calendar-plus"></i> Registration Information
                            </h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <p style="margin: 5px 0;">
                                        <strong>Registered On:</strong> ${registeredAt}
                                    </p>
                                </div>
                                <div class="col-md-6">
                                    <p style="margin: 5px 0;">
                                        <strong>Part Number:</strong> ${foundTool.partNumber || 'N/A'}
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Last Activity -->
                        <div style="background: #fff3e0; padding: 20px; border-radius: 10px;">
                            <h5 style="color: #f57c00; margin-bottom: 15px;">
                                <i class="fas fa-history"></i> Last Activity
                            </h5>
                            <div class="row">
                                <div class="col-md-4">
                                    <p style="margin: 5px 0;">
                                        <strong>Last User:</strong><br>
                                        <span style="color: #333; font-size: 1.1rem;">${lastUser}</span>
                                    </p>
                                </div>
                                <div class="col-md-4">
                                    <p style="margin: 5px 0;">
                                        <strong>Last Action:</strong><br>
                                        <span style="color: ${lastAction === 'IN' ? '#28a745' : '#dc3545'}; font-size: 1.1rem; font-weight: bold;">${lastAction}</span>
                                    </p>
                                </div>
                                <div class="col-md-4">
                                    <p style="margin: 5px 0;">
                                        <strong>Action Time:</strong><br>
                                        <span style="color: #333; font-size: 1.1rem;">${lastActionTime}</span>
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Additional Details -->
                        ${foundTool.location ? `
                            <div style="margin-top: 20px; padding: 15px; background: #f1f8e9; border-left: 4px solid #8bc34a; border-radius: 8px;">
                                <p style="margin: 0;">
                                    <i class="fas fa-map-pin"></i> <strong>Storage Location:</strong> ${foundTool.location}
                                </p>
                            </div>
                        ` : ''}

                        <!-- Action Buttons -->
                        <div style="margin-top: 30px; text-align: center; display: flex; gap: 15px; justify-content: center;">
                            <button class="btn btn-primary btn-lg" onclick="viewToolHistory('${foundTool.id}')">
                                <i class="fas fa-history"></i> View Full History
                            </button>
                            <button class="btn btn-secondary btn-lg" onclick="clearActivityResults()">
                                <i class="fas fa-search"></i> Search Another Tool
                            </button>
                        </div>
                    </div>
                `;

            } catch (error) {
                console.error('Error searching for tool:', error);
                resultsDiv.innerHTML = `
                    <div style="background: #f8d7da; border: 2px solid #dc3545; border-radius: 12px; padding: 30px; text-align: center;">
                        <i class="fas fa-exclamation-circle" style="font-size: 3rem; color: #dc3545; margin-bottom: 15px;"></i>
                        <h4 style="color: #721c24;">Error</h4>
                        <p style="color: #721c24;">An error occurred while searching for the tool.</p>
                        <p style="color: #666;">${error.message}</p>
                    </div>
                `;
            }
        };

        // Clear activity results
        window.clearActivityResults = function() {
            document.getElementById('activityResults').style.display = 'none';
            document.getElementById('activityToolSearch').value = '';
            document.getElementById('activityToolSearch').focus();
        };

        // View tool history (shows all log entries)
        window.viewToolHistory = async function(toolId) {
            const db = window.db || firebase.firestore();
            const resultsDiv = document.getElementById('activityResults');
            
            resultsDiv.innerHTML = `
                <div class="text-center" style="padding: 40px;">
                    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
                    <p style="margin-top: 20px;">Loading tool history...</p>
                </div>
            `;

            try {
                const logsSnapshot = await db.collection('logtoolmovements')
                    .where('toolId', '==', toolId)
                    .orderBy('timestamp', 'desc')
                    .limit(20)
                    .get();

                let historyHTML = `
                    <div style="background: white; border: 3px solid #667eea; border-radius: 15px; padding: 30px;">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <h4><i class="fas fa-history"></i> Tool Activity History - ${toolId}</h4>
                            <button class="btn btn-secondary" onclick="searchToolActivity()">
                                <i class="fas fa-arrow-left"></i> Back to Tool Details
                            </button>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead style="background: #667eea; color: white;">
                                    <tr>
                                        <th>Date & Time</th>
                                        <th>User</th>
                                        <th>Action</th>
                                        <th>Work Location</th>
                                        <th>Tool Location</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;

                if (logsSnapshot.empty) {
                    historyHTML += `
                        <tr>
                            <td colspan="5" class="text-center text-muted">No activity history found</td>
                        </tr>
                    `;
                } else {
                    logsSnapshot.forEach(doc => {
                        const log = doc.data();
                        const timestamp = log.timestamp ? log.timestamp.toDate().toLocaleString('en-GB') : 'Unknown';
                        const statusColor = log.status === 'IN' ? '#28a745' : '#dc3545';
                        
                        historyHTML += `
                            <tr>
                                <td>${timestamp}</td>
                                <td><strong>${log.technician || 'Unknown'}</strong></td>
                                <td><span style="color: ${statusColor}; font-weight: bold;">${log.status || 'N/A'}</span></td>
                                <td>${log.WorkOn || 'N/A'}</td>
                                <td>${log.location || 'N/A'}</td>
                            </tr>
                        `;
                    });
                }

                historyHTML += `
                                </tbody>
                            </table>
                        </div>
                        <p class="text-muted text-center mt-3">
                            <i class="fas fa-info-circle"></i> Showing last 20 activities
                        </p>
                    </div>
                `;

                resultsDiv.innerHTML = historyHTML;

            } catch (error) {
                console.error('Error loading tool history:', error);
                resultsDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle"></i> Error loading history: ${error.message}
                    </div>
                `;
            }
        };

        // Show dropdown with tool suggestions
        function showActivityDropdown(searchTerm) {
            const dropdown = document.getElementById('activityDropdown');
            
            if (!searchTerm || searchTerm.length < 1) {
                dropdown.style.display = 'none';
                return;
            }

            // Filter tools based on search term (case-insensitive)
            const lowerSearch = searchTerm.toLowerCase();
            const matches = allToolsForActivity.filter(tool => 
                tool.id.toLowerCase().includes(lowerSearch) ||
                tool.toolName.toLowerCase().includes(lowerSearch) ||
                (tool.partNumber && tool.partNumber.toLowerCase().includes(lowerSearch))
            ).slice(0, 10); // Limit to 10 results

            if (matches.length === 0) {
                dropdown.innerHTML = '<div class="activity-dropdown-empty">No tools found matching "' + searchTerm + '"</div>';
                dropdown.style.display = 'block';
                return;
            }

            // Build dropdown HTML
            dropdown.innerHTML = matches.map(tool => {
                const statusColor = tool.status === 'IN' ? '#28a745' : tool.status === 'OUT' ? '#dc3545' : '#6c757d';
                const partNumberDisplay = tool.partNumber ? `P/N: ${tool.partNumber} | ` : '';
                return `
                    <div class="activity-dropdown-item" onclick="selectToolFromDropdown('${tool.id}')">
                        <div class="tool-id">${tool.id}</div>
                        <div class="tool-name">${tool.toolName}</div>
                        <div class="tool-owner">
                            ${partNumberDisplay}Owner: ${tool.owner} | 
                            <span style="color: ${statusColor}; font-weight: bold;">${tool.status}</span>
                        </div>
                    </div>
                `;
            }).join('');

            dropdown.style.display = 'block';
        }

        // Select tool from dropdown
        window.selectToolFromDropdown = function(toolId) {
            document.getElementById('activityToolSearch').value = toolId;
            document.getElementById('activityDropdown').style.display = 'none';
            searchToolActivity();
        };

        // Hide dropdown when clicking outside
        document.addEventListener('click', function(e) {
            const searchInput = document.getElementById('activityToolSearch');
            const dropdown = document.getElementById('activityDropdown');
            
            if (searchInput && dropdown && 
                e.target !== searchInput && 
                !dropdown.contains(e.target)) {
                dropdown.style.display = 'none';
            }
        });

        // Allow Enter key to trigger search and setup input listener
        document.addEventListener('DOMContentLoaded', function() {
            const activitySearch = document.getElementById('activityToolSearch');
            if (activitySearch) {
                // Enter key to search
                activitySearch.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        document.getElementById('activityDropdown').style.display = 'none';
                        searchToolActivity();
                    }
                });

                // Input event to show dropdown
                activitySearch.addEventListener('input', function(e) {
                    showActivityDropdown(e.target.value);
                });

                // Focus event to show dropdown if there's text
                activitySearch.addEventListener('focus', function(e) {
                    if (e.target.value) {
                        showActivityDropdown(e.target.value);
                    }
                });
            }
        });
        })();
    </script>
</body>
</html>


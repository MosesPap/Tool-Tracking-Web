<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <title>ToolScanner Menu - Tool Tracking</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/common.css">
    <style>
        /* Reset body and html margins for full-width title bars */
        body, html {
            margin: 0;
            padding: 0;
        }
        
        /* Full-width title bar styles */
        .full-width-title-bar {
            width: 100vw !important;
            margin-left: calc(50% - 50vw) !important;
            margin-right: calc(50% - 50vw) !important;
            margin-top: 0 !important;
        }
        
        /* Button styles - matching index.html */
        .btn-primary {
            background-color: #FF9800 !important;
            border-color: #FF9800 !important;
            color: white !important;
            font-weight: bold;
            border-radius: 24px !important;
            padding: 12px 24px !important;
            box-shadow: 0 4px 8px rgba(255, 152, 0, 0.3);
            transition: all 0.3s ease;
            border: none;
        }
        
        .btn-primary:hover {
            background-color: #F57C00 !important;
            border-color: #F57C00 !important;
            color: white !important;
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(255, 152, 0, 0.4);
        }
        
        .btn-primary:active {
            transform: translateY(-1px);
            box-shadow: 0 6px 12px rgba(255, 152, 0, 0.4);
        }
        
        .btn-warning {
            background-color: #FF9800 !important;
            border-color: #FF9800 !important;
            color: white !important;
            font-weight: bold;
            border-radius: 24px !important;
            padding: 12px 24px !important;
            box-shadow: 0 4px 8px rgba(255, 152, 0, 0.3);
            transition: all 0.3s ease;
            border: none;
        }
        
        .btn-warning:hover {
            background-color: #F57C00 !important;
            border-color: #F57C00 !important;
            color: white !important;
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(255, 152, 0, 0.4);
        }
        
        .btn-warning:active {
            transform: translateY(-1px);
            box-shadow: 0 6px 12px rgba(255, 152, 0, 0.4);
        }
        
        /* 3D Grey button styles for My Tools - darker than other buttons */
        #menuMyToolsBtn {
            background: linear-gradient(135deg, #9e9e9e 0%, #757575 100%) !important;
            border-color: #757575 !important;
            color: white !important;
            font-weight: bold;
            border-radius: 24px !important;
            padding: 12px 24px !important;
            box-shadow: 0 4px 8px rgba(117, 117, 117, 0.4),
                        inset 0 1px 0 rgba(255, 255, 255, 0.2),
                        inset 0 -1px 0 rgba(0, 0, 0, 0.2) !important;
            transition: all 0.3s ease;
            border: 2px solid #616161 !important;
            transform: perspective(1000px) rotateX(2deg);
        }
        
        #menuMyToolsBtn:hover {
            background: linear-gradient(135deg, #8e8e8e 0%, #616161 100%) !important;
            border-color: #616161 !important;
            color: white !important;
            transform: perspective(1000px) rotateX(0deg) translateY(-3px);
            box-shadow: 0 8px 16px rgba(117, 117, 117, 0.5),
                        inset 0 1px 0 rgba(255, 255, 255, 0.3),
                        inset 0 -1px 0 rgba(0, 0, 0, 0.3) !important;
        }
        
        #menuMyToolsBtn:active {
            transform: perspective(1000px) rotateX(2deg) translateY(-1px);
            box-shadow: 0 6px 12px rgba(117, 117, 117, 0.4),
                        inset 0 1px 0 rgba(255, 255, 255, 0.2),
                        inset 0 -1px 0 rgba(0, 0, 0, 0.2) !important;
        }
        
        /* 3D Grey button styles for Work Location */
        #menuWorkLocationBtn {
            background: linear-gradient(135deg, #9e9e9e 0%, #757575 100%) !important;
            border-color: #757575 !important;
            color: white !important;
            font-weight: bold;
            border-radius: 24px !important;
            padding: 12px 24px !important;
            box-shadow: 0 4px 8px rgba(117, 117, 117, 0.4),
                        inset 0 1px 0 rgba(255, 255, 255, 0.2),
                        inset 0 -1px 0 rgba(0, 0, 0, 0.2) !important;
            transition: all 0.3s ease;
            border: 2px solid #616161 !important;
            transform: perspective(1000px) rotateX(2deg);
        }
        
        #menuWorkLocationBtn:hover {
            background: linear-gradient(135deg, #8e8e8e 0%, #616161 100%) !important;
            border-color: #616161 !important;
            color: white !important;
            transform: perspective(1000px) rotateX(0deg) translateY(-3px);
            box-shadow: 0 8px 16px rgba(117, 117, 117, 0.5),
                        inset 0 1px 0 rgba(255, 255, 255, 0.3),
                        inset 0 -1px 0 rgba(0, 0, 0, 0.3) !important;
        }
        
        #menuWorkLocationBtn:active {
            transform: perspective(1000px) rotateX(2deg) translateY(-1px);
            box-shadow: 0 6px 12px rgba(117, 117, 117, 0.4),
                        inset 0 1px 0 rgba(255, 255, 255, 0.2),
                        inset 0 -1px 0 rgba(0, 0, 0, 0.2) !important;
        }
        
        /* Menu button container */
        .d-grid.col-6 {
            max-width: 85% !important;
            width: 85% !important;
            flex: 0 0 85% !important;
        }
        
        /* Increase font size and padding for all menu buttons */
        .btn {
            font-size: 1.5rem !important;
            padding: 16px 32px !important;
            min-height: 60px !important;
        }
        
        /* Increase icon size */
        .btn i {
            font-size: 1.3rem !important;
            margin-right: 8px !important;
        }
        
        @media (max-width: 768px) {
            .d-grid.col-6 {
                max-width: 100% !important;
                width: 100% !important;
                flex: 0 0 100% !important;
            }
        }
    </style>
</head>
<body>
    <!-- ToolScanner Menu Section -->
    <div id="toolScannerMenu">
        <!-- Orange Top Bar with Title and Settings -->
        <div class="full-width-title-bar" style="background: #FF9800; color: white; min-width: 100vw; padding: 10px 0 8px 0; position: relative; box-shadow: 0 2px 8px rgba(255,152,0,0.10); margin-bottom: 0.5rem; overflow: visible;">
            <h2 style="margin: 0 0 0 20px; font-size: 1.3rem; font-weight: bold; letter-spacing: 1px;">ToolScanner Menu</h2>
            <button id="settingsBtn" class="btn btn-link p-0" style="position: absolute; right: 18px; top: 50%; transform: translateY(-50%); font-size: 2rem; color: white; z-index: 2;" title="Settings">
                <i class="fas fa-cog" style="color: white;"></i>
            </button>
        </div>
        <div class="container py-4">
            <!-- Welcome Message -->
            <div style="margin: 8px 0 10px 0; text-align: left;">
                <span style="font-size: 1.5rem; color: #333; font-weight: bold;">Welcome, <span id="fullName" class="technician-name"></span></span>
            </div>
            <div class="d-grid gap-3 col-6 mx-auto">
                <button class="btn btn-success" id="menuRegisterBtn"><i class="fas fa-plus"></i> Register Tools</button>
                <button class="btn btn-danger" id="menuOutBtn"><i class="fas fa-sign-out-alt"></i> View OUT Tools</button>
                <button class="btn btn-warning" id="menuMyToolsBtn"><i class="fas fa-toolbox"></i> My Tools</button>
                <button class="btn" id="menuWorkLocationBtn"><i class="fas fa-map-marker-alt"></i> Tools by Work Location</button>
                <button class="btn btn-primary" id="menuDutyShiftsBtn"><i class="fas fa-calendar-alt"></i> Duty Shifts</button>
                <button class="btn btn-info" id="menuAdminBtn" style="display: none;"><i class="fas fa-user-shield"></i> Tool Administrator</button>
                <button class="btn btn-primary" id="menuTrainingQuestionsBtn" style="display: none;"><i class="fas fa-question-circle"></i> Create Training Questions</button>
                <button class="btn btn-secondary" id="menuLogoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>
        </div>
    </div>

    <!-- Admin Code Modal -->
    <div class="modal fade" id="adminCodeModal" tabindex="-1" aria-labelledby="adminCodeModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="adminCodeModalLabel">Enter Admin Code</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="adminCodeInput" class="form-label">Admin Code</label>
                        <input type="password" id="adminCodeInput" class="form-control mb-2" placeholder="Enter admin code">
                        <div id="adminCodeError" class="text-danger" style="display: none;"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="verifyAdminCodeBtn">Verify</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <!-- Common Firebase configuration and utilities -->
    <script src="js/common.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Wait for common.js to load and set window.auth
        // This ensures we use the same Firebase Auth instance across all pages
        function initializeMainMenu() {
            // Get auth and db from common.js (global instances)
            const auth = window.auth;
            const db = window.db;
            
            if (!auth || !db) {
                console.error('[MAIN-MENU] window.auth or window.db not available! Retrying in 100ms...');
                setTimeout(initializeMainMenu, 100);
                return;
            }
            
            console.log('[MAIN-MENU] ✓ Using global auth instance from common.js');
            console.log('[MAIN-MENU] ✓ Using global db instance from common.js');

            // Variables
            let previousOutToolsCount = 0;
            let previousOutToolsData = [];

            // Check authentication state
            console.log('[MAIN-MENU] Page loaded, checking auth state...');
            console.log('[MAIN-MENU] localStorage.authVerified:', localStorage.getItem('authVerified'));
            console.log('[MAIN-MENU] localStorage.fullName:', localStorage.getItem('fullName'));
            console.log('[MAIN-MENU] auth.currentUser (sync):', auth.currentUser ? auth.currentUser.email : 'null');
            
            auth.onAuthStateChanged(function(user) {
            console.log('[MAIN-MENU] onAuthStateChanged fired, user:', user ? user.email : 'null');
            console.log('[MAIN-MENU] user.emailVerified:', user ? user.emailVerified : 'N/A');
            
            if (user && !user.emailVerified) {
                // Force sign out if user is not verified
                console.log('[MAIN-MENU] User email not verified, signing out...');
                auth.signOut();
                window.location.href = 'index.html';
                return;
            }
            
            if (user) {
                console.log('[MAIN-MENU] User authenticated, setting authVerified flag');
                // User is logged in - set auth verification flag for seamless navigation
                localStorage.setItem('authVerified', 'true');
                console.log('[MAIN-MENU] authVerified flag set to true');
                
                // Fetch data and show menu
                console.log('[MAIN-MENU] Fetching technician data from Firestore...');
                db.collection('technicians').doc(user.uid)
                    .get()
                    .then(doc => {
                        console.log('[MAIN-MENU] Firestore doc exists:', doc.exists);
                        if (doc.exists) {
                            const technicianData = doc.data();
                            const name = technicianData.fullName || user.email;
                            localStorage.setItem('techniciansId', doc.id);
                            localStorage.setItem('fullName', name);
                            console.log('[MAIN-MENU] Stored fullName:', name);
                            console.log('[MAIN-MENU] Stored techniciansId:', doc.id);
                            document.getElementById('fullName').textContent = name;
                            
                            // Check if user is admin
                            if (technicianData.isAdmin) {
                                localStorage.setItem('isAdmin', 'true'); // Cache admin status for faster admin page load
                                const menuAdminBtn = document.getElementById('menuAdminBtn');
                                if (menuAdminBtn) {
                                    menuAdminBtn.style.display = 'block';
                                }
                            } else {
                                localStorage.removeItem('isAdmin'); // Clear cache if not admin
                            }
                            
                            // Check if user is instructor
                            if (technicianData.isInstructor) {
                                const menuTrainingQuestionsBtn = document.getElementById('menuTrainingQuestionsBtn');
                                if (menuTrainingQuestionsBtn) {
                                    menuTrainingQuestionsBtn.style.display = 'block';
                                }
                            }
                        } else {
                            console.log('[MAIN-MENU] Technician doc does not exist, using email');
                            document.getElementById('fullName').textContent = user.email;
                        }
                        console.log('[MAIN-MENU] Calling updatePreviousOutToolsCount()');
                        updatePreviousOutToolsCount();
                    }).catch(error => {
                        console.error('[MAIN-MENU] Error fetching technician data:', error);
                        document.getElementById('fullName').textContent = user.email;
                        updatePreviousOutToolsCount();
                    });
            } else {
                // User is not logged in - redirect to index.html
                console.log('[MAIN-MENU] No user found, redirecting to index.html');
                localStorage.removeItem('authVerified');
                localStorage.removeItem('fullName');
                window.location.href = 'index.html';
            }
        });

        // Update previous OUT tools count
        async function updatePreviousOutToolsCount() {
            try {
                const user = auth.currentUser;
                if (!user) return;

                const fullName = localStorage.getItem('fullName') || user.email;
                const techniciansId = localStorage.getItem('techniciansId') || user.uid;

                // Query for tools checked out by this technician that are still OUT
                // Note: Tools are saved with 'technician' field, not 'checkedOutBy'
                const outToolsSnapshot = await db.collection('tools')
                    .where('technician', '==', fullName)
                    .where('status', '==', 'OUT')
                    .get();

                if (!outToolsSnapshot.empty) {
                    // Calculate today's start time (midnight in local timezone)
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    console.log('[MAIN-MENU] Today start time (local):', today.toISOString());
                    console.log('[MAIN-MENU] Today start time (local date):', today.toDateString());
                    
                    // Filter tools from previous days (not today)
                    const previousTools = outToolsSnapshot.docs.filter(doc => {
                        const data = doc.data();
                        const timestamp = data.timestamp;
                        console.log('[MAIN-MENU] Tool', doc.id, 'timestamp:', timestamp, 'timestamp type:', typeof timestamp);
                        
                        if (timestamp) {
                            let toolDate;
                            // Handle Firestore Timestamp
                            if (timestamp.toDate && typeof timestamp.toDate === 'function') {
                                toolDate = timestamp.toDate();
                            } 
                            // Handle regular Date object
                            else if (timestamp instanceof Date) {
                                toolDate = timestamp;
                            }
                            // Handle timestamp number (milliseconds)
                            else if (typeof timestamp === 'number') {
                                toolDate = new Date(timestamp);
                            }
                            // Handle Firestore Timestamp-like object
                            else if (timestamp.seconds) {
                                toolDate = new Date(timestamp.seconds * 1000);
                            }
                            else {
                                console.log('[MAIN-MENU] Tool', doc.id, 'has unsupported timestamp format');
                                return false;
                            }
                            
                            // Compare dates in local timezone
                            const toolDateLocal = new Date(toolDate.getFullYear(), toolDate.getMonth(), toolDate.getDate());
                            const isPrevious = toolDateLocal < today;
                            console.log('[MAIN-MENU] Tool', doc.id, 'date (UTC):', toolDate.toISOString(), 'date (local):', toolDateLocal.toDateString(), 'isPrevious:', isPrevious);
                            return isPrevious;
                        }
                        console.log('[MAIN-MENU] Tool', doc.id, 'has no timestamp');
                        return false;
                    });
                    
                    console.log('[MAIN-MENU] Previous tools count:', previousTools.length);
                    
                    previousOutToolsCount = previousTools.length;
                    previousOutToolsData = previousTools.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));

                    // Update button text with previous OUT tools count
                    const menuOutBtn = document.getElementById('menuOutBtn');
                    if (menuOutBtn) {
                        menuOutBtn.innerHTML = `<i class="fas fa-sign-out-alt"></i> View OUT Tools (${previousOutToolsCount})`;
                        menuOutBtn.disabled = previousOutToolsCount === 0;
                    }
                } else {
                    previousOutToolsCount = 0;
                    previousOutToolsData = [];
                    const menuOutBtn = document.getElementById('menuOutBtn');
                    if (menuOutBtn) {
                        menuOutBtn.innerHTML = `<i class="fas fa-sign-out-alt"></i> View OUT Tools (0)`;
                        menuOutBtn.disabled = true;
                    }
                }
            } catch (error) {
                console.error('Error fetching previous OUT tools count:', error);
                previousOutToolsCount = 0;
                previousOutToolsData = [];
                const menuOutBtn = document.getElementById('menuOutBtn');
                if (menuOutBtn) {
                    menuOutBtn.innerHTML = `<i class="fas fa-sign-out-alt"></i> View OUT Tools (0)`;
                    menuOutBtn.disabled = true;
                }
            }
        }

        // Function to setup menu button handlers
        function setupMenuButtons() {
            console.log('Setting up menu buttons...');
            
            // Register Tools button
            const menuRegisterBtn = document.getElementById('menuRegisterBtn');
            if (menuRegisterBtn) {
                console.log('Found menuRegisterBtn');
                menuRegisterBtn.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Register Tools button clicked');
                    window.location.href = 'register-tools.html';
                };
            } else {
                console.error('menuRegisterBtn not found!');
            }

            // View OUT Tools button
            const menuOutBtn = document.getElementById('menuOutBtn');
            if (menuOutBtn) {
                console.log('Found menuOutBtn');
                menuOutBtn.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('View OUT Tools button clicked');
                    window.location.href = 'previous-out.html';
                };
            } else {
                console.error('menuOutBtn not found!');
            }

            // My Tools button
            const menuMyToolsBtn = document.getElementById('menuMyToolsBtn');
            if (menuMyToolsBtn) {
                console.log('Found menuMyToolsBtn');
                menuMyToolsBtn.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('My Tools button clicked');
                    window.location.href = 'my-tools.html';
                };
            } else {
                console.error('menuMyToolsBtn not found!');
            }

            // Tools by Work Location button
            const menuWorkLocationBtn = document.getElementById('menuWorkLocationBtn');
            if (menuWorkLocationBtn) {
                console.log('Found menuWorkLocationBtn');
                menuWorkLocationBtn.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Tools by Work Location button clicked');
                    window.location.href = 'work-location.html';
                };
            } else {
                console.error('menuWorkLocationBtn not found!');
            }

            // Duty Shifts button
            const menuDutyShiftsBtn = document.getElementById('menuDutyShiftsBtn');
            if (menuDutyShiftsBtn) {
                console.log('Found menuDutyShiftsBtn');
                menuDutyShiftsBtn.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Duty Shifts button clicked');
                    window.location.href = 'duty-shifts.html';
                };
            } else {
                console.error('menuDutyShiftsBtn not found!');
            }

            // Tool Administrator button
            const menuAdminBtn = document.getElementById('menuAdminBtn');
            if (menuAdminBtn) {
                console.log('Found menuAdminBtn');
                menuAdminBtn.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Tool Administrator button clicked');
                    window.location.href = 'admin.html';
                };
            }

            // Create Training Questions button
            const menuTrainingQuestionsBtn = document.getElementById('menuTrainingQuestionsBtn');
            if (menuTrainingQuestionsBtn) {
                console.log('Found menuTrainingQuestionsBtn');
                menuTrainingQuestionsBtn.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Create Training Questions button clicked');
                    window.location.href = 'pdf-question-generator.html';
                };
            }

            // Logout button
            const menuLogoutBtn = document.getElementById('menuLogoutBtn');
            if (menuLogoutBtn) {
                console.log('Found menuLogoutBtn');
                menuLogoutBtn.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Logout button clicked');
                    auth.signOut().then(() => {
                        // Clear all auth-related data
                        localStorage.removeItem('fullName');
                        localStorage.removeItem('techniciansId');
                        localStorage.removeItem('authVerified');
                        localStorage.removeItem('isAdmin'); // Clear admin cache
                        window.location.href = 'index.html';
                    }).catch(error => {
                        console.error('Error signing out:', error);
                    });
                };
            } else {
                console.error('menuLogoutBtn not found!');
            }

            // Settings button
            const settingsBtn = document.getElementById('settingsBtn');
            if (settingsBtn) {
                console.log('Found settingsBtn');
                settingsBtn.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Settings button clicked');
                    document.getElementById('adminCodeInput').value = '';
                    document.getElementById('adminCodeError').style.display = 'none';
                    const modal = new bootstrap.Modal(document.getElementById('adminCodeModal'));
                    modal.show();
                };
            }

            // Verify admin code
            const verifyAdminCodeBtn = document.getElementById('verifyAdminCodeBtn');
            if (verifyAdminCodeBtn) {
                verifyAdminCodeBtn.onclick = function() {
                    const adminCode = document.getElementById('adminCodeInput').value;
                    const errorDiv = document.getElementById('adminCodeError');
                    
                    if (adminCode === 'AVIONICS2024') {
                        // Correct code - navigate to admin page
                        const modal = bootstrap.Modal.getInstance(document.getElementById('adminCodeModal'));
                        modal.hide();
                        window.location.href = 'admin.html';
                    } else {
                        errorDiv.textContent = 'Invalid admin code. Please try again.';
                        errorDiv.style.display = 'block';
                    }
                };
            }
            
            console.log('Menu buttons setup complete');
        }

            // Setup buttons when DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', setupMenuButtons);
            } else {
                // DOM is already loaded
                setupMenuButtons();
            }
            
            // Also try after a short delay as fallback
            setTimeout(setupMenuButtons, 100);
        }
        
        // Start initialization - wait for common.js to load
        initializeMainMenu();
    </script>
</body>
</html>


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <title>PDF Question Generator - Tool Tracking</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/common.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .main-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .card {
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            border: none;
            margin-bottom: 20px;
        }

        .card-header {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            padding: 20px;
            font-weight: bold;
            font-size: 1.5rem;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: #f8f9fa;
        }

        .upload-area.dragover {
            border-color: #FF9800;
            background: #fff3e0;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 8px;
            padding: 12px 30px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%);
            border: none;
            border-radius: 8px;
            padding: 12px 30px;
            font-weight: bold;
        }

        .btn-danger {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            border: none;
            border-radius: 8px;
            padding: 12px 30px;
            font-weight: bold;
        }

        .question-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #667eea;
        }

        .question-number {
            font-weight: bold;
            color: #667eea;
            font-size: 1.2rem;
            margin-bottom: 10px;
        }

        .question-text {
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: #333;
        }

        .option {
            padding: 12px;
            margin: 8px 0;
            border-radius: 8px;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .option:hover {
            background: #e9ecef;
            border-color: #667eea;
        }

        .option.correct {
            background: #d4edda;
            border-color: #4CAF50;
            color: #155724;
        }

        .option.incorrect {
            background: #f8d7da;
            border-color: #f44336;
            color: #721c24;
        }

        .loading-spinner {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading-spinner.active {
            display: block;
        }

        .spinner-border {
            width: 3rem;
            height: 3rem;
            border-width: 0.3em;
        }

        .api-key-section {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .pdf-preview {
            max-height: 400px;
            overflow-y: auto;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .settings-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .form-label {
            font-weight: bold;
            color: #333;
        }

        .alert {
            border-radius: 8px;
            border: none;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-file-pdf me-2"></i>
                PDF Question Generator
            </div>
            <div class="card-body p-4">
                <!-- API Key Section -->
                <div class="api-key-section" style="background: #d4edda; border-color: #28a745;">
                    <h5><i class="fas fa-key me-2"></i>Google Gemini API Configuration (FREE!)</h5>
                    <p class="mb-2"><strong>Free to use!</strong> Google Gemini offers a generous free tier. Enter your API key to generate questions. Your key is stored locally and never sent to our servers.</p>
                    <div class="input-group mb-2">
                        <span class="input-group-text"><i class="fas fa-lock"></i></span>
                        <input type="password" id="apiKey" class="form-control" placeholder="AIza..." value="">
                        <button class="btn btn-outline-secondary" type="button" id="toggleApiKey">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    <small class="text-muted">
                        Get your FREE API key from <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a> (No credit card required!)
                        <br>
                        <strong>Note:</strong> The default project works fine! Just create an API key from Google AI Studio - no need to create a new project.
                    </small>
                    <div class="mt-2">
                        <button class="btn btn-sm btn-info" id="testApiKeyBtn" onclick="testApiKey()">
                            <i class="fas fa-check-circle me-1"></i>Test API Key
                        </button>
                        <small id="apiKeyStatus" class="ms-2"></small>
                    </div>
                </div>

                <!-- Settings Section -->
                <div class="settings-section">
                    <h5><i class="fas fa-cog me-2"></i>Generation Settings</h5>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Number of Questions</label>
                            <input type="number" id="numQuestions" class="form-control" value="5" min="1" max="20">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Difficulty Level</label>
                            <select id="difficulty" class="form-select">
                                <option value="easy">Easy</option>
                                <option value="medium" selected>Medium</option>
                                <option value="hard">Hard</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Question Type</label>
                            <select id="questionType" class="form-select">
                                <option value="comprehension" selected>Comprehension</option>
                                <option value="factual">Factual</option>
                                <option value="analytical">Analytical</option>
                                <option value="application">Application</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- PDF Upload Section -->
                <div class="upload-area" id="uploadArea">
                    <i class="fas fa-cloud-upload-alt fa-3x mb-3 text-primary"></i>
                    <h4>Drop your PDF file here</h4>
                    <p class="text-muted">or click to browse</p>
                    <input type="file" id="pdfFile" accept=".pdf" style="display: none;">
                    <button class="btn btn-primary mt-3" onclick="document.getElementById('pdfFile').click()">
                        <i class="fas fa-file-pdf me-2"></i>Select PDF File
                    </button>
                </div>

                <div id="fileInfo" class="mt-3" style="display: none;">
                    <div class="alert alert-info">
                        <i class="fas fa-file-pdf me-2"></i>
                        <span id="fileName"></span>
                        <button class="btn btn-sm btn-danger float-end" onclick="clearFile()">
                            <i class="fas fa-times"></i> Remove
                        </button>
                    </div>
                </div>

                <!-- PDF Text Preview -->
                <div id="pdfPreview" style="display: none;">
                    <h5 class="mt-4 mb-3"><i class="fas fa-eye me-2"></i>Extracted Text Preview</h5>
                    <div class="pdf-preview" id="extractedText"></div>
                </div>

                <!-- Generate Button -->
                <div class="text-center mt-4" id="generateSection" style="display: none;">
                    <button class="btn btn-success btn-lg" id="generateBtn">
                        <i class="fas fa-magic me-2"></i>Generate Questions
                    </button>
                </div>

                <!-- Loading Spinner -->
                <div class="loading-spinner" id="loadingSpinner">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3">Processing PDF and generating questions...</p>
                </div>

                <!-- Questions Display -->
                <div id="questionsContainer" style="display: none;">
                    <h4 class="mt-4 mb-3"><i class="fas fa-question-circle me-2"></i>Generated Questions</h4>
                    <div id="questionsList"></div>
                    <div class="text-center mt-4">
                        <button class="btn btn-primary" onclick="exportQuestions()">
                            <i class="fas fa-download me-2"></i>Export Questions
                        </button>
                        <button class="btn btn-secondary ms-2" onclick="clearAll()">
                            <i class="fas fa-redo me-2"></i>Start Over
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Set up PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let pdfText = '';
        let questions = [];

        // Load API key from localStorage
        const savedApiKey = localStorage.getItem('gemini_api_key');
        if (savedApiKey) {
            document.getElementById('apiKey').value = savedApiKey;
        }

        // Toggle API key visibility
        document.getElementById('toggleApiKey').addEventListener('click', function() {
            const apiKeyInput = document.getElementById('apiKey');
            const icon = this.querySelector('i');
            if (apiKeyInput.type === 'password') {
                apiKeyInput.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                apiKeyInput.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        });

        // Save API key when changed
        document.getElementById('apiKey').addEventListener('change', function() {
            localStorage.setItem('gemini_api_key', this.value);
        });

        // File upload handling
        const uploadArea = document.getElementById('uploadArea');
        const pdfFileInput = document.getElementById('pdfFile');

        uploadArea.addEventListener('click', () => pdfFileInput.click());

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type === 'application/pdf') {
                handleFile(files[0]);
            }
        });

        pdfFileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        async function handleFile(file) {
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileInfo').style.display = 'block';
            document.getElementById('pdfPreview').style.display = 'none';
            document.getElementById('generateSection').style.display = 'none';
            document.getElementById('questionsContainer').style.display = 'none';

            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                
                let fullText = '';
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    fullText += pageText + '\n\n';
                }

                pdfText = fullText;
                
                // Show preview (truncated if too long)
                const previewText = fullText.length > 2000 ? fullText.substring(0, 2000) + '...' : fullText;
                document.getElementById('extractedText').textContent = previewText;
                document.getElementById('pdfPreview').style.display = 'block';
                document.getElementById('generateSection').style.display = 'block';
            } catch (error) {
                alert('Error reading PDF: ' + error.message);
                console.error(error);
            }
        }

        function clearFile() {
            pdfFileInput.value = '';
            pdfText = '';
            document.getElementById('fileInfo').style.display = 'none';
            document.getElementById('pdfPreview').style.display = 'none';
            document.getElementById('generateSection').style.display = 'none';
            document.getElementById('questionsContainer').style.display = 'none';
        }

        function clearAll() {
            clearFile();
            questions = [];
            document.getElementById('questionsList').innerHTML = '';
        }

        document.getElementById('generateBtn').addEventListener('click', generateQuestions);

        // Function to test API key and list available models
        async function testApiKey() {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey) {
                alert('Please enter your API key first');
                return;
            }

            const statusEl = document.getElementById('apiKeyStatus');
            statusEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
            statusEl.className = 'ms-2 text-info';

            try {
                // Try to list available models
                const response = await fetch(`https://generativelanguage.googleapis.com/v1/models?key=${apiKey}`);
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error?.message || `HTTP ${response.status}`);
                }

                const data = await response.json();
                const models = data.models || [];
                const modelNames = models.map(m => m.name).filter(name => name.includes('gemini'));
                
                if (modelNames.length > 0) {
                    statusEl.innerHTML = `<i class="fas fa-check-circle text-success"></i> API Key works! Available models: ${modelNames.length}`;
                    statusEl.className = 'ms-2 text-success';
                    console.log('Available models:', modelNames);
                } else {
                    statusEl.innerHTML = '<i class="fas fa-exclamation-triangle text-warning"></i> API Key works but no Gemini models found';
                    statusEl.className = 'ms-2 text-warning';
                }
            } catch (error) {
                statusEl.innerHTML = `<i class="fas fa-times-circle text-danger"></i> Error: ${error.message}`;
                statusEl.className = 'ms-2 text-danger';
                console.error('API Key test failed:', error);
            }
        }

        async function generateQuestions() {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey) {
                alert('Please enter your Google Gemini API key');
                return;
            }

            if (!pdfText) {
                alert('Please upload a PDF file first');
                return;
            }

            // Save API key
            localStorage.setItem('gemini_api_key', apiKey);

            const numQuestions = parseInt(document.getElementById('numQuestions').value);
            const difficulty = document.getElementById('difficulty').value;
            const questionType = document.getElementById('questionType').value;

            document.getElementById('loadingSpinner').classList.add('active');
            document.getElementById('generateSection').style.display = 'none';
            document.getElementById('questionsContainer').style.display = 'none';

            try {
                // Truncate text if too long (Gemini has token limits)
                const maxLength = 30000; // Gemini free tier allows more tokens
                const textToUse = pdfText.length > maxLength ? pdfText.substring(0, maxLength) + '...' : pdfText;

                const prompt = `Based on the following text from a PDF document, generate ${numQuestions} multiple choice questions. 
Each question should have:
- A clear question stem
- 4 answer options (A, B, C, D)
- One correct answer clearly marked

Difficulty level: ${difficulty}
Question type: ${questionType}

Format the response as a JSON array with this structure:
[
  {
    "question": "Question text here?",
    "options": {
      "A": "Option A text",
      "B": "Option B text",
      "C": "Option C text",
      "D": "Option D text"
    },
    "correct": "A"
  }
]

Text content:
${textToUse}

Return ONLY the JSON array, no additional text or markdown formatting.`;

                // First, try to get available models
                let availableModels = [];
                try {
                    const listResponse = await fetch(`https://generativelanguage.googleapis.com/v1/models?key=${apiKey}`);
                    if (listResponse.ok) {
                        const listData = await listResponse.json();
                        availableModels = (listData.models || [])
                            .map(m => m.name.replace('models/', ''))
                            .filter(name => name.includes('gemini') && name.includes('generateContent'));
                        console.log('Available models:', availableModels);
                    }
                } catch (e) {
                    console.log('Could not list models, will try defaults');
                }

                // Use Google Gemini API - try different models
                // Default models to try if we couldn't list them
                const defaultModels = [
                    'gemini-1.5-flash',
                    'gemini-1.5-pro', 
                    'gemini-pro',
                    'gemini-1.5-flash-latest',
                    'gemini-1.5-pro-latest'
                ];
                
                const modelsToTry = availableModels.length > 0 ? availableModels : defaultModels;

                let data = null;
                let lastError = null;
                let successfulModel = null;

                for (const model of modelsToTry) {
                    try {
                        // Try both v1 and v1beta endpoints
                        const endpoints = [
                            `https://generativelanguage.googleapis.com/v1/models/${model}:generateContent?key=${apiKey}`,
                            `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`
                        ];

                        for (const url of endpoints) {
                            try {
                                const response = await fetch(url, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({
                                        contents: [{
                                            parts: [{
                                                text: prompt
                                            }]
                                        }],
                                        generationConfig: {
                                            temperature: 0.7,
                                            maxOutputTokens: 2048
                                        }
                                    })
                                });

                                if (response.ok) {
                                    data = await response.json();
                                    successfulModel = model;
                                    console.log(`Successfully used model: ${model} with endpoint: ${url}`);
                                    break; // Success, exit endpoint loop
                                } else {
                                    const errorData = await response.json().catch(() => ({}));
                                    lastError = errorData.error?.message || `HTTP ${response.status}: ${response.statusText}`;
                                    console.log(`Model ${model} failed with ${url}:`, lastError);
                                }
                            } catch (err) {
                                lastError = err.message;
                                console.log(`Model ${model} error with ${url}:`, err.message);
                            }
                        }

                        if (data) break; // Success, exit model loop
                    } catch (err) {
                        lastError = err.message;
                        console.log(`Model ${model} error:`, err.message);
                        continue; // Try next model
                    }
                }

                if (!data || !data.candidates || !data.candidates[0]) {
                    throw new Error(lastError || 'Failed to generate questions. Please check your API key and ensure the Generative AI API is enabled in your Google Cloud project.');
                }

                const content = data.candidates[0].content.parts[0].text.trim();
                
                // Clean up the response (remove markdown code blocks if present)
                let jsonContent = content;
                if (content.startsWith('```')) {
                    jsonContent = content.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                }

                questions = JSON.parse(jsonContent);
                displayQuestions();
            } catch (error) {
                alert('Error generating questions: ' + error.message + '\n\nMake sure your API key is correct and you have not exceeded the free tier limits.');
                console.error(error);
            } finally {
                document.getElementById('loadingSpinner').classList.remove('active');
                document.getElementById('generateSection').style.display = 'block';
            }
        }

        function displayQuestions() {
            const container = document.getElementById('questionsList');
            container.innerHTML = '';

            questions.forEach((q, index) => {
                const questionCard = document.createElement('div');
                questionCard.className = 'question-card';
                
                const questionHtml = `
                    <div class="question-number">Question ${index + 1}</div>
                    <div class="question-text">${q.question}</div>
                    <div class="options">
                        ${Object.entries(q.options).map(([key, value]) => 
                            `<div class="option" data-option="${key}">
                                <strong>${key}.</strong> ${value}
                            </div>`
                        ).join('')}
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">
                            <strong>Correct Answer:</strong> <span class="badge bg-success">${q.correct}</span>
                        </small>
                    </div>
                `;
                
                questionCard.innerHTML = questionHtml;
                
                // Add click handlers to show correct/incorrect
                const options = questionCard.querySelectorAll('.option');
                options.forEach(option => {
                    option.addEventListener('click', function() {
                        const selectedOption = this.dataset.option;
                        options.forEach(opt => {
                            opt.classList.remove('correct', 'incorrect');
                            if (opt.dataset.option === q.correct) {
                                opt.classList.add('correct');
                            } else if (opt.dataset.option === selectedOption && selectedOption !== q.correct) {
                                opt.classList.add('incorrect');
                            }
                        });
                    });
                });
                
                container.appendChild(questionCard);
            });

            document.getElementById('questionsContainer').style.display = 'block';
        }

        function exportQuestions() {
            let exportText = 'PDF Question Generator - Generated Questions\n';
            exportText += '='.repeat(50) + '\n\n';

            questions.forEach((q, index) => {
                exportText += `Question ${index + 1}: ${q.question}\n\n`;
                Object.entries(q.options).forEach(([key, value]) => {
                    exportText += `  ${key}. ${value}\n`;
                });
                exportText += `\nCorrect Answer: ${q.correct}\n\n`;
                exportText += '-'.repeat(50) + '\n\n';
            });

            const blob = new Blob([exportText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'generated_questions.txt';
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>

